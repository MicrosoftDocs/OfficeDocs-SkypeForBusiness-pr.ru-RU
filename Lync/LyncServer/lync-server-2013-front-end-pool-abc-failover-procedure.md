---
title: 'Lync Server 2013: процедура отработки отказа для пула переднего плана ABC'
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
f1.keywords:
- NOCSH
TOCTitle: Front End pool ABC failover procedure
ms:assetid: 67763ad3-6796-45eb-a486-901f21ac1a95
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ945635(v=OCS.15)
ms:contentKeyID: 51541486
ms.date: 07/23/2014
manager: serdars
mtps_version: v=OCS.15
ms.openlocfilehash: f60ded6539f6d984662449562d0f978e98dc3078
ms.sourcegitcommit: 831d141dfc5a49dd764cb296b73b63e5a9f8e599
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2020
ms.locfileid: "42206555"
---
<div data-xmlns="http://www.w3.org/1999/xhtml">

<div class="topic" data-xmlns="http://www.w3.org/1999/xhtml" data-msxsl="urn:schemas-microsoft-com:xslt" data-cs="https://msdn.microsoft.com/">

<div data-asp="https://msdn2.microsoft.com/asp">

# <a name="front-end-pool-abc-failover-procedure-in-lync-server-2013"></a>Процедура отработки отказа для пула переднего плана ABC в Lync Server 2013

</div>

<div id="mainSection">

<div id="mainBody">

<span> </span>

_**Последнее изменение темы:** 2014-05-22_

Выполните следующие действия, чтобы выполнить процедуру отработки отказа ABC. Эта процедура содержит подробное описание каждого этапа, а затем команды и командлеты, которые необходимо выполнить для каждого этапа.

Чтобы запустить командлеты, откройте командную консоль Lync Server с помощью команды Запуск от имени администратора.

<div>

## <a name="to-perform-an-abc-failover"></a>Выполнение отработки отказа ABC

1.  Проверьте, является ли пул A узлом для центрального сервера управления (CMS).
    
      - Выполните следующий командлет:
        
            Get-CsService -CentralManagement
        
        Если поле Identity активного сервера CMS указывает на полное доменное имя пула A, то сначала выполните шаги 2 и 3, чтобы сначала выполнить отработку отказа на центральном сервере управления. В противном случае перейдите к шагу 4.

2.  Отработка отказа для сервера CMS в пул B в режиме аварийного восстановления путем запуска следующего командлета:
    
        Invoke-CsManagementServerFailover -BackupSqlServerFqdn <Pool B BE FQDN> -BackupSqlInstanceName <Pool B BE instance name> [-BackupMirrorSqlServerFqdn <Pool B Mirror BE FQDN> -BackupMirrorSqlInstanceName <Pool B Mirror BE Instance name>] -Force -Verbose
    
    После этого мы рекомендуем переместить CMS из пула б в другой существующий связанный пул для дополнительной устойчивости. Дополнительные сведения см. в статье [Move – CsManagementServer](https://docs.microsoft.com/powershell/module/skype/Move-CsManagementServer)..

3.  Если пул A содержит CMS, импортируйте конфигурацию LIS из пула а в базу данных LIS (LIS. mdf) пула. Это будет работать только в том случае, если вы регулярно создаете резервную копию данных LIS. Чтобы импортировать конфигурацию LIS, выполните следующие командлеты:
    
        Import-CsLisConfiguration -FileName <String> 
        Publish-CsLisConfiguration

4.  Импортируйте резервные копии рабочих процессов службы группы ответа Lync Server из пула A в пул B.
    
    <div>
    

    > [!NOTE]  
    > В настоящее время командлету <STRONG>Import-CsRgsConfiguration</STRONG> требуется, чтобы имена очередей и рабочих процессов в пуле A отличались от имен очередей и рабочих процессов в пуле B. Если имена не отличаются, при выполнении командлета <STRONG>Import-CsRgsConfiguration</STRONG> возникает ошибка, и перед выполнением командлета <STRONG>Import-CsRgsConfiguration</STRONG> необходимо переименовать очереди и рабочие процессы в пуле B.

    
    </div>
    
    Существует два варианта импорта конфигурации группы ответа из пула A в пул B. Выбор варианта зависит от того, хотите ли вы перезаписать параметры уровня приложения для пула B с параметрами уровня приложения в пуле A.
    
      - Если вы хотите перезаписать параметры пула в, выполните командлет **Import – CsRgsConfiguration** с параметром **реплацеексистингсеттингс** :
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"  -ReplaceExistingRgsSettings
    
      - Если вы не хотите перезаписывать параметры пула B, используйте командлет **Import – CsRgsConfiguration** без параметра **реплацеексистингсеттингс** .
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"
    
    <div>
    

    > [!WARNING]  
    > Имейте в виду, что если вы не хотите перезаписывать параметры уровня приложения для резервного пула (пула б) с параметрами основного пула (Pool A), то параметры уровня приложения пула A будут потеряны при потере пула A, так как приложение группы ответа может Сохраните только один набор параметров уровня приложения для каждого пула. При развертывании Pool C для замены пула A параметры на уровне приложения должны быть перенастроены, включая звуковой файл по умолчанию для хранения музыки.

    
    </div>

5.  Убедитесь, что импорт конфигурации группы ответа выполнен успешно, выполнив следующие командлеты, чтобы отобразить импортированные группы ответа. Обратите внимание на то, что импортированные группы ответа по-прежнему принадлежат пулу A.
    
        Get-CsRgsWorkflow -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"
        
        Get-CsRgsQueue -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"
        
        Get-CsRgsAgentGroup -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"

6.  Для неназначенных номеров переместите диапазоны неназначенных номеров, которые используют "извещение", в качестве выбранной службы объявлений из пула A в пул B. Для этого выполните указанные ниже действия.
    
      - Повторно создайте все объявления, развернутые в пуле A, в пуле B. Если при развертывании объявлений в пуле A использовались какие бы то ни были звуковые файлы, эти файлы понадобятся для повторного создания объявлений в пуле B. Чтобы повторно создать объявления в пуле б, используйте командлеты **New – ксаннаунцемент** с пулом B в качестве родительской службы.
    
      - Переназначьте все диапазоны неназначенных номеров, которые нацелены на оповещение в пуле а, в новые развернутые объявления в пуле б. выполните следующий командлет для каждого диапазона неназначенных номеров, предназначенного для объявления пула а:
        
            Set-CsUnassignedNumber -Identity "<Range Name>" -AnnouncementService "<Pool B FQDN>" -AnnouncementName "<New Announcement in pool B>"
    
    <div>
    

    > [!NOTE]  
    > Этот шаг не нужен для диапазонов неназначенных номеров, в которых выбрана служба обмена единой системой обмена сообщениями.

    
    </div>

7.  Отработка отказа пула A to Pool B в режиме аварийного восстановления (DR), выполнив следующий командлет:
    
        Invoke-CsPoolFailover -PoolFqdn <Pool A FQDN> -DisasterMode

8.  Создать пул C, но не запускать службы в пуле C.
    
    Обратите внимание, что это действие можно выполнить одновременно с действиями 5 и 6.

9.  Принудительное перемещение пользователей, размещенных в пуле а, в пул C с помощью следующего командлета:
    
        Get-csuser -Filter {RegistrarPool -eq "<Pool A FQDN>"} | Move-CsUser -Target <Pool C FQDN> -Force
    
    На этом шаге пользователи, размещенные в пуле, начнут испытывать сбой службы. Этот сбой будет продолжен до этапа 16, после чего службы будут запущены в пуле C.

10. Принудительно переместите каталог конференций пула A в пул C, выполнив следующий командлет:
    
        Move-CsConferenceDirectory -Identity <Conference Directory ID of Pool A> -TargetPool <Pool C FQDN> -Force

11. Принудительно переместите объект контакта автосекретаря конференц-связи (CAA) из пула A в пул C, выполнив следующий командлет:
    
        Move-csApplicationEndpoint -Identity "<Pool A CAA Uri>" -targetApplicationPool <Pool C FQDN> -force

12. Скопируйте содержимое конференций из пула B в пул C.

13. Экспортируйте данные пользователя из пула б и импортируйте данные пользователя в пул C, выполнив следующие командлеты:
    
        Export-CsUserData -PoolFqdn <Pool B Fqdn> -FileName <String>
        Import-CsUserData -PoolFqdn <Pool C Fqdn> -FileName <String>

14. Восстановите резервные копии данных приложения парковки вызовов из пула A в пул C и назначьте Диапазоны орбит парковки вызовов для пула а в пул C.
    
      - С помощью панели управления Lync Server или командной консоли Lync Server вы можете переназначить диапазон орбиты для парковки вызовов пула A в пул C. Для командной консоли Lync Server выполните следующий командлет для каждого диапазона орбит парковки вызовов, назначенного пулу A (Обратите внимание, что параметр Identity указывает на диапазоны орбит парковки вызовов, принадлежащие пулу A):
        
            Set-CsCallParkOrbit -Identity "<Call Park Orbit Identity>" -CallParkService "service:ApplicationServer:<Pool C FQDN>"
    
      - Если настроенная музыка заблокирована для парковки вызовов в пуле A, восстановите настроенный в пуле C файл музыки для парковки на удержание вызовов.
        
            Xcopy <Source> <Destination: Pool C CPS File Store Path>
        
        Например:
        
            Xcopy "Source Path" "<Pool C File Store Path>\OcsFileStore\coX-ApplicationServer-X\AppServerFiles\CPS\"
    
      - Наконец, перенастройте параметры парковки вызовов в пуле C с помощью командлета **Set – CsCpsConfiguration** . Приложение парковки вызовов может хранить только один набор параметров и один настроенный звуковой файл музыки при удержании на пул, и эти параметры не будут создаваться и сохраняться в случае аварии.

15. Если следующий пул прыжков для сохраняемого чата указывает на пул A, сделайте и опубликуйте изменения топологии, чтобы сервер следующего прыжка указывал на пул C.
    
      - В построителе топологий измените пул сохраняемого чата, чтобы он ссылался на пул C в качестве следующего прыжка. Для этого щелкните правой кнопкой мыши пул сохраняемого чата, перейдите на вкладку **Общие** , а затем введите имя пула C в поле **пул следующего прыжка**.
    
      - Запустите службы из пула C, выполнив следующий командлет:
        
            Start-csWindowsService
    
    На этом шаге сбой службы завершается для пользователей, изначально размещенных в пуле A.

16. Экспортируйте рабочие процессы службы группы ответа Lync Server из пула б, владельцем которых является пул A, для импорта в пул C, выполнив следующий командлет:
    
        Export-CsRgsConfiguration -Source "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>" -FileName "C:\RgsExportPrimaryUpdated.zip" 

17. Импортируйте рабочие процессы службы группы ответа Lync Server в пул C из пула B.
    
    Существует два варианта импорта конфигурации группы ответа из пула б в пул C. Выбор варианта зависит от того, хотите ли вы перезаписать параметры уровня приложения для пула C с параметрами уровня приложения в пуле B.
    
      - Если вы хотите перезаписать параметры пула в C, выполните командлет **Import – CsRgsConfiguration** с параметром **реплацеексистингсеттингс** :
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool C FQDN>" -FileName "C:\RgsExportPrimary.zip"  -ReplaceExistingRgsSettings
    
      - Если вы не хотите перезаписывать параметры пула в C, используйте командлет **Import – CsRgsConfiguration** без параметра **реплацеексистингсеттингс** .
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"
    
    <div>
    

    > [!WARNING]  
    > Имейте в виду, что если вы не хотите перезаписывать параметры уровня приложения для пула C с параметрами резервного пула (пула B), то параметры уровня приложения пула B будут потеряны, так как приложение группы ответа может хранить только один набор уровня приложения. параметры для каждого пула.

    
    </div>

18. Убедитесь, что импорт конфигурации группы ответа выполнен успешно, выполнив следующие командлеты, чтобы отобразить группы ответа, импортированные в пул C.
    
        Get-CsRgsWorkflow -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll
         Get-CsRgsQueue -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll
        Get-CsRgsAgentGroup -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll

19. После проверки импортированной конфигурации в пуле C удалите группы ответа, принадлежащие основному пулу из пула B. Это снизит время простоя групп ответа.
    
    На этом этапе создается новый файл с экспортированной конфигурацией, после чего он удаляется из пула B.
    
        Export-CsRgsConfiguration -Source "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>" -FileName "C:\RgsExportPrimaryUpdated.zip" -RemoveExportedConfiguration

20. Переместить в пул C диапазоны неназначенных номеров, перемещенных из пула A в пул B.
    
      - Повторное создание в пуле с все объявления, которые были повторно созданы из пула A в пуле B. Если при развертывании извещений использовались какие бы то ни были звуковые файлы, их необходимо будет использовать для повторного создания объявлений в пуле C. Чтобы повторно создать объявления в пуле C, используйте командлеты **New – ксаннаунцемент** с пулом C в качестве родительской службы.
    
      - Перенаправлять в пул C все диапазоны неназначенных номеров, которые были перенацелены из пула A в пул б. выполните следующий командлет для каждого диапазона неназначенных номеров, которые необходимо переадресовать:
        
            Set-CsUnassignedNumber -Identity "<Range Name>" -AnnouncementService "<Pool C FQDN>" -AnnouncementName "<New Announcement in pool C>"
    
      - Необязательно Удалить из пула б объявления, которые были повторно созданы в пуле C, если они больше не используются в пуле B. Чтобы удалить объявления, используйте командлет **Remove – ксаннаунцемент** .
        
        <div>
        

        > [!NOTE]  
        > Этот шаг не нужен для диапазонов неназначенных номеров, в которых служба извещения использует "Единая система обмена сообщениями".

        
        </div>

21. Очистите данные пользователя пула A в пуле б, выполнив следующий командлет:
    
        Remove-CsUserStoreBackupData -PoolFqdn <Pool B FQDN> -Verbose

22. Выполните указанные ниже действия в построителе топологий.
    
      - Несвязанный пул A и пул B. Свяжите пул б и пул C. Затем удалите пул A из топологии и опубликуйте его. Для этого:
        
          - В построителе топологий щелкните пул б правой кнопкой мыши и выберите команду **изменить свойства**.
        
          - Нажмите кнопку **устойчивости** на левой панели.
        
          - В поле под **сопоставленным резервным пулом**выберите пул C. Обратите внимание, что в поле выбора связанного резервного пула изначально отображается пул A, так как пул B был ранее связан с этим пулом.
        
          - Выберите **Automatic failover and failback for Voice** (Автоматическая отработка отказа и восстановление размещения для голосовой связи) и нажмите кнопку **OK** (ОК).
            
            Теперь при просмотре сведений о данном пуле связанный с ним пул отображается на правой панели в области **Resiliency** (Устойчивость).
        
          - В дереве консоли щелкните правой кнопкой мыши пул A, а затем выберите команду Удалить.
        
          - Опубликуйте топологию.

23. Запустите приложение начальной загрузки в пуле C, чтобы установить приложение службы резервного копирования, а затем запустите приложение службы резервного копирования, выполнив следующие действия в папке Deployment локального компьютера в пуле C:
    
        Run "%SYSTEMROOT%\Program Files\Microsoft Lync Server 2013\Deployment\Bootstrapper.exe"
        Start-CsWindowsService -name LyncBackup

24. Перезапустите приложение службы резервного копирования в пуле б, выполнив следующие командлеты:
    
        Stop-CsWindowsService -name LyncBackup
        Start-CsWindowsService -name LyncBackup

25. Если пул C является пулом Standard Edition (SE), а пул B имеет CMS, установите базу данных CMS вручную в пуле C, выполнив следующий командлет:
    
        Install-CsDatabase -CentralManagementDatabase -SqlServerFqdn <Pool C FQDN> -SqlInstanceName rtc

26. Запустите службу резервного копирования, чтобы синхронизировать старое содержимое конференций из пула B с пулом C, созданным до совместной связи B и C, и для синхронизации нового контента конференций из пула C в пул B, который был создан после объединения групп C и до B и C. Чтобы сделать это, выполните следующие командлеты:
    
        Invoke-CsBackupServiceSync -PoolFqdn <Pool C FQDN>
        Invoke-CsBackupServiceSync -PoolFqdn <Pool B FQDN>

27. Для каждого устройства для обеспечения связи в филиале, сопоставленного с пулом A:
    
      - Завершите работу SBA X, выполнив следующий командлет:
        
            Stop-CsWindowsService
    
      - Создайте файл, содержащий список пользователей, размещенных на SBA X. Список потребуется, когда пользователи перемещаются обратно в SBA X на шаге 30. Для этого выполните следующий командлет:
        
            Get-CsUser -Filter {RegistrarPool -eq "<SBA X FQDN>"} | Export-Csv d:\sbaxusers.txt
    
      - Принудительное перемещение пользователей, размещенных на SBA X, в пул C с помощью следующего командлета:
        
            Get-CsUser -Filter {RegistrarPool -eq "<SBA X FQDN>"} | Move-CsUser -Target <Pool C FQDN> -Force -Verbose
    
      - Обновите данные этих пользователей, выполнив следующие командлеты:
        
            Convert-csUserData -InputFile <Data file exported from PoolB> -OutputFile c:\Logs\ExportedUserData.xml -TargetVersionLync2010 
            $a=get-csuser -Filter {RegistrarPool -eq "FQDN of SBA X"} | select SipAddress
            foreach($x in $a) {$x.SipAddress.Substring(4) >> users.txt}
        
        Затем выполните следующий сценарий:
        
            $users=gc c:\logs\users.txt
            foreach ($user in $users)
            {
            Update-CsUserData -FileName c:\logs\exportedUserDAta.xml -UserFilter $user - 
            }
        
        <div>
        

        > [!NOTE]  
        > Отказ службы будет выполняться для пользователей, размещенных в устройства, связанных с пулом A до тех пор, пока эти пользователи не будут перемещены в пул C.

        
        </div>

28. В построителе топологий для каждого SBA X, ранее связанных с пулом A, выполните следующие действия:
    
      - Измените связь на Pool C. Для этого щелкните сайт филиала, разверните узел устройства для обеспечения связи или серверы для обеспечения связи в филиалах и выберите устройство для обеспечения связи в **филиалах**. Затем выберите **интерфейсный пул, пул служб пользователя** , который будет подключаться к этому устройству для обеспечения связи в филиалах, как пул C, а затем нажмите кнопку **Далее**.
    
      - Опубликуйте топологию. Для этого в дереве консоли щелкните правой кнопкой мыши новое устройство для обеспечения связи в **филиалах**, выберите **топология**, а затем нажмите кнопку **опубликовать**.

29. Для каждого SBA X теперь связан с пулом C:
    
      - Запустите SBA X, выполнив следующий командлет на устройстве для обеспечения связи в филиалах:
        
            Start-CsWindowsService
    
      - Переместите пользователей, которые изначально были размещены в SBA X из пула C, в SBA X, выполнив следующий командлет.
        
            Import-Csv d:\sbaxusers.txt | Move-CsUser -Target <SBA X FQDN> -Force

</div>

</div>

<span> </span>

</div>

</div>

</div>

