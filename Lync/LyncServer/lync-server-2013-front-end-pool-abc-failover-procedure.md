---
title: 'Lync Server 2013: простая процедура отработки отказа для интерфейсного пула'
TOCTitle: Простая процедура отработки отказа для интерфейсного пула
ms:assetid: 67763ad3-6796-45eb-a486-901f21ac1a95
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ945635(v=OCS.15)
ms:contentKeyID: 52058243
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Простая процедура отработки отказа для интерфейсного пула в Lync Server 2013

 

_**Дата изменения раздела:** 2014-05-22_

Используйте описанные ниже действия для выполнения простой процедуры отработки отказа. Данная процедура содержит общее описание каждого действия, после которого приведены необходимые команды и командлеты.

Для запуска командлетов откройте командную консоль Командная консоль Lync Server с помощью функции запуска от имени администратора.

## Выполнение простой процедуры отработки отказа

1.  Проверьте, является ли пул А местом размещения центрального сервера управления (CMS).
    
      - выполнить следующий командлет:
        
            Get-CsService -CentralManagement
        
        Если поле удостоверения активного центрального сервера управления указывает на полное доменное имя пула А, выполните действия 2 и 3 этой процедуры для предварительной отработки отказа этот центрального сервера управления. В противном случае перейдите к действию 4.

2.  Выполните отработку отказа центрального сервера управления в пул Б в режиме аварийного восстановления, выполнив следующий командлет:
    
        Invoke-CsManagementServerFailover -BackupSqlServerFqdn <Pool B BE FQDN> -BackupSqlInstanceName <Pool B BE instance name> [-BackupMirrorSqlServerFqdn <Pool B Mirror BE FQDN> -BackupMirrorSqlInstanceName <Pool B Mirror BE Instance name>] -Force -Verbose
    
    После этого мы рекомендуем переместить центральный сервер управления из пула Б в другой имеющийся связанный пул для повышения уровня устойчивости. Дополнительные сведения см. в статье [Move-CsManagementServer](https://docs.microsoft.com/en-us/powershell/module/skype/Move-CsManagementServer)..

3.  Если пул А содержит центральный сервер управления, импортируйте конфигурацию LIS из пула А в базу данных LIS пула Б (Lis.mdf). Это сработает только в том случае, если вы регулярно выполняли резервное копирование данных LIS. Чтобы импортировать конфигурацию LIS, запустите следующие командлеты:
    
        Import-CsLisConfiguration -FileName <String> 
        Publish-CsLisConfiguration

4.  Импортируйте резервные рабочие процессы службы группы ответа Lync Server из пула А в пул Б.
    
    > [!NOTE]  
    > В настоящее время командлет <strong>Import-CsRgsConfiguration</strong> требует, чтобы имена очередей и рабочих процессов в пуле А отличались от имен очередей и рабочих процессов в пуле Б. Если имена не различаются, при выполнении командлета <strong>Import-CsRgsConfiguration</strong> возникает ошибка, поэтому перед продолжением работы с командлетом <strong>Import-CsRgsConfiguration</strong> потребуется переименовать очереди и рабочие процессы в пуле Б.    
    Доступно два способа импорта конфигурации группы ответа из пула А в пул Б. Подходящий способ зависит от того, хотите ли вы записать параметры уровня приложений в пуле А поверх параметров уровня приложений в пуле Б.
    
      - Если вы хотите перезаписать параметры пула Б, запустите командлет **Import-CsRgsConfiguration** с параметром **ReplaceExistingSettings** :
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"  -ReplaceExistingRgsSettings
    
      - Если вы не хотите перезаписывать параметры пула Б, используйте командлет **Import-CsRgsConfiguration** без параметра **ReplaceExistingSettings** .
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"
    
    > [!WARNING]  
    > Помните о том, что если вы решили не перезаписывать параметры уровня приложений в резервном пуле (пул Б) параметрами основного пула (пул А), то при сбое пула А все его параметры уровня приложений будут потеряны, так как для каждого из пулов приложение группы ответа может сохранить только один набор параметров уровня приложений. При развертывании пула C на замену пула А необходимо повторно настроить параметры уровня приложений, включая звуковой файл по умолчанию, воспроизводимый при удержании вызова.

5.  Убедитесь, что импорт конфигурации группы ответа выполнен успешно, запустив следующие командлеты для отображения импортированных групп ответа. Обратите внимание на то, что импортированные группы ответа все еще принадлежат пулу А.
    
        Get-CsRgsWorkflow -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"
        
        Get-CsRgsQueue -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"
        
        Get-CsRgsAgentGroup -Identity "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>"

6.  Для неназначенных номеров переместите диапазоны неназначенных номеров, использующие "Оповещение" в качестве выбранной службы оповещений, из пула А в пул Б. Чтобы сделать это, выполните следующие действия:
    
      - Повторно создайте в пуле Б все оповещения, которые были развернуты в пуле А. Если при развертывании оповещений в пуле А использовались какие-либо звуковые файлы, они потребуются при повторном создании оповещений в пуле Б. Чтобы повторно создать оповещения в пуле Б, запустите командлет **New-CsAnnouncement** с пулом Б в качестве родительской службы.
    
      - Переориентируйте диапазоны неназначенных номеров, нацеленные на оповещение в пуле А, но новые развернутые оповещения в пуле Б. Запустите следующий командлет для каждого диапазона неназначенных номеров, нацеленного на оповещение в пуле А:
        
            Set-CsUnassignedNumber -Identity "<Range Name>" -AnnouncementService "<Pool B FQDN>" -AnnouncementName "<New Announcement in pool B>"
    
    > [!NOTE]  
    > Выполнение данного действия не требуется для диапазонов неназначенных номеров, которые используют в качестве выбранной службы оповещений единую систему обмена сообщениями Exchange.

7.  Выполните отработку отказа пула А в пул Б в режиме аварийного восстановления, выполнив следующий командлет:
    
        Invoke-CsPoolFailover -PoolFqdn <Pool A FQDN> -DisasterMode

8.  Создайте пул В, не запуская на нем никакие службы.
    
    Обратите внимание на то, что данное действие можно выполнить одновременно с действиями 5 и 6.

9.  Инициируйте принудительное перемещение пользователей, размещенных в пуле А, в пул В, выполнив следующий командлет:
    
        Get-csuser -Filter {RegistrarPool -eq "<Pool A FQDN>"} | Move-CsUser -Target <Pool C FQDN> -Force
    
    После этого пользователи, размещенные в пуле А, начнут испытывать проблемы со службами. Такое состояние продлится до действия 16, когда службы будут запущены в пуле В.

10. Инициируйте принудительное перемещение каталога конференций пула А в пул В, выполнив следующий командлет:
    
        Move-CsConferenceDirectory -Identity <Conference Directory ID of Pool A> -TargetPool <Pool C FQDN> -Force

11. Инициируйте принудительное перемещение контактного объекта автосекретаря конференции из пула А в пул В, выполнив следующий командлет:
    
        Move-csApplicationEndpoint -Identity "<Pool A CAA Uri>" -targetApplicationPool <Pool C FQDN> -force

12. Скопируйте содержимое конференции из пула Б в пул В.

13. Экспортируйте пользовательские данные из пула Б и импортируйте их в пул В, выполнив следующие командлеты:
    
        Export-CsUserData -PoolFqdn <Pool B Fqdn> -FileName <String>
        Import-CsUserData -PoolFqdn <Pool C Fqdn> -FileName <String>

14. Восстановите резервные данные приложения парковки вызовов из пула А в пул В и назначьте пулу В диапазоны орбит парковки вызовов пула А.
    
      - Вы можете переназначить диапазон орбит парковки вызовов пула А пулу В с помощью панели управления Lync Server или командной консоли Lync Server. Из командной консоли Lync Server запустите следующий командлет для каждого диапазона орбит парковки вызовов, назначенного пулу А (обратите внимание на то, что параметр Identity ссылается на диапазоны орбит парковки вызовов, относящиеся к пулу А):
        
            Set-CsCallParkOrbit -Identity "<Call Park Orbit Identity>" -CallParkService "service:ApplicationServer:<Pool C FQDN>"
    
      - Если для парковки вызовов в пуле А была настроена музыка, воспроизводимая во время удержания, восстановите соответствующий музыкальный файл в пуле В.
        
            Xcopy <Source> <Destination: Pool C CPS File Store Path>
        
        Например:
        
            Xcopy "Source Path" "<Pool C File Store Path>\OcsFileStore\coX-ApplicationServer-X\AppServerFiles\CPS\"
    
      - Наконец, повторно настройте параметры парковки вызовов в пуле В с помощью командлета **Set-CsCpsConfiguration**. На каждый пул приложение парковки вызовов может сохранить только один набор параметров и один пользовательский музыкальный файл для воспроизведения во время удержания, и эти параметры не сохраняются в случае аварии.

15. Если пул следующего прыжка для сохраняемый сеанс беседы указывает на пул А, создайте и опубликуйте изменения топологии, чтобы сервер следующего прыжка указывал на В.
    
      - В построителе топологий измените пул сохраняемый сеанс беседы таким образом, чтобы при следующем прыжке он указывал на пул В. Для этого нажмите правой кнопкой мыши пул сохраняемый сеанс беседы, выберите вкладку **Общие** и введите имя пула В в поле **Пул следующих прыжков**.
    
      - Запустите службы в пуле В, выполнив следующий командлет:
        
            Start-csWindowsService
    
    После этого пользователи, которые изначально размещались в пуле А, перестают испытывать проблемы со службами.

16. Экспортируйте рабочие процессы службы группы ответа Lync Server из пула Б, принадлежащего пулу А, для последующего импорта в пул В, выполнив следующий командлет:
    
        Export-CsRgsConfiguration -Source "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>" -FileName "C:\RgsExportPrimaryUpdated.zip" 

17. Импортируйте рабочие процессы службы группы ответа Lync Server из пула Б в пул В.
    
    Доступно два способа импорта конфигурации группы ответа из пула Б в пул В. Подходящий способ зависит от того, хотите ли вы записать параметры уровня приложений в пуле Б поверх параметров уровня приложений в пуле В.
    
      - Если вы хотите перезаписать параметры пула В, запустите командлет **Import-CsRgsConfiguration** с параметром **ReplaceExistingSettings** :
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool C FQDN>" -FileName "C:\RgsExportPrimary.zip"  -ReplaceExistingRgsSettings
    
      - Если вы не хотите перезаписывать параметры пула В, используйте командлет **Import-CsRgsConfiguration** без параметра **ReplaceExistingSettings** .
        
            Import-CsRgsConfiguration -Destination "service:ApplicationServer:<Pool B FQDN>" -FileName "C:\RgsExportPrimary.zip"
    
    > [!WARNING]  
    > Помните о том, что если вы решили не перезаписывать параметры уровня приложений в пуле В параметрами резервного пула (пул Б), то все его параметры уровня приложений будут потеряны, так как для каждого из пулов приложение группы ответа может сохранить только один набор параметров уровня приложений.

18. Убедитесь, что импорт конфигурации группы ответа выполнен успешно, запустив следующие командлеты для отображения групп ответа, импортированных в пул В.
    
        Get-CsRgsWorkflow -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll
         Get-CsRgsQueue -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll
        Get-CsRgsAgentGroup -Identity "service:ApplicationServer:<Pool C FQDN>" -ShowAll

19. После проверки импортированной конфигурации в пуле В удалите из пула Б группы ответа, принадлежащие основному пулу. Это позволит минимизировать время простоя для групп ответа.
    
    В данном действии создается новый файл с экспортированной конфигурацией, после чего этот файл удаляется из пула Б.
    
        Export-CsRgsConfiguration -Source "service:ApplicationServer:<Pool B FQDN>" -Owner "service:ApplicationServer:<Pool A FQDN>" -FileName "C:\RgsExportPrimaryUpdated.zip" -RemoveExportedConfiguration

20. Переместите в пул В диапазоны неназначенных номеров, перемещенные из пула А в пул Б.
    
      - Повторно создайте в пуле В все оповещения, которые были воссозданы из пула А в пул Б. Если при развертывании перемещаемых оповещений использовались какие-либо звуковые файлы, их потребуется использовать для воссоздания этих оповещений в пуле В. Чтобы повторно создать оповещения в пуле В, запустите командлет **New-CsAnnouncement** с пулом В в качестве родительской службы.
    
      - Переориентируйте на пул В все диапазоны неназначенных номеров, переориентированные с пула А на пул Б. Запустите следующий командлет для каждого диапазона неназначенных номеров, который требуется переориентировать:
        
            Set-CsUnassignedNumber -Identity "<Range Name>" -AnnouncementService "<Pool C FQDN>" -AnnouncementName "<New Announcement in pool C>"
    
      - (Дополнительно) Если оповещения, воссозданные в пуле В, больше не используются в пуле Б, удалите их из пула Б. Для удаления оповещений используйте командлет **Remove-CsAnnouncement**.
        
        > [!NOTE]  
        > Выполнение данного действия не требуется для диапазонов неназначенных номеров, которые используют в качестве службы оповещений единую систему обмена сообщениями Exchange.

21. Очистите пользовательские данные пула А в пул Б, выполнив следующий командлет:
    
        Remove-CsUserStoreBackupData -PoolFqdn <Pool B FQDN> -Verbose

22. Выполните следующие действия в построителе топологий:
    
      - Отмените связывание пула А и пула Б. Свяжите пул Б и пул В. После этого удалите пул А из топологии и опубликуйте ее. Чтобы сделать это, выполните следующие действия:
        
          - В построителе топологий щелкните пул Б правой кнопкой мыши и выберите пункт **Edit Properties** (Изменить свойства).
        
          - Щелкните элемент **Resiliency** (Устойчивость) на левой панели.
        
          - В расположенном ниже поле **Associated Backup Pool** (Сопоставленный резервный пул) выберите пул В. Обратите внимание на то, что изначально в поле выбора "Associated Backup Pool" (Сопоставленный резервный пул) отображается пул А, так как именно с ним сначала был сопоставлен пул Б.
        
          - Выберите **Automatic failover and failback for Voice** (Автоматическая отработка отказа и восстановление размещения для голосовой связи) и нажмите кнопку **OK** (ОК).
            
            Теперь при просмотре сведений о данном пуле связанный с ним пул отображается на правой панели в области **Resiliency** (Устойчивость).
        
          - В дереве консоли щелкните правой кнопкой мыши пул А, а затем выберите пункт "Delete" (Удалить).
        
          - Опубликуйте топологию.

23. Запустите приложение начальной загрузки в пуле В, чтобы установить приложение службы резервного копирования, а затем запустите это приложение, выполнив в пуле В следующую команду из папки развертывания на локальном компьютере:
    
        Run "%SYSTEMROOT%\Program Files\Microsoft Lync Server 2013\Deployment\Bootstrapper.exe"
        Start-CsWindowsService -name LyncBackup

24. Перезапустите приложение службы резервного копирования в пуле Б, выполнив следующий командлет:
    
        Stop-CsWindowsService -name LyncBackup
        Start-CsWindowsService -name LyncBackup

25. Если пул В является пулом Standard Edition (SE), а пул Б содержит центральный сервер управления, вручную установите базу данных центрального сервера управления в пул В, выполнив следующий командлет:
    
        Install-CsDatabase -CentralManagementDatabase -SqlServerFqdn <Pool C FQDN> -SqlInstanceName rtc

26. Вызовите службу резервного копирования, чтобы синхронизировать из пула Б в пул В старое содержимое конференций, созданное до связывания пулов Б и В, а также синхронизировать из пула В в пул Б новое содержимое конференций, созданное после запуска пула В и до связывания пулов Б и В. Чтобы сделать это, выполните следующие командлеты:
    
        Invoke-CsBackupServiceSync -PoolFqdn <Pool C FQDN>
        Invoke-CsBackupServiceSync -PoolFqdn <Pool B FQDN>

27. Для каждого устройства для обеспечения связи в филиалах X, сопоставленного с пулом А:
    
      - Завершите работу устройства для обеспечения связи в филиалах X, выполнив следующий командлет:
        
            Stop-CsWindowsService
    
      - Создайте файл, содержащий список пользователей, размещенных на устройстве для обеспечения связи в филиалах X. Этот список потребуется при перемещении пользователей обратно на устройство для обеспечения связи в филиалах X в действии 30. Чтобы сделать это, выполните следующий командлет:
        
            Get-CsUser -Filter {RegistrarPool -eq "<SBA X FQDN>"} | Export-Csv d:\sbaxusers.txt
    
      - Инициируйте принудительное перемещение пользователей, размещенных на устройстве для обеспечения связи в филиалах X, в пул В, выполнив следующий командлет:
        
            Get-CsUser -Filter {RegistrarPool -eq "<SBA X FQDN>"} | Move-CsUser -Target <Pool C FQDN> -Force -Verbose
    
      - Обновите данные этих пользователей, выполнив следующие командлеты:
        
            Convert-csUserData -InputFile <Data file exported from PoolB> -OutputFile c:\Logs\ExportedUserData.xml -TargetVersionLync2010 
            $a=get-csuser -Filter {RegistrarPool -eq "FQDN of SBA X"} | select SipAddress
            foreach($x in $a) {$x.SipAddress.Substring(4) >> users.txt}
        
        После этого выполните следующий командлет:
        
            $users=gc c:\logs\users.txt
            foreach ($user in $users)
            {
            Update-CsUserData -FileName c:\logs\exportedUserDAta.xml -UserFilter $user - 
            }
        
        > [!NOTE]  
        > Пользователи, размещенные на устройствах для обеспечения связи в филиалах, сопоставленных с пулом А, будут испытывать проблемы со службами, пока вы не переместите этих пользователей в пул В.

28. В построителе топологий для каждого устройства для обеспечения связи в филиалах X, ранее сопоставленного с пулом А, выполните следующие действия:
    
      - Измените сопоставление на пул В. Для этого щелкните сайт филиала, разверните узел устройств для обеспечения связи в филиалах или серверов, а затем щелкните элемент **Survivable Branch Appliance** (Устройство для обеспечения связи в филиалах). После этого выберите **Front End pool, User Services Pool** (Интерфейсный пул, пул служб обслуживания пользователей), к которому данное устройство для обеспечения связи в филиалах будет подключаться в качестве пула В, и нажмите кнопку **Next** (Далее).
    
      - Опубликуйте топологию. Для этого в дереве консоли щелкните правой кнопкой мыши новый элемент **Survivable Branch Appliance** (Устройство для обеспечения связи в филиалах), выберите пункт **Topology** (Топология) и щелкните элемент **Publish** (Опубликовать).

29. Для каждого устройства для обеспечения связи в филиалах X, сопоставленного уже с пулом В:
    
      - Запустите устройство для обеспечения связи в филиалах X, выполнив на нем следующий командлет:
        
            Start-CsWindowsService
    
      - Переместите пользователей, которые изначально размещались на устройстве для обеспечения связи в филиалах X, из пула В на устройство для обеспечения связи в филиалах X, выполнив следующий командлет.
        
            Import-Csv d:\sbaxusers.txt | Move-CsUser -Target <SBA X FQDN> -Force

