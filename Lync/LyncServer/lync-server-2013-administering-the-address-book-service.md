---
title: Управление службой адресной книги в Lync Server 2013
TOCTitle: Управление службой адресной книги в Lync Server 2013
ms:assetid: 801e4243-9670-4477-aa2f-88b61ecf5351
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Gg429711(v=OCS.15)
ms:contentKeyID: 49310321
ms.date: 12/10/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Управление службой адресной книги в Lync Server 2013

 

_**Дата изменения раздела:** 2016-12-08_

Служба адресной книги устанавливается по умолчанию как часть развертывания Lync Server, Enterprise Edition или Сервер Standard Edition. Базы данных, используемые службой адресной книги (RTCab и RTCab1) создаются на SQL Server (для Enterprise Edition это фоновый сервер SQL Server, для Сервер Standard Edition — совместно размещенный SQL Server).

> [!NOTE]  
> Подробнее об использовании функции <strong>Редактирование ADSI</strong> для редактирования атрибутов объекта Доменные службы Active Directory см. в разделе <a href="http://go.microsoft.com/fwlink/?linkid=330427">Редактирование ADSI</a>. Подробнее о средстве набора ресурсов, созданном специально для службы адресной книги, см. в разделе <a href="http://go.microsoft.com/fwlink/?linkid=330429">Средства Microsoft Lync Server 2013 Resource Kit Tools</a>.

## Нормализация номеров телефонов сервера адресной книги

Для Lync Server требуются стандартизированные телефонные номера RFC 3966/E.164. Для использования неструктурированных или неправильно отформатированных номеров Lync Server применяет сервер адресной книги для предварительной обработки телефонных номеров перед их отправкой в правила нормализации. Если используется номер телефона из адресной книги и применяется правило нормализации, клиенты, такие как Lync Phone Edition и Lync Mobile, могут использовать эти нормализованные номера.

Правила нормализации, которые использовались в предыдущих версиях, могут работать неправильно без некоторых настроек. Поскольку пробел и необязательные символы удаляются перед применением правил нормализации, если регулярное выражение ищет дефис или другой символ, который был удален, правило нормализации может завершиться с ошибкой. Следует проверить правила нормализации и убедиться, что они не ищут эти необязательные символы или что это правило может завершиться с ошибкой и продолжить работу, если символ не будет обнаружен там, где он ожидается.

## Репликатор пользователей и сервер адресной книги

Сервер адресной книги использует данные репликатора пользователей для обновления информации, которую он изначально получает из глобального списка адресов (GAL). Репликатор пользователей записывает атрибуты Доменные службы Active Directory для каждого пользователя, контакта и группы в таблицу AbUserEntry в базе данных, а сервер адресной книги синхронизирует данные пользователей из базы данных в файлы в файловом хранилище сервера адресной книги и RTCab базы данных адресной книги. Схема таблицы AbUserEntry использует два столбца **UserGuid** и **UserData**. **UserGuid** — это столбец индекса, который содержит 16-байтовый GUID объекта Active Directory. **UserData** — это столбец изображений, содержащий все ранее упоминающиеся атрибуты Доменные службы Active Directory для этого контакта.

Репликатор пользователей определяет, какие атрибуты Active Directory будут записываться, читая таблицу конфигурации, расположенную в том же экземпляре SQL Server, что и таблица AbUserEntry. Таблица AbAttribute содержит три столбца: **Код**, **Имя**, **Флаги** и **Включение**. Эта таблица создается во время настройки базы данных. Если таблица AbAttribute пуста, репликатор пользователей пропускает логику обработки таблицы AbUserEntry. Атрибуты сервера адресной книги являются динамическими и загружаются из таблицы AbAttribute, которые изначально записываются сервером адресной книги при его активации.

При активации сервера адресной книги таблица AbAttribute заполняется значениями, представленными в следующей таблице.


<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 33%" />
<col style="width: 33%" />
</colgroup>
<thead>
<tr class="header">
<th>Код</th>
<th>Имя</th>
<th>Флаги</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>1</p></td>
<td><p>givenName</p></td>
<td><p>0x01400000</p></td>
</tr>
<tr class="even">
<td><p>2</p></td>
<td><p>Sn</p></td>
<td><p>0x02400000</p></td>
</tr>
<tr class="odd">
<td><p>3</p></td>
<td><p>displayName</p></td>
<td><p>0x03420000</p></td>
</tr>
<tr class="even">
<td><p>4</p></td>
<td><p>Название</p></td>
<td><p>0x04000000</p></td>
</tr>
<tr class="odd">
<td><p>5</p></td>
<td><p>mailNickname</p></td>
<td><p>0x05400000</p></td>
</tr>
<tr class="even">
<td><p>6</p></td>
<td><p>Организация</p></td>
<td><p>0x06000000</p></td>
</tr>
<tr class="odd">
<td><p>7</p></td>
<td><p>physicalDeliveryOfficeName</p></td>
<td><p>0x07000000</p></td>
</tr>
<tr class="even">
<td><p>8</p></td>
<td><p>msRTCSIP-PrimaryUserAddress</p></td>
<td><p>0x08520C00</p></td>
</tr>
<tr class="odd">
<td><p>9</p></td>
<td><p>telephoneNumber</p></td>
<td><p>0x09022800</p></td>
</tr>
<tr class="even">
<td><p>10</p></td>
<td><p>homePhone</p></td>
<td><p>0x0A302800</p></td>
</tr>
<tr class="odd">
<td><p>11</p></td>
<td><p>Мобильный</p></td>
<td><p>0x0B622800</p></td>
</tr>
<tr class="even">
<td><p>12</p></td>
<td><p>otherTelephone</p></td>
<td><p>0x0C302000</p></td>
</tr>
<tr class="odd">
<td><p>13</p></td>
<td><p>ipPhone</p></td>
<td><p>0x0D302000</p></td>
</tr>
<tr class="even">
<td><p>14</p></td>
<td><p>Почта</p></td>
<td><p>0x0E500000</p></td>
</tr>
<tr class="odd">
<td><p>15</p></td>
<td><p>groupType</p></td>
<td><p>0x0F010800</p></td>
</tr>
<tr class="even">
<td><p>16</p></td>
<td><p>Отдел</p></td>
<td><p>0x10000000</p></td>
</tr>
<tr class="odd">
<td><p>17</p></td>
<td><p>Описание</p></td>
<td><p>0x11000100</p></td>
</tr>
<tr class="even">
<td><p>18</p></td>
<td><p>Руководитель</p></td>
<td><p>0x12040001</p></td>
</tr>
<tr class="odd">
<td><p>19</p></td>
<td><p>proxyAddress</p></td>
<td><p>0x00500105</p></td>
</tr>
<tr class="even">
<td><p>20</p></td>
<td><p>msExchHideFromAddressLists</p></td>
<td><p>0xFF000003</p></td>
</tr>
<tr class="odd">
<td><p>99</p></td>
<td><p>entryID</p></td>
<td><p>0x99000000</p></td>
</tr>
</tbody>
</table>


Числа в столбце **Код** должны быть уникальными и не должны использоваться повторно. Кроме того, если значения кода не превышают 256, это позволяет экономить место в выходных файлах, записанных сервером адресной книги. Однако максимальное значение кода равно 65535. Столбец **Имя** соответствует имени атрибута Active Directory, который репликатор пользователей должен поместить в таблицу AbUserEntry для каждого контакта. Значение столбца **Флаги** используется для определения типа атрибута. Следующие типы атрибутов сервера адресной книги распознаются репликатором пользователей, что указано в младшем байте значения в столбце **Флаги**.


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Атрибут</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>0x0</p></td>
<td><p>Строковый атрибут. Репликатор пользователей преобразует этот тип в UTF-8 перед сохранением в таблице AbUserEntry.</p></td>
</tr>
<tr class="even">
<td><p>0x1</p></td>
<td><p>Двоичный атрибут. Репликатор пользователей сохраняет его в BLOB-объекте без преобразования.</p></td>
</tr>
<tr class="odd">
<td><p>0x2</p></td>
<td><p>Это строковый атрибут, но он используется, только если значение атрибута начинается со строки &quot;tel:&quot;. Это прежде всего требуется для многозначных строковых атрибутов, в частности <strong>proxyAddresses</strong>. В этом случае сервер адресной книги интересуют только записи <strong>proxyAddresses</strong> , которые начинаются со строки &quot;tel:&quot;. Таким образом для экономии пространства, репликатор пользователей сохраняет только записи, начинающиеся со строки &quot;tel:&quot;.</p></td>
</tr>
<tr class="even">
<td><p>0x3</p></td>
<td><p>Логический строковый атрибут: если его значение равно TRUE, репликатор пользователей не включает этот контакт в таблицу AbUserEntry. Если значение атрибута равно FALSE, репликатор включает атрибуты данного контакта в таблицу AbUserEntry (но не определенный атрибут с этим флагом). Это еще один особый тип, который прежде всего предназначен для атрибута <strong>msExchHideFromAddressLists</strong>.</p></td>
</tr>
<tr class="odd">
<td><p>0x4</p></td>
<td><p>Строковый атрибут, который включается, только если значение атрибута начинается со строки &quot;smtp:&quot;и содержит символ &quot;@&quot;.</p></td>
</tr>
<tr class="even">
<td><p>0x5</p></td>
<td><p>Строковый атрибут, который включается, только если значение атрибута начинается со строки &quot;tel:&quot; или &quot;smtp:&quot;и содержит символ &quot;@&quot;.</p></td>
</tr>
<tr class="odd">
<td><p>0x100</p></td>
<td><p>Если этот параметр установлен, это многозначный атрибут, который может использоваться несколько раз для каждого контакта.</p></td>
</tr>
<tr class="even">
<td><p>0x400</p></td>
<td><p>Если этот параметр установлен, этот атрибут идентифицирует атрибут имени учетной записи электронной почты пользователя для контакта. Сервер адресной книги использует этот флаг, чтобы определить, какое значение атрибута будет показано в записи журнала событий нормализации телефона.</p></td>
</tr>
<tr class="odd">
<td><p>0x800</p></td>
<td><p>Если этот параметр задан, этот обязательный атрибут определяет для контакта. Сервер адресной книги добавляет пользователя в таблицу AbUserEntry только при наличии значения этого атрибута в Active Directory. Если существует несколько обязательных атрибутов, только у одного из них должно быть значение, чтобы пользователя был включен в таблицу AbUserEntry.</p></td>
</tr>
<tr class="even">
<td><p>0x1000</p></td>
<td><p>Если этот параметр установлен, сервер адресной книги всегда нормализует значение этого атрибута.</p></td>
</tr>
<tr class="odd">
<td><p>0x2000</p></td>
<td><p>Если этот параметр установлен, сервер адресной книги использует нормализованный номер из <strong>proxyAddresses</strong>, если параметр CMS <strong>UseNormalizationRules</strong> имеет значение False; в противном случае сервер действует оно ведет себя так же, как и при бите флага равном 0x1000.</p></td>
</tr>
<tr class="even">
<td><p>0x4000</p></td>
<td><p>Если этот параметр установлен, сервер адресной книги не включает в таблицу AbUserEntry объекты, содержащие это значение для заданного атрибута. Например, если в атрибуте <strong>msRTCSIP-PrimaryUserAddress</strong> задан этот бит флага. контакты с этим атрибутом не записываются в базу данных.</p></td>
</tr>
<tr class="odd">
<td><p>0x8000</p></td>
<td><p>Если этот параметр установлен, сервер адресной книги не включает в таблицу AbUserEntry объекты без этого значения для указанного атрибута. Если для объекта установлены оба битовых флажка 0x4000 и 0x8000, атрибут со значением флаг 0x4000 имеет приоритет, а объект исключается из таблицы AbUserEntry.</p></td>
</tr>
<tr class="even">
<td><p>0x10000</p></td>
<td><p>Если этот параметр задан, данный объект представляет собой объект группы. Репликатор пользователей использует этот флаг для включения контактов с атрибутом <strong>groupType</strong>, наличие которого указывает на группу (например, список рассылки или группу безопасности).</p></td>
</tr>
<tr class="odd">
<td><p>0x20000</p></td>
<td><p>Если этот параметр задан, репликатор пользователей использует этот флаг для включения этого атрибута в файлы сервера адресной книги определенного устройства (то есть DABS-файлы).</p></td>
</tr>
</tbody>
</table>


В предыдущих версиях Lync Server при внесении изменения в Active Directory администратору требовалось выполнить командлеты **Update -CSUserDatabase** и **Update –CSAddressBook**Windows PowerShell, чтобы незамедлительно сохранить изменение в пользовательской базе данных Lync Server и базе данных RTCab. В Lync Server 2013 репликатор пользовательских данных Lync Server извлекает изменения из Active Directory и обновляет пользовательскую базу данных Lync Server на основе заданного интервала. Репликатор пользовательских данных Lync Server также быстро распространяет изменения в базу данных RTCab без необходимости запуска командлета Update-CSAddressBook. Если веб-запрос адресной книги включен, изменения отражаются в результатах поиска клиентов Lync. Администраторам нужно выполнить Update -CSAddressBook, только если включена загрузка файла адресной книги.

> [!NOTE]  
> По умолчанию репликатор пользовательских данных Lync Server автоматически запускается каждые 5 минут. Этот интервал можно настроить с помощью командлета Set -CSUserReplicatorConfiguration -ReplicationCycleInterval &lt;&gt;.

## Фильтрование адресной книги

Пользователями, добавленными в файлы сервера адресной книги, можно управлять с помощью определенных атрибутов Доменные службы Active Directory, указанных в таблице AbAttribute. Одним таким атрибутом, используемым для фильтрации, является **msExchangeHideFromAddressBook**.Это атрибут пользователя, добавляемый схемой Exchange. Если значение этого атрибута равно TRUE, Exchange Server использует его, чтобы скрыть контакт из глобального списка адресов (GAL) Outlook. Аналогично, если значение атрибута равно TRUE, репликатор пользователей не включает этого пользователя в таблицу AbUserEntry, при этом данный пользователь не будет включен в файлы сервера адресной книги.

Вы можете использовать некоторые флаги для определения фильтра, который будет использоваться для атрибутов сервера адресной книги. Например, наличие определенных флагов может идентифицировать атрибут как включаемый или исключаемый. Репликатор пользователей фильтрует контакты, которые содержат атрибут исключения и фильтрует содержимое без атрибута включения.

> [!WARNING]  
> Дополнительные сведения о фильтрации адресной книги см. в разделе <a href="https://technet.microsoft.com/en-us/library/gg415643(v=ocs.15)">Командлеты сервера адресной книги</a> и <a href="http://go.microsoft.com/fwlink/?linkid=330430">Фильтрация адресной книги Lync 2013</a>

В настоящее время существует три разных фильтров, перечисленные в следующей таблице.


<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>Атрибут</th>
<th>Описание</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>0x800</p></td>
<td><p>Если этот параметр задан, он определяет обязательный атрибут для контакта. Репликатор пользователей применяет этот флаг, чтобы фильтровать контакты, которые не содержат по крайней мере один необходимый атрибут. OuPathId является обязательным атрибутом, который всегда устанавливается. Также необходимо задать по крайней мере один из других обязательных атрибутов. В противном случае контакт (то есть значение обязательного атрибута OuPathId) по-прежнему не будет записано в базу данных. Например, если <strong>telephoneNumber</strong> и <strong>HomePhone</strong> определены как обязательные атрибуты, только контакты, у которых есть хотя бы один из этих атрибутов, будут записаны в базу данных.</p></td>
</tr>
<tr class="even">
<td><p>0x4000</p></td>
<td><p>Если этот атрибут задан, он определяет атрибут исключения. Репликатор пользователей использует этот флаг для фильтрация контактов, содержащих этот атрибут. Например, если <strong>msRTCSIP-PrimaryUserAddress</strong> определен как атрибут исключения, контакты с этим атрибутом не записываются в базу данных.</p></td>
</tr>
<tr class="odd">
<td><p>0x8000</p></td>
<td><p>Если этот атрибут задан, он определяет атрибут включения. Репликатор пользователей использует этот флаг для фильтрация контактов, не содержащих этот атрибут. Например, если <strong>msRTCSIP-PrimaryUserAddress</strong> определен как атрибут включения, только контакты с этим атрибутом записываются в базу данных.</p></td>
</tr>
</tbody>
</table>


> [!NOTE]  
> Если оба флага 0x4000 (атрибут исключения) и 0x8000 (атрибут включения) установлены, бит 0x4000 переопределяет бит 0x8000, а контакт исключается.

Хотя вы можете фильтровать адресную книгу так, чтобы включить только определенных пользователей, ограничение записей не ограничивает возможностей других пользователей для связи с отфильтрованными пользователями или просмотра сведений об их присутствии. Пользователи всегда могут выполнять поиск, вручную отправлять мгновенные сообщения или вручную инициировать вызовы пользователей, не входящих в адресную книгу, вводя полное имя входа пользователя. Кроме того, контактные данные пользователя также можно найти в Outlook.

Хотя наличие полных записей контактов в файлах адресной книги позволяет использовать Lync Server для инициации создания сообщения электронной почты, телефонных вызовов или вызовов корпоративной голосовой связи (если она включена на сервере) для связи с пользователями, не настроенными для протокола SIP, некоторые организации предпочитают включать в записи сервера адресной книги только пользователей с поддержкой SIP. Вы можете фильтровать адресную книгу так, чтобы включить в нее только пользователей с поддержкой SIP, сняв бит 0x800 в столбце **Флаги** следующих обязательных атрибутов: **mailNickname**, **telephoneNumber**, **homePhone** и **mobile**. Вы также можете отфильтровать адресную книгу, чтобы включить в нее только пользователей с поддержкой SIP, установив флаг 0x8000 (атрибут включения) в столбце **Флаги** атрибута **msRTCSIP-PrimaryUserAddress**. Это также помогает исключить учетные записи службы из файлов адресной книги.

После изменения таблицы AbAttribute вы можете обновить данные в таблице AbUserEntry, выполнив командлет **Update-CsUserDatabase**. После завершения репликации UR, можно обновить файл в хранилище файлов сервера адресной книги вручную, выполнив командлет **UpdateCsAddressBook**.

> [!NOTE]  
> Сервер переднего плана, на котором размещается сервер адресной книги, не настраивается административно. Он выбирается во время развертывания, обычно это первый развертываемый сервер переднего плана. В случае сбоя служба адресной книги перемещается на другой сервер переднего плана, что не требует вмешательства администратора.

> [!IMPORTANT]  
> Если вы консолидировали или иначе изменили вашу инфраструктуру с развертывания с несколькими лесами или развертывания с предком и потомком (например, при консолидации инфраструктуры перед переходом на Lync Server), загрузка службы адресной книги и веб-запросы адресной книги могут завершаться с ошибкой для некоторых пользователей. В развертывании со множеством доменов или лесов атрибут <strong>MsRTCSIP-OriginatorSid</strong> заполняется в объектах пользователей, которые вызывают проблему. Для атрибута <strong>MsRTCSIP-OriginatorSid</strong> необходимо задать значение NULL в этих объектах, чтобы устранить проблему.
