---
title: Принципы работы сервера сохраняемого сеанса беседы в Lync Server 2013
TOCTitle: Принципы работы сервера сохраняемого сеанса беседы в Lync Server 2013
ms:assetid: 3d04e9a1-3f0c-458e-bcbe-d27c8c464276
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ683096(v=OCS.15)
ms:contentKeyID: 49887954
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Принципы работы сервера сохраняемого сеанса беседы в Lync Server 2013

 

_**Дата изменения раздела:** 2012-11-21_

Сервер сохраняемого сеанса беседыLync Server 2013 позволяет участвовать в многосторонних тематических беседах, которые продолжаются в течение некоторого времени. Сервер сохраняемого сеанса беседы позволяет организации решать перечисленные ниже задачи.

  - Улучшать коммуникации между географически разделенными и многофункциональными отделами

  - Повышать информированность и степень участия

  - Улучшать коммуникации в расширенной организации

  - Снижать информационные перегрузки

  - Расширять осведомленность

  - Распространять важные знания и сведения

Сервер сохраняемого сеанса беседы можно развернуть в качестве дополнительной роли Lync Server 2013. Службы сохраняемый сеанс беседы запускаются в выделенном пуле, и пул серверов сохраняемого сеанса беседы зависит от пула Lync Server в плане маршрутизации сообщений. Клиенты используют протокол XCCOS (eXtensible Chat Communication Over SIP). Серверы переднего планаLync Server настраиваются для маршрутизации трафика в пул серверов сохраняемого сеанса беседы.

## Высокоуровневая архитектура

На следующих схемах приведены высокоуровневая оценка архитектуры и служб сервера сохраняемого сеанса беседы.

**Высокоуровневая архитектура сервера сохраняемого чата**

![Архитектура сервера сохраняемого чата.](images/JJ683096.5db6f36f-4461-4d87-ba77-463b7ffe609b(OCS.15).jpg "Архитектура сервера сохраняемого чата.")

**Высокоуровневые службы сервера сохраняемого чата**

![Компоненты сервера сохраняемого чата.](images/JJ683096.b6d743aa-3a86-4081-aaef-4fe3257db4e7(OCS.15).jpg "Компоненты сервера сохраняемого чата.")

На сервере сохраняемого сеанса беседыпереднего плана работают две службы:

  - Сохраняемый чат (канал)

  - Соответствие

## Служба сохраняемого чата (канала)

Служба сохраняемый сеанс беседы (канал) является основной службой, ответственной за сервер сохраняемого сеанса беседы. Данная служба предоставляет следующие функции.

  - Принимает входящие сообщения

  - Регистрирует и отображает сетевых участников в комнате сохраняемого сеанса беседы

  - Передает сообщения другим подписчикам канала

  - Реализует логику управления каналом, приглашения в комнату чата и уведомлений о появлении нового контента

Служба сохраняемый сеанс беседы (канал) сохраняет и обеспечивает доступ к контенту комнаты чата и другим системным метаданным (правила авторизации и т. д.) с помощью хранилища сохраняемый сеанс беседы. Данная служба сохраняет файлы, загруженные в комнаты чатов в хранилище файлов сохраняемый сеанс беседы.

## Служба соответствия

Служба соответствия является дополнительным компонентом сервера сохраняемого сеанса беседы. Она несет ответственность за архивацию контента чатов и событий в хранилище соответствия сервера сохраняемый сеанс беседы. Если организация придерживается нормативным требованиям, в соответствии с которыми активность на сервере сохраняемый сеанс беседы должна архивироваться, можно развернуть дополнительную службу соответствия сервера сохраняемый сеанс беседы. Служба соответствия устанавливается на каждом сервере сохраняемого сеанса беседы в пуле сохраняемый сеанс беседы. После настройки служба соответствия сохраняемого сеанса беседы регистрирует активность пользователей, такую как вход в комнаты и выход из них, а также публикацию и чтение сообщений. Служба соответствия сохраняет файлы, которые должны быть заархивированы, в файловом хранилище соответствия сохраняемый сеанс беседы.

## Веб-службы сохраняемый сеанс беседы

На сервере Lync Serverпереднего плана работают две службы, которые зависят от Службы IIS и реализованы в качестве веб-компонентов.

  - **Веб-службы сохраняемых сеансов беседы для загрузки файлов на сервер и с сервера**. Служит для публикации и получения файлов при работе с комнатами чата.

  - **Веб-службы сохраняемый сеанс беседы для управления комнатами чатов**. Несут ответственность за предоставление пользователям возможности управления комнатами чатов и создания новых комнат чатов.

## С чего можно начать использование сервера сохраняемого сеанса беседы?

Сервер сохраняемого сеанса беседы является дополнительной ролью сервера в рамках инфраструктуры Lync Server 2013. Если установить роль сохраняемого сеанса беседы, любые пользователи, включенные администратором через политику, могут использовать сервер сохраняемый сеанс беседы с помощью своего клиента Lync 2013. Дополнительные сведения о развертывании сервера сохраняемого сеанса беседы и включения пользователей для эффективного использования возможностей политики см. в разделе [Развертывание сервера сохраняемого чата в Lync Server 2013](lync-server-2013-deploying-persistent-chat-server.md).

Подробные сведения о настройке параметров в развертывании сохраняемого сеанса беседы см. в разделах [Развертывание сервера сохраняемого чата в Lync Server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [Управление Lync Server 2013 и сервером сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md).

Сведения о включении пользователей на основе политики, например чтобы они могли воспользоваться функциональными возможностями сохраняемых сеансов беседы в клиенте Lync 2013 см. в разделах [Развертывание сервера сохраняемого чата в Lync Server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [Управление Lync Server 2013 и сервером сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md).

При развертывании возможностей соответствия для сохраняемых сеансов беседы сведения о настройке параметров соответствия требованиям см. в разделе [Управление Lync Server 2013 и сервером сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md).

## Потоки вызовов сохраняемых сеансов беседы

Клиент Lync связывается со службой сохраняемых сеансов беседы с помощью протокола XCCOS. Ниже описан процесс входа и типичный сценарий подписки на комнату и публикации сообщения.

## Вход

Ниже описан процесс входа.

1.  Сначала клиент Lync отправляет сообщение SIP SUBSCRIBE для получения с сервера документа автоматической подготовки. Данный документ указывает, включен ли на сервере сохраняемый сеанс беседы для этого пользователя, а также содержит список SIP URI для пула серверов сохраняемого сеанса беседы.

2.  Клиент Lync отправляет сообщение SIP INVITE на SIP URI сервера сохраняемого сеанса беседы, полученного на предыдущем шаге. За последовательностью INVITE следует сообщение 200 OK и ACK. Клиент Lync открыл сеанс SIP с конечной точкой сервера сохраняемого сеанса беседы. После этого клиент связывается с сервером сохраняемого сеанса беседы путем отправки сообщений SIP INFO, содержащих сообщения чата или команды, запрашивающие у сервера определенные действия. Все эти сообщения подтверждаются сообщениями 200 OK или 503 Служба недоступна (в случае большой нагрузки на сервер). Если клиент получает ответ 503, то пытается повторить сообщение. (В настоящем примере не включен ответ 503). Если сервер принимает сообщение и команду и передает сообщение 200 ОК, то предоставляет клиенту ответ в виде отдельного сообщения SIP INFO. Этот ответ включает ссылку на исходную команду.

3.  Клиент Lync отправляет сообщение SIP INFO, содержащее команду XCCOS **getserverinfo**. Сервер сохраняемого сеанса беседы отвечает новым сообщением SIP INFO, содержащим сведения о конфигурации службы сохраняемого сеанса беседы.

4.  Клиент Lync отправляет сообщение SIP INFO, содержащее команду XCCOS **getassociations**. Сервер сохраняемого сеанса беседы отвечает новым сообщением SIP INFO, содержащим список комнат, в которых данный пользователь является участником. Клиент Lync повторяет команду для получения списка комнат, в которых пользователь является менеджером.

5.  Клиент Lync получает список отслеживаемых комнат из документа "присутствия", в котором каждая отслеживаемая комната представлена категорией roomSetting. Присоединение ко всем отслеживаемым комнатам выполняется одним сообщением SIP INFO, содержащим команду XCCOS **bjoin**, содержащую список URI комнат. Так как список отслеживаемых комнат содержится на сервере, любой клиент на любом компьютере имеет одинаковый список отслеживаемых комнат для URI указанного пользователя. Клиент Lync также сохраняет список открытых комнат (если этот параметр включен пользователем) в реестре на локальном компьютере и присоединяется к каждой из этих комнат путем отправки сообщения SIP INFO, содержащего команду XCCOS **join** для каждой открытой комнаты. Так как этот список содержится в реестре, он может быть разным на двух клиентах Lync, запущенных на разных компьютерах.

6.  Для каждой комнаты, к которой было выполнено присоединение, клиент Lync передает сообщение SIP INFO, содержащее команду XCCOS **bccontext**. Сервер сохраняемого сеанса беседы отвечает новым сообщением SIP INFO, содержащим последнее сообщение чата в комнате.

7.  Клиент Lync отправляет сообщение SIP INFO, содержащее команду XCCOS **getinv** (то есть получение приглашения) для запроса любых новых приглашений в комнату, которые еще не были просмотрены этим клиентом. В отдельном сообщении SIP INFO сервер сохраняемого сеанса беседы возвращает список нужных комнат.

## Подписка на комнату и публикация сообщения

В следующей последовательности описан типичный сценарий подписки на комнату и публикации сообщения

1.  В клиенте Lync пользователь1 щелкает **Присоединиться к комнате чатов**, затем **Поиск**, после чего вводит какой-либо критерий поиска. Клиент отправляет сообщение SIP INFO, содержащее команду XCCOS **chansrch** (поиск комнаты) вместе с критерием поиска. Сервер сохраняемого сеанса беседы опрашивает внутреннюю базу данных и отвечает новым сообщением SIP INFO, содержащим список доступных комнат, соответствующих критерию поиска.

2.  Пользователь1 выбирает комнату чата, к которой хочет присоединиться, и щелкает пункт **Подписаться на эту комнату**. Клиент отправляет на сервер сохраняемого сеанса беседы сообщение SIP INFO, содержащее команду XCCOS **join** и идентификатор комнаты чата, выбранной пользователем. Сервер сохраняемого сеанса беседы отвечает сообщением SIP INFO, содержащим данные для подготовки.

3.  Клиент Lync отправляет серверу сохраняемого сеанса беседы сообщение SIP INFO, содержащее команду XCCOS **bccontext** (контекст ответов). Сервер сохраняемого сеанса беседы получает историю чатов и возвращает ее клиенту в отдельном сообщении SIP INFO. На этом этапе пользователь входит в комнату чата, готовый к участию в беседе.

4.  Пользователь1 вводит новое сообщение и нажимает кнопку **Отправить**. Клиент Lync публикует сообщение в комнате чата с помощью команды XCCOS **grpchat** в сообщении SIP INFO. Сервер сохраняемого сеанса беседы сохраняет копию этого нового сообщения во внутренней базе данных сохраняемых сеансов беседы.

5.  Сервер сохраняемого сеанса беседы отправляет отдельную копию сообщения SIP INFO XCCOS **grpchat** пользователю2, который уже вошел в комнату чата.

## Потоки вызовов соответствия сохраняемых сеансов беседы

Сервер сохраняемого сеанса беседы использует очередь сообщений (также известную как MSMQ) в качестве дополнительной базы данных соответствия (mgccomp) для обработки данных соответствия. Примером обработки событий соответствия является следующая последовательность событий, описывающая обработку события публикации сообщения.

1.  Пользователь публикует сообщение в комнате.

2.  Сервер сохраняемого сеанса беседы размещает информацию, относящуюся к событию, в частной очереди сообщений.

3.  Сервер соответствия сохраняемых сеансов беседы считывает это событие из очереди и помещает его в базу данных mgccomp для последующей обработки.

4.  Периодически сервер соответствия сохраняемых сеансов беседы обрабатывает набор событий в базе данных и отправляет их на обработку адаптеру соответствия сохраняемых сеансов беседы.

5.  Если адаптер успешно обрабатывает данные, сервер соответствия сохраняемых сеансов беседы удаляет события из базы данных mgccomp.

