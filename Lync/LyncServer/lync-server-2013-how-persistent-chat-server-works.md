---
title: 'Lync Server 2013: работа сервера сохраняемого чата'
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
f1.keywords:
- NOCSH
TOCTitle: How Persistent Chat Server works
ms:assetid: 3d04e9a1-3f0c-458e-bcbe-d27c8c464276
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ683096(v=OCS.15)
ms:contentKeyID: 49684643
ms.date: 07/23/2014
manager: serdars
mtps_version: v=OCS.15
ms.openlocfilehash: d919d7c9d955355a45ebf3c05391204ca919a3fa
ms.sourcegitcommit: 4d6bf5c58b2c553dc1df8375ede4a9cb9eaadff2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/16/2020
ms.locfileid: "48528176"
---
# <a name="how-persistent-chat-server-works-in-lync-server-2013"></a>Принцип работы сервера сохраняемого чата в Lync Server 2013

<div data-xmlns="http://www.w3.org/1999/xhtml">

<div class="topic" data-xmlns="http://www.w3.org/1999/xhtml" data-msxsl="urn:schemas-microsoft-com:xslt" data-cs="https://msdn.microsoft.com/">

<div data-asp="https://msdn2.microsoft.com/asp">



</div>

<div id="mainSection">

<div id="mainBody">

<span> </span>

_**Последнее изменение темы:** 2012-11-21_

Lync Server 2013, сервер сохраняемого чата позволяет принимать участие в многосторонних беседах на основе тем, которые сохраняются со временем. Сервер сохраняемого чата поможет вашей организации выполнить следующие действия:

  - Улучшить связь между рабочими группами, которые географически рассредоточены и выполняют разные функции.

  - Расширить доступ к информации и партнерские отношения.

  - Улучшить связь в крупной организации.

  - Уменьшить информационную нагрузку.

  - Улучшить информированность.

  - Увеличить распределение важного знания и информации.

Сервер сохраняемого чата можно развернуть в качестве дополнительной роли с Lync Server 2013. Службы сохраняемого чата выполняются в выделенном пуле, а пул серверов сохраняемого чата зависит от пула Lync Server для маршрутизации сообщений. Клиенты используют протокол XCCOS (eXtensible Chat Communication Over SIP). Серверы переднего плана Lync Server настраиваются на маршрутизацию трафика в пул серверов сохраняемого чата.

<div>

## <a name="high-level-architecture"></a>Высокоуровневая архитектура

На следующих схемах представлены высокие уровни архитектуры и служб сервера сохраняемого чата.

**Высокоуровневая архитектура сервера сохраняемого чата**

![Архитектура сервера сохраняемого чата.](images/JJ683096.5db6f36f-4461-4d87-ba77-463b7ffe609b(OCS.15).jpg "Архитектура сервера сохраняемого чата.")

**Высокоуровневые службы сервера сохраняемого чата**

![Компоненты сервера сохраняемого чата.](images/JJ683096.b6d743aa-3a86-4081-aaef-4fe3257db4e7(OCS.15).jpg "Компоненты сервера сохраняемого чата.")

На серверах переднего плана сервера сохраняемого чата выполняются две службы:

  - Сохраняемый чат (канал)

  - Соответствие требованиям

<div>

## <a name="persistent-chat-channel-service"></a>Служба сохраняемого чата (канала)

Служба сохраняемого чата (Channel) — это основная служба, ответственная за сервер сохраняемого чата. Данная служба предоставляет следующие функции.

  - Принимает входящие сообщения

  - Регистрация и перечисление интерактивных участников в комнате сохраняемого чата

  - Передает сообщения другим подписчикам канала

  - Реализует логику управления каналом, приглашения в комнату чата и уведомлений о появлении нового контента

Служба сохраняемого чата (канал) хранит и получает доступ к содержимому комнаты чата и другим системным метаданным (правилам авторизации и т. д.) с помощью хранилища сохраняемого чата. Эта служба хранит файлы, которые отправляются в комнаты чата в хранилище файлов сохраняемого чата.

</div>

<div>

## <a name="compliance-service"></a>Служба соответствия

Служба соответствия является опциональным компонентом сервера сохраняемого чата и отвечает за архивацию содержимого и событий чата в хранилище соответствия сохраняемого чата. Если в Организации есть нормативы, для которых требуется архивировать действия сохраняемого чата, можно развернуть необязательную службу соответствия сохраняемого чата. Служба соответствия устанавливается на каждом сервере сохраняемого чата в пуле сохраняемого чата. При настройке сервер сохраняемого чата регистрирует действия пользователя, такие как присоединение к комнатам и выход из них, а также учет и чтение сообщений. Служба соответствия хранит файлы, которые необходимо архивировать в хранилище файлов соответствия сохраняемого чата.

</div>

<div>

## <a name="persistent-chat-web-services"></a>Веб-службы сохраняемого чата

На серверах переднего плана Lync Server запускаются две службы, которые зависят от служб IIS, и реализуются как веб-компоненты:

  - **Веб-службы сохраняемого чата для отправки и загрузки файлов** Отвечает за разноски и получение файлов из комнат чата.

  - **Веб-службы сохраняемого чата для управления комнатами чата** Отвечает за предоставление пользователям возможности управления комнатами чата и создания новых комнат чата.

</div>

</div>

<div>

## <a name="how-do-i-start-using-persistent-chat-server"></a>Как начать работу с сервером сохраняемого чата?

Сервер сохраняемого чата является необязательной ролью сервера в инфраструктуре Lync Server 2013. При установке роли сервера сохраняемого чата все пользователи, которые были включены с помощью политики администратором, могут использовать сохраняемый чат с клиентом Lync 2013.

Сведения о развертывании сервера сохраняемого чата и о том, как разрешить пользователям использовать возможности с помощью политики, приведены [в разделе Развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md).

Сведения о настройке параметров развертывания сервера сохраняемого чата [в разделе Развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [управление Lync Server 2013, сервер сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md).

Сведения о том, как включить пользователям с помощью политики, чтобы использовать функции сохраняемого чата в клиенте Lync 2013, можно узнать в статье [развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [управление Lync Server 2013, сервер сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md).

Если вы развернули соответствие сохраняемого чата, ознакомьтесь со статьей [Управление Lync server 2013, сервер сохраняемого чата](managing-lync-server-2013-persistent-chat-server.md) для получения дополнительных сведений о настройке параметров для обеспечения соответствия требованиям.

</div>

<div>

## <a name="persistent-chat-call-flows"></a>Потоки вызовов сохраняемого чата

Клиент сохраняемого чата обменивается данными со службой сохраняемого чата с помощью XCCOS. В следующих последовательностях описывается процесс входа и типичный сценарий подписки на комнаты и публикации сообщений.

<div>

## <a name="sign-in"></a>Вход

Приведенная ниже схема и пошаговые инструкции описывают процесс входа.

**Процесс входа клиента сохраняемого чата**

![Схема последовательности вызовов сервера сохраняемого чата.](images/JJ683096.9b3b3c61-caca-42b6-853c-6a09e6ff5c44(OCS.15).jpg "Схема последовательности вызовов сервера сохраняемого чата.")

1.  Сначала клиент сохраняемого чата отправляет подписку по протоколу SIP, чтобы получить из сервера встроенный документ подготовки. Этот документ указывает, включено или выключено сохраняемый чат для пользователя и список URI SIP для пула серверов сохраняемого чата.

2.  Клиент сохраняемого чата отправляет сообщение SIP INVITE в URI SIP сервера сохраняемого чата, полученного на предыдущем шаге. После последовательного приглашения добавляется 200 ОК и подтверждение, а клиент сохраняемого чата теперь открыл сеанс SIP с конечной точкой сервера сохраняемого чата. Таким образом, клиент сохраняемого чата обменивается данными с сервером сохраняемого чата, отправляя сообщения SIP INFO, содержащие сообщения или команды чата, которые запрашивают сервер для выполнения действия. Все эти сообщения подтверждаются с помощью 200 ОК или 503 Служба недоступна (то есть в случае интенсивной загрузки сервера). Если клиент получает ответ 503, он повторит попытку отправки сообщения. (Этот пример не включает ответ 503.) Если сервер принимает сообщение или команду и отправляет 200 ОК, он предоставляет ответ клиенту в виде отдельного ИНФОРМАЦИОНного сообщения SIP. Этот ответ включает ссылку на исходную команду.

3.  Клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду XCCOS **жетсерверинфо** . Сервер сохраняемого чата отвечает с новым ИНФОРМАЦИОНным сообщением SIP, содержащим сведения о конфигурации службы сохраняемого чата.

4.  Клиент сохраняемого чата отправляет сообщение SIP INFO, которое **содержит команду XCCOS** . Сервер сохраняемого чата отвечает с новым ИНФОРМАЦИОНным сообщением SIP, содержащим список комнат, участником которых является пользователь. Клиент сохраняемого чата повторяет команду, чтобы получить список комнат, в которых пользователь является руководителем.

5.  Клиент сохраняемого чата получает список отслеживаемых комнат из документа "присутствие", где каждая проданная комната представлена категорией "Румсеттинг". Присоединение ко всем отслеживаемым комнатам выполняется одним сообщением SIP INFO, содержащим команду XCCOS **bjoin**, содержащую список URI комнат. Так как список отслеживаемых комнат содержится на сервере, любой клиент на любом компьютере имеет одинаковый список отслеживаемых комнат для URI указанного пользователя. Клиент сохраняемого чата также сохраняет список открытых комнат (если этот параметр включен пользователем) в реестре локального компьютера и присоединяется к каждой из этих комнат при входе, отправляя сообщение SIP INFO, которое содержит команду XCCOS **Join** для каждой открытой комнаты. Так как этот список хранится в реестре, он может различаться на двух клиентах сохраняемого чата, работающих на разных компьютерах.

6.  Для каждой присоединенной комнаты клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду XCCOS **бкконтекст** . Сервер сохраняемого чата отвечает новым ИНФОРМАЦИОНным сообщением SIP, содержащим Последнее сообщение чата в комнате.

7.  Клиент сохраняемого чата отправляет сообщение SIP INFO, содержащее команду XCCOS **жетинв** (то есть получить приглашение), чтобы запросить все новые приглашения на помещение, которые клиент еще не видел. В отдельном ИНФОРМАЦИОНном сообщении SIP сервер сохраняемого чата возвращает список этих комнат.

</div>

<div>

## <a name="subscribe-to-a-room-and-post-a-message"></a>Подписка на комнату и публикация сообщения

Приведенная ниже схема и пошаговые инструкции описывают типичный сценарий подписки на комнаты и записи сообщений.

**Подписку на помещение клиента сохраняемого чата и отправка сообщений по потребованию**

![Сценарий подписки на комнаты и записи сообщений.](images/JJ683096.2d3c417e-c91b-42bd-964e-285b72bb2e44(OCS.15).jpg "Сценарий подписки на комнаты и записи сообщений.")

1.  В клиенте сохраняемого чата пользователь user1 щелкает **Присоединение к комнате чата**, щелкает **Поиск**, а затем вводит некоторые условия поиска. Клиент сохраняемого чата отправляет сообщение SIP INFO, которое содержит команду XCCOS **чансрч** (Поиск комнаты), а также условия поиска. Сервер сохраняемого чата запрашивает внутреннюю базу данных и ответы в новом сообщении SIP INFO, которое содержит список доступных комнат, соответствующих условиям поиска.

2.  Пользователь1 выбирает комнату чата, к которой хочет присоединиться, и щелкает пункт **Подписаться на эту комнату**. Клиент сохраняемого чата отправляет на сервер сохраняемого чата сообщение информации SIP, содержащее команду **соединения** XCCOS, и идентификатор комнаты чата, выбранная пользователем. Сервер сохраняемого чата отвечает на сообщение SIP INFO, содержащее данные подготовки.

3.  Клиент сохраняемого чата отправляет на сервер сохраняемого чата сообщение сведений SIP, которое содержит команду XCCOS **бкконтекст** (context Chat). Сервер сохраняемого чата извлекает журнал бесед и возвращает его в клиент сохраняемого чата в отдельном ИНФОРМАЦИОНном сообщении SIP. На этом этапе пользователь входит в комнату чата, готовый к участию в беседе.

4.  Пользователь1 вводит новое сообщение и нажимает кнопку **Отправить**. Клиент сохраняемого чата отправляет сообщение в комнату чата с помощью команды SIP INFO XCCOS **грпчат** . Сервер сохраняемого чата сохраняет копию этого нового сообщения в фоновой базе данных сохраняемого чата.

5.  Сервер сохраняемого чата отправляет отдельную копию сообщения SIP XCCOS **грпчат** в Пользователь2, который уже ввел комнату чата.

</div>

</div>

<div>

## <a name="persistent-chat-compliance-call-flows"></a>Потоки вызовов соответствия сохраняемого чата

Сервер сохраняемого чата использует очередь сообщений (также называемую MSMQ) и дополнительную базу данных соответствия (mgccomp) для обработки данных соответствия требованиям. Примером обработки событий соответствия является следующая последовательность событий, описывающая обработку события публикации сообщения.

1.  Пользователь публикует сообщение в комнате.

2.  Сервер сохраняемого чата размещает сведения, относящиеся к событию в частной очереди Message Queuing.

3.  Сервер соответствия сохраняемого чата читает это событие из очереди и помещает его в базу данных mgccomp для дальнейшей обработки.

4.  Периодически сервер соответствия сохраняемого чата обрабатывает набор событий в базе данных и отправляет их в адаптер соответствия сохраняемого чата для обработки.

5.  Если адаптер успешно обрабатывает данные, сервер соответствия сохраняемого чата удаляет события из базы данных mgccomp.

</div>

</div>

<span> </span>

</div>

</div>

</div>

