---
title: 'Lync Server 2013: как работает сервер сохраняемого чата'
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
TOCTitle: How Persistent Chat Server works
ms:assetid: 3d04e9a1-3f0c-458e-bcbe-d27c8c464276
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ683096(v=OCS.15)
ms:contentKeyID: 49684643
ms.date: 07/23/2014
manager: serdars
mtps_version: v=OCS.15
ms.openlocfilehash: 0bf6179e1ce24264c2079b3096fa9bb8c539ca1c
ms.sourcegitcommit: bb53f131fabb03a66f0d000f8ba668fbad190778
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2019
ms.locfileid: "34834071"
---
<div data-xmlns="http://www.w3.org/1999/xhtml">

<div class="topic" data-xmlns="http://www.w3.org/1999/xhtml" data-msxsl="urn:schemas-microsoft-com:xslt" data-cs="http://msdn.microsoft.com/en-us/">

<div data-asp="http://msdn2.microsoft.com/asp">

# <a name="how-persistent-chat-server-works-in-lync-server-2013"></a>Как работает сервер сохраняемого чата в Lync Server 2013

</div>

<div id="mainSection">

<div id="mainBody">

<span> </span>

_**Тема последнего изменения:** 2012-11-21_

Lync Server 2013, сервер сохраняемого чата позволяет принимать участие в многокомпонентных беседах, которые сохраняются с течением времени. Сервер сохраняемого чата может помочь вашей организации выполнять указанные ниже действия.

  - Улучшена связь между географически распределенными и функциональными группами

  - Расширение возможностей для информирования о информации и участия в них

  - Повышение эффективности общения с помощью расширенной Организации

  - Уменьшить перегрузку данных

  - Улучшенная поддержка информации

  - Повышайте разброса важных знаний и данных

Вы можете развернуть сохраняемый сервер чата как необязательную роль в Lync Server 2013. Службы сохраняемого чата выполняются на выделенном пуле, а пул серверов сохраняемого чата зависит от пула сервера Lync Server для маршрутизации сообщений. Клиенты используют расширяемую связь в чате по протоколу SIP (КСККОС). Серверы переднего плана Lync Server настроены так, чтобы перенаправлять трафик в пул сервера сохраняемого чата.

<div>

## <a name="high-level-architecture"></a>Архитектура высокого уровня

На приведенных ниже схемах представлены точки зрения серверной архитектуры и служб сохраняемого чата.

**Высокоуровневая архитектура сервера сохраняемого чата**

![Серверная архитектура сохраняемого чата.] (images/JJ683096.5db6f36f-4461-4d87-ba77-463b7ffe609b(OCS.15).jpg "Серверная архитектура сохраняемого чата.")

**Высокоуровневые службы сервера сохраняемого чата**

![Серверные компоненты сохраняемого чата.] (images/JJ683096.b6d743aa-3a86-4081-aaef-4fe3257db4e7(OCS.15).jpg "Серверные компоненты сохраняемого чата.")

На серверном сервере сохраняемого чата две службы выполняются на серверах клиентского доступа.

  - Сохраняемый чат (канал)

  - О

<div>

## <a name="persistent-chat-channel-service"></a>Служба сохраняемого чата (канала)

Служба сохраняемого чата – это основная служба, ответственная за сохраняемый сервер чата. Эта служба предоставляет следующие функции:

  - Принимает входящие сообщения

  - Регистрирует участников, подключенных к комнате сохраняемого чата, и выводит их списки

  - Передает сообщения другим подписчикам канала

  - Реализация логики управления каналами, приглашением на комнату чата, поиском и новыми уведомлениями о содержимом

Служба сохраняемого чата (канала) хранит и обращается к содержимому комнаты чата и другим системным метаданным (правилам авторизации и т. д.) с помощью хранилища сохраняемого чата. Эта служба хранит файлы, которые отправляются в комнаты чата в хранилище файлов сохраняемого чата.

</div>

<div>

## <a name="compliance-service"></a>Служба соответствия требованиям

Служба соответствия является опциональным компонентом постоянного сервера чатов и отвечает за архивирование содержимого чата и событий в магазине соответствия требованиям в отношении сохраняемого чата. Если организация придерживается нормативных требований, в соответствии с которыми активность на сервере сохраняемого чата должна архивироваться, можно развернуть дополнительную службу соответствия сохраняемого чата. Служба соответствия устанавливается на каждый сервер сохраняемого чата в пуле сохраняемого чата. При настройке сохраняемый сервер чата регистрирует действия пользователей, такие как присоединение к комнатам и выход из них, а также отправка и чтение сообщений. Служба соответствия хранит файлы, которые должны быть архивированы в хранилище файлов соответствия требованиям сохраняемого чата.

</div>

<div>

## <a name="persistent-chat-web-services"></a>Веб-службы сохраняемого чата

На серверах переднего плана Lync Server выполняются две службы, которые зависят от служб IIS и реализованы как веб-компоненты.

  - **Веб-службы сохраняемого чата для отправки и скачивания файлов** Ответственен за публикацию и получение файлов из комнат чата.

  - **Веб-службы сохраняемого чата для управления комнатой чата** Ответственность за предоставление пользователям возможности управлять комнатами чатов, а также создавать комнаты чатов.

</div>

</div>

<div>

## <a name="how-do-i-start-using-persistent-chat-server"></a>Как начать работу с сохраняемым сервером чата?

Сервер сохраняемого чата — это необязательная роль сервера в инфраструктуре Lync Server 2013. Если вы установили серверную роль "сохраняемый чат", все пользователи, которые были включены администратором с помощью политики, могут использовать для клиента Lync 2013 сохраняемый чат.

Подробнее о том, как развернуть сервер сохраняемого чата и разрешить пользователям использовать возможности с помощью политики, можно найти [в разделе Развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md).

Подробнее о том, как настроить параметры конфигурации сервера сохраняемого чата, можно найти [в разделе Развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [Управление сервером Lync Server 2013, сохраняемый сервер чата](managing-lync-server-2013-persistent-chat-server.md).

Дополнительные сведения о том, как включить использование функции сохраняемого чата в клиенте Lync 2013, можно найти в разделе [развертывание сервера сохраняемого чата в Lync server 2013](lync-server-2013-deploying-persistent-chat-server.md) и [Управление приложением Lync Server 2013, сохраняемый сервер чата](managing-lync-server-2013-persistent-chat-server.md).

Если вы развернули постоянную совместимость чата, ознакомьтесь со статьей [Управление сервером Lync server 2013, сохраняемый сервер чата](managing-lync-server-2013-persistent-chat-server.md) для получения подробных сведений о том, как настроить параметры соответствия требованиям.

</div>

<div>

## <a name="persistent-chat-call-flows"></a>Потоки звонков в сохраняемый чат

Клиент сохраняемый чат взаимодействует со службой сохраняемого чата с помощью КСККОС. Следующие последовательности описывают процесс входа и типичную подписку на комнату и сценарий публикации сообщения.

<div>

## <a name="sign-in"></a>Вход в учетную запись

На приведенном ниже рисунке показано, как пошаговые инструкции описывают процесс входа.

**Поток звонков для входа клиента в сохраняемый чат**

![Схема потока звонка для сервера сохраняемого чата.] (images/JJ683096.9b3b3c61-caca-42b6-853c-6a09e6ff5c44(OCS.15).jpg "Схема потока звонка для сервера сохраняемого чата.")

1.  Клиент сохраняемого чата сначала отправляет абонентскую подписку, чтобы извлечь из сервера документ для подготовки из стандартного диапазона. Этот документ указывает на то, включена или отключена сохраняемый чат для пользователя, а также список URI SIP для пула серверов сохраняемого чата.

2.  Клиент сохраняемого чата отправляет сообщение INVITE по протоколу SIP URI SIP сервера сохраняемого чата, полученного на предыдущем этапе. После последовательного приглашения на приглашение выдается 200 ОК и подтверждение, а клиент сохраняемый чат теперь открыл сеанс SIP с постоянной конечной точкой сервера чата. Таким образом, клиент сохраняемый чат будет взаимодействовать с сохраняемым сервером чата, отправив информационные сообщения SIP, которые содержат сообщения или команды чата, требующие от сервера выполнения действия. Все эти сообщения подтверждаются с помощью 200 ОК или 503 Служба недоступна (то есть в случае высокой нагрузки на сервер). Если клиент получает ответ 503, он попытается повторить сообщение. (Этот пример не включает ответ 503.) Если сервер принимает сообщение или команду и отправляет 200 ОК, он предоставляет ответ клиенту в форме отдельного ИНФОРМАЦИОНного сообщения SIP. Этот ответ включает ссылку на команду "источник".

3.  Клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду КСККОС **жетсерверинфо** . Сохраняемый сервер чата отправляет ответы с новым ИНФОРМАЦИОНным сообщением SIP, содержащим сведения о конфигурации службы "сохраняемый чат".

4.  Клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду КСККОС **** -Associations. Сохраняемый сервер чатов ответы с новым ИНФОРМАЦИОНным сообщением SIP, содержащим список комнат, участником которых является пользователь. Клиент сохраняемый чат повторяет команду, чтобы получить список комнат, в которых пользователь является руководителем.

5.  Клиент сохраняемого чата получает список отслеживаемых комнат из документа "присутствие", где каждая отслеживаемая комната представлена категорией "Румсеттинг". Все отслеживаемые комнаты будут соединены одним сообщением SIP INFO, содержащим команду КСККОС **bЧтобы присоединиться** , которая включает список URI комнаты. Поскольку список отслеживаемых комнат хранится на сервере, любой клиент на компьютере имеет один и тот же список отслеживаемых комнат для указанного URI пользователя. Клиент сохраняемый чат также хранит список открытых комнат (если этот параметр включен пользователем) в реестре локального компьютера и присоединяется к каждой из этих комнат при входе, отправляя ИНФОРМАЦИОНное сообщение SIP, содержащее команду КСККОС **Join** для каждой открытой комнаты. . Так как этот список хранится в реестре, он может различаться на двух клиентах с сохраненным разговором, запущенных на разных компьютерах.

6.  Для каждой присоединенной комнаты клиент "сохраняемый чат" отправляет сообщение SIP INFO, содержащее команду КСККОС **бкконтекст** . Сохраняемый сервер чата отправляет ответы с новым ИНФОРМАЦИОНным сообщением SIP, содержащим Последнее сообщение чата в комнате.

7.  Клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду КСККОС **жетинв** (то есть приглашение), чтобы запросить все новые приглашения на конференцию, которые еще не видели клиент. В отдельном ИНФОРМАЦИОНном сообщении SIP сервер сохраняемого чата возвращает список этих комнат.

</div>

<div>

## <a name="subscribe-to-a-room-and-post-a-message"></a>Подписка на комнату и публикация сообщения

На приведенном ниже рисунке приводится описание типичной подписки на комнату и сценария записи сообщения.

**Подписку на клиентскую комнату для сохраняемого чата и отправка сообщения в потоке звонков**

![Подписка на комнату и сценарий публикации сообщения.] (images/JJ683096.2d3c417e-c91b-42bd-964e-285b72bb2e44(OCS.15).jpg "Подписка на комнату и сценарий публикации сообщения.")

1.  Из клиента для сохраняемого чата пользователь user1 щелкает присоединиться **к комнате чата**, нажмет кнопку **Поиск**, а затем вводит некоторые условия поиска. Клиент сохраняемого чата отправляет ИНФОРМАЦИОНное сообщение SIP, содержащее команду КСККОС **чансрч** (Поиск комнаты), а также условия поиска. Сервер сохраняемого чата отправляет запросы на заполненную базу данных и ответы в новом сообщении SIP INFO, содержащем список доступных комнат, отвечающих условиям поиска.

2.  Пользователь1 выберет комнату чата, к которой ей нужно присоединиться, и щелкаем подписаться на **эту комнату**. Клиент сохраняемого чата отправляет на сервер сохраняемого чата сообщение о SIP, содержащее команду "присоединиться **к** ксккос", и код комнаты комнаты чата, в которой выбран пользователь. Сохраняемый сервер чата отвечает на сообщение информации SIP, содержащее данные подготовки.

3.  Клиент сохраняемого чата отправляет на сервер сохраненного чата сообщение о SIP, содержащее команду КСККОС **бкконтекст** (контекст чата). Сервер сохраняемого чата извлекает историю чата и возвращает его в сохраняемый клиент чата в отдельном сообщении SIP INFO. На этом этапе пользователь вводит комнату чата и готова принять участие.

4.  Пользователь1 вводит новое сообщение, а затем нажимает кнопку " **Отправить**". Клиент сохраняемый чат отправляет сообщение в комнату чата с помощью команды SIP INFO КСККОС **грпчат** . Сохраняемый сервер чата сохраняет копию этого сообщения в базе данных сохраняемого обратного чата.

5.  Сервер сохраняемого чата отправляет отдельную копию сообщения SIP КСККОС **грпчат** в Пользователь2, который уже ввел в комнату чата.

</div>

</div>

<div>

## <a name="persistent-chat-compliance-call-flows"></a>Потоки звонков для соблюдения требований в отношении сохраняемого чата

Сервер сохраняемого чата использует очередь сообщений (также называемую MSMQ) и дополнительную базу данных соответствия (мгккомп) для обработки данных соответствия требованиям. В качестве примера обработки событий соответствия в приведенной ниже последовательности событий описывается обработка события POST сообщения.

1.  Пользователь отправляет сообщение в комнату.

2.  Сервер сохраняемого чата помещает сведения о событии в частную очередь Message Queuing.

3.  Сохраняемый чат сервер для обеспечения соответствия требованиям читает это событие из очереди и помещает его в базу данных мгккомп для дальнейшей обработки.

4.  Периодически сервер соответствия требованиям к чат обрабатывает набор событий в базе данных и отправляет их на постоянный адаптер соответствия чатов для обработки.

5.  Если адаптер успешно обрабатывает данные, сервер соответствия требованиям сохраняемый чат удаляет события из базы данных мгккомп.

</div>

</div>

<span> </span>

</div>

</div>

</div>

