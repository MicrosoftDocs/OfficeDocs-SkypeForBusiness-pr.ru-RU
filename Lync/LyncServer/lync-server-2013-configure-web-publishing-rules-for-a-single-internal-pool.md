---
title: 'Lync Server 2013: настройка правил веб-публикации для единого внутреннего пула'
TOCTitle: Настройка правил веб-публикации для единого внутреннего пула
ms:assetid: 86ff4b2a-1ba9-46a2-a175-8b19e00a49dd
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/Gg429712(v=OCS.15)
ms:contentKeyID: 49310426
ms.date: 12/10/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Настройка правил веб-публикации для единого внутреннего пула в Lync Server 2013

 

_**Дата изменения раздела:** 2016-12-08_

Шлюз Microsoft Forefront Threat Management Gateway 2010 и маршрутизация запросов приложений IIS (IIS ARR) используют правила веб-публикации для публикации внутренних ресурсов, таких как URL-адреса собраний, для пользователей в Интернете.

Помимо URL-адресов веб-служб для виртуальных каталогов, следует также создать правила публикации для простых URL-адресов, URL-адресов LyncDiscover и Сервер Office Web Apps. Для каждого простого URL-адреса необходимо создать отдельное правило на обратном прокси-сервере, указывающее на этот адрес.

Если вы развертываете службу мобильности и используете автоматическое обнаружение, вам необходимо создать правило публикации для внешнего URL-адреса службы автообнаружения. Автоматическое обнаружение также требует правил публикации внешнего URL-адреса веб-служб Lync Server для Директоров и переднего плана. Подробные сведения о создании правил веб-публикации для автоматического обнаружения см. в разделе [Настройка обратного прокси-сервера для мобильной работы в Lync Server 2013](lync-server-2013-configuring-the-reverse-proxy-for-mobility.md).

Чтобы создать правила веб-публикации, используйте следующие инструкции.

> [!NOTE]  
> Предполагается, что вы установили стандартный выпуск шлюза Forefront Threat Management Gateway (TMG) 2010 или установили и настроили IIS с расширением маршрутизации запросов приложений (IIS ARR) . Можно использовать либо шлюз TMG, либо маршрутизацию запросов приложений IIS.

## Создание правила публикации веб-сервера на компьютере с TMG 2010

1.  В меню **Пуск** последовательно выберите пункты **Программы** , **Microsoft Forefront TMG** и **Управление Forefront TMG** .

2.  В области слева разверните узел **Имя сервера** , щелкните правой кнопкой мыши пункт **Политика брандмауэра** , выберите пункт **Создать** и щелкните **Правило публикации веб-сайта** .

3.  На странице **Новое правило веб-публикации** введите отображаемое имя правила публикации (например, LyncServerWebDownloadsRule).

4.  На странице **Выбрать действие правила** выберите пункт **Разрешить** .

5.  На странице **Тип публикации** выберите пункт **Опубликовать один веб-сайт или систему балансировки нагрузки** .

6.  На странице **Безопасность подключения к серверу** выберите пункт **Использовать SSL для подключения к опубликованному веб-серверу или ферме серверов** .

7.  На странице **Внутренние сведения публикации** в поле **Внутреннее имя сайта** введите полное доменное имя внутренней веб-фермы, в которой размещается содержимое собраний и адресной книги.
    
    > [!NOTE]  
    > Если внутренний сервер представляет собой сервер Standard Edition, необходимо ввести его полное доменное имя. Если внутренний сервер является интерфейсным пулом, в качестве полного доменного имени следует указать виртуальный IP-адрес аппаратного балансировщика нагрузки, который распределяет нагрузку на веб-серверы внутренней фермы. Сервер TMG должен иметь возможность разрешать полное доменное имя в IP-адрес внутреннего веб-сервера. Если сервер TMG не может разрешить полное доменное имя в правильный IP-адрес, выберите пункт <strong>Используйте имя или IP-адрес компьютера для подключения к опубликованному серверу</strong> , а затем в поле <strong>Имя компьютера или</strong> <strong>IP-адрес</strong> введите IP-адрес внутреннего веб-сервера. В этом случае следует убедиться в том, что на сервере TMG открыт порт 53 и что этот сервер может связаться с сервером DNS, находящимся в сети периметра. Вы также можете обеспечить разрешение имен с помощью записей в файле локальных узлов.

8.  На странице **Внутренние сведения публикации** в поле **Путь (необязательно)** введите **/\*** в качестве пути к публикуемой папке.
    
    > [!NOTE]  
    > В мастере публикации веб-сайта можно указать только один путь. Дополнительные пути можно добавить путем изменения свойств правила.

9.  На странице **Параметры внешнего имени** убедитесь в том, что в разделе **Принимать запросы для** выбран пункт **Это имя домена** , и введите полное доменное имя внешних веб-служб в поле **Внешнее имя** .

10. На странице **Выбрать веб-прослушиватель** нажмите кнопку **Создать** , чтобы открыть мастер определения нового веб-прослушивателя.

11. На странице **Мастер создания веб-прослушивателя** в поле **Имя веб-прослушивателя** введите имя веб-прослушивателя (например, LyncServerWebServers).

12. На странице **Безопасность клиентских подключений** выберите пункт **Требовать безопасного подключения SSL для клиентов** .

13. На странице **IP-адрес веб-прослушивателя** выберите пункт **Внешний** и нажмите кнопку **Выбрать IP-адреса** .

14. На странице **Выбор внешнего IP-адреса прослушивателя** выберите пункт **Указанный IP-адрес на компьютере Forefront TMG в выбранной сети** , выберите нужный IP-адрес и нажмите кнопку **Добавить** .

15. На странице **SSL-сертификаты прослушивателя** выберите пункт **Назначить сертификат для каждого IP-адреса** , выберите IP-адрес, связанный с полным доменным именем внешнего веб-сервера, и нажмите кнопку **Выбрать сертификат** .

16. На странице **Выбор сертификата** выберите сертификат, который соответствует внешним именам, указанным в шаге 9, и нажмите кнопку **Выбрать** .

17. На странице **Параметр проверки подлинности** выберите пункт **Без проверки подлинности** .

18. На странице **Параметр единого входа** нажмите кнопку **Далее** .

19. На странице **Завершение работы мастера определения веб-прослушивателя** проверьте, верны ли параметры **веб-прослушивателя** , и нажмите кнопку **Готово** .

20. На странице **Делегирование проверки подлинности** выберите пункт **Без делегирования, но клиент может выполнять проверку подлинности напрямую** .

21. На странице **Набор учетных записей** нажмите кнопку **Далее** .

22. На странице **Завершение работы мастера создания правила веб-публикации** проверьте, верны ли параметры правила веб-публикации, и нажмите кнопку **Готово** .

23. В области сведений нажмите кнопку **Применить** , чтобы сохранить изменения и обновить конфигурацию.

## Создание правила публикации веб-сервера на компьютере с маршрутизацией запросов приложений IIS

1.  Свяжите сертификат, который будет использоваться для обратного прокси-сервера, с протоколом HTTPS. Нажмите выберите пункт меню **Пуск**  \> **Все программы**  \> **Администрирование**  \> **Диспетчер служб IIS** .
    
    > [!NOTE]  
    > Дополнительные сведения, снимки экрана и руководство по развертыванию и настройке служб маршрутизации приложений IIS см. в статье NextHop <a href="http://go.microsoft.com/fwlink/?linkid=293391">Использование маршрутизации запросов приложений IIS в качестве обратного прокси-сервера для Lync Server 2013</a> (на английском языке).

2.  Если вы еще не сделали этого, импортируйте сертификат, который планируется использовать для обратного прокси-сервера. В программе **Диспетчер служб IIS** выберите имя обратного прокси-сервера в левой части консоли. В средней части консоли в разделе **IIS** найдите элемент **Сертификаты сервера** . Щелкните правой кнопкой мыши пункт **Сертификаты сервера** и выберите команду **Открытие функции** .

3.  В правой части консоли выберите команду **Импортировать…** . Введите путь и имя файла сертификата с расширением или нажмите кнопку **…** , чтобы найти сертификат. Выберите сертификат и нажмите кнопку **Открыть** . Введите пароль, используемый для защиты закрытого ключа (если вы назначили пароль при экспорте сертификата и закрытого ключа). Нажмите кнопку **OК** . Если импорт сертификата прошел успешно, сертификат появится в виде записи в средней части консоли в поле **Сертификаты сервера** .

4.  Назначьте сертификат для использования HTTPS. В левой части консоли выберите **Веб-сайт по умолчанию** сервера IIS. В правой части консоли щелкните пункт **Привязки…** . В диалоговом окне **Привязки сайта** нажмите кнопку **Добавить…** . В диалоговом окне **Добавление привязки сайта** в разделе **Тип:** выберите **HTTPS** . Выбор протокола HTTPS даст возможность выбрать сертификат для его использования. В разделе **Сертификат SSL:** выберите сертификат, который импортировали для обратного прокси-сервера. Нажмите кнопку **OК** , а затем – **Закрыть** . Сертификат теперь связан с обратным прокси-сервером для протоколов SSL и TLS.
    
    > [!IMPORTANT]  
    > Если при закрытии диалоговых окон привязок появится предупреждение о том, что нет промежуточных сертификатов, понадобится найти и импортировать открытый сертификат корневого центра сертификации и все промежуточные сертификаты ЦС. Прочитайте инструкции в общем ЦС, где был получен сертификат, а затем следуйте инструкциям, чтобы запросить и импортировать сертификаты. Если сертификат экспортировался из сервер, можно экспортировать сертификат корневого центра сертификации и промежуточные сертификаты ЦС, связанные с сервер. Импортируйте сертификат корневого ЦС в хранилище доверенных корневых ЦС компьютера (не путать с хранилищем пользователя), а промежуточные сертификаты – в хранилище промежуточных сертификатов ЦС компьютера.

5.  В левой части консоли под именем сервера IIS щелкните правой кнопкой мыши пункт **Фермы серверов** и выберите команду **Создать ферму сервера…** .
    
    > [!NOTE]  
    > Если узел <strong>Фермы серверов</strong> не отображается, нужно установить маршрутизацию запросов приложений. Подробнее см. в статье <a href="lync-server-2013-setting-up-reverse-proxy-servers.md">Настройка обратных прокси-серверов для Lync Server 2013</a>.    
    В диалоговом окне **Создать ферму сервера** в поле **Имя фермы сервера** введите понятное имя для первого URL-адреса. Нажмите кнопку **Далее** .

6.  В диалоговом окне **Добавить сервер** в поле **Адрес сервера** введите полное доменное имя (FQDN) внешних веб-служб на своем сервере переднего плана. Имена, которые будут использоваться здесь для примера,  те же, что используются в разделе планирования для обратного прокси-сервера, [Сводка по сертификатам — обратный прокси-сервер в Lync Server 2013](lync-server-2013-certificate-summary-reverse-proxy.md). Ссылаясь на планирование обратного прокси-сервера, мы вводим полное доменное имя `webext.contoso.com`. Убедитесь, что установлен флажок рядом с пунктом **В сети** . Нажмите кнопку **Добавить** , чтобы добавить сервер в пул веб-серверов для этой конфигурации.
    
    > [!WARNING]  
    > Lync Server использует аппаратные балансировщики нагрузки в пуле Директор и переднего плана для трафика по HTTP и HTTPS. При добавлении сервера в ферму серверов маршрутизации запросов приложений IIS нужно указать только одно полное доменное имя. Полным доменным именем будет переднего плана или Директор в конфигурациях сервера, не добавленных в пул, или полное доменное имя настроенной балансировки нагрузки для серверов пулов. Единственный метод балансировки нагрузки HTTP и HTTPS трафика – с помощью аппаратных балансировщиков нагрузки.

7.  В диалоговом окне **Добавить сервер** нажмите кнопку **Дополнительные параметры…** . Откроется диалоговое окно определения маршрутизации запроса приложения для запросов к настроенному полному доменному имени. Необходимо переопределить порт, который используется при обработке запроса с помощью маршрутизации запросов приложений IIS.
    
    По умолчанию должен быть задан порт назначения HTTP 8080. Щелкните рядом с полем **httpPort 80** и задайте значение **8080** . Щелкните рядом с полем **httpsPort 443** и задайте значение **4443** . Оставьте параметр **вес** равным 100. При необходимости можно переопределить веса для данного правила, как только будут получены базовые статистические данные. Нажмите кнопку **Готово** , чтобы завершить эту часть настройки правила.

8.  Может появиться сообщение правил переопределения о том, что диспетчер IIS может создать правило переопределения URL-адреса, чтобы автоматически направлять все входящие запросы в ферму сервера. Нажмите кнопку **Да** . Вы будете регулировать правила вручную, но выбор значения "Да" задает начальную конфигурацию.

9.  Нажмите имя фермы серверов, которую только что создали. В разделе **Ферма сервера** в просмотре возможностей диспетчера IIS дважды щелкните **Кэширование** . Снимите флажок **Включить кэширование диска** . Нажмите кнопку **Применить** в правой части окна.

10. Щелкните имя фермы серверов. В разделе **Ферма серверов** в окне просмотра возможностей диспетчера IIS дважды щелкните пункт **Прокси-сервер** . На странице настроек прокси-сервера измените значение **Время ожидания (в секундах)** на соответствующее вашему развертыванию значение. Нажмите кнопку **Применить** , чтобы сохранить изменения.
    
    > [!IMPORTANT]  
    > Значение времени ожидания прокси-сервера – это число, которое различается в разных развертываниях. Необходимо следить за работой вашего развертывания и изменять значение для получения наилучших результатов работы клиентов. Можно указать значение ниже 200. При поддержке использования в среде мобильных клиентов Lync следует установить значение равное 960, чтобы публиковать время ожидания push-уведомлений от Office 365, в котором для времени ожидания установлено значение 900. Вполне вероятно, что вам понадобится увеличить значение времени ожидания, чтобы избежать отключений клиента, когда значение слишком низкое, или уменьшить, если подключения через прокси-сервер не отключаются и очищаются еще долго после отключения клиента. Определить нужное значение можно только путем мониторинга и определение базовых показателей, которые являются нормальными для вашей среды.

11. Щелкните имя фермы серверов. В разделе **Ферма серверов** в окне просмотра возможностей диспетчера IIS дважды щелкните пункт **Правила маршрутизации** . В диалоговом окне правил маршрутизации в разделе маршрутизации снимите флажок рядом со значением "Включить разгрузку SSL". Если снять флажок нельзя, установите флажок для значения **Использовать переопределение URL-адресов для проверки входящих запросов** . Нажмите кнопку **Применить** , чтобы сохранить изменения.
    
    > [!CAUTION]  
    > Разгрузка SSL с помощью обратного прокси-сервера не поддерживается.

12. Повторите действия с 5 по 11 для каждого URL-адреса, который должен проходить через обратный прокси-сервер. Общий список будет выглядеть, как показано ниже.
    
      - переднего плана Внешние веб-службы: webext.contoso.com (заданы при первоначальной настройке)
    
      - ДиректорВнешние веб-службы для Директор: webdirext.contoso.com (необязательны при развертывании Директор)
    
      - Простой URL-адрес meet: meet.contoso.com
    
      - Простой URL-адрес dialin: dialin.contoso.com
    
      - URL-адрес автообнаружения Lync: lyncdiscover.contoso.com
    
      - URL-адрес сервера Office Web Apps Server: officewebapps01.contoso.com
        
        > [!IMPORTANT]  
        > URL-адрес Сервер Office Web Apps будет использовать другой адрес httpsPort. На шаге 7 вы задаете <strong>httpsPort</strong> равным <strong>443</strong> и <strong>httpPort</strong> равным <strong>80</strong> . Все остальные параметры конфигурации одинаковы.

13. В левой части консоли выберите имя сервера IIS. В средней части консоли в разделе **IIS** найдите пункт **Переопределение URL-адреса** . Дважды щелкните пункт "Переопределение URL-адреса", чтобы открыть конфигурацию правил переопределения URL-адреса. Должны отобразиться правила для каждой фермы серверов, созданной при выполнении предшествующих действий. Если их нет, убедитесь, что выбрали имя **Сервер IIS** непосредственно под узлом **Начальная страница** в консоли диспетчера Information Server.

14. В диалоговом окне **Переопределение URL-адреса** отобразится полное имя правила **ARR\_webext.contoso.com\_loadbalance\_SSL** (с использованием webext.contoso.com в качестве примера).
    
      - Дважды щелкните правило, чтобы открыть диалоговое окно **Редактирование входящего правила** .
    
      - Нажмите кнопку **Добавить…** в диалоговом окне **Условия** .
    
      - На вкладке **Добавить условие** в поле **Ввод условия:** введите **{HTTP\_HOST}** (по мере ввода появится диалоговое окно, в котором можно выбрать условие). В разделе **Проверка входной строки:** выберите пункт **Соответствует шаблону** . В поле **Ввод шаблона** введите **\*** . Выберите параметр **Игнорировать регистр** . Нажмите кнопку **OК** .
    
      - Прокрутите вниз диалоговое окно **Редактировать входящее правило** , чтобы найти диалоговое окно **Действие** . Для параметра **Тип действия:** нужно установить значение **Маршрут к ферме сервера** , для параметра **Схема:**  – **https://** , а для параметра **Ферма сервера:**   – URL-адрес, к которому применяется это правило. В данном примере нужно задать значение **webext.contoso.com** , а для параметра **Путь:**  – **/{R:0}**
    
      - Нажмите кнопку **Применить** ,чтобы сохранить изменения. Нажмите кнопку **Назад к правилам** , чтобы вернуться к правилам переопределения URL-адреса.

15. Повторите процедуру, определенную в действии 14, для каждого указанного правила переопределения SSL – по одному на каждый URL-адрес фермы серверов.
    
    > [!WARNING]  
    > По умолчанию правила HTTP создаются так же, как правила SSL, и обозначаются аналогичными именами. В данном примере правило HTTP будет называться <strong>ARR_webext.contoso.com_loadbalance</strong> . Не требуется вносить никаких изменений в эти правила, их можно проигнорировать. .

## Изменение свойств правила веб-публикации в TMG 2010

1.  В меню **Пуск** наведите указатель на пункт **Программы** , выберите пункт **Microsoft Forefront TMG** , а затем **Управление Forefront TMG** .

2.  В области слева разверните узел **Имя сервера** и щелкните пункт **Политика брандмауэра** .

3.  В области сведений щелкните правой кнопкой мыши созданное ранее правило публикации веб-сервера (например, LyncServerExternalRule) и выберите пункт **Свойства** .

4.  На странице **Свойства** на вкладке **Откуда** сделайте следующее.
    
      - В списке **Это правило применяется к трафику от следующих источников** выберите пункт **Везде** и нажмите кнопку **Удалить** .
    
      - Нажмите кнопку **Добавить** .
    
      - На странице **Добавление сетевых сущностей** разверните узел **Сети** , щелкните **Внешние** , нажмите кнопку **Добавить** , а затем нажмите кнопку **Закрыть** .

5.  На вкладке **Куда** убедитесь в том, что установлен флажок **Пересылать исходный заголовок узла вместо действительного** .

6.  На вкладке **Использование моста** установите флажок **Пересылать запрос на порт SSL** и укажите порт **4443** .

7.  На вкладке **Внешнее имя** добавьте простые URL-адреса (например, meet.contoso.com и dialin.contoso.com).

8.  Нажмите кнопку **Применить** , чтобы сохранить изменения, после чего нажмите кнопку **ОК** .

9.  В области сведений нажмите кнопку **Применить** , чтобы сохранить изменения и обновить конфигурацию.

## Изменение свойств правила веб-публикации в IIS ARR

1.  Выберите пункт меню **Пуск**  \> **Все программы**  \> **Администрирование**  \> **Диспетчер служб IIS** .

2.  В левой части консоли выберите имя сервера IIS.

3.  В средней части консоли в разделе **IIS** найдите **Переопределение URL-адреса** . Дважды щелкните пункт "Переопределение URL-адреса", чтобы открыть конфигурацию правил переопределения URL-адреса.

4.  Дважды щелкните правило, которое нужно изменить. При необходимости внесите изменения в поля **Соответствие URL-адресу** , **Условия** , **Переменные сервера** и **Действие** .

5.  Нажмите кнопку **Применить** , чтобы применить изменения. Нажмите кнопку **Назад к правилам** , чтобы изменить другие правила, или закройте консоль **Диспетчер IIS** , если все нужные изменения внесены.

