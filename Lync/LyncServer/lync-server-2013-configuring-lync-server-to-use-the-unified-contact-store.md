---
title: "Lync Server 2013: настройка единого хранилища контактов для Lync Server"
TOCTitle: "Lync Server 2013: настройка единого хранилища контактов для Lync Server"
ms:assetid: 6aa17ae3-764e-4986-a900-85a3cdb8c1fc
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ688083(v=OCS.15)
ms:contentKeyID: 49888031
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Настройка Microsoft Lync Server 2013 для использования единого хранилища контактов

 

_**Дата изменения раздела:** 2014-02-07_

Единое хранилище контактов позволяет пользователям хранить один список контактов, доступных в различных приложениях, в том числе в Microsoft Lync 2013, Microsoft Outlook 2013 и Microsoft Outlook Web App 2013. Если включить единое хранилище контактов для пользователя, его или ее контакты не сохраняются в Microsoft Lync Server 2013 и извлекаются с помощью протокола SIP. Эти контакты сохраняются в Microsoft Exchange Server 2013 и извлекаются с помощью веб-служб Exchange.

> [!NOTE]  
> Технически говоря, сведения о контактах хранятся в двух папках в почтовом ящике Exchange 2013 пользователя. Сами контакты хранятся в папке Lync Contacts, которая видна конечным пользователям. Метаданные контактов хранятся во вложенной папке, которая не видна конечным пользователям.

## Включение единого хранилища контактов для пользователей

Если вы уже настроили межсерверную проверку подлинности между Lync Server 2013 и Exchange 2013, вы также включили использование единого хранилища контактов. Дополнительная настройка серверов не требуется. Однако необходимо настроить учетную запись пользователя, чтобы переместить контакты пользователя в единое хранилище. По умолчанию контакты пользователя хранятся в Lync Server, а не в едином хранилище.

Доступ к единому хранилищу контактов контролируется с помощью политик служб пользователей Lync Server. У политик служб пользователей всего одно свойство (UcsAllowed), которое используется для определения расположения хранения контактов пользователя. Если пользователь управляется политикой служб пользователей, в которой для UcsAllowed задано значение True ($True), контакты пользователя будут храниться в едином хранилище контактов. Если пользователь контролируется политикой служб пользователей, в которой для UcsAllowed задано значение False ($False), его или ее контакты будут храниться в Lync Server.

При установке Lync Server 2013 также устанавливается одна политика служб пользователей (настроенная в глобальной области). Для значения UcsAllowed в этой политике задано значение True, т. е. по умолчанию контакты пользователя будут храниться в едином хранилище контактов (предполагается, что оно развернуто и настроено). Если вы хотите все контакты пользователя в единое хранилище контактов, вам не требуется выполнять никаких действий:

Если для вас предпочтительнее не переносить все ваши контакты в единое хранилище контактов, можно заблокировать единое хранилище контактов для всех пользователей, присвоив свойству UcsAllowed в глобальной политике значение False:

    Set-CsUserServicesPolicy -Identity global -UcsAllowed $False

После отключения единого хранилища контактов в глобальной политике можно создать политику на уровне пользователей, которая позволяет применять единое хранилище контактов. Это позволяет хранить контакты некоторых пользователей в едином хранилище контактов, а другие пользователи будут продолжать хранить контакты в Lync Server. Вы можете создать политику служб пользователей на уровне пользователей с помощью следующей команды:

    New-CsUserServicesPolicy -Identity "AllowUnifiedContactStore" -UcsAllowed $True

После создания политики ее необходимо назначить всем пользователям, которым требуется доступ к единому хранилищу контактов. Политики на уровне пользователей можно назначить пользователям с помощью следующей команды:

    Grant-CsUserServicesPolicy -Identity "Ken Myer" -PolicyName "AllowUnifiedContactStore"

После назначения политики Lync Server начнет переносить контакты пользователя в единое хранилище контактов. После завершения переноса контакты пользователя будут храниться в Exchange, а не в Lync Server. Если после завершения переноса пользователь находится в системе Lync 2013, появится сообщение о необходимости выхода из Lync и последующего входа в систему для завершения процесса. Контакты пользователей, которым не была назначена политика на уровне пользователей, не будут перенесены в единое хранилище контактов, т. к. такие пользователи управляются глобальной политикой. В глобальной политике отключено использование единого хранилища контактов.

Вы можете проверить, были ли контакты пользователя успешно перенесены в единое хранилище контактов, выполнив командлет [Test-CsUnifiedContactStore](https://docs.microsoft.com/en-us/powershell/module/skype/Test-CsUnifiedContactStore) в Командная консоль Lync Server:

    Test-CsUnifiedContactStore -UserSipAddress "sip:kenmyer@litwareinc.com" -TargetFqdn "atl-cs-001.litwareinc.com"

Если Test-CsUnifiedContactStore выполнен успешно, контакты для пользователя sip:kenmyer@litwareinc.com были перенесены в единое хранилище контактов.

## Откат в единое хранилище контактов

Если вам нужно удалить контакты пользователя из единого хранилища контактов (например, если пользователя нужно заново разместить в Microsoft Lync Server 2010 и единое хранилище контактов будет недоступно), выполните два действия. Во-первых, назначьте пользователю новую политику служб пользователей, которая запрещает хранение контактов в едином хранилище контактов. (Т. е. политика, в которой для свойства UcsAllowed задано значение $False.) Если такой политики нет, ее можно создать с помощью следующей команды:

    New-CsUserServicesPolicy -Identity NoUnifiedContactStore -UcsAllowed $False

Затем вы можете назначить эту политику на уровней пользователей (NoUnifiedContactStore) с помощью следующей команды:

    Grant-CsUserServicesPolicy -Identity "Ken Myer" -PolicyName NoUnifiedContactStore

Предыдущая команда назначает новую политику пользователю Ken Myer и не позволяет переносить его контакты в единое хранилище контактов.

> [!NOTE]  
> В некоторых случаях можно добиться тех же результатов, просто не назначая текущую политику служб пользователя. Например, предположим, что для Ken Myer есть политика на уровне пользователя, включающая единое хранилище контактов, но ваша глобальная политика запрещает использование хранилища. В этом случае вы можете отменить назначение политики служб пользователя Ken Myer. В этом случае этот пользователь будет контролироваться глобальной политикой и у него не будет доступа к единому хранилищу контактов.<br />Чтобы отменить назначение ранее назначенной политики на уровне пользователей, используйте ту же команду, что и ранее, но на этот раз задайте для параметра PolicyName значение NULL:<br />Grant-CsUserServicesPolicy –Identity &quot;Ken Myer&quot; –PolicyName $Null

Следует помнить о концепции "не позволяет перенести контакты пользователя Ken Myer в единое хранилище контактов" при работе с единым хранилищем контактов. Если просто назначить для Ken Myer новую политику служб пользователя, его контакты не будут перенесены из единого хранилища контактов. Когда пользователь входит в Lync Server 2013, система на основе политики служб пользователя определяет, должны ли контакты пользователя храниться в едином хранилище контактов. Если ответ — да, (т. е. для свойства UcsAllowed задано значение $True), эти контакты будут перенесены в единое хранилище контактов (если они еще не в нем). Если ответ — нет, Lync Server просто игнорирует контакты пользователя и переходит к следующей задаче. Это значит, что Lync Server не будет автоматически перемещать контакты пользователя из единого хранилища контактов независимо от значения свойства UcsAllowed.

Это также значит, что после назначения пользователю новой политики служб пользователей необходимо выполнить командлет [Invoke-CsUcsRollback](https://docs.microsoft.com/en-us/powershell/module/skype/Invoke-CsUcsRollback), чтобы переместить контакты пользователя из Exchange 2013 в Lync Server 2013. Например, после назначения Ken Myer новой политики служб пользователя можно перенести его контакты из единого хранилища контактов с помощью следующей команды:

    Invoke-CsUcsRollback -Identity "Ken Myer"

Если изменить политику служб пользователей, но не выполнять командлет Invoke-CsUcsRollback, контакты Ken Myer не будут удалены из единого хранилища контактов. Что будет, если выполнить Invoke-CsUcsRollback, но не менять политику служб пользователей Ken Myer? Тогда его контакты будут временно удалены из единого хранилища контактов. Важно помнить о том, что удаление временное. После удаления контактов из единого хранилища контактов Lync Server 2013 ждет 7 дней и проверяет, какая политика служб пользователей назначена Ken Myer. Если все еще назначена политика, позволяющая применять единое хранилище контактов, его контакты автоматически перемещаются в хранилище контактов. Чтобы удалить контакты из хранилища контактов без возможности восстановления, в дополнение к запуску командлета Invoke-CsUcsRollback следует изменить политику служб пользователя.

Из-за большого количества переменных, влияющих на перенос, трудно определить, сколько времени потребуется для полного переноса учетных записей в единое хранилище контактов. В качестве общего правила следует иметь в виду, что перенос не вступает в силу немедленно: даже при переносе небольшого числа контактов для полного завершения переноса может потребоваться около 10 минут.

