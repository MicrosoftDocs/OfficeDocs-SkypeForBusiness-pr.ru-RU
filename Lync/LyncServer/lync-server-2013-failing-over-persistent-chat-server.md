---
title: 'Lync Server 2013: отработка отказа сервером сохраняемого чата'
TOCTitle: Отработка отказа сервером сохраняемого чата
ms:assetid: 2cd79ffd-fee6-44ce-96cf-b98bf25e2690
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ204772(v=OCS.15)
ms:contentKeyID: 49309300
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Отработка отказа сервером сохраняемого чата в Lync Server 2013

 

_**Дата изменения раздела:** 2014-02-05_

Отработка отказа для сервера сохраняемого сеанса беседы ориентирована на ручное выполнение.

Предпосылка для выполнения процедуры отработки отказа основана на предположении, что дополнительный центр обработки данных запущен и функционирует, но службы сервера сохраняемого сеанса беседы с базой данных-источником сервера ( сохраняемый сеанс беседы) должны быть полностью недоступны, включая следующее:

  - Базы данных-источник сервера сохраняемого сеанса беседы и зеркала сервера сохраняемого сеанса беседы не работают.

  - Сервер переднего планаLync Server не работает.

Вся процедура состоит из двух основных этапов:

  - Восстановление базы данных-источника ( сохраняемый сеанс беседы) mgc.

  - Реализация зеркального отображения для новой базы данных-источника.

База данных соответствия, которую использует сохраняемый сеанс беседы, (mgccomp) не обеспечивает отработку отказа. Содержимое этой базы данных является временным и очищается по мере обработки данных адаптером соответствия. Администратор, контролирующий сохраняемый сеанс беседы, обязан правильно управлять выходными данными адаптера во избежание потери данных.

## Отработка отказа сервера сохраняемого сеанса беседы

1.  Удалите доставку журналов из резервной базы данных доставки журналов сервера сохраняемого сеанса беседы.
    
    1.  Используя SQL Server Management Studio, подключитесь к экземпляру базы данных, где находится резервная база данных mgc сервера сохраняемого сеанса беседы.
    
    2.  Откройте окно отправки запроса в базу данных master.
    
    3.  Используйте следующую команду для сброса доставки журналов:
        
            exec sp_delete_log_shipping_secondary_database mgc

2.  Скопируйте все нескопированные файлы резервных копий из общей папки резервных копий в конечную папку копирования на резервном сервере.

3.  По порядку примените все непримененные резервные копии журналов транзакций к базе данных-получателю. Дополнительные сведения см. в статье о применении резервной копии журнала транзакций (Transact-SQL) по адресу http://go.microsoft.com/fwlink/?linkid=247428\&clcid=0x419

4.  Подключите резервную базу данных mgc к сети. В окне запроса, которое было открыто в действии 1b, выполните следующие действия.
    
    1.  Завершите все подключения к базе данных mgc при их наличии:
        
        1.  Выполните команду **exec sp\_who2** для определения подключений к базе данных mgc.
        
        2.  **kill \<spid\>** для завершения этих подключений.
    
    2.  Подключите базу данных к сети.
        
        1.  **восстановление базы данных mgc средствами восстановления** .

5.  В командной консоли Lync Server следует выполнить команду **Set-CsPersistentChatState -Identity "service:atl-cs-001.litwareinc.com" –PoolState FailedOver** для перехода на резервную базу данных mgc. Обязательно замените полное доменное имя в пуле Persistent Chat для узла atl-cs-001.litwareinc.com.
    
    Резервная база данных mgc теперь выступает в качестве базы данных-источника.

6.  В командной консоли Lync Server запустите командлет **Install-CsMirrorDatabase**, чтобы реализовать зеркало высокой доступности для резервной базы данных, которая теперь выступает в качестве базы данных-источника. Используйте экземпляр резервной базы данных в качестве базы данных источника и экземпляр резервной зеркальной базы данных в качестве экземпляра зеркала. Это не то же самое зеркало, которое изначально было настроено для базы данных-источника в процессе установки. Дополнительные сведения см. в разделе об использовании командлетов Командная консоль Lync Server в статье [Развертывание зеркального отображения SQL Server для обеспечения высокой доступности внутреннего сервера в Lync Server 2013](lync-server-2013-deploying-sql-mirroring-for-back-end-server-high-availability.md).

7.  Задайте активные серверы сервера сохраняемого сеанса беседы. Воспользуйтесь командлетом **Set-CsPersistentChatActiveServer** в командной оболочке Lync Server, чтобы задать список активных серверов.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая основная база данных, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью.
    
    На данном этапе отработка отказа из базы данных-источника сервера сохраняемого сеанса беседы в резервную базу данных сервера сохраняемого сеанса беседы выполняется успешно.

