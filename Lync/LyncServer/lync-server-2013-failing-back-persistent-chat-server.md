---
title: 'Lync Server 2013: восстановление сервера сохраняемого чата после сбоя'
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
TOCTitle: Failing back Persistent Chat Server
ms:assetid: 67b91de4-6ddc-43e6-9812-5e1aa84a7980
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ204970(v=OCS.15)
ms:contentKeyID: 48184396
ms.date: 07/23/2014
manager: serdars
mtps_version: v=OCS.15
ms.openlocfilehash: 1d79c25d153de81906fcaf9355a543d31cb8fe0a
ms.sourcegitcommit: bb53f131fabb03a66f0d000f8ba668fbad190778
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/11/2019
ms.locfileid: "34834182"
---
<div data-xmlns="http://www.w3.org/1999/xhtml">

<div class="topic" data-xmlns="http://www.w3.org/1999/xhtml" data-msxsl="urn:schemas-microsoft-com:xslt" data-cs="http://msdn.microsoft.com/en-us/">

<div data-asp="http://msdn2.microsoft.com/asp">

# <a name="failing-back-persistent-chat-server-in-lync-server-2013"></a>Восстановление сервера сохраняемого чата после сбоя в Lync Server 2013

</div>

<div id="mainSection">

<div id="mainBody">

<span> </span>

_**Тема последнего изменения:** 2014-02-05_

В этой процедуре описаны действия, которые необходимо выполнить для восстановления после отказа сервера с постоянным чат, и для повторного выполнения операций из основного центра обработки данных.

В случае отказа сервера сохраняемого чата в основном центре обработки данных снижается полный сбой, и основная и зеркальная базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.

Ниже описывается процедура возобновления нормальной работы после восстановления базы данных-источника и подключения серверов. В этой процедуре предполагается, что основной центр обработки данных восстановлен из общего отключения и что база данных MGC и база данных мгккомп были перестроены и переустановлены с помощью построителя топологии.

Кроме того, в этой процедуре предполагается, что новые зеркальные и резервные серверы не были развернуты в течение периода перехода на другой ресурс, и что развернут только сервер резервного копирования и зеркальный сервер, который определен в [случае сбоя на постоянном сервере чата в Lync server 2013](lync-server-2013-failing-over-persistent-chat-server.md).

Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.

<div>

## <a name="to-fail-back-persistent-chat-server"></a>Чтобы вернуть сервер сохраняемого чата

1.  Удалите все серверы из списка "активный сервер чата", используя `Set-CsPersistentChatActiveServer` командлет из командной консоли Lync Server Management Shell. Это прекратит выполнение всех постоянных серверов чата при подключении к базе данных MGC и базе данных мгккомп во время восстановления после сбоя.
    
    <div>
    

    > [!IMPORTANT]  
    > Агент SQL Server на дополнительном сервере сервера сохраняемого обратного чата должен выполняться под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения: 
    > <UL>
    > <LI>
    > <P>доступ на чтение к сетевой папке, в которую помещаются резервные копии;</P>
    > <LI>
    > <P>доступ на запись к локальному каталогу, в который они копируются.</P></LI></UL>

    
    </div>

2.  Отключите зеркальное отображение для резервной базы данных mgc.
    
    1.  С помощью SQL Server Management Studio подключитесь к экземпляру резервной копии mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
    3.  Щелкните **Удалить зеркальное отображение**.
    
    4.  Нажмите **ОК**.
    
    5.  Выполните те же действия для базы данных mgccomp.

3.  Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
    1.  С помощью SQL Server Management Studio подключитесь к экземпляру резервной копии mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
    3.  В списке **Тип резервной копии** выберите пункт **Полная**.
    
    4.  В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
    5.  В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
    6.  * \<\> Необязательный* В поле **Описание**введите описание набора резервных копий.
    
    7.  Удалите расположение резервной копии по умолчанию из списка назначений.
    
    8.  Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
    9.  Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.

4.  Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
    1.  С помощью SQL Server Management Studio подключитесь к экземпляру основного mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
    3.  Выберите пункт **С устройства**.
    
    4.  Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
    5.  В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
    6.  В области **Выбор страницы** щелкните **Параметры**.
    
    7.  В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
    8.  На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
    9.  Нажмите кнопку **ОК**, чтобы начать процесс восстановления.

5.  Настройте доставку журналов SQL Server для базы данных PRIMARY. Выполните действия, описанные в разделе [Настройка сервера сохраняемого чата для обеспечения высокой доступности и аварийного восстановления в Lync Server 2013](lync-server-2013-configuring-persistent-chat-server-for-high-availability-and-disaster-recovery.md) , чтобы создать доставку журналов для первичной базы данных mgc.

6.  Установите для сервера сохраняемые активные серверы чата. В командной консоли Lync Server используйте командлет **Set-ксперсистентчатактивесервер** , чтобы настроить список активных серверов.
    
    <div>
    

    > [!IMPORTANT]  
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая база данных-источник, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью.

    
    </div>

Восстановите состояние пула в обычном режиме, выполнив следующую команду Windows PowerShell:

    Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal

Для получения дополнительных сведений ознакомьтесь с разделом справки для командлета [Set-ксперсистентчатстате](https://docs.microsoft.com/powershell/module/skype/Set-CsPersistentChatState) .

</div>

</div>

<span> </span>

</div>

</div>

</div>

