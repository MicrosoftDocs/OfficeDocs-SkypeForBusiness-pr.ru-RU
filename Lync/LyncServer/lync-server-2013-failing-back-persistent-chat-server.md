---
title: 'Lync Server 2013: аварийное восстановление сервера сохраняемого чата'
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
f1.keywords:
- NOCSH
TOCTitle: Failing back Persistent Chat Server
ms:assetid: 67b91de4-6ddc-43e6-9812-5e1aa84a7980
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ204970(v=OCS.15)
ms:contentKeyID: 48184396
ms.date: 07/23/2014
manager: serdars
mtps_version: v=OCS.15
ms.openlocfilehash: 1da806e476635543e0afeafee8b7c195cf21cfc4
ms.sourcegitcommit: 831d141dfc5a49dd764cb296b73b63e5a9f8e599
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/21/2020
ms.locfileid: "42202295"
---
<div data-xmlns="http://www.w3.org/1999/xhtml">

<div class="topic" data-xmlns="http://www.w3.org/1999/xhtml" data-msxsl="urn:schemas-microsoft-com:xslt" data-cs="https://msdn.microsoft.com/">

<div data-asp="https://msdn2.microsoft.com/asp">

# <a name="failing-back-persistent-chat-server-in-lync-server-2013"></a>Восстановление сервера сохраняемого чата в Lync Server 2013

</div>

<div id="mainSection">

<div id="mainBody">

<span> </span>

_**Последнее изменение темы:** 2014-02-05_

В этой процедуре описаны действия, необходимые для восстановления после сбоя сервера сохраняемого чата, а также переопределение операций из основного центра обработки данных.

Во время сбоя сервера сохраняемого чата в основном центре обработки данных остается полный сбой, а основная и зеркальная базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.

Ниже описывается процедура возобновления нормальной работы после восстановления основной базы данных и подключения серверов. В процедуре предполагается, что основной центр обработки данных восстановлен из общего отключения, а база данных MGC и база данных mgccomp были перестроены и переустановлены с помощью построителя топологий.

В процедуре также предполагается, что новые зеркальные и резервные серверы не были развернуты в течение периода отработки отказа, а также что развернут единственный сервер резервного копирования и его зеркальный сервер, как определено при [отработке отказа сервера сохраняемого чата в Lync server 2013](lync-server-2013-failing-over-persistent-chat-server.md).

Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.

<div>

## <a name="to-fail-back-persistent-chat-server"></a>Отказ от возврата сервера сохраняемого чата

1.  Очистите все серверы из списка активный сервер сохраняемого чата с помощью `Set-CsPersistentChatActiveServer` командлета из командной консоли Lync Server. При этом все серверы сохраняемого чата не подключаются к базе данных MGC и базе данных mgccomp во время восстановления размещения.
    
    <div>
    

    > [!IMPORTANT]  
    > Агент SQL Server на сервере вторичного сервера сохраняемого чата должен работать под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения: 
    > <UL>
    > <LI>
    > <P>доступ на чтение к сетевой папке, в которую помещаются резервные копии;</P>
    > <LI>
    > <P>доступ на запись к локальному каталогу, в который они копируются.</P></LI></UL>

    
    </div>

2.  Отключите зеркальное отображение для резервной базы данных mgc.
    
    1.  С помощью SQL Server Management Studio подключитесь к резервному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
    3.  Щелкните **Удалить зеркальное отображение**.
    
    4.  При появлении запроса на подтверждение нажмите кнопку **ОК**.
    
    5.  Выполните те же действия для базы данных mgccomp.

3.  Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
    1.  С помощью SQL Server Management Studio подключитесь к резервному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
    3.  В списке **Тип резервной копии** выберите пункт **Полная**.
    
    4.  В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
    5.  В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
    6.  *Необязательное требование\> \<* В поле **Description (описание**) введите описание резервного набора данных.
    
    7.  Удалите расположение резервной копии по умолчанию из списка назначений.
    
    8.  Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
    9.  Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.

4.  Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
    1.  С помощью SQL Server Management Studio подключитесь к основному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
    3.  Выберите пункт **С устройства**.
    
    4.  Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
    5.  В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
    6.  В области **Выбор страницы** щелкните **Параметры**.
    
    7.  В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
    8.  На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
    9.  Нажмите кнопку **ОК**, чтобы начать процесс восстановления.

5.  Настройка доставки журналов SQL Server для основной базы данных. Выполните процедуры, описанные в разделе [Настройка сервера сохраняемого чата для обеспечения высокой доступности и аварийного восстановления в Lync Server 2013](lync-server-2013-configuring-persistent-chat-server-for-high-availability-and-disaster-recovery.md) , чтобы создать доставку журналов для основной базы данных mgc.

6.  Задайте для сервера сохраняемого чата активные серверы. В командной консоли Lync Server используйте командлет **Set – CsPersistentChatActiveServer** , чтобы задать список активных серверов.
    
    <div>
    

    > [!IMPORTANT]  
    > Все активные серверы должны располагаться в одном центре обработки данных с новой базой данных-источником или в центре обработки данных, имеющем подключение к базе данных с низкой задержкой и высокой пропускной способностью.

    
    </div>

Чтобы восстановить нормальное состояние пула, выполните следующую команду Windows PowerShell:

    Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal

Для получения дополнительных сведений обратитесь к разделу справки по командлету [Set – CsPersistentChatState](https://docs.microsoft.com/powershell/module/skype/Set-CsPersistentChatState) .

</div>

</div>

<span> </span>

</div>

</div>

</div>

