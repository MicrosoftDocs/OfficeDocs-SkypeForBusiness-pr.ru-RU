---
title: 'Lync Server 2013: восстановление сервера сохраняемого чата после сбоя'
TOCTitle: Восстановление сервера сохраняемого чата после сбоя
ms:assetid: 67b91de4-6ddc-43e6-9812-5e1aa84a7980
ms:mtpsurl: https://technet.microsoft.com/ru-ru/library/JJ204970(v=OCS.15)
ms:contentKeyID: 49310022
ms.date: 05/19/2016
mtps_version: v=OCS.15
ms.translationtype: HT
---

# Восстановление сервера сохраняемого чата после сбоя в Lync Server 2013

 

_**Дата изменения раздела:** 2014-02-05_

В этом разделе описываются действия, необходимые для восстановления сохраняемого сеанса беседы после сбоя и возобновления взаимодействия с основным центром обработки данных.

В случае сбоя сохраняемого сеанса беседы основной центр обработки данных полностью отключается, в результате чего основная и зеркальная базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.

Ниже описывается процедура возобновления нормальной работы после восстановления основной базы данных и подключения серверов. Предполагается, что нормальная работа основного центра обработки данных была восстановлена и что базы данных mgc и mgccomp были созданы повторно и установлены с помощью построителя топологий.

Также предполагается, что в процессе отработки отказа не были развернуты новые зеркальные и резервные серверы и что единственный сервер, который был развернут, – это резервный и соответствующий зеркальный серверы, определенные в разделе [Отработка отказа сервером сохраняемого чата в Lync Server 2013](lync-server-2013-failing-over-persistent-chat-server.md).

Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.

## Восстановление размещения сохраняемого сеанса беседы

1.  Удалите все серверы из списка активных серверов сохраняемого сеанса беседы с помощью командлета `Set-CsPersistentChatActiveServer` из Командная консоль Lync Server. Таким образом вы запретите всем сохраняемого чата подключаться к базам данных mgc и mgccomp в процессе восстановления размещения.
    
    > [!IMPORTANT]  
    > Агент SQL Server на дополнительном тыловом сервере сохраняемого сеанса беседы должен работать под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения:
    > <ul><li><p>доступ на чтение к сетевой папке, в которую помещаются резервные копии;</p></li>
    > <li><p>доступ на запись к локальному каталогу, в который они копируются.</p></li></ul>


2.  Отключите зеркальное отображение для резервной базы данных mgc.
    
    1.  С помощью SQL Server Management Studio подключитесь к резервному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение** .
    
    3.  Щелкните **Удалить зеркальное отображение** .
    
    4.  Нажмите кнопку **ОК** .
    
    5.  Выполните те же действия для базы данных mgccomp.

3.  Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
    1.  С помощью SQL Server Management Studio подключитесь к резервному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию** . Появится диалоговое окно **Резервное копирование базы данных** .
    
    3.  В списке **Тип резервной копии** выберите пункт **Полная** .
    
    4.  В списке **Компонент резервного копирования** выберите пункт **База данных** .
    
    5.  В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
    6.  *\<Дополнительно\>* В поле **Описание** введите описание резервного набора данных.
    
    7.  Удалите расположение резервной копии по умолчанию из списка назначений.
    
    8.  Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
    9.  Нажмите кнопку **ОК** , чтобы закрыть диалоговое окно и начать процесс резервного копирования.

4.  Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
    1.  С помощью SQL Server Management Studio подключитесь к основному экземпляру mgc.
    
    2.  Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** , выберите пункт **Восстановить** , а затем **База данных** . Появится диалоговое окно **Восстановление базы данных** .
    
    3.  Выберите пункт **С устройства** .
    
    4.  Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии** . В списке **Резервные носители** выберите пункт **Файл** . Нажмите кнопку **Добавить** , выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК** .
    
    5.  В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
    6.  В области **Выбор страницы** щелкните **Параметры** .
    
    7.  В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных** .
    
    8.  На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию** .
    
    9.  Нажмите кнопку **ОК** , чтобы начать процесс восстановления.

5.  Настройте доставку журналов SQL Server для основной базы данных. Выполните инструкции, приведенные в разделе [Настройка сервера сохраняемого чата для обеспечения высокой доступности и аварийного восстановления в Lync Server 2013](lync-server-2013-configuring-persistent-chat-server-for-high-availability-and-disaster-recovery.md), чтобы настроить доставку журналов для основной базы данных mgc.

6.  Задайте активные серверы сохраняемого сеанса беседы. В Командная консоль Lync Server выполните командлет **Set-CsPersistentChatActiveServer**, чтобы настроить список активных серверов.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая основная база данных, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью.


Чтобы восстановить обычное состояние пула, выполните следующую команду Windows PowerShell:

    Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal

Дополнительные сведения о командлете [Set-CsPersistentChatState](https://docs.microsoft.com/en-us/powershell/module/skype/Set-CsPersistentChatState) см. в разделе справки.

