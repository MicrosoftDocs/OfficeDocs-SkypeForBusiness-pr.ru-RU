---
title: Служба централизованного ведения журналов в Skype для бизнеса 2015
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: Сводка. Сведения о компонентах службы и параметрах конфигурации для службы централизованного ведения журналов в Skype для бизнеса Server 2015.
ms.openlocfilehash: f4cb47204aa4970e0a86d5f1d556099b52afd07c
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49835269"
---
# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Служба централизованного ведения журналов в Skype для бизнеса 2015
 
**Сводка:** Learn about the service components and configuration settings for the Centralized Logging Service in Skype for Business Server 2015.
  
Централизованная служба ведения журналов может: 
  
- Запустите или остановите ведение журнала на одном или более компьютерах и пулах с помощью одной команды из центрального расположения.
    
- Журналы поиска на одном или более компьютерах и в пулах. Вы можете адаптировать поиск, чтобы вернуть все журналы на всех компьютерах, или получить более краткие результаты.
    
- Настройте сеансы ведения журналов следующим образом:
    
  - Определите **сценарий** или используйте сценарий по умолчанию. Сценарий в службе централизованного ведения журналов состоит из области действия (глобального или сайта), имени сценария для определения цели сценария и одного или более поставщиков. Можно запустить сценарий по умолчанию и один определенный сценарий в любой момент времени на компьютере.
    
  - Используйте существующий поставщик или создайте новый. Aprovider определяет, что собирает сеанс ведения журнала, какой уровень детализации, какие компоненты необходимо отслеживать и какие флаги применяются.
    
    > [!TIP]
    >  Если вы знакомы с OCSLogger, терминпровизеры ссылаются  на коллекцию компонентов (например, S4, SIPStack), тип ведения журнала **(например,** WPP, EventLog или журнал IIS), уровень трассиации **(например,** All, verbose, debug) и флаги **(например,** TF_COMPONENT, TF_DIAG). Эти элементы определяются в поставщике (переменная Windows PowerShell) и передаются в команду службы централизованного ведения журналов.
  
  - Настройте журналы для определенных компьютеров и пулов.
    
  - Определите область для сеанса ведения журнала из параметров **"Сайт"** (для ведения журналов только на компьютерах на этом сайте) или "Глобальная" **(для** запуска захвата журналов на всех компьютерах в развертывании).
    
Централизованная служба ведения журналов — это мощное средство устранения неполадок, связанных с большими или небольшими проблемами, от анализа первопричин до проблем с производительностью. Все примеры показаны с помощью оболочки управления Skype для бизнеса Server. Справка предоставляется средству командной строки через само средство, но существует ограниченный набор функций, которые можно выполнять из командной строки. С помощью Skype для бизнеса Server Management Shell вы можете получить доступ к гораздо большему и настраиваемому набору функций, поэтому это всегда должно быть вашим первым выбором. 
  
## <a name="logging-service-components"></a>Компоненты службы ведения журнала

 Служба централизованного ведения журналов работает на всех серверах в развертывании и состоит из следующих агентов и служб:
  
- Агент централизованной службы ведения журналов ClsAgent выполняется на каждом компьютере с развернутой skype для бизнеса Server. Он прослушивает (на портах **TCP 50001-50003)** команды от ClsController через WCF и отправляет ответы обратно контроллеру. Он управляет сеансами журнала (запуском, остановкой и обновлением) и выполняет поиск в журналах. Кроме того, он выполняет такие операции, как архивация и очистка журналов. 
    
- Командлеты контроллера службы централизованного ведения журналов командная оболочка Skype для бизнеса Server отправляет команды "Начните", "Остановить", "Очистить" и "Поиск" в ClsAgent. При отправлении команд поиска итоговые журналы возвращаются в ClsControllerLib.dll и объединяются. Контроллер отправляет команды агенту, получает состояние этих команд и управляет данными файла журнала поиска по мере их возврата от всех агентов на любом компьютере в области поиска и собирает данные журнала в осмысленный и упорядоченный набор выходных данных. В следующих темах основное внимание уделяется использованию оболочки управления Skype для бизнеса Server.
    
**Взаимодействие ClsController и ClsAgent**

![Связь между CLSController и CLSAgent.](../../media/Ops_CLS_Architecture.jpg)
  
Команды выдают с помощью интерфейса командной строки Windows Server или командной оболочки Skype для бизнеса Server. Команды выполняются на компьютере, на котором выполнен вход в систему, и отправляются локальному агенту ClsAgent или на другие компьютеры и пулы в развертывании.
  
ClsAgent поддерживает файл индекса всех файлов .CACHE, которые имеются на локальном компьютере. ClsAgent размещает их так, чтобы они равномерно распределялись по томам, определенным параметром CacheFileLocalFolders, и не занимали более 80% места на каждом томе (расположение и процент локального кэша можно настроить с помощью командлета **Set-CsClsConfiguration**). ClsAgent также отвечает за удаление с локального компьютера устаревших кэшированных файлов журнала трассировки событий (файлов ETL). По истечении двухнедельного срока (этот временной интервал настраивается с помощью командлета **Set-CsClsConfiguration**) эти файлы копируются в общую папку и удаляются с локального компьютера. Дополнительные сведения см. в описании командлета [Set-CsClsConfiguration](https://docs.microsoft.com/powershell/module/skype/set-csclsconfiguration?view=skype-ps). При получении запроса поиска условия поиска используются для выбора набора кэшированных ETL-файлов для выполнения поиска на основании значений из индекса, поддерживаемого агентом.
  
> [!NOTE]
> ClsAgent может выполнять поиск файлов, перемещенных в общую папку с локального компьютера. После перемещения файлов в общую папку ClsAgent не контролирует их устаревание и удаление. Необходимо определить административную задачу для отслеживания размера файлов в общей папке и их удаления или архивации. 
  
Результирующие файлы журналов можно считывать и анализировать с помощью различных средств, в том числе с помощью **Snooper.exe** и других средств, способных считывать текстовые файлы, таких как **Notepad.exe**. Snooper.exe входит в состав средств отлаки Skype для бизнеса Server 2015 и доступна в качестве [веб-загрузки.](https://go.microsoft.com/fwlink/p/?LinkId=285257)
  
Как и OCSLogger, централизованная служба ведения журналов имеет несколько компонентов для трассировки и предоставляет параметры для выбора флагов, таких как TF_COMPONENT и TF_DIAG. Централизованная служба ведения журналов также сохраняет параметры уровня ведения журнала OCSLogger.
  
Наиболее важным преимуществом использования командной оболочки Skype для бизнеса Server по сравнению с командной строкой ClsController является возможность настройки и определения новых сценариев с помощью выбранных поставщиков, которые нацелены на проблемное пространство, настраиваемые флаги и уровни ведения журнала. Средство ClsController ограничено сценариями, определенными для исполняемого процесса.
  
В предыдущих версиях средство OCSLogger.exe позволяло администраторам и сотрудникам технической поддержки собирать файлы трассировки с компьютеров в развертывании. Наряду с преимуществами, средство OCSLogger обладало одним существенным недостатком. В заданный момент времени журналы можно было собирать только на одном компьютере. Можно было вести журналы на нескольких компьютерах с помощью отдельных копий OCSLogger, но при этом создавалось несколько журналов, а простого способа объединения результатов не существовало.
  
Когда пользователь запрашивает поиск журналов, ClsController определяет, на какие компьютеры отправить этот запрос (на основании выбранных сценариев). Контроллер также определяет, нужно ли выполнять поиск в общей папке, в которой находятся сохраненные ETL-файлы. При получении результатов поиска ClsController объединяет их в один упорядоченный по времени набор, который предоставляется пользователю. Пользователи могут сохранять результаты поиска на локальном компьютере для дальнейшего анализа.
  
При запуске сеанса ведения журнала пользователь указывает сценарии, имеющие отношение к решаемой задаче. В любой момент времени могут выполняться два сценария. Одним из этих сценариев должен быть сценарий AlwaysOn. Как можно понять из названия, этот сценарий должен всегда выполняться в развертывании, собирая сведения о всех компьютерах, пулах и компонентах.
  
> [!IMPORTANT]
> Сценарий AlwaysOn не выполняется в развертывании по умолчанию. Этот сценарий необходимо явно запустить. После запуска он будет выполняться, пока не будет явно остановлен, а состояние выполнения будет сохраняться между перезагрузками компьютеров. For details on starting and stopping scenarios, see [Start or stop CLS log capture in Skype for Business Server 2015.](start-or-stop-log-capture.md) 
  
При возникновении неполадок запустите второй сценарий, связанный с обнаруженной проблемой. Воспроизведите условия возникновения проблемы и остановите ведение журнала для второго сценария. Выполните в журнале поиск данных, связанных с обнаруженной проблемой. При объединении журналов создается файл, содержащий сообщения трассировки со всех компьютеров в области сайта или в глобальной области развертывания. Если поиск возвращает слишком много данных, которые физически невозможно проанализировать (такую ситуацию часто называют отношением "сигнал-шум", в котором значение "шума" слишком велико), выполните другой поиск с более точными параметрами. На этом этапе можно заметить наборы данных, которые позволяют выявить признаки проблемы и сузить круг поиска. В конечном счете, после выполнения нескольких уточненных поисков можно обнаружить данные, имеющие отношение к проблеме, и определить ее причину.
  
> [!TIP]
> When presented with a problem scenario in Skype for Business Server, start by asking yourself "What do I already know about the problem?" Если определить границы проблемы, можно исключить большую часть операционных сущностями в Skype для бизнеса Server. 
  
Рассмотрим пример сценария, в котором пользователи не получают актуальные результаты при поиске контактов. Нет смысла искать проблемы в компонентах мультимедиа, Корпоративная голосовая связь, вконференцию и ряде других компонентов. Неизвестно только то, где фактически возникла проблема: в клиенте или на стороне сервера? Контакты собираются из Active Directory репликатором пользователей и доставляются клиенту с помощью сервера адресной книги (ABServer). AbServer получает обновления из базы данных RTC (где их написал репликатор пользователей) и собирает их в файлы адресной книги по умолчанию — 01:30. Клиенты Skype для бизнеса Server извлекает новую адресную книгу по случайному расписанию. Так как вы знаете, как работает этот процесс, вы можете уменьшить количество потенциальных причин, связанных с проблемой, связанной с данными, которые репликатор пользователей собирает из Active Directory, abServer не получает и не создает файлы адресной книги, или клиенты не загружают файл адресной книги.
  
## <a name="current-configuration"></a>Текущая конфигурация

Служба централизованного ведения журналов настраивается для определения того, что служба ведения журналов предназначена для сбора, как она собирает, откуда она будет собираться и какие параметры журнала. Эти параметры определяются глобально (то есть для всего развертывания) или для сайта (то есть именоваемого сайта в развертывании). Любое определенное ведение журнала приведет к использованию параметров, подходящих для удостоверения, используемого для команд запуска, остановки, очистки журналов и выполнения поиска.
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>Отображение текущей конфигурации службы централизованного ведения журналов

1. Запустите оболочку управления Skype для бизнеса Server: нажмите кнопку "Начните", выберите "Все программы", "Skype для бизнеса **2015",** а затем щелкните "Skype для бизнеса Server Management **Shell".**
    
2. Введите следующую команду в командной строке:
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > Можно сузить или расширить область возвращаемой параметров конфигурации, определив область, например  `-Identity` "Site:Redmond", чтобы вернуть только CsClsConfiguration для сайта Redmond. Если требуется получить подробные сведения о заданной части конфигурации, вы можете перенакладыть выходные данные в другой Windows PowerShell. Например, чтобы получить сведения о сценариях, определенных в конфигурации сайта Redmond, введите: `Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Пример выходных данных get-CsClsConfiguration.](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    В результате работы этого cmdlet отображается текущая конфигурация службы централизованного ведения журналов.
    
|**Параметр конфигурации**|**Описание**|
|:-----|:-----|
|**Identity** <br/> |Определяет область действия и имя данной конфигурации.  Существует одна глобальная конфигурация и по одной конфигурации для каждого сайта.  <br/> |
|**Scenarios** <br/> |Список всех сценариев, определенных для данной конфигурации.  <br/> |
|**SearchTerms** <br/> |Определенные поисковые запросы для этой конфигурации. Microsoft 365 или Office 365, а не локальное развертывание.  <br/> |
|**SecurityGroups** <br/> |Определенные группы безопасности, которые управляют кто (т. е. участники групп безопасности) могут просматривать компьютеры на основе сайта их размещения. В этом контексте сайт — это сайт, определенный в построителье топологий.  <br/> |
|**Регионы** <br/> |Определенные регионы используются для сбора групп безопасности по регионам, например EMEA (страны Европы, Ближнего Востока и Африки).  <br/> |
|**EtlFileRolloverSizeMB** <br/> |Данный параметры указывает максимальный размер файла журнала до создания нового файла трассировки журнала (.etl). Новый файл журнала создается при достижении определенного размера, даже если не было достигнуто значение, заданное в параметре EtlFileRolloverMinutes.  <br/> |
|**EtlFileRolloverMinutes** <br/> |Определенное максимальное время существования журнала (в минутах) до создания нового ETL-файла. Новый файл журнала создается по завершении таймера, даже если еще не было достигнуто значение максимального размера, заданное в параметре EtlFileRolloverSizeMB.  <br/> |
|**TmfFileSearchPath** <br/> |Местоположение для поиска файлов формата трассировки сообщений.  <br/> |
|**CacheFileLocalFolders** <br/> |Определенный путь к месту сохранения файлов кэша на компьютерах. CLSAgent записывает файлы кэша и работает в контексте сетевой службы. В этом случае значением переменной %TEMP% является %WINDIR%\ServiceProfiles\NetworkService\AppData\Local. По умолчанию файлы кэша и файлы журнала записываются в один каталог.  <br/> |
|**CacheFileNetworkFolder** <br/> |Можно определить UNC-путь для получения файлов кэша во время операций ведения журналов.  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |Определяется как максимальное время в днях для сохранения файлов кэша.  <br/> |
|**CacheFileMaxDiskUsage** <br/> |Определяется как часть дискового пространства (выраженное в процентах), которое может использоваться под файлы кэша.  <br/> |
|**ComponentThrottleLimit** <br/> |Определяется как максимальное количество трассировок в секунду, которое может создавать компонент до активации автоматического ограничителя.  <br/> |
|**ComponentThrottleSample** <br/> |Количество превышений значения ComponentThrottleLimit в течение 60 секунд.  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |Минимальная версия CLSAgent, допустимая для запуска. Этот элемент предназначен для Microsoft 365 или Office 365.  <br/> |
   

