---
title: Централизованная служба ведения журнала в Skype для бизнеса 2015 г.
ms.reviewer: null
ms.author: serdars
author: SerdarSoysal
manager: serdars
ms.date: 2/1/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
  - NOCSH
ms.localizationpriority: medium
ms.collection: IT_Skype16
ms.assetid: 975718a0-f3e3-404d-9453-6224e73bfdd0
description: Сводка. Сведения о компонентах службы и настройках конфигурации для централизированной службы ведения журнала в Skype для бизнеса Server 2015 г.
---

# <a name="centralized-logging-service-in-skype-for-business-2015"></a>Централизованная служба ведения журнала в Skype для бизнеса 2015 г.
 
**Сводка:** Узнайте о компонентах службы и параметрах конфигурации для централизированной службы ведения журнала в Skype для бизнеса Server 2015 г.
  
Централизованная служба ведения журнала может: 
  
- Запустите или прекратите ведение журнала на одном или более компьютерах и пулах с одной командой из центрального расположения.
    
- Журналы поиска на одном или более компьютерах и пулах. Вы можете адаптировать поиск, чтобы вернуть все журналы на всех компьютерах или получить более краткие результаты.
    
- Настройте сеансы ведения журналов следующим образом:
    
  - Определите **сценарий** или используйте сценарий по умолчанию. Сценарий в службе централизованного ведения журнала состоит из области (глобальной или веб-сайта), имени сценария для определения цели сценария и одного или более поставщиков. Вы можете запустить сценарий по умолчанию и один определенный сценарий в любой момент времени на компьютере.
    
  - Используйте существующий поставщик или создайте новый. Aprovider определяет, что собирает сеанс ведения журнала, какой уровень детализации, какие компоненты отслеживать и какие флаги применяются.
    
    > [!TIP]
    >  Если вы знакомы с OCSLogger, термины относятся к набору **компонентов (например** , S4, SIPStack), типу ведения **журнала (например** , журналу WPP, EventLog или IIS logfile), уровню трассировочная трассировка **(например** , all, verbose, debug) и флагам **(например** , TF_COMPONENT, TF_DIAG). Эти элементы определяются в поставщике (переменная Windows PowerShell) и передаются в команду централизованной службы ведения журнала.
  
  - Настройка журналов для определенных компьютеров и пулов.
    
  - Определите область для сеанса ведения журнала из параметров **Site** (для запуска захватов журналов только на компьютерах на этом сайте) или **Global** (для запуска захватов журналов на всех компьютерах в развертывании).
    
Централизованная служба ведения журнала является мощным средством устранения неполадок для больших или малых проблем, от анализа корневых причин до проблем производительности. Все примеры показаны с помощью Skype для бизнеса Server management Shell. Помощь предоставляется для средства командной строки через сам инструмент, но существует ограниченный набор функций, которые можно выполнить из командной строки. С помощью Skype для бизнеса Server управленческой оболочки у вас есть доступ к гораздо большему и гораздо более настраиваемому набору функций, поэтому всегда должен быть вашим первым выбором. 
  
## <a name="logging-service-components"></a>Компоненты службы ведения журнала

 Централизованная служба ведения журнала работает на всех серверах развертывания и состоит из следующих агентов и служб:
  
- Централизованный агент службы ведения журнала ClsAgent выполняется на каждой машине с Skype для бизнеса Server развернутой. Он прослушивает (в портах **TCP 50001-50003**) команды clsController над WCF и отправляет ответы на контроллер. Он управляет сеансами журналов (start/stop/update) и поиском журналов. Он также выполняет операции по домашнему хозяйству, такие как архивация журналов и очистка. 
    
- Командлеты диспетчера службы централизованного ведения журнала Командлеты командлетов Skype для бизнеса Server команд управления отправляют команды Start, Stop, Flush и Search в ClsAgent. При отправлении команд поиска в результате журналы возвращаются в ClsControllerLib.dll и агрегируются. Контроллер отправляет команды агенту, получает состояние этих команд и управляет данными файлов журнала поиска по мере их возврата со всех агентов на любом компьютере в области поиска и агрегируется данные журнала в значимый и упорядоченный набор выходных данных. Сведения в следующих темах посвящены использованию Skype для бизнеса Server Management Shell.
    
**Взаимодействие ClsController и ClsAgent**

![Связь между CLSController и CLSAgent.](../../media/Ops_CLS_Architecture.jpg)
  
Команды выдают с помощью интерфейса командной строки Windows Server или с помощью Skype для бизнеса Server командной оболочки. Команды выполняются на компьютере, на котором выполнен вход в систему, и отправляются локальному агенту ClsAgent или на другие компьютеры и пулы в развертывании.
  
ClsAgent поддерживает файл индекса всех файлов .CACHE, которые имеются на локальном компьютере. ClsAgent размещает их так, чтобы они равномерно распределялись по томам, определенным параметром CacheFileLocalFolders, и не занимали более 80% места на каждом томе (расположение и процент локального кэша можно настроить с помощью командлета **Set-CsClsConfiguration**). ClsAgent также отвечает за удаление с локального компьютера устаревших кэшированных файлов журнала трассировки событий (файлов ETL). По истечении двухнедельного срока (этот временной интервал настраивается с помощью командлета **Set-CsClsConfiguration**) эти файлы копируются в общую папку и удаляются с локального компьютера. Дополнительные сведения см. в описании командлета [Set-CsClsConfiguration](/powershell/module/skype/set-csclsconfiguration?view=skype-ps). При получении запроса поиска условия поиска используются для выбора набора кэшированных ETL-файлов для выполнения поиска на основании значений из индекса, поддерживаемого агентом.
  
> [!NOTE]
> ClsAgent может выполнять поиск файлов, перемещенных в общую папку с локального компьютера. После перемещения файлов в общую папку ClsAgent не контролирует их устаревание и удаление. Необходимо определить административную задачу для отслеживания размера файлов в общей папке и их удаления или архивации. 
  
Результирующие файлы журналов можно считывать и анализировать с помощью различных средств, в том числе с помощью **Snooper.exe** и других средств, способных считывать текстовые файлы, таких как **Notepad.exe**. Snooper.exe является частью Skype для бизнеса Server 2015 отлаготки и доступна в качестве [веб-загрузки](https://go.microsoft.com/fwlink/p/?LinkId=285257).
  
Как и OCSLogger, централизованная служба ведения журнала имеет несколько компонентов для отслеживания и предоставляет варианты выбора флагов, таких как TF_COMPONENT и TF_DIAG. Централизованная служба ведения журнала также сохраняет параметры уровня ведения журнала OCSLogger.
  
Самое важное преимущество использования командной Skype для бизнеса Server командной строки ClsController заключается в том, что вы можете настроить и определить новые сценарии с помощью выбранных поставщиков, которые ориентированы на проблемное пространство, настраиваемые флаги и уровни ведения журналов. Средство ClsController ограничено сценариями, определенными для исполняемого процесса.
  
В предыдущих версиях средство OCSLogger.exe позволяло администраторам и сотрудникам технической поддержки собирать файлы трассировки с компьютеров в развертывании. Наряду с преимуществами, средство OCSLogger обладало одним существенным недостатком. В заданный момент времени журналы можно было собирать только на одном компьютере. Можно было вести журналы на нескольких компьютерах с помощью отдельных копий OCSLogger, но при этом создавалось несколько журналов, а простого способа объединения результатов не существовало.
  
Когда пользователь запрашивает поиск журналов, ClsController определяет, на какие компьютеры отправить этот запрос (на основании выбранных сценариев). Контроллер также определяет, нужно ли выполнять поиск в общей папке, в которой находятся сохраненные ETL-файлы. При получении результатов поиска ClsController объединяет их в один упорядоченный по времени набор, который предоставляется пользователю. Пользователи могут сохранять результаты поиска на локальном компьютере для дальнейшего анализа.
  
При запуске сеанса ведения журнала пользователь указывает сценарии, имеющие отношение к решаемой задаче. В любой момент времени могут выполняться два сценария. Одним из этих сценариев должен быть сценарий AlwaysOn. Как можно понять из названия, этот сценарий должен всегда выполняться в развертывании, собирая сведения о всех компьютерах, пулах и компонентах.
  
> [!IMPORTANT]
> Сценарий AlwaysOn не выполняется в развертывании по умолчанию. Этот сценарий необходимо явно запустить. После запуска он будет выполняться, пока не будет явно остановлен, а состояние выполнения будет сохраняться между перезагрузками компьютеров. Подробные сведения о сценариях запуска и остановки см. в материале [Start or stop CLS log capture in Skype для бизнеса Server 2015 г](start-or-stop-log-capture.md). 
  
При возникновении неполадок запустите второй сценарий, связанный с обнаруженной проблемой. Воспроизведите условия возникновения проблемы и остановите ведение журнала для второго сценария. Выполните в журнале поиск данных, связанных с обнаруженной проблемой. При объединении журналов создается файл, содержащий сообщения трассировки со всех компьютеров в области сайта или в глобальной области развертывания. Если поиск возвращает слишком много данных, которые физически невозможно проанализировать (такую ситуацию часто называют отношением "сигнал-шум", в котором значение "шума" слишком велико), выполните другой поиск с более точными параметрами. На этом этапе можно заметить наборы данных, которые позволяют выявить признаки проблемы и сузить круг поиска. В конечном счете, после выполнения нескольких уточненных поисков можно обнаружить данные, имеющие отношение к проблеме, и определить ее причину.
  
> [!TIP]
> Если вам будет представлена проблема в Skype для бизнеса Server, сначала задайте себе вопрос: "Что я уже знаю об этой проблеме?" Если количественно определить границы проблем, можно устранить большую часть операционных сущностями в Skype для бизнеса Server. 
  
Рассмотрим пример сценария, в котором пользователи не получают актуальные результаты при поиске контактов. Нет смысла искать проблемы в компонентах мультимедиа, Корпоративная голосовая связь, конференциях и ряде других компонентов. Неизвестно только то, где фактически возникла проблема: в клиенте или на стороне сервера? Контакты собираются из Active Directory репликатором пользователей и доставляются клиенту с помощью сервера адресной книги (ABServer). AbServer получает свои обновления из базы данных RTC (где их писал репликатор пользователей) и собирает их в файлы адресной книги, по умолчанию - 1:30 утра. Клиенты Skype для бизнеса Server получить новую адресную книгу по рандомизированному расписанию. Так как вы знаете, как работает этот процесс, вы можете уменьшить поиск потенциальной причины до проблемы, связанной с данными, собираемые из Active Directory репликатором пользователей, abServer, не собирающих и не создающих файлы адресной книги, или клиентов, не скачивающих файл адресной книги.
  
## <a name="current-configuration"></a>Текущая конфигурация

Централизованная служба ведения журнала настроена для определения того, для чего предназначена служба ведения журнала, как она собирает, откуда она будет собираться и какие параметры журнала. Эти параметры определяются глобально (то есть для всего развертывания) или для сайта (то есть имени сайта в развертывании). Любое определенное ведение журнала приведет к использованию параметров, подходящих для удостоверения, используемого для команд запуска, остановки, очистки журналов и выполнения поиска.
  
### <a name="to-display-the-current-centralized-logging-service-configuration"></a>Отображение текущей конфигурации централизованной службы ведения журнала.

1. Запустите Skype для бизнеса Server: нажмите кнопку **Начните, нажмите** кнопку Все **программы, нажмите** кнопку Skype для бизнеса **2015**, а затем нажмите кнопку **Skype для бизнеса Server управленческой оболочки**.
    
2. Введите следующую команду в командной строке:
    
   ```PowerShell
   Get-CsClsConfiguration
   ```

    > [!TIP]
    > Можно сузить  `-Identity` или расширить область параметров конфигурации, которые возвращаются путем определения и области, например "Site:Redmond", чтобы вернуть только CsClsConfiguration для сайта Redmond. Если вы хотите получить сведения о данной части конфигурации, вы можете совмещать вывод в другой Windows PowerShell. Например, чтобы получить сведения о сценариях, определенных в конфигурации сайта "Redmond", введите: `Get-CsClsConfiguration -Identity "site:Redmond" | Select-Object -ExpandProperty Scenarios`
  
     ![Пример вывода get-CsClsConfiguration.](../../media/Ops_Get-CsClsConfiguration_Basic.jpg)
  
    В результате этого комлета отображается текущая конфигурация централизированной службы ведения журнала.
    
|**Настройка конфигурации**|**Описание**|
|:-----|:-----|
|**Identity** <br/> |Определяет область действия и имя данной конфигурации.  Существует одна глобальная конфигурация и по одной конфигурации для каждого сайта.  <br/> |
|**Scenarios** <br/> |Список всех сценариев, определенных для данной конфигурации.  <br/> |
|**SearchTerms** <br/> |Определенные поисковые запросы для этой конфигурации. Microsoft 365 или Office 365, а не локального развертывания.  <br/> |
|**SecurityGroups** <br/> |Определенные группы безопасности, которые управляют кто (т. е. участники групп безопасности) могут просматривать компьютеры на основе сайта их размещения. Сайт в этом контексте — это сайт, определенный в Topology Builder.  <br/> |
|**Регионы** <br/> |Определенные регионы используются для сбора групп безопасности по регионам, например EMEA (страны Европы, Ближнего Востока и Африки).  <br/> |
|**EtlFileRolloverSizeMB** <br/> |Данный параметры указывает максимальный размер файла журнала до создания нового файла трассировки журнала (.etl). Новый файл журнала создается при достижении определенного размера, даже если не было достигнуто значение, заданное в параметре EtlFileRolloverMinutes.  <br/> |
|**EtlFileRolloverMinutes** <br/> |Определенное максимальное время существования журнала (в минутах) до создания нового ETL-файла. Новый файл журнала создается по завершении таймера, даже если еще не было достигнуто значение максимального размера, заданное в параметре EtlFileRolloverSizeMB.  <br/> |
|**TmfFileSearchPath** <br/> |Местоположение для поиска файлов формата трассировки сообщений.  <br/> |
|**CacheFileLocalFolders** <br/> |Определенный путь к месту сохранения файлов кэша на компьютерах. CLSAgent записывает файлы кэша и работает в контексте сетевой службы. В этом случае значением переменной %TEMP% является %WINDIR%\ServiceProfiles\NetworkService\AppData\Local. По умолчанию файлы кэша и файлы журнала записываются в один каталог.  <br/> |
|**CacheFileNetworkFolder** <br/> |Можно определить UNC-путь для получения файлов кэша во время операций ведения журналов.  <br/> |
|**CacheFileLocalRetentionPeriod** <br/> |Определяется как максимальное время в днях для сохранения файлов кэша.  <br/> |
|**CacheFileMaxDiskUsage** <br/> |Определяется как часть дискового пространства (выраженное в процентах), которое может использоваться под файлы кэша.  <br/> |
|**ComponentThrottleLimit** <br/> |Определяется как максимальное количество трассировок в секунду, которое может создавать компонент до активации автоматического ограничителя.  <br/> |
|**ComponentThrottleSample** <br/> |Количество превышений значения ComponentThrottleLimit в течение 60 секунд.  <br/> |
|**MinimumClsAgentServiceVersion** <br/> |Минимальная версия CLSAgent, допустимая для запуска. Этот элемент предназначен для Microsoft 365 или Office 365.  <br/> |
