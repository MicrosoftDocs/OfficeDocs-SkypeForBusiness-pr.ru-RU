---
title: Развертывание диспетчера статистики в Skype для бизнеса Server
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 37b2bb9c-c5d4-4fb0-a976-670b7594b82f
description: Сводка. Этот раздел посвящен развертыванию диспетчера статистики в Skype для бизнеса Server.
ms.openlocfilehash: 57b799079da400389b9e3049406a52bbba4dc1e6
ms.sourcegitcommit: 2cc98fcecd753e6e8374fc1b5a78b8e3d61e0cf7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2020
ms.locfileid: "40990614"
---
# <a name="deploy-statistics-manager-for-skype-for-business-server"></a>Развертывание диспетчера статистики в Skype для бизнеса Server
 
**Сводка.** Этот раздел посвящен развертыванию диспетчера статистики в Skype для бизнеса Server.
  
 Диспетчер статистики в Skype для бизнеса Server — это эффективный инструмент, который позволяет просматривать данные о состоянии и производительности Skype для бизнеса Server в режиме реального времени. Вы можете вести опрос данных о производительности нескольких сотен серверов каждые несколько секунд и мгновенно просматривать результаты на веб-сайте диспетчера статистики.
  
Перед установкой диспетчера статистики следует ознакомиться с требованиями к программному обеспечению, сети и оборудованию. Дополнительные сведения см. в статье [Планирование диспетчера статистики в Skype для бизнеса Server](plan.md).
  
> [!NOTE]
> Если вы обновляете более раннюю версию диспетчера статистики, см. статью [Обновление диспетчера статистики в Skype для бизнеса Server](upgrade.md). 
  
> [!NOTE]
> Веб-сайт диспетчера статистики тестировался и корректно работает с браузерами Internet Explorer 11 и более поздних версий, Microsoft Edge 20.10240 и более поздних версий и Chrome 46 и более поздних версий (текущая актуальная версия). 
  
Диспетчера статистики можно скачать по адресу [https://aka.ms/StatsManDownload](https://aka.ms/StatsManDownload). 
  
В этой статье содержатся следующие разделы.
  
- [Развертывание диспетчера статистики](deploy.md#BKMK_Deploy)
    
- [Поиск и устранение неполадок в развертывании](deploy.md#BKMK_Troubleshoot)
    
- [Создание самозаверяющего сертификата](deploy.md#BKMK_SelfCert)
    
## <a name="deploy-statistics-manager"></a>Развертывание диспетчера статистики
<a name="BKMK_Deploy"> </a>

Чтобы развернуть диспетчера статистики, сделайте следующее.
  
1. Подготовьте хост-компьютер прослушивателя, установив систему кэширования в памяти Redis и убедившись, что установлены все необходимые сертификаты.
    
2. Установите службу прослушивателя на хост-компьютере. 
    
3. Установите веб-сайт на хост-компьютере.
    
4. Установите агент на каждом отслеживаемом компьютере с Skype для бизнеса Server.
    
5. Импортируйте топологию для отслеживаемых серверов.
    
> [!NOTE]
> Система Redis, служба прослушивателя и веб-сайт должны быть установлены на одном хост-компьютере. Убедитесь, что на хост-компьютере не установлен Skype для бизнеса Server. 
  
### <a name="prepare-the-listener-host-machine"></a>Подготовка хост-компьютера прослушивателя

Для подготовки хост-компьютера необходимо установить систему кэширования в памяти Redis и убедиться, что на компьютере установлен действительный сертификат. Майкрософт рекомендует устанавливать последнюю стабильную сборку системы Redis 3.0. Диспетчер статистики версии 2.0 тестировался с системами Redis 3.2.100. 
  
1. Скачайте Redis со следующего сайта: [https://github.com/MSOpenTech/redis](https://github.com/MSOpenTech/redis). 
    
    Неподписанные установщики можно скачать с веб-страницы [https://github.com/MSOpenTech/redis/releases](https://github.com/MSOpenTech/redis/releases)
    
    При необходимости подписанные двоичные файлы можно получить через популярные диспетчеры пакетов — [Nuget](https://www.nuget.org/packages/Redis-64/) и [Choclatey](https://chocolatey.org/packages/redis-64).
    
   - Запустите MSI-файл и следуйте указаниям.
    
   - Не устанавливайте флажок, добавляющий правило брандмауэра.
    
2. Службе прослушивателя требуется сертификат. Майкрософт настоятельно рекомендует использовать сертификат, подписанный надежным центром сертификации. 
    
    Если вы хотите использовать самозаверяющий сертификат (например, для тестирования в лаборатории), см. раздел [Создание самозаверяющего сертификата](deploy.md#BKMK_SelfCert).
    
    Обратите внимание, что агент использует проверку по отпечатку сертификата (вместо проверки цепочки сертификатов). Он не будет выполнять полную проверку сертификатов, так как возможно использование самозаверяющих сертификатов.
    
### <a name="install-the-listener-service"></a>Установка службы прослушивателя

Установите службу прослушивателя на хост-компьютере, запустив файл StatsManPerfAgentListener.msi и сделав следующее:
  
1. Изучите лицензионное соглашение. Если вы согласны, выберите пункт **Я принимаю условия лицензионного соглашения** и нажмите кнопку **Далее**.  
    
2. На следующей странице введите указанную ниже информацию.
    
   - **Пароль службы**. Этот пароль будет использоваться удаленными агентами для проверки подлинности в службе прослушивателя.
    
   - **Порт службы**. Это номер HTTPS-порта, используемый прослушивателем для связи с агентами. Во время установки этот порт будет разрешен в локальном брандмауэре, будет создан список ACL для URL-адреса и к этому порту будет привязан SSL-сертификат. Значение по умолчанию — 8443.
    
   - **Отпечаток сертификата**. Это отпечаток сертификата, используемый прослушивателем для шифрования в протоколе HTTPS. Сетевая служба должна иметь доступ на чтение к закрытому ключу.
    
     Для выбора отпечатка сертификата нажмите кнопку **Выбор...**.
    
     Отпечаток сертификата можно найти с помощью диспетчера сертификатов или с помощью следующей команды PowerShell:
    
   ```PowerShell
   Get-ChildItem -path cert:\LocalMachine\My
   ```

   - **Каталог установки**. Это каталог, куда устанавливаются двоичные файлы. Каталог по умолчанию можно изменить на другой с помощью кнопки **Обзор...**.
    
   - **Каталог AppData**. Это каталог, в котором будут храниться папка Logs и другие данные. Каталог по умолчанию можно изменить на другой. Он не будет удален при удалении программы.
    
3. Нажмите кнопку **Установить**.
    
Чтобы проверить установку, сделайте следующее.
  
1. Откройте браузер и перейдите по адресу https://localhost:\<service-port\>/healthcheck/.
    
    По умолчанию порт службы — 8443 (если вы не задали другой порт).
    
2. Чтобы убедиться, что прослушиватель установлен правильно, проверьте следующие вещи.
    
   - Если страница проверки работоспособности отображается, прослушиватель установлен успешно.
    
   - Если Кновнсерверкаунт имеет значение 1 или выше, устанавливается соединение с Redis.
    
   - Подождав несколько минут и дождавшись установки по меньшей мере одного агента, посмотрите, увеличивается ли значение счетчика ValuesWritten.
    
### <a name="install-the-website"></a>Установка веб-сайта

Установите веб-сайт на хост-компьютере, запустив файл StatsManWebSite.msi (включен в [Skype для бизнеса Server, диспетчер статистики в режиме реального времени (64-разрядный)](https://www.microsoft.com/en-in/download/details.aspx?id=57518)) и сделав следующее:
  
1. Изучите лицензионное соглашение. Если вы согласны, выберите пункт **Я принимаю условия лицензионного соглашения** и нажмите кнопку **Далее**.  
    
2. На следующей странице введите указанную ниже информацию.
    
   - **Порт службы**. Это номер порта, который прослушивается веб-сайтом. Его можно изменить позже, используя привязку порта в диспетчере служб IIS. Во время установки этот порт будет разрешен в локальном брандмауэре.
    
   - **Каталог установки**. Это каталог, куда устанавливаются двоичные файлы. Каталог по умолчанию можно изменить на другой с помощью кнопки **Обзор...**.
    
   - **Каталог AppData**. Это каталог, в котором будут храниться папка Logs и другие данные. Каталог по умолчанию можно изменить на другой. Он не будет удален при удалении программы.
    
3. Нажмите кнопку **Установить**.
    
Для просмотра веб-сайта откройте в браузере адрес http://localhost,webport\>/.
  
Для просмотра только информации о работоспособности откройте в браузере адрес http://localhost:\<webport\>/healthcheck/.
  
По умолчанию номер веб-порта — 8080. Привязку порта веб-сайта можно изменить с помощью диспетчера служб IIS.
  
Веб-установщик добавляет локальную группу безопасности с именем StatsManWebSiteUsers. В эту группу безопасности можно добавить учетные записи, которым нужно дать доступ к веб-сайту. 
  
### <a name="install-the-agents"></a>Установка агентов

Установите агент на все серверы Skype для бизнеса Server, которые необходимо отслеживать, запустив файл StatsManPerfAgent.msi и сделав следующее.
  
1. Изучите лицензионное соглашение. Если вы согласны, выберите пункт **Я принимаю условия лицензионного соглашения** и нажмите кнопку **Далее**.  
    
2. На следующей странице введите указанную ниже информацию.
    
   - **Пароль службы**. Этот пароль будет использоваться удаленными агентами для проверки подлинности в службе прослушивателя.
    
   - **URI службы**. Это URI, по которому располагается прослушиватель. Он должен иметь формат https://name:port.
    
     Можно использовать NetBIOS-имя или полное доменное имя. Также можно использовать имя, указанное в качестве **Субъекта** или **Альтернативного имени субъекта** в сертификате службы прослушивателя, но это не является обязательным требованием.
    
   - **Отпечаток службы**. Это отпечаток SSL-сертификата, используемого прослушивателем. Этот отпечаток будет использоваться агентом для проверки подлинности в службе прослушивателя. (Он не будет выполнять полную проверку сертификатов, так как возможно использование самозаверяющих сертификатов.)
    
   - **Каталог установки**. Это каталог, куда устанавливаются двоичные файлы. Каталог по умолчанию можно изменить на другой с помощью кнопки **Обзор...**.
    
   - **Каталог AppData**. Это каталог, в котором будут храниться папка Logs и зашифрованный файл password.txt. Каталог по умолчанию можно изменить на другой. Он не будет удален при удалении программы.
    
3. Нажмите кнопку **Установить**.
    
Если вы устанавливаете агент на несколько компьютеров, возможно, стоит сделать это в автоматическом режиме. Пример: 
  
```
msiexec /l install.log /i StatsManPerfAgent.msi SERVICE_THUMBPRINT=<thumbprint> SERVICE_PASSWORD=<password> SERVICE_URI=https://<hostname>:<servicePort>/[INSTALLDIR=<directory>][DIR_  STATSMANAPPDATA=<directory>]
```

### <a name="import-the-topology"></a>импорт топологии
<a name="BKMK_ImportTopology"> </a>

После установки и запуска диспетчера статистики необходимо импортировать топологию Skype для бизнеса Server, чтобы диспетчер статистики знал сайт, пул и роль каждого сервера. Для импорта топологии Skype для бизнеса Server используйте командлет [Get-CsPool](https://docs.microsoft.com/powershell/module/skype/get-cspool?view=skype-ps), чтобы получить информацию о каждом пуле, используемом в вашей организации, а затем импортируйте эту информацию в диспетчер статистики.
  
Чтобы импортировать топологию Skype для бизнеса Server, выполните следующие действия:
  
1. На хосте, где есть командлеты PowerShell Skype для бизнеса Server:
    
    a) Выполните следующую команду. 
    
   ```PowerShell
   Get-CsPool | Export-Clixml -Path mypoolinfo.xml
   ```
    б) Скопируйте файл mypoolinfo.xml на сервер, на котором запущен прослушиватель.
    
2. На хосте, на котором запущен прослушиватель:
    
   a) Запустите PowerShell.
    
   б) Перейдите в каталог, куда установлен прослушиватель. По умолчанию это: 
    
   ```PowerShell
   cd C:\Program Files\Skype for Business Server StatsMan Listener
   ```

3. Чтобы проверить, какие серверы добавляются и обновляются, выполните следующую команду:
    
   ```PowerShell
    .\Update-StatsManServerInfo.ps1 -CsPoolFile  <path to mypoolinfo.xml>
   ```

Следующая команда позволяет увидеть все параметры:
  
```PowerShell
Get-Help .\Update-StatsManServerInfo.ps1 -Detailed 
```

Для просмотра всей импортированной информации о сервере выполните следующий сценарий: 
  
```PowerShell
.\Get-StatsManServerInfo.ps1
```

Если вам нужно отслеживать серверы, не присутствующие в вашей топологии Skype для бизнеса Server (например, Exchange Server), вы можете импортировать один сервер на хосте, на котором запущен прослушиватель. Чтобы выполнить импорт для одного сервера, сделайте следующее.
  
1. Перейдите в каталог, куда установлен прослушиватель. По умолчанию это: 
    
   ```
   cd C:\Program Files\Skype for Business Server StatsMan Listener
   ```

2. Выполните следующую команду.
    
   ```
    .\Update-StatsManServerInfo.ps1 -HostName <hostname> -SiteName <name of site> -PoolName <poolName> -Roles <role1>[,<role2>,<roleN>]
   ```

## <a name="troubleshoot-your-deployment"></a>Поиск и устранение неполадок в развертывании
<a name="BKMK_Troubleshoot"> </a>

Если агент не запускается, проверьте следующее. 
  
- Зарегистрирован ли агент в диспетчере статистики?
    
1. 	Убедитесь, что вы выполнили инструкции по импорту топологии. См. статью [Импорт топологии](deploy.md#BKMK_ImportTopology).  
    
2. Если агент находится на сервере, который не указан в топологии (например, узлы в кластере SQL AlwaysOn), необходимо добавить агент вручную, следуя инструкциям в статье [Импорт топологии](deploy.md#BKMK_ImportTopology).
    
- Может ли агент установить контакт с прослушивателем?
    
1. Убедитесь, что служба прослушивателя запущена. 
    
    Если служба не запущена, убедитесь, что система Redis запущена, а затем попробуйте перезапустить прослушиватель.
    
2. Убедитесь, что порт открыт для службы прослушивателя и что компьютер с агентом может установить связь с этим портом.
    
- Чтобы убедиться, что диспетчер статистики собирает данные, вы можете проверить CSV-файл указанным ниже способом. 
    
    Следующая команда получает имена хранилищ счетчика: 
    
  ```
  .\PerfAgentStorageManager.exe -redis=localhost -a=listcounterstoragenames -mode=verbose | findstr /i processor
  ```

    Следующая команда получает значения указанных счетчиков: 
    
  ```
  .\PerfAgentStorageManager.exe -redis=localhost -a=getcountervalues  -counter="\\*\Processor Information\% Processor Time_Mean_Mean\_Total" -file:all-processor.csv
  ```

Информацию о всех событиях, которые можно видеть в журнале событий приложения, см. в статье [Устранение проблем диспетчера статистики в Skype для бизнеса Server](troubleshoot.md).
  
## <a name="create-a-self-signed-certificate"></a>Создание самозаверяющего сертификата
<a name="BKMK_SelfCert"> </a>

Майкрософт настоятельно рекомендует использовать сертификат, подписанный надежным центром сертификации. Если же вы хотите использовать самозаверяющий сертификат в целях тестирования, сделайте следующее. 
  
1. Выполнив вход от имени администратора, введите в консоли PowerShell следующую команду:
    
   ```PowerShell
   New-SelfSignedCertificate -DnsName StatsManListener -CertStoreLocation Cert:\LocalMachine\My
   ```

2. Введите `certlm.msc`. Откроется диспетчер сертификатов для локального компьютера.
    
3. Перейдите в раздел **Личное**, затем откройте раздел **Сертификаты**.
    
4. Щелкните правой кнопкой мыши элемент **StatsManListener-\>Все задачи-\>Управление закрытыми ключами…**
    
5. Нажмите **Добавить**.
    
6. В поле **Введите имена выбираемых объектов** введите "Сетевая служба"
    
7. Нажмите кнопку **ОК**.
    
8. В разделе **Полный доступ** снимите флажок **Разрешить**. (Необходим только доступ на чтение.)
    
9. Нажмите кнопку **ОК**.
    
## <a name="for-more-information"></a>Дополнительные сведения
<a name="BKMK_SelfCert"> </a>

Дополнительные сведения см. в указанных ниже статьях.
  
- [Планирование диспетчера статистики в Skype для бизнеса Server](plan.md)
    
- [Обновление диспетчера статистики в Skype для бизнеса Server](upgrade.md)
    
- [Устранение проблем диспетчера статистики в Skype для бизнеса Server](troubleshoot.md) ß
