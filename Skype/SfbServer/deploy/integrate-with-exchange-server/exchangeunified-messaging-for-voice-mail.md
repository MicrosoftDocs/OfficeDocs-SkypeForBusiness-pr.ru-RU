---
title: Настройка единой Exchange Server для голосовой почты Skype для бизнеса Server
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
ms.date: 2/11/2019
audience: ITPro
ms.topic: quickstart
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 1be9c4f4-fd8e-4d64-9798-f8737b12e2ab
description: Сводка. Настройка единой Exchange Server для голосовой почты Skype для бизнеса Server.
ms.openlocfilehash: 68cf4a11deccac9ad71bdb6216c4126362787498
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49834039"
---
# <a name="configure-exchange-server-unified-messaging-for-skype-for-business-server-voice-mail"></a>Настройка единой Exchange Server для голосовой почты Skype для бизнеса Server
 
**Сводка:** Настройте Exchange Server единой системы обмена сообщениями для голосовой почты Skype для бизнеса Server.
  
Skype для бизнеса Server позволяет хранить сообщения голосовой почты в Exchange Server 2016 или Exchange Server 2013; эти сообщения голосовой почты будут отображаться в почтовых ящиках пользователей в качестве сообщений электронной почты. 

> [!NOTE]
> Как уже было известно, единая система обмена сообщениями Exchange больше недоступна в Exchange 2019, но вы по-прежнему можете использовать телефонную систему для записи сообщений голосовой почты, а затем оставить запись в почтовом ящике Exchange пользователя. Дополнительные [сведения см. в](../../../sfbhybrid/hybrid/plan-cloud-voicemail.md) записи "Планирование облачной голосовой почты".
  
If you have already configured server-to-server authentication between Skype for Business Server and Exchange Server 2016 or Exchange Server 2013, then you are ready to setup unified messaging. Для этого необходимо сначала создать и назначить новую телефонную систему единой системы обмена сообщениями на Exchange Server. Например, эти две команды (запускаемые в командной оболочке Exchange) настраивают новую трехзначную телефонную план для Exchange:
  
```powershell
New-UMDialPlan -Name "RedmondDialPlan" -VoIPSecurity "Secured" -NumberOfDigitsInExtension 3 -URIType "SipName" -CountryOrRegionCode 1
Set-UMDialPlan "RedmondDialPlan" -ConfiguredInCountryOrRegionGroups "Anywhere,*,*,*" -AllowedInCountryOrRegionGroups "Anywhere"
```

В первой команде в примере параметр VoIPSecurity и значение параметра "Secured" указывают, что канал сигналов шифруется с помощью TLS. URIType "SipName" указывает, что сообщения будут отправляться и получены по протоколу SIP, а код CountryOrRegionCode 1 указывает, что эта телефонная плана применяется к США.
  
Во второй команде значение параметра, передаваемое параметру ConfiguredInCountryOrRegionGroups, указывает группы в стране, которые можно использовать с этой телефонной группой. Значение параметра "Anywhere, \* \* , " задает \* следующее:
  
- Имя группы ("Anywhere")
    
- AllowedNumberString ( подстрок, указывающий, что любая строка \* номера разрешена)
    
- DialNumberString ( поддиадровое обозначение, указывающее, что любой \* набираемый номер разрешен)
    
- TextComment ( \* поддиакон, указывающий, что любая текстовая команда разрешена)
    
> [!NOTE]
> При создании новой телефонной плана также будет создаваться политика почтовых ящиков по умолчанию. 
  
После создания и настройки новой телефонной системы необходимо добавить новую на сервер единой системы обмена сообщениями, а затем изменить режим запуска этого сервера; в частности, необходимо установить режим запуска "Dual". Обе эти задачи можно выполнить в пределах exchange Management Shell:
  
```powershell
Set-UmService -Identity "atl-exchangeum-001.litwareinc.com" -DialPlans "RedmondDialPlan" -UMStartupMode "Dual"
```

После настройки сервера единой системы обмена сообщениями необходимо выполнить следующий Enable-ExchangeCertificate, чтобы убедиться, что сертификат Exchange применен к службе единой системы обмена сообщениями:
  
```powershell
Enable-ExchangeCertificate -Server "atl-umserver-001.litwareinc.com" -Thumbprint "EA5A332496CC05DA69B75B66111C0F78A110D22d" -Services "SMTP","IIS","UM"
```

После правильного присвоения сертификата необходимо остановить и перезапустить службу MsExchangeUM на сервере единой системы обмена сообщениями. Эту службу необходимо остановить и перезапустить при любом изменении режима запуска.
  
После завершения настройки сервера единой системы обмена сообщениями можно настроить маршрутизатор вызовов единой системы обмена сообщениями:
  
```powershell
Set-UMCallRouterSettings -Server "atl-exchange-001.litwareinc.com" -UMStartupMode "Dual" -DialPlans "RedmondDialPlan" 
Enable-ExchangeCertificate -Server "atl-umserver-001.litwareinc.com" -Thumbprint "45BAA32496CC891169B75B9811320F78A1075DDA" -Services "IIS","UMCallRouter"
```

Поскольку режим запуска изменился, необходимо остановить и перезапустить службу MsExchangeUMCR на компьютере, где размещен маршрутизатор вызовов этой системы.
  
Для завершения настройки единой системы обмена сообщениями необходимо создать политику почтовых ящиков единой системы обмена сообщениями, а затем использовать эту политику, чтобы включить для пользователей единую систему обмена сообщениями. Вы можете создать политику почтовых ящиков с помощью команды, похожей на данной:
  
```powershell
New-UMMailboxPolicy -Name "RedmondMailboxPolicy" -AllowedInCountryOrRegionGroups "Anywhere"
```

Кроме того, можно включить для пользователя единую систему обмена сообщениями с помощью команды, похожей на данной:
  
```powershell
Enable-UMMailbox -Extensions 100 -SIPResourceIdentifier "kenmyer@litwareinc.com" -Identity "litwareinc\kenmyer" -UMMailboxPolicy "RedmondMailboxPolicy"
```

В предыдущей команде параметр Extensions представляет номер телефона пользователя. В этом примере пользователь имеет номер расширения 100.
  
После включения его почтового ящика пользователь kenmyer@litwareinc.com сможет использовать единую систему обмена сообщениями Exchange. Чтобы убедиться, что пользователь может подключиться к exchange UM, с помощью команды [Test-CsExUMConnectivity](https://docs.microsoft.com/powershell/module/skype/test-csexumconnectivity?view=skype-ps) в оболочке управления Skype для бизнеса Server:
  
```powershell
$credential = Get-Credential "litwareinc\kenmyer"
Test-CsExUMConnectivity -TargetFqdn "atl-cs-001.litwareinc.com" -UserSipAddress "sip:kenmyer@litwareinc.com" -UserCredential $credential
```

Если у вас есть второй пользователь с включенной поддержкой единой системы обмена сообщениями, вы можете использовать для проверки, может ли второй пользователь оставить голосовое сообщение для первого пользователя с помощью [test-CsExUMVoiceMail.](https://docs.microsoft.com/powershell/module/skype/test-csexumvoicemail?view=skype-ps)
  
```powershell
$credential = Get-Credential "litwareinc\pilar"
Test-CsExUMVoiceMail -TargetFqdn "atl-cs-001.litwareinc.com" -ReceiverSipAddress "sip:kenmyer@litwareinc.com" -SenderSipAddress "sip:pilar@litwareinc.com" -SenderCredential $credential
```



## <a name="configuring-unified-messaging-on-microsoft-exchange-server"></a>Настройка единой системы обмена сообщениями на Microsoft Exchange Server 
> [!IMPORTANT]
> Если вы хотите использовать единую систему обмена сообщениями Exchange для предоставления служб автоотвечения, голосовой доступ к Outlook или автослужб для пользователей Корпоративная голосовая связь, ознакомьтесь с разделом ["Планирование](../../plan-your-deployment/integrate-with-exchange/unified-messaging.md)интеграции единой системы обмена сообщениями Exchange в Skype для бизнеса" и следуйте инструкциям в этом разделе. 

Чтобы настроить единую систему обмена сообщениями Exchange для работы с Корпоративная голосовая связь, необходимо выполнить следующие задачи:

- Настройка сертификатов на сервере со службами единой системы обмена сообщениями Exchange
  > [!NOTE]
  > Добавить все серверы клиентского доступа и почтовых ящиков во все абонентские группы URI для SIP единой системы обмена сообщениями. В противном случае маршрутизация исходящих вызовов не сможет работать ожидаемым образом. 
- При необходимости создайте одну или несколько абонентские планы SIP URI для SIP, а также номера телефонов для абонентского доступа, а затем создайте соответствующие абонентские планы L.

- С помощью сценария exchucutil.ps1:
    - создать IP-шлюзы единой системы обмена сообщениями;
    - создать сервисные группы единой системы обмена сообщениями;
    - Предоставление Skype для бизнеса Server разрешения на чтение объектов доменных служб Active Directory в этой службе.
- создать объект автосекретаря единой системы обмена сообщениями;
- создать объект абонентского доступа;
- создать URI для SIP для каждого пользователя и связать пользователей с абонентской группой SIP единой системы обмена сообщениями.

### <a name="requirements-and-recommendations"></a>Требования и рекомендации

Перед началом работы в документации этого раздела предполагается, что развернуты следующие роли Exchange: клиентский доступ и почтовый ящик. В Microsoft Exchange Server exchange um runs as a service on these servers.

Также обратите внимание на следующее.
- Если система обмена данными Exchange установлена в нескольких лесах, необходимо выполнить Exchange Server интеграции для каждого леса. Кроме того, каждый лес системы должен быть настроен для доверия лесу, в котором развернут Skype для бизнеса Server, а лес, в котором развернутSkype для бизнеса Server, должен быть настроен для доверия каждому лесу этой системы.
- Действия по интеграции выполняются как для ролей Exchange Server, где запущены службы единой системы обмена сообщениями, так и для сервера Skype для бизнеса Server. Прежде чем выполнять действия по интеграции Lync Server 2013, необходимо выполнить Exchange Server интеграции единой системы обмена сообщениями.
  > [!NOTE]
  > Сведения о том, какие действия по интеграции выполняются на каких серверах и на каких ролях администраторов, см. в обзоре процесса развертывания для интеграции локальной единой системы обмена сообщениями и [Skype для бизнеса.](../../plan-your-deployment/integrate-with-exchange/deployment-overview.md) 

На каждом сервере с exchange UM должны быть доступны следующие средства:
- Командная консоль Exchange
- сценарий exchucutil.ps1, выполняющий следующие задачи:
    - Создает шлюз IP для каждого сервера Skype для бизнеса Server.
    - Создает группу для каждого шлюза. Идентификатор пилотного проекта для каждой группы определяет группу URI SIP, используемую пулом переднего плана или сервером Standard Edition, связанным со шлюзом.
    - Предоставляет Skype для бизнеса Server разрешение на чтение объектов exchange UM в доменных службах Active Directory.



### <a name="configure-unified-messaging-on-microsoft-exchange-with-exchucutilps1"></a>Настройка единой системы обмена сообщениями в Microsoft Exchange с помощью ExchUCUtil.ps1 

При интеграции Microsoft Skype для бизнеса Server с единой системы обмена сообщениями Exchange необходимо запустить сценарий ExchUcUtil.ps1 в оболочке. Сценарий ExchUcUtil.ps1 выполняет указанные ниже действия.

- Создает шлюз IP для каждого пула Skype для бизнеса Server.

> [!IMPORTANT]
> Сценарий ExchUcUtil.ps1 создает один или несколько шлюзов IP системы. Необходимо отключить исходяющие вызовы на всех шлюзах IP системы, кроме одного шлюза, созданного сценарием. Это включает отключение исходяющих вызовов на шлюзах IP системы, созданных до того, как вы запустили сценарий. 

- Создает сервисную группу единой системы обмена сообщениями для каждого шлюза IP единой системы обмена сообщениями. Идентификатор пилотного проекта для каждой сервисной группы указывает группу URI SIP, используемую пулом переднего плана Skype для бизнеса Server или сервером Standard Edition, связанным со шлюзом IP этой системы.
- Предоставляет Skype для бизнеса Server разрешение на чтение объектов контейнеров этой системы Active Directory, таких как группы, автозаверяющие службы, шлюзы IP и сервисные группы этой системы.
  > [!IMPORTANT]
  > Каждый лес должен быть настроен для доверия лесу, в котором развернут Skype для бизнеса Server, а лес, в котором развернут Skype для бизнеса Server 2013, должен быть настроен для доверия каждому лесу этой системы. Если система обмена данными Exchange установлена в нескольких лесах, необходимо выполнить Exchange Server интеграции для каждого леса или указать домен Skype для бизнеса Server. Например, ExchUcUtil.ps1 –Forest:<lync-domain-controller-fqdn>. 

### <a name="use-the-shell-to-run-the-exchucutilps1-script"></a>Использование командной консоли Exchange для запуска сценария ExchUcUtil.ps1

Запустите ExchUcUtil.ps1 на любом сервере Exchange в организации, который в той же топологии, что и Skype для бизнеса Server. Вы можете запустить сценарий на сервере почтовых ящиков с помощью командной консоли или с помощью удаленного Windows PowerShell на сервере клиентского доступа. Если вы запустите сценарий на сервере клиентского доступа в своей организации, этот сервер выступит в роли прокси-сервера в сеансе удаленного Windows PowerShell для сервера почтовых ящиков в организации.
> [!IMPORTANT]
> Сценарий ExchUcUtil.ps1 создает один или несколько шлюзов IP системы. Необходимо отключить исходяющие вызовы на всех шлюзах IP системы, кроме одного шлюза, созданного сценарием. Это включает отключение исходяющих вызовов на шлюзах IP системы, созданных до того, как вы запустили сценарий. Чтобы отключить исходяющие вызовы на шлюзе IP этой системы, см. пункт "Отключение исходяющих вызовов на шлюзах IP этой системы". 
> [!IMPORTANT]
> Чтобы запускать этот сценарий, вы должны обладать разрешениями роли руководителя организации Exchange или являться участником группы безопасности "Администраторы организации Exchange". 

1. Запустите командную консоль Exchange.
2. В запросе C:\Windows\System32 **\<drive letter> введите cd :\Program Files\Microsoft\Exchange Server\V15\Scripts>.ExchUcUtil.ps1,** а затем нажмите ввод.

#### <a name="how-do-you-know-this-worked"></a>Как проверить, что все получилось?

Чтобы убедиться в успешном выполнении сценария ExchUcUtul.ps1, выполните следующие действия:
- С помощью командлета Get-UMIPGateway или Центра администрирования Exchange просмотрите один или несколько вновь созданных шлюзов IP единой системы обмена сообщениями.
- С помощью командлета Get-UMHuntGroup или Центра администрирования Exchange просмотрите одну или несколько вновь созданных сервисных групп единой системы обмена сообщениями.

### <a name="configure-certificates-on-the-server-running-exchange-server-unified-messaging"></a>Настройка сертификатов на сервере, на Exchange Server единой системы обмена сообщениями
 
Если вы развернули единую систему обмена сообщениями Exchange, как описано в документации по планированию интеграции единой системы обмена сообщениями Exchange в Skype для бизнеса Server, и хотите предоставить функции единой системы обмена сообщениями Exchange пользователям Корпоративная голосовая связь в организации, можно использовать следующие процедуры для настройки сертификата на сервере с единой системы обмена сообщениями Exchange.

> [!IMPORTANT]
> Для внутренних сертификатов как серверы Skype для бизнеса Server, так и серверы с Microsoft Exchange должны иметь сертификаты доверенных корневых полномочий, которые являются взаимно доверенными. Может использоваться один и тот же или разные центры сертификации, но корневой сертификат центра сертификации (CA) на серверах должен быть зарегистрирован в хранилище доверенных корневых сертификатов ЦС. 

Для Exchange Server необходимо настроить сертификат сервера для подключения к Skype для бизнеса Server:
1. Загрузите сертификат ЦС для сервера Exchange Server.
2. Установите сертификат ЦС для сервера Exchange Server.
3. Убедитесь в том, что ЦС включен в список доверенных корневых ЦС сервера Exchange Server.
4. Создайте запрос сертификата для сервера Exchange Server и установите сертификат. 
5. Назначьте сертификат серверу Exchange Server.


**Чтобы скачать сертификат ЦС:**

1. На сервере с exchange UM нажмите кнопку "Начните", выберите "Выполнить", **введите http:// \<name of your Issuing CA Server> /certsrv,** а затем нажмите кнопку **"ОК".** 
2. В области "Выбор задачи" щелкните **"Скачать сертификат ЦС" или "Цепочка сертификатов" или CRL.**
3. В **области загрузки сертификата ЦС,** цепочки сертификатов или CRL выберите "Метод кодиирования в Base **64"** и нажмите кнопку "Скачать **сертификат ЦС".**
   > [!NOTE]
   > На этом этапе вы можете задать шифрование DER. Если вы выбрали шифрование DER, то в следующем шаге процедуры, а также в шаге 10 **Установка сертификата ЦС** вместо типа файла CER будет использоваться тип P7B. 
4. В диалоговом окне **Загрузка файла** нажмите кнопку **Сохранить** и сохраните файл на жесткий диск на сервере. (Файл будет иметь расширение CER или P7B в зависимости от выбранного ранее метода шифрования.)

**Чтобы установить сертификат ЦС:**

1. На сервере с exchange UM откройте консоль управления (MMC), нажав кнопку "Начните", нажмите кнопку **"Выполнить",** введите **mmc** в поле "Открыть" и нажмите кнопку **"ОК".** 
2. В меню **Файл** выберите команду **Добавить или удалить оснастку** и нажмите кнопку **Добавить**.
3. В окне **Добавить изолированную оснастку** выберите пункт **Сертификаты** и нажмите кнопку **Добавить**.
4. В диалоговом окне **Оснастка диспетчера сертификатов** выберите пункт **Учетная запись компьютера** и нажмите кнопку **Далее**.
5. В диалоговом окне **Выбор компьютера** убедитесь в том, что установлен флажок **Локальный компьютер (на котором запущена эта консоль)**, и нажмите кнопку **Готово**.
6. Нажмите кнопку **Закрыть**, а затем кнопку **ОК**. 
7. В дереве консоли разверните узел **Сертификаты (локальный компьютер)**, узел **Доверенные корневые центры сертификации** и щелкните папку **Сертификаты**.
8. Щелкните папку **Сертификаты** правой кнопкой мыши, наведите указатель на пункт **Все задачи** и выберите команду **Импорт**.
9. Нажмите кнопку **Далее**. 
10. Нажмите кнопку **Обзор**, чтобы выбрать файл, после чего нажмите кнопку **Далее**. (Файл будет иметь расширение CER или P7B в зависимости от метода шифрования, выбранного в шаге 3 раздела **Загрузка сертификата ЦС**).
11. Щелкните **"Разместить все сертификаты"** в следующем хранилище.
12. Нажмите кнопку **Обзор** и выберите элемент **Доверенные корневые центры сертификации**. 
13. Нажмите кнопку **Далее**, чтобы проверить параметры, после чего нажмите кнопку **Готово**. 


**Чтобы убедиться, что ЦС находится в списке доверенных корневых ЦС:**

1. На сервере с exchange UM в MMC расширьте сертификаты (локальный компьютер), развернув доверенные корневые органы сертификации, а затем щелкните "Сертификаты".
2. В области сведений проверьте, имеется ли ЦС в списке доверенных ЦС.


