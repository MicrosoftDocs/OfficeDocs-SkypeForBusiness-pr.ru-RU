---
title: Настройка единой системы обмена сообщениями Exchange Server для голосовой почты Skype для бизнеса Server
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
ms.date: 2/11/2019
audience: ITPro
ms.topic: quickstart
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: 1be9c4f4-fd8e-4d64-9798-f8737b12e2ab
description: 'Сводка: Настройка единой системы обмена сообщениями Exchange Server для голосовой почты в Skype для бизнеса Server.'
ms.openlocfilehash: affaf5eb25b755d51d4ce47dd75834b6704d7610
ms.sourcegitcommit: b1229ed5dc25a04e56aa02aab8ad3d4209559d8f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2020
ms.locfileid: "41797070"
---
# <a name="configure-exchange-server-unified-messaging-for-skype-for-business-server-voice-mail"></a>Настройка единой системы обмена сообщениями Exchange Server для голосовой почты Skype для бизнеса Server
 
**Сводка:** Настройте единую систему обмена сообщениями Exchange Server для голосовой почты в Skype для бизнеса Server.
  
Skype для бизнеса Server позволяет использовать голосовые сообщения, хранящиеся в Exchange Server 2016 или Exchange Server 2013; Эти голосовые сообщения будут отображаться как сообщения электронной почты в ящиках пользователей. 

> [!NOTE]
> Единая система обмена сообщениями Exchange, которая ранее известна, больше не доступна в Exchange 2019, но вы по-прежнему можете использовать телефонную систему для записи голосовых сообщений, а затем оставить запись в почтовом ящике Exchange пользователя. Дополнительные сведения приведены в разделе [планирование облачной службы голосовой почты](../../../sfbhybrid/hybrid/plan-cloud-voicemail.md) .
  
Если вы уже настроили проверку подлинности серверов в Skype для бизнеса Server и Exchange Server 2016 или Exchange Server 2013, вы можете настроить единую систему обмена сообщениями. Для этого необходимо сначала создать и назначить новую абонентскую группу единой системы обмена сообщениями на сервере Exchange. Например, эти две команды (выполняются из командной консоли Exchange) настраивают новый 3-значный абонентский тариф для Exchange:
  
```powershell
New-UMDialPlan -Name "RedmondDialPlan" -VoIPSecurity "Secured" -NumberOfDigitsInExtension 3 -URIType "SipName" -CountryOrRegionCode 1
Set-UMDialPlan "RedmondDialPlan" -ConfiguredInCountryOrRegionGroups "Anywhere,*,*,*" -AllowedInCountryOrRegionGroups "Anywhere"
```

В первой команде примера параметр Воипсекурити и значение параметра "безопасно" указывает на то, что канал сигналов шифруется с помощью протокола TLS. Значение "SipName" параметра URIType указывает, что сообщения будут отправляться и получаться посредством протокола SIP, а если для параметра CountryOrRegionCode выбрано значение "1", это свидетельствует о том, что абонентская группа применима для США.
  
Во второй команде значение, переданное в параметр ConfiguredInCountryOrRegionGroups, определяет группы внутри страны, которые можно использовать в этой абонентской группе. Значение параметра "везде\*\*",\*"," задает указанные ниже значения.
  
- Имя группы ("Anywhere")
    
- Алловеднумберстринг (\*— подстановочный знак, указывающий на то, что любая строка с цифрами разрешена)
    
- Диалнумберстринг (\*— подстановочный знак, указывающий на то, что все номера разрешены)
    
- Тексткоммент (\*— подстановочный знак, указывающий на то, что какая-либо из текстовых команд разрешена)
    
> [!NOTE]
> При создании новой абонентской группы создается также используемая по умолчанию политика почтовых ящиков. 
  
После создания и настройки новой абонентской группы необходимо добавить ее на сервере единой системы обмена сообщениями и затем изменить режим запуска этого сервера: в частности, задать режим запуска "Двойной". Вы можете выполнять обе эти задачи в командной консоли Exchange:
  
```powershell
Set-UmService -Identity "atl-exchangeum-001.litwareinc.com" -DialPlans "RedmondDialPlan" -UMStartupMode "Dual"
```

После того как вы настроили сервер единой системы обмена сообщениями, необходимо выполнить командлет Enable-ExchangeCertificate, чтобы убедиться в том, что сертификат Exchange применен к службе единой системы обмена сообщениями:
  
```powershell
Enable-ExchangeCertificate -Server "atl-umserver-001.litwareinc.com" -Thumbprint "EA5A332496CC05DA69B75B66111C0F78A110D22d" -Services "SMTP","IIS","UM"
```

После корректного назначения сертификата необходимо остановить и перезапустить службу MsExchangeUM на сервере единой системы обмена сообщениями. Эту службу необходимо останавливать и запускать после каждого изменения режима запуска.
  
По завершении настройки сервера единой системы обмена сообщениями можно настроить маршрутизатор вызовов в единую систему обмена сообщениями:
  
```powershell
Set-UMCallRouterSettings -Server "atl-exchange-001.litwareinc.com" -UMStartupMode "Dual" -DialPlans "RedmondDialPlan" 
Enable-ExchangeCertificate -Server "atl-umserver-001.litwareinc.com" -Thumbprint "45BAA32496CC891169B75B9811320F78A1075DDA" -Services "IIS","UMCallRouter"
```

Поскольку режим запуска был изменен, необходимо остановить и перезапустить службу MsExchangeUMCR на том, компьютере, где размещен маршрутизатор вызовов в единую систему обмена сообщениями.
  
Для завершения настройки единой системы обмена сообщениями необходимо создать политику почтовых ящиков единой системы обмена мгновенными сообщениями, после чего использовать ее, чтобы разрешить пользователям работу с единой системой обмена сообщениями. Для создания политики почтовых ящиков можно использовать команду следующего вида:
  
```powershell
New-UMMailboxPolicy -Name "RedmondMailboxPolicy" -AllowedInCountryOrRegionGroups "Anywhere"
```

Чтобы разрешить пользователям работу с единой системой обмена сообщениями, можно также использовать команду следующего вида:
  
```powershell
Enable-UMMailbox -Extensions 100 -SIPResourceIdentifier "kenmyer@litwareinc.com" -Identity "litwareinc\kenmyer" -UMMailboxPolicy "RedmondMailboxPolicy"
```

В предыдущей команде параметр Extensions представляет добавочный номер телефона для пользователя. В этом примере добавочный номер пользователя — 100.
  
После активации почтового ящика пользователь kenmyer@litwareinc.com может работать с единой системой обмена сообщениями Exchange. Вы можете убедиться, что пользователь может подключаться к UM Exchange, выполнив командлет [Test-ксексумконнективити](https://docs.microsoft.com/powershell/module/skype/test-csexumconnectivity?view=skype-ps) в командной консоли управления Skype для бизнеса Server.
  
```powershell
$credential = Get-Credential "litwareinc\kenmyer"
Test-CsExUMConnectivity -TargetFqdn "atl-cs-001.litwareinc.com" -UserSipAddress "sip:kenmyer@litwareinc.com" -UserCredential $credential
```

При наличии второго пользователя, которому разрешена работа с единой системой обмена сообщениями, можно с помощью командлета [Test-CsExUMVoiceMail](https://docs.microsoft.com/powershell/module/skype/test-csexumvoicemail?view=skype-ps) проверить, может ли второй пользователь оставлять сообщения голосовой почты для первого пользователя.
  
```powershell
$credential = Get-Credential "litwareinc\pilar"
Test-CsExUMVoiceMail -TargetFqdn "atl-cs-001.litwareinc.com" -ReceiverSipAddress "sip:kenmyer@litwareinc.com" -SenderSipAddress "sip:pilar@litwareinc.com" -SenderCredential $credential
```



## <a name="configuring-unified-messaging-on-microsoft-exchange-server"></a>Настройка единой системы обмена сообщениями на сервере Microsoft Exchange 
> [!IMPORTANT]
> Если вы хотите использовать единую систему обмена сообщениями Exchange для обеспечения ответа на звонки, голосового доступа к Outlook или служб автоматического ассистента для пользователей корпоративной голосовой связи, читайте [план интеграции единой системы обмена сообщениями в Skype для бизнеса](../../plan-your-deployment/integrate-with-exchange/unified-messaging.md)и следуйте инструкциям в этом разделе. 

Чтобы настроить единую систему обмена сообщениями Exchange для работы с корпоративной голосовой связью, необходимо выполнить указанные ниже действия.

- Настройка сертификатов на сервере, на котором запущены службы единой системы обмена сообщениями Exchange
  > [!NOTE]
  > Добавляйте все серверы клиентского доступа и почтовых ящиков ко всем абонентам SIP URI для UM. Если нет, Маршрутизация исходящих вызовов не будет работать должным образом. 
- Создайте одну или несколько абонентов SIP с помощью URI для обмена сообщениями, а также с телефонными номерами абонентов, если это необходимо, а затем создайте соответствующие абонентские планы.

- С помощью сценария ексчукутил. ps1 вы можете:
    - Создание IP-шлюзов UM.
    - Создание групп слежения UM.
    - Предоставьте Skype для бизнеса Server разрешение на чтение объектов доменных служб Active Directory UM.
- Создайте объект автоматического ассистента UM.
- Создайте объект абонентского доступа.
- Создание универсального кода ресурса (URI) SIP для каждого пользователя и сопоставление пользователей с помощью абонентской группы SIP URI.

### <a name="requirements-and-recommendations"></a>Требования и рекомендации

Прежде чем приступить к работе, в документации в этом разделе предполагается, что вы развернули следующие роли Exchange: клиентский доступ и почтовый ящик. На сервере Microsoft Exchange служба единой системы обмена сообщениями Exchange работает в качестве службы на этих серверах.

Также обратите внимание на следующее:
- Если в нескольких лесах установлено приложение Exchange UM, для каждого леса UM необходимо выполнить инструкции интеграции с Exchange Server. Кроме того, каждый лес UM должен быть настроен для доверия к лесу, в котором развернута Skype для бизнеса Server, и лес в Вхичскипе для Business Server должен быть настроен для доверия к каждому лесу UM.
- Этапы интеграции выполняются как на ролях сервера Exchange, так и на серверах, на которых работает служба единой системы обмена сообщениями, а также на сервере, на котором установлен Skype для бизнеса Server. Перед выполнением шагов интеграции Lync Server 2013 необходимо выполнить инструкции интеграции с единой системой обмена сообщениями Exchange Server.
  > [!NOTE]
  > Чтобы узнать, какие действия по интеграции выполняются на каких серверах и на каких ролях администратора, ознакомьтесь со статьей [Общие сведения о процессе развертывания для интеграции локальной системы обработки сообщений и Skype для бизнеса](../../plan-your-deployment/integrate-with-exchange/deployment-overview.md). 

Следующие средства должны быть доступны на каждом сервере, на котором запущена служба единой системы обмена сообщениями Exchange.
- Консоль управления Exchange
- Сценарий ексчукутил. ps1, который выполняет следующие задачи:
    - Создание шлюза IP единой системы обмена сообщениями для каждого сервера Skype для бизнеса.
    - Создание группы слежения для каждого шлюза. Идентификатор пилотной программы для каждой из групп слежения указывает абонентскую группу UM SIP, используемую интерфейсным пулом или сервером Standard Edition, который связан с шлюзом.
    - Предоставление серверу Skype для бизнеса разрешения на чтение объектов единой системы обмена сообщениями Exchange в доменных службах Active Directory.



### <a name="configure-unified-messaging-on-microsoft-exchange-with-exchucutilps1"></a>Configure Unified Messaging on Microsoft Exchange with ExchUCUtil.ps1 

При интеграции Microsoft Skype для бизнеса Server с единой системой обмена сообщениями Exchange (UM) необходимо запустить сценарий Ексчукутил. ps1 в оболочке. Сценарий Ексчукутил. ps1 делает следующее:

- Создание шлюза IP единой системы обмена сообщениями для каждого пула серверов Skype для бизнеса.

> [!IMPORTANT]
> Сценарий Ексчукутил. ps1 создает один или несколько IP-шлюзов UM. Вы должны отключить исходящие вызовы для всех IP-шлюзов UM за исключением одного шлюза, созданного сценарием. Сюда входит отключение исходящих вызовов для IP-шлюзов UM, созданных до запуска сценария. 

- Создает группу слежения UM для каждого IP-шлюза UM. Идентификатор пилотной программы для каждой из групп слежения определяет абонентскую группу UM, которая используется в пуле интерфейсов SIP в Skype для бизнеса Server или стандартном сервере Standard Edition, связанном с IP-шлюзом UM.
- Предоставление доступа к Skype для бизнеса Server для чтения объектов контейнеров Active Directory UM, таких как абонентские группы единой системы обмена сообщениями, автосекретарей, IP-шлюзы UM и групп слежения UM.
  > [!IMPORTANT]
  > Каждый лес UM должен быть настроен для доверия к лесу, в котором развернута Skype для бизнеса Server, и в лесу, в котором развернута Skype для бизнеса Server 2013, необходимо настроить для доверия к каждому лесу UM. Если в нескольких лесах установлено приложение Exchange UM, для каждого из них необходимо выполнить интеграцию с Exchange Server, а также указать домен Skype для бизнеса Server. Например, Ексчукутил. ps1 — Forest: <Lync — Domain-Controller — FQDN>. 

### <a name="use-the-shell-to-run-the-exchucutilps1-script"></a>Использование оболочки для запуска сценария Ексчукутил. ps1

Запустите сценарий Ексчукутил. ps1 на любом сервере Exchange в Организации, который находится в той же топологии, что и Skype для бизнеса Server. Вы можете запустить сценарий с сервера почтовых ящиков с помощью оболочки или запустить сценарий с помощью удаленного Windows PowerShell на сервере клиентского доступа. Если сценарий запускается на сервере клиентского доступа в вашей организации, сервер клиентского доступа будет прокси-сервером для удаленного сеанса Windows PowerShell на сервере почтовых ящиков в Организации.
> [!IMPORTANT]
> Сценарий Ексчукутил. ps1 создает один или несколько IP-шлюзов UM. Вы должны отключить исходящие вызовы для всех IP-шлюзов UM за исключением одного шлюза, созданного сценарием. Сюда входит отключение исходящих вызовов для IP-шлюзов UM, созданных до запуска сценария. Чтобы отключить исходящие вызовы для IP-шлюза UM, ознакомьтесь со сведениями отключение исходящих вызовов для IP-шлюзов UM. 
> [!IMPORTANT]
> Чтобы запустить сценарий, необходимо иметь разрешения роли управления организацией Exchange или быть членом группы безопасности администраторов организации Exchange. 

1. Откройте консоль управления Exchange.
2. В командной строке C:\Windows\System32 введите **букву \<компакт-диска>: \program филес\микрософт\ексчанже Server\V15\Scripts>. Ексчукутил. ps1**и нажмите клавишу ВВОД.

#### <a name="how-do-you-know-this-worked"></a>Как узнать, что это сработало?

Чтобы убедиться, что сценарий Ексчукутул. ps1 успешно завершился, выполните указанные ниже действия.
- С помощью командлета Get-Умипгатевай или ПОПЗ просмотрите новые созданные IP-шлюзы или шлюзы UM.
- Используйте командлет Get-Умхунтграуп или ПОПЗ для просмотра новой группы слежения UM или групп, которые были созданы.

### <a name="configure-certificates-on-the-server-running-exchange-server-unified-messaging"></a>Настройка сертификатов на сервере, на котором работает единая система обмена сообщениями Exchange Server
 
Если вы развернули единую систему обмена сообщениями Exchange (UM) в соответствии с инструкциями по планированию интеграции единой системы обмена сообщениями в Skype для бизнеса Server в документации по планированию, и хотите предоставить вам возможности Exchange UM для пользователей корпоративной голосовой связи в вашей учетной записи Организации, для настройки сертификата на сервере, на котором запущено приложение Exchange UM, можно использовать описанные ниже процедуры.

> [!IMPORTANT]
> Для внутренних сертификатов оба сервера, на которых работает Skype для бизнеса Server и серверы Microsoft Exchange, должны иметь Доверенные корневые центры сертификации, которые являются взаимно доверенными. Центр сертификации (ЦС) может быть либо тем же, либо другим центром сертификации, если корневой сертификат центра сертификации зарегистрирован в хранилище сертификатов доверенного корневого центра. 

Для подключения к Skype для бизнеса Server необходимо настроить сервер Exchange с сертификатом сервера.
1. Скачайте сертификат ЦС для сервера Exchange.
2. Установите сертификат ЦС для сервера Exchange.
3. Убедитесь, что центр сертификации входит в список доверенных корневых ЦС сервера Exchange.
4. Создайте запрос на сертификат для сервера Exchange и установите сертификат. 
5. Назначьте сертификат для сервера Exchange.


**Чтобы загрузить сертификат ЦС, выполните указанные ниже действия.**

1. На сервере с Exchange UM нажмите кнопку **Пуск**, выберите команду **выполнить**, введите **http://\<имя сервера центра сертификации>/certsrv**и нажмите кнопку **ОК**.
2. В разделе Выберите задачу нажмите **загрузить сертификат ЦС, цепочку сертификатов или CRL**.
3. В разделе **Загрузка сертификата ЦС, цепочки сертификатов или CRL**выберите **метод кодирования для базового 64**, а затем нажмите кнопку**загрузить сертификат ЦС**.
   > [!NOTE]
   > Вы также можете задать кодировку DER (правила кодирования) на этом этапе. Если вы выбрали кодировку DER, тип файла на следующем этапе и на этапе 10 **для установки сертификата ЦС** —. p7b, а не. cer. 
4. В диалоговом окне **Загрузка файла** нажмите кнопку **сохранить**, а затем сохраните файл на жестком диске сервера. (В зависимости от кодировки, выбранной на предыдущем шаге, файл будет содержать расширение. cer или. p7b.)

**Чтобы установить сертификат ЦС, выполните указанные ниже действия.**

1. На сервере с Exchange UM откройте консоль управления (MMC), нажав кнопку **Пуск**, выберите команду **выполнить**, введите в поле Открыть значение **MMC** и нажмите кнопку **ОК**.
2. В меню **файл** выберите команду **Добавить или удалить оснастку**, а затем нажмите кнопку **добавить**.
3. В диалоговом окне **Добавление изолированных оснасток** выберите пункт **Сертификаты**и нажмите кнопку **добавить**.
4. В диалоговом окне **Оснастка диспетчера сертификатов** выберите **Учетная запись компьютера** и затем нажмите кнопку **Далее**.
5. В диалоговом окне **Выбор компьютера** убедитесь, что на **локальном компьютере установлен флажок (компьютер, на котором запущена эта консоль)** , и нажмите кнопку **Готово**.
6. Нажмите кнопку **Закрыть**, а затем — кнопку **ОК**. 
7. В дереве консоли разверните узел **Сертификаты (локальный компьютер)**, а затем разверните узел **Доверенные корневые центры сертификации**и выберите пункт **Сертификаты**.
8. Щелкните правой кнопкой мыши пункт **Сертификаты**, выберите пункт **все задачи**и нажмите кнопку **Импорт**.
9. Нажмите кнопку **Далее**. 
10. Нажмите кнопку **Обзор** , чтобы найти файл, а затем нажмите кнопку **Далее**. (В зависимости от кодировки, выбранной на этапе 3 **для скачивания сертификата ЦС**, файл будет содержать расширение. cer или. p7b.
11. Нажмите кнопку **поместить все сертификаты** в следующее хранилище.
12. Нажмите кнопку **Обзор**и выберите пункт **Доверенные корневые центры сертификации**. 
13. Нажмите кнопку **Далее** , чтобы проверить настройки, а затем нажмите кнопку **Готово**. 


**Чтобы убедиться в том, что центр сертификации находится в списке доверенных корневых ЦС, выполните указанные ниже действия.**

1. На сервере, на котором запущена служба единой системы обмена сообщениями, в MMC разверните раздел Сертификаты (локальный компьютер), разверните узел Доверенные корневые центры сертификации и выберите пункт Сертификаты.
2. В области сведений убедитесь, что ваш центр сертификации входит в список доверенных центров сертификации.


