---
title: Развертывание SQL зеркального отражания для высокой доступности серверов в Skype для бизнеса Server 2015
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
audience: ITPro
ms.topic: quickstart
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.assetid: 70224520-b5c8-4940-a08e-7fb9b1adde8d
description: 'Чтобы иметь возможность развернуть SQL зеркальном отражании, серверы должны работать SQL Server 2008 R2. Эта версия должна работать на всех задействованных серверах: основном, зеркальном и на свидетеле. Подробные сведения см. в накопительном пакете обновления 9 для SQL Server 2008 Пакет обновления 1 .'
ms.openlocfilehash: 8a546f65d8ad5c701eea20fb2c9c3bf0e026ff1f
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49830559"
---
# <a name="deploy-sql-mirroring-for-back-end-server-high-availability-in-skype-for-business-server-2015"></a>Развертывание SQL зеркального отражания для высокой доступности серверов в Skype для бизнеса Server 2015


Чтобы иметь возможность развернуть SQL зеркальном отражании, серверы должны работать SQL Server 2008 R2. Эта версия должна работать на всех задействованных серверах: основном, зеркальном и на свидетеле. Подробные сведения см. в накопительном пакете [обновления 9 для SQL Server 2008 Пакет обновления 1](https://go.microsoft.com/fwlink/p/?linkid=3052&amp;kbid=2083921).

В целом, для настройки зеркального отображения SQL между двумя внутренними серверами с ресурсом-свидетелем требуется следующее:

- Версия сервера-SQL Server должна поддерживать SQL зеркальное отражение.

- На основном ресурсе, зеркальном ресурсе и ресурсе-свидетеле (если развертывается) должна быть установлена одна и та же версия SQL Server.

- На основном и зеркальном ресурсах должен быть установлен один и тот же выпуск SQL Server. На ресурсе-свидетеле может быть установлен другой выпуск.

Для SQL с точки зрения того, какие SQL версии поддерживаются для роли свидетеля, см. статью "Свидетель [зеркального поиска базы данных".](https://go.microsoft.com/fwlink/p/?LinkId=247345)

Построитель топологий используется для развертывания SQL зеркального отражания. В построитель топологий можно выбрать вариант зеркального создания баз данных, а построитель топологий настраивает зеркальное отражение (включая настройку свидетеля, если необходимо) при публикации топологии. Обратите внимание, что настройка или удаление свидетеля выполняется одновременно с настройкой или удалением зеркала. Отдельной команды для развертывания или удаления только свидетеля не существует.

Для настройки зеркального отображения серверов сначала нужно правильно настроить разрешения базы данных SQL. Подробные сведения см. в сведениях о том, как настроить учетные записи входа для зеркального зеркального управления базами данных или групп доступности [AlwaysOn (SQL Server).](https://go.microsoft.com/fwlink/p/?LinkId=268454)

При SQL зеркальном отражающих данных режим восстановления базы данных всегда устанавливается в режиме **полного,** что означает, что необходимо внимательно следить за размером журнала транзакций и регулярно восстанавливать их, чтобы избежать неиссякаемого места на диске на тыловых серверах. Частота резервного копирования журналов транзакций зависит от скорости роста журнала, которая, в свою очередь, зависит от транзакций базы данных, возникших в действиях пользователей в интерфейсном пуле. Рекомендуется определить, насколько ожидается увеличение журнала транзакций для рабочей нагрузки развертывания, чтобы можно было планировать соответствующим образом. В следующих статьях приводится дополнительная информация SQL резервного копирования и управления журналами:

- [Модели восстановления базы данных](https://go.microsoft.com/fwlink/p/?LinkId=268446)

- [Обзор резервного копирования](https://go.microsoft.com/fwlink/p/?LinkId=268449)

- [Журнал транзакций резервного копирования](https://go.microsoft.com/fwlink/p/?LinkId=268452)

При использовании зеркального отображения SQL топологию можно настроить при создании пулов или после их создания.

> [!IMPORTANT]
> Использование построитель топологий или cmdlets для SQL зеркального SQL поддерживается только в том случае, если основной, зеркальный и свидетельный (при желании) серверы принадлежат одному домену. Если необходимо настроить зеркальное отображение SQL для серверов в других доменах, см. документацию по SQL Server.

> [!IMPORTANT]
> При внесении изменений в отношения зеркального отображения серверных баз данных необходимо перезагрузить все серверы переднего плана в пуле. > для изменения зеркального отражания (например, изменения расположения зеркала) необходимо использовать построитель топологий, чтобы выполнить следующие три действия:

1. Удаление зеркального отображения со старого сервера-зеркала.

2. Добавление зеркального отображения на новый сервер-зеркало.

3. Публикация топологии.

> [!NOTE]
> Для записи зеркальных файлов необходимо создать обную папку, а службе, SQL Server и агенту SQL, необходим доступ на чтение и записи. Если служба SQL Server работает в контексте сетевой службы, вы можете добавить<\<Domain\> \\ SQLSERVERNAME $ как основного, так и зеркального сервера SQL к разрешениям для совместной \> работы. $важно определить, что это учетная запись компьютера.

## <a name="to-configure-sql-mirroring-while-creating-a-pool-in-topology-builder"></a>Настройка зеркального SQL при создании пула в построителье топологий

1. На странице **Определение хранилища SQL** щелкните **Создать** рядом с окном **Хранилище SQL**.

2. На странице **Определение нового хранилища SQL** укажите основное хранилище, выберите **Этот образец SQL связан зеркальным отображением**, укажите номер порта для зеркального отображения SQL (по умолчанию — 5022), а затем щелкните **ОК**.

3. Вернитесь на страницу **Определение хранилища SQL** и выберите **Включить зеркальное отображение хранилища SQL**.

4. На странице **Определение нового хранилища SQL** укажите хранилище SQL, которое будет использоваться в качестве зеркала. Выберите **Этот образец SQL связан зеркальным отображением**, укажите номер порта (по умолчанию — 5022), а затем щелкните **ОК**.

5. Если необходимо использовать ресурс-свидетель для этого зеркала, выполните следующие действия:

    а. Выберите **Использовать ресурс-свидетель зеркального отображения SQL для включения автоматического переключения**.

    б. На странице **Определение хранилища SQL** выберите **Использовать ресурс-свидетель зеркального отображения SQL для включения автоматического переключения** и укажите хранилище SQL для использования в качестве ресурса-свидетеля.

    c. Укажите номер порта (по умолчанию — 7022) и щелкните **ОК**.

6. После определения пула переднего плана и всех остальных ролей в топологии используйте построитель топологий для публикации топологии. При публикации топологии, если в пуле переднего SQL центрального хранилище управления включено зеркальное SQL баз данных.

    Щелкните **Настройки** и введите путь, который необходимо использовать в качестве пути к файловому ресурсу общего доступа для резервной копии зеркального отображения.

    Щелкните **ОК**, а затем щелкните **Далее** для создания баз данных и публикации топологии. Будут развернуты ресурс-зеркало и ресурс-свидетель (если указано).

Построитель топологий можно использовать для изменения свойств существующего пула, чтобы включить SQL зеркальное отражение.

## <a name="to-add-sql-mirroring-to-an-existing-front-end-pool-in-topology-builder"></a>Добавление зеркального SQL в существующий пул переднего входа в построитель топологий

1. В построитель топологий щелкните пул правой кнопкой мыши и выберите **"Изменить свойства".**

2. Выберите **Включить зеркальное отображение хранилища SQL**, а затем щелкните **Создать** рядом с элементом **Зеркальное отображение хранилища SQL**.

3. Укажите хранилище SQL, которое необходимо использовать в качестве зеркала.

4. Выберите **Этот образец SQL связан зеркальным отображением**, укажите номер порта зеркального отображения SQL (порт по умолчанию — 5022), а затем щелкните **ОК**.

5. Если необходимо настроить ресурс-свидетель, выберите **Использовать ресурс-свидетель зеркального отображения SQL для включения автоматического переключения** и щелкните **Создать**.

6. Укажите хранилище SQL, которое необходимо использовать в качестве свидетеля.

7. Выберите **Этот образец SQL связан зеркальным отображением**, укажите номер порта зеркального отображения SQL (порт по умолчанию — 7022), а затем щелкните **ОК**.

8. Щелкните **ОК**.

9. Опубликуйте топологию. После этого появится запрос на установку базы данных.

    В процессе публикации топологии вам будет предложено определить путь к файловой папке. Серверы SQL, которые участвуют в зеркальном отражающих данных, должны иметь доступ на чтение и записи к этой файловой папке, чтобы было установлено зеркальное.

Затем перед переходом к следующей процедуре необходимо установить базу данных.

При настройке зеркального отображения сервера SQL Server следует иметь в виду следующее:

- Если конечная точка зеркального отображения уже существует, она будет повторно использоваться с подключением по указанным портам, а порты, определенные в топологии, будут игнорироваться.

- Любой порт, уже выделенный для других приложений на том же сервере, включая порты для других экземпляров SQL, не должен использоваться для доступных установленных экземпляров SQL. Это означает, что при наличии нескольких экземпляров SQL Server, установленных на одном и том же сервере, они не должны использовать один и тот же порт для зеркального отображения. Для получения подробной информации см. следующие статьи:

  - [Указание сетевого адреса сервера (зеркальное отражение базы данных)](https://go.microsoft.com/fwlink/p/?LinkId=247346)

  - [Конечная точка зеркального зеркального SQL Server)](https://go.microsoft.com/fwlink/p/?LinkId=247347)

## <a name="using-skype-for-business-server-2015-management-shell-cmdlets-to-set-up-sql-mirroring"></a>Using Skype for Business Server 2015 Management Shell Cmdlets to Set Up SQL Mirroring

Проще всего настроить зеркальное отражение с помощью построитель топологий, но это также можно сделать с помощью cmdlets.

1. Откройте окно оболочки управления Skype для бизнеса Server 2015 и запустите следующий cmdlet:

   ```powershell
   Install-CsMirrorDatabase [-ConfiguredDatabases] [-ForInstance] [-ForDefaultInstance] [-DatabaseType <Application | Archiving | CentralMgmt | Monitoring | User | BIStaging | PersistentChat | PersistentChatCompliance >] -FileShare <fileshare> -SqlServerFqdn <primarySqlserverFqdn> [-SqlInstanceName] [-DatabasePathMap] [-ExcludeDatabaseList] [-DropExistingDatabasesOnMirror] -Verbose
   ```

    Например:

   ```powershell
   Install-CsMirrorDatabase -ConfiguredDatabases -FileShare \\PRIMARYBE\csdatabackup -SqlServerFqdn primaryBE.contoso.com -DropExistingDatabasesOnMirror -Verbose
   ```

    Отобразится следующее:

   <pre>
   Database Name:rtcxds
        Data File:D:\CsData\BackendStore\rtc\DbPath\rtcxds.mdf
         Log File:D:\CsData\BackendStore\rtc\LogPath\rtcxds.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:rtcshared
        Data File:D:\CsData\BackendStore\rtc\DbPath\rtcshared.mdf
         Log File:D:\CsData\BackendStore\rtc\LogPath\rtcshared.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:rtcab
        Data File:D:\CsData\ABSStore\rtc\DbPath\rtcab.mdf
         Log File:D:\CsData\ABSStore\rtc\LogPath\rtcab.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:rgsconfig
        Data File:D:\CsData\ApplicationStore\rtc\DbPath\rgsconfig.mdf
         Log File:D:\CsData\ApplicationStore\rtc\LogPath\rgsconfig.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:rgsdyn
        Data File:D:\CsData\ApplicationStore\rtc\DbPath\rgsdyn.mdf
         Log File:D:\CsData\ApplicationStore\rtc\LogPath\rgsdyn.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:cpsdyn
        Data File:D:\CsData\ApplicationStore\rtc\DbPath\cpsdyn.mdf
         Log File:D:\CsData\ApplicationStore\rtc\LogPath\cpsdyn.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:xds
        Data File:D:\CsData\CentralMgmtStore\rtc\DbPath\xds.mdf
         Log File:D:\CsData\CentralMgmtStore\rtc\LogPath\xds.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
    Database Name:lis
        Data File:D:\CsData\CentralMgmtStore\rtc\DbPath\lis.mdf
         Log File:D:\CsData\CentralMgmtStore\rtc\LogPath\lis.ldf
      Primary SQL: e04-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\e04-ocs$
       Mirror SQL: K16-ocs.los_a.lsipt.local\rtc
          Account: LOS_A\K16-ocs$
     Witness SQL : AB14-lct.los_a.lsipt.local\rtc
          Account: LOS_A\AB14-lct$
   [Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "Y"):
   </pre>

2. Проверьте следующее:

    - Порт 5022 доступен через брандмауэр, если брандмауэр Windows включен на основном ресурсе SQL Server e04-ocs.los_a.lsipt.local\rtc.

    - Порт 5022 доступен через брандмауэр, если брандмауэр Windows включен на зеркальном ресурсе SQL Server K16-ocs.los_a.lsipt.local\rtc.

    - Порт 7022 доступен через брандмауэр, если брандмауэр Windows включен на ресурсе-свидетеле SQL Server AB14-lct.los_a.lsipt.local\rtc.

   - Учетные записи, SQL-серверы на всех основных и зеркальных серверах SQL имеют разрешение на чтение и запись для файлового сервера \\ E04-OCS\csdatabackup

   - Убедитесь, что поставщик инструментария управления Windows (WMI) работает на всех этих серверах. Командлет использует этого поставщика для поиска информации об учетных записях для служб SQL Server, которые выполняются на всех основных, зеркальных серверах и серверах-свидетелях.

   - Убедитесь, что учетная запись, выполняющая этот командлет, имеет право на создание папок для данных и файлов журналов для всех зеркальных серверов.

   - Обратите внимание, что учетная запись пользователя, применяемая экземпляром SQL для запуска, должна обладать разрешениями на чтение и запись для файлового ресурса. Если ресурс размещен на другом сервере, экземпляр SQL использует локальную системную учетную запись, вы должны предоставить разрешения для файлового ресурса серверу, на котором размещен экземпляр SQL.

3. Введите A и нажмите клавишу ВВОД.

    Зеркальное отображение будет настроено.

    **Install-CsMirrorDatabase** устанавливает зеркальное отражение и настраивает зеркальное отражение для всех баз данных, присутствующих в основном SQL хранилище. Если требуется настроить зеркальное отражение только для определенных баз данных, можно использовать параметр -DatabaseType или настроить зеркальное отражение для всех баз данных, кроме нескольких, можно использовать параметр -ExcludeDatabaseList вместе со списком разделенных запятой имен баз данных, которые необходимо исключить.

    Например, если вы добавили в **Install-CsMirrorDatabase** следующую функцию, будет выполнено зеркальное отображение всех баз данных, кроме rtcxds.

    `-ExcludeDatabaseList rtcab,rtcxds`

   Например, если вы добавили в **Install-CsMirrorDatabase**, следующую функцию, будет выполнено зеркальное отображение баз данных rtcab, rtcshared и rtcxds.

    `-DatabaseType User`

## <a name="removing-or-changing-sql-mirroring"></a>Удаление и изменение зеркального отображения SQL

Чтобы удалить зеркальное отображение SQL пула в построителе топологий, сначала следует использовать командлет для удаления зеркала в SQL Server. Затем вы можете использовать построитель топологий, чтобы удалить зеркало из топологии. Чтобы сделать это в SQL Server, запустите следующий командлет:

```powershell
Uninstall-CsMirrorDatabase -SqlServerFqdn <SQLServer FQDN> [-SqlInstanceName <SQLServer instance name>] -DatabaseType <Application | Archiving | CentralMgmt | Monitoring | User | BIStaging | PersistentChat | PersistentChatCompliance> [-DropExistingDatabasesOnMirror] [-Verbose]
```

Например, чтобы удалить зеркальное отображение и сбросить базы данных для баз данных User, введите следующую команду:

```powershell
Uninstall-CsMirrorDatabase -SqlServerFqdn primaryBE.contoso.com -SqlInstanceName rtc -Verbose -DatabaseType User -DropExistingDatabasesOnMirror
```

При этом затронутые базы данных удаляются  `-DropExistingDatabasesOnMirror` из зеркала.

Затем чтобы удалить зеркало из топологии, выполните следующие действия:

1. В построителе топологии щелкните пул правой кнопкой мыши и щелкните **Изменить свойства**.

2. Снимите флажок **Включить зеркальное отображение хранилища SQL** и щелкните **ОК**.

3. Опубликуйте топологию.

## <a name="removing-a-mirroring-witness"></a>Удаление следящего сервера зеркального отображения

Используйте эту процедуру, если необходимо удалить свидетель из конфигурации зеркального зеркального отражания на тыловом сервере.

1. В построителе топологии щелкните пул правой кнопкой мыши и щелкните **Изменить свойства**.

2. Снимите флажок **Использовать свидетель зеркального отображения SQL Server для автоматического перехода на другой ресурс** и нажмите **ОК**.

3. Опубликуйте топологию.

    После публикации топологии построитель топологий отображет следующее сообщение:

   ```console
   Run the Uninstall-CsMirrorDatabase cmdlet to remove databases that are paired with following primary databases.
   ```

    Однако не следуйте этому шагу и не введите, так как это позволит удалить всю  `Uninstall-CsMirrorDatabase` конфигурацию зеркального зеркального отражания.

4. Чтобы удалить только свидетель из конфигурации SQL Server, выполните инструкции, которые см. в этой [SQL Server.](https://go.microsoft.com/fwlink/p/?LinkId=268456)


