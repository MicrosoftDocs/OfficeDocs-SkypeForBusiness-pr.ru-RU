---
title: Подготовка устройства Cloud Connector
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 2/15/2018
audience: ITPro
ms.topic: conceptual
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection:
- Strat_SB_Hybrid
ms.custom: ''
ms.assetid: 6eacfa99-9759-4c13-aca3-8992c2ff2710
description: Сведения о том, как подготовить ваше устройство Cloud Connector к развертыванию и использованию с телефонной системой в Office 365 (облачная УАТС).
ms.openlocfilehash: 6dbbc7eb1639859f889d6674e9f000507912d35a
ms.sourcegitcommit: 88a16c09dd91229e1a8c156445eb3c360c942978
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/14/2020
ms.locfileid: "41983844"
---
# <a name="prepare-your-cloud-connector-appliance"></a>Подготовка устройства Cloud Connector

Сведения о том, как подготовить ваше устройство Cloud Connector к развертыванию и использованию с телефонной системой в Office 365 (облачная УАТС).

В этом разделе описывается, как получить установочные файлы Skype для бизнеса Cloud Connector Edition, установить программное обеспечение Cloud Connector и подготовить ваше устройство Cloud Connector к развертыванию. После выполнения всех действий, описанных в этом разделе, вы будете готовы к развертыванию Cloud Connector для одного или нескольких сайтов. Если у вас есть развертывание Cloud Connector и вы еще не выполнили обновление до Cloud Connector версии 2,1, ознакомьтесь со статьей [обновление до новой версии Cloud Connector](upgrade-to-a-new-version-of-cloud-connector.md).

> [!NOTE]
> Корпорация Майкрософт поддерживает текущую версию Cloud Connector Edition версии 2,1. Если вы настроили автоматическое обновление, Cloud Connector обновится автоматически. Если вы настроили обновление вручную, вам потребуется выполнить обновление до версии 2,1 в течение 60 дней с момента ее выпуска. Корпорация Майкрософт будет поддерживать предыдущую версию в течение 60 дней после выпуска 2,1, чтобы разрешить время обновления. 

> [!NOTE]
> Для Cloud Connector версии 2,1 и более поздних версий на ведущем устройстве должно быть установлено приложение .NET Framework 4.6.1 или более поздней версии. 

> [!IMPORTANT]
> При успешном развертывании при запуске командлетов для настройки Skype для бизнеса Cloud Connector Edition всегда используйте тот же сеанс консоли, что и в начале работы. Не следует переключаться на другие сеансы во время развертывания и настройки. 

> [!NOTE]
> Существует несколько действий, которые можно выполнить только для первого устройства в развертывании: создание общего ресурса для каталога сайтов, Загрузка BITS и подготовка файла виртуального жесткого диска (VHDX) из образа Windows Server ISO. 

## <a name="download-the-skype-for-business-cloud-connector-edition-installer"></a>Загрузка установщика Skype для бизнеса Cloud Connector Edition

1. Скачайте файлы установки на сервер узла, на котором будут запускаться виртуальные машины Cloud Connector: [https://aka.ms/CloudConnectorInstaller](https://aka.ms/CloudConnectorInstaller). 

    > [!IMPORTANT]
    > Во время установки Cloud Connector сервер узла должен иметь доступ к Интернету, так как во время установки будут загружены дополнительные файлы. 

2. Запустите установщик и примите значения по умолчанию во время установки.

3. Убедитесь, что установка успешно завершена.

## <a name="verify-the-installation-and-configure-the-environment"></a>Проверка установки и настройка среды

1. Откройте консоль PowerShell от имени администратора и убедитесь, что командлеты Skype для бизнеса Cloud Connector Edition доступны, используя следующий командлет:

   ```powershell
   Get-Command *-Cc*
   ```

    Команда должна вернуть список командлетов Skype для бизнеса Cloud Connector Edition.

2. Файлы VHD, SfBBits и VersionInfo будут храниться в **каталоге сайтов**.

    Расположение **каталога сайтов** можно найти с помощью следующего командлета:

   ```powershell
   Get-CcSiteDirectory
   ```

    Команда должна вернуть расположение в файловой системе. Расположением может быть локальная папка или файловый ресурс. Расположение по умолчанию для **каталога сайтов** :%UserProfile%\CloudConnector\SiteRoot. Расположение по умолчанию должно быть заменено на общую папку на первом устройстве, созданном на каждом сайте.

    Необходимо выбрать следующее расположение:

   - Создается на первом устройстве, созданном на каждом сайте.

   - Общая папка, доступная другим серверам узлов (устройствам) на том же сайте.

     Чтобы задать для **каталога сайтов** расположение, отличное от используемого по умолчанию, выполните следующий командлет:

   ```powershell
   Set-CcSiteDirectory <UNC File path>
   ```

    При развертывании высокого уровня доступности для сайта обязательно выполните командлет, чтобы задать для **каталога сайтов** одно и то же расположение на каждом сервере узла в пределах сайта.

    При входе в систему и развертывании каждого устройства на сайте убедитесь, что текущая учетная запись входа имеет право доступа к **каталогу сайта**.

3. **Каталог Appliance** является локальным рабочим корневым каталогом для Skype для бизнеса Cloud Connector Edition и расположением, в котором сохраняются внешние сертификаты, экземпляры и журналы. Расположение по умолчанию:%Усерпрофиле%\клаудконнектор\апплианцерут.

    Чтобы найти расположение **каталога устройств**, выполните следующий командлет:

   ```powershell
   Get-CcApplianceDirectory
   ```

    Чтобы задать для **каталога устройств** расположение, отличное от используемого по умолчанию, выполните следующий командлет:

   ```powershell
   Set-CcApplianceDirectory <File path>
   ```

    Для каталога устройства должна быть задана локальная папка на устройстве. **Каталог устройств** необходимо задать только перед запуском развертывания Skype для бизнеса Cloud Connector Edition. Если вы измените его после развертывания, вам потребуется повторно развернуть сервер узла.

    > [!IMPORTANT]
    > Путь к **каталогу устройств** не должен содержать пробелов.

## <a name="set-the-path-for-the-external-edge-certificate"></a>Задание пути для внешнего пограничного сертификата

- Выполните следующий командлет, чтобы задать путь, включая имя файла, к внешнему пограничному сертификату. Пример: C:\certs\cce\ap.contoso.com.pfx. Сертификат должен содержать закрытые ключи.

  ```powershell
  Set-CcExternalCertificateFilePath -Path <Full path to External certificate, including file name> -Target EdgeServer
  ```

    > [!NOTE]
    > Обратите внимание, что параметр-target относится только к версиям 1.4.2 и более поздним версиям. 

    Укажите полный путь к внешнему сертификату, включая имя файла. Сертификат может храниться локально или на общем файловом ресурсе. Если сертификат хранится в общей папке, Общая папка должна быть создана на первом устройстве каждого сайта и должна быть доступна другим устройствам, принадлежащим к тому же сайту. Этот командлет копирует внешний сертификат в **каталог устройства**.

    > [!IMPORTANT]
    > **Если вы обновили версию Cloud Connector версии 1.4.2 или более поздней**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи и цепочку сертификатов, включая сертификат КОРНЕВОГО центра сертификации и сертификаты ПРОМЕЖУТОЧНОГО центра сертификации. **Если вы еще не обновили версию Cloud Connector версии 1.4.2**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи. Этот внешний сертификат должен быть выдан центром сертификации, который по умолчанию является доверенным для Windows.

## <a name="set-the-path-for-the-external-pstn-gatewaysbc-certificate"></a>Задайте путь к внешнему сертификату шлюза PSTN/SBC

Если вы используете протокол TLS между сервером-посредником и шлюзом PSTN/SBC, выполните следующий командлет, чтобы задать путь, включая имя файла, к сертификату шлюза. Пример: К:\цертс\кце\сбк.Контосо.ком.цер. Сертификат должен содержать корневой центр сертификации и промежуточную цепь для сертификата, назначенного шлюзу:

```powershell
Set-CcExternalCertificateFilePath -Path <Full path to gateway certificate, including file name> -Target MediationServer 
```

> [!NOTE]
> Обратите внимание, что параметр-target относится только к версиям 1.4.2 и более поздним версиям. 

## <a name="create-virtual-switches-in-hyper-v-manager"></a>Создание виртуальных коммутаторов в диспетчере Hyper – V

1. Откройте**Диспетчер виртуальных коммутаторов** **Hyper – V** > и выберите команду **создать диспетчер виртуальных коммутаторов**.

2. Создайте внешний виртуальный коммутатор и привяжите его к физическому сетевому адаптеру, подключенному к домену внутренней сети:

    Выберите **разрешить операционной системе управления общий доступ к этому сетевому адаптеру** для этого виртуального коммутатора.

3. Создайте внешний виртуальный коммутатор и привяжите его к физическому сетевому адаптеру, который пересылается в Интернет:

    Снимите флажок **Разрешить управление операционной системой, чтобы предоставить общий доступ к этому сетевому адаптеру** для этого виртуального коммутатора.

4. Задайте имя коммутатора, который подключает сеть периметра к домену внутренней сети **SFB CCE**.

    Задайте имя коммутатора, который подключает сеть периметра к **коммутатору Интернета SFB CCE Internet**.

## <a name="update-the-cloudconnectorini-configuration-file"></a>Обновление файла конфигурации CloudConnector. ini

Подготовьте файл CloudConnector. ini, используя сведения, собранные в разделе [Определение параметров развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе [Plan for Skype for Business Cloud Connector Edition](plan-skype-for-business-cloud-connector-edition.md) .

Чтобы обновить файл, сначала выполните следующий командлет, чтобы получить пример шаблона (CloudConnector. Sample. ini):

```powershell
Export-CcConfigurationSampleFile
```

Пример шаблона хранится в **каталоге устройств**.

После того как вы обновите их значениями для вашей среды, сохраните файл как CloudConnector. ini в **каталоге устройств**. Командлет **Get – CcApplianceDirectory** можно использовать, чтобы определить путь к **каталогу устройств**.

При обновлении ini-файла учитывайте следующие возможности.

> [!NOTE]
> В этом разделе рассматриваются не все значения для ini-файла, в данном разделе рассматриваются только те, которые связаны с особыми аспектами. Полный список представлен в разделе [Определение параметров развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) раздела [Plan for Skype for Business Cloud Connector Edition](plan-skype-for-business-cloud-connector-edition.md) . Для получения дополнительных сведений о том, какие значения необходимо изменить для дополнительных устройств или новых сайтов, ознакомьтесь с разделом [один сайт с высокой доступностью (HA) по сравнению с развертыванием](deploy-multiple-sites-in-cloud-connector.md#BKMK_SingleSitecomparedtomulti-site) нескольких сайтов в разделе [развертывание нескольких сайтов в Cloud Connector](deploy-multiple-sites-in-cloud-connector.md). 

- **SiteName:** Значение по умолчанию — **site1**. Перед развертыванием Cloud Connector необходимо обновить его, так как при запуске **Register-CcAppliance** для регистрации устройства на существующем или новом сайте командлет будет использовать **SiteName** , чтобы определить, какой сайт нужно зарегистрировать.

     Если вы хотите зарегистрировать устройство на новом сайте, значение **SiteName** должно быть уникальным и отличаться от существующих сайтов. Если вы хотите зарегистрировать устройство на существующем сайте, значение **SiteName** в ini-файле должно быть соответствующим имени, определенному в конфигурации клиента Office 365. При копировании файла конфигурации с одного сайта на другой необходимо соответствующим образом обновить значение **SiteName** для каждого сайта.

- **ServerName:** Имя сервера не должно содержать имя домена и должно содержать не более 15 символов.

- **Хардваретипе:** Если вы не задаете или не оставляете значение null, будет использоваться значение по умолчанию **Normal** . Используйте параметр **Normal** , если планируется развертывание более крупной версии Cloud Connector для поддержки 500 одновременных вызовов на хост-компьютере, как описано в статье [Plan for Skype for Business Cloud Connector Edition](plan-skype-for-business-cloud-connector-edition.md). Используйте **минимум** для развертывания меньшего размера, поддерживающего одновременные вызовы 50.

- **Виртуальные коммутаторы Интернета/корпоративной сети/управления:**: добавьте имя созданных виртуальных коммутаторов. В качестве виртуального коммутатора управления оставьте значение по умолчанию. Сценарий развертывания создаст виртуальный коммутатор управления в начале развертывания и удалит его после завершения развертывания.

- **ManagementIPPrefix:** ManagementIPPrefix в разделе Network должен быть другой подсетью с другими внутренними IP-адресами. Например, в качестве значения по умолчанию отображается ManagementIPPrefix 192.168.213.0, в то время как AD IPAddress — 192.168.0.238.

    Сценарии развертывания создают сетевой адаптер управления на каждой виртуальной машине, назначают IP-адрес управления и подключают его к виртуальному коммутатору управления. Это позволяет ведущему серверу подключаться к виртуальным машинам и управлять ими через эту сеть управления. Виртуальный коммутатор управления удаляется после завершения развертывания.

- **Конфигурации базовых ВМ:** Параметры в этом разделе необходимо настроить для командлета **Convert – CcIsoToVhdx** .

    Во время подготовки образа базовой ВИРТУАЛЬНОЙ машины базовая виртуальная машина будет подключена к коммутатору внутренней сети. Чтобы виртуальная машина могла получить доступ к Интернету, необходимы следующие параметры:

  - Общую Басевмип: IP-адрес в корпоративной сети, назначаемый основной виртуальной машине.

  - Сетью Корпнетдефаултгатевай: шлюз по умолчанию, назначаемый основной виртуальной машине.

  - Сетью CorpnetDNSIPAddress: IP-адрес DNS, назначаемый основной виртуальной машине.

  - Сетью Всуссервер: IP-адрес службы обновления Windows Server.

  - Сетью Всусстатуссервер: IP-адрес сервера состояния службы обновления Windows Server.

  - Сетью EnableReferSupport: этот параметр определяет, включена ли поддержка SIP или отключена в конфигурации магистрали для IP/УАТС.

- **Внутренние IP-адреса:**

  - Убедитесь, что CorpnetIPPrefixLength маска подсети правильная.

  - Убедитесь в отсутствии конфликтов IP-адресов для этих внутренних IP-адресов.

- **Внешние IP-адреса:**

  - Для общедоступного IP-адреса MR: укажите либо ExternalMRIPs для не-NAT, либо ExternalMRPublicIPs для NAT.

  - Екстерналсипипс и ExternalMRIPs могут быть одинаковыми.

  - Убедитесь, что Интернетиппрефиксленгс маска подсети правильная.

  - Убедитесь в отсутствии конфликтов IP-адресов для этих внешних IP-адресов.

- **Шлюзы**

  - Если у вас только один шлюз, удалите раздел для дополнительного шлюза. Если у вас больше двух шлюзов, создайте дополнительные разделы, скопировав и вставив существующий, а затем обновив его.

  - Убедитесь, что IP-адрес и порт шлюза (-ов) указаны правильно.

  - Для поддержки высокой доступности шлюза PSTN оставьте дополнительный шлюз и добавьте любые дополнительные шлюзы, которые будут использоваться. Вы можете скопировать и вставить существующую запись, а затем обновить ее.

- При необходимости вы можете изменить значение LocalRoute, чтобы ограничить номера исходящих вызовов.

## <a name="download-the-bits-to-the-site-directory"></a>Загрузка BITS в каталог сайтов

Выполните следующий командлет, чтобы скачать файлы сведений о битах и версии в **Каталог сайтов**:

```powershell
Start-CcDownload
```

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

## <a name="prepare-base-virtual-disk-vhdx-from-the-downloaded-iso-file"></a>Подготовка базового виртуального диска (VHDX) из загруженного ISO-файла

На этом этапе подготавливается файл виртуального жесткого диска (VHDX) из ISO-образа Windows Server 2012. VHDX будет использоваться для создания виртуальных машин во время развертывания. Будет создана временная виртуальная машина (базовая ВИРТУАЛЬная машина), и Windows Server 2012 будет установлена из ISO-файла. После создания виртуальной машины будут установлены некоторые необходимые компоненты, и будет применено Последнее обновление Windows. В конце базовая виртуальная машина будет обобщена (Sysprep) и очищена, оставив только созданный файл виртуального диска.

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

Перед выполнением этого действия Убедитесь, что переключатель в корпоративной сети создан. Кроме того, убедитесь, что в файле CloudConnector. ini правильно настроены следующие параметры:

- Сетью CorpnetSwitchName

- Общую басевмип

- Сетью CorpnetIPPrefixLength

- Сетью корпнетдефаултгатевай

- Сетью CorpnetDNSIPAddress

Запустите консоль PowerShell от имени администратора и выполните следующий командлет, чтобы преобразовать образ ISO в виртуальный жесткий диск (VHD):

```powershell
Convert-CcIsoToVhdx -IsoFilePath <Windows ISO File Path, including file name>
```

Укажите полный путь, включая имя файла, к ISO-образу. Пример: C:\ISO\WindowsServer2012R2.iso.

Созданный VHD-файл хранится в папке \Битс\вхд **каталога сайтов** . Путь к **каталогу сайтов** можно получить с помощью команды **Get-CcSiteDirectory**.

> [!IMPORTANT]
> По умолчанию параметры прокси-сервера не настроены на основной виртуальной машине. Если в сетевой среде требуется прокси-сервер для обновления виртуальной машины с помощью центра обновления Windows, необходимо добавить параметр-PauseBeforeUpdate при выполнении "Convert-CcIsoToVhdx". Сценарий будет приостановлен до обновления Windows, и у вас будет возможность вручную настроить прокси-сервер на виртуальной машине. После настройки прокси-сервера и того, что виртуальная машина может получить доступ к Интернету, можно возобновить сценарий, чтобы выполнить оставшиеся действия. 

### <a name="create-vhds-for-a-multi-site-deployment"></a>Создание виртуальных жестких дисков для развертывания с несколькими сайтами

Это необязательный шаг, который применяется только для развертываний с несколькими сайтами.

При развертывании развертывания с несколькими сайтами не требуется преобразовывать ISO-файл в VHD для каждого сайта. Вы можете скопировать VHDX-файл, созданный для первого сайта, на сервер узла для второго сайта.

 Скопируйте файл в то же расположение ( **Каталог сайтов** \битс\вхд) и с тем же именем на сервер узла для дополнительного сайта.

## <a name="set-the-powershell-execution-policy-to-remotesigned"></a>Установка RemoteSigned для политики выполнения PowerShell

В сценариях PowerShell требуется, чтобы для политики выполнения было задано значение RemoteSigned. Чтобы просмотреть текущую настройку, откройте консоль PowerShell от имени администратора, а затем выполните следующий командлет:

```powershell
Get-ExecutionPolicy
```

Если для него не задано значение "RemoteSigned", выполните следующий командлет, чтобы изменить его:

```powershell
Set-ExecutionPolicy RemoteSigned
```

## <a name="change-local-group-policy-on-the-host-machine-versions-141-and-earlier"></a>Изменение локальной групповой политики на хост-компьютере (версии 1.4.1 и более ранних)

> [!NOTE]
> Эта задача не является обязательной для Cloud Connector Versions 1.4.2 и более поздних версий. 

Учетная запись CceService создается во время развертывания Skype для бизнеса Cloud Connector Edition. Он запускает службу управления Cloud Connector и требует разрешения на удаление cloudconnector. msi. Необходимо изменить параметр групповой политики на компьютере узла Cloud Connector, чтобы указать, что реестр пользователя не должен выгружаться при выходе пользователя из системы. Выполните указанные ниже действия.

### <a name="to-change-the-group-policy-setting"></a>Изменение параметра групповой политики

1. Откройте **редактор групповых политик** , выполнив gpedit. msc.

2. В **редакторе групповой политики**перейдите к разделу административные шаблоны > системе > UserProfile > не выгружать реестр пользователя при выходе пользователя из системы. 

3. Присвойте его значению **Enabled**.

## <a name="set-up-your-office-365-tenant"></a>Настройка клиента Office 365

Клиент Office 365 с Skype для бизнеса Online и телефонной системой в Office 365 является обязательным. Перед попыткой использовать Cloud Connector убедитесь, что клиент настроен и настроен.

Некоторые действия по установке Office 365 требуют использования удаленной оболочки клиента (TRPS) для настройки клиента Office 365. **Этот параметр должен быть установлен на сервере узла.** Вы можете скачать модуль Skype для бизнеса Online для PowerShell из: [Skype для бизнеса Online, модуль Windows PowerShell](https://www.microsoft.com/download/details.aspx?id=39366).

Создайте выделенную учетную запись администратора Skype для бизнеса для управления Cloud Connector Online, например CceOnlineManagmentAdministrator. Эта учетная запись будет использоваться устройством для добавления или удаления устройства, включения или отключения автоматического обновления ОС, включения или отключения автоматического двоичного обновления. Задайте для пароля для этой учетной записи срок действия не ограничен, чтобы не изменять его для службы каждый раз, когда она истечет.


