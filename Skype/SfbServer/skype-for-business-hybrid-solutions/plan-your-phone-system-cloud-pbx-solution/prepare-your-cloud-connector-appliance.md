---
title: Подготовка устройства Cloud Connector
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 2/15/2018
ms.audience: ITPro
ms.topic: conceptual
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.collection:
- Strat_SB_Hybrid
ms.custom: ''
ms.assetid: 6eacfa99-9759-4c13-aca3-8992c2ff2710
description: Узнайте о сведения о подготовке устройства облачных соединитель для развертывания и использования с телефонной системой в Office 365 (облако УАТС).
ms.openlocfilehash: 3716c7c4b9d4b8daa0a4995ed7e3d77b400b587f
ms.sourcegitcommit: da8c037bb30abf5d5cf3b60d4b71e3a10e553402
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/27/2019
ms.locfileid: "30887318"
---
# <a name="prepare-your-cloud-connector-appliance"></a>Подготовка устройства Cloud Connector

Узнайте о сведения о подготовке устройства облачных соединитель для развертывания и использования с телефонной системой в Office 365 (облако УАТС).

В этом разделе описывается, как получить файлы установки Skype для бизнеса Cloud Connector Edition, установить программное обеспечение Cloud Connector и подготовить устройство Cloud Connector к развертыванию. После выполнения всех шагов, которые приводятся в этом разделе, вы будете готовы к развертыванию Cloud Connector для одного или нескольких сайтов. Если у вас есть существующее развертывание соединителя облачных и вы еще не был обновлен для соединителя облачных версии 2.1, видеть [обновление до новой версии облачных соединителя](upgrade-to-a-new-version-of-cloud-connector.md).

> [!NOTE]
> Майкрософт поддерживает текущую версию Edition соединителя облаке, версии 2.1. Если у вас настроено автоматическое обновление, Cloud Connector обновится автоматически. Если вы настроили по запросу, необходимо обновить до версии 2.1 в течение 60 дней после его выпуска. Корпорация Майкрософт будет поддержка предыдущей версии 60 дней после выпуска 2.1, чтобы разрешить время обновления. 

> [!NOTE]
> Для соединителя облачных версии 2.1 и более поздних версий appliance узла необходимо наличие .NET Framework 4.6.1 или более поздней. 

> [!IMPORTANT]
> Для успешного развертывания при выполнении командлетов для настройки Скайп облаке соединитель для выпуска для бизнеса, всегда используйте одного сеанса консоли, которая запущена в. Не рекомендуется переключаться на другие сеансы в процессе развертывания и настройки. 

> [!NOTE]
> Некоторые шаги выполняются только для первого устройства в развертывании: создание общего каталога сайта, загрузка необходимых компонентов и подготовка файла виртуального жесткого диска (VHDX) на основе ISO-образа Windows Server. 

## <a name="download-the-skype-for-business-cloud-connector-edition-installer"></a>Загрузка установщика Skype для бизнеса Cloud Connector Edition

1. На сервере размещения, которой будет запускаться виртуальных машин соединителя облаке, загрузите файлы установки: [https://aka.ms/CloudConnectorInstaller](https://aka.ms/CloudConnectorInstaller). 

    > [!IMPORTANT]
    > Во время установки Cloud Connector сервер узла должен иметь доступ к Интернету, так как ему потребуется скачивать дополнительные файлы. 

2. Запустите установщик и примите значения по умолчанию во время установки.

3. Убедитесь, что установка завершилась успешно.

## <a name="verify-the-installation-and-configure-the-environment"></a>Проверка установки и настройка среды

1. Откройте консоль PowerShell от имени администратора и убедитесь, что Скайп по командлетам соединителя Cloud Business Edition доступны с помощью следующего командлета:

   ```
   Get-Command *-Cc*
   ```

    Команда должна вернуть список командлетов для Скайп облаке соединитель для выпуска для бизнеса.

2. Файлы VHD, SfBBits и VersionInfo будут храниться в **каталоге сайтов**.

    Чтобы узнать расположение **каталога веб-сайтов**, запустите следующий командлет:

   ```
   Get-CcSiteDirectory
   ```

    Команда должна вернуть расположение в вашей файловой системе. Это может быть локальная или общая папка. Расположение **каталога веб-сайтов** по умолчанию: %USERPROFILE%\CloudConnector\SiteRoot. На первом устройстве, созданном на каждом сайте, в качестве расположения по умолчанию следует указать общую папку.

    Необходимо выбрать следующее местоположение:

   - Создается на первом устройстве, создаваемом для каждого сайта.

   - Общая папка, доступная другим серверам узла (устройства) в рамках того же сайта.

     Чтобы выбрать для **каталога сайтов** расположение, отличное от заданного по умолчанию, выполните следующий командлет:

   ```
   Set-CcSiteDirectory <UNC File path>
   ```

    При развертывании высокой доступности для сайта убедитесь, что командлет задает одинаковое расположение **каталога сайтов** на каждом сервере узла сайта.

    После входа в систему и развертывание каждого устройства на сайте, убедитесь в том, что текущая учетная запись пользователя для доступа к **Каталога сайтов**.

3. **Устройство для каталогов** является корневым каталогом локального рабочее для Скайп для соединителя Cloud Business Edition и расположение для сохранения внешнего сертификатов, экземпляры и журналы. Расположение по умолчанию: %USERPROFILE%\CloudConnector\ApplianceRoot.

    Чтобы узнать расположение **каталога устройств**, запустите следующий командлет:

   ```
   Get-CcApplianceDirectory
   ```

    Чтобы выбрать для **каталога устройств** расположение, отличное от заданного по умолчанию, выполните следующий командлет:

   ```
   Set-CcApplianceDirectory <File path>
   ```

    В качестве каталога устройства необходимо задать локальную папку на устройстве. **Устройство для каталога** следует устанавливать только в том случае, прежде чем начать Скайп для развертывания соединителя Cloud Business Edition. Если изменить его после развертывания, потребуется выполнить развертывание сервера узла снова.

    > [!IMPORTANT]
    > Путь к **каталогу устройств** не должен содержать пробелы.

## <a name="set-the-path-for-the-external-edge-certificate"></a>Задайте путь к внешнему сертификату пограничного компонента

- Выполните следующий командлет, чтобы задать путь с именем файла к внешнему сертификату пограничного компонента. Пример: C:\certs\cce\ap.contoso.com.pfx. Сертификат должен содержать закрытые ключи.

  ```
  Set-CcExternalCertificateFilePath -Path <Full path to External certificate, including file name> -Target EdgeServer
  ```

    > [!NOTE]
    > Обратите внимание, что параметр -Target относится к версии 1.4.2 и более поздним версиям. 

    Укажите полный путь к внешнему сертификату, включая имя файла. Сертификат может храниться как локально, так и в общей папке. Если сертификат хранится в общей папке, она должна создаваться на первом устройстве для каждого сайта и должна быть доступна другим устройствам, принадлежащим тому же сайту. Этот командлет копирует внешний сертификат в **каталог устройства**.

    > [!IMPORTANT]
    > **Если вы обновили Cloud Connector до версии 1.4.2 или более поздней версии**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи и полную цепочку сертификатов, включая корневые и промежуточные сертификаты ЦС. **Если вы еще НЕ выполнили обновление Cloud Connector до версии 1.4.2**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи. Такой внешний сертификат должен быть выдан центром сертификации, который по умолчанию является доверенным в Windows.

## <a name="set-the-path-for-the-external-pstn-gatewaysbc-certificate"></a>Задайте путь к внешнему сертификату шлюза ТСОП/SBC

Если между сервером-посредником и шлюзом ТСОП/SBC используется протокол TLS, выполните следующий командлет, чтобы задать путь с именем файла к сертификату шлюза. Например: C:\certs\cce\sbc.contoso.com.cer. Этот сертификат должен содержать корневой ЦС и промежуточную цепочку для сертификата, назначенного шлюзу:

```
Set-CcExternalCertificateFilePath -Path <Full path to gateway certificate, including file name> -Target MediationServer 
```

> [!NOTE]
> Обратите внимание, что параметр -Target относится к версии 1.4.2 и более поздним версиям. 

## <a name="create-virtual-switches-in-hyper-v-manager"></a>Создание виртуальных коммутаторов в диспетчере Hyper-V

1. Откройте **Диспетчер Hyper-V** > **виртуального коммутатора**и выберите **Новый диспетчер виртуальной переключатель**.

2. Создайте внешний виртуальный коммутатор и привяжите его к физическому сетевому адаптеру, который подключен к домену внутренней сети:

    Установите для этого виртуального коммутатора флажок **Разрешить операционной системе управления общий доступ к этому сетевому адаптеру**.

3. Создайте внешний виртуального коммутатора и привязка к физической сетевой адаптер, направляемые в Интернет:

    Снимите флажок **Разрешить общий доступ к данному сетевому адаптеру управляющей операционной системе** для этого виртуального коммутатора.

4. Задайте имя коммутатора, который подключается сети периметра к внутренней сети домена **SfB системы CCE Corpnet переключиться**.

    Задайте имя коммутатора, подключающегося к Интернет, **SfB системы CCE Internet переключиться**сети периметра.

## <a name="update-the-cloudconnectorini-configuration-file"></a>Изменение файла конфигурации CloudConnector.ini

Подготовка файла CloudConnector.ini, с помощью сведения, собранные в [Определение параметров развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе [Планирование Скайп облаке соединитель для выпуска для бизнеса](plan-skype-for-business-cloud-connector-edition.md) .

Чтобы изменить файл, сначала выполните следующий командлет, чтобы получить пример шаблона (CloudConnector.Sample.ini):

```
Export-CcConfigurationSampleFile
```

Пример шаблона хранится в **каталоге устройств**.

Изменив файл с помощью значений для своей среды, сохраните его как CloudConnector.ini в **каталоге устройств**. Чтобы определить путь к **каталогу устройств**, можно выполнить командлет **Get-CcApplianceDirectory**.

При внесении изменений в INI-файл учтите следующие аспекты.

> [!NOTE]
> В этом разделе рассматриваются не все значения для файла INI, только ее с особое внимание можно найти здесь. Полный список обратитесь к разделу [Определение параметров развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе [Планирование Скайп облаке соединитель для выпуска для бизнеса](plan-skype-for-business-cloud-connector-edition.md) . Дополнительные сведения о том, какие значения необходимо изменить для добавления дополнительных устройств или сайтов, см. в разделе[Сравнение развертывания отдельного сайта с высокой доступностью и развертывания с несколькими сайтами](deploy-multiple-sites-in-cloud-connector.md#BKMK_SingleSitecomparedtomulti-site) статьи[Deploy multiple sites in Cloud Connector](deploy-multiple-sites-in-cloud-connector.md) . 

- **SiteName**. По умолчанию имеет значение **Site1**. Это значение необходимо обновить до начала развертывания Cloud Connector, поскольку при выполнении командлета **Register-CcAppliance** для регистрации устройства на существующем или новом сайте значение **SiteName** будет использоваться командлетом для определения сайта, который требуется зарегистрировать.

     Если вы хотите зарегистрировать устройство на новом сайте, значение **SiteName** должно быть уникальным и отличаться от существующих сайтов. Если необходимо зарегистрировать appliance к существующему сайту, значение для **SiteName** в INI-файле должно совпадать с именем, определенных в конфигурации клиента Office 365. Если вы копируете файл конфигурации с одного сайта на другой, для каждого сайта необходимо соответствующим образом обновить значение **SiteName**.

- **ServerName**. Имя сервера не должно содержать имя домена и должно иметь длину не более 15 символов. 

- **HardwareType:** Если не заданы или оставьте значение null, будет использоваться значение по умолчанию **Normal** . Используйте **Обычный** , если вы планируете развернуть большей версии облачных соединитель для поддержки 500 одновременных звонков на главном компьютере, как описано в статье [Plan для Скайп облаке соединитель для выпуска для бизнеса](plan-skype-for-business-cloud-connector-edition.md). Для меньших развертываний, в которых поддерживается до 50 параллельных звонков, следует использовать значение **Минимум**.

- **Виртуальных коммутаторов управление/корпоративной сети и через Интернет:**: Добавление имени виртуальных коммутаторов были созданы. Для виртуального коммутатора управления оставьте значение по умолчанию. Сценарий развертывания будет создание виртуального коммутатора управления в начале развертывания и удалите его после завершения развертывания.

- **ManagementIPPrefix**. Префикс ManagementIPPrefix в разделе Network (Сеть) должен принадлежать к подсети, к которой не принадлежат другие внутренние IP-адреса. Например, как указано в значении по умолчанию, значение параметра ManagementIPPrefix — 192.168.213.0, а AD IPAddress — 192.168.0.238.

    Сценарии развертывания создают сетевой адаптер управления на каждой виртуальной машине, назначают ему IP-адрес управления и подключают его к виртуальному коммутатору управления. Это позволяет серверу узла подключаться к виртуальным машинам и управлять ими с помощью этой сети управления. Виртуальный коммутатор управления удаляется после завершения развертывания.

- **Специальные конфигурации** для базовой виртуальной машины. В этом разделе настраиваются **Convert-CcIsoToVhdx** параметры для командлета .

    При подготовке образа базовой виртуальной машины эта машина будет подключена к коммутатору внутренней сети. Следующие ключевые параметры необходимы для обеспечения доступа виртуальной машины к Интернету:

  - [Common]BaseVMIP — IP-адрес корпоративной сети, назначаемый базовой виртуальной машине.

  - [Network]CorpnetDefaultGateway — шлюз по умолчанию, назначаемый базовой виртуальной машине.

  - [Network]CorpnetDNSIPAddress — IP-адрес DNS, назначаемый базовой виртуальной машине.

  - [Network]WSUSServer — IP-адрес службы Windows Server Update Service (WSUS)

  - [Network]WSUSStatusServer — IP-адрес сервера состояния WSUS.

  - [Network]EnableReferSupport — параметр, определяющий, включена ли поддержка SIP REFER в конфигурации магистрали для IP/УАТС.

- **Внутренние IP-адреса**

  - Убедитесь в том, что маска подсети CorpnetIPPrefixLength является правильным.

  - Убедитесь, что нет конфликтов IP-адресов для этих внутреннего IP-адреса.

- **Внешние IP-адреса**

  - Для MR общедоступный IP-адрес: указать либо ExternalMRIPs не преобразования сетевых адресов или ExternalMRPublicIPs для преобразование сетевых адресов.

  - ExternalSIPIPs и ExternalMRIPs могут быть одинаковыми.

  - Убедитесь в том, что маска подсети InternetIPPrefixLength является правильным.

  - Убедитесь, что нет конфликтов IP-адресов для этих внешних IP-адреса.

- **Шлюзы**.

  - Если у вас только один шлюз, удалите раздел для второго шлюза. Если вы используете несколько шлюзов, для создания дополнительных разделов скопируйте существующий раздел и измените данные в нем соответствующим образом.

  - Убедитесь, что IP-адрес и порт шлюза(-ов) указаны правильно.

  - Чтобы обеспечить поддержку высокой доступности на уровне шлюза ТСОП, оставьте второй шлюз и добавьте необходимые для работы дополнительные шлюзы. Можно скопировать и вставить существующей записи и затем обновите его.

- Кроме того можно обновить значение LocalRoute для ограничения номеров исходящих вызовов.

## <a name="download-the-bits-to-the-site-directory"></a>Загрузка BITS-файлов в каталог сайтов

Выполните следующий командлет, чтобы скачать файлы компонентов и сведений о версии в **каталог сайта**:

```
Start-CcDownload
```

> [!NOTE]
> Этот шаг необходимо выполнять только для первого устройства. 

## <a name="prepare-base-virtual-disk-vhdx-from-the-downloaded-iso-file"></a>Подготовьте базовый виртуальный диск (VHDX) на основе скачанного ISO-файла

В рамках этой процедуры мы подготовим файл виртуального жесткого диска (VHDX) на основе ISO-образа Windows Server 2012. VHDX-файл будет использоваться для создания виртуальных машин во время развертывания. Будет создан временный виртуальной машины (базовый виртуальной Машины) и Windows Server 2012 будет установлено ISO-файл. После создания виртуальной машины потребуется установить некоторые обязательные компоненты и применить последние обновления Windows. И наконец, мы выполним подготовку базовой виртуальной машины к использованию (sysprep) и очистим ее, оставив только созданный файл виртуального диска.

> [!NOTE]
> Этот шаг необходимо выполнять только для первого устройства. 

Прежде чем переходить к этой процедуре, убедитесь, что создан коммутатор корпоративной сети. Кроме того, проверьте правильность настройки следующих параметров в файле CloudConnector.ini:

- [Network]CorpnetSwitchName

- [Common]BaseVMIP

- [Network]CorpnetIPPrefixLength

- [Network]CorpnetDefaultGateway

- [Network]CorpnetDNSIPAddress

Запустите консоль PowerShell от имени администратора и выполните следующий командлет, чтобы преобразовать ISO-образ в виртуальный жесткий диск (VHD):

```
Convert-CcIsoToVhdx -IsoFilePath <Windows ISO File Path, including file name>
```

Укажите полный путь, включая имя файла, к ISO-образу. Например: C:\ISO\WindowsServer2012.iso.

Созданный файл виртуального жесткого диска хранится в папке \Bits\VHD **Каталога сайтов** . Путь к **каталогу сайтов** можно получить, выполнив командлет **Get-CcSiteDirectory**.

> [!IMPORTANT]
> По умолчанию параметры прокси-сервера не настроены для базовой виртуальной машины. При необходимости использования прокси-сервера для обновления виртуальной Машины с помощью центра обновления Windows в сетевой среде следует добавить параметр - PauseBeforeUpdate при запуске «Convert-CcIsoToVhdx». Скрипт будет приостановлено до обновления Windows и иметь возможность вручную настроить прокси-сервер, на виртуальной Машине. После указания прокси-сервера (что позволит виртуальной машине получать доступ к Интернету) можно возобновить сценарий для выполнения оставшихся действий. 

### <a name="create-vhds-for-a-multi-site-deployment"></a>Создание VHD-файлов для развертывания с несколькими сайтами

Это дополнительная процедура, применимая только к многосайтовым развертываниям.

В развертывании такого типа нет необходимости преобразовать ISO в VHD для каждого сайта. Можно скопировать VHDX-файл, созданный для первого сайта, на узел сервера для второго сайта.

 Скопируйте файл в ту же папку файл (папка \Bits\VHD **Каталога веб-сайтов** ) и с тем же именем, на хост-сервера для дополнительных сайта.

## <a name="set-the-powershell-execution-policy-to-remotesigned"></a>Задание значения RemoteSigned для политики выполнения PowerShell

Указанные здесь сценарии PowerShell требуют, чтобы для политики выполнения было задано значение RemoteSigned. Чтобы узнать текущую настройку, откройте консоль PowerShell от имени администратора, а затем выполните следующий командлет:

```
Get-ExecutionPolicy
```

Если значение RemoteSigned не задано, выполните этот командлет, чтобы изменить его:

```
Set-ExecutionPolicy RemoteSigned
```

## <a name="change-local-group-policy-on-the-host-machine-versions-141-and-earlier"></a>Изменение локальной групповой политики на хост-компьютере (версии 1.4.1 и более ранние)

> [!NOTE]
> Эта задача не выполняется для Cloud Connector версии 1.4.2 и более поздних версий. 

Учетная запись CceService создается во время развертывания Skype для бизнеса Cloud Connector Edition. Он запускается облачная служба управления Connector и требуется разрешение на удаление cloudconnector.msi. Необходимо изменить параметр групповой политики на хост-компьютере Cloud Connector, чтобы указать, что реестр пользователя не следует выгружать при выходе пользователя из системы. Следуйте инструкциям ниже.

### <a name="to-change-the-group-policy-setting"></a>Изменение параметра групповой политики

1. Откройте **Редактор групповой политики** , выполнив gpedit.msc.

2. В **редакторе групповых политик** перейдите в раздел «Административные шаблоны» > «Система» > UserProfile > «Не выполнять принудительную выгрузку реестра пользователя при его выходе из системы».  

3. Присвойте ей значение **включено**.

## <a name="set-up-your-office-365-tenant"></a>Настройка клиента Office 365

Необходим клиента Office 365 с помощью Скайп для бизнеса в Интернет и телефонной системой в Office 365. Убедитесь в том, Установка и настроен перед попыткой использования соединителя облачных вашего клиента.

Некоторые действия программы установки Office 365 требуется настройка клиента Office 365 с помощью PowerShell удаленного клиента (TRPS). **Ее необходимо установить на сервере узла.** Вы можете загрузить Скайп для бизнеса в Интернет модуль для PowerShell из: [Скайп для бизнеса в Интернет, модуля Windows PowerShell](https://www.microsoft.com/en-us/download/details.aspx?id=39366).

Создание выделенной Скайп для учетной записи администратора предприятия для соединителя облачных online управления, например CceOnlineManagmentAdministrator. Эта учетная запись будет использоваться для добавления и удаления устройств, включения и отключения автоматического обновления ОС, включения и отключения автоматического обновления двоичных файлов. Задайте для этой учетной записи бессрочный пароль, чтобы упростить работу со службой.


