---
title: Подготовка устройства Cloud Connector
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 2/15/2018
audience: ITPro
ms.topic: conceptual
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
ms.collection:
- Strat_SB_Hybrid
ms.custom: ''
ms.assetid: 6eacfa99-9759-4c13-aca3-8992c2ff2710
description: Узнайте, как подготовить устройство Cloud Connector к развертыванию и использовать телефонная система (Cloud PBX).
ms.openlocfilehash: 255b276ebb0d192f876d07e318cf94ccf3698a1f
ms.sourcegitcommit: 556fffc96729150efcc04cd5d6069c402012421e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2021
ms.locfileid: "58590003"
---
# <a name="prepare-your-cloud-connector-appliance"></a>Подготовка устройства Cloud Connector

> [!Important]
> Cloud Connector Edition завершится 31 июля 2021 г. вместе с Skype для бизнеса Online. После обновления организации Teams, узнайте, как подключить локальной телефонной сети к Teams с помощью прямой [маршрутизации](/MicrosoftTeams/direct-routing-landing-page).

Узнайте, как подготовить устройство Cloud Connector к развертыванию и использовать телефонная система (Cloud PBX).

В этом разделе описывается, как получить файлы Skype для бизнеса Cloud Connector Edition установки, установить программное обеспечение Cloud Connector и подготовить устройство Cloud Connector для развертывания. После завершения всех действий в этом разделе вы будете готовы развернуть cloud Connector для одного сайта или нескольких сайтов. Если у вас есть существующее развертывание облачного соединиттеля и вы еще не обновлены до версии 2.1 cloud Connector, см. в примере Обновление до новой версии облачного [соединитетеля.](upgrade-to-a-new-version-of-cloud-connector.md)

> [!NOTE]
> Корпорация Майкрософт поддерживает текущую версию Cloud Connector Edition версии 2.1. Если вы настраивали автоматическое обновление, облачный соединителю будет обновляться автоматически. Если вы настроили ручное обновление, вам потребуется обновить версию 2.1 в течение 60 дней после ее выпуска. Корпорация Майкрософт будет поддерживать предыдущую версию в течение 60 дней после выпуска 2.1, чтобы у вас было время на обновление. 

> [!NOTE]
> Для версии Cloud Connector 2.1 и более поздней версии хост-устройство должно быть установлено платформа .NET Framework 4.6.1 или более поздней версии. 

> [!IMPORTANT]
> Для успешного развертывания при запуске cmdlets для настройки Skype для бизнеса Cloud Connector Edition всегда используйте тот же сеанс консоли, что и запущенный сеанс. Избегайте переключения на различные сеансы во время развертывания и конфигурации. 

> [!NOTE]
> Есть несколько действий, которые выполняются только для первого устройства в развертывании: создание доли для каталога сайтов, скачивание битов и подготовка файла виртуального жесткого диска (VHDX) из изображения ISO Windows Server. 

## <a name="download-the-skype-for-business-cloud-connector-edition-installer"></a>Скачайте Skype для бизнеса Cloud Connector Edition установщика

1. На сервере хост-сервера, где будут работать VMs облачного соединителя, скачайте файлы установки: [https://aka.ms/CloudConnectorInstaller](https://aka.ms/CloudConnectorInstaller) . 

    > [!IMPORTANT]
    > Хост-сервер должен иметь доступ к Интернету во время установки облачного соединителя, так как во время установки загружаются дополнительные файлы. 

2. Запустите установщик и примите значения по умолчанию во время установки.

3. Подтверждение успешного завершения установки.

## <a name="verify-the-installation-and-configure-the-environment"></a>Проверка установки и настройка среды

1. Откройте консоль PowerShell в качестве администратора и подтвердите, что Skype для бизнеса Cloud Connector Edition доступны с помощью следующего cmdlet:

   ```powershell
   Get-Command *-Cc*
   ```

    Команда должна вернуть список командлетов для Skype для бизнеса Cloud Connector Edition.

2. Файлы VHD, SfBBits и VersionInfo будут храниться в **Каталоге сайтов.**

    Расположение каталога сайтов  можно найти с помощью следующего cmdlet:

   ```powershell
   Get-CcSiteDirectory
   ```

    Команда должна вернуть расположение в файловой системе. Расположение может быть локальной папкой или файлом. Расположение каталога  сайтов по умолчанию: %USERPROFILE%\CloudConnector\SiteRoot. Расположение по умолчанию должно быть изменено на файл на первом устройстве, созданном на каждом сайте.

    Выбранное расположение должно быть:

   - Создан на первом устройстве, созданном на каждом сайте.

   - Общая папка, доступная другим хост-серверам (устройствам) на том же сайте.

     Чтобы настроить **каталог сайтов к** расположению, помимо по умолчанию, запустите следующий cmdlet:

   ```powershell
   Set-CcSiteDirectory <UNC File path>
   ```

    При развертывании высокой доступности (HA) для сайта убедитесь, что вы  запустите этот код, чтобы установить каталог сайтов в одном расположении на каждом сервере узла на сайте.

    При входе и развертывании каждого устройства на сайте убедитесь, что текущая учетная запись с логотипом имеет правильный доступ к **каталогу сайтов.**

3. Каталог **приборов —** это локальный рабочий корневой каталог для Skype для бизнеса Cloud Connector Edition и расположение, в котором сохраняются внешние сертификаты, экземпляры и журналы. Расположение по умолчанию: %USERPROFILE%\CloudConnector\ApplianceRoot.

    Чтобы найти расположение каталога **приборов,** запустите следующий cmdlet:

   ```powershell
   Get-CcApplianceDirectory
   ```

    Чтобы настроить **Каталог приборов** для расположения, помимо по умолчанию, запустите следующий cmdlet:

   ```powershell
   Set-CcApplianceDirectory <File path>
   ```

    Каталог приборов должен быть установлен в локальной папке на устройстве. Прежде чем приступить **к** развертыванию Skype для бизнеса Cloud Connector Edition, необходимо Skype для бизнеса Cloud Connector Edition каталог приборов. Если вы измените его после развертывания, вам потребуется передиплоять хост-сервер.

    > [!IMPORTANT]
    > Путь к **Каталогу приборов не должен** содержать пробелов.

## <a name="set-the-path-for-the-external-edge-certificate"></a>Настройка пути для внешнего сертификата Edge

- Запустите следующий комдлет, чтобы задать путь, в том числе имя файла, внешнему сертификату Edge. Например: C:\certs\cce\ap.contoso.com.pfx. Сертификат должен содержать закрытые ключи.

  ```powershell
  Set-CcExternalCertificateFilePath -Path <Full path to External certificate, including file name> -Target EdgeServer
  ```

    > [!NOTE]
    > Обратите внимание, что параметр -Target является специфическим для версий 1.4.2 и более поздней версии. 

    Укажите полный путь к внешнему сертификату, включая имя файла. Сертификат может храниться локально или в файлообме. Если сертификат хранится в общей папке, общая папка должна быть создана на первом устройстве каждого сайта и должна быть доступна другими устройствами, принадлежащими к одному сайту. Этот cmdlet копирует внешний сертификат в **Каталог приборов**.

    > [!IMPORTANT]
    > Если вы обновили версию **Cloud Connector версии 1.4.2** или более поздней версии, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи и всю цепочку сертификатов, включая корневой сертификат CA и промежуточные сертификаты CA. Если вы еще не обновили версию Облачного соединитетеля **1.4.2,** убедитесь, что подготовленный внешний сертификат содержит закрытые ключи. Этот внешний сертификат должен быть выдан органом сертификации, которому Windows по умолчанию.

## <a name="set-the-path-for-the-external-pstn-gatewaysbc-certificate"></a>Настройка пути для внешнего шлюза PSTN/SBC

Если вы используете TLS между сервером-посредником и шлюзом PSTN/SBC, запустите следующий cmdlet, чтобы задать путь, включая имя файла, к сертификату шлюза. Например: C:\certs\cce\sbc.contoso.com.cer. Сертификат должен содержать корневой ЦС и промежуточную цепочку для сертификата, назначенного шлюзу:

```powershell
Set-CcExternalCertificateFilePath -Path <Full path to gateway certificate, including file name> -Target MediationServer 
```

> [!NOTE]
> Обратите внимание, что параметр -Target является специфическим для версий 1.4.2 и более поздней версии. 

## <a name="create-virtual-switches-in-hyper-v-manager"></a>Создание виртуальных коммутаторов в Hyper-V Manager

1. Откройте **Hyper-V диспетчер**  >  **виртуальных коммутаторов** и выберите **New Virtual Switch Manager**.

2. Создайте внешний виртуальный переключатель и привязывайте его к физическому сетевому адаптеру, подключенного к внутреннему сетевому домену:

    Выберите **Разрешить операционной системе управления совместно использовать этот сетевой адаптер** для этого виртуального переключателя.

3. Создайте внешний виртуальный переключатель и привязывайте его к физическому сетевому адаптеру, который будет перенаходить в Интернет:

    De-select Разрешить операционной системе управления **совместно использовать этот сетевой адаптер** для этого виртуального коммутатора.

4. Установите имя переключателя, соединяющего сеть периметра с внутренним сетевым доменом **SfB CCE Corpnet Switch.**

    Установите имя переключателя, соединяющего сеть периметра с **интернет-переключателем SfB CCE.**

## <a name="update-the-cloudconnectorini-configuration-file"></a>Обновление файла CloudConnector.ini конфигурации

Подготовка файла CloudConnector.ini с помощью сведений, [](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) собранных в разделе Определение параметров развертывания в разделе [Plan for Skype для бизнеса Cloud Connector Edition.](plan-skype-for-business-cloud-connector-edition.md)

Чтобы обновить файл, сначала запустите следующий cmdlet, чтобы получить образец шаблона (CloudConnector.Sample.ini):

```powershell
Export-CcConfigurationSampleFile
```

Пример шаблона хранится в **Каталоге приборов.**

После обновления с помощью значений для среды сохраните файл CloudConnector.ini в **Каталоге приборов.** Вы можете запустить **Get-CcApplianceDirectory,** чтобы определить путь к **каталогу приборов.**

При обновлении .ini следует учитывать следующее:

> [!NOTE]
> Не все значения для .ini обсуждаются в этом разделе, здесь рассматриваются только значения с особым вниманием. Полный список см. в разделе [Определение](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) параметров развертывания в разделе [Plan for Skype для бизнеса Cloud Connector Edition.](plan-skype-for-business-cloud-connector-edition.md) Дополнительные сведения о том, какие значения необходимо изменить для дополнительных устройств или новых сайтов, см. в разделе Единый сайт с высокой доступностью [(HA)](deploy-multiple-sites-in-cloud-connector.md#BKMK_SingleSitecomparedtomulti-site) по сравнению с многоэтапными развертываниями в разделе [Развертывание](deploy-multiple-sites-in-cloud-connector.md)нескольких сайтов в облачном соединители. 

- **Имя сайта:** По умолчанию значение **Site1**. Перед развертыванием облачного соединителя необходимо обновить его, так как при запуске **Register-CcAppliance** для регистрации устройства на существующем или новом сайте, для регистрации на сайте будет использовать **имя siteName.**

     Если вы хотите зарегистрировать устройство на новом сайте, значение **SiteName** должно быть уникальным и отличается от существующих сайтов. Если вы хотите зарегистрировать устройство на существующем сайте, значение **siteName** в файле .ini должно совпадать с именем, определенным в конфигурации Microsoft 365 или Office 365 организации. Если вы копируете файл конфигурации с одного сайта на другой, убедитесь, что вы соответственно обновляете значение **для siteName** для каждого сайта.

- **ServerName:** Имя сервера не должно содержать доменное имя и должно быть ограничено 15 символами.

- **HardwareType:** Если значение не установлено или не будет равно нуль, будет использоваться значение **Normal** по умолчанию. Используйте **Normal,** если вы планируете развернуть более крупную версию облачного соединитель для поддержки 500 одновременных вызовов на одну хост-машину, как описано в [Plan for Skype для бизнеса Cloud Connector Edition.](plan-skype-for-business-cloud-connector-edition.md) Используйте **Minimum** для меньшего развертывания, которое поддерживает 50 одновременных вызовов.

- **Виртуальные переключатели Internet/Corpnet/Management: :** Добавьте имя созданных виртуальных коммутаторов. Для виртуального переключателя управления оставьте значение по умолчанию. Сценарий развертывания создаст виртуальный переключатель управления в начале развертывания и удалит его по завершению развертывания.

- **ManagementIPPrefix:** ManagementIPPrefix в разделе Network должен быть другой подсети от других внутренних IPs. Например, как показывает значение по умолчанию, Значение ManagementIPPrefix — 192.168.213.0, а значение AD IPAddress — 192.168.0.238.

    Сценарии развертывания создают адаптер сети управления на каждой виртуальной машине, назначают IP-адрес управления и подключают его к виртуальному переключательу управления. Это позволяет хост-серверу подключаться к каждой виртуальной машине и управлять ими с помощью этой сети управления. Виртуальный переключатель управления удаляется по завершению развертывания.

- **Базовые конфигурации VM:** Параметры в этом разделе необходимо настроить для **cmdlet Convert-CcIsoToVhdx.**

    Во время подготовки базового VM-изображения базовый VM будет подключен к внутреннему сетевому переключательу. Для доступа к Интернету для VM важны следующие параметры:

  - [Общие] BaseVMIP: IP-адрес corpnet, который будет назначен базовому VM.

  - [Сеть] CorpnetDefaultGateway: шлюз по умолчанию, который будет назначен базовому VM.

  - [Сеть] CorpnetDNSIPAddress: IP-адрес DNS, который будет назначен базовому VM.

  - [Сеть] WSUSServer: IP-адрес службы обновления Windows сервера.

  - [Сеть] WSUSStatusServer: IP-адрес сервера Windows службы обновления сервера.

  - [Сеть] EnableReferSupport: это определит, включена или отключена поддержка SIP REFER в конфигурации магистрали в IP/PBX.

- **Внутренние IPs:**

  - Убедитесь, что маска подсети CorpnetIPPrefixLength является правильной.

  - Убедитесь, что для этих внутренних IP-ip-адресов нет конфликтов.

- **Внешние IPs:**

  - Для IP-адресов mr public: укажите внешниеMRI-адреса для non-NAT или ExternalMRPublicIPs для NAT.

  - ExternalSIPIPs и ExternalMRIPs могут быть одинаковыми.

  - Убедитесь, что маска подсети InternetIPPrefixLength является правильной.

  - Убедитесь, что для этих внешних IP-ip-адресов нет конфликтов.

- **Шлюзы:**

  - Если у вас есть только один шлюз, удалите раздел для вторичного шлюза. Если у вас больше двух шлюзов, создайте дополнительные разделы, скопируя и вклеив существующий, а затем обновив его.

  - Убедитесь, что IP-адрес и порт шлюза (ы) являются правильными.

  - Чтобы поддерживать уровень ha шлюза PSTN, оставьте вторичный шлюз и добавьте дополнительные шлюзы, которые вы будете использовать. Можно скопировать и вклеить существующую запись, а затем обновить ее.

- Дополнительно можно обновить значение LocalRoute, чтобы ограничить исходящие номера вызовов.

## <a name="download-the-bits-to-the-site-directory"></a>Скачайте биты в каталог сайта

Запустите следующий cmdlet, чтобы скачать биты и версии файлов информации в **Каталог сайта**:

```powershell
Start-CcDownload
```

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

## <a name="prepare-base-virtual-disk-vhdx-from-the-downloaded-iso-file"></a>Подготовка базового виртуального диска (VHDX) из загруженного файла ISO

Этот шаг подготавливает виртуальный жесткий диск (VHDX) из Windows Server 2012 isO. VHDX будет использоваться для создания виртуальных машин во время развертывания. Будет создана временная виртуальная машина (базовый VM), Windows Server 2012 будет установлена из файла ISO. После создания VM будут установлены некоторые необходимые компоненты и Windows будет применено последнее обновление. В конце базовый VM будет обобщен (sysprep) и очищен, оставив только созданный виртуальный дисковый файл.

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

Прежде чем приступить к этому шагу, убедитесь, что коммутатор corpnet создан. Кроме того, подтвердим, что в файле CloudConnector.ini правильно настроены следующие параметры:

- [Сеть] CorpnetSwitchName

- [Общие] BaseVMIP

- [Сеть] CorpnetIPPrefixLength

- [Сеть] CorpnetDefaultGateway

- [Сеть] CorpnetDNSIPAddress

Запустите консоль PowerShell в качестве администратора и запустите следующий cmdlet, чтобы преобразовать изображение ISO в виртуальный жесткий диск (VHD):

```powershell
Convert-CcIsoToVhdx -IsoFilePath <Windows ISO File Path, including file name>
```

Укажите полный путь, включая имя файла, на изображение ISO. Например: C:\ISO\WindowsServer2012R2.iso.

Созданный VHD-файл хранится в папке **Site Directory** \Bits\VHD. Путь к каталогу  сайтов можно получить с помощью **Get-CcSiteDirectory.**

> [!IMPORTANT]
> По умолчанию параметры прокси не настроены на базовом VM. Если прокси-сервер требуется в сетевой среде для обновления VM с помощью Windows Update, необходимо добавить переключатель PauseBeforeUpdate при запуске "Convert-CcIsoToVhdx". Перед обновлением Windows скрипт приостановится, и у вас будет возможность вручную настроить прокси-сервер в VM. После установки прокси-сервера и доступа к Интернету vM можно возобновить сценарий для выполнения оставшихся действий. 

### <a name="create-vhds-for-a-multi-site-deployment"></a>Создание VHD для развертывания на нескольких узлах

Это необязательный шаг, который применяется только к развертыванию на нескольких узлах.

При развертывании развертывания на нескольких веб-узлах не требуется преобразовать ISO в VHD для каждого сайта. Вы можете скопировать VHDX, созданный для первого сайта, на сервер узла для второго сайта.

 Скопируйте файл в том же расположении файла **(папка Site Directory** \Bits\VHD) и с тем же именем файла на сервере узла для дополнительного сайта.

## <a name="set-the-powershell-execution-policy-to-remotesigned"></a>Установите политику выполнения PowerShell в RemoteSigned

Предоставленные скрипты PowerShell требуют, чтобы политика выполнения была настроена на RemoteSigned. Чтобы увидеть текущий параметр, откройте консоль PowerShell в качестве администратора и запустите следующий cmdlet:

```powershell
Get-ExecutionPolicy
```

Если не установлено "RemoteSigned", запустите следующий cmdlet, чтобы изменить его:

```powershell
Set-ExecutionPolicy RemoteSigned
```

## <a name="change-local-group-policy-on-the-host-machine-versions-141-and-earlier"></a>Изменение локальной групповой политики на хост-машине (версии 1.4.1 и ранее)

> [!NOTE]
> Эта задача не требуется для версий Cloud Connector 1.4.2 и более поздней версии. 

Учетная запись CceService создается во время Skype для бизнеса Cloud Connector Edition развертывания. Она запускает службу управления облачными соединителями и требует разрешения на cloudconnector.msi. Необходимо изменить параметр групповой политики на хост-машине облачного соединитела, чтобы указать, что реестр пользователей не должен быть выгружен при отключении входа пользователя. Выполните следующие действия:

### <a name="to-change-the-group-policy-setting"></a>Изменение параметра групповой политики

1. Откройте редактор **групповой политики,** задав gpedit.msc.

2. В **редакторе** групповой политики перейдите к административным шаблонам > System > UserProfile > Не принудительно разгрузите реестр пользователей при входе пользователя. 

3. Установите значение **Включено**.

## <a name="set-up-your-microsoft-365-or-office-365-organization"></a>Настройка Microsoft 365 или Office 365 организации

Требуется Microsoft 365 или Office 365 с Skype для бизнеса Online и телефонная система. Убедитесь, что клиент настроен и настроен перед попыткой использования облачного соединитетеля.

Некоторые Microsoft 365 и Office 365 настройки требуют, чтобы вы использовали tenant Remote PowerShell (TRPS) для настройки Microsoft 365 или Office 365 организации. **Это должно быть установлено на сервере хост-сервера.** Вы можете скачать модуль Skype для бизнеса Online для PowerShell из: [Skype для бизнеса Online, Windows PowerShell Module](https://www.microsoft.com/download/details.aspx?id=39366).

Создание учетной записи Skype для бизнеса администратора для управления облачным подключением, например CceOnlineManagmentAdministrator. Эта учетная запись будет использоваться устройством для добавления или удаления устройства, включить или отключить автоматическое обновление ОС, включить или отключить автоматическое двоичное обновление. Установите пароль для этой учетной записи, чтобы никогда не истекал срок действия, чтобы не нужно менять его для службы каждый раз, когда он истекает.