---
title: Подготовка устройства Cloud Connector
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 2/15/2018
audience: ITPro
ms.topic: conceptual
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection:
- Strat_SB_Hybrid
ms.custom: ''
ms.assetid: 6eacfa99-9759-4c13-aca3-8992c2ff2710
description: Узнайте, как подготовить устройство Cloud Connector к развертыванию и использованию с телефонной системой (облачной УАКС).
ms.openlocfilehash: 74c4885a25b4176f4d5eb3ac27926bd9528387c6
ms.sourcegitcommit: b424ab14683ab5080ebfd085adff7c0dbe1be84c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/03/2020
ms.locfileid: "47358945"
---
# <a name="prepare-your-cloud-connector-appliance"></a>Подготовка устройства Cloud Connector

> [!Important]
> Выпуск Cloud Connector Edition завершится 31 июля 2021 г. вместе со Skype для бизнеса Online. После обновления вашей организации до Teams узнайте, как подключить свою локальной телефонной сети к Teams с помощью [прямой маршрутизации.](https://docs.microsoft.com/MicrosoftTeams/direct-routing-landing-page)

Узнайте, как подготовить устройство Cloud Connector к развертыванию и использованию с телефонной системой (облачной УАПС).

В этом разделе описывается, как получить файлы установки Skype для бизнеса Cloud Connector Edition, установить программное обеспечение Cloud Connector и подготовить устройство Cloud Connector к развертыванию. После завершения всех действий в этом разделе вы будете готовы к развертыванию Cloud Connector для одного или нескольких сайтов. Если у вас есть существующее развертывание Cloud Connector и вы еще не обновились до Cloud Connector версии 2.1, см. статью "Обновление до новой версии [Cloud Connector".](upgrade-to-a-new-version-of-cloud-connector.md)

> [!NOTE]
> Корпорация Майкрософт поддерживает текущую версию Cloud Connector Edition версии 2.1. Если вы настроили автоматическое обновление, Cloud Connector будет обновляться автоматически. Если вы настроили обновление вручную, вам потребуется обновить версию 2.1 в течение 60 дней с момента его выпуска. Корпорация Майкрософт будет поддерживать предыдущую версию в течение 60 дней после выпуска 2.1, чтобы у вас было время на обновление. 

> [!NOTE]
> Для Cloud Connector версии 2.1 и более поздних версий на хост-устройстве должна быть установлена .NET Framework 4.6.1 или более поздней версии. 

> [!IMPORTANT]
> При успешном развертывании при запуске с помощью cmdlets для настройки Skype для бизнеса Cloud Connector Edition всегда используйте тот же сеанс консоли, в который вы начали. Избегайте переключения на другие сеансы во время развертывания и настройки. 

> [!NOTE]
> Некоторые действия выполняются только для первого устройства в развертывании: создание папки для каталога сайта, скачивание битов и подготовка файла виртуального жесткого диска (VHDX) из isO-образа Windows Server. 

## <a name="download-the-skype-for-business-cloud-connector-edition-installer"></a>Скачивание установщика Skype для бизнеса Cloud Connector Edition

1. На сервере, на котором будут работать ВМ Cloud Connector, скачайте файлы [https://aka.ms/CloudConnectorInstaller](https://aka.ms/CloudConnectorInstaller) установки: 

    > [!IMPORTANT]
    > Хост-сервер должен иметь доступ к Интернету во время установки Cloud Connector, так как во время установки загружаются дополнительные файлы. 

2. Запустите установщик и примите значения по умолчанию во время установки.

3. Подтвердим, что установка успешно завершена.

## <a name="verify-the-installation-and-configure-the-environment"></a>Проверка установки и настройка среды

1. Откройте консоль PowerShell от учетной записи администратора и подтвердим, что доступны следующие cmdlets Skype для бизнеса Cloud Connector Edition:

   ```powershell
   Get-Command *-Cc*
   ```

    Команда должна вернуть список командлетов для Skype для бизнеса Cloud Connector Edition.

2. Файлы VHD, SfBBits и VersionInfo будут храниться в **каталоге сайтов.**

    Расположение каталога сайтов можно найти с **помощью** следующего cmdlet:

   ```powershell
   Get-CcSiteDirectory
   ```

    Команда должна вернуть расположение в файловой системе. Расположение может быть локальной папкой или файловой папкой. Расположение каталога  сайтов по умолчанию: %USERPROFILE%\CloudConnector\SiteRoot. Расположение по умолчанию должно быть изменено на обную папку на первом устройстве, созданном на каждом сайте.

    Выбранное расположение должно быть:

   - Создается на первом устройстве, созданном на каждом сайте.

   - Общая папка, доступная другим серверам узла (устройствам) на том же сайте.

     Чтобы установить **для каталога сайтов** расположение, не назначенное по умолчанию, запустите следующий cmdlet:

   ```powershell
   Set-CcSiteDirectory <UNC File path>
   ```

    При развертывании высокой доступности для сайта убедитесь, что вы запустите  его, чтобы установить для каталога сайтов одно и то же расположение на каждом сервере узла сайта.

    При входе и развертывании каждого устройства на сайте убедитесь, что текущая учетная запись входа имеет правильный доступ к **каталогу сайтов.**

3. Каталог **устройств —** это локальный рабочий корневой каталог skype для бизнеса Cloud Connector Edition и расположение, в котором сохраняются внешние сертификаты, экземпляры и журналы. Расположение по умолчанию: %USERPROFILE%\CloudConnector\ApplianceRoot.

    Чтобы найти расположение **каталога** устройств, запустите следующий cmdlet:

   ```powershell
   Get-CcApplianceDirectory
   ```

    Чтобы установить для **каталога устройств** расположение, не назначенное по умолчанию, запустите следующий cmdlet:

   ```powershell
   Set-CcApplianceDirectory <File path>
   ```

    Для каталога устройства необходимо установить локализованную папку на устройстве. Следует установить каталог  устройств только перед началом развертывания Skype для бизнеса Cloud Connector Edition. Если вы измените его после развертывания, потребуется развертывание сервера размещения.

    > [!IMPORTANT]
    > Путь к каталогу **устройств не должен** содержать пробелов.

## <a name="set-the-path-for-the-external-edge-certificate"></a>Настройка пути для внешнего сертификата edge

- Запустите следующий cmdlet, чтобы установить путь, включая имя файла, к внешнему сертификату edge. Например: C:\certs\cce\ap.contoso.com.pfx. Сертификат должен содержать закрытые ключи.

  ```powershell
  Set-CcExternalCertificateFilePath -Path <Full path to External certificate, including file name> -Target EdgeServer
  ```

    > [!NOTE]
    > Обратите внимание, что параметр -Target является специфическим для версий 1.4.2 и более поздних версий. 

    Укажите полный путь к внешнему сертификату, включая имя файла. Сертификат может храниться локально или в файловом хранилище. Если сертификат хранится в общей папке, общая папка должна быть создана на первом устройстве каждого сайта и должна быть доступна другим устройствам, принадлежащим к одному сайту. Этот cmdlet копирует внешний сертификат в каталог **устройств.**

    > [!IMPORTANT]
    > Если вы обновили cloud Connector версии **1.4.2** или более поздней, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи и полную цепочку сертификатов, включая сертификат корневого ЦС и сертификаты промежуточных ЦС. Если вы ЕЩЕ НЕ обновили Cloud Connector версии **1.4.2,** убедитесь, что подготовленный внешний сертификат содержит закрытые ключи. Этот внешний сертификат должен быть выдан органом сертификации, которому по умолчанию доверяет Windows.

## <a name="set-the-path-for-the-external-pstn-gatewaysbc-certificate"></a>Настройка пути для внешнего сертификата шлюза STN/SBC

При использовании TLS между сервером-посредником и шлюзом STN/SBC запустите следующий cmdlet, чтобы установить путь, включая имя файла, к сертификату шлюза. Например: C:\certs\cce\sbc.contoso.com.cer. Сертификат должен содержать корневой ЦС и промежуточную цепочку для сертификата, назначенного шлюзу:

```powershell
Set-CcExternalCertificateFilePath -Path <Full path to gateway certificate, including file name> -Target MediationServer 
```

> [!NOTE]
> Обратите внимание, что параметр -Target является специфическим для версий 1.4.2 и более поздних версий. 

## <a name="create-virtual-switches-in-hyper-v-manager"></a>Создание виртуальных коммутаторов в диспетчере Hyper-V

1. Откройте **диспетчер виртуальных коммутаторов Диспетчер Hyper-V** и выберите  >   **"Новый диспетчер виртуальных коммутаторов".**

2. Создайте внешний виртуальный коммутатор и привяжете его к физическому сетевому адаптеру, подключенном к домену внутренней сети:

    Выберите **"Разрешить операционной системе управления совместно использовать этот сетевой адаптер** для этого виртуального коммутатора".

3. Создайте внешний виртуальный коммутатор и привяжете его к физическому сетевому адаптеру, который маршрутит в Интернет:

    De-select **Allow management operating system to share this network adapter** for this virtual switch.

4. Установите имя коммутатора, который подключает сеть периметра к домену внутренней сети **SfB CCE Corpnet Switch.**

    Установите имя коммутатора, который подключает сеть периметра к **Интернет-коммутатору CCE SfB.**

## <a name="update-the-cloudconnectorini-configuration-file"></a>Обновление файла CloudConnector.ini конфигурации

Подготовьте CloudConnector.ini, используя сведения, собранные [](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе "Определение параметров развертывания" в разделе "Планирование использования Skype для бизнеса [Cloud Connector Edition".](plan-skype-for-business-cloud-connector-edition.md)

Чтобы обновить файл, сначала запустите следующий cmdlet, чтобы получить пример шаблона (CloudConnector.Sample.ini):

```powershell
Export-CcConfigurationSampleFile
```

Пример шаблона хранится в **каталоге устройств.**

Обновив его с помощью значений для своей среды, сохраните файл CloudConnector.ini в **каталоге устройств.** Чтобы определить путь к каталогу устройств, можно запустить **get-CcApplianceDirectory.** 

При обновлении INI-файла учитывайте следующее:

> [!NOTE]
> Не все значения INI-файла рассматриваются в этом разделе, здесь рассматриваются только значения, которые имеют особое значение. Полный список см. в разделе ["Определение](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) параметров развертывания" статьи ["Планирование skype для бизнеса Cloud Connector Edition".](plan-skype-for-business-cloud-connector-edition.md) Дополнительные сведения о том, какие значения необходимо изменить для [](deploy-multiple-sites-in-cloud-connector.md#BKMK_SingleSitecomparedtomulti-site) дополнительных устройств или новых сайтов, см. в разделе "Один сайт с высокой доступностью" по сравнению с развертываниями с несколькими сайтами в разделе "Развертывание нескольких сайтов в [Cloud Connector".](deploy-multiple-sites-in-cloud-connector.md) 

- **SiteName:** Значение по умолчанию **— Site1.** Перед развертыванием Cloud Connector необходимо обновить его, так как при запуске **Register-CcAppliance** для регистрации устройства на существующем или новом сайте он будет использовать **имя** сайта, чтобы определить, какой сайт необходимо зарегистрировать.

     Если вы хотите зарегистрировать устройство на новом сайте, значение **SiteName** должно быть уникальным и отличается от существующего сайта. Если вы хотите зарегистрировать устройство на существующем сайте, значение **siteName** в INI-файле должно совпадать с именем, определенным в конфигурации организации Microsoft 365 или Office 365. При копировании файла конфигурации с одного сайта на другой убедитесь, что значение **SiteName** для каждого сайта обновляется соответствующим образом.

- **ServerName:** Имя сервера не должно содержать имя домена и должно содержать не более 15 символов.

- **HardwareType:** Если вы не установите или не оставьте значение null, будет использоваться значение **normal** по умолчанию. Используйте **обычный,** если вы планируете развернуть более крупную версию Cloud Connector для поддержки 500 одновременных вызовов на хост-компьютер, как описано в описании плана Skype для бизнеса [Cloud Connector Edition.](plan-skype-for-business-cloud-connector-edition.md) Используйте **минимум** для развертывания меньшего размера, которое поддерживает 50 одновременных вызовов.

- **Виртуальные коммутаторы Internet/Corpnet/Management:** добавьте имя созданных виртуальных коммутаторов. Для виртуального коммутатора управления оставьте значение по умолчанию. Сценарий развертывания создаст виртуальный коммутатор управления в начале развертывания и удалит его после завершения развертывания.

- **ManagementIPPrefix:** ManagementIPPrefix в разделе "Сеть" должен быть подсети, отличаемой от других внутренних IPs. Например, как показано значение по умолчанию, ManagementIPPrefix — 192.168.213.0, а AD IPAddress — 192.168.0.238.

    Сценарии развертывания создают сетевой адаптер управления на каждой виртуальной машине, назначают IP-адрес управления и подключают его к виртуальному коммутатору управления. Это позволяет серверу-хост-серверу подключаться к каждой виртуальной машине и управлять ими через эту сеть управления. Виртуальный коммутатор управления удаляется после завершения развертывания.

- **Конфигурации базовой VM:** Параметры в этом разделе должны быть настроены для cmdlet **Convert-CcIsoToVhdx.**

    Во время подготовки образа базовой ВМ базовая VM будет подключена к внутреннему сетевому коммутатору. Для доступа к Интернету для ВМ критически важны следующие параметры:

  - [Common] BaseVMIP: IP-адрес corpnet, который будет назначен базовой ВМ.

  - [Сеть] CorpnetDefaultGateway: шлюз по умолчанию, который должен быть назначен базовой ВМ.

  - [Сеть] CorpnetDNSIPAddress: IP-адрес DNS, который будет назначен базовой ВМ.

  - [Сеть] WSUSServer: IP-адрес службы обновления Windows Server.

  - [Сеть] WSUSStatusServer: IP-адрес сервера состояния службы обновления Windows Server.

  - [Сеть] EnableReferSupport: определяет, включена ли поддержка SIP REFER в конфигурации магистрали для IP/УАПС.

- **Внутренние IPs:**

  - Убедитесь, что маска подсети CorpnetIPPrefixLength правильна.

  - Убедитесь, что для этих внутренних IP-адресов нет конфликтов.

- **Внешние IPs:**

  - Для общедоступных IP-адресов MR: укажите externalMRIPs для без NAT или ExternalMRPublicIPs для NAT.

  - ExternalSIPIPs и ExternalMRIPs могут быть одинаковыми.

  - Убедитесь, что маска подсети InternetIPPrefixLength правильна.

  - Убедитесь, что для этих внешних IP-адресов нет конфликтов.

- **Шлюзы:**

  - Если имеется только один шлюз, удалите раздел для дополнительного шлюза. Если у вас более двух шлюзов, создайте дополнительные разделы, скопируйте и в конце в pasting существующий шлюз, а затем обновив его.

  - Убедитесь, что IP-адрес и порт шлюзов верны.

  - Для поддержки высокого уровня высокого уровня шлюза STN оставьте дополнительный шлюз и добавьте все дополнительные шлюзы, которые вы будете использовать. Вы можете скопировать и вкопировать существующую запись, а затем обновить ее.

- При желании вы можете обновить значение LocalRoute, чтобы ограничить номера исходящие вызовы.

## <a name="download-the-bits-to-the-site-directory"></a>Скачивание битов в каталог сайтов

Чтобы скачать файлы сведений о битах и версиях в каталог сайтов, запустите следующий **cmdlet:**

```powershell
Start-CcDownload
```

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

## <a name="prepare-base-virtual-disk-vhdx-from-the-downloaded-iso-file"></a>Подготовка базового виртуального диска (VHDX) из скачаного ISO-файла

На этом этапе подготавливается файл виртуального жесткого диска (VHDX) из isO-образа Windows Server 2012. VHDX будет использоваться для создания виртуальных машин во время развертывания. Будет создана временная виртуальная машина (базовая виртуальная машина), а windows Server 2012 будет установлена из ISO-файла. После создания ВМ будут установлены некоторые необходимые компоненты и будет применено последнее обновление Windows. В конце базовой виртуальной виртуальной модели будут обобщены (sysprep) и очищены, оставив только созданный файл виртуального диска.

> [!NOTE]
> Этот шаг необходимо выполнить только для первого устройства. 

Прежде чем приступить к этому шагу, убедитесь, что коммутатор corpnet создан. Кроме того, необходимо подтвердить правильную настройку следующих параметров в CloudConnector.ini файла:

- [Сеть] CorpnetSwitchName

- [Common] BaseVMIP

- [Сеть] CorpnetIPPrefixLength

- [Сеть] CorpnetDefaultGateway

- [Сеть] CorpnetDNSIPAddress

Запустите консоль PowerShell от учетной записи администратора и запустите следующий cmdlet, чтобы преобразовать ISO-образ в виртуальный жесткий диск (VHD):

```powershell
Convert-CcIsoToVhdx -IsoFilePath <Windows ISO File Path, including file name>
```

Укажите полный путь, включая имя файла, к ISO-образу. Например: C:\ISO\WindowsServer2012R2.iso.

Созданный VHD-файл хранится в папке **Каталог сайта** \Bits\VHD. Путь к каталогу  сайтов можно получить с помощью **get-CcSiteDirectory.**

> [!IMPORTANT]
> По умолчанию параметры прокси-сервера не настроены на базовой ВМ. Если для обновления ВМ с помощью Обновления Windows в сетевой среде требуется прокси-сервер, следует добавить переключатель -PauseBeforeUpdate при запуске "Convert-CcIsoToVhdx". Сценарий будет приостановлен до обновления Windows, и вы сможете вручную настроить прокси-сервер на VM. После настройки прокси-сервера и доступа к Интернету можно возобновить сценарий, чтобы выполнить оставшиеся действия. 

### <a name="create-vhds-for-a-multi-site-deployment"></a>Создание VHD для развертывания с несколькими сайтами

Это необязательный шаг, который применяется только к развертываниям с несколькими сайтами.

При развертывании развертывания с несколькими сайтами нет необходимости преобразовывать ISO в VHD для каждого сайта. Можно скопировать VHDX, созданный для первого сайта, на сервер узла для второго сайта.

 Скопируйте файл в то же расположение файла (папка **Каталог** сайта \Bits\VHD) и с тем же именем файла на сервере узла для дополнительного сайта.

## <a name="set-the-powershell-execution-policy-to-remotesigned"></a>Присвоение политике выполнения PowerShell удаленной подписи

Предоставленные сценарии PowerShell требуют, чтобы политика выполнения была установлена как RemoteSigned. Чтобы увидеть текущий параметр, откройте консоль PowerShell от учетной записи администратора и запустите следующий cmdlet:

```powershell
Get-ExecutionPolicy
```

Если для него не установлено "RemoteSigned", запустите следующий cmdlet, чтобы изменить его:

```powershell
Set-ExecutionPolicy RemoteSigned
```

## <a name="change-local-group-policy-on-the-host-machine-versions-141-and-earlier"></a>Изменение локальной групповой политики на хост-компьютере (версии 1.4.1 и более ранние)

> [!NOTE]
> Эта задача не требуется для Cloud Connector версий 1.4.2 и более поздних версий. 

Учетная запись CceService создается во время развертывания Skype для бизнеса Cloud Connector Edition. Она запускает службу управления Cloud Connector и требует разрешения на cloudconnector.msi. Необходимо изменить параметр групповой политики на хост-компьютере Cloud Connector, чтобы указать, что реестр пользователей не должен быть выгружен при выключении пользователя. Выполните следующие действия:

### <a name="to-change-the-group-policy-setting"></a>Изменение параметра групповой политики

1. Откройте редактор **групповой политики,** задав gpedit.msc.

2. В редакторе групповой политики перейдите в меню "Административные шаблоны > Системные > UserProfile > Не выгружать реестр пользователей принудительно при отображении пользователя. 

3. Установите для нее значение **Enabled**.

## <a name="set-up-your-microsoft-365-or-office-365-organization"></a>Настройка организации Microsoft 365 или Office 365

Требуется организация Microsoft 365 или Office 365 со Skype для бизнеса Online и телефонной системой. Перед попыткой использовать Cloud Connector убедитесь, что клиент настроен и настроен.

Некоторые действия по настройке Microsoft 365 и Office 365 требуют использования удаленной службы PowerShell клиента (TRPS) для настройки организации Microsoft 365 или Office 365. **Его следует установить на сервере хост-сервера.** Вы можете скачать модуль Skype для бизнеса Online для PowerShell на сайте: Skype для бизнеса [Online, Windows PowerShell Module.](https://www.microsoft.com/download/details.aspx?id=39366)

Создайте выделенную учетную запись администратора Skype для бизнеса для управления Cloud Connector online, например CceOnlineManagmentAdministrator. Эта учетная запись будет использоваться устройством для добавления или удаления устройства, включить или отключить автоматическое обновление ОС, включить или отключить автоматическое двоичное обновление. Установите для этой учетной записи пароль без срока действия, чтобы не изменять его для службы каждый раз, когда истекает срок действия.


