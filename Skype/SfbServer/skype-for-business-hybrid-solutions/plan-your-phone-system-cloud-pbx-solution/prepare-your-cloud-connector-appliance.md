---
title: Подготовка устройства Cloud Connector
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 2/15/2018
audience: ITPro
ms.topic: conceptual
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.collection:
- Strat_SB_Hybrid
ms.custom: ''
ms.assetid: 6eacfa99-9759-4c13-aca3-8992c2ff2710
description: Узнайте, как подготовить ваше управляющее устройство для работы с облачным соединителем для развертывания и использования в телефонной системе Office 365 (облачная УАТС).
ms.openlocfilehash: 779cb53dd19d627d8864da65e3e41f5d6dabee99
ms.sourcegitcommit: fe274303510d07a90b506bfa050c669accef0476
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/09/2020
ms.locfileid: "41001949"
---
# <a name="prepare-your-cloud-connector-appliance"></a>Подготовка устройства Cloud Connector

Узнайте, как подготовить ваше управляющее устройство для работы с облачным соединителем для развертывания и использования в телефонной системе Office 365 (облачная УАТС).

В этом разделе описывается, как получить файлы установки Skype для бизнеса Cloud Connector Edition, установить программное обеспечение Cloud Connector и подготовить устройство Cloud Connector к развертыванию. После выполнения всех шагов, которые приводятся в этом разделе, вы будете готовы к развертыванию Cloud Connector для одного или нескольких сайтов. Если у вас есть развертывание облачного соединителя и вы еще не обновили версию 2,1 в облаке, ознакомьтесь со сведениями [о переходе на новую версию облачного соединителя](upgrade-to-a-new-version-of-cloud-connector.md).

> [!NOTE]
> Корпорация Майкрософт выпускает текущую версию Cloud Connector Edition версии 2,1. Если у вас настроено автоматическое обновление, Cloud Connector обновится автоматически. Если вы настроили обновление вручную, вам потребуется выполнить обновление до версии 2,1 в течение 60 дней выпуска. Корпорация Майкрософт будет поддерживать прежнюю версию в течение 60 дней после выпуска 2,1, чтобы можно было выполнить обновление. 

> [!NOTE]
> Для облачного соединителя версии 2,1 и более поздних версий на устройстве узла должно быть установлено приложение .NET Framework 4.6.1 или более поздней версии. 

> [!IMPORTANT]
> При успешном развертывании при запуске командлетов для настройки Skype для бизнеса Cloud Connector Edition всегда используйте тот же консольный сеанс, что и у вас, с которого вы начали. Не рекомендуется переключаться на другие сеансы в процессе развертывания и настройки. 

> [!NOTE]
> Некоторые шаги выполняются только для первого устройства в развертывании: создание общего каталога сайта, загрузка необходимых компонентов и подготовка файла виртуального жесткого диска (VHDX) на основе ISO-образа Windows Server. 

## <a name="download-the-skype-for-business-cloud-connector-edition-installer"></a>Загрузка установщика Skype для бизнеса Cloud Connector Edition

1. На сервере узла, на котором будут запускаться виртуальные машины облачного соединителя, скачайте установочные файлы: [https://aka.ms/CloudConnectorInstaller](https://aka.ms/CloudConnectorInstaller). 

    > [!IMPORTANT]
    > Во время установки Cloud Connector сервер узла должен иметь доступ к Интернету, так как ему потребуется скачивать дополнительные файлы. 

2. Запустите установщик и примите значения по умолчанию во время установки.

3. Убедитесь, что установка завершилась успешно.

## <a name="verify-the-installation-and-configure-the-environment"></a>Проверка установки и настройка среды

1. Откройте консоль PowerShell с правами администратора и убедитесь, что командлеты Skype для бизнеса Cloud Connector доступны с помощью следующего командлета:

   ```powershell
   Get-Command *-Cc*
   ```

    Команда должна возвращать список командлетов для Skype для бизнеса Cloud Connector Edition.

2. Файлы VHD, SfBBits и VersionInfo будут храниться в **каталоге сайтов**.

    Чтобы узнать расположение **каталога веб-сайтов**, запустите следующий командлет:

   ```powershell
   Get-CcSiteDirectory
   ```

    Команда должна вернуть расположение в вашей файловой системе. Это может быть локальная или общая папка. Расположение **каталога веб-сайтов** по умолчанию: %USERPROFILE%\CloudConnector\SiteRoot. На первом устройстве, созданном на каждом сайте, в качестве расположения по умолчанию следует указать общую папку.

    Необходимо выбрать следующее местоположение:

   - Создается на первом устройстве, создаваемом для каждого сайта.

   - Общая папка, доступная другим серверам узла (устройства) в рамках того же сайта.

     Чтобы выбрать для **каталога сайтов** расположение, отличное от заданного по умолчанию, выполните следующий командлет:

   ```powershell
   Set-CcSiteDirectory <UNC File path>
   ```

    При развертывании высокой доступности для сайта убедитесь, что командлет задает одинаковое расположение **каталога сайтов** на каждом сервере узла сайта.

    При входе в систему и развертывании на каждом устройстве на сайте убедитесь в том, что текущая учетная запись имеет право доступа к **каталогу сайта**.

3. **Каталог Appliance** — это локальный рабочий корневой каталог для Skype для бизнеса Cloud Connector Edition, а также расположение, в котором хранятся внешние сертификаты, экземпляры и журналы. Расположение по умолчанию: %USERPROFILE%\CloudConnector\ApplianceRoot.

    Чтобы узнать расположение **каталога устройств**, запустите следующий командлет:

   ```powershell
   Get-CcApplianceDirectory
   ```

    Чтобы выбрать для **каталога устройств** расположение, отличное от заданного по умолчанию, выполните следующий командлет:

   ```powershell
   Set-CcApplianceDirectory <File path>
   ```

    В качестве каталога устройства необходимо задать локальную папку на устройстве. Вы должны настроить **каталог устройства** только перед запуском развертывания Skype для бизнеса Cloud Connector Edition. Если изменить его после развертывания, потребуется выполнить развертывание сервера узла снова.

    > [!IMPORTANT]
    > Путь к **каталогу устройств** не должен содержать пробелы.

## <a name="set-the-path-for-the-external-edge-certificate"></a>Задайте путь к внешнему сертификату пограничного компонента

- Выполните следующий командлет, чтобы задать путь с именем файла к внешнему сертификату пограничного компонента. Пример: C:\certs\cce\ap.contoso.com.pfx. Сертификат должен содержать закрытые ключи.

  ```powershell
  Set-CcExternalCertificateFilePath -Path <Full path to External certificate, including file name> -Target EdgeServer
  ```

    > [!NOTE]
    > Обратите внимание, что параметр -Target относится к версии 1.4.2 и более поздним версиям. 

    Укажите полный путь к внешнему сертификату, включая имя файла. Сертификат может храниться как локально, так и в общей папке. Если сертификат хранится в общей папке, она должна создаваться на первом устройстве для каждого сайта и должна быть доступна другим устройствам, принадлежащим тому же сайту. Этот командлет копирует внешний сертификат в **каталог устройства**.

    > [!IMPORTANT]
    > **Если вы обновили Cloud Connector до версии 1.4.2 или более поздней версии**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи и полную цепочку сертификатов, включая корневые и промежуточные сертификаты ЦС. **Если вы еще НЕ выполнили обновление Cloud Connector до версии 1.4.2**, убедитесь, что подготовленный внешний сертификат содержит закрытые ключи. Такой внешний сертификат должен быть выдан центром сертификации, который по умолчанию является доверенным в Windows.

## <a name="set-the-path-for-the-external-pstn-gatewaysbc-certificate"></a>Задайте путь к внешнему сертификату шлюза ТСОП/SBC

Если между сервером-посредником и шлюзом ТСОП/SBC используется протокол TLS, выполните следующий командлет, чтобы задать путь с именем файла к сертификату шлюза. Например: К:\цертс\кце\сбк.Контосо.ком.цер. Этот сертификат должен содержать корневой ЦС и промежуточную цепочку для сертификата, назначенного шлюзу:

```powershell
Set-CcExternalCertificateFilePath -Path <Full path to gateway certificate, including file name> -Target MediationServer 
```

> [!NOTE]
> Обратите внимание, что параметр -Target относится к версии 1.4.2 и более поздним версиям. 

## <a name="create-virtual-switches-in-hyper-v-manager"></a>Создание виртуальных коммутаторов в диспетчере Hyper-V

1. Откройте**Диспетчер виртуальных коммутаторов** **Hyper-V Manager** > и выберите **новый диспетчер виртуальных коммутаторов**.

2. Создайте внешний виртуальный коммутатор и привяжите его к физическому сетевому адаптеру, который подключен к домену внутренней сети:

    Установите для этого виртуального коммутатора флажок **Разрешить операционной системе управления общий доступ к этому сетевому адаптеру**.

3. Создайте внешний виртуальный коммутатор и свяжите его с физическим сетевым адаптером, который пересылается в Интернет:

    Снимите флажок **Разрешить управление операционной системой, чтобы предоставить общий доступ к сетевому адаптеру** для этого виртуального коммутатора.

4. Укажите имя коммутатора, соединяющего демилитаризованную сеть с доменом внутренней сети **SFB кце**.

    Укажите имя коммутатора, соединяющего демилитаризованную сеть с Интернет- **SFB кце Интернет-коммутатором**.

## <a name="update-the-cloudconnectorini-configuration-file"></a>Изменение файла конфигурации CloudConnector.ini

Подготовьте файл Клаудконнектор. ini, воспользовавшись собранными данными, чтобы [определить параметры развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе [план для Skype для бизнеса Cloud Connector Edition](plan-skype-for-business-cloud-connector-edition.md) .

Чтобы изменить файл, сначала выполните следующий командлет, чтобы получить пример шаблона (CloudConnector.Sample.ini):

```powershell
Export-CcConfigurationSampleFile
```

Пример шаблона хранится в **каталоге устройств**.

Изменив файл с помощью значений для своей среды, сохраните его как CloudConnector.ini в **каталоге устройств**. Чтобы определить путь к **каталогу устройств**, можно выполнить командлет **Get-CcApplianceDirectory**.

При внесении изменений в INI-файл учтите следующие аспекты.

> [!NOTE]
> В этом разделе рассматриваются не все значения для ini-файла, и здесь рассматриваются только те, которые связаны с особыми аспектами. Полный список можно найти в разделе [Определение параметров развертывания](plan-skype-for-business-cloud-connector-edition.md#BKMK_SiteParams) в разделе [планирование для облачной версии Skype для бизнеса Cloud Connector Edition](plan-skype-for-business-cloud-connector-edition.md) . Дополнительные сведения о том, какие значения необходимо изменить для добавления дополнительных устройств или сайтов, см. в разделе[Сравнение развертывания отдельного сайта с высокой доступностью и развертывания с несколькими сайтами](deploy-multiple-sites-in-cloud-connector.md#BKMK_SingleSitecomparedtomulti-site) статьи[Deploy multiple sites in Cloud Connector](deploy-multiple-sites-in-cloud-connector.md) . 

- **SiteName**. По умолчанию имеет значение **Site1**. Это значение необходимо обновить до начала развертывания Cloud Connector, поскольку при выполнении командлета **Register-CcAppliance** для регистрации устройства на существующем или новом сайте значение **SiteName** будет использоваться командлетом для определения сайта, который требуется зарегистрировать.

     Если вы хотите зарегистрировать устройство на новом сайте, значение **SiteName** должно быть уникальным и отличаться от существующих сайтов. Если вы хотите зарегистрировать устройство на существующем сайте, значение **SiteName** в ini-файле должно совпадать с именем, определенным в конфигурации клиента Office 365. Если вы копируете файл конфигурации с одного сайта на другой, для каждого сайта необходимо соответствующим образом обновить значение **SiteName**.

- **ServerName**. Имя сервера не должно содержать имя домена и должно иметь длину не более 15 символов. 

- **Хардваретипе:** Если вы не задаете значение null, используется значение по умолчанию **Normal** . Если вы планируете развернуть более крупную версию облачного соединителя для поддержки 500 одновременных звонков на компьютер, как описано в разделе [планирование в облаке Skype для бизнеса Cloud Edition](plan-skype-for-business-cloud-connector-edition.md), используйте значение **Normal** . Для меньших развертываний, в которых поддерживается до 50 параллельных звонков, следует использовать значение **Минимум**.

- **Виртуальные коммутаторы для Интернета и корпоративной сети/управления:**: добавьте имена созданных вами виртуальных коммутаторов. Для виртуального коммутатора управления оставьте значение по умолчанию. Сценарий развертывания создаст виртуальный коммутатор управления в начале развертывания и удалит его после завершения развертывания.

- **ManagementIPPrefix**. Префикс ManagementIPPrefix в разделе Network (Сеть) должен принадлежать к подсети, к которой не принадлежат другие внутренние IP-адреса. Например, как указано в значении по умолчанию, значение параметра ManagementIPPrefix — 192.168.213.0, а AD IPAddress — 192.168.0.238.

    Сценарии развертывания создают сетевой адаптер управления на каждой виртуальной машине, назначают ему IP-адрес управления и подключают его к виртуальному коммутатору управления. Это позволяет серверу узла подключаться к виртуальным машинам и управлять ими с помощью этой сети управления. Виртуальный коммутатор управления удаляется после завершения развертывания.

- **Специальные конфигурации** для базовой виртуальной машины. В этом разделе настраиваются **Convert-CcIsoToVhdx** параметры для командлета .

    При подготовке образа базовой виртуальной машины эта машина будет подключена к коммутатору внутренней сети. Следующие ключевые параметры необходимы для обеспечения доступа виртуальной машины к Интернету:

  - [Common]BaseVMIP — IP-адрес корпоративной сети, назначаемый базовой виртуальной машине.

  - [Network]CorpnetDefaultGateway — шлюз по умолчанию, назначаемый базовой виртуальной машине.

  - [Network]CorpnetDNSIPAddress — IP-адрес DNS, назначаемый базовой виртуальной машине.

  - [Network]WSUSServer — IP-адрес службы Windows Server Update Service (WSUS)

  - [Network]WSUSStatusServer — IP-адрес сервера состояния WSUS.

  - [Network]EnableReferSupport — параметр, определяющий, включена ли поддержка SIP REFER в конфигурации магистрали для IP/УАТС.

- **Внутренние IP-адреса**

  - Убедитесь, что Корпнетиппрефиксленгс маска подсети задана правильно.

  - Убедитесь в отсутствии конфликтов IP для этих внутренних IP-адресов.

- **Внешние IP-адреса**

  - Для общедоступного IP-адреса MR: укажите либо Екстерналмрипс, не NAT, либо ЕкстерналмрпублиЦипс для NAT.

  - Екстерналсипипс и Екстерналмрипс могут быть одинаковыми.

  - Убедитесь, что Интернетиппрефиксленгс маска подсети задана правильно.

  - Убедитесь в отсутствии конфликтов IP для этих внешних IP-адресов.

- **Шлюзы**.

  - Если у вас только один шлюз, удалите раздел для второго шлюза. Если вы используете несколько шлюзов, для создания дополнительных разделов скопируйте существующий раздел и измените данные в нем соответствующим образом.

  - Убедитесь, что IP-адрес и порт шлюза(-ов) указаны правильно.

  - Чтобы обеспечить поддержку высокой доступности на уровне шлюза ТСОП, оставьте второй шлюз и добавьте необходимые для работы дополнительные шлюзы. Вы можете скопировать и вставить существующий элемент, а затем обновить его.

- При необходимости вы можете изменить значение Локалрауте, чтобы ограничить исходящие номера звонка.

## <a name="download-the-bits-to-the-site-directory"></a>Загрузка BITS-файлов в каталог сайтов

Выполните следующий командлет, чтобы скачать файлы компонентов и сведений о версии в **каталог сайта**:

```powershell
Start-CcDownload
```

> [!NOTE]
> Этот шаг необходимо выполнять только для первого устройства. 

## <a name="prepare-base-virtual-disk-vhdx-from-the-downloaded-iso-file"></a>Подготовьте базовый виртуальный диск (VHDX) на основе скачанного ISO-файла

В рамках этой процедуры мы подготовим файл виртуального жесткого диска (VHDX) на основе ISO-образа Windows Server 2012. VHDX-файл будет использоваться для создания виртуальных машин во время развертывания. Будет создана временная виртуальная машина (базовая ВИРТУАЛЬная машина) и Windows Server 2012 будет установлена из файла ISO. После создания виртуальной машины потребуется установить некоторые обязательные компоненты и применить последние обновления Windows. И наконец, мы выполним подготовку базовой виртуальной машины к использованию (sysprep) и очистим ее, оставив только созданный файл виртуального диска.

> [!NOTE]
> Этот шаг необходимо выполнять только для первого устройства. 

Прежде чем переходить к этой процедуре, убедитесь, что создан коммутатор корпоративной сети. Кроме того, проверьте правильность настройки следующих параметров в файле CloudConnector.ini:

- [Network]CorpnetSwitchName

- [Common]BaseVMIP

- [Network]CorpnetIPPrefixLength

- [Network]CorpnetDefaultGateway

- [Network]CorpnetDNSIPAddress

Запустите консоль PowerShell от имени администратора и выполните следующий командлет, чтобы преобразовать ISO-образ в виртуальный жесткий диск (VHD):

```powershell
Convert-CcIsoToVhdx -IsoFilePath <Windows ISO File Path, including file name>
```

Укажите полный путь, включая имя файла, к ISO-образу. Например: C:\ISO\WindowsServer2012.iso.

Созданный файл виртуального жесткого диска хранится в папке \Битс\вхд **каталога сайтов** . Путь к **каталогу сайтов** можно получить, выполнив командлет **Get-CcSiteDirectory**.

> [!IMPORTANT]
> По умолчанию параметры прокси-сервера не настроены для базовой виртуальной машины. Если в сетевой среде требуется прокси-сервер для обновления виртуальной машины с помощью центра обновления Windows, необходимо добавить параметр-Паусебефореупдате при запуске "Convert-КЦисотовхдкс". Сценарий будет приостановлен до обновления Windows, и вы сможете вручную настроить прокси-сервер на виртуальной машине. После указания прокси-сервера (что позволит виртуальной машине получать доступ к Интернету) можно возобновить сценарий для выполнения оставшихся действий. 

### <a name="create-vhds-for-a-multi-site-deployment"></a>Создание VHD-файлов для развертывания с несколькими сайтами

Это дополнительная процедура, применимая только к многосайтовым развертываниям.

В развертывании такого типа нет необходимости преобразовать ISO в VHD для каждого сайта. Можно скопировать VHDX-файл, созданный для первого сайта, на узел сервера для второго сайта.

 Скопируйте файл в то же расположение ( **Каталог сайтов** \битс\вхд) и с тем же именем файла на сервере узла для дополнительного сайта.

## <a name="set-the-powershell-execution-policy-to-remotesigned"></a>Задание значения RemoteSigned для политики выполнения PowerShell

Указанные здесь сценарии PowerShell требуют, чтобы для политики выполнения было задано значение RemoteSigned. Чтобы узнать текущую настройку, откройте консоль PowerShell от имени администратора, а затем выполните следующий командлет:

```powershell
Get-ExecutionPolicy
```

Если значение RemoteSigned не задано, выполните этот командлет, чтобы изменить его:

```powershell
Set-ExecutionPolicy RemoteSigned
```

## <a name="change-local-group-policy-on-the-host-machine-versions-141-and-earlier"></a>Изменение локальной групповой политики на хост-компьютере (версии 1.4.1 и более ранние)

> [!NOTE]
> Эта задача не выполняется для Cloud Connector версии 1.4.2 и более поздних версий. 

Учетная запись CceService создается во время развертывания Skype для бизнеса Cloud Connector Edition. Она запускает облачную службу управления соединителем и требует разрешения на удаление клаудконнектор. msi. Необходимо изменить параметр групповой политики на хост-компьютере Cloud Connector, чтобы указать, что реестр пользователя не следует выгружать при выходе пользователя из системы. Следуйте инструкциям ниже.

### <a name="to-change-the-group-policy-setting"></a>Изменение параметра групповой политики

1. Откройте **Редактор групповой политики** , запустив gpedit. msc.

2. В **редакторе групповых политик** перейдите в раздел «Административные шаблоны» > «Система» > UserProfile > «Не выполнять принудительную выгрузку реестра пользователя при его выходе из системы».  

3. Установите для него значение **Enabled (включено**).

## <a name="set-up-your-office-365-tenant"></a>Настройка клиента Office 365

Клиент Office 365 с помощью Skype для бизнеса Online и телефонной системы в Office 365 является обязательным. Прежде чем использовать облачный соединитель, убедитесь, что вы настроили и настроили ваш клиент.

Некоторые действия по установке Office 365 требуют использования удаленной оболочки клиента PowerShell (ТРПС) для настройки клиента Office 365. **Ее необходимо установить на сервере узла.** Вы можете скачать модуль Skype для бизнеса Online для PowerShell из: [Skype для бизнеса Online, модуль Windows PowerShell](https://www.microsoft.com/en-us/download/details.aspx?id=39366).

Создайте специальную учетную запись администратора Skype для бизнеса для управления Интернет-соединителем, например Кцеонлинеманагментадминистратор. Эта учетная запись будет использоваться для добавления и удаления устройств, включения и отключения автоматического обновления ОС, включения и отключения автоматического обновления двоичных файлов. Задайте для этой учетной записи бессрочный пароль, чтобы упростить работу со службой.


