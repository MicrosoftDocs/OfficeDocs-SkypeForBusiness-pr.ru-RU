---
title: Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
ms.assetid: edf4a04c-d4c9-4c05-aacc-9e084618bb55
description: Ознакомьтесь с этой темой, чтобы узнать, как отслеживать развертывание облачной версии 2.1 и более позднее развертывание с помощью пакета управления операциями Майкрософт (OMS).
ms.openlocfilehash: 43ebfe689e113daa063a2ef2ed0d9b68a9d9d66a
ms.sourcegitcommit: 556fffc96729150efcc04cd5d6069c402012421e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2021
ms.locfileid: "58627731"
---
# <a name="monitor-cloud-connector-using-operations-management-suite-oms"></a>Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)

> [!Important]
> Cloud Connector Edition завершится 31 июля 2021 г. вместе с Skype для бизнеса Online. После обновления организации Teams, узнайте, как подключить локальной телефонной сети к Teams с помощью прямой [маршрутизации](/MicrosoftTeams/direct-routing-landing-page).

Ознакомьтесь с этой темой, чтобы узнать, как отслеживать развертывание облачной версии 2.1 и более позднее развертывание с помощью пакета управления операциями Майкрософт (OMS).

Теперь вы можете отслеживать развертывание облачной соединители версии 2.1 и более поздней версии с помощью пакета управления операциями (OMS) — решения для управления облачными ИТ-службами Майкрософт. OmS Log Analytics позволяет отслеживать и анализировать доступность и производительность ресурсов, включая физические и виртуальные машины. Дополнительные сведения о oms и log Analytics см. в обзоре [What is Operations Management Suite (OMS)?](/azure/operations-management-suite/operations-management-suite-overview)

В этом разделе содержатся следующие разделы:

- Необходимые условия

- Настройка облачного соединитетеля для использования OMS

- Настройка OMS

- Анализ оповещений в репозитории Log Analytics

- Рекомендуемый набор мониторинга

## <a name="prerequisites"></a>Необходимые условия

Прежде чем использовать OMS для мониторинга развертывания облачного соединитетеля, вам потребуется следующее:

- **Учетная запись Azure и рабочее пространство OMS.** Если у вас еще нет учетной записи Azure, необходимо создать ее для использования omS Log Analytics. Сведения о создании учетной записи Azure и создании рабочего пространства OMS см. в журнале [Get started with a Log Analytics workspace.](/azure/log-analytics/log-analytics-get-started)

- **Cloud Connector версии 2.1 или более поздней версии**

- **Для мониторинга облачного** соединитетеля необходим новый поиск журнала Log Analytics. Дополнительные сведения см. в [журнале Upgrade your Azure Log Analytics workspace to new log search.](/azure/log-analytics/log-analytics-log-search-upgrade)

## <a name="configure-cloud-connector-to-use-oms"></a>Настройка облачного соединитетеля для использования OMS

Вам потребуется настроить локальное окружение облачного соединитетеля для использования OMS. Для этого вам потребуется свой ИД рабочего пространства OMS и ключ, которые можно найти с помощью портала OMS следующим образом: Параметры-- Подключенные источники \> \> — Windows Серверы:

![Снимок экрана для OMS облачного соединитела](../../media/a4bb0a96-c940-435e-a3f5-5ef3062dea83.png)

Настройка облачного соединитетеля для использования OMS зависит от вашего сценария:

- **Если вы устанавливаете** новый прибор облачного соединителя или хотите повторно развернуть устройство, выполните следующие действия перед запуском Install-CcAppliance:

    1. В разделе CloudConnector.ini файл [Common] задай параметр OMSEnabled true.

        Каждый раз, когда облачный соединитатель развернут или обновлен, он будет пытаться установить агент OMS автоматически на VMs. Включи эту функцию, чтобы агент OMS выдержал автоматическое обновление облачного соединитетеля.

    2. Чтобы настроить oms ID и ключ, запустите Set-CcCredential-AccountType OMSWorkspace. 

- **Если вы устанавливаете** агент OMS на существующее устройство облачного соединителя, выполните следующие действия:

    1. В разделе CloudConnector.ini файл [Общие] установите OMSEnabled=true. 

    2. Запустите Import-CcConfiguration. 

    3. Запустите Install-CcOMSAgent. 

        > [!NOTE]
        > Если учетные данные OMSWorkspace никогда не задавались, вам будет предложено выполнить установку-CcOMSAgent. 

- **Если вы хотите обновить ID рабочего пространства OMS или ключ в устройстве облачного соединиттеля, который уже установил агент OMS:**

    1. Чтобы настроить oms ID и ключ, запустите Set-CcCredential-AccountType OMSWorkspace. 

    2. Чтобы применить обновления, запустите Install-CcOMSAgent. 

- **Во всех сценариях убедитесь, что агенты подключены следующим образом:**

    На портале OMS перейдите в Параметры — \> подключенные источники — \> Windows Серверы. Вы увидите список подключенных машин. 

## <a name="configure-oms"></a>Настройка OMS

Далее необходимо указать конфигурацию OMS с помощью портала OMS. В частности, необходимо:

- Укажите сведения о журналах событий и счетчиках производительности.

- Создание оповещений 

### <a name="specify-information-about-event-logs-and-performance-counters"></a>Укажите сведения о журналах событий и счетчиках производительности

На портале OMS необходимо указать сведения о журналах событий и счетчиках производительности следующим образом:

1. Перейдите Параметры- журналы событий Windows данных и добавьте журналы \> \> событий для: 

   - Lync Server

   - Для приложений

     > [!NOTE]
     > Необходимо вручную ввести Lync Server в текстовом окне. Он не появляется в качестве параметра в списке выпаданий. 

     Дополнительные сведения см. в Windows источниках данных журнала событий [в журнале Log Analytics.](/azure/log-analytics/log-analytics-data-sources-windows-events)

2. Перейдите Параметры- счетчики производительности Windows данных и добавьте счетчики \> \> производительности для: 

   - **Счетчики уровня ОС.** Можно добавить счетчики уровня ОС, такие как использование процессора, использование памяти, использование сети или использование существующих решений, таких как Capacity и Performance, Network Performance Monitor, без явного добавления счетчиков. Независимо от того, как вы решите отслеживать их, Корпорация Майкрософт рекомендует отслеживать эти счетчики ОС.

   - **Skype для бизнеса счетчики**. Существует множество счетчиков, предоставляемых Skype для бизнеса. Эти счетчики можно найти, войдя на любой сервер-посредник и открыв монитор производительности. Эти счетчики начинаются с "LS:". Корпорация Майкрософт рекомендует как минимум начинать со следующих счетчиков емкости и добавлять другие интересные:

     Общее количество активных вызовов:

       - LS:MediationServer — входящие вызовы \- (_Total) 

       - LS:MediationServer — исходящие вызовы \- (_Total) 

     Общее количество звонков об обхода активных средств массовой информации:

       - LS:MediationServer — входящие вызовы (_Total) \- активные вызовы обхода мультимедиа 

       - LS:MediationServer — исходящие вызовы (_Total) \- активные вызовы обхода мультимедиа 

     > [!NOTE]
     > Необходимо вручную ввести счетчики производительности в текстовом окне. Они не отображаются в качестве параметров в выпадаемом списке. 

     Дополнительные сведения см. в Windows и источниках данных о производительности [Linux в журнале Analytics](/azure/log-analytics/log-analytics-data-sources-performance-counters)

### <a name="create-alerts"></a>Создание оповещений

В OMS есть два типа оповещений: количество оповещений о результатах и оповещений об измерении показателей. Дополнительные сведения о создании оповещений см. в журнале [Working with alert rules in Log Analytics.](/azure/log-analytics/log-analytics-alerts-creating)

При создании оповещений следует учитывать следующее:

- Убедитесь, что оповещение является оповещением о количестве результатов, которое является выбором по умолчанию. 

- В демо-запросах требуется, чтобы "Количество результатов" было установлено как "Больше 0". 

- Рекомендуется установить периодичность времени и частоты оповещений до 5 минут. 

- Рекомендуется не включить "Подавления оповещений" для демонстрационных оповещений. 

- Для типичных сценариев оповещения Корпорация Майкрософт рекомендует создать пару оповещений: одно оповещение об ошибке и одно оповещение об сбросе. Для оповещений об ошибке выберите критический уровень серьезности; для оповещения об сбросе выберите информационный уровень серьезности .

В следующих разделах описано, как создавать примеры оповещений.

 **Создайте пару оповещений: "RTCMEDSRV не работает на серверах-посредниках" и "RTCMEDSRV снова запущен в серверах-посредниках"**

Чтобы создать эту пару оповещений:

- Запрос оповещения об ошибке:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003)  | summarize arg_max(TimeGenerated, EventID) by Computer | where EventID == 25003
  ```

    В запросе используется компьютерный *фильтр, в котором Компьютер содержит "MediationServer".* Фильтр выбирает только компьютер, имя которого содержит строку "MediationServer".

     Вы замените фильтр собственным компьютерным фильтром или просто удалите его. Можно создавать сложные фильтры строк без регулярных выражений. Дополнительные сведения см. в [стряхтовом операторе.](https://docs.loganalytics.io/docs/Language-Reference/Scalar-operators/String-operators) Вы также можете использовать регулярные выражения. Кроме того, можно создать компьютерную группу, сэкономив поисковый запрос и используя ее в качестве фильтра компьютера в запросе оповещений. Дополнительные сведения см. в [журнале Computer groups in Log Analytics.](/azure/log-analytics/log-analytics-computer-groups)

    Для каждого компьютера запрос об ошибке получит последний журнал событий как для запуска службы RTCMEDSRV, так и для остановки службы. Он возвращает один журнал, если последним событием является событие остановки службы; он не возвращает ничего, если последним событием является событие запуска службы. Короче говоря, запрос возвращает список серверов, RTCMEDSRV которых остановлен в окне времени. 

- Запрос для оповещений об сбросе:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003) | summarize arg_max(TimeGenerated, EventID) by Computer  | where EventID == 2500
  ```

    Запрос сброса делает ровно противоположное тому, что происходит с запросом об ошибке. Для каждого компьютера он возвращает одно событие, если последним событием является событие запуска службы; он не возвращает ничего, если последним событием является событие остановки службы.

**Создайте пару оповещений: "Слишком много одновременно вызовов в серверах-посредниках" и "Одновременное выполнение вызовов возвращается к нормальной нагрузке"**

Чтобы создать это предупреждение:

- Запрос оповещения об ошибке:

  ```Kusto
  Perf | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName == "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls >= 500
  ```

    На каждом компьютере запрос получит последние счетчики входящие вызовы и исходящие вызовы и суммирует эти два значения. Он возвращает один журнал, если значение суммы превышает 500; он ничего не возвращает, если этого не делается. Короче говоря, запрос возвращает список серверов, чьи одновременно вызовы слишком много в окне времени.

- Запрос для оповещений об сбросе:

  ```Kusto
  Perf  | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName ==  "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls < 500
  ```

    Запрос сброса делает ровно противоположное тому, что происходит с запросом об ошибке. На каждом компьютере запрос получит последние счетчики входящие вызовы и исходящие вызовы и суммирует эти два значения. Он возвращает один журнал, если значение суммы меньше 500; иначе ничего не будет возвращаться.

**Создание оповещений: "Использование \> ЦП 90 или RTCMEDIARELAY остановлено на серверах" оповещение**

Чтобы создать это оповещение, запрос:

```Kusto
search *| where Computer contains "MediationServer" | where (Type == "Perf" or Type == "Event") | where ((ObjectName ==  "Processor" and CounterName == "% Processor Time") or EventLog == "Lync Server") | where (CounterValue > 90 or EventID == 22003)
```

Запрос будет получать все счетчик использования процессора и событие остановки службы со всех компьютеров и возвращать один журнал, если использование процессора превышает 90% или служба когда-либо остановлена. 

## <a name="analyze-the-alerts-in-your-log-analytics-repository"></a>Анализ оповещений в репозитории Log Analytics

Для анализа оповещений в репозитории используйте решение Alert Management. Дополнительные сведения см. в решении Alert Management в пакете управления операциями [(OMS)](/azure/log-analytics/log-analytics-solution-alert-management)

## <a name="recommended-minimal-monitoring-set"></a>Рекомендуемый минимальный набор мониторинга

Определение проблем с журналами событий и счетчиками производительности: 

- **Журналы событий.** Для любой проблемы должна быть пара событий с одним набором событий, чтобы указать, что что-то не так, в то время как другой указывает, что все хорошо. Для любого определенного периода времени это последнее записанное событие, которое указывает, является ли что-то недопустимым для этого периода времени.

- **Счетчики производительности.** Для контрольных счетчиков должен быть порог.

В следующей таблице перечислены службы, которые Корпорация Майкрософт рекомендует контролировать, перечисляя стоп-и запуск ID событий:

|Имя службы  <br/> |Роль целевого сервера  <br/> |Stop Event ID  <br/> |Start Event ID  <br/> |
|:-----|:-----|:-----|:-----|
|RTCMEDSRV  <br/> |Сервер-посредник  <br/> |25003  <br/> |25002  <br/> |
|RTCSRV  <br/> |Пограничный сервер  <br/> |12289  <br/> |12288  <br/> |
|RTCMRAUTH  <br/> |Пограничный сервер  <br/> |19003  <br/> |19002  <br/> |
|RTCMEDIARELAY  <br/> |Пограничный сервер  <br/> |22003  <br/> |22002  <br/> |

В следующей таблице перечислены сетевые проблемы, которые корпорация Майкрософт рекомендует контролировать:


| Имя монитора  <br/>                                        | Роль целевого сервера  <br/> | Выражение ID событий успеха  <br/> | Выражение ID событий ошибки  <br/> | Пример отказа  <br/> |
|:-----------------------------------------------------------|:--------------------------|:-----------------------------------|:---------------------------------|:-----------------------|
| Сервер-посредник для сбоя подключения к шлюзу  <br/>    | Сервер-посредник  <br/>   | 25062                              |                                  | 25002  <br/>           |
| Сервер-посредник для сбоя завершения вызова шлюза  <br/> | Сервер-посредник  <br/>   | 25064                              |                                  | 25002  <br/>           |
| Критические сетевые проблемы  <br/>                           | Пограничный сервер  <br/>        | 14353                              |                                  | 12288  <br/>           |

Ниже перечислены счетчики емкости вызовов, которые необходимо отслеживать. Эти цифры должны быть меньше 500 для стандартного выпуска Cloud Connector; менее 50 для минимального выпуска cloud Connector.

- LS:MediationServer — входящие вызовы \- (_Total) 

- LS:MediationServer — исходящие вызовы \- (_Total) 

- LS:MediationServer — входящие вызовы (_Total) \- активные вызовы обхода мультимедиа

- LS:MediationServer — исходящие вызовы (_Total) \- активные вызовы обхода мультимедиа

## <a name="see-also"></a>См. также

Дополнительные сведения о работе с OMS см. в следующих сведениях:

- [Поиск данных с помощью поиска журналов в журнале Analytics](/azure/log-analytics/log-analytics-log-searches)

- [Языковая ссылка Azure Log Analytics](https://docs.loganalytics.io/docs/Language-Reference)

- [Понимание оповещений в журнале Analytics](/azure/log-analytics/log-analytics-alerts)

- [Подключение Windows для службы аналитики журналов в Azure](/azure/log-analytics/log-analytics-windows-agents)