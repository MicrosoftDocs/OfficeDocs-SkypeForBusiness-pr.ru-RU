---
title: Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.assetid: edf4a04c-d4c9-4c05-aacc-9e084618bb55
description: В этом разделе вы узнаете, как отслеживать развертывание Cloud Connector версии 2.1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).
ms.openlocfilehash: eca2f56bf564e376717a42bd8d297710905f8dc6
ms.sourcegitcommit: b424ab14683ab5080ebfd085adff7c0dbe1be84c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/03/2020
ms.locfileid: "47359095"
---
# <a name="monitor-cloud-connector-using-operations-management-suite-oms"></a>Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)

> [!Important]
> Выпуск Cloud Connector Edition завершится 31 июля 2021 г. вместе со Skype для бизнеса Online. После обновления вашей организации до Teams узнайте, как подключить свою локальной телефонной сети к Teams с помощью [прямой маршрутизации.](https://docs.microsoft.com/MicrosoftTeams/direct-routing-landing-page)

В этом разделе вы узнаете, как отслеживать развертывание Cloud Connector версии 2.1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).

Теперь вы можете отслеживать развертывание Cloud Connector версии 2.1 и более поздних версий с помощью Operations Management Suite (OMS), решения для управления облачными ИТ-ресурсами Майкрософт. Аналитика журналов OMS позволяет отслеживать и анализировать доступность и производительность ресурсов, включая физические и виртуальные машины. Дополнительные сведения об OMS и Log Analytics см. в подмносях "Что такое [Operations Management Suite (OMS)"?](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-overview)

В этом разделе содержатся следующие разделы:

- Предварительные условия

- Настройка Cloud Connector для использования OMS

- Настройка OMS

- Анализ оповещений в репозитории Log Analytics

- Рекомендуемый набор мониторинга

## <a name="prerequisites"></a>Предварительные условия

Прежде чем использовать OMS для отслеживания развертывания Cloud Connector, необходимо следующее:

- **Учетная запись Azure и рабочее пространство OMS.** Если у вас еще нет учетной записи Azure, ее необходимо создать, чтобы использовать аналитику журнала OMS. Сведения о создании учетной записи Azure и создании рабочей области OMS см. в записи "Начало работы с рабочей областью [Log Analytics".](https://docs.microsoft.com/azure/log-analytics/log-analytics-get-started)

- **Cloud Connector версии 2.1 или более поздней**

- **Для мониторинга Cloud Connector** требуется поиск в журнале Аналитика журналов. Дополнительные сведения см. в записи об обновлении рабочей области [Azure Log Analytics до поиска в новых журналах.](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-search-upgrade)

## <a name="configure-cloud-connector-to-use-oms"></a>Настройка Cloud Connector для использования OMS

Вам потребуется настроить облачную среду Connector для использования OMS. Для этого вам потребуется ваш ИД рабочей области OMS и ключ, которые можно найти на портале OMS следующим образом: Параметры -- Подключенные источники \> — \> Windows Servers:

![Снимок экрана для OMS Cloud Connector](../../media/a4bb0a96-c940-435e-a3f5-5ef3062dea83.png)

Настройка Cloud Connector для использования OMS зависит от вашего сценария:

- **Если вы устанавливаете новое** устройство Cloud Connector или хотите повторно развернуть его, выполните следующие действия перед запуском Install-CcAppliance:

    1. В разделе CloudConnector.ini [Common] установите для параметра OMSEnabled параметр True.

        При каждом развертывании или обновлении Cloud Connector будет пытаться автоматически установить агент OMS на ВМ. Включив эту функцию, агент OMS сможет выдержать автоматическое обновление Cloud Connector.

    2. Чтобы настроить ИД OMS и ключ, запустите Set-CcCredential -AccountType OMSWorkspace. 

- **При установке агента OMS** на существующее устройство Cloud Connector выполните следующие действия.

    1. В разделе CloudConnector.ini [Common] установите OMSEnabled=true. 

    2. Запустите import-CcConfiguration. 

    3. Запустите install-CcOMSAgent. 

        > [!NOTE]
        > Если учетные данные OMSWorkspace никогда не задавались, при запуске командной системы Install-CcOMSAgent вам будет предложено в этом случае в этом случае. 

- **Если вы хотите обновить ИД или ключ рабочей области OMS на устройстве Cloud Connector, на которое уже установлен агент OMS:**

    1. Чтобы настроить ИД OMS и ключ, запустите Set-CcCredential -AccountType OMSWorkspace. 

    2. Чтобы применить обновления, запустите install-CcOMSAgent. 

- **Для всех сценариев убедитесь, что агенты подключены следующим образом:**

    На портале OMS перейдите в "Параметры — \> подключенные источники — \> серверы Windows". Вы увидите список подключенных компьютеров. 

## <a name="configure-oms"></a>Настройка OMS

Затем необходимо указать конфигурацию OMS с помощью портала OMS. В частности, вам потребуется:

- Укажите сведения о журналах событий и счетчиках производительности.

- Создание оповещений 

### <a name="specify-information-about-event-logs-and-performance-counters"></a>Указание сведений о журналах событий и счетчиках производительности

На портале OMS необходимо указать сведения о журналах событий и счетчиках производительности следующим образом:

1. Перейдите в "Параметры- Журналы событий Windows" и добавьте \> \> журналы событий для: 

   - Lync Server

   - Для приложений

     > [!NOTE]
     > В текстовом поле необходимо вручную ввести Lync Server. Он не появляется в качестве параметра в выпадаемом списке. 

     Дополнительные сведения см. в источниках [данных журнала событий Windows в Log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-windows-events)

2. Перейдите в "Параметры" \> "Данные: \> счетчики производительности Windows" и добавьте счетчики производительности для: 

   - **Счетчики уровня ОС.** Можно добавить счетчики уровня ОС, такие как использование процессора, использование памяти, использование сети или использовать существующие решения, такие как емкость и производительность, сетевой монитор производительности без явного добавления счетчиков. Независимо от того, как вы решите отслеживать их, Майкрософт рекомендует отслеживать эти счетчики ОС.

   - **Счетчики Skype для бизнеса.** Skype для бизнеса предоставляет множество счетчиков. Эти счетчики можно найти, войдя на любой сервер-посредник и открыв монитор производительности. Эти счетчики начинаются со "LS:". Корпорация Майкрософт рекомендует как минимум начать со следующих счетчиков емкости и добавить другие счетчики, которые могут быть интересны:

     Общее количество активных вызовов:

       - LS:MediationServer — текущие входящие вызовы \- (_Total) 

       - LS:MediationServer — текущие исходящие вызовы \- (_Total) 

     Общее количество активных вызовов обхода мультимедиа:

       - LS:MediationServer — входящие вызовы (_Total) \- активные вызовы обхода мультимедиа 

       - LS:MediationServer — исходящие вызовы (_Total) \- Активные вызовы обхода мультимедиа 

     > [!NOTE]
     > В текстовом поле необходимо вручную ввести счетчики производительности. Они не отображаются в качестве параметров в выпадаемом списке. 

     Дополнительные сведения см. в источниках данных о производительности Windows и [Linux в log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-performance-counters)

### <a name="create-alerts"></a>Создание оповещений

В OMS существует два типа оповещений: количество оповещений о результатах и оповещения показателей. Дополнительные сведения о создании оповещений см. в анализе журнала "Работа с правилами [оповещений".](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts-creating)

При создании оповещений следует учитывать следующее:

- Убедитесь, что оповещение является оповещением "Число результатов", которое является выбором по умолчанию. 

- Для демонстрационных запросов требуется, чтобы для "Число результатов" было установлено "Больше 0". 

- Рекомендуется установить для окне времени и частоты оповещений 5 минут. 

- Не рекомендуется включить "Подавление оповещений" для демонстрационных оповещений. 

- Для типичных сценариев оповещений Корпорация Майкрософт рекомендует создать пару оповещений: одно оповещение об ошибке и одно оповещение о сбросе. Для оповещения об ошибке выберите "Критический уровень серьезности"; для оповещения о сбросе выберите "Информационный уровень серьезности".

В следующих разделах описывается создание примеров оповещений.

 **Создайте пару оповещений: "RTCMEDSRV НЕ работает на серверах-посредниках" и "RTCMEDSRV снова работает на серверах-посредниках"**

Чтобы создать эту пару оповещений:

- Запрос оповещения об ошибке:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003)  | summarize arg_max(TimeGenerated, EventID) by Computer | where EventID == 25003
  ```

    Запрос использует фильтр компьютера,  *где компьютер содержит "MediationServer"*  . Фильтр выбирает только компьютер, имя которого содержит строку "MediationServer".

     Необходимо заменить фильтр собственным фильтром компьютера или просто удалить его. Сложные строки можно создавать без регулярных выражений. Дополнительные сведения см. в [операторе String.](https://docs.loganalytics.io/docs/Language-Reference/Scalar-operators/String-operators) Вы также можете использовать регулярные выражения. Кроме того, можно создать группу компьютеров, сэкономив поисковый запрос и используя эту группу в качестве фильтра компьютера в запросе оповещения. Дополнительные сведения [см. в группах компьютеров при поиске в журнале Log Analytics.](https://docs.microsoft.com/azure/log-analytics/log-analytics-computer-groups)

    Для каждого компьютера запрос об ошибке получит последний журнал событий для запуска и остановки службы RTCMEDSRV. Он возвращает один журнал, если последним событием является событие остановки службы; Он не возвращает ничего, если последним событием является событие запуска службы. Одним словом, запрос возвратит список серверов, RTCMEDSRV которых остановлен в окне времени. 

- Запрос оповещения о сбросе:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003) | summarize arg_max(TimeGenerated, EventID) by Computer  | where EventID == 2500
  ```

    Запрос на сброс делает именно противоположное, что и запрос об ошибке. Для каждого компьютера он возвращает одно событие, если последним событием является событие запуска службы; Он не возвращает ничего, если последним событием является событие остановки службы.

**Создайте пару оповещений: "Слишком много одновременно звонков на серверах-посредниках" и "Одновременное выполнение вызовов возвращается к обычной нагрузке"**

Чтобы создать это оповещение:

- Запрос оповещения об ошибке:

  ```Kusto
  Perf | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName == "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls >= 500
  ```

    Для каждого компьютера запрос получит последние счетчики для входящий и исходящие вызовы и суммирует эти два значения. Он возвращает один журнал, если сумма превышает 500; Если этого не сделать, он не возвратит ничего. Одним словом, запрос возвратит список серверов, количество одновременно звонков которых слишком много в течение окне времени.

- Запрос оповещения о сбросе:

  ```Kusto
  Perf  | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName ==  "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls < 500
  ```

    Запрос на сброс делает именно противоположное, что и запрос об ошибке. Для каждого компьютера запрос получит последние счетчики для входящий и исходящие вызовы и суммирует эти два значения. Он возвращает один журнал, если сумма меньше 500; В противном случае ничего не будет возвращено.

**Создание оповещения: "Использование ЦП \> 90 или RTCMEDIARELAY остановлено на серверах"**

Чтобы создать это оповещение, запрос:

```Kusto
search *| where Computer contains "MediationServer" | where (Type == "Perf" or Type == "Event") | where ((ObjectName ==  "Processor" and CounterName == "% Processor Time") or EventLog == "Lync Server") | where (CounterValue > 90 or EventID == 22003)
```

Запрос будет получать все события счетчика использования процессора и остановки службы со всех компьютеров и возвращать один журнал, если использование процессора превышает 90 % или служба когда-либо останавливается. 

## <a name="analyze-the-alerts-in-your-log-analytics-repository"></a>Анализ оповещений в репозитории Log Analytics

Для анализа оповещений в репозитории используйте решение управления оповещениями. Дополнительные сведения см. в решении [управления оповещениями в Operations Management Suite (OMS)](https://docs.microsoft.com/azure/log-analytics/log-analytics-solution-alert-management)

## <a name="recommended-minimal-monitoring-set"></a>Рекомендуемый минимальный набор мониторинга

Чтобы выявить проблемы с журналами событий и счетчиками производительности: 

- **Журналы событий.** Для любой проблемы должна быть пара событий с одним набором событий, чтобы указать на то, что что-то не так, а с другой стороны, это означает, что все в порядке. Для любого заданного периода времени это последнее записанное событие, которое указывает, не является ли что-то недопустимым для этого периода времени.

- **Счетчики производительности.** Для отслеживаемой счетчики должно быть пороговое значение.

В следующей таблице перечислены службы, которые корпорация Майкрософт рекомендует контролировать, перечисляя ид событий остановки и запуска:

|Имя службы  <br/> |Роль целевого сервера  <br/> |Stop Event ID  <br/> |ИД события запуска  <br/> |
|:-----|:-----|:-----|:-----|
|RTCMEDSRV  <br/> |Сервер-посредник  <br/> |25003  <br/> |25002  <br/> |
|RTCSRV  <br/> |Пограничный сервер  <br/> |12289  <br/> |12288  <br/> |
|RTCMRAUTH  <br/> |Пограничный сервер  <br/> |19003  <br/> |19002  <br/> |
|RTCMEDIARELAY  <br/> |Пограничный сервер  <br/> |22003  <br/> |22002  <br/> |

В следующей таблице перечислены проблемы сети, которые корпорация Майкрософт рекомендует контролировать:


| Имя монитора  <br/>                                        | Роль целевого сервера  <br/> | Выражение "Success Event ID" (Событие успешной работы)  <br/> | Выражение error Event ID  <br/> | Пример сбоя  <br/> |
|:-----------------------------------------------------------|:--------------------------|:-----------------------------------|:---------------------------------|:-----------------------|
| Сбой подключения сервера-посредника к шлюзу  <br/>    | Сервер-посредник  <br/>   | 25062                              |                                  | 25002  <br/>           |
| Сбой завершения вызова между сервером-посредником  <br/> | Сервер-посредник  <br/>   | 25064                              |                                  | 25002  <br/>           |
| Критические проблемы с сетью  <br/>                           | Пограничный сервер  <br/>        | 14353                              |                                  | 12288  <br/>           |

Ниже перечислены счетчики емкости вызовов, которые необходимо отслеживать. Эти числа должны быть меньше 500 для выпуска Cloud Connector standard; менее 50 для минимального выпуска Cloud Connector.

- LS:MediationServer — текущие входящие вызовы \- (_Total) 

- LS:MediationServer — текущие исходящие вызовы \- (_Total) 

- LS:MediationServer — входящие вызовы (_Total) \- активные вызовы обхода мультимедиа

- LS:MediationServer — исходящие вызовы (_Total) \- Активные вызовы обхода мультимедиа

## <a name="see-also"></a>См. также

Дополнительные сведения о работе с OMS см. в следующих сведениях:

- [Поиск данных с помощью поиска в журнале Аналитика](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-searches)

- [Справочник по языку Azure Log Analytics](https://docs.loganalytics.io/docs/Language-Reference)

- [Понимание оповещений в log Analytics](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts)

- [Подключение компьютеров Windows к службе Log Analytics в Azure](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)


