---
title: Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
ms.assetid: edf4a04c-d4c9-4c05-aacc-9e084618bb55
description: В этом разделе описано, как отслеживать развертывание Облачного соединителя версии 2.1 и более поздних с помощью Microsoft Operations Management Suite (OMS).
ms.openlocfilehash: c10eac34e065ab76cb570a21752838c308b6afd8
ms.sourcegitcommit: 296862e02b548f0212c9c70504e65b467d459cc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2022
ms.locfileid: "65676511"
---
# <a name="monitor-cloud-connector-using-operations-management-suite-oms"></a>Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)

> [!Important]
> Выпуск Cloud Connector будет снят с учета 31 июля 2021 г. вместе с Skype для бизнеса Online. После обновления организации до Teams узнайте, как подключить локальную телефонную сеть к Teams с помощью прямой [маршрутизации](/MicrosoftTeams/direct-routing-landing-page).

В этом разделе описано, как отслеживать развертывание Облачного соединителя версии 2.1 и более поздних с помощью Microsoft Operations Management Suite (OMS).

Теперь вы можете отслеживать развертывание Cloud Connector версии 2.1 и более поздних с помощью Operations Management Suite (OMS) — решения для управления облачными ИТ-ресурсами Майкрософт. OmS Log Analytics позволяет отслеживать и анализировать доступность и производительность ресурсов, включая физические и виртуальные машины. Дополнительные сведения об OMS и Log Analytics см. в статье ["Что такое Operations Management Suite (OMS)"?](/azure/operations-management-suite/operations-management-suite-overview)

Этот раздел содержит следующие разделы:

- Предварительные требования

- Настройка Cloud Connector для использования OMS

- Настройка OMS

- Анализ оповещений в репозитории Log Analytics

- Рекомендуемый набор мониторинга

## <a name="prerequisites"></a>Предварительные требования

Прежде чем использовать OMS для мониторинга развертывания Cloud Connector, вам потребуется следующее:

- **Учетная запись Azure и рабочая область OMS.** Если у вас еще нет учетной записи Azure, необходимо создать ее для использования OMS Log Analytics. Сведения о том, как создать учетную запись Azure и настроить рабочую область OMS, см. начало работы [с рабочей областью Log Analytics](/azure/log-analytics/log-analytics-get-started).

- **Cloud Connector версии 2.1 или более поздней**

- **Для мониторинга Cloud Connector** требуется новый поиск по журналам Log Analytics. Дополнительные сведения см. в [статье об обновлении рабочей области Azure Log Analytics до нового поиска по журналам](/azure/log-analytics/log-analytics-log-search-upgrade).

## <a name="configure-cloud-connector-to-use-oms"></a>Настройка Cloud Connector для использования OMS

Вам потребуется настроить локальную среду Cloud Connector для использования OMS. Для этого вам потребуются идентификатор и ключ рабочей области OMS, которые можно найти на портале OMS следующим образом: Параметры --\>Connected Sources --\> Windows Servers:

![Снимок экрана: OMS облачного соединителя.](../../media/a4bb0a96-c940-435e-a3f5-5ef3062dea83.png)

Настройка Cloud Connector для использования OMS зависит от вашего сценария:

- **Если вы устанавливаете новое устройство Cloud Connector** или хотите повторно развернуть устройство, выполните следующие действия перед запуском Install-CcAppliance:

  1. В разделе CloudConnector.ini [Общие] задайте для параметра OMSEnabled значение True.

     При каждом развертывании или обновлении Cloud Connector он будет пытаться автоматически установить агент OMS на виртуальные машины. Включите эту функцию, чтобы агент OMS можно было выдержать автоматическое обновление Cloud Connector.

  2. Чтобы настроить идентификатор и ключ OMS, выполните Set-CcCredential -AccountType OMSWorkspace.

- **При установке агента OMS на существующее устройство Cloud Connector** выполните следующие действия.

  1. В разделе CloudConnector.ini [Common] задайте OMSEnabled=true.

  2. Запустите import-CcConfiguration.

  3. Запустите Install-CcOMSAgent.

     > [!NOTE]
     > Если учетные данные OMSWorkspace никогда не были заданы, при запуске install-CcOMSAgent вам будет предложено ввести учетные данные.

- **Если вы хотите обновить идентификатор или ключ рабочей области OMS на устройстве Cloud Connector, на котором уже установлен агент OMS:**

  1. Чтобы настроить идентификатор и ключ OMS, выполните Set-CcCredential -AccountType OMSWorkspace.

  2. Чтобы применить обновления, выполните командную строку Install-CcOMSAgent.

- **Во всех сценариях убедитесь, что агенты подключены следующим образом:**

    На портале OMS перейдите к разделу Параметры подключенных\> источников — Windows\> серверов. Вы увидите список подключенных компьютеров.

## <a name="configure-oms"></a>Настройка OMS

Далее необходимо указать конфигурацию OMS с помощью портала OMS. В частности, вам потребуется:

- Укажите сведения о журналах событий и счетчиках производительности.

- Создание оповещений

### <a name="specify-information-about-event-logs-and-performance-counters"></a>Указание сведений о журналах событий и счетчиках производительности

На портале OMS необходимо указать сведения о журналах событий и счетчиках производительности следующим образом:

1. Перейдите Параметры-data-Windows\>\> event logs и добавьте журналы событий для:

   - Lync Server

   - Приложение

     > [!NOTE]
     > В текстовом поле необходимо вручную ввести Lync Server. Он не отображается как параметр в раскрывающемся списке.

     Дополнительные сведения см[. в Windows данных журнала событий в Log Analytics.](/azure/log-analytics/log-analytics-data-sources-windows-events)

2. Перейдите Параметры-data-Windows\>\> производительности и добавьте счетчики производительности для:

   - **Счетчики уровня ОС**. Вы можете добавить счетчики уровня ОС, такие как использование процессора, использование памяти, использование сети или использовать существующие решения, такие как емкость и производительность, сетевые Монитор производительности без явного добавления счетчиков. Независимо от того, как вы решите отслеживать их, корпорация Майкрософт рекомендует отслеживать эти счетчики ОС.

   - **Skype для бизнеса счетчиков**. Существует множество счетчиков, предоставляемых Skype для бизнеса. Эти счетчики можно найти, войдите на любой сервер-посредник и откройте Монитор производительности. Эти счетчики начинаются с "LS:". Корпорация Майкрософт рекомендует начать со следующих счетчиков емкости как минимум и добавить другие, которые вас интересуют:

     Всего активных вызовов:

     - LS:MediationServer — текущие входящие вызовы (_Total)\-

     - LS:MediationServer — исходящие вызовы (_Total)\- Текущие

     Общее количество активных вызовов обхода сервера-посредника:

     - LS:MediationServer — входящие вызовы (_Total) Активные вызовы\- обхода сервера-посредника

     - LS:MediationServer — исходящие вызовы (_Total) Активные\- вызовы обхода сервера-посредника

     > [!NOTE]
     > В текстовом поле необходимо вручную ввести счетчики производительности. Они не отображаются как параметры в раскрывающемся списке.

     Дополнительные сведения см. [в Windows данных производительности и Linux в Log Analytics.](/azure/log-analytics/log-analytics-data-sources-performance-counters)

### <a name="create-alerts"></a>Создание оповещений

В OMS существует два типа оповещений: количество оповещений о результатах и оповещения об измерении метрик. Дополнительные сведения о создании оповещений см. в разделе ["Работа с правилами генерации](/azure/log-analytics/log-analytics-alerts-creating) оповещений" в Log Analytics.

При создании оповещений следует учитывать следующее:

- Убедитесь, что оповещение является оповещением "Число результатов", которое используется по умолчанию.

- Для демонстрационных запросов требуется, чтобы для параметра "Число результатов" было задано значение "Больше 0".

- Рекомендуется задать для интервала времени и частоты оповещений значение 5 минут.

- Рекомендуется не включить отключение оповещений для демонстрационных оповещений.

- Для типичных сценариев оповещений корпорация Майкрософт рекомендует создать пару оповещений: одно оповещение об ошибке и одно оповещение сброса. Для оповещения об ошибке выберите уровень серьезности "Критический"; Для оповещения о сбросе выберите информационный уровень серьезности.

В следующих разделах описывается создание примеров оповещений.

#### <a name="create-an-alert-pair-rtcmedsrv-is-not-running-in-mediation-servers-and-rtcmedsrv-is-back-in-running-in-mediation-servers"></a>Создайте пару оповещений: "RTCMEDSRV НЕ выполняется на серверах-посредниках" и "RTCMEDSRV снова запущен на серверах-посредниках"

Чтобы создать эту пару оповещений:

- Запрос оповещения об ошибке:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003)  | summarize arg_max(TimeGenerated, EventID) by Computer | where EventID == 25003
  ```

    В запросе используется фильтр компьютера  *, в котором "Компьютер" содержит "MediationServer"*  . Фильтр выбирает только компьютер, имя которого содержит строку MediationServer.

     Вы замените фильтр собственным фильтром компьютера или просто удалите его. Сложные строковые фильтры можно создавать без регулярных выражений. Вы также можете использовать регулярные выражения. Кроме того, можно создать группу компьютеров, сохранив поисковый запрос и используя ее в качестве фильтра компьютера в запросе оповещения. Дополнительные сведения см. в [разделе "Группы компьютеров" в поиске по журналам Log Analytics](/azure/log-analytics/log-analytics-computer-groups).

    Для каждого компьютера запрос на ошибку получает последний журнал событий как для запуска службы RTCMEDSRV, так и для остановки службы. Он возвращает один журнал, если последним событием является событие остановки службы; Он не вернет ничего, если последним событием является событие запуска службы. Вкратце, запрос вернет список серверов, RTCMEDSRV которых остановлен в окне времени.

- Запрос для оповещения о сбросе:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003) | summarize arg_max(TimeGenerated, EventID) by Computer  | where EventID == 2500
  ```

    Запрос сброса выполняет ровно противоположное действие запроса на ошибку. Для каждого компьютера он возвращает значение, если последним событием является событие запуска службы; Он не вернет ничего, если последним событием является событие остановки службы.

#### <a name="create-an-alert-pair--too-many-concurrent-calls-in-mediation-servers-and-concurrent-calls-fall-back-to-normal-load"></a>Создайте пару оповещений: "Слишком много одновременных вызовов на серверах-посредниках" и "Параллельные вызовы переходит к обычной нагрузке"

Чтобы создать это оповещение:

- Запрос оповещения об ошибке:

  ```Kusto
  Perf | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName == "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls >= 500
  ```

    Для каждого компьютера запрос получает последние счетчики для входящего и исходящего вызова и суммирует эти два значения. Он возвращает один журнал, если сумма превышает 500; в этом случае ничего не будет возвращено. Вкратце, запрос вернет список серверов, количество одновременных вызовов которых слишком велико в окне времени.

- Запрос для оповещения о сбросе:

  ```Kusto
  Perf  | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName ==  "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls < 500
  ```

    Запрос сброса выполняет ровно противоположное действие запроса на ошибку. Для каждого компьютера запрос получает последние счетчики для входящего и исходящего вызова и суммирует эти два значения. Он возвращает один журнал, если сумма меньше 500; в противном случае он не вернет ничего.

#### <a name="create-an-alert-cpu-usage--90-or-rtcmediarelay-stopped-in-servers-alert"></a>Создайте оповещение " \> Использование ЦП 90 или RTCMEDIARELAY остановлено на серверах"

Чтобы создать это оповещение, выполните следующий запрос:

```Kusto
search *| where Computer contains "MediationServer" | where (Type == "Perf" or Type == "Event") | where ((ObjectName ==  "Processor" and CounterName == "% Processor Time") or EventLog == "Lync Server") | where (CounterValue > 90 or EventID == 22003)
```

Запрос получает все счетчик использования процессора и событие остановки службы со всех компьютеров и возвращает один журнал, если использование процессора превышает 90 % или служба когда-либо остановлена.

## <a name="analyze-the-alerts-in-your-log-analytics-repository"></a>Анализ оповещений в репозитории Log Analytics

Для анализа оповещений в репозитории используйте решение для управления оповещениями. Дополнительные сведения см. в решении ["Управление оповещениями" в Operations Management Suite (OMS)](/azure/log-analytics/log-analytics-solution-alert-management)

## <a name="recommended-minimal-monitoring-set"></a>Рекомендуемый минимальный набор мониторинга

Чтобы выявить проблемы с журналами событий и счетчиками производительности, выполните указанные ниже действия.

- **Журналы событий.** Для любой проблемы должна быть пара событий с одним набором событий, указывающим на то, что что-то не так, а другая указывает, что все в коде хорошо. Для любого заданного периода времени это последнее записанное событие, указывающее, является ли что-то недопустимым для этого периода времени.

- **Счетчики производительности.** Для отслеживаемых счетчиков должно быть пороговое значение.

В следующей таблице перечислены службы, которые корпорация Майкрософт рекомендует выполнять мониторинг, перечисляя идентификаторы событий остановки и запуска:

|Имя службы  <br/> |Роль целевого сервера  <br/> |Stop Event ID  <br/> |Идентификатор события запуска  <br/> |
|:-----|:-----|:-----|:-----|
|RTCMEDSRV  <br/> |Сервер-посредник  <br/> |25003  <br/> |25002  <br/> |
|RTCSRV  <br/> |Пограничный сервер  <br/> |12289  <br/> |12288  <br/> |
|RTCMRAUTH  <br/> |Пограничный сервер  <br/> |19003  <br/> |19002  <br/> |
|RTCMEDIARELAY  <br/> |Пограничный сервер  <br/> |22003  <br/> |22002  <br/> |

В следующей таблице перечислены сетевые проблемы, рекомендуемые корпорацией Майкрософт для мониторинга.


| Имя монитора  <br/>                                        | Роль целевого сервера  <br/> | Выражение идентификатора события успешного выполнения  <br/> | Выражение идентификатора события ошибки  <br/> | Пример сбоя  <br/> |
|:-----------------------------------------------------------|:--------------------------|:-----------------------------------|:---------------------------------|:-----------------------|
| Сбой подключения сервера-посредника к шлюзу  <br/>    | Сервер-посредник  <br/>   | 25062                              |                                  | 25002  <br/>           |
| Сбой завершения вызова от сервера-посредника к шлюзу  <br/> | Сервер-посредник  <br/>   | 25064                              |                                  | 25002  <br/>           |
| Критические сетевые проблемы  <br/>                           | Пограничный сервер  <br/>        | 14353                              |                                  | 12288  <br/>           |

Ниже перечислены счетчики емкости вызовов, которые необходимо отслеживать. Эти числа должны быть меньше 500 для выпуска Cloud Connector Standard. Менее 50 для минимального выпуска Cloud Connector.

- LS:MediationServer — текущие входящие вызовы (_Total)\-

- LS:MediationServer — исходящие вызовы (_Total)\- Текущие

- LS:MediationServer — входящие вызовы (_Total) Активные вызовы\- обхода сервера-посредника

- LS:MediationServer — исходящие вызовы (_Total) Активные\- вызовы обхода сервера-посредника

## <a name="see-also"></a>См. также

Дополнительные сведения о работе с OMS см. в следующих статьях:

- [Поиск данных с помощью поиска по журналам в Log Analytics](/azure/log-analytics/log-analytics-log-searches)

- [Основные сведения об оповещениях в Log Analytics](/azure/log-analytics/log-analytics-alerts)

- [Подключение Windows компьютеры в службу Log Analytics в Azure](/azure/log-analytics/log-analytics-windows-agents)