---
title: Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.assetid: edf4a04c-d4c9-4c05-aacc-9e084618bb55
description: В этом разделе рассказывается, как отслеживать развертывание Cloud Connector версии 2,1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).
ms.openlocfilehash: eca2f56bf564e376717a42bd8d297710905f8dc6
ms.sourcegitcommit: b424ab14683ab5080ebfd085adff7c0dbe1be84c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/03/2020
ms.locfileid: "47359095"
---
# <a name="monitor-cloud-connector-using-operations-management-suite-oms"></a>Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)

> [!Important]
> Cloud Connector Edition выйдет 31 июля 2021 вместе со Skype для бизнеса Online. После обновления вашей организации до Teams Узнайте, как подключить локальную телефонную сеть к Teams с помощью [прямой маршрутизации](https://docs.microsoft.com/MicrosoftTeams/direct-routing-landing-page).

В этом разделе рассказывается, как отслеживать развертывание Cloud Connector версии 2,1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).

Теперь вы можете отслеживать развертывание Cloud Connector версии 2,1 и более поздней версии с помощью Operations Management Suite (OMS), решения для ИТ-управления в облаке Майкрософт. Анализ журналов OMS позволяет отслеживать и анализировать доступность и производительность ресурсов, включая физические и виртуальные машины. Для получения дополнительных сведений о OMS и службе анализа журналов посмотрите, [что представляет собой набор Operations Management Suite (OMS).](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-overview)

В этом разделе содержатся следующие разделы:

- Предварительные требования

- Настройка Cloud Connector для использования OMS

- Настройка OMS

- Анализ оповещений в репозитории анализа журналов

- Рекомендуемый набор мониторинга

## <a name="prerequisites"></a>Предварительные требования

Прежде чем вы сможете использовать OMS для мониторинга развертывания Cloud Connector, вам потребуются следующие компоненты:

- **Учетная запись Azure и Рабочая область OMS.** Если у вас еще нет учетной записи Azure, вам потребуется создать ее для использования службы анализа журналов OMS. Сведения о том, как создать учетную запись Azure и настроить рабочую область OMS, можно найти в статье [Начало работы с рабочей областью анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-get-started).

- **Cloud Connector версии 2,1 или более поздней**

- **Журнал анализа журналов** для мониторинга Cloud Connector необходим новый поиск журнала. Дополнительные сведения см. [в статье обновление рабочей области службы анализа журналов Azure до нового поиска в журнале](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-search-upgrade).

## <a name="configure-cloud-connector-to-use-oms"></a>Настройка Cloud Connector для использования OMS

Вам потребуется настроить локальную среду Cloud Connector для использования OMS. Для этого вам потребуется идентификатор и ключ вашей рабочей области OMS, которые можно найти с помощью портала OMS: Settings — \> подключенные источники — \> серверы Windows:

![Снимок экрана OMS для Cloud Connector](../../media/a4bb0a96-c940-435e-a3f5-5ef3062dea83.png)

Способ настройки Cloud Connector для использования OMS зависит от сценария.

- **Если вы устанавливаете новое устройство Cloud Connector или хотите повторно развернуть устройство**, выполните следующие действия перед выполнением командлета Install — CcAppliance:

    1. В разделе CloudConnector.ini файл [Common] задайте для параметра Омсенаблед значение true.

        Каждый раз, когда Cloud Connector разворачивается или обновляется, он попытается автоматически установить агент OMS на виртуальных машинах. Включите эту функцию, чтобы агент OMS мог продолжать автоматическое обновление Cloud Connector.

    2. Чтобы настроить идентификатор и ключ OMS, выполните командлет Set – CcCredential – AccountType Омсворкспаце. 

- **Если вы устанавливаете агент OMS на существующем устройстве Cloud Connector**, выполните следующие действия:

    1. В разделе CloudConnector.ini файл [Common] задайте Омсенаблед = true. 

    2. Выполните командлет Import – CcConfiguration. 

    3. Выполните командлет Install — Ккомсажент. 

        > [!NOTE]
        > Если учетные данные Омсворкспаце никогда не были заданы, при выполнении командлета Install — Ккомсажент вам потребуется ввести учетные данные. 

- **Если вы хотите обновить идентификатор или ключ рабочей области OMS на устройстве Cloud Connector, на котором уже установлен агент OMS, выполните следующие действия:**

    1. Чтобы настроить идентификатор и ключ OMS, выполните командлет Set – CcCredential – AccountType Омсворкспаце. 

    2. Чтобы применить обновления, выполните командлет Install – Ккомсажент. 

- **Для всех сценариев убедитесь, что агенты подключены следующим образом:**

    На портале OMS перейдите в раздел Параметры — \> подключенные источники — \> серверы Windows. Вы увидите список подключенных машин. 

## <a name="configure-oms"></a>Настройка OMS

Далее необходимо указать конфигурацию OMS с помощью портала OMS. В частности, необходимо выполнить следующие действия:

- Укажите сведения о журналах событий и счетчиках производительности.

- Создание оповещений 

### <a name="specify-information-about-event-logs-and-performance-counters"></a>Указание сведений о журналах событий и счетчиках производительности

На портале OMS необходимо указать сведения о журналах событий и счетчиках производительности следующим образом:

1. Перейдите в раздел Параметры — \> \> журналы событий Windows и добавьте журналы событий для: 

   - Lync Server

   - Для приложений

     > [!NOTE]
     > Необходимо вручную ввести Lync Server в текстовом поле. В раскрывающемся списке этот параметр не отображается. 

     Дополнительные сведения см. в статье " [Источники данных журнала событий Windows" в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-windows-events)

2. Выберите параметры — \> \> счетчики производительности Windows для данных и добавьте счетчики производительности для: 

   - **Счетчики уровня ОС**. Можно добавить счетчики уровня операционной системы, такие как использование процессора, использование памяти, использование сети, или можно использовать существующие решения, такие как производительность и производительность, сетевой монитор, не добавляя счетчики явным образом. Независимо от того, как вы решите отслеживать их, корпорация Майкрософт рекомендует отслеживать эти счетчики ОС.

   - **Счетчики Skype для бизнеса**. Skype для бизнеса предоставляет множество счетчиков. Эти счетчики можно найти, выполнив вход на любой сервер-посредник и открыв системный монитор. Эти счетчики начинаются с "LS:". Корпорация Майкрософт рекомендует использовать следующие счетчики мощности как минимум и добавить нужные еще нужные значения.

     Общее количество активных вызовов:

       - LS: MediationServer — текущие входящие вызовы (_Total) \- 

       - LS: MediationServer — текущие исходящие вызовы (_Total) \- 

     Общее количество активных вызовов обхода мультимедиа:

       - LS: MediationServer — входящие вызовы (_Total) \- активные вызовы обхода сервера-посредника 

       - LS: MediationServer-исходящие вызовы (_Total) \- активные вызовы обхода сервера-посредника 

     > [!NOTE]
     > Необходимо вручную вводить счетчики производительности в текстовом поле. Они не отображаются в виде параметров в раскрывающемся списке. 

     Дополнительные сведения о [источниках данных производительности Windows и Linux в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-performance-counters)

### <a name="create-alerts"></a>Создание оповещений

В OMS существует два типа оповещений: количество оповещений о результатах и оповещений об измерении показателей. Дополнительные сведения о создании оповещений можно найти [в статье работа с правилами оповещения в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts-creating).

При создании оповещений следует учитывать следующее:

- Убедитесь, что оповещение является предупреждением о результатах, которое является выбором по умолчанию. 

- В демонстрационных запросах необходимо, чтобы для параметра "число результатов" было задано значение "больше 0". 

- Рекомендуется устанавливать для интервала времени и частоты оповещений значение 5 минут. 

- Не рекомендуется включать "подавлять оповещения" для демонстрационных оповещений. 

- Для типичных сценариев оповещений Корпорация Майкрософт рекомендует создать единую комбинацию оповещений: одно сообщение об ошибке и одно оповещение о сбросе. Для оповещения об ошибке выберите критический уровень серьезности. для оповещения о сбросе выберите информационный уровень серьезности.

В следующих разделах описано, как создавать образцы оповещений.

 **Создание записи оповещения: "РТКМЕДСРВ не работает на серверах-посредниках" и "РТКМЕДСРВ работает на серверах-посредниках"**

Чтобы создать эту комбинацию оповещений:

- Запрос на оповещение об ошибке:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003)  | summarize arg_max(TimeGenerated, EventID) by Computer | where EventID == 25003
  ```

    В запросе используется фильтр компьютера,  *где компьютер содержит "MediationServer"*  . Фильтр выбирает только компьютер, имя которого содержит строку "MediationServer".

     Фильтр можно заменить на собственный фильтр компьютера или просто удалить. Можно создавать сложные строковые фильтры без регулярных выражений. Более подробную информацию можно узнать в статье [Операторы String](https://docs.loganalytics.io/docs/Language-Reference/Scalar-operators/String-operators). Вы также можете использовать регулярные выражения. Кроме того, вы можете создать группу компьютеров, сохранив поисковый запрос и используя эту группу в качестве фильтра компьютера в запросе оповещения. Дополнительные сведения см. [в разделе группы компьютеров в поиске журналов службы анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-computer-groups)

    Для каждого компьютера запрос об ошибке будет получать последний журнал событий для запуска службы РТКМЕДСРВ и остановки службы. Если Последнее событие является событием остановки службы, будет возвращен один журнал; Если Последнее событие является событием запуска службы, оно возвратит значение Nothing. Коротко говоря, запрос вернет список серверов, РТКМЕДСРВ которых остановлен в окне времени. 

- Запрос на оповещение о сбросе:

  ```Kusto
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003) | summarize arg_max(TimeGenerated, EventID) by Computer  | where EventID == 2500
  ```

    Запрос Reset выполняет в точности то же самое обратное сообщение об ошибке. Для каждого компьютера возвращается один, если последним событием является событие запуска службы; Если Последнее событие является событием остановки службы, оно возвратит значение Nothing.

**Создание записи оповещения: "слишком много одновременных вызовов на серверах-посредниках" и "одновременные вызовы отходятся до нормально загруженного"**

Чтобы создать это оповещение:

- Запрос на оповещение об ошибке:

  ```Kusto
  Perf | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName == "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls >= 500
  ```

    Для каждого компьютера запрос получает последние счетчики входящего и исходящего звонка, а также выводит эти два значения. Он возвратит один журнал, если сумма превышает 500; Если это не так, он возвратит значение Nothing. Коротко говоря, запрос возвращает список серверов, одновременные вызовы которых слишком много в окне времени.

- Запрос на оповещение о сбросе:

  ```Kusto
  Perf  | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName ==  "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls < 500
  ```

    Запрос Reset выполняет в точности то же самое обратное сообщение об ошибке. Для каждого компьютера запрос получает последние счетчики входящего и исходящего звонка, а также выводит эти два значения. Он возвратит один журнал, если значение sum меньше 500; в противном случае он возвратит значение Nothing.

**Создание оповещения: "предупреждение об использовании ЦП \> 90 или рткмедиарелай остановлено на серверах"**

Для создания этого оповещения используется следующий запрос:

```Kusto
search *| where Computer contains "MediationServer" | where (Type == "Perf" or Type == "Event") | where ((ObjectName ==  "Processor" and CounterName == "% Processor Time") or EventLog == "Lync Server") | where (CounterValue > 90 or EventID == 22003)
```

Запрос будет получать все события счетчика использования процессора и остановки службы со всех компьютеров и возвращать один журнал, если загрузка процессора превышает 90% или служба когда-либо останавливается. 

## <a name="analyze-the-alerts-in-your-log-analytics-repository"></a>Анализ оповещений в репозитории анализа журналов

Чтобы проанализировать оповещения в репозитории, используйте решение для управления оповещениями. Дополнительные сведения: решение для [управления оповещениями в Operations Management Suite (OMS)](https://docs.microsoft.com/azure/log-analytics/log-analytics-solution-alert-management)

## <a name="recommended-minimal-monitoring-set"></a>Рекомендуемый минимальный набор мониторинга

Чтобы определить проблемы с журналами событий и счетчиками производительности, выполните указанные ниже действия. 

- **Журналы событий.** При возникновении любой проблемы должна быть сопоставлена одна и та же группа событий, в которой один набор событий указывает на то, что что-то не так, а другое указывает на то, что все правильно. Для любого определенного периода времени это последнее записанное событие, которое указывает, является ли что-либо амисс для этого периода времени.

- **Счетчики производительности.** Для наблюдаемых счетчиков должно быть задано пороговое значение.

В следующей таблице перечислены службы, которые корпорация Майкрософт рекомендует отслеживать, указывая идентификаторы событий Stop и Start:

|Имя службы  <br/> |Роль целевого сервера  <br/> |Код события Stop  <br/> |Код события запуска  <br/> |
|:-----|:-----|:-----|:-----|
|рткмедсрв  <br/> |Mediation Server (Сервер-посредник);  <br/> |25003  <br/> |25002  <br/> |
|RTCSRV  <br/> |Пограничный сервер  <br/> |12289  <br/> |12288  <br/> |
|рткмраус  <br/> |Пограничный сервер  <br/> |19003  <br/> |19002  <br/> |
|рткмедиарелай  <br/> |Пограничный сервер  <br/> |22003  <br/> |22002  <br/> |

В следующей таблице перечислены сетевые проблемы, которые корпорация Майкрософт рекомендует отслеживать:


| Имя монитора  <br/>                                        | Роль целевого сервера  <br/> | Выражение идентификатора события Success  <br/> | Выражение идентификатора события ошибки  <br/> | Пример ошибки  <br/> |
|:-----------------------------------------------------------|:--------------------------|:-----------------------------------|:---------------------------------|:-----------------------|
| Ошибка подключения сервера-посредника к шлюзу  <br/>    | Mediation Server (Сервер-посредник);  <br/>   | 25062                              |                                  | 25002  <br/>           |
| Сбой при завершении вызова сервера-посредника на шлюз  <br/> | Mediation Server (Сервер-посредник);  <br/>   | 25064                              |                                  | 25002  <br/>           |
| Критические проблемы с сетью  <br/>                           | Пограничный сервер  <br/>        | 14353                              |                                  | 12288  <br/>           |

Ниже перечислены счетчики мощности звонков, которые необходимо отслеживать. Эти номера должны быть меньше, чем 500 для выпуска Cloud Connector Standard Edition; меньше 50 для минимального выпуска Cloud Connector.

- LS: MediationServer — текущие входящие вызовы (_Total) \- 

- LS: MediationServer — текущие исходящие вызовы (_Total) \- 

- LS: MediationServer — входящие вызовы (_Total) \- активные вызовы обхода сервера-посредника

- LS: MediationServer-исходящие вызовы (_Total) \- активные вызовы обхода сервера-посредника

## <a name="see-also"></a>См. также

Дополнительные сведения о работе с OMS можно найти в следующих статьях:

- [Поиск данных с помощью поиска в журнале в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-searches)

- [Справочник по языку службы анализа журналов Azure](https://docs.loganalytics.io/docs/Language-Reference)

- [Общие сведения об оповещениях в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts)

- [Подключение компьютеров Windows к службе анализа журналов в Azure](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)


