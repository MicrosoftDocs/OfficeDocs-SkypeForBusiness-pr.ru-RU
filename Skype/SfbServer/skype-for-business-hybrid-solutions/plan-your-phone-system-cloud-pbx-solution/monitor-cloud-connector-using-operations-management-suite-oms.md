---
title: Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.assetid: edf4a04c-d4c9-4c05-aacc-9e084618bb55
description: В этой статье рассказывается о том, как отслеживать облачный соединитель версии 2,1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).
ms.openlocfilehash: 1dcac3519624cef898622f915b08b24363453b84
ms.sourcegitcommit: e64c50818cac37f3d6f0f96d0d4ff0f4bba24aef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2020
ms.locfileid: "41799629"
---
# <a name="monitor-cloud-connector-using-operations-management-suite-oms"></a>Отслеживание Cloud Connector с помощью Operations Management Suite (OMS)

В этой статье рассказывается о том, как отслеживать облачный соединитель версии 2,1 и более поздних версий с помощью Microsoft Operations Management Suite (OMS).

Теперь вы можете наблюдать за развертыванием облачного соединителя версии 2,1 и более поздних версий с помощью Operations Management Suite (OMS), решения для ИТ-управления в облаке (Майкрософт). С помощью службы анализа журналов OMS вы можете отслеживать и анализировать доступность и производительность ресурсов, в том числе физических и виртуальных компьютеров. Дополнительные сведения о службе OMS и Analytics log можно найти в статье [что такое набор Operations Management Suite (OMS)?](https://docs.microsoft.com/azure/operations-management-suite/operations-management-suite-overview).

В этой статье содержатся следующие разделы.

- Предварительные требования

- Настройка облачного соединителя для использования OMS

- Настройка OMS

- Анализ оповещений в репозитории аналитических журналов

- Рекомендуемый параметр наблюдения

## <a name="prerequisites"></a>Предварительные требования

Прежде чем вы сможете использовать OMS для наблюдения за развертыванием облачного соединителя, вам потребуется выполнить указанные ниже действия.

- **Учетная запись Azure и Рабочая область OMS.** Если у вас еще нет учетной записи Azure, вам потребуется создать ее для использования службы ведения журналов OMS. Сведения о том, как создать учетную запись Azure и настроить рабочую область OMS, можно найти в разделе [Начало работы с рабочей областью службы анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-get-started).

- **Облачный соединитель версии 2,1 или более поздней**

- Для мониторинга облачного соединителя требуется **Новый поиск журнала** в службе аналитики. Дополнительные сведения можно найти [в разделе Обновление рабочей области службы анализа журналов Azure для нового поиска в журнале](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-search-upgrade).

## <a name="configure-cloud-connector-to-use-oms"></a>Настройка облачного соединителя для использования OMS

Для использования OMS необходимо настроить локальную среду облачного соединителя. Для этого вам потребуется идентификатор рабочей области OMS и ключ, который можно найти с помощью портала OMS, как описано ниже: параметры--\>подключенные источники — серверы\> Windows.

![Снимок экрана OMS в Cloud Connector](../../media/a4bb0a96-c940-435e-a3f5-5ef3062dea83.png)

Способ настройки облачного соединителя для использования OMS зависит от вашего сценария.

- **Если при установке нового устройства с облаком соединительной линии требуется повторное развертывание устройства**, выполните следующие действия перед выполнением Install-ккапплианце:

1. В разделе файл Клаудконнектор. ini [Common] установите для параметра Омсенаблед значение true.

    Каждый раз, когда облачный соединитель разворачивается или обновляется, он попытается автоматически установить агент OMS на виртуальных машинах. Включите эту функцию, чтобы агент OMS мог содержаться в автоматическом обновлении облачной соединительной линии.

2. Для настройки идентификатора OMS и ключа выполните Set-Кккредентиал-AccountType Омсворкспаце. 

- **Если вы устанавливаете агент OMS на существующем устройстве облачного соединителя**, выполните указанные ниже действия.

1. В разделе файл Клаудконнектор. ini [Common] установите Омсенаблед = true. 

2. Запустите Import-Ккконфигуратион. 

3. Запустите Install-Ккомсажент. 

    > [!NOTE]
    > Если учетные данные Омсворкспаце никогда не были заданы, при запуске Install-Ккомсажент вам будет предложено ввести учетные данные. 

- **Если вы хотите обновить идентификатор или ключ рабочей области OMS на устройстве облачного соединителя, на котором уже установлен агент OMS, выполните указанные ниже действия.**

1. Для настройки идентификатора OMS и ключа выполните Set-Кккредентиал-AccountType Омсворкспаце. 

2. Чтобы применить обновления, запустите Install-Ккомсажент. 

- **Для всех сценариев убедитесь, что агенты подключены следующим образом:**

    На портале OMS перейдите в раздел Параметры —\> подключенные источники\> — серверы Windows. Вы увидите список подключенных компьютеров. 

## <a name="configure-oms"></a>Настройка OMS

После этого вам нужно будет указать конфигурацию OMS с помощью портала OMS. В частности, необходимо выполнить следующие действия:

- Укажите сведения о журналах событий и счетчиках производительности.

- Создание оповещений. 

### <a name="specify-information-about-event-logs-and-performance-counters"></a>Указание сведений о журналах событий и счетчиках производительности

На портале OMS вы должны указать сведения о журналах событий и счетчиках производительности, как описано ниже.

1. Перейдите в раздел настройки\>— журналы\>событий Windows и добавьте журналы событий для: 

   - Lync Server

   - Приложение

     > [!NOTE]
     > Вы должны вручную ввести в текстовом поле Lync Server. Этот параметр не отображается в раскрывающемся списке. 

     Дополнительные сведения можно найти [в разделе источники данных журнала событий Windows в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-windows-events)

2. Выберите параметры-\>счетчики производительности\> Windows для данных и добавьте счетчики производительности для: 

   - **Счетчики уровня ОС**. Вы можете добавить счетчики уровня операционной системы, такие как использование процессора, использование памяти, использование сети или использование существующих решений, таких как производительность и производительность, монитор производительности сети без явного добавления счетчиков. Независимо от того, как вы решите следить за их работой, корпорация Майкрософт рекомендует наблюдать за этими счетчиками операционной системы.

   - **Счетчики Skype для бизнеса**. В Skype для бизнеса предусмотрено множество счетчиков. Эти счетчики можно найти, войдя на любой сервер и открыв системный монитор. Эти счетчики начинаются с "LS:". Корпорация Майкрософт рекомендует использовать как минимум указанные ниже счетчики мощности и добавить еще более интересные.

     Общее количество активных звонков:

   - LS: Медиатионсервер — текущие входящие звонки (_Total\- ) 

   - LS: Медиатионсервер — текущие исходящие вызовы (\- _Total) 

     Общее количество активных звонков на обход мультимедиа:

   - LS: Медиатионсервер – входящие звонки (_Total)\- вызовы обхода активных мультимедиа 

   - LS: Медиатионсервер-исходящие вызовы (_Total\- ) вызовы обхода активных мультимедиа 

     > [!NOTE]
     > Вы должны вручную вводить в текстовом поле счетчики производительности. Они не отображаются в виде параметров в раскрывающемся списке. 

     Дополнительные сведения можно найти [в разделе источники данных о производительности Windows и Linux в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-data-sources-performance-counters)

### <a name="create-alerts"></a>Создание оповещений

В OMS есть два типа оповещений: количество оповещений о результатах и оповещения об измерении показателей. Дополнительные сведения о создании оповещений можно найти [в разделе Работа с правилами оповещения в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts-creating).

При создании оповещений вы должны иметь в виду следующее:

- Убедитесь, что оповещение является оповещением с результатами, которое является выбором по умолчанию. 

- Для демонстрационных запросов требуется, чтобы для параметра "число результатов" было задано значение "больше 0". 

- Рекомендуется установить как для интервала времени, так и для частоты оповещений, равным 5 минутам. 

- Не рекомендуется включать функцию "отключить оповещения" для демонстрационных оповещений. 

- Для типичных ситуаций с оповещениями Корпорация Майкрософт рекомендует создавать пары оповещений: одно сообщение об ошибке и одно оповещение о сбросе. Для оповещения об ошибке выберите критический уровень серьезности. для оповещения о сбросе выберите уровень серьезности.

В следующих разделах описано, как создавать образцы оповещений.

 **Создание пары оповещений: "РТКМЕДСРВ не работает на серверах исправлений", а "РТКМЕДСРВ работает на серверах исправлений"**

Чтобы создать эту пару оповещений:

- Запрос на сообщение об ошибке:

  ```
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003)  | summarize arg_max(TimeGenerated, EventID) by Computer | where EventID == 25003
  ```

    Запрос использует фильтр компьютера, на *котором компьютер содержит "медиатионсервер"* . Фильтр выбирает только компьютер, имя которого включает строку "Медиатионсервер".

     Вы можете заменить фильтр на собственный фильтр компьютера или просто удалить его. Вы можете создавать сложные фильтры строк без регулярных выражений. Дополнительные сведения можно найти в разделе [Операторы строковых операторов](https://docs.loganalytics.io/docs/Language-Reference/Scalar-operators/String-operators). Вы также можете выбрать использование регулярных выражений. Кроме того, вы можете создать группу компьютеров, сохранив поисковый запрос и используя эту группу в качестве фильтра на компьютере в запросе на оповещение. Дополнительные сведения можно найти [в разделе группы компьютеров в поиске журнала службы анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-computer-groups).

    Для каждого компьютера запрос об ошибке получит журнал последних событий для запуска службы РТКМЕДСРВ и остановки службы. Если Последнее событие является событием остановки службы, будет возвращен один журнал. Если Последнее событие является событием запуска службы, будет возвращено значение Nothing. Коротко говоря, запрос вернет список серверов, в которых РТКМЕДСРВ остановлен в окне времени. 

- Запрос на оповещение о сбросе:

  ```
  Event | where Computer contains "MediationServer" | where EventLog == "Lync Server" and (EventID == 25002 or EventID == 25003) | summarize arg_max(TimeGenerated, EventID) by Computer  | where EventID == 2500
  ```

    Запрос на сброс — это противоположный результат запроса об ошибке. Для каждого компьютера он возвратит один из них, если Последнее событие является событием запуска службы; Если Последнее событие является событием остановки службы, будет возвращено значение Nothing.

  **Создание пары оповещений: "слишком много одновременных звонков на серверы исправлений" и "одновременные звонки возвращаются к обычной загрузке"**

Чтобы создать это оповещение, выполните указанные ниже действия.

- Запрос на сообщение об ошибке:

  ```
  Perf | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName == "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls >= 500
  ```

    Для каждого компьютера запрос получит последние счетчики входящего и исходящего звонка, а затем сложить эти два значения. Если сумма превышает 500, будет возвращен один журнал. Если это не так, она возвратит ничего. Коротко говоря, запрос вернет список серверов, одновременные звонки которых слишком много в окне времени.

- Запрос на оповещение о сбросе:

  ```
  Perf  | where Computer contains "MediationServer" | where (ObjectName == "LS:MediationServer - Outbound Calls" or ObjectName ==  "LS:MediationServer - Inbound Calls") | summarize arg_max(TimeGenerated, CounterValue) by ObjectName, Computer | summarize  TotalCalls = sum(CounterValue) by Computer| where TotalCalls < 500
  ```

    Запрос на сброс — это противоположный результат запроса об ошибке. Для каждого компьютера запрос получит последние счетчики входящего и исходящего звонка, а затем сложить эти два значения. Если сумма превышает 500, она вернет один журнал. в противном случае он вернет Nothing.

  **Создание оповещения: "Загрузка ЦП \> 90 или рткмедиарелай остановлена на серверах"**

Чтобы создать это оповещение, сделайте следующее:

```
search *| where Computer contains "MediationServer" | where (Type == "Perf" or Type == "Event") | where ((ObjectName ==  "Processor" and CounterName == "% Processor Time") or EventLog == "Lync Server") | where (CounterValue > 90 or EventID == 22003)
```

Запрос возвращает все счетчики использования процессора и остановку служб со всех компьютеров и возвращают один журнал, если загрузка процессора превышает 90% или служба когда-либо прекратится. 

## <a name="analyze-the-alerts-in-your-log-analytics-repository"></a>Анализ оповещений в репозитории аналитических журналов

Чтобы проанализировать оповещения в репозитории, используйте решение для управления оповещениями. Дополнительные сведения можно найти [в разделе решение для управления оповещениями в Operations Management Suite (OMS)](https://docs.microsoft.com/azure/log-analytics/log-analytics-solution-alert-management)

## <a name="recommended-minimal-monitoring-set"></a>Рекомендуемый минимальный набор контрольных данных

Чтобы выявить проблемы с журналами событий и счетчиками производительности, выполните указанные ниже действия. 

- **Журналы событий.** Для любой проблемы должна существовать пара событий с одним набором событий, указывающая на то, что что-то пошло не так, а другое указывает на то, что все правильно. Для любого определенного периода времени это последнее записанное событие, которое показывает, является ли что-либо неправильным для этого периода времени.

- **Счетчики производительности.** Для наблюдаемых счетчиков должно быть пороговое значение.

В следующей таблице перечислены службы, которые корпорация Майкрософт рекомендует отслеживать, указывая коды событий Stop и Start:

|Название услуги  <br/> |Роль целевого сервера  <br/> |Код события остановки  <br/> |Код события запуска  <br/> |
|:-----|:-----|:-----|:-----|
|рткмедсрв  <br/> |Сервер-посредник  <br/> |25003  <br/> |25002  <br/> |
|ртксрв  <br/> |Пограничный сервер  <br/> |12289  <br/> |12288  <br/> |
|рткмраус  <br/> |Пограничный сервер  <br/> |19003  <br/> |19002  <br/> |
|рткмедиарелай  <br/> |Пограничный сервер  <br/> |22003  <br/> |22002  <br/> |

В таблице ниже перечислены сетевые проблемы, которые корпорация Майкрософт рекомендует отслеживать.


| Имя монитора  <br/>                                        | Роль целевого сервера  <br/> | Выражение с кодом события "успех"  <br/> | Выражение с кодом события ошибки  <br/> | Пример сбоя  <br/> |
|:-----------------------------------------------------------|:--------------------------|:-----------------------------------|:---------------------------------|:-----------------------|
| Ошибка подключения сервера обновлений к шлюзу  <br/>    | Сервер-посредник  <br/>   | 25062                              |                                  | 25002  <br/>           |
| Сбой завершения вызова сервера обновлений до шлюза  <br/> | Сервер-посредник  <br/>   | 25064                              |                                  | 25002  <br/>           |
| Критические проблемы с сетью  <br/>                           | Пограничный сервер  <br/>        | 14353                              |                                  | 12288  <br/>           |

Ниже перечислены счетчики мощности звонков, которые нужно отслеживать. Эти номера должны быть меньше, чем 500 для облачного соединителя Standard Edition. менее 50 для облачного соединителя (минимум).

- LS: Медиатионсервер — текущие входящие звонки (_Total\- ) 

- LS: Медиатионсервер — текущие исходящие вызовы (\- _Total) 

- LS: Медиатионсервер – входящие звонки (_Total)\- вызовы обхода активных мультимедиа

- LS: Медиатионсервер-исходящие вызовы (_Total\- ) вызовы обхода активных мультимедиа

## <a name="see-also"></a>См. также

Дополнительные сведения о работе с OMS можно найти в следующих статьях:

- [Поиск данных с помощью поиска по журналу в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-log-searches)

- [Справочник по языку Azure log Analytics](https://docs.loganalytics.io/docs/Language-Reference)

- [Общие сведения об оповещениях в службе анализа журналов](https://docs.microsoft.com/azure/log-analytics/log-analytics-alerts)

- [Подключение компьютеров с Windows к службе Analytics log в Azure](https://docs.microsoft.com/azure/log-analytics/log-analytics-windows-agents)


