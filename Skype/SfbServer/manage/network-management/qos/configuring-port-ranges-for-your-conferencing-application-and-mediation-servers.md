---
title: Настройка диапазонов портов и политики качества обслуживания для конференций, приложений и серверов-исправлений
ms.reviewer: ''
ms:assetid: 4d6eaa5d-0127-453f-be6a-e55384772d83
ms:mtpsurl: https://technet.microsoft.com/en-us/library/JJ204872(v=OCS.15)
ms:contentKeyID: 48184074
mtps_version: v=OCS.15
ms.author: v-lanac
author: lanachin
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
description: В этой статье описано, как настроить диапазоны портов и политику качества обслуживания для конференций, приложений и серверов-исправлений.
ms.openlocfilehash: 76373407a8087e3646668d7ce9952c83c500af97
ms.sourcegitcommit: e64c50818cac37f3d6f0f96d0d4ff0f4bba24aef
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/06/2020
ms.locfileid: "41817448"
---
# <a name="configuring-port-ranges-and-a-quality-of-service-policy-for-your-conferencing-application-and-mediation-servers"></a>Настройка диапазонов портов и политики качества обслуживания для конференций, приложений и серверов-исправлений

В этой статье описано, как настроить диапазоны портов и политику качества обслуживания для конференций, приложений и серверов-исправлений.

## <a name="configure-port-ranges"></a>Настройка диапазонов портов

Для реализации качества обслуживания следует настроить идентичные диапазоны портов для голосовой связи, видео и совместного использования приложений на серверах конференц-связи, приложений и исправлений. Кроме того, эти диапазоны портов не должны перекрываться. Чтобы использовать простой пример, предположим, что вы используете порты 10000 – 10999 для видео на серверах конференц-связи. Это означает, что вы также должны резервировать порты 10000 – 10999 для видео на серверах приложений и исправлений. В противном случае качество обслуживания не будет работать должным образом.

Аналогичным образом, предположим, что вы резервируете порты 10000 – 10999 для видео, а затем Зарезервируйте порты 10500 – 11999 для звука. Это может создавать проблемы со службой качества обслуживания, так как диапазоны портов перекрываются. При использовании QoS у каждого модальности должен быть уникальный набор портов: Если вы используете порты 10000 – 10999 для видео, вам придется использовать другой диапазон (например, с 11000 по 11999, для звука).

По умолчанию диапазоны звуковых и видеопортов не перекрываются в Skype для бизнеса Server; Однако диапазоны портов, назначаемые для общего разделения приложений, перекрываются с диапазонами звуковых и видеопортов. (В свою очередь, это означает, что ни один из этих диапазонов не уникален.) Вы можете проверить существующие диапазоны портов для серверов конференций, приложений и исправлений, запустив в командной консоли Skype для бизнеса Server следующие три команды:

    Get-CsService -ConferencingServer | Select-Object Identity, AudioPortStart, AudioPortCount, VideoPortStart, VideoPortCount, AppSharingPortStart, AppSharingPortCount
    
    Get-CsService -ApplicationServer | Select-Object Identity, AudioPortStart, AudioPortCount
    
    Get-CsService -MediationServer | Select-Object Identity, AudioPortStart, AudioPortCount

> [!WARNING]  
> Как видно из предыдущих команд, для каждого типа порта — звук, видео и общий доступ к приложениям — каждому из них назначается два отдельных значения: начало порта и число портов. Начало порта указывает первый порт, используемый для этого модального. Например, если начало звукового порта равно 50000, то первым портом, используемым для звукового трафика, является порт 50000. Если счетчик звуковых портов равен 2 (то есть не является допустимым значением, но используется в целях иллюстрации), это означает, что для звуковых данных выделены только два порта. Если первый порт является портом 50000 и есть два порта, это означает, что второй порт должен быть портом 50001 (диапазоны портов должны быть непрерывными). Как следствие, диапазон портов для звука — порты 50000 – 50001 включительно.<BR><br>Обратите внимание, что сервер приложений и сервер исправлений поддерживают только QoS для звука; Вам не нужно изменять порты общего использования видео или приложений на серверах приложений или серверах исправлений.

Если вы запустили три команды, вы увидите, что значения по умолчанию для порта в Skype для бизнеса Server настраиваются следующим образом:

<table>
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr class="header">
<th>Свойство</th>
<th>Сервер конференц-связи</th>
<th>Сервер приложений</th>
<th>Сервер-посредник</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><p>аудиопортстарт</p></td>
<td><p>49152</p></td>
<td><p>49152</p></td>
<td><p>49152</p></td>
</tr>
<tr class="even">
<td><p>аудиопорткаунт</p></td>
<td><p>8348</p></td>
<td><p>8348</p></td>
<td><p>8348</p></td>
</tr>
<tr class="odd">
<td><p>видеопортстарт</p></td>
<td><p>57501</p></td>
<td><p>--</p></td>
<td><p>--</p></td>
</tr>
<tr class="even">
<td><p>видеопорткаунт</p></td>
<td><p>8034</p></td>
<td><p>--</p></td>
<td><p>--</p></td>
</tr>
<tr class="odd">
<td><p>аппликатионшарингпортстарт</p></td>
<td><p>49152</p></td>
<td><p>--</p></td>
<td><p>--</p></td>
</tr>
<tr class="even">
<td><p>аппликатионшарингпорткаунт</p></td>
<td><p>16383</p></td>
<td><p>--</p></td>
<td><p>--</p></td>
</tr>
</tbody>
</table>

Как отмечалось ранее, при настройке портов сервера Skype для бизнеса для QoS вы должны убедиться, что: 1) параметры звукового порта идентичны на серверах конференций, приложений и исправлений. и 2) диапазоны портов не перекрываются. Если вы внимательно посмотрите на приведенную выше таблицу, вы увидите, что диапазоны портов идентичны для трех типов серверов. Например, для начального звукового порта установлен порт 49152 на каждом из типов серверов, а общее количество портов, зарезервированных для звука на каждом сервере, также совпадает: 8348. Однако диапазоны портов перекрываются: Аудиопорты начинаются с порта 49152, но это значит, что порты можно настроить для совместного использования приложений. Чтобы обеспечить оптимальное использование качества обслуживания, необходимо повторно настроить общий доступ к приложениям, чтобы использовать уникальный диапазон портов. Например, можно настроить общий доступ к приложениям с порта 40803 и использовать порт 8348. (Зачем 8348 порт? Если вы добавите эти значения вместе--40803 + 8348--это значит, что общий доступ к приложениям будет использовать порты 40803 через порт 49150. Так как порты не начинаются с порта 49152, перекрывающиеся диапазоны портов больше не будут перекрываться.)

После выбора нового диапазона портов для совместного использования приложений вы можете внести изменения с помощью командлета Set-КсконференЦингсервер. Это изменение не нужно вносить на серверах приложений или на серверах-посредниках, так как эти серверы не обрабатывают трафик общего обмена приложениями. Если вы решите переназначить порты, используемые для звукового трафика, вам нужно изменить только значения порта на этих серверах.

Чтобы изменить значения портов для совместного использования приложений на одном сервере конференц-связи, выполните следующую команду в командной консоли управления Skype для бизнеса Server.

    Set-CsConferenceServer -Identity ConferencingServer:atl-cs-001.litwareinc.com -AppSharingPortStart 40803 -AppSharingPortCount 8348

Если вы хотите внести эти изменения на всех серверах конференц-связи, вы можете выполнить эту команду:

    Get-CsService -ConferencingServer | ForEach-Object {Set-CsConferenceServer -Identity $_.Identity -AppSharingPortStart 40803 -AppSharingPortCount 8348}

После изменения параметров порта следует остановить и перезапустить все службы, затрагиваемые этими изменениями.

Не обязательно, чтобы сервер конференц-связи, серверы приложений и серверы исправлений совместно применялись к одному и тому же диапазону портов; единственное истинное требование состоит в том, что вы настроили уникальные диапазоны портов на всех серверах. Тем не менее, администрирование обычно будет проще, если вы используете один и тот же набор портов на всех серверах.

## <a name="configure-a-quality-of-service-policy-in-skype-for-business-server-for-your-conferencing-application-and-mediation-servers"></a>Настройка политики качества обслуживания в Skype для бизнеса Server для конференц-связи, серверов приложений и исправлений

Настройка диапазонов портов упрощает использование качества обслуживания, гарантируя, что весь трафик определенного типа (например, весь звуковой трафик) проходит через один и тот же набор портов. Это упрощает для системы определение и пометку определенного пакета: Если порт 49152 зарезервирован для звукового трафика, любой пакет, переданный через порт 49152, можно пометить с помощью кода DSCP, указывающего на то, что это звуковой пакет. В свою очередь, это позволяет маршрутизаторам идентифицировать пакет в качестве звукового пакета и давать ему более высокий приоритет, чем непомеченные пакеты (например, пакеты, используемые для копирования файла с одного сервера на другой).

Тем не менее, если запретить набор портов для определенного типа трафика, пакеты, передаваемые через эти порты, не помечаются соответствующим кодом DSCP. В дополнение к определению диапазонов портов необходимо также создать политики качества обслуживания, определяющие код DSCP, связанный с каждым диапазоном портов. В Skype для бизнеса Server обычно это означает создание двух политик: для звуковых и видеофайлов.

Проще всего создавать политики качества обслуживания, а также управлять ими с помощью групповой политики. (Эти же политики также можно создать с помощью локальной политики безопасности. Тем не менее, это необходимо для того, чтобы повторять одну и ту же процедуру на каждом и каждом компьютере.) Первоначальный набор политик QoS (для звуковых и видеофайлов) должен применяться только к серверам Skype для бизнеса Server, на которых запущен сервер конференц-связи, сервер приложений и (или) сервер служб исправлений. Если все эти компьютеры находятся в одном и том же подразделении Active Directory, вы можете просто назначить этому подразделению новый объект групповой политики (GPO). Кроме того, вы можете выполнить другие действия, чтобы назначить новую политику для указанных компьютеров; Например, вы можете поместить соответствующие компьютеры в группу безопасности, а затем применить их только к этой группе безопасности с помощью фильтрации безопасности групповой политики.

Чтобы создать политику качества обслуживания для управления звуковым подключением, войдите на компьютер, на котором установлен компонент управления групповыми политиками. Откройте средство управления групповыми политиками (нажмите кнопку **Пуск**, выберите пункт **Администрирование**, а затем — **Управление групповыми политиками**), а затем выполните указанные ниже действия.

1.  В разделе Управление групповой политикой найдите контейнер, в котором нужно создать новую политику. Например, если все серверные компьютеры Skype для бизнеса находятся в подразделении "Skype для бизнеса", в подразделении "Skype для бизнеса" сервера должны быть созданы новые политики.

2.  Щелкните правой кнопкой мыши соответствующий контейнер, а затем выберите команду **создать объект групповой политики в этом домене и свяжите его**.

3.  В диалоговом окне **создание GPO** введите имя нового объекта групповой политики в поле **имя** (например, в **Skype для бизнеса Server QoS**), а затем нажмите кнопку **ОК**.

4.  Щелкните созданную политику правой кнопкой мыши и выберите команду **изменить**.

5.  В редакторе управления групповыми политиками разверните узел **Конфигурация компьютера**, выберите пункт **политики**, разверните раздел **Параметры Windows**, щелкните правой кнопкой мыши службу **QoS на основе политики**и выберите команду **создать новую политику**.

6.  В диалоговом окне **QoS на основе политики** на первой странице в поле **имя** введите имя новой политики (например, **Skype для бизнеса Server QoS**). Выберите **задать значение DSCP** и задайте значение **46**. Оставьте параметр **задать частоту исходящих подключений** невыбранным и нажмите кнопку **Далее**.

7.  На следующей странице убедитесь, что выбраны **все приложения** , а затем нажмите кнопку **Далее**. Это гарантирует, что все приложения будут соответствовать пакеты из указанного диапазона портов с указанным кодом DSCP.

8.  На третьей странице убедитесь, что выбраны оба **IP-адреса источника и конечный IP-адрес** , а затем нажмите кнопку **Далее**. Эти два параметра гарантируют, что пакеты будут управляться независимо от того, на каком компьютере (IP-адрес) отправили эти пакеты, и какой компьютер (IP-адрес) будет получать эти пакеты.

9.  На четвертой странице в раскрывающемся списке выберите протокол **TCP и UDP** , который будет **применяться этой политикой QoS** . Протокол TCP и протокол UDP (User Datagram Protocol) — это два сетевых протокола, которые чаще всего используются в Skype для бизнеса Server и его клиентских приложениях.

10. Под заголовком **укажите номер исходного порта**, выберите **из этого исходного порта или диапазона**. В сопроводительном текстовом поле введите диапазон портов, зарезервированный для передачи звука. Например, если вы зарезервированы порты 49152 через порты 57500 для звукового трафика, введите диапазон портов в следующем формате: **49152:57500**. Нажмите **Готово**.

> [!NOTE]  
> Значение DSCP для 46 является несколько случайным: хотя для пометки пакетов звука часто используется DSCP 46, вам не нужно использовать DSCP 46 для голосовой связи. Если вы уже реализовали качество обслуживания и используете другой код DSCP (например, DSCP 40), необходимо настроить политику качества обслуживания таким образом, чтобы она использовала тот же код (то есть 40 для звука). Если вы только что сейчас реализуете качество обслуживания, рекомендуется использовать DSCP 46 для звука, просто потому, что это значение обычно используется для пометки звуковых пакетов.

После создания политики QoS для звукового трафика вы должны создать вторую политику для видеотрафика (и, при необходимости, третью политику для управления трафиком о совместном доступе к приложениям). Чтобы создать политику для видео, выполните те же действия, что и при создании политики звука, заменив указанные ниже.

  - Использование другого (и уникального) имени политики (например, в **Skype для бизнеса Server**).

  - Задайте для параметра DSCP значение **34** вместо 46. (Обратите внимание, что вам не нужно использовать значение DSCP для 34. Единственным требованием является использование другого значения DSCP для видео, чем вы использовали для звука.

  - Используйте ранее настроенный диапазон портов для видеоканала. Например, если вы зарезервированы порты 57501 – 65535 для видео, задайте диапазон портов следующим образом: **57501:65535**.

Если вы решили создать политику для управления трафиком общего доступа к приложениям, необходимо создать третью политику, которая будет выполнять указанные ниже действия.

  - Используйте другое (и уникальное) имя политики (например, **общий доступ к приложениям в Skype для бизнеса Server**).

  - Задайте для параметра DSCP значение **24** , а не 46. (Опять же, вам не нужно использовать значение DSCP, равное 24. Единственным требованием является использование другого значения DSCP для общего пользования приложениями, чем при использовании звука или видео.)

  - Используйте ранее настроенный диапазон портов для видеоканала. Например, если у вас есть резервированные порты 40803 – 49151 для совместного использования приложений, задайте диапазон портов следующим образом: **40803:49151**.

Новые политики, созданные вами, вступят в силу только после обновления групповой политики на компьютерах в Skype для бизнеса Server. Хотя групповая политика периодически обновляется сама, вы можете обновить ее принудительно, запустив на каждом нужном компьютере следующую команду.

    Gpupdate.exe /force

Эту команду можно выполнить в командной консоли Skype для бизнеса Server или в любом командном окне, работающем под учетными данными администратора. Чтобы открыть такое окно с правами администратора, в меню **Пуск** правой кнопкой мыши щелкните **Командная строка** и выберите пункт **Запуск от имени администратора**.

Чтобы убедиться в том, что новые политики качества обслуживания применены, выполните указанные ниже действия.

1.  На компьютере, на котором установлен сервер Skype для бизнеса, нажмите кнопку **Пуск**и выберите команду **выполнить**.

2.  В диалоговом окне **выполнить** введите **regedit**и нажмите клавишу ВВОД.

3.  В редакторе реестра разверните узел **компьютер**, разверните **раздел\_hKey\_локальный компьютер**, разверните раздел **программы** **, а затем**разверните раздел **Microsoft**, затем разверните раздел **Windows**и выберите команду **QoS**. В разделе **QoS** для каждой созданной политики QoS должны отображаться разделы реестра. Например, если вы создали две новые политики (с именем службы QoS для Skype для бизнеса Server и другое название — Skype для бизнеса Server), вы должны увидеть записи в реестре для качества обслуживания аудио-и видеофайлов Skype для бизнеса Server.

Чтобы убедиться в том, что сетевые пакеты помечены с использованием соответствующего значения DSCP, необходимо также создать новый параметр реестра на каждом компьютере, выполнив описанные ниже действия.

1.  В меню **Пуск** выберите пункт **Выполнить**.

2.  В диалоговом окне **выполнить** введите **regedit**и нажмите клавишу ВВОД.

3.  В редакторе реестра разверните раздел **\_hKey локальный\_компьютер**, разверните раздел **система**, разверните **куррентконтролсет**, затем — **службы**, а затем — значок **tcpip**.

4.  Щелкните правой кнопкой мыши **tcpip**, наведите указатель на пункт **создать**и выберите **клавишу**. После создания нового раздела реестра введите **QoS**и нажмите КЛАВИШу ввод, чтобы переименовать раздел.

5.  Щелкните правой кнопкой мыши **QoS**, наведите указатель на пункт **создать**и выберите **строковое значение**. После создания нового значения реестра введите команду не **использовать NLA**и нажмите клавишу ВВОД, чтобы переименовать значение.

6.  Дважды щелкните **не использовать NLA**. В диалоговом окне **изменение строки** введите **1** в поле **значение** , а затем нажмите кнопку **ОК**.

7.  Закройте редактор реестра и перезагрузите компьютер.
