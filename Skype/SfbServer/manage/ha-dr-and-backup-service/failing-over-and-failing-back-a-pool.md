---
title: Отработка отказа для пула
ms.reviewer: ''
author: lanachin
ms.author: v-lanac
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
description: .
ms.openlocfilehash: 2848261164ac568d3db4dd05160b7e50ec3981d3
ms.sourcegitcommit: ab47ff88f51a96aaf8bc99a6303e114d41ca5c2f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/20/2019
ms.locfileid: "34303892"
---
# <a name="failing-over-and-failing-back-a-pool-in-skype-for-business-server"></a>Отказ от резервного копирования пула в Skype для бизнеса Server и отказ от него 

Выполните описанные ниже действия, если один пул переднего плана завершился сбоем и необходимо отработку отказа, или пул, в котором произошел сбой, снова подключен к сети, и вам необходимо восстановить состояние развертывания в обычном режиме работы. Кроме того, вы узнаете, как переключиться на подложку, используемую для Федерации Skype для бизнеса или КСМПП Federation, или изменить пул краев, связанный с пулом переднего плана.

- [Переключение из пула переднего плана](#fail-over-a-front-end-pool)
- [Не удается вернуть пул](#fail-back-a-pool)
- [Отказ от пула EDGE, используемого для интеграции Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-skype-for-business-server-federation)
- [Отказ от пула EDGE, используемого для Федерации КСМПП в Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server)
- [Сбой при обратном использовании пула EDGE, используемого для Федерации Skype для бизнеса Server или Федерации КСМПП](#fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation)
- [Изменение пула EDGE, связанного с пулом переднего плана](#change-the-edge-pool-associated-with-a-front-end-pool)

## <a name="fail-over-a-front-end-pool"></a>Переключение из пула переднего плана

В этой процедуре Datacenter1 содержит Pool1 и Pool1 завершился сбоем. Вы не можете найти Pool2 в Datacenter2.

Большая часть работы для отработки отказа в пуле связана с отказом в хранилище Центрального управления, если это необходимо. Это важно, так как центральное хранилище управления должно быть работоспособным при сбое пользователей пула.

Кроме того, если пул переднего плана завершается сбоем, но пул EDGE на нем по-прежнему работает, необходимо знать, использует ли пул отказ в качестве следующего пула прыжков. Если это так, вы должны изменить пул EDGE, чтобы использовать другой пул переднего плана, прежде чем произойдет сбой в пуле внешних интерфейсов. Способ изменения параметров следующего прыжка зависит от того, будет ли край использовать пул на том же сайте, что и пул EDGE, или другой сайт.

**Настройка пограничного пула на использование следующего пула прыжков на том же сайте**

1.  Откройте построитель топологии, щелкните правой кнопкой мыши Граничный пул, который необходимо изменить, и выберите команду **изменить свойства**.

2.  Щелкните **следующий прыжок**. В списке **следующего прыжка пул:** выберите пул, который будет использоваться в качестве пула следующего прыжка.

3.  Нажмите кнопку **ОК**, а затем опубликуйте изменения.

**Настройка пограничного пула на использование пула следующего прыжка на другом сайте**

1.  Откройте окно командной консоли Skype для бизнеса Server и введите следующий командлет:
    
        Set-CsEdgeServer -Identity EdgeServer:<Edge Server pool FQDN> -Registrar Registrar:<NextHopPoolFQDN>

**Отказ от пула в случае аварии**

1.  Чтобы найти, какой из пулов является узлом центрального сервера управления, введите следующий командлет на сервере переднего плана в Pool2:
    
        Invoke-CsManagementServerFailover -Whatif
    
    Результаты этого командлета показывают, в каком пуле на данный момент размещен Центральный сервер управления. В оставшейся части этой процедуры этот пул называется пулом CMS\_.

2.  Использование построителя топологии для поиска версии сервера Skype для бизнеса Server, работающей на\_пуле CMS. Если на компьютере установлено приложение Skype для бизнеса Server, найдите пул резервных копий пула 1 с помощью следующего командлета.
    
        Get-CsPoolBackupRelationship -PoolFQDN <CMS_Pool FQDN>
    
    Пусть резервная копия\_пула является пулом резервных копий.

3.  Проверьте состояние хранилища центрального управления с помощью следующего командлета:
    
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
    
    Этот командлет показывает, что оба Активемастерфкдн и Активефилетрансферажентс указывают на полное доменное имя пула\_CMS. Если они пусты, центральный сервер управления недоступен, и вы должны пройти его.

4.  Если хранилище Центрального управления недоступно или хранилище Центрального управления запущено на Pool1 (то есть в пуле, в котором произошел сбой), перед отказом в пуле необходимо выполнить переключение на центральный сервер управления. Если вам нужно переключиться на центральный сервер управления, размещенный в пуле, на котором работает Skype для бизнеса Server, используйте командлет, описанный в шаге 5 этой процедуры. Если вам не нужно переключиться на центральный сервер управления, перейдите к шагу 7 этой процедуры.

5.  Чтобы отдать отказ на хранение центрального хранилища в пуле, работающем в Skype для бизнеса Server, выполните указанные ниже действия.
    
      - Сначала убедитесь, что сервер, на котором он\_находится в резервной копии, запускает экземпляр основного хранилища, введя следующие символы:
        
            Get-CsDatabaseMirrorState -DatabaseType Centralmgmt -PoolFqdn <Backup_Pool Fqdn>
    
      - Если основной сервер в пуле резервной копии\_является основным, введите:
        
            Invoke-CSManagementServerFailover -BackupSQLServerFqdn <Backup_Pool Primary BackEnd Server FQDN> -BackupSQLInstanceName <Backup_Pool Primary SQL Instance Name>
        
        Если сервер зеркального отображения в пуле резервных копий\_является основным, введите:
        
            Invoke-CSManagementServerFailover -MirrorSQLServerFqdn <Backup_Pool Mirror BackEnd Server FQDN> -MirrorSQLInstanceName <Backup_Pool Mirror SQL Instance Name>
    
      - Убедитесь, что переход на центральный сервер управления завершен. Введите следующую команду:
        
            Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
        
        Убедитесь, что оба Активемастерфкдн и Активефилетрансферажентс указывают на полное доменное имя\_пула резервных копий.
    
      - Наконец, проверьте состояние реплики для всех серверов переднего плана, введя следующее:
        
            Get-CsManagementStoreReplicationStatus 
        
        Убедитесь, что все реплики имеют значение истина.
        
        Перейдите к шагу 7 в этой процедуре.

6.  Установите хранилище Central Management на сервере заднего резервного\_пула.
    
      - Сначала выполните следующую команду:
        
        ``` 
        Install-CsDatabase -CentralManagementDatabase -Clean -SqlServerFqdn <Backup_Pool Back End Server FQDN> -SqlInstanceName rtc  
        ```
    
      - Запустите следующую команду на одном из серверов переднего плана резервного\_пула, чтобы принудительно переместить хранилище Центрального управления.
        
            Move-CsManagementServer -ConfigurationFileName c:\CsConfigurationFile.zip -LisConfigurationFileName c:\CsLisConfigurationFile.zip -Force 
    
      - Проверка завершения перемещения.
        
            Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
        
        Убедитесь, что оба Активемастерфкдн и Активефилетрансферажентс указывают на полное доменное имя\_пула резервных копий.
    
      - Проверьте состояние реплики для всех серверов переднего плана, введя следующее:
        
            Get-CsManagementStoreReplicationStatus 
        
        Убедитесь, что все реплики имеют значение истина.
    
      - Установите службу центрального сервера управления на остальных серверах переднего плана в пуле резервных копий\_. Для этого выполните следующую команду на всех серверах переднего плана, кроме той, которую вы использовали при принудительном переходе на центральное хранилище управления в этой процедуре:
        
            Bootstrapper /Setup 

7.  Для переключения пользователей из Pool1 в Pool2, выполнив следующий командлет в окне командной консоли Skype для бизнеса Server:
    
        Invoke-CsPoolFailover -PoolFQDN <Pool1 FQDN> -DisasterMode -Verbose
    
    Поскольку действия, описанные в предыдущем разделе, для проверки состояния центрального хранилища управления не являются универсальными, возможно, этот командлет завершится сбоем, так как хранилище Центрального управления пока не проходит полную отработку отказа. В этом случае необходимо исправить центральное хранилище управления на основе отображаемых сообщений об ошибках, а затем повторно запустить этот командлет.
    
    Если появляется следующее сообщение об ошибке, вам необходимо изменить пул EDGE на этом сайте, чтобы использовать другой пул в качестве следующего прыжка, прежде чем вы перейдете на пул. Подробности можно найти в разделе процедуры, описанные в начале этой статьи.
    
        Invoke-CsPoolFailOver : This Front-end pool "pool1.contoso.com" is specified in
        topology as the next hop for the Edge server. Failing over this pool may cause External
        access/Federation/Split-domain/XMPP features to stop working. Please use Topology Builder to
        change the Edge internal next hop setting to point to a different Front-end pool,  before you
        proceed.


## <a name="fail-back-a-pool"></a>Не удается вернуть пул

После того как пул, в котором произошел сбой, перейдет в оперативный режим (то есть Pool1 в этом примере), выполните указанные ниже действия, чтобы восстановить состояние развертывания для обычного рабочего состояния.

Обратите внимание, что процесс восстановления после сбоя занимает несколько минут.Следует исходить из длительности 60 минут для пула, в котором работает 20 000 пользователей.

Не изменяйте пользователей, которые изначально были размещены в Pool1, и произошел сбой при переходе на Pool2, введя следующий командлет:
    
    Invoke-CsPoolFailback -PoolFQDN <Pool1 FQDN> -Verbose

Никаких других действий не требуется. Если вы отошел сбой на центральном сервере управления, вы можете оставить его в Pool2.

## <a name="fail-over-the-edge-pool-used-for-skype-for-business-server-federation"></a>Отказ от пула EDGE, используемого для интеграции Skype для бизнеса Server 

Если пул пограничного пула, на котором настроена веб-сервер Skype для бизнеса Server, не работает, необходимо изменить Федерацию так, чтобы он использовал другой пул Edge для работы Федерации.

1.  На сервере переднего плана откройте окно Построитель топологии. Разверните **** узел пограничного пула и щелкните правой кнопкой мыши граничный сервер пограничного сервера или пул пограничного сервера, настроенный на данный момент для Федерации. Нажмите кнопку **изменить свойства**.

2.  В диалоговом окне **изменение свойств** в разделе **Общие**снимите флажок **включить федерацию для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

3.  Разверните **Пулы Edge**, а затем щелкните правой кнопкой мыши граничный сервер пограничного сервера или пул пограничного сервера, который вы хотите использовать для Федерации. Нажмите кнопку **изменить свойства**.

4.  В диалоговом окне **изменение свойств** в разделе **Общие**установите флажок **включить федерацию для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

5.  Нажмите кнопку **действие**, выберите пункт **топология**, нажмите кнопку **опубликовать**. При появлении запроса на **публикацию топологии**нажмите кнопку **Далее**. Завершив публикацию, нажмите кнопку **Готово**.

6.  На пограничном сервере откройте мастер развертывания Skype для бизнеса Server. Нажмите кнопку **Установка или обновление серверной системы Skype для бизнеса**, а затем нажмите кнопку **Настройка или удалите компоненты Skype для бизнеса Server**. Нажмите кнопку **выполнить еще раз**.

7.  Нажмите кнопку **Далее**. На экране сводки будут показаны действия по мере их выполнения. После завершения развертывания щелкните **Просмотреть журнал** , чтобы просмотреть доступные файлы журнала. Нажмите кнопку **Готово** , чтобы завершить развертывание.
    
    Если сайт, содержащий неисправный пул, содержит серверы переднего плана, которые еще не запущены, для использования пула EDGE на удаленном сайте, который еще не работает, необходимо обновить службу веб-конференций и службу Конференции/V на этих интерфейсных пулах. 

 ## <a name="fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server"></a>Отказ от пула EDGE, используемого для Федерации КСМПП в Skype для бизнеса Server 

В вашей организации используется один пул краев, назначенный пулом для КСМПП Федерации. Если этот пул отключается, необходимо отдать отказ на КСМПП Федерацию для использования другого пула Edge перед тем, как КСМПП Федерация сможет снова работать.

После установки пулов EDGE и включения КСМПП Федерации вы можете упростить процесс аварийного восстановления, настроив внешние записи DNS SRV для всех пулов Edge для КСМПП Федерации, а не только для одной из них. Для каждой из этих записей SRV должен быть установлен другой приоритет. Весь трафик Федерации КСМПП проходит через пул с записью SRV с самым высоким приоритетом. 

В описанной ниже процедуре EdgePool1 — пул, изначально размещенный КСМПП Federation, и EdgePool2 — пул, который теперь будет размещен КСМПП Федерации.


### <a name="to-fail-over-the-edge-pool-used-for-xmpp-federation"></a>Чтобы отдать отказ на использование пула пограничного сервера для Федерации КСМПП

1.  Если вы еще не развернули другой пул пограничных кромок (Кроме того, который в данный момент не работает), разверните этот пул. 

2.  На каждом пограничном сервере в новом пограничном пуле, на котором будет размещена КСМПП Федерация (EdgePool2), запустите следующий командлет:
    
        Stop-CsWindowsService

3.  Чтобы перенаправить маршрут Федерации КСМПП на EdgePool2, выполните следующий командлет:
    
        Set-CsSite Site2 -XmppExternalFederationRoute EdgeServer2.contoso.com
    
    В этом примере Site2 — сайт с пулом EDGE, который теперь будет размещаться на маршруте Федерации КСМПП, а EdgeServer2.contoso.com — это полное доменное имя пограничного сервера в этом пуле.

4.  На внешнем DNS-сервере измените запись DNS A для Федерации КСМПП, чтобы она указывала на EdgeServer2.contoso.com.

5.  Если у вас еще нет DNS-записи SRV для Федерации КСМПП, которая разрешается в пул EDGE, который теперь будет размещаться в КСМПП Федерации, необходимо добавить его, как показано в следующем примере. Для этой записи SRV должно быть задано значение Port 5269.
    
        _xmpp-server._tcp.contoso.com

6.  Убедитесь, что в пуле EDGE, на котором будет размещена КСМПП Федерация, есть порт 5269, Открытый извне.

7.  Запустите службы на всех пограничных серверах в пограничном пуле, где будет размещаться Федерация КСМПП:
    
        Start-CsWindowsService


## <a name="fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation"></a>Сбой при обратном использовании пула EDGE, используемого для Федерации Skype для бизнеса Server или Федерации КСМПП 

После того как пул пограничного пула, который использовался для размещения Федерации, будет переведен в режим онлайн, выполните указанные ниже действия, чтобы восстановить маршрут Федерации Skype для бизнеса Server и/или КСМПП Федерации для повторного использования этого восстановленного пограничного пула.

1.  В пуле EDGE, который теперь доступен еще раз, запустите службы Edge.

2.  Если вы хотите вернуть маршрут Федерации Skype для бизнеса Server для использования восстановленного пограничного сервера, выполните указанные ниже действия.
    
      - На сервере переднего плана откройте окно Построитель топологии. Разверните узел **Edge**Pools, а затем щелкните правой кнопкой мыши граничный сервер пограничного сервера или пул пограничного сервера, настроенный на данный момент для Федерации. Нажмите кнопку **изменить свойства**.
    
      - В диалоговом окне **изменение свойств** в разделе **Общие**снимите флажок **включить федерацию для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
      - Разверните узел **Edge**Pools, а затем щелкните правой кнопкой мыши исходный сервер пограничного сервера или пул пограничного сервера, который вы снова хотите использовать для Федерации. Нажмите кнопку **изменить свойства**.
    
      - В диалоговом окне **изменение свойств** в разделе **Общие**установите флажок **включить федерацию для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
      - Нажмите кнопку **действие**, выберите пункт **топология**, нажмите кнопку **опубликовать**. При появлении запроса на **публикацию топологии**нажмите кнопку **Далее**. Завершив публикацию, нажмите кнопку **Готово**.
    
      - На пограничном сервере откройте мастер развертывания Skype для бизнеса Server. Нажмите кнопку **Установка или обновление системы Skype для бизнеса Server**, а затем выберите пункт **Настройка или удалить компоненты Skype для бизнеса Server**. Нажмите кнопку **выполнить еще раз**.
    
      - Нажмите кнопку **Далее**. На экране сводки будут показаны действия по мере их выполнения. После завершения развертывания щелкните **Просмотреть журнал** , чтобы просмотреть доступные файлы журнала. Нажмите кнопку **Готово** , чтобы завершить развертывание.

3.  Если вы хотите восстановить маршрут Федерации КСМПП для использования восстановленного пограничного сервера, выполните указанные ниже действия.
    
      - Запустите следующий командлет, чтобы перенаправить маршрут Федерации КСМПП на Граничный пул, который будет размещен КСМПП Federation (в этом примере — EdgeServer1):
        
            Set-CsSite Site1 -XmppExternalFederationRoute EdgeServer1.contoso.com
        
        В этом примере site1 — сайт с пулом EDGE, который теперь будет размещаться на маршруте Федерации КСМПП, а EdgeServer1.contoso.com — это полное доменное имя пограничного сервера в этом пуле.
    
      - Если у вас еще нет DNS-записи SRV для Федерации КСМПП, которая разрешается в пул EDGE, который теперь будет размещаться в КСМПП Федерации, необходимо добавить его, как показано в следующем примере. Для этой записи SRV должно быть задано значение Port 5269.
        
            _xmpp-server._tcp.contoso.com
    
      - На внешнем DNS-сервере измените запись DNS A для Федерации КСМПП, чтобы она указывала на EdgeServer2.contoso.com.
    
      - Убедитесь, что в пуле EDGE, на котором будет размещена КСМПП Федерация, есть порт 5269, Открытый извне.

4.  Если на веб-сайте, содержащем пул пограничного сервера, не удалось выполнить все неудачные и восстановленные интерфейсы, следует обновить службу веб-конференций и службу Конференции/V на этих интерфейсных пулах с помощью пулов EDGE на своем локальном сайте.

5.  Если пул переднего плана на сайте, на котором произошла ошибка, также завершился сбоем, вы можете использовать Invoke – Кспулфаилбакк для возврата пула переднего плана.


## <a name="change-the-edge-pool-associated-with-a-front-end-pool"></a>Изменение пула EDGE, связанного с пулом переднего плана

Если пул пограничного пула отключается, но пул переднего плана на этом же сайте по-прежнему работает, вы должны настроить интерфейс пула на использование пограничного пула на другом сайте, пока не произойдет восстановление пула Edge.

1.  В построителе топологии найдите имя пула переднего плана, который нужно изменить.

2.  Щелкните пул правой кнопкой мыши и выберите команду **изменить свойства**.

3.  В разделе **связи** в группе **сопоставление краевого пула (для компонентов мультимедиа)** выберите в раскрывающемся списке пул краев, который вы хотите связать с этим пулом переднего плана.

4.  Нажмите **ОК**.
