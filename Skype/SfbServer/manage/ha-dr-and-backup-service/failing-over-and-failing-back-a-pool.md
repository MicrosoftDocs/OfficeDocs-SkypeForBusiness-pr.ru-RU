---
title: Отработка отказа для пула
ms.reviewer: ''
author: cichur
ms.author: v-cichur
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
description: .
ms.openlocfilehash: 1ebd4e8110b8783c869530d95eda0646a895b88e
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49826569"
---
# <a name="failing-over-and-failing-back-a-pool-in-skype-for-business-server"></a>Отбой и отбой пула в Skype для бизнеса Server 

Используйте следующие процедуры, если сбой одного пула переднего конца и требуется отбой или пул, в который произошла авария, снова в сети, и необходимо восстановить обычное рабочее состояние развертывания. Кроме того, узнайте, как отменить отбой и отменить отбой в пуле, используемом для федерации Skype для бизнеса или федерации XMPP, или изменить пул, связанный с пулом переднего края.

- [Отбой пула переднего входа](#fail-over-a-front-end-pool)
- [Отбой пула](#fail-back-a-pool)
- [Отбой в пуле, используемом для федерации Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-skype-for-business-server-federation)
- [Отбой в пуле, используемом для федерации XMPP в Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server)
- [Отбой в пуле, используемом для федерации Skype для бизнеса Server или федерации XMPP](#fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation)
- [Изменение пула, связанного с пулом переднего края](#change-the-edge-pool-associated-with-a-front-end-pool)

## <a name="fail-over-a-front-end-pool"></a>Отбой пула переднего входа

В этой процедуре Datacenter1 содержит Pool1, и произошел отказ Pool1. Выполняется обход отказавшего пула к пулу Pool2, находящемуся в Datacenter2.

Большая часть работы по отсечению пула включает отбой центрального банка управления, если это необходимо. Это важно, так как центральное хранилище управления должно работать при отсечении пользователей пула.

Кроме того, если возник отказ клиентского пула, но пограничный пул на этом сайте по-прежнему работает, необходимо знать, используется ли пограничным пулом отказавший пул в качестве следующего перехода по пулам. Если используется, следует изменить пограничный пул, чтобы он использовал другой клиентский пул до обхода отказавшего клиентского пула. Порядок изменения настройки следующего перехода по пулам зависит от того, будет ли пограничный пул использовать пул на том же сайте, на котором находится пограничный пул, или на другом сайте.

**Настройка пула edge для использования пула следующего прыжка на том же сайте**

1.  Откройте построитель топологий, щелкните правой кнопкой мыши нужный пул и выберите "Изменить **свойства".**

2.  Щелкните **Следующий переход**. В списке **Пул следующего перехода:** выберите пул, который сейчас служит в качестве пула следующего перехода.

3.  Нажмите кнопку **ОК**, а затем опубликуйте изменения.

**Настройка пула edge для использования пула следующего прыжка на другом сайте**

1.  Откройте окно оболочки управления Skype для бизнеса Server и введите следующий cmdlet:
    
        Set-CsEdgeServer -Identity EdgeServer:<Edge Server pool FQDN> -Registrar Registrar:<NextHopPoolFQDN>

**Отбой пула в аварийной ситуации**

1.  Найдите пул, который является местом для центрального сервера управления, введя следующий cmdlet на сервере переднего сервера в пуле Pool2:
    
        Invoke-CsManagementServerFailover -Whatif
    
    В результатах этого cmdlet покажите, в котором в настоящее время размещен центральный сервер управления. В остальной части этой процедуры этот пул называется пулом \_ CMS.

2.  Используйте построитель топологий для поиска версии Skype для бизнеса Server, запущенной в пуле \_ CMS. Если на сервере работает Skype для бизнеса Server, используйте следующий cmdlet для поиска резервного пула пула 1.
    
        Get-CsPoolBackupRelationship -PoolFQDN <CMS_Pool FQDN>
    
    Пул \_ резервных копий должен быть резервным пулом.

3.  Проверьте состояние центрального банка управления с помощью следующего cmdlet:
    
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
    
    Этот cmdlet должен показать, что ActiveMasterFQDN и ActiveFileTransferAgents указывают на FQDN пула \_ CMS. Если они пустые, центральный сервер управления недопустим, и его необходимо переудать.

4.  Если центральное хранилище управления не доступно или центральное хранилище управления было запущено в пуле Pool1 (то есть в пуле, в который вошел сбой), необходимо перенаправить центральный сервер управления перед отбойом пула. Если необходимо перенаправить центральный сервер управления, который был запущен в пуле, где работает Skype для бизнеса Server, используйте этот cmdlet на шаге 5 этой процедуры. Если нет необходимости в отступе центрального сервера управления, переперейти к шагу 7 этой процедуры.

5.  To fail over the Central Management store on a pool running Skype for Business Server, do the following:
    
      - Сначала проверьте, какой тыловый сервер в резервном пуле запускает основной экземпляр центрального хранилище управления, введя \_ следующую информацию:
        
            Get-CsDatabaseMirrorState -DatabaseType Centralmgmt -PoolFqdn <Backup_Pool Fqdn>
    
      - Если основной сервер в резервном пуле \_ является основным, введите:
        
            Invoke-CSManagementServerFailover -BackupSQLServerFqdn <Backup_Pool Primary BackEnd Server FQDN> -BackupSQLInstanceName <Backup_Pool Primary SQL Instance Name>
        
        Если основным является зеркальный тыловой сервер в резервном \_ пуле, введите:
        
            Invoke-CSManagementServerFailover -MirrorSQLServerFqdn <Backup_Pool Mirror BackEnd Server FQDN> -MirrorSQLInstanceName <Backup_Pool Mirror SQL Instance Name>
    
      - Проверьте, завершена ли отбой центрального сервера управления. Введите следующую команду:
        
            Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
        
        Убедитесь, что activeMasterFQDN и ActiveFileTransferAgents указывают на FQDN резервного \_ пула.
    
      - Наконец, проверьте состояние реплики для всех серверов переднего сервера, введя следующую информацию:
        
            Get-CsManagementStoreReplicationStatus 
        
        Проверьте, все ли реплики имеют значение True.
        
        Перейдите к действию 7 этой процедуры.

6.  Установите центральное хранилище управления на тыловый сервер резервного \_ пула.
    
      - Сначала выполните следующую команду:
        ```PowerShell
         
        Install-CsDatabase -CentralManagementDatabase -Clean -SqlServerFqdn <Backup_Pool Back End Server FQDN> -SqlInstanceName rtc  
        ```
    
      - Чтобы принудительно переместить центральное хранилище управления, запустите следующую команду на одном из серверов переднего сервера резервного \_ пула:
        
            Move-CsManagementServer -ConfigurationFileName c:\CsConfigurationFile.zip -LisConfigurationFileName c:\CsLisConfigurationFile.zip -Force 
    
      - Проверьте, выполнилось ли перемещение.
        
            Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus 
        
        Убедитесь, что activeMasterFQDN и ActiveFileTransferAgents указывают на FQDN резервного \_ пула.
    
      - Проверьте состояние реплики для всех серверов переднего плана, введя следующую команду:
        
            Get-CsManagementStoreReplicationStatus 
        
        Проверьте, все ли реплики имеют значение True.
    
      - Установите службу центрального сервера управления на остальных серверах переднего сервера в резервном \_ пуле. Для этого запустите следующую команду на всех серверах переднего сервера, за исключением команды, которая использовалась при принудительным перемещением центрального банка управления ранее в этой процедуре:
        
            Bootstrapper /Setup 

7.  Чтобы перенаправить пользователей из пула Pool1 в пул 2, в окне оболочки управления Skype для бизнеса Server в окне управления Skype для бизнеса Server будет запущен следующий cmdlet:
    
        Invoke-CsPoolFailover -PoolFQDN <Pool1 FQDN> -DisasterMode -Verbose
    
    Поскольку действия, которые были предприняты в предыдущих частях этой процедуры для проверки состояния центрального банка управления, не являются универсальными, существует вероятность сбой этого cmdlet, так как центральное хранилище управления еще не полностью завершено. В этом случае необходимо исправить центральное хранилище управления на основе сообщений об ошибках, которые вы видите, а затем снова запустить этот cmdlet.
    
    Если выводится приводимое ниже сообщение об ошибке, необходимо изменить пограничный пул на данном сайте, чтобы использовать до обхода отказавшего пула другой пул в качестве следующего перехода. Подробности см. в описании процедур в начале этой статьи.
    
        Invoke-CsPoolFailOver : This Front-end pool "pool1.contoso.com" is specified in
        topology as the next hop for the Edge server. Failing over this pool may cause External
        access/Federation/Split-domain/XMPP features to stop working. Please use Topology Builder to
        change the Edge internal next hop setting to point to a different Front-end pool,  before you
        proceed.


## <a name="fail-back-a-pool"></a>Отбой пула

После возврата пула, в котором возникла аварийная ситуация, в режим работы (в данном примере это Pool1) выполните следующие действия для восстановления обычного рабочего состояния развертывания.

Обратите внимание, что процедура отработки отказа занимает несколько минут.  В качестве справки: отработка отказа для пула в 20000 пользователей занимает до 60 минут.

Восстановите размещение пользователей, которые изначально размещались в пуле Pool1 и были переключены на пул Pool2; для этого введите следующий командлет:
    
    Invoke-CsPoolFailback -PoolFQDN <Pool1 FQDN> -Verbose

Другие действия не требуются. Если вы перейдут на центральный сервер управления, его можно оставить в пуле Pool2.

## <a name="fail-over-the-edge-pool-used-for-skype-for-business-server-federation"></a>Отбой в пуле, используемом для федерации Skype для бизнеса Server 

If the Edge pool where you have Skype for Business Server federation configured goes down, you must change federation to use a different Edge pool for federation to work.

1.  На интерфейсном сервере откройте построитель топологии. **Разверните пулы,** а затем щелкните правой кнопкой мыши сервер или пул, настроенный в настоящее время для федерации. Выберите пункт **Изменить свойства**.

2.  В разделе **Общие** области **Изменение свойств** снимите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

3.  **Разверните пулы,** а затем щелкните правой кнопкой мыши сервер или пул, который вы хотите использовать для федерации. Выберите пункт **Изменить свойства**.

4.  В разделе **Общие** области **Изменение свойств** установите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

5.  Щелкните **Действие**, выберите **Топология**, затем **Опубликовать**. По запросу **Публикация топологии** нажмите кнопку **Далее**. При завершении публикации нажмите кнопку **Готово**.

6.  На этом сервере откройте мастер развертывания Skype для бизнеса Server. Click **Install or Update Skype for Business Server System**, and then click Setup or Remove Skype for Business Server **Components**. Нажмите кнопку **Перезапуск**.

7.  Нажмите **Далее**. На экране сводки будут отображаться действия по мере их выполнения. После завершения развертывания щелкните **Просмотреть журнал** для просмотра доступных файлов журнала. Нажмите кнопку **Готово**, чтобы завершить развертывание.
    
    Если сайт, содержащий неработающий пограничный пул, содержит интерфейсные серверы, которые все еще продолжают работать, необходимо обновить службу веб-конференций и службу аудио- и видеоконференций на этих интерфейсных пулах для использования работоспособного пограничного пула, расположенного на удаленном сайте. 

 ## <a name="fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server"></a>Отбой в пуле, используемом для федерации XMPP в Skype для бизнеса Server 

В организации присутствует только один пограничный пул, назначенный  качестве пула для федерации XMPP. Если этот пул перестанет работать, необходимо выполнить отработку отказа федерации XMPP для использования другого пограничного пула, чтобы федерация XMPP снова начала функционировать.\

При первой установке пограничных пулов и включении федерации XMPP можно упростить процедуру аварийного восстановления путем определения внешних SRV-записей DNS для всех пограничных пулов федерации XMPP, а не только одного. Каждая из этих SRV-записей должна содержать собственное значение приоритета. Весь трафик федерации XMPP проходит через пул с SRV-записью, имеющей наивысший приоритет. 

В следующей процедуре EdgePool1 — это пул, в котором изначально была размещена федерация XMPP, а EdgePool2 — пул, в котором будет размещена федерация XMPP.


### <a name="to-fail-over-the-edge-pool-used-for-xmpp-federation"></a>Отбой в пуле, используемом для федерации XMPP

1.  Если другой пограничный пул еще не развернут (т. е. единственный пограничный пул в настоящее время не работает), разверните новый пул. 

2.  На каждом пограничном сервере в новом пограничном пуле, который теперь размещает федерацию XMPP EdgePool2), запустите следующий командлет:
    
        Stop-CsWindowsService

3.  Выполните следующий командлет, чтобы переопределить маршрут федерации XMPP на сервер EdgePool2:
    
        Set-CsSite Site2 -XmppExternalFederationRoute EdgeServer2.contoso.com
    
    В этом примере Site2 — это сайт, содержащий пограничный пул, который в настоящее время содержит пограничный пул, через который проходит маршрут федерации XMPP, а EdgeServer2.contoso.com — это полное доменное имя пограничного сервера в этом пуле.

4.  На внешнем DNS-сервере измените запись узла A для федерации XMPP, чтобы она указывала на EdgeServer2.contoso.com.

5.  Если отсутствует SRV-запись федерации XMPP, которая разрешается в адрес пограничного пула, поддерживающего в настоящее время федерацию XMPP, необходимо добавить ее, как показано в следующем примере. В этой SRV-записи необходимо указать значение порта 5269.
    
        _xmpp-server._tcp.contoso.com

6.  Убедитесь, что на внешнем интерфейсе пограничного пула, в котором теперь размещена федерация XMPP, открыт порт 5269.

7.  Запустите службу на всех пограничных серверах в пограничном пуле, содержащем федерацию XMPP:
    
        Start-CsWindowsService


## <a name="fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation"></a>Отбой в пуле, используемом для федерации Skype для бизнеса Server или федерации XMPP 

After a failed Edge pool that used to host federation has been brought back online, use this procedure to fail back the Skype for Business Server federation route and/or the XMPP federation route to again use this restored Edge pool.

1.  Запустите службы пограничного сервера на пограничном пуле, который снова доступен.

2.  Чтобы восстановить маршрут федерации Skype для бизнеса Server для использования восстановленного сервера, сделайте следующее:
    
      - На интерфейсном сервере откройте построитель топологий. Разверните узел **Пограничные пулы**, затем щелкните правой кнопкой мыши пограничный сервер или пул пограничных серверов, настроенный в настоящее время для федерации. Выберите пункт **Изменить свойства**.
    
      - В поле **Edit Properties** (Изменить свойства) раздела **General** (Общие) снимите флажок **Enable federation for this Edge pool (Port 5061)** (Разрешить федерацию для этого пограничного пула (порт 506)). Нажмите кнопку **ОК**.
    
      - Разверните **пограничные пулы**, затем щелкните правой кнопкой исходный пограничный сервер или пул пограничного сервера, который необходимо снова использовать для федерации. Выберите **Edit properties** (Изменить свойства).
    
      - В поле **Edit Properties** (Изменить свойства) раздела **General** (Общие) установите флажок **Enable federation for this Edge pool (Port 5061)** (Разрешить федерацию для этого пограничного пула (порт 506)). Нажмите кнопку **ОК**.
    
      - Щелкните **Действие**, выберите **Топология**, затем **Опубликовать**. По запросу **Публикация топологии** нажмите кнопку **Далее**. При завершении публикации нажмите кнопку **Готово**.
    
      - На этом сервере откройте мастер развертывания Skype для бизнеса Server. Click **Install or Update Skype for Business Server System**, then click Setup or Remove Skype for Business Server **Components**. Нажмите кнопку **Перезапуск**.
    
      - Нажмите **Далее**. На экране сводки будут отображаться действия по мере их выполнения. После завершения развертывания щелкните **Просмотреть журнал** для просмотра доступных файлов журнала. Щелкните **Finish** (Готово) для завершения развертывания.

3.  Если необходимо восстановить маршрутизацию федерации XMPP для использования восстановленного пограничного сервера, выполните следующие действия:
    
      - Выполните следующий командлет, чтобы повторно указать маршрут федерации XMPP к пограничному пулу, в котором теперь будет размещаться федерация XMPP (в данном примере — EdgeServer1):
        
            Set-CsSite Site1 -XmppExternalFederationRoute EdgeServer1.contoso.com
        
        В данном примере Site1 — это сайт, содержащий пограничный пул, в котором теперь размещается маршрут федерации XMPP, а EdgeServer1.contoso.com — это полное доменное имя пограничного сервера в этом пуле.
    
      - Если у вас пока нет записи DNS SRV для федерации XMPP, которая разрешается в пограничный пул, где будет размещаться федерация XMPP, вы должны добавить ее, как указано в следующем примере. Для этой записи SRV необходимо указать значение порта 5269.
        
            _xmpp-server._tcp.contoso.com
    
      - На внешнем DNS-сервере измените запись DNS A для федерации XMPP таким образом, чтобы она указывала на EdgeServer2.contoso.com.
    
      - Убедитесь, что порт 5269 пограничного пула, в котором теперь будет размещаться федерация XMPP, открыт на внешнем уровне.

4.  Если пулы переднего края остаются работающими на сайте, содержаном сбойного пула и восстановленном, следует обновить службу веб-служб и службу видео- и видеоконференций в этих пулах переднего края, чтобы снова использовать пулы edge на локальном сайте.

5.  Если происходит сбой пула переднего плана на том же сайте, где располагается отказавший пограничный пул, можно использовать Invoke–CsPoolFailback для восстановления пула переднего плана.


## <a name="change-the-edge-pool-associated-with-a-front-end-pool"></a>Изменение пула, связанного с пулом переднего края

Если пограничный пул отключается, однако интерфейсный пул все еще работает, необходимо указать для интерфейсного пула использование пограничного пула в другом сайте, пока не будет восстановлена работоспособность сбойного пограничного пула.

1.  В построителе топологий перейдите к имени интерфейсного пула, который необходимо изменить.

2.  Щелкните правой кнопкой мыши соответствующий пул, а затем выберите **Изменить свойства**.

3.  В разделе **Связи** под надписью **Сопоставить пограничный пул (для компонентов мультимедиа)** используйте раскрывающееся поле для выбора пограничного пула, с которым следует сопоставить интерфейсный пул.

4.  Нажмите кнопку **ОК**.
