---
title: Отработка отказа для пула
ms.reviewer: ''
author: SerdarSoysal
ms.author: serdars
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
description: .
ms.openlocfilehash: 0b1f79ff40584c82d6da603ede49004f3c0c8968
ms.sourcegitcommit: 296862e02b548f0212c9c70504e65b467d459cc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2022
ms.locfileid: "65675041"
---
# <a name="failing-over-and-failing-back-a-pool-in-skype-for-business-server"></a>Отработка отказа и восстановление размещения пула в Skype для бизнеса Server

Используйте следующие процедуры, если один пул Front-End завершился сбоем и его необходимо выполнить отработку отказа, или пул, в котором была выполнена авария, снова подключен к сети и необходимо восстановить развертывание в обычном рабочем состоянии. Узнайте, как выполнить отработку отказа и восстановление размещения пограничного пула, используемого для федерации Skype для бизнеса или федерации XMPP, или изменить пул Edge, связанный с Front-End пулом.

- [Отработка отказа пула переднего плана](#fail-over-a-front-end-pool)
- [Восстановление размещения пула](#fail-back-a-pool)
- [Отработка отказа для пограничного пула, используемого для Skype для бизнеса Server федерации](#fail-over-the-edge-pool-used-for-skype-for-business-server-federation)
- [Отработка отказа для пограничного пула, используемого для федерации XMPP в Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server)
- [Восстановление размещения пограничного пула, используемого для Skype для бизнеса Server федерации или федерации XMPP](#fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation)
- [Изменение пограничного пула, связанного с пулом переднего плана](#change-the-edge-pool-associated-with-a-front-end-pool)

## <a name="fail-over-a-front-end-pool"></a>Отработка отказа Front-End пула

Datacenter1 содержит Pool1, и сбой пула 1. Выполняется отработка отказа в пул 2, расположенный в центре обработки данных 2.

Большая часть работы по отработке отказа пула включает отработку отказа центрального хранилища управления, если это необходимо. Центральное хранилище управления должно работать при отработке отказа пользователей пула.

Если пул Front-End завершается сбоем, но пограничный пул на этом сайте по-прежнему работает, необходимо знать, использует ли пограничный пул пул сбоя в качестве пула следующего прыжка. В этом случае необходимо изменить пул Edge, чтобы использовать другой пул Front-End, прежде чем выполнять отработку отказа Front-End пула. Порядок изменения настройки следующего перехода по пулам зависит от того, будет ли пограничный пул использовать пул на том же сайте, на котором находится пограничный пул, или на другом сайте.

**Настройка пула Edge для использования пула следующего прыжка на том же сайте**

1. Откройте построитель топологий, щелкните правой кнопкой мыши пул Edge, который необходимо изменить, и выберите команду **"Изменить свойства"**.

2. Выберите **следующий прыжок**. В **списке пула следующего прыжка выберите** пул, который будет использоваться в качестве пула следующего прыжка.

3. Нажмите **кнопку "** ОК" и опубликуйте изменения.

**Настройка пограничного пула для использования пула следующего прыжка на другом сайте**

1. Откройте окно Skype для бизнеса Server Management Shell и введите следующий командлет:

    ```powershell
    Set-CsEdgeServer -Identity EdgeServer:<Edge Server pool FQDN> -Registrar Registrar:<NextHopPoolFQDN>
    ```

**Отработка отказа пула в случае аварии**

1. Найдите пул узлов для центрального сервера управления, введя следующий командлет на сервере Front-End Pool2:

    ```powershell
    Invoke-CsManagementServerFailover -Whatif
    ```

    В результатах этого командлета показано, в каком пуле в настоящее время размещается центральный сервер управления. В остальной части этой процедуры этот пул называется пулом CMS\_.

2. Используйте построитель топологий, чтобы найти версию Skype для бизнеса Server в пуле CMS\_. Если он выполняется Skype для бизнеса Server, используйте следующий командлет, чтобы найти пул резервных копий пула 1.

    ```powershell
    Get-CsPoolBackupRelationship -PoolFQDN <CMS_Pool FQDN>
    ```

    Пул резервных\_копий должен быть пулом резервных копий.

3. Проверьте состояние центрального хранилища управления с помощью следующего командлета:

    ```powershell
    Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
    ```

    Этот командлет должен показать, что activeMasterFQDN и ActiveFileTransferAgent указывают на полное доменное имя пула CMS\_. Если они пустые, центральный сервер управления недоступен и его необходимо выполнить отработку отказа.

4.  Если центральное хранилище управления недоступно или центральное хранилище управления выполнялось в пуле Pool1 (то есть в пуле, который завершился сбоем), перед отработкой отказа пула необходимо выполнить отработку отказа центрального сервера управления. Если необходимо выполнить отработку отказа центрального сервера управления, размещенного в пуле, Skype для бизнеса Server, используйте командлет на шаге 5 этой процедуры. Если отработка отказа центрального сервера управления не требуется, перейдите к шагу 7 этой процедуры.

5.  Чтобы выполнить отработку отказа центрального хранилища управления в пуле, Skype для бизнеса Server, выполните следующие действия.

    1. Сначала проверьте, какой Back-End Server\_в пуле резервных копий запускает основной экземпляр центрального хранилища управления, введя следующую команду:

        ```powershell
        Get-CsDatabaseMirrorState -DatabaseType Centralmgmt -PoolFqdn <Backup_Pool Fqdn>
        ```
    
    1. Если основным сервером Back-End в пуле резервных\_копий является основной сервер, введите:

        ```powershell        
        Invoke-CSManagementServerFailover -BackupSQLServerFqdn <Backup_Pool Primary BackEnd Server FQDN> -BackupSQLInstanceName <Backup_Pool Primary SQL Instance Name>
        ```
        
    1. Если зеркальный сервер Back-End в пуле\_резервных копий является основным, введите:
    
        ```powershell
        Invoke-CSManagementServerFailover -MirrorSQLServerFqdn <Backup_Pool Mirror BackEnd Server FQDN> -MirrorSQLInstanceName <Backup_Pool Mirror SQL Instance Name>
        ```
    
    1. Убедитесь, что отработка отказа центрального сервера управления завершена. Введите следующую команду:
    
        ```powershell    
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
        ```
        
        Убедитесь, что activeMasterFQDN и ActiveFileTransferAgent указывают на полное доменное имя пула резервных копий\_.
    
    1. Наконец, проверьте состояние реплики для всех серверов Front-End, введя следующую команду:
        
        ```powershell
        Get-CsManagementStoreReplicationStatus 
        ```
        
        Проверьте, все ли реплики имеют значение True.
        
        Перейдите к действию 7 этой процедуры.

6.  Установите центральное хранилище управления на внутреннем сервере пула резервных копий\_.
    
    1. Сначала выполните следующую команду:

        ```powershell
        Install-CsDatabase -CentralManagementDatabase -Clean -SqlServerFqdn <Backup_Pool Back End Server FQDN> -SqlInstanceName rtc  
        ```
    
    1. Выполните следующую команду на одном\_из серверов переднего плана пула резервных копий, чтобы принудительно переместить центральное хранилище управления:

        ```powershell
        Move-CsManagementServer -ConfigurationFileName c:\CsConfigurationFile.zip -LisConfigurationFileName c:\CsLisConfigurationFile.zip -Force
        ```
    
    1. Проверьте, выполнилось ли перемещение.

        ```powershell
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
        ```
        
        Убедитесь, что activeMasterFQDN и ActiveFileTransferAgent указывают на полное доменное имя пула резервных копий\_.
    
    1. Проверьте состояние реплики для всех серверов переднего плана, введя следующую команду:

        ```powershell
        Get-CsManagementStoreReplicationStatus
        ```
        
        Проверьте, все ли реплики имеют значение True.
    
    1. Установите службу центрального сервера управления на остальных серверах переднего плана в пуле резервных копий\_. Для этого выполните следующую команду на всех серверах переднего плана, за исключением того, который использовался при принудительном перемещении центрального хранилища управления ранее в этой процедуре:

        ```console
        Bootstrapper /Setup
        ```

7.  Выполните отработку отказа пользователей из Pool1 в Pool2, выполнив следующий командлет в окне Skype для бизнеса Server командной консоли:

    ```powershell
    Invoke-CsPoolFailover -PoolFQDN <Pool1 FQDN> -DisasterMode -Verbose
    ```
    
    Так как действия, выполненные в предыдущих частях этой процедуры для проверки состояния центрального хранилища управления, не являются универсальными, существует вероятность того, что этот командлет завершится ошибкой, так как центральное хранилище управления еще не полностью завершилось отработкой отказа. В этом случае необходимо исправить центральное хранилище управления на основе отображаемого сообщения об ошибках, а затем снова запустить этот командлет.
    
    Если выводится приводимое ниже сообщение об ошибке, необходимо изменить пограничный пул на данном сайте, чтобы использовать до обхода отказавшего пула другой пул в качестве следующего перехода. Подробности см. в описании процедур в начале этой статьи.
    
    ```console
    Invoke-CsPoolFailOver : This Front-end pool "pool1.contoso.com" is specified in
    topology as the next hop for the Edge server. Failing over this pool may cause External
    access/Federation/Split-domain/XMPP features to stop working. Please use Topology Builder to
    change the Edge internal next hop setting to point to a different Front-end pool,  before you
    proceed.
    ```


## <a name="fail-back-a-pool"></a>Восстановление размещения пула

После возврата пула, в котором возникла аварийная ситуация, в режим работы (в данном примере это Pool1) выполните следующие действия для восстановления обычного рабочего состояния развертывания.

Процесс восстановления размещения занимает несколько минут. Для справки предполагается, что для пула из 20 000 пользователей потребуется до 60 минут.

Восстановите размещение пользователей, которые изначально размещались в пуле Pool1 и были переключены на пул Pool2; для этого введите следующий командлет:

```powershell
Invoke-CsPoolFailback -PoolFQDN <Pool1 FQDN> -Verbose
```

Другие действия не требуются. При отработке отказа центрального сервера управления его можно оставить в pool2.

## <a name="fail-over-the-edge-pool-used-for-skype-for-business-server-federation"></a>Отработка отказа для пограничного пула, используемого для Skype для бизнеса Server федерации 

Если пул Edge, в котором Skype для бизнеса Server настроена федерация, выходит из строя, необходимо изменить федерацию, чтобы использовать другой пограничный пул для работы федерации.

1.  На интерфейсном сервере откройте построитель топологии. **Разверните пограничные пулы**, а затем щелкните правой кнопкой мыши пограничный сервер или пограничный пул серверов, настроенный в настоящее время для федерации. Выберите пункт **Изменить свойства**.

2.  В разделе **Общие** области **Изменение свойств** снимите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

3.  **Разверните пограничные пулы**, а затем щелкните правой кнопкой мыши пограничный сервер или пограничный пул серверов, который вы хотите использовать для федерации. Выберите пункт **Изменить свойства**.

4.  В разделе **Общие** области **Изменение свойств** установите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

5.  Выберите **"Действие**", " **Топология**", "Опубликовать **"**. При появлении запроса **на публикацию топологии** нажмите кнопку **"Далее"**. По завершении публикации нажмите кнопку **"Готово"**.

6.  На пограничном сервере откройте мастер Skype для бизнеса Server развертывания. Выберите **"Установить или обновить Skype для бизнеса Server"**, а затем выберите "Установка **" или "Skype для бизнеса Server компонентов"**. Нажмите **кнопку "Выполнить еще раз"**.

7.  Нажмите кнопку **Далее**. В окне сводки будут показаны действия по мере их выполнения. После завершения развертывания выберите " **Просмотреть журнал",** чтобы просмотреть доступные файлы журналов. Нажмите **кнопку "** Готово", чтобы завершить развертывание.
    
    Если сайт, содержащий неуданный пограничный пул, содержит серверы переднего плана, которые все еще работают, необходимо обновить службу веб-конференций и службу конференц-связи A/V в этих пулах Front-End, чтобы использовать пограничный пул на удаленном сайте, который все еще работает. 

 ## <a name="fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server"></a>Отработка отказа для пограничного пула, используемого для федерации XMPP в Skype для бизнеса Server 

В организации присутствует только один пограничный пул, назначенный  качестве пула для федерации XMPP. Если этот пул перестанет работать, необходимо выполнить отработку отказа федерации XMPP для использования другого пограничного пула, чтобы федерация XMPP снова начала функционировать.\

При первой установке пограничных пулов и включении федерации XMPP можно упростить процедуру аварийного восстановления путем определения внешних SRV-записей DNS для всех пограничных пулов федерации XMPP, а не только одного. Каждая из этих SRV-записей должна содержать собственное значение приоритета. Весь трафик федерации XMPP проходит через пул с SRV-записью, имеющей наивысший приоритет. 

В следующей процедуре EdgePool1 — это пул, в котором изначально размещались федерации XMPP, а EdgePool2 — это пул, в котором теперь будет размещена федерация XMPP.
### <a name="to-fail-over-the-edge-pool-used-for-xmpp-federation"></a>Отработка отказа пограничного пула, используемого для федерации XMPP

1.  Если у вас еще нет другого развернутого пограничного пула (кроме того, который в настоящее время не работает), разверните этот пул. 

2.  На каждом пограничном сервере в новом пограничном пуле, который теперь размещает федерацию XMPP EdgePool2), запустите следующий командлет:

    ```powershell
    Stop-CsWindowsService
    ```

3.  Выполните следующий командлет, чтобы переопределить маршрут федерации XMPP на сервер EdgePool2:

    ```powershell
    Set-CsSite Site2 -XmppExternalFederationRoute EdgeServer2.contoso.com
    ```
    
    В этом примере Site2 — это сайт, содержащий пограничный пул, который в настоящее время содержит пограничный пул, через который проходит маршрут федерации XMPP, а EdgeServer2.contoso.com — это полное доменное имя пограничного сервера в этом пуле.

4.  На внешнем DNS-сервере измените запись узла A для федерации XMPP, чтобы она указывала на EdgeServer2.contoso.com.

5.  Если отсутствует SRV-запись федерации XMPP, которая разрешается в адрес пограничного пула, поддерживающего в настоящее время федерацию XMPP, необходимо добавить ее, как показано в следующем примере. В этой SRV-записи необходимо указать значение порта 5269.

    ```console
    _xmpp-server._tcp.contoso.com
    ```

6.  Убедитесь, что на внешнем интерфейсе пограничного пула, в котором теперь размещена федерация XMPP, открыт порт 5269.

7.  Запустите службу на всех пограничных серверах в пограничном пуле, содержащем федерацию XMPP:

    ```powershell
    Start-CsWindowsService
    ```

## <a name="fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation"></a>Восстановление размещения пограничного пула, используемого для Skype для бизнеса Server федерации или федерации XMPP 

После того как невыполнение пула Edge, используемого для размещения федерации, было восстановлено, выполните эту процедуру, чтобы восстановить маршрут федерации Skype для бизнеса Server и (или) маршрут федерации XMPP, чтобы снова использовать этот восстановленный пограничный пул.

1.  Запустите службы пограничного сервера на пограничном пуле, который снова доступен.

2.  Если вы хотите восстановить маршрут Skype для бизнеса Server для использования восстановленного пограничного сервера, выполните следующие действия.
    
    1. На интерфейсном сервере откройте построитель топологии. **Разверните пограничные пулы**, а затем щелкните правой кнопкой мыши пограничный сервер или пограничный пул серверов, настроенный в настоящее время для федерации. Выберите пункт **Изменить свойства**.
    
    1. В разделе **Общие** области **Изменение свойств** снимите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
    1. **Разверните пограничные пулы**, а затем щелкните правой кнопкой мыши исходный пограничный сервер или пограничный пул серверов, который вы снова хотите использовать для федерации. Выберите пункт **Изменить свойства**.
    
    1. В разделе **Общие** области **Изменение свойств** установите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
    1. Выберите **"Действие**", " **Топология**", "Опубликовать **"**. При появлении запроса **на публикацию топологии** нажмите кнопку **"Далее"**. По завершении публикации нажмите кнопку **"Готово"**.
    
    1. На пограничном сервере откройте мастер Skype для бизнеса Server развертывания. Выберите **"Установить или обновить Skype для бизнеса Server"**, а затем выберите "Установка **" или "Skype для бизнеса Server компонентов"**. Нажмите **кнопку "Выполнить еще раз"**.
    
    1. Нажмите кнопку **Далее**. В окне сводки будут показаны действия по мере их выполнения. После завершения развертывания выберите " **Просмотреть журнал",** чтобы просмотреть доступные файлы журналов. Нажмите **кнопку "** Готово", чтобы завершить развертывание.

3.  Если необходимо восстановить маршрутизацию федерации XMPP для использования восстановленного пограничного сервера, выполните следующие действия:
    
    1. Выполните следующий командлет, чтобы повторно указать маршрут федерации XMPP к пограничному пулу, в котором теперь будет размещаться федерация XMPP (в данном примере — EdgeServer1):
  
        ```powershell
        Set-CsSite Site1 -XmppExternalFederationRoute EdgeServer1.contoso.com
        ```
        
        В данном примере Site1 — это сайт, содержащий пограничный пул, в котором теперь размещается маршрут федерации XMPP, а EdgeServer1.contoso.com — это полное доменное имя пограничного сервера в этом пуле.
    
    1. Если у вас пока нет записи DNS SRV для федерации XMPP, которая разрешается в пограничный пул, где будет размещаться федерация XMPP, вы должны добавить ее, как указано в следующем примере. Для этой записи SRV необходимо указать значение порта 5269.

        ```console
        _xmpp-server._tcp.contoso.com
        ```
    
    1. На внешнем DNS-сервере измените запись DNS A для федерации XMPP таким образом, чтобы она указывала на EdgeServer2.contoso.com.
    
    1. Убедитесь, что порт 5269 пограничного пула, в котором теперь будет размещаться федерация XMPP, открыт на внешнем уровне.

4.  Если пулы переднего плана оставались работающими на сайте, содержащему неустройки и восстановленный пограничный пул, следует обновить службу веб-конференций и службу конференц-связи A/V в этих интерфейсных пулах, чтобы снова использовать пограничные пулы на локальном сайте.

5.  Если происходит сбой пула переднего плана на том же сайте, где располагается отказавший пограничный пул, можно использовать Invoke–CsPoolFailback для восстановления пула переднего плана.


## <a name="change-the-edge-pool-associated-with-a-front-end-pool"></a>Изменение пограничного пула, связанного с пулом переднего плана

Если пограничный пул отключается, однако интерфейсный пул все еще работает, необходимо указать для интерфейсного пула использование пограничного пула в другом сайте, пока не будет восстановлена работоспособность сбойного пограничного пула.

1.  В построителе топологий перейдите к имени интерфейсного пула, который необходимо изменить.

2.  Щелкните пул правой кнопкой мыши и выберите команду **"Изменить свойства"**.

3.  В разделе **Связи** под надписью **Сопоставить пограничный пул (для компонентов мультимедиа)** используйте раскрывающееся поле для выбора пограничного пула, с которым следует сопоставить интерфейсный пул.

4.  Нажмите кнопку **ОК**.
