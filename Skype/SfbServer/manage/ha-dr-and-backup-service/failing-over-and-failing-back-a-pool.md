---
title: Отработка отказа для пула
ms.reviewer: ''
author: HowlinWolf-92
ms.author: v-mahoffman
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
description: .
ms.openlocfilehash: 55377e77a5b365a4db149ee69b6cd796e373a80b
ms.sourcegitcommit: 67324fe43f50c8414bb65c52f5b561ac30b52748
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/08/2021
ms.locfileid: "60849972"
---
# <a name="failing-over-and-failing-back-a-pool-in-skype-for-business-server"></a>Сбой и сбой обратного пула в Skype для бизнеса Server

Используйте следующие процедуры, если Front-End пула не удалось и должен быть сбой, или пул, который испытал бедствие, вернулся в режиме онлайн, и необходимо восстановить развертывание до обычного рабочего состояния. Узнайте, как отменить и отменить резерв Edge, используемый для федерации Skype для бизнеса федерации или федерации XMPP, или изменить пул Edge, связанный с Front-End пулом.

- [Сбой в пуле переднего конца](#fail-over-a-front-end-pool)
- [Сбой обратно пула](#fail-back-a-pool)
- [Fail over the Edge pool used for Skype для бизнеса Server federation](#fail-over-the-edge-pool-used-for-skype-for-business-server-federation)
- [Fail over the Edge pool used for XMPP federation in Skype для бизнеса Server](#fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server)
- [Отбой обратно в пуле Edge, используемом для Skype для бизнеса Server федерации или федерации XMPP](#fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation)
- [Изменение пула Edge, связанного с пулом переднего конца](#change-the-edge-pool-associated-with-a-front-end-pool)

## <a name="fail-over-a-front-end-pool"></a>Сбой в Front-End пула

Центр обработки данных1 содержит Pool1, а Пул1 не справился с обработкой. Не удается ок. Пул 2, расположенный в Центре обработки данных2.

Большая часть работы по отказу пула включает сбой в работе над хранилищем центрального управления, если это необходимо. Центральный магазин управления должен быть функциональным при сбойе пользователей пула.

Если пул Front-End не работает, но пул Edge на этом сайте по-прежнему работает, необходимо знать, использует ли пул Edge неудачный пул в качестве следующего пула хмеля. Если это так, необходимо изменить пул Edge, чтобы использовать другой пул Front-End, прежде чем сбой из-за Front-End пула. Порядок изменения настройки следующего перехода по пулам зависит от того, будет ли пограничный пул использовать пул на том же сайте, на котором находится пограничный пул, или на другом сайте.

**Настройка пула Edge для использования следующего пула хмеля на том же сайте**

1. Откройте топологию Builder, щелкните правой кнопкой мыши край пула, который необходимо изменить, и выберите **Изменить свойства**.

2. Выберите **следующий переход**. В следующем **пуле хмеля:** список выберите пул, который теперь будет выполнять функцию следующего пула.

3. Выберите **ОК** и опубликуй изменения.

**Настройка пула Edge для использования следующего пула хмеля на другом сайте**

1. Откройте окно Skype для бизнеса Server и введите следующий код:

    ```powershell
    Set-CsEdgeServer -Identity EdgeServer:<Edge Server pool FQDN> -Registrar Registrar:<NextHopPoolFQDN>
    ```

**Сбой в результате аварийной ситуации над пулом**

1. Найдите пул хозяйского сервера для центрального сервера управления, введя на Front-End в Pool2 следующие команды:

    ```powershell
    Invoke-CsManagementServerFailover -Whatif
    ```

    Результаты этого команды показывают, в котором пуле в настоящее время размещен Центральный сервер управления. В остальной части этой процедуры этот пул называется CMS \_ Pool.

2. Используйте Топологию Builder, чтобы найти версию Skype для бизнеса Server в пуле \_ CMS. Если он работает Skype для бизнеса Server, используйте следующий cmdlet, чтобы найти резервный пул пула пула 1.

    ```powershell
    Get-CsPoolBackupRelationship -PoolFQDN <CMS_Pool FQDN>
    ```

    Пул \_ резервного копирования будет резервным пулом.

3. Проверьте состояние центрального магазина управления следующим cmdlet:

    ```powershell
    Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
    ```

    Этот кодлет должен показать, что как ActiveMasterFQDN, так и ActiveFileTransferAgents указывают на FQDN cmS \_ Pool. Если они пусты, центральный сервер управления недопустим, и его необходимо сбой.

4.  Если центральный магазин управления недодоступн или если центральный магазин управления работает в пуле1 (то есть сбой пула), перед сбоем над пулом необходимо сбой в работе центрального сервера управления. Если требуется сбой в работе центрального сервера управления, который был организован в пуле, Skype для бизнеса Server, используйте этот комдлет в шаге 5 этой процедуры. Если вам не нужно сбой в центральном сервере управления, пропустите шаг 7 этой процедуры.

5.  Чтобы не сбой в центральном хранилище управления в пуле с Skype для бизнеса Server, сделайте следующее:

    1. Сначала проверьте, Back-End сервер в резервном пуле запускает основной экземпляр центра управления, введя \_ следующие данные:

        ```powershell
        Get-CsDatabaseMirrorState -DatabaseType Centralmgmt -PoolFqdn <Backup_Pool Fqdn>
        ```
    
    1. Если основной сервер Back-End резервного копирования является \_ основным, введите:

        ```powershell        
        Invoke-CSManagementServerFailover -BackupSQLServerFqdn <Backup_Pool Primary BackEnd Server FQDN> -BackupSQLInstanceName <Backup_Pool Primary SQL Instance Name>
        ```
        
    1. Если зеркальный Back-End в резервном пуле является \_ основным, введите:
    
        ```powershell
        Invoke-CSManagementServerFailover -MirrorSQLServerFqdn <Backup_Pool Mirror BackEnd Server FQDN> -MirrorSQLInstanceName <Backup_Pool Mirror SQL Instance Name>
        ```
    
    1. Проверьте, завершен ли сбой центрального сервера управления. Введите следующую команду:
    
        ```powershell    
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
        ```
        
        Убедитесь, что и ActiveMasterFQDN, и ActiveFileTransferAgents указывают на FQDN резервного \_ пула.
    
    1. Наконец, проверьте состояние реплики для всех Front-End серверов, введя следующие:
        
        ```powershell
        Get-CsManagementStoreReplicationStatus 
        ```
        
        Проверьте, все ли реплики имеют значение True.
        
        Перейдите к действию 7 этой процедуры.

6.  Установка центра управления на сервер резервного копирования резервного \_ копирования.
    
    1. Сначала выполните следующую команду:

        ```powershell
        Install-CsDatabase -CentralManagementDatabase -Clean -SqlServerFqdn <Backup_Pool Back End Server FQDN> -SqlInstanceName rtc  
        ```
    
    1. Запустите следующую команду на одном из передних конечных серверов резервного пула, чтобы заставить переместить \_ центральный магазин управления:

        ```powershell
        Move-CsManagementServer -ConfigurationFileName c:\CsConfigurationFile.zip -LisConfigurationFileName c:\CsLisConfigurationFile.zip -Force
        ```
    
    1. Проверьте, выполнилось ли перемещение.

        ```powershell
        Get-CsManagementStoreReplicationStatus -CentralManagementStoreStatus
        ```
        
        Убедитесь, что и ActiveMasterFQDN, и ActiveFileTransferAgents указывают на FQDN резервного \_ пула.
    
    1. Проверьте состояние реплики для всех серверов переднего плана, введя следующую команду:

        ```powershell
        Get-CsManagementStoreReplicationStatus
        ```
        
        Проверьте, все ли реплики имеют значение True.
    
    1. Установите службу Центрального сервера управления на остальные серверы переднего конца в резервном \_ пуле. Для этого запустите следующую команду на всех серверах переднего конца, за исключением команды, используемой при принуждении к переходу центра управления в начале этой процедуры:

        ```console
        Bootstrapper /Setup
        ```

7.  Сбой в работе пользователей из Пула1 в Пул2 при запуске следующего команды в окне Skype для бизнеса Server Management Shell:

    ```powershell
    Invoke-CsPoolFailover -PoolFQDN <Pool1 FQDN> -DisasterMode -Verbose
    ```
    
    Так как действия, предпринятые в предыдущих частях этой процедуры для проверки состояния магазина Central Management, не являются универсальными, вероятность сбой этого cmdlet сохраняется, так как хранилище Central Management еще не полностью завершено. В этом случае необходимо исправить центральный магазин управления на основе сообщений об ошибках, которые вы видите, а затем запустить этот комдлет снова.
    
    Если выводится приводимое ниже сообщение об ошибке, необходимо изменить пограничный пул на данном сайте, чтобы использовать до обхода отказавшего пула другой пул в качестве следующего перехода. Подробности см. в описании процедур в начале этой статьи.
    
    ```console
    Invoke-CsPoolFailOver : This Front-end pool "pool1.contoso.com" is specified in
    topology as the next hop for the Edge server. Failing over this pool may cause External
    access/Federation/Split-domain/XMPP features to stop working. Please use Topology Builder to
    change the Edge internal next hop setting to point to a different Front-end pool,  before you
    proceed.
    ```


## <a name="fail-back-a-pool"></a>Сбой обратно пула

После возврата пула, в котором возникла аварийная ситуация, в режим работы (в данном примере это Pool1) выполните следующие действия для восстановления обычного рабочего состояния развертывания.

Процесс сбойной работы занимает несколько минут. Для справки предполагается, что для пула из 20 000 пользователей может занять до 60 минут.

Восстановите размещение пользователей, которые изначально размещались в пуле Pool1 и были переключены на пул Pool2; для этого введите следующий командлет:

```powershell
Invoke-CsPoolFailback -PoolFQDN <Pool1 FQDN> -Verbose
```

Другие действия не требуются. Если вы не справился с управлением на центральном сервере управления, вы можете оставить его в Pool2.

## <a name="fail-over-the-edge-pool-used-for-skype-for-business-server-federation"></a>Fail over the Edge pool used for Skype для бизнеса Server federation 

Если пул Edge, в котором Skype для бизнеса Server федерации, выходит из нее, необходимо изменить федерацию, чтобы использовать другой пул Edge для работы федерации.

1.  На интерфейсном сервере откройте построитель топологии. **Расширьте пулы** Edge и нажмите правой кнопкой мыши в пуле edge server или edge server, который в настоящее время настроен для Федерации. Выберите пункт **Изменить свойства**.

2.  В разделе **Общие** области **Изменение свойств** снимите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

3.  **Расширьте пулы** Edge и нажмите правой кнопкой мыши в пуле edge server или Edge Server, которые вы теперь хотите использовать для Федерации. Выберите пункт **Изменить свойства**.

4.  В разделе **Общие** области **Изменение свойств** установите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.

5.  Выберите **действие,** выберите **топологию,** выберите **Опубликовать**. Когда предложено опубликовать **топологию,** выберите **Далее**. После завершения публикации выберите **Finish**.

6.  На сервере Edge откройте мастер Skype для бизнеса Server развертывания. Установите **или обновите Skype для бизнеса Server,** а затем выберите **установки или Skype для бизнеса Server компоненты**. Выберите **Выполнить снова**.

7.  Нажмите кнопку **Далее**. В окне сводки будут показаны действия по мере их выполнения. После развертывания выберите view **Log** для просмотра доступных файлов журнала. Выберите **Готово** для завершения развертывания.
    
    Если сайт, содержащий неудающийся пул Edge, содержит все еще запущенные серверы переднего конца, необходимо обновить службу веб-конференциалов и службу A/V conferencing на этих Front-End пулах, чтобы использовать пул Edge на удаленном сайте, который все еще работает. 

 ## <a name="fail-over-the-edge-pool-used-for-xmpp-federation-in-skype-for-business-server"></a>Fail over the Edge pool used for XMPP federation in Skype для бизнеса Server 

В организации присутствует только один пограничный пул, назначенный  качестве пула для федерации XMPP. Если этот пул перестанет работать, необходимо выполнить отработку отказа федерации XMPP для использования другого пограничного пула, чтобы федерация XMPP снова начала функционировать.\

При первой установке пограничных пулов и включении федерации XMPP можно упростить процедуру аварийного восстановления путем определения внешних SRV-записей DNS для всех пограничных пулов федерации XMPP, а не только одного. Каждая из этих SRV-записей должна содержать собственное значение приоритета. Весь трафик федерации XMPP проходит через пул с SRV-записью, имеющей наивысший приоритет. 

В следующей процедуре EdgePool1 — это пул, в котором изначально была организована федерация XMPP, а EdgePool2 — это пул, который теперь будет принимать федерацию XMPP.
### <a name="to-fail-over-the-edge-pool-used-for-xmpp-federation"></a>Сбой в пуле Edge, используемом для федерации XMPP

1.  Если у вас еще нет развернутого другого пула Edge (кроме того, который в настоящее время не работает), разверни этот пул. 

2.  На каждом пограничном сервере в новом пограничном пуле, который теперь размещает федерацию XMPP EdgePool2), запустите следующий командлет:

    ```powershell
    Stop-CsWindowsService
    ```

3.  Выполните следующий командлет, чтобы переопределить маршрут федерации XMPP на сервер EdgePool2:

    ```powershell
    Set-CsSite Site2 -XmppExternalFederationRoute EdgeServer2.contoso.com
    ```
    
    В этом примере Site2 — это сайт, содержащий пограничный пул, который в настоящее время содержит пограничный пул, через который проходит маршрут федерации XMPP, а EdgeServer2.contoso.com — это полное доменное имя пограничного сервера в этом пуле.

4.  На внешнем DNS-сервере измените запись узла A для федерации XMPP, чтобы она указывала на EdgeServer2.contoso.com.

5.  Если отсутствует SRV-запись федерации XMPP, которая разрешается в адрес пограничного пула, поддерживающего в настоящее время федерацию XMPP, необходимо добавить ее, как показано в следующем примере. В этой SRV-записи необходимо указать значение порта 5269.

    ```console
    _xmpp-server._tcp.contoso.com
    ```

6.  Убедитесь, что на внешнем интерфейсе пограничного пула, в котором теперь размещена федерация XMPP, открыт порт 5269.

7.  Запустите службу на всех пограничных серверах в пограничном пуле, содержащем федерацию XMPP:

    ```powershell
    Start-CsWindowsService
    ```

## <a name="fail-back-the-edge-pool-used-for-skype-for-business-server-federation-or-xmpp-federation"></a>Отбой обратно в пуле Edge, используемом для Skype для бизнеса Server федерации или федерации XMPP 

После того, как сбой в пуле Edge, который использовался для веб-трансляции федерации, используйте эту процедуру, чтобы восстановить маршрут федерации Skype для бизнеса Server и/или маршрут федерации XMPP, чтобы снова использовать восстановленный пул Edge.

1.  Запустите службы пограничного сервера на пограничном пуле, который снова доступен.

2.  Если вы хотите отойтки Skype для бизнеса Server федерации, чтобы использовать восстановленный edge Server, сделайте следующее:
    
    1. На интерфейсном сервере откройте построитель топологии. **Разойдитесь** по пулам Edge , нажмите правой кнопкой мыши на сервере Edge или в пуле edge server, который в настоящее время настроен для Федерации. Выберите пункт **Изменить свойства**.
    
    1. В разделе **Общие** области **Изменение свойств** снимите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
    1. **Разойдитесь** по пулам Edge и нажмите правой кнопкой мыши исходный пул edge server или edge server, который вы снова хотите использовать для Федерации. Выберите пункт **Изменить свойства**.
    
    1. В разделе **Общие** области **Изменение свойств** установите флажок **Включение федерации для этого пограничного пула (порт 5061)**. Нажмите кнопку **ОК**.
    
    1. Выберите **действие,** выберите **топологию,** выберите **Опубликовать**. Когда предложено опубликовать **топологию,** выберите **Далее**. После завершения публикации выберите **Finish**.
    
    1. На сервере Edge откройте мастер Skype для бизнеса Server развертывания. Выберите **установку или обновление Skype для бизнеса Server,** а затем установите или **удалите компоненты Skype для бизнеса Server.** Выберите **Выполнить снова**.
    
    1. Нажмите кнопку **Далее**. В окне сводки будут показаны действия по мере их выполнения. После развертывания выберите view **Log** для просмотра доступных файлов журнала. Выберите **Готово** для завершения развертывания.

3.  Если необходимо восстановить маршрутизацию федерации XMPP для использования восстановленного пограничного сервера, выполните следующие действия:
    
    1. Выполните следующий командлет, чтобы повторно указать маршрут федерации XMPP к пограничному пулу, в котором теперь будет размещаться федерация XMPP (в данном примере — EdgeServer1):
  
        ```powershell
        Set-CsSite Site1 -XmppExternalFederationRoute EdgeServer1.contoso.com
        ```
        
        В данном примере Site1 — это сайт, содержащий пограничный пул, в котором теперь размещается маршрут федерации XMPP, а EdgeServer1.contoso.com — это полное доменное имя пограничного сервера в этом пуле.
    
    1. Если у вас пока нет записи DNS SRV для федерации XMPP, которая разрешается в пограничный пул, где будет размещаться федерация XMPP, вы должны добавить ее, как указано в следующем примере. Для этой записи SRV необходимо указать значение порта 5269.

        ```console
        _xmpp-server._tcp.contoso.com
        ```
    
    1. На внешнем DNS-сервере измените запись DNS A для федерации XMPP таким образом, чтобы она указывала на EdgeServer2.contoso.com.
    
    1. Убедитесь, что порт 5269 пограничного пула, в котором теперь будет размещаться федерация XMPP, открыт на внешнем уровне.

4.  Если пулы переднего конца оставались запущенными на сайте, содержащим неудавшиеся и восстановленные пулы Edge, следует обновить службу веб-конференциалов и службу A/V Conferencing на этих пулах переднего конца, чтобы снова использовать пулы Edge на локальном сайте.

5.  Если происходит сбой пула переднего плана на том же сайте, где располагается отказавший пограничный пул, можно использовать Invoke–CsPoolFailback для восстановления пула переднего плана.


## <a name="change-the-edge-pool-associated-with-a-front-end-pool"></a>Изменение пула Edge, связанного с пулом переднего конца

Если пограничный пул отключается, однако интерфейсный пул все еще работает, необходимо указать для интерфейсного пула использование пограничного пула в другом сайте, пока не будет восстановлена работоспособность сбойного пограничного пула.

1.  В построителе топологий перейдите к имени интерфейсного пула, который необходимо изменить.

2.  Щелкните правой кнопкой мыши пул, а затем выберите **Изменить свойства**.

3.  В разделе **Связи** под надписью **Сопоставить пограничный пул (для компонентов мультимедиа)** используйте раскрывающееся поле для выбора пограничного пула, с которым следует сопоставить интерфейсный пул.

4.  Нажмите кнопку **ОК**.
