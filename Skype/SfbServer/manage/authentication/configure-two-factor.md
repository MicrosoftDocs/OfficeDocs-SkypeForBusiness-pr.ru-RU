---
title: Настройка двух факторов проверки подлинности в Skype для бизнеса Server
ms.reviewer: ''
ms.author: v-mahoffman
author: cichur
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
ms.collection: IT_Skype16
ms.assetid: c24e0891-e108-4cb6-9902-c6a4c8e68455
description: Сводка. Настройка двух факторов проверки подлинности в Skype для бизнеса Server.
ms.openlocfilehash: c1749c6fcd97e10f7e09ddc243059cedc695fb65
ms.sourcegitcommit: 65a10f80e5dfd67b2778e09f5f92c21ef09ce36a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2021
ms.locfileid: "60751798"
---
# <a name="configure-two-factor-authentication-in-skype-for-business-server"></a>Настройка двух факторов проверки подлинности в Skype для бизнеса Server

**Сводка:** Настройка двух факторов проверки подлинности в Skype для бизнеса Server.

В следующих разделах описываются действия, необходимые для настройки двух факторов проверки подлинности для развертывания. Дополнительные сведения о двухфакторной проверке подлинности см. в Office 365 многофакторной проверки подлинности для администраторов сети [— Grid User Post.](https://go.microsoft.com/fwlink/p/?LinkId=313332)

## <a name="configure-an-enterprise-root-certificate-authority-to-support-smart-card-authentication"></a>Настройка органа Enterprise корневого сертификата для поддержки проверки подлинности смарт-карт

Ниже описаны действия по настройке Enterprise Root CA для поддержки проверки подлинности смарт-карт:

Сведения о том, как установить Enterprise Root CA, см. в Enterprise Root [Certification Authority.](/previous-versions/windows/it-pro/windows-server-2003/cc776709(v=ws.10))

1. Войдите на компьютер Enterprise ca с помощью учетной записи администратора домена.

2. Запустите system Manager и убедитесь, что установлена роль веб-регистрации в Службе сертификации.

3. Из меню **"Административные инструменты"** откройте консоль **управления сертификацией.**

4. В области навигации расширь **управление сертификацией.**

5. Щелкните правой кнопкой мыши **шаблоны сертификатов,** выберите **Новый,** а затем выберите **шаблон сертификата для выпуска**.

6. Выберите **агента регистрации,** **пользователя smartcard и** логотип **Smartcard.**

7. Нажмите кнопку **ОК**.

8. Правой кнопкой мыши **по шаблонам сертификата**.

9. Выберите **Управление**.

10. Откройте свойства шаблона пользователя Smartcard.

11. Нажмите на **вкладку Безопасность.**

12. Измените разрешения следующим образом:

    - Добавление отдельных учетных записей AD пользователей с разрешениями На чтение и регистрацию (разрешить) или

    - Добавление группы безопасности, содержащей пользователей смарт-карт, с разрешениями на чтение и регистрацию (разрешить) или

    - Добавление группы пользователей домена с разрешениями на чтение и регистрацию (разрешить)

## <a name="configure-windows-8-for-virtual-smart-cards"></a>Настройка Windows 8 виртуальных смарт-карт

Одним из факторов, который следует учитывать при развертывании двух факторов проверки подлинности и технологии смарт-карт, является стоимость реализации. Windows 8 предоставляет ряд новых возможностей безопасности, и одна из самых интересных новых функций — поддержка виртуальных смарт-карт.

Для компьютеров, оснащенных чипом Доверенный модуль платформы (TPM), который соответствует спецификации версии 1.2, организации теперь могут получать преимущества логотипа смарт-карт, не внося дополнительных инвестиций в оборудование. Дополнительные сведения см. в [ссылке Использование виртуальных смарт-карт с Windows 8.](https://go.microsoft.com/fwlink/p/?LinkId=313365)

### <a name="to-configure-windows-8-for-virtual-smart-cards"></a>Настройка Windows 8 виртуальных смарт-карт

1. Войдите на Windows 8 с помощью учетных данных пользователя с Skype для бизнеса включенной поддержкой.

2. На Windows 8 начните с курсора в нижний правый угол экрана.

3. Выберите параметр **Search,** а затем поиск по запросуCommand.

4. Правой кнопкой мыши **по командной подсказке,** а затем выберите **Выполнить в качестве администратора**.

5. Откройте консоль управления доверенным модулем платформы (TPM) с помощью следующей команды:

   ```console
   Tpm.msc
   ```

6. На консоли управления TPM убедитесь, что версия спецификации TPM не менее 1.2

    > [!NOTE]
    > Если вы получаете диалоговое окно с указанием, что модуль совместимых платформ доверия (TPM) не может быть найден, убедитесь, что компьютер имеет совместимый модуль TPM и включен в системе BIOS.

7. Закрыть консоль управления TPM

8. Из командной подсказки создайте новую виртуальную смарт-карту с помощью следующей команды:

  ```console
  TpmVscMgr create /name MyVSC /pin default /adminkey random /generate
  ```

   > [!NOTE]
   > Чтобы обеспечить настраиваемую ПИН-кодовую ценность при создании виртуальной смарт-карты, используйте подсказку /pin-код.

9. Из командной подсказки откройте консоль управления компьютером, выив следующую команду:

  ```console
  CompMgmt.msc
  ```

10. В консоли Управление компьютером выберите **управление устройствами.**

11. Расширение **считывателей смарт-карт.**

12. Убедитесь, что новый виртуальный считыватель смарт-карт был успешно создан.

## <a name="enroll-users-for-smart-card-authentication"></a>Регистрация пользователей для проверки подлинности смарт-карт

Обычно существует два метода регистрации пользователей для проверки подлинности смарт-карт. Более простой метод состоит в том, чтобы пользователи зарегистрировались непосредственно для проверки подлинности смарт-карт с помощью веб-регистрации, а более сложный метод предполагает использование агента регистрации. В этом разделе основное внимание уделяется самозаверению сертификатов смарт-карт.

Дополнительные сведения о регистрации от имени пользователей в качестве агента регистрации см. в статью Регистрация на сертификаты от имени [других пользователей.](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/cc770802(v=ws.11))

### <a name="to-enroll-users-for-smart-card-authentication"></a>Регистрация пользователей для проверки подлинности смарт-карт

1. Войдите на Windows 8 рабочей станции с помощью учетных данных пользователя с Skype для бизнеса включенной поддержкой.

2. Запуск Internet Explorer.

3. Просмотрите **страницу веб-регистрации** в службе сертификации https://MyCA.contoso.com/certsrv) (например. .

    > [!NOTE]
    > Если вы используете Internet Explorer 10, вам может потребоваться просмотреть этот веб-сайт в режиме совместимости.

4. На странице **Welcome** выберите **Запрос сертификата**.

5. Далее выберите **Расширенный запрос**.

6. Выберите **Создать и отправить запрос в этот ЦС.**

7. Выберите **пользователя smartcard в** разделе Шаблон **сертификата** и выполните расширенный запрос сертификата со следующими значениями:

  - **Параметры key подтверждают,** что он следует за настройками:

    - Выберите **кнопку Создание нового набора ключей**

    - Для **CSP** выберите **поставщика криптографии Microsoft Base Smart Card**

    - Для **использования ключей** выберите **Exchange** (это единственный доступный вариант).

    - Для **размера ключей** введите 2048

    - Подтверждение выбора **имени контейнера автоматического** ключа

    - Оставьте остальные ящики неконтранными.

  - В **статье Дополнительные параметры** подтверждают следующие значения:

    - Для **формата запроса** выберите **CMC**.

    - Для **алгоритма hash выберите** **sha1**.

    - Для **дружеского имени** введите сертификатSmardcard.

8. Если вы используете физический считыватель смарт-карт, вставьте смарт-карту в устройство.

9. Щелкните **Отправить** для отправки запроса сертификата.

10. При запросе введите ПИН-код, который использовался для создания виртуальной смарт-карты.

    > [!NOTE]
    > Значение ПИН-кода виртуальной смарт-карты по умолчанию 12345678.

11. После выдачи сертификата нажмите **кнопку Установите этот сертификат,** чтобы завершить процесс регистрации.

    > [!NOTE]
    >  Если запрос сертификата не работает с ошибкой "Этот веб-браузер не поддерживает генерацию запросов сертификатов", существует три возможных способа решения проблемы:
    >- Включить представление совместимости в Internet Explorer.
    >- Включаем параметры Intranet в Internet Explorer.
    >- Выберите параметр Reset all zones to default level setting under the Security tab in the Internet Explorer options menu.

## <a name="configure-active-directory-federation-services-ad-fs-20"></a>Настройка служб Федерации Active Directory (AD FS 2.0)

В следующем разделе описывается настройка служб Федерации Active Directory (AD FS 2.0) для поддержки многофакторной проверки подлинности. Сведения об установке AD FS 2.0 см. в [ad FS 2.0 Step-by-Step и How To Guides.](/previous-versions/windows/it-pro/windows-server-2008-R2-and-2008/dd727938(v=ws.10))

> [!NOTE]
> При установке AD FS 2.0 не используйте Windows Server Manager для добавления роли служб Федерации Active Directory. Вместо этого скачайте и установите [службы Федерации Active Directory.](/troubleshoot/windows-server/identity/availability-description-afds)

### <a name="to-configure-ad-fs-for-two-factor-authentication"></a>Настройка AD FS для двух факторов проверки подлинности

1. Войдите на компьютер AD FS 2.0 с помощью учетной записи администратора домена.

2. Запустите Windows PowerShell.

3. Из Windows PowerShell командной строки запустите следующую команду:

  ```PowerShell
  add-pssnapin Microsoft.Adfs.PowerShell
  ```

4. Установить партнерские отношения с каждым сервером, который будет включен для пассивной проверки подлинности, заключив следующую команду, заменив имя сервера, определенное вашему развертыванию:

  ```PowerShell
  Add-ADFSRelyingPartyTrust -Name SfBPool01-PassiveAuth -MetadataURL https://SfBpool01.contoso.com/passiveauth/federationmetadata/2007-06/federationmetadata.xml
  ```

5. Из меню "Административные средства" запустите консоль управления AD FS 2.0.

6. Расширение **доверительные**  >  **отношения, опираясь на партийные траста.**

7. Убедитесь, что для вашего Skype для бизнеса Server создано новое доверие.

8. Создайте и назначьте правило авторизации выдачи для доверяющих сторон с Windows PowerShell с помощью следующих команд:

  ```PowerShell
  $IssuanceAuthorizationRules = '@RuleTemplate = "AllowAllAuthzRule" => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");'
  ```

  ```PowerShell
  Set-ADFSRelyingPartyTrust -TargetName SfBPool01-PassiveAuth
-IssuanceAuthorizationRules $IssuanceAuthorizationRules
  ```

9. Создайте и назначьте правило преобразования выдачи для доверяющих сторон с Windows PowerShell с помощью следующих команд:

  ```PowerShell
  $IssuanceTransformRules = '@RuleTemplate = "PassThroughClaims" @RuleName = "Sid" c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid"]=> issue(claim = c);'
  ```

  ```PowerShell
  Set-ADFSRelyingPartyTrust -TargetName SfBPool01-PassiveAuth -IssuanceTransformRules $IssuanceTransformRules
  ```

10. На консоли управления AD FS 2.0 нажмите правой кнопкой мыши на доверяемой стороне и выберите **правила редактирования утверждений.**

11. Выберите **вкладку Правила авторизации** выдачи и убедитесь, что новое правило авторизации было создано успешно.

12. Выберите **вкладку Правила преобразования** выдачи и убедитесь, что новое правило преобразования было создано успешно.

## <a name="configuring-ad-fs-20-to-support-client-authentication"></a>Настройка AD FS 2.0 для поддержки проверки подлинности клиентов

Существует два возможных типа проверки подлинности, которые можно настроить, чтобы разрешить AD FS 2.0 поддерживать проверку подлинности с помощью смарт-карт:

- Проверка подлинности на основе форм (FBA)

- Проверка подлинности клиента на уровне транспортного уровня

С помощью проверки подлинности на основе форм можно разработать веб-страницу, которая позволяет пользователям проверить подлинность либо с помощью имени пользователя или пароля, либо с помощью смарт-карты и ПИН-кода. В этом разделе основное внимание уделяется внедрению проверки подлинности клиента на уровне транспортного уровня с помощью AD FS 2.0. Дополнительные сведения о типах проверки подлинности AD FS 2.0 см. в дополнительных сведениях о типах проверки подлинности [AD FS 2.0.](https://go.microsoft.com/fwlink/p/?LinkId=313384)

### <a name="to-configure-ad-fs-20-to-support-client-authentication"></a>Настройка AD FS 2.0 для поддержки проверки подлинности клиентов

1. Войдите на компьютер AD FS 2.0 с помощью учетной записи администратора домена.

2. Запуск Windows Explorer.

3. Просмотрите C:\inetpub\adfs\ls

4. Сделайте копию резервного копирования существующего web.config файла.

5. Откройте существующий web.config с помощью Блокнот.

6. В панели Меню выберите **Изменить,** а затем выберите **Найти**.

7. Поиск \<localAuthenticationTypes\> .

    Обратите внимание, что в списке перечислены четыре типа проверки подлинности по одному на строку.

8. Переместите строку, содержащую тип проверки подлинности TLSClient, в верхнюю часть списка в разделе.

9. Сохранение и web.config файл.

10. Запуск командной подсказки с повышенными привилегиями.

11. Перезапустите IIS, запустив следующую команду:

  ```console
  IISReset /Restart /NoForce
  ```

## <a name="configuring-skype-for-business-server-passive-authentication"></a>Настройка Skype для бизнеса Server проверки подлинности

В следующем разделе описывается настройка Skype для бизнеса Server для поддержки пассивной проверки подлинности. После включения пользователям, включенным для двух факторов проверки подлинности, потребуется использовать физическую или виртуальную смарт-карту и действительный ПИН-код для входа в Skype для бизнеса клиента.

> [!NOTE]
> Настоятельно рекомендуется, чтобы клиенты могли включить пассивную проверку подлинности для регистратора и веб-служб на уровне служб. Если для регистратора и веб-служб на глобальном уровне включена пассивная проверка подлинности, это, скорее всего, приведет к сбоям проверки подлинности в масштабах всей организации для пользователей, которые не подписываются с поддерживаемым клиентом настольных компьютеров.

### <a name="web-service-configuration"></a>Конфигурация веб-служб

Ниже описано, как создать настраиваемую конфигурацию веб-служб для серверов директоров, Enterprise пулов и выпуск Standard, которые будут включены для пассивной проверки подлинности.

### <a name="to-create-a-custom-web-service-configuration"></a>Создание настраиваемой конфигурации веб-службы

1. Войдите на Skype для бизнеса Server сервер с помощью Skype для бизнеса учетной записи администратора.

2. Запуск оболочки Skype для бизнеса Server управления.

3. В командной строке Skype для бизнеса Server Management Shell создайте новую конфигурацию веб-службы для каждого сервера Director, Enterprise Pool и выпуск Standard, которая будет включена для пассивной проверки подлинности с помощью следующей команды:

  ```PowerShell
  New-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" -UseWsFedPassiveAuth $true -WsFedPassiveMetadataUri https://dc.contoso.com/federationmetadata/2007-06/federationmetadata.xml
  ```

   > [!CAUTION]
   > Значение FQDN WsFedPassiveMetadataUri — это имя службы федерации сервера AD FS 2.0. Значение Имя службы Федерации можно найти в консоли управления AD FS 2.0, щелкнув правой кнопкой мыши службу из области навигации и выбрав свойства  **службы Edit Federation.**

4. Убедитесь, что значения UseWsFedPassiveAuth и WsFedPassiveMetadataUri были заданы правильно, с помощью следующей команды:

  ```PowerShell
  Get-CsWebServiceConfiguration -identity "Service:WebServer:SfBPool01.contoso.com" | format-list UseWsFedPassiveAuth, WsFedPassiveMetadataUri
  ```

5. Для клиентов пассивная проверка подлинности является наименее предпочтительным методом проверки подлинности для проверки подлинности вебтикета. Для всех директоров, Enterprise пулов и выпуск Standard серверов, которые будут включены для пассивной проверки подлинности, все другие типы проверки подлинности должны быть отключены в Skype для бизнеса веб-службах при запуске следующего cmdlet:

  ```PowerShell
  Set-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" -UseCertificateAuth $false -UsePinAuth $false -UseWindowsAuth NONE
  ```

6. Убедитесь, что все другие типы проверки подлинности были успешно отключены при запуске следующего cmdlet:

  ```PowerShell
  Get-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" | format-list UseCertificateAuth, UsePinAuth, UseWindowsAuth
  ```

### <a name="proxy-configuration"></a>Конфигурация прокси

Если проверка подлинности сертификата отключена для Skype для бизнеса веб-служб, клиент Skype для бизнеса использует менее предпочтительный тип проверки подлинности, например Kerberos или NTLM, для проверки подлинности в службу Регистратора. Проверка подлинности сертификатов по-прежнему необходима для того, чтобы позволить клиенту получить вебтикет, однако Kerberos и NTLM должны быть отключены для службы Регистратора.

В следующих действиях описывается создание настраиваемой конфигурации прокси для edge Pools, Enterprise пулов и выпуск Standard серверов, которые будут включены для пассивной проверки подлинности.

### <a name="to-create-a-custom-proxy-configuration"></a>Создание настраиваемой конфигурации прокси

1. Из командной строки Skype для бизнеса Server Management Shell создайте новую прокси-конфигурацию для каждого Skype для бизнеса Server Edge Pool, Enterprise Pool и выпуск Standard сервера, который будет включен для пассивной проверки подлинности, запуская следующие команды:

  ```PowerShell
  New-CsProxyConfiguration -Identity "Service:EdgeServer:EdgePool01.contoso.com" -UseKerberosForClientToProxyAuth $False -UseNtlmForClientToProxyAuth $False
  ```

  ```PowerShell
  New-CsProxyConfiguration -Identity "Service:Registrar:SfBPool01.contoso.com" -UseKerberosForClientToProxyAuth $False -UseNtlmForClientToProxyAuth $False
  ```

2. Убедитесь, что все другие типы проверки подлинности прокси успешно отключены, выработав следующую команду:

  ```PowerShell
  Get-CsProxyConfiguration -Identity "Service:Registrar:SfBPool01.contoso.com" | format-list UseKerberosForClientToProxyAuth, UseNtlmForClientToProxyAuth, UseCertifcateForClientToProxyAuth
  ```

## <a name="see-also"></a>См. также

[Управление двух-факторной проверкой подлинности в Skype для бизнеса Server](two-factor-authentication.md)

[Используйте двух факторов проверку подлинности с Skype для бизнеса клиентом и Skype для бизнеса Server](use-two-factor.md)
