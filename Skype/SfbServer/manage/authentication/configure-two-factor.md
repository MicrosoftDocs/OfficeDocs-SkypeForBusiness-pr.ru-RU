---
title: Настройка двух коэффициентов проверки подлинности в Skype для бизнеса Server
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.collection: IT_Skype16
ms.assetid: c24e0891-e108-4cb6-9902-c6a4c8e68455
description: Сводка. Настройка двух коэффициентов проверки подлинности в Skype для бизнеса Server.
ms.openlocfilehash: a7c5b4489b6b39e924a85c5e99796044d892c11f
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49814419"
---
# <a name="configure-two-factor-authentication-in-skype-for-business-server"></a>Настройка двух коэффициентов проверки подлинности в Skype для бизнеса Server

**Сводка:** Настройка двух коэффициентов проверки подлинности в Skype для бизнеса Server.

В следующих разделах описаны действия, необходимые для настройки двух коэффициентов проверки подлинности для развертывания. Дополнительные сведения о двухфакторной проверке подлинности см. в подсистеме "Включение многофакторной проверки подлинности Office 365 для администраторов в Интернете [" Публикация пользователя сетки".](https://go.microsoft.com/fwlink/p/?LinkId=313332)

## <a name="configure-an-enterprise-root-certificate-authority-to-support-smart-card-authentication"></a>Настройка корпоративного корневого сертификата для поддержки проверки подлинности смарт-карт

Ниже описано, как настроить корпоративный корневой ЦС для поддержки проверки подлинности смарт-карт.

Сведения об установке корпоративного корневого ЦС см. в процедуре [установки корпоративного корневого ЦС.](https://go.microsoft.com/fwlink/p/?LinkID=313364)

1. Войдите на компьютер корпоративного ЦС с помощью учетной записи администратора домена.

2. Запустите System Manager и убедитесь, что установлена роль веб-регистрации в службе сертификации.

3. В меню **"Администрирование"** откройте консоль управления **"Сертификация".**

4. В области навигации разо **расширении сертификации.**

5. Щелкните правой **кнопкой мыши шаблоны сертификатов,** выберите **"Новый"** и выберите **"Шаблон сертификата для выдачи".**

6. Выберите **агент регистрации,** **пользователь смарт-карты** и **учетные данные смарт-карт.**

7. Нажмите кнопку **ОК**.

8. Щелкните правой **кнопкой мыши шаблоны сертификатов.**

9. Выберите **"Управление".**

10. Откройте свойства шаблона "Пользователь смарт-карты".

11. Щелкните **вкладку "Безопасность".**

12. Измените разрешения следующим образом:

    - Добавление учетных записей AD отдельных пользователей с разрешениями на чтение и регистрацию (разрешение) или

    - Добавление группы безопасности, содержащей пользователей смарт-карт с разрешениями на чтение и регистрацию (разрешение) или

    - Добавление группы "Пользователи домена" с разрешениями на чтение и регистрацию (разрешение)

## <a name="configure-windows-8-for-virtual-smart-cards"></a>Настройка Windows 8 виртуальных смарт-карт

Одним из факторов, которые следует учитывать при развертывании двух коэффициентов проверки подлинности и технологии смарт-карт, является стоимость реализации. Windows 8 предоставляет ряд новых возможностей безопасности, а одной из наиболее интересных новых функций является поддержка виртуальных смарт-карт.

На компьютерах, оснащенных микросхемой доверенного платформенного модуля (TPM), которая соответствует спецификации версии 1.2, организации теперь могут получить преимущества при вложениях в оборудование. Дополнительные сведения см. в [теме "Использование виртуальных смарт-карт с Windows 8.](https://go.microsoft.com/fwlink/p/?LinkId=313365)

### <a name="to-configure-windows-8-for-virtual-smart-cards"></a>Настройка Windows 8 виртуальных смарт-карт

1. Войдите на Windows 8, используя учетные данные пользователя, включенного в Skype для бизнеса.

2. На Windows 8 экрана переместите курсор в нижний правый угол экрана.

3. Выберите параметр **"Поиск",** а затем наберите "Command Prompt".

4. Щелкните правой **кнопкой** мыши командную подсказку и выберите команду **"Запуск от прав администратора".**

5. Откройте консоль управления доверенным платформенного модуля (TPM) с помощью следующей команды:

  ```console
  Tpm.msc
  ```

6. В консоли управления TPM убедитесь, что версия спецификации TPM не менее 1.2

    > [!NOTE]
    > Если вы получаете диалоговое окно с указанием того, что совместимый модуль платформы доверия (TPM) не найден, убедитесь, что на компьютере есть совместимый модуль TPM и что он включен в BIOS системы.

7. Закройте консоль управления TPM

8. Создайте виртуальную смарт-карту в командной области с помощью следующей команды:

  ```console
  TpmVscMgr create /name MyVSC /pin default /adminkey random /generate
  ```

    > [!NOTE]
    > Чтобы предоставить пользовательское значение ПИН-кода при создании виртуальной смарт-карты, используйте /pin-запрос.

9. Откройте консоль управления компьютером в командной командной консоли, выляв следующую команду:

  ```console
  CompMgmt.msc
  ```

10. В консоли "Управление компьютером" выберите **"Управление устройствами".**

11. Развернуть **считыватели смарт-карт.**

12. Убедитесь, что новое устройство чтения виртуальных смарт-карт успешно создано.

## <a name="enroll-users-for-smart-card-authentication"></a>Регистрация пользователей для проверки подлинности с смарт-картой

Обычно существует два способа регистрации пользователей для проверки подлинности с смарт-картой. Более простой способ состоит в том, чтобы пользователи зарегистрировались непосредственно для проверки подлинности смарт-карт с помощью веб-регистрации, в то время как более сложный метод включает использование агента регистрации. В этом разделе основное внимание уделяется самостоятельной регистрации сертификатов смарт-карт.

Дополнительные сведения о регистрации от имени пользователей в качестве агента регистрации см. в подсети "Регистрация сертификатов от имени [других пользователей".](https://go.microsoft.com/fwlink/p/?LinkID=313367)

### <a name="to-enroll-users-for-smart-card-authentication"></a>Регистрация пользователей для проверки подлинности смарт-карт

1. Войдите на Windows 8 рабочей станции, используя учетные данные пользователя, включенного в Skype для бизнеса.

2. Запустите Internet Explorer.

3. Перейдите на **страницу веб-регистрации в** службе сертификации (например, https://MyCA.contoso.com/certsrv)

    > [!NOTE]
    > Если вы используете Internet Explorer 10, может потребоваться просмотреть этот веб-сайт в режиме совместимости.

4. На странице **приветствия** выберите запрос **сертификата.**

5. Затем выберите **"Расширенный запрос".**

6. Выберите **"Создать" и отправьте запрос в этот ЦС.**

7. Выберите **"Пользователь смарт-карты"** в разделе **"Шаблон** сертификата" и выполните расширенный запрос сертификата со следующими значениями:

  - **Ключевые параметры** подтверждают, что он:

    - Select the **Create new key set** radio button

    - Для **CSP выберите** **microsoft Base Smart Card Crypto Provider**

    - Для **использования ключей** выберите **Exchange** (это единственный доступный вариант).

    - For **Key Size**, enter 2048

    - Подтверждение выбора **имени контейнера автоматического** ключа

    - Оставьте остальные флажки без флажков.

  - В **области дополнительных параметров** подтвердим следующие значения:

    - Для **формата запроса** выберите **CMC**.

    - Для **алгоритма hash select** **sha1**.

    - Для **friendly Name** enterSmardcard Certificate.

8. Если вы используете физическое устройство чтения смарт-карт, вставьте смарт-карту в устройство.

9. Нажмите **кнопку** "Отправить", чтобы отправить запрос на сертификат.

10. При запросе введите ПИН-код, который использовался для создания виртуальной смарт-карты.

    > [!NOTE]
    > Значение ПИН-кода виртуальной смарт-карты по умолчанию — "12345678".

11. После выдачи сертификата нажмите кнопку **"Установить этот сертификат",** чтобы завершить процесс регистрации.

    > [!NOTE]
    >  Если запрос сертификата не удается с ошибкой "Этот веб-браузер не поддерживает генерацию запросов на сертификаты", существует три возможных способа решения проблемы:

        a. Enable Compatibility View in Internet Explorer
        b. Enable the Turn on Intranet settings option in Internet Explorer
        c. Select the Reset all zones to default level setting under the Security tab in the Internet Explorer options menu.

## <a name="configure-active-directory-federation-services-ad-fs-20"></a>Настройка служб федерации Active Directory (AD FS 2.0)

В следующем разделе описывается настройка служб федерации Active Directory (AD FS 2.0) для поддержки многофакторной проверки подлинности. Сведения об установке AD FS 2.0 см. в пошаговом руководстве по [AD FS 2.0.](https://go.microsoft.com/fwlink/p/?LinkId=313374)

> [!NOTE]
> При установке AD FS 2.0 не добавляйте роль служб федерации Active Directory с помощью диспетчера Windows Server. Вместо этого скачайте и установите пакет служб федерации [Active Directory 2.0 RTW.](https://go.microsoft.com/fwlink/p/?LinkId=313375)

### <a name="to-configure-ad-fs-for-two-factor-authentication"></a>Настройка двух коэффициентов проверки подлинности для AD FS

1. Войдите на компьютер AD FS 2.0 с помощью учетной записи администратора домена.

2. Запустите Windows PowerShell.

3. В командной Windows PowerShell командной строки запустите следующую команду:

  ```PowerShell
  add-pssnapin Microsoft.Adfs.PowerShell
  ```

4. Создайте партнерство с каждым сервером, для которого будет включена пассивная проверка подлинности, выступая в следующей команде, заменяя имя сервера для конкретного развертывания:

  ```PowerShell
  Add-ADFSRelyingPartyTrust -Name SfBPool01-PassiveAuth -MetadataURL https://SfBpool01.contoso.com/passiveauth/federationmetadata/2007-06/federationmetadata.xml
  ```

5. В меню "Администрирование" запустите консоль управления AD FS 2.0.

6. **Расширйте отношения доверия** с отношениями доверия с  >  **отношениями с отношениями доверия с отношениями доверия.**

7. Убедитесь, что для Skype для бизнеса Server создано новое доверие.

8. Создайте и назначьте правило авторизации выдачи для отношения доверия с Windows PowerShell с помощью следующих команд:

  ```PowerShell
  $IssuanceAuthorizationRules = '@RuleTemplate = "AllowAllAuthzRule" => issue(Type = "https://schemas.microsoft.com/authorization/claims/permit", Value = "true");'
  ```

  ```PowerShell
  Set-ADFSRelyingPartyTrust -TargetName SfBPool01-PassiveAuth
-IssuanceAuthorizationRules $IssuanceAuthorizationRules
  ```

9. Создайте и назначьте правило преобразования выдачи для отношения доверия с Windows PowerShell с помощью следующих команд:

  ```PowerShell
  $IssuanceTransformRules = '@RuleTemplate = "PassThroughClaims" @RuleName = "Sid" c:[Type == "https://schemas.microsoft.com/ws/2008/06/identity/claims/primarysid"]=> issue(claim = c);'
  ```

  ```PowerShell
  Set-ADFSRelyingPartyTrust -TargetName SfBPool01-PassiveAuth -IssuanceTransformRules $IssuanceTransformRules
  ```

10. В консоли управления AD FS 2.0 щелкните правой кнопкой мыши отношения доверия с вашей стороной и выберите "Изменить **правила утверждений".**

11. Выберите **вкладку "Правила авторизации** выдачи" и убедитесь, что новое правило авторизации успешно создано.

12. Выберите **вкладку "Правила преобразования** выдачи" и убедитесь, что новое правило преобразования успешно создано.

## <a name="configuring-ad-fs-20-to-support-client-authentication"></a>Настройка AD FS 2.0 для поддержки проверки подлинности клиентов

Существует два возможных типа проверки подлинности, которые можно настроить, чтобы разрешить AD FS 2.0 поддерживать проверку подлинности с помощью смарт-карт:

- Проверка подлинности на основе форм (FBA)

- Проверка подлинности клиента уровня транспорта

С помощью проверки подлинности на основе форм можно разработать веб-страницу, которая позволяет пользователям проверить подлинность с помощью имени пользователя или пароля или смарт-карты и ПИН-кода. В этом разделе основное внимание уделяется реализации проверки подлинности клиента на уровне транспорта с помощью AD FS 2.0. Дополнительные сведения о типах проверки подлинности AD [](https://go.microsoft.com/fwlink/p/?LinkId=313384)FS 2.0 см. в этой теме.

### <a name="to-configure-ad-fs-20-to-support-client-authentication"></a>Настройка AD FS 2.0 для поддержки проверки подлинности клиентов

1. Войдите на компьютер AD FS 2.0 с помощью учетной записи администратора домена.

2. Запустите проводник Windows.

3. Перейдите в C:\inetpub\adfs\ls

4. Сделайте резервную копию существующего web.config файла.

5. Откройте существующий web.config с помощью Блокнота.

6. В панели меню выберите **"Правка",** а затем выберите **"Найти".**

7. Поиск по \<localAuthenticationTypes\> запросу .

    Обратите внимание, что в списке перечислены четыре типа проверки подлинности, по одному на строку.

8. Переместите строку, содержащую тип проверки подлинности TLSClient, в верхнюю часть списка в разделе.

9. Сохраните и закроите web.config файла.

10. Запустите командную подсказку с повышенными привилегиями.

11. Перезапустите IIS с помощью следующей команды:

  ```console
  IISReset /Restart /NoForce
  ```

## <a name="configuring-skype-for-business-server-passive-authentication"></a>Настройка пассивной проверки подлинности Skype для бизнеса Server

В следующем разделе описывается настройка Skype для бизнеса Server для поддержки пассивной проверки подлинности. После включения пользователям, для которых включена двух коэффициентная проверка подлинности, потребуется использовать физическую или виртуальную смарт-карту и действительный ПИН-код для входа в клиент Skype для бизнеса.

> [!NOTE]
> Настоятельно рекомендуется, чтобы клиенты могли включить пассивную проверку подлинности для регистратора и веб-служб на уровне службы. Если для регистратора и веб-служб включена пассивная проверка подлинности на глобальном уровне, скорее всего, это приведет к сбоям проверки подлинности для пользователей, которые не въехывают с помощью поддерживаемого настольного клиента.

### <a name="web-service-configuration"></a>Конфигурация веб-службы

Далее описано, как создать настраиваемую конфигурацию веб-служб для директоров, корпоративных пулов и серверов Standard Edition, которая будет включена для пассивной проверки подлинности.

### <a name="to-create-a-custom-web-service-configuration"></a>Создание настраиваемой конфигурации веб-службы

1. Войдите на сервер переднего сервера Skype для бизнеса Server с помощью учетной записи администратора Skype для бизнеса.

2. Запустите оболочку управления Skype для бизнеса Server.

3. В командной строке командной строки командной строки Skype для бизнеса Server создайте новую конфигурацию веб-службы для каждого директора, корпоративного пула и сервера Standard Edition, для которых будет включена пассивная проверка подлинности, вы можете использовать следующую команду:

  ```PowerShell
  New-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" -UseWsFedPassiveAuth $true -WsFedPassiveMetadataUri https://dc.contoso.com/federationmetadata/2007-06/federationmetadata.xml
  ```

    > [!CAUTION]
    > ЗначениеМ FQDN WsFedPassiveMetadataUri является имя службы федерации сервера AD FS 2.0. Значение "Имя службы федерации" можно найти в консоли управления AD FS  2.0, щелкнув правой кнопкой мыши службу в области навигации и выбрав "Изменить свойства службы федерации". 

4. Убедитесь, что значения UseWsFedPassiveAuth и WsFedPassiveMetadataUri заданы правильно, выдав следующую команду:

  ```PowerShell
  Get-CsWebServiceConfiguration -identity "Service:WebServer:SfBPool01.contoso.com" | format-list UseWsFedPassiveAuth, WsFedPassiveMetadataUri
  ```

5. Для клиентов пассивная проверка подлинности является наименее предпочтительным методом проверки подлинности webticket. Для всех директоров, корпоративных пулов и серверов Standard Edition, на которые будет включена пассивная проверка подлинности, все остальные типы проверки подлинности должны быть отключены в веб-службах Skype для бизнеса с помощью следующего cmdlet:

  ```PowerShell
  Set-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" -UseCertificateAuth $false -UsePinAuth $false -UseWindowsAuth NONE
  ```

6. Убедитесь, что все остальные типы проверки подлинности успешно отключены, выработав следующий cmdlet:

  ```PowerShell
  Get-CsWebServiceConfiguration -Identity "Service:WebServer:SfBPool01.contoso.com" | format-list UseCertificateAuth, UsePinAuth, UseWindowsAuth
  ```

### <a name="proxy-configuration"></a>Конфигурация прокси-сервера

Если для веб-служб Skype для бизнеса отключена проверка подлинности на сертификате, клиент Skype для бизнеса будет использовать менее предпочтительный тип проверки подлинности, например Kerberos или NTLM, для проверки подлинности в службе Регистратора. Проверка подлинности на сертификате по-прежнему необходима, чтобы клиент извлечения webticket, однако Kerberos и NTLM должны быть отключены для службы регистратора.

Далее описано, как создать настраиваемую конфигурацию прокси-сервера для пулов, корпоративных пулов и серверов Standard Edition, которые будут включены для пассивной проверки подлинности.

### <a name="to-create-a-custom-proxy-configuration"></a>Создание настраиваемой конфигурации прокси-сервера

1. В командной строке командной строки командной строки Skype для бизнеса Server создайте новую конфигурацию прокси-сервера для каждого пула skype для бизнеса Server, корпоративного пула и сервера Standard Edition, для которых будет включена пассивная проверка подлинности, вы можете использовать следующие команды:

  ```PowerShell
  New-CsProxyConfiguration -Identity "Service:EdgeServer:EdgePool01.contoso.com" -UseKerberosForClientToProxyAuth $False -UseNtlmForClientToProxyAuth $False
  ```

  ```PowerShell
  New-CsProxyConfiguration -Identity "Service:Registrar:SfBPool01.contoso.com" -UseKerberosForClientToProxyAuth $False -UseNtlmForClientToProxyAuth $False
  ```

2. Убедитесь, что все остальные типы проверки подлинности прокси-сервера успешно отключены, выработав следующую команду:

  ```PowerShell
  Get-CsProxyConfiguration -Identity "Service:Registrar:SfBPool01.contoso.com" | format-list UseKerberosForClientToProxyAuth, UseNtlmForClientToProxyAuth, UseCertifcateForClientToProxyAuth
  ```

## <a name="see-also"></a>См. также

[Управление двух-факторной проверкой подлинности в Skype для бизнеса Server](two-factor-authentication.md)

[Использование двух коэффициентов проверки подлинности в клиенте Skype для бизнеса и Skype для бизнеса Server](use-two-factor.md)
