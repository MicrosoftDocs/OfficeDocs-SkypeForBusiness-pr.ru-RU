---
title: Управление высокой доступностью и аварийное восстановление для сервера сохраняемой беседы в Skype для бизнеса Server 2015
ms.reviewer: ''
ms.author: v-cichur
author: cichur
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
localization_priority: Normal
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: Сводка. Узнайте, как управлять высокой доступностью и аварийной восстановлением сервера сохраняемой беседы в Skype для бизнеса Server 2015.
ms.openlocfilehash: 7ec7182d8fe2866499f731b43df712a69c44bc42
ms.sourcegitcommit: c528fad9db719f3fa96dc3fa99332a349cd9d317
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/12/2021
ms.locfileid: "49815049"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Управление высокой доступностью и аварийное восстановление для сервера сохраняемой беседы в Skype для бизнеса Server 2015
 
**Сводка:** Learn how to manage Persistent Chat Server high availability and disaster recovery in Skype for Business Server 2015.
  
В этом разделе описывается отбой и отбой сервера сохраняемой беседы. Перед чтением этого раздела ознакомьтесь с разделом "Планирование высокой доступности и аварийного восстановления для сервера сохраняемой беседы в Skype для бизнеса [Server 2015"](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md) и "Настройка высокой доступности и аварийного восстановления для сервера сохраняемой беседы в Skype для бизнеса [Server 2015".](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)

> [!NOTE]
> Сохраняемая беседа доступна в Skype для бизнеса Server 2015, но больше не поддерживается в Skype для бизнеса Server 2019. Такие же функции доступны в Teams. Дополнительные сведения [см. в сведениях о том,](/microsoftteams/upgrade-start-here)как начать обновление Microsoft Teams. Если необходимо использовать сохраняемого чата, вы можете либо перенести пользователей, которым требуются эти функции, в Teams, либо продолжить использование Skype для бизнеса Server 2015. 
  
## <a name="fail-over-persistent-chat-server"></a>Отбой сервера сохраняемой беседы

Отбой для сервера сохраняемого чата предназначен в основном для ручного процесса.
  
Процедура отключки основана на предположении, что дополнительный центр обработки данных запущен, но службы сервера сохраняемого чата, в котором расположена основная база данных сохраняемого чата, полностью недоступны, включая следующие:
  
- Базовая база данных сервера сохраняемой беседы и зеркальная база данных сервера сохраняемой беседы отсев.
    
- Сервер переднего сервера Skype для бизнеса Server недоумеет.
    
Вся процедура состоит из двух основных этапов:
  
- Восстановление основной базы данных сохраняемой беседы (mgc).
    
- Реализация зеркального отображения для новой базы данных-источника.
    
База данных соответствия сохраняемой беседы (mgccomp) не отлалачивается. Содержимое этой базы данных является временным и очищается по мере обработки данных адаптером соответствия. Вы как администратор сохраняемой беседы несете ответственность за правильное управление выходными данными адаптеров во избежание потери данных.
  
Чтобы перенаправить сервер сохраняемой беседы, сохраняемая беседа:
  
1. Удалите доставку журналов из базы данных доставки журналов резервной копии сервера сохраняемой беседы.
    
   - С помощью SQL Server Management Studio подключите к экземпляру базы данных, в котором расположена резервная база данных mgc сервера сохраняемой беседы.
    
   - Откройте окно отправки запроса в базу данных master.
    
   - Используйте следующую команду для сброса доставки журналов:
    
   ```SQL
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. Скопируйте все нескопированные файлы резервных копий из общей папки резервных копий в конечную папку копирования на резервном сервере.
    
3. По порядку примените все непримененные резервные копии журналов транзакций к базе данных-получателю. Подробные сведения см. в сведениях о применении резервного копирования журнала [транзакций (Transact-SQL).](https://go.microsoft.com/fwlink/p/?linkid=247428)
    
4. Подключите резервную базу данных mgc к сети. В окне запроса, которое было открыто в действии 1b, выполните следующие действия.
    
   - Завершите все подключения к базе данных mgc при их наличии:
    
   - **exec sp_who2** для определения подключений к базе данных mgc.
    
   - **kill \<spid\>** для окончания этих подключений.
    
   - Подключите базу данных к сети.
    
   - **восстановление базы данных mgc с восстановлением.**
    
5. In Skype for Business Server Management Shell, use the command **Set-CsPersistentChatState -Identity "service:atl-cs-001.litwareinc.com" -PoolState FailedOver** to fail over to the mgc backup database. Не забудьте заменить полное доменное имя пула сохраняемого чата для atl-cs-001.litwareinc.com.
    
    Резервная база данных mgc теперь выступает в качестве базы данных-источника.
    
6. In Skype for Business Server Management Shell, use the **Install-CsMirrorDatabase** cmdlet to establish a high availability mirror for the backup database that now serves as the primary database. Используйте экземпляр резервной базы данных в качестве базы данных источника и экземпляр резервной зеркальной базы данных в качестве экземпляра зеркала. Это не то же самое зеркало, которое изначально было настроено для базы данных-источника в процессе установки.
    
7. Установите активные серверы сохраняемой беседы. From the Skype for Business Server Management Shell, use the **Set-CsPersistentChatActiveServer** cmdlet to set the list of active servers.
    
    > [!IMPORTANT]
    > Все активные серверы должны располагаться в одном центре обработки данных с новой базой данных-источником или в центре обработки данных, имеющем подключение к базе данных с низкой задержкой и высокой пропускной способностью. 
  
    На этом этапе успешно завершается отбой из основной базы данных сервера сохраняемой беседы в резервную базу данных сервера сохраняемой беседы.
    
## <a name="fail-back-persistent-chat-server"></a>Отбой сервера сохраняемой беседы

В этой процедуре описаны действия, необходимые для восстановления после сбоя сервера сохраняемого чата и восстановления операций из основного центра обработки данных.
  
Во время сбоя сервера сохраняемого чата основной центр обработки данных полностью перебои, а основная и зеркальная базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.
  
Ниже описывается процедура возобновления нормальной работы после восстановления основной базы данных и подключения серверов. В этой процедуре предполагается, что основной центр обработки данных был восстановлен после полного отключения и что база данных mgc и база данных mgccomp были перестроены и переустановлены с помощью построщика топологий.
  
В процедуре также предполагается, что в период от сбойа не были развернуты новые зеркальные серверы и резервные серверы, а единственным развернутым сервером является резервный сервер и его зеркальный сервер, как было определено ранее в процедуре "Отбой через сервер сохраняемого чата".
  
Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.
  
1. Clear all servers from the Persistent Chat Server Active Server list by using the **Set-CsPersistentChatActiveServer** cmdlet from the Skype for Business Server Management Shell. Это останавливает подключение всех серверов сохраняемого чата к базе данных mgc и базе данных mgccomp во время отката.
    
    > [!IMPORTANT]
    > Агент SQL Server на дополнительном тыловом сервере сохраняемого чата должен работать под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения: 
  
   - доступ на чтение к сетевой папке, в которую помещаются резервные копии;
    
   - доступ на запись к локальному каталогу, в который они копируются.
    
2. Отключите зеркальное отображение для резервной базы данных mgc.
    
   - Подключите SQL Server Management Studio к резервному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
   - Щелкните **Удалить зеркальное отображение**.
    
   - При появлении запроса на подтверждение нажмите кнопку **ОК**.
    
   - Выполните те же действия для базы данных mgccomp.
    
3. Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
   - Подключите SQL Server Management Studio к резервному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
   - В списке **Тип резервной копии** выберите пункт **Полная**.
    
   - В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
   - В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
   -  *\<Optional\>*  В **описании** введите описание резервного набора.
    
   - Удалите расположение резервной копии по умолчанию из списка назначений.
    
   - Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
   - Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.
    
4. Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
   - Подключите SQL Server Management Studio к основному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
   - Выберите пункт **С устройства**.
    
   - Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
   - В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
   - В области **Выбор страницы** щелкните **Параметры**.
    
   - В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
   - На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
   - Нажмите кнопку **ОК**, чтобы начать процесс восстановления.
    
5. Настройте SQL Server журналов для основной базы данных. Выполните процедуры в процедуре настройки высокой доступности и аварийного восстановления для сервера сохраняемой беседы в Skype для бизнеса [Server 2015,](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md) чтобы установить доставку журналов для основной базы данных mgc.
    
6. Установите активные серверы сохраняемой беседы. From the Skype for Business Server Management Shell, use the **Set-CsPersistentChatActiveServer** cmdlet to set the list of active servers.
    
    > [!IMPORTANT]
    > Все активные серверы должны располагаться в одном центре обработки данных с новой базой данных-источником или в центре обработки данных, имеющем подключение к базе данных с низкой задержкой и высокой пропускной способностью. 
  
Чтобы восстановить нормальное состояние пула, запустите следующую Windows PowerShell команду:
  
```PowerShell
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

Дополнительные сведения см. в разделе справки по [cmdlet Set-CsPersistentChatState.](https://docs.microsoft.com/powershell/module/skype/set-cspersistentchatstate?view=skype-ps)
  

