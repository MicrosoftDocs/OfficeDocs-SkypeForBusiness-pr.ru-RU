---
title: Управление высокой доступностью и аварийным восстановлением для сервера сохраняемого чата в Skype для бизнеса Server 2015
ms.reviewer: ''
ms.author: v-lanac
author: lanachin
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: 'Сводка: сведения о том, как управлять сохраняемым сервером в режиме высокой доступности и аварийным восстановлением в Skype для бизнеса Server 2015.'
ms.openlocfilehash: d46e34485f231d313475b4fdc5948a7262b324ed
ms.sourcegitcommit: 2cc98fcecd753e6e8374fc1b5a78b8e3d61e0cf7
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/08/2020
ms.locfileid: "40991984"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Управление высокой доступностью и аварийным восстановлением для сервера сохраняемого чата в Skype для бизнеса Server 2015
 
**Сводка:** Сведения о том, как управлять сохраняемым сервером в режиме высокой доступности и аварийным восстановлением в Skype для бизнеса Server 2015.
  
В этой статье описано, как переключиться на сохраняемый сервер чата и вернуть этот отказ. Перед тем как читать этот раздел, не забудьте прочитать [план для обеспечения высокой доступности и аварийного восстановления для постоянного сервера чата в Skype для бизнеса server 2015](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md) и [Настройте режим высокой доступности и аварийного восстановления для постоянного сервера чата в Skype для бизнеса Server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md).

> [!NOTE]
> Сохраняемый чат доступен в Skype для бизнеса Server 2015, но больше не поддерживается в Skype для бизнеса Server 2019. Такие же функции доступны в Teams. Дополнительные сведения см. в статье [Начало перехода на Microsoft Teams](/microsoftteams/upgrade-start-here). Если вам нужно использовать сохраняемый чат, то вы можете либо перенести пользователей, которым нужна эта функция, в Teams, либо продолжать использовать Skype для бизнеса Server 2015. 
  
## <a name="fail-over-persistent-chat-server"></a>Переключение на сохраняемый сервер чата

Отработка отказа для сервера сохраняемого чата разработана в основном как процесс вручную.
  
Процедура отработки отказа основывается на предположении, что дополнительный центр обработки данных работает, но службы сервера сохраняемого чата, в которых находится первичная база данных чата, полностью недоступны, в том числе следующие:
  
- База данных основного сервера и зеркальный сервер сохраняемого чата.
    
- Сервер клиентского доступа к Skype для бизнеса Server не работает.
    
Вся процедура состоит из двух основных этапов:
  
- Восстановите первичную базу данных сохраняемого чата (MGC).
    
- Реализация зеркального отображения для новой базы данных-источника.
    
Не отменяется переключение на базу данных соответствия требованиям в отношении сохраняемого чата (мгккомп). Содержимое этой базы данных является временным и очищается по мере обработки данных адаптером соответствия. Это ваша ответственность в том, чтобы правильно управлять выводом адаптера, чтобы избежать потери данных.
  
Порядок отработки отказа сервера сохраняемого чата
  
1. Удалите доставку журналов из базы данных для резервного копирования журналов на сервере.
    
   - С помощью SQL Server Management Studio подключитесь к экземпляру базы данных, в котором находится база данных MGC сервера сохраняемого чата.
    
   - Откройте окно отправки запроса в базу данных master.
    
   - Используйте следующую команду для сброса доставки журналов:
    
   ```SQL
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. Скопируйте все нескопированные файлы резервных копий из общей папки резервных копий в конечную папку копирования на резервном сервере.
    
3. По порядку примените все непримененные резервные копии журналов транзакций к базе данных-получателю. Подробности можно найти [в статье инструкции по применению резервной копии журнала транзакций (Transact-SQL)](https://go.microsoft.com/fwlink/p/?linkid=247428).
    
4. Подключите резервную базу данных mgc к сети. В окне запроса, которое было открыто в действии 1b, выполните следующие действия.
    
   - Завершите все подключения к базе данных mgc при их наличии:
    
   - Выполните команду **exec sp_who2**, чтобы определить подключения к базе данных mgc.
    
   - ** \<прервать\> SPID** , чтобы завершить эти подключения.
    
   - Подключите базу данных к сети:
    
   - **restore database mgc with recovery**.
    
5. В командной консоли управления Skype для бизнеса Server используйте команду **Set-ксперсистентчатстате-Identity "Service: ATL-CS-001.litwareinc.com"-Пулстате фаиледовер** , чтобы переходить на базу данных MGC Backup. Обязательно замените полное доменное имя в пуле Persistent Chat для узла atl-cs-001.litwareinc.com.
    
    Резервная база данных mgc теперь выступает в качестве базы данных-источника.
    
6. В командной консоли управления Skype для бизнеса Server используйте командлет **Install-ксмиррордатабасе** , чтобы установить зеркало высокой доступности для резервной базы данных, которая теперь используется в качестве базы данных-источника. Используйте экземпляр резервной базы данных в качестве базы данных-источника и экземпляр резервной зеркальной базы данных в качестве экземпляра зеркала. Это не то же самое зеркало, которое изначально было настроено для базы данных-источника в процессе установки.
    
7. Установите для сервера сохраняемые активные серверы чата. С помощью командлета **Set-ксперсистентчатактивесервер** можно настроить список активных серверов в командной консоли Skype для бизнеса Server.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая база данных-источник, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью. 
  
    На этом этапе резервная копия базы данных сервера сохраняемого чата будет успешно выполнена для базы данных архивации сервера сохраняемого чата.
    
## <a name="fail-back-persistent-chat-server"></a>Не удается вернуть сервер сохраняемого чата

В этой процедуре описаны действия, которые необходимо выполнить для восстановления после отказа сервера с постоянным чат, и для повторного выполнения операций из основного центра обработки данных.
  
В случае отказа сервера сохраняемого чата в основном центре обработки данных снижается полный сбой, и основная и зеркальная базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.
  
Ниже описывается процедура возобновления нормальной работы после восстановления базы данных-источника и подключения серверов. В этой процедуре предполагается, что основной центр обработки данных восстановлен из общего отключения и что база данных MGC и база данных мгккомп были перестроены и переустановлены с помощью построителя топологии.
  
Также предполагается, что в процессе отработки отказа не были развернуты новые зеркальные и резервные серверы и что единственный сервер, который был развернут, — это резервный и соответствующий зеркальный серверы, определенные в разделе "Отработка отказа сервером сохраняемого чата".
  
Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.
  
1. С помощью командлета **Set-ксперсистентчатактивесервер** в командной консоли управления Skype для бизнеса Server удалите все серверы из списка "активный сервер чата". Это прекратит выполнение всех постоянных серверов чата при подключении к базе данных MGC и базе данных мгккомп во время восстановления после сбоя.
    
    > [!IMPORTANT]
    > Агент SQL Server на дополнительном сервере сервера сохраняемого обратного чата должен выполняться под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения: 
  
   - доступ на чтение к сетевой папке, в которую помещаются резервные копии;
    
   - доступ на запись к локальному каталогу, в который они копируются.
    
2. Отключите зеркальное отображение для резервной базы данных mgc.
    
   - С помощью SQL Server Management Studio подключитесь к экземпляру резервной копии mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
   - Щелкните **Удалить зеркальное отображение**.
    
   - Нажмите **ОК**.
    
   - Выполните те же действия для базы данных mgccomp.
    
3. Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
   - С помощью SQL Server Management Studio подключитесь к экземпляру резервной копии mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
   - В списке **Тип резервной копии** выберите пункт **Полная**.
    
   - В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
   - В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
   -  * \<Необязательный\> *  В поле **Описание**введите описание набора резервных копий.
    
   - Удалите расположение резервной копии по умолчанию из списка назначений.
    
   - Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
   - Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.
    
4. Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
   - С помощью SQL Server Management Studio подключитесь к экземпляру основного mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
   - Выберите пункт **С устройства**.
    
   - Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
   - В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
   - В области **Выбор страницы** щелкните **Параметры**.
    
   - В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
   - На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
   - Нажмите кнопку **ОК**, чтобы начать процесс восстановления.
    
5. Настройте доставку журналов SQL Server для базы данных PRIMARY. Выполните действия, описанные в разделе [Настройка обеспечения высокой доступности и аварийного восстановления для постоянного сервера чата в Skype для бизнеса server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md) , чтобы установить доставку журналов для первичной базы данных mgc.
    
6. Установите для сервера сохраняемые активные серверы чата. С помощью командлета **Set-ксперсистентчатактивесервер** можно настроить список активных серверов в командной консоли Skype для бизнеса Server.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая база данных-источник, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью. 
  
Чтобы восстановить обычное состояние пула, выполните следующую команду Windows PowerShell:
  
```PowerShell
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

Дополнительные сведения см. в разделе справки с описанием командлета [Set-CsPersistentChatState](https://docs.microsoft.com/powershell/module/skype/set-cspersistentchatstate?view=skype-ps).
  

