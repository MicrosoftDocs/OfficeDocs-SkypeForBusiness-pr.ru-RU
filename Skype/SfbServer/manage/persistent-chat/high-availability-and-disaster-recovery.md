---
title: Управление высокой доступностью и аварийным восстановлением для сервера сохраняемого чата в Skype для бизнеса Server 2015
ms.author: serdars
author: SerdarSoysal
manager: serdars
ms.date: 1/31/2018
ms.audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
localization_priority: Normal
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: 'Сводка: Узнайте, как управлять сервера сохраняемого чата высокой доступности и аварийного восстановления в Скайп для Business Server 2015.'
ms.openlocfilehash: 477897362a01ae3ac6097c50eaed8f9ece31f49d
ms.sourcegitcommit: dd37c12a0312270955755ab2826adcfbae813790
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/04/2018
ms.locfileid: "25371636"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Управление высокой доступностью и аварийным восстановлением для сервера сохраняемого чата в Skype для бизнеса Server 2015
 
**Сводка:** Сведения об управлении сервера сохраняемого чата высокой доступности и аварийного восстановления в Скайп для Business Server 2015.
  
В этом разделе описывается, как выполнить отработку отказа и восстановления размещения обратно Persistent Chat Server. Перед прочтением данного раздела, обязательно прочитайте [Планирование высокой доступности и аварийного восстановления для сервера сохраняемого чата в Скайп для Business Server 2015](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md) и [Настройка высокой доступности и аварийного восстановления для сервера сохраняемого чата в Скайп для Бизнес-2015 сервера](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md).

> [!NOTE]
> Сохраняемый чат доступна в Скайп для Business Server 2015, но больше не поддерживается в Скайп для Business Server 2019. Те же функциональные возможности доступны в группах. Для получения дополнительных сведений см [Реализация из Скайп для бизнеса для групп Майкрософт](/microsoftteams/journey-skypeforbusiness-teams). Если необходимо использовать сохраняемого чата, возможны либо перенос пользователей, которым требуется эта функция групп, или для дальнейшего использования Скайп для Business Server 2015. 
  
## <a name="fail-over-persistent-chat-server"></a>Переключения сервера сохраняемого чата

Отработка отказа для сервера сохраняемого чата разрабатывалась ориентирована на ручное выполнение.
  
Процедура отработки отказа на основе предполагается, что центр дополнительных данных — это копирование и работает, но службы сервера сохраняемого чата, где расположена Persistent Chat базы данных-источника, полностью недоступен, включая следующие:
  
- Persistent Chat Server основной базы данных и сервера сохраняемого чата зеркальная база данных не работают.
    
- Скайп для сервера переднего плана Business Server не работает.
    
Вся процедура состоит из двух основных этапов:
  
- Восстановление Persistent Chat базы данных-источника (mgc).
    
- Реализация зеркального отображения для новой базы данных-источника.
    
Сохраняемый чат база данных соответствия (mgccomp) не отработки отказа. Содержимое этой базы данных является временным и очищается по мере обработки данных адаптером соответствия. Отвечает, администратор сохраняемого чата правильно управлять вывода адаптера, чтобы избежать потери данных.
  
Порядок отработки отказа сервера сохраняемого чата
  
1. Удалите доставку журналов из Persistent Chat Server резервного копирования базы данных доставки журналов.
    
   - С помощью SQL Server Management Studio, подключитесь к экземпляру базы данных, где расположена база данных mgc резервного копирования сервера сохраняемого чата.
    
   - Откройте окно отправки запроса в базу данных master.
    
   - Используйте следующую команду для сброса доставки журналов:
    
   ```
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. Скопируйте все нескопированные файлы резервных копий из общей папки резервных копий в конечную папку копирования на резервном сервере.
    
3. По порядку примените все непримененные резервные копии журналов транзакций к базе данных-получателю. Дополнительные сведения см [как: применение резервной копии журнала транзакций (Transact-SQL)](https://go.microsoft.com/fwlink/p/?linkid=247428).
    
4. Подключите резервную базу данных mgc к сети. В окне запроса, которое было открыто в действии 1b, выполните следующие действия.
    
   - Завершите все подключения к базе данных mgc при их наличии:
    
   - Выполните команду **exec sp_who2**, чтобы определить подключения к базе данных mgc.
    
   - **kill \<spid\> ** для завершения этих подключений.
    
   - Подключите базу данных к сети:
    
   - **restore database mgc with recovery**.
    
5. В Скайп консоли Business Server, используйте команду **Set-CsPersistentChatState-Identity «служба: atl-cs-001.litwareinc.com» - PoolState FailedOver** отработки отказа для резервного копирования базы данных mgc. Обязательно замените полное доменное имя в пуле Persistent Chat для узла atl-cs-001.litwareinc.com.
    
    Резервная база данных mgc теперь выступает в качестве базы данных-источника.
    
6. В Скайп для консоли Business Server используйте командлет **Install-CsMirrorDatabase** зеркального высокой доступности для резервного копирования базы данных, теперь выступает в качестве базы данных-источника. Используйте экземпляр резервной базы данных в качестве базы данных-источника и экземпляр резервной зеркальной базы данных в качестве экземпляра зеркала. Это не то же самое зеркало, которое изначально было настроено для базы данных-источника в процессе установки.
    
7. Настройка сервера сохраняемого чата активных серверов. Скайп для консоли Business Server используя командлет **Set-CsPersistentChatActiveServer** Установка списка активных серверов.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая база данных-источник, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью. 
  
    На этом этапе отработка отказа из базы данных-источника сервера сохраняемого чата для резервного копирования базы данных сервера сохраняемого чата выполняется успешно.
    
## <a name="fail-back-persistent-chat-server"></a>Сбой обратно Persistent Chat Server

В этом разделе описываются действия, необходимые для восстановления после сбоя сервера сохраняемого чата и возобновления взаимодействия с основным центром обработки данных.
  
Во время сбоя сервера сохраняемого чата основным центром обработки данных приходится сталкиваться полный отказ и основной и зеркальной базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.
  
Ниже описывается процедура возобновления нормальной работы после восстановления базы данных-источника и подключения серверов. В процедуре предполагается, что основным центром обработки данных были восстановлены из общий сбой, и, что базу данных mgc и базы данных mgccomp после перестроение и переустановить с помощью построителя топологий.
  
Также предполагается, что в процессе отработки отказа не были развернуты новые зеркальные и резервные серверы и что единственный сервер, который был развернут, — это резервный и соответствующий зеркальный серверы, определенные в разделе "Отработка отказа сервером сохраняемого чата".
  
Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.
  
1. Снимите все серверы из списка Persistent Chat Server Active Server с помощью командлета **Set-CsPersistentChatActiveServer** из Скайп для консоли Business Server. Это останавливает все Persistent Chat серверы из подключение к базе данных mgc и базы данных mgccomp во время восстановления размещения.
    
    > [!IMPORTANT]
    > Агент SQL Server на базу данных-получатель Persistent Chat Server Тыловой сервер должен выполняться под привилегированной учетной записи. В частности, эта учетная запись должна иметь следующие разрешения: 
  
   - доступ на чтение к сетевой папке, в которую помещаются резервные копии;
    
   - доступ на запись к локальному каталогу, в который они копируются.
    
2. Отключите зеркальное отображение для резервной базы данных mgc.
    
   - С помощью SQL Server Management Studio, подключитесь к резервному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
   - Щелкните **Удалить зеркальное отображение**.
    
   - Нажмите **ОК**.
    
   - Выполните те же действия для базы данных mgccomp.
    
3. Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
   - С помощью SQL Server Management Studio, подключитесь к резервному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
   - В списке **Тип резервной копии** выберите пункт **Полная**.
    
   - В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
   - В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
   -  * \<Необязательно\> *  В поле **Описание**введите описание резервного набора данных.
    
   - Удалите расположение резервной копии по умолчанию из списка назначений.
    
   - Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
   - Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.
    
4. Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
   - С помощью SQL Server Management Studio, подключитесь к основному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
   - Выберите пункт **С устройства**.
    
   - Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
   - В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
   - В области **Выбор страницы** щелкните **Параметры**.
    
   - В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
   - На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
   - Нажмите кнопку **ОК**, чтобы начать процесс восстановления.
    
5. Настройка доставки журналов SQL Server для базы данных-источника. Следуйте инструкциям в разделе [Настройка высокой доступности и аварийного восстановления для сервера сохраняемого чата в Скайп для Business Server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md) для установления доставки журналов для базы данных основного mgc.
    
6. Настройка сервера сохраняемого чата активных серверов. Скайп для консоли Business Server используя командлет **Set-CsPersistentChatActiveServer** Установка списка активных серверов.
    
    > [!IMPORTANT]
    > Все активные серверы должны быть расположены в том же центре обработки данных, что и новая база данных-источник, или подключенном к ней через соединение с низкой задержкой и высокой пропускной способностью. 
  
Для восстановления в пул в обычном состоянии выполните следующую команду Windows PowerShell:
  
```
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

Для получения дополнительных сведений см раздел справки для командлета [Set-CsPersistentChatState](https://docs.microsoft.com/powershell/module/skype/set-cspersistentchatstate?view=skype-ps) .
  

