---
title: Управление высокой доступностью и восстановлением аварийности для сохраняемой сервера чата в Skype для бизнеса Server 2015 г.
ms.reviewer: ''
ms.author: v-mahoffman
author: cichur
manager: serdars
ms.date: 1/31/2018
audience: ITPro
ms.topic: article
ms.prod: skype-for-business-itpro
f1.keywords:
- NOCSH
ms.localizationpriority: medium
ms.assetid: 4346e70b-ac48-4ab9-853e-3cdd6dcfe678
description: Сводка. Узнайте, как управлять высокой доступностью и восстановлением аварийного восстановления сохраняемой сервера чата в Skype для бизнеса Server 2015 г.
ms.openlocfilehash: 3b45f38f1a530e91b75693196c5e64e206b10121
ms.sourcegitcommit: 65a10f80e5dfd67b2778e09f5f92c21ef09ce36a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/04/2021
ms.locfileid: "60774769"
---
# <a name="manage-high-availability-and-disaster-recovery-for-persistent-chat-server-in-skype-for-business-server-2015"></a>Управление высокой доступностью и восстановлением аварийности для сохраняемой сервера чата в Skype для бизнеса Server 2015 г.
 
**Сводка:** Узнайте, как управлять высокой доступностью и восстановлением аварийного Skype для бизнеса Server 2015 г.
  
В этом разделе описывается, как не сбой и сбой назад Стойкий сервер чата. Перед чтением этой темы ознакомьтесь с Планом высокой доступности и аварийного восстановления для стойких чат-серверов в [Skype для бизнеса Server 2015](../../plan-your-deployment/persistent-chat-server/high-availability-and-disaster-recovery.md) г. и настройте высокую доступность и аварийное восстановление для стойких чат-серверов в [Skype для бизнеса Server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md)г. .

> [!NOTE]
> Постоянный чат доступен в Skype для бизнеса Server 2015 г., но больше не поддерживается Skype для бизнеса Server 2019 г. Такая же функциональность доступна в Teams. Дополнительные сведения см. в ссылке Начало работы [с обновлением Microsoft Teams обновления.](/microsoftteams/upgrade-start-here) Если вам нужно использовать постоянный чат, вы можете либо перенести пользователей, требующих Teams, либо продолжить использование Skype для бизнеса Server 2015 г. 
  
## <a name="fail-over-persistent-chat-server"></a>Сбой в сервере сохраняемой беседы

Неудача для сохраняемого сервера чата предназначена в основном для ручного процесса.
  
Процедура сбой основана на предположении, что вторичный центр обработки данных запущен и запущен, но службы сохраняемого сервера чата, где расположена основная база данных сохраняемого чата, полностью недоступны, в том числе следующие:
  
- Постоянная базовая база данных Chat Server и зеркальная база данных сохраняемой системы чат-сервера не сохраняются.
    
- Skype для бизнеса Server Front End Server не сойт.
    
Вся процедура состоит из двух основных этапов:
  
- Восстановление основной базы данных сохраняемой системы чата (mgc).
    
- Реализация зеркального отображения для новой базы данных-источника.
    
Постоянная база данных соответствия чату (mgccomp) не сбой. Содержимое этой базы данных является временным и очищается по мере обработки данных адаптером соответствия. Вы, как постоянный администратор чата, несете ответственность за правильное управление выходом адаптеров, чтобы избежать потери данных.
  
Сбой в сервере сохраняемой чат-сервера:
  
1. Удалите доставку журнала из базы данных отправки резервного копирования серверов чата.
    
   - С SQL Server Management Studio подключайтесь к экземпляру базы данных, в котором расположена база данных резервного копирования chat Server.
    
   - Откройте окно отправки запроса в базу данных master.
    
   - Используйте следующую команду для сброса доставки журналов:
    
   ```SQL
   exec sp_delete_log_shipping_secondary_database mgc
   ```

2. Скопируйте все нескопированные файлы резервных копий из общей папки резервных копий в конечную папку копирования на резервном сервере.
    
3. По порядку примените все непримененные резервные копии журналов транзакций к базе данных-получателю. Подробные сведения [см. в материале How to: Apply a Transaction Log Backup (Transact-SQL).](/previous-versions/sql/sql-server-2008-r2/ms187607(v=sql.105))
    
4. Подключите резервную базу данных mgc к сети. В окне запроса, которое было открыто в действии 1b, выполните следующие действия.
    
   - Завершите все подключения к базе данных mgc при их наличии:
    
   - **exec sp_who2** для определения подключений к базе данных mgc.
    
   - **kill \<spid\>** чтобы положить конец этим подключениям.
    
   - Подключите базу данных к сети.
    
   - **восстановление mgc базы данных с восстановлением**.
    
5. В Skype для бизнеса Server командной оболочке используйте команду **Set-CsPersistentChatState -Identity "service:atl-cs-001.litwareinc.com" -PoolState FailedOver** для сбойной работы с базой данных резервного копирования mgc. Не забудьте заменить полностью квалифицированное доменное имя вашего пула постоянных чатов для atl-cs-001.litwareinc.com.
    
    Резервная база данных mgc теперь выступает в качестве базы данных-источника.
    
6. В Skype для бизнеса Server управленческой оболочки используйте команды **Install-CsMirrorDatabase** для создания зеркала высокой доступности для резервной базы данных, которая в настоящее время служит основной базой данных. Используйте экземпляр резервной базы данных в качестве базы данных источника и экземпляр резервной зеркальной базы данных в качестве экземпляра зеркала. Это не то же самое зеркало, которое изначально было настроено для базы данных-источника в процессе установки.
    
7. Установите активные серверы сервера чата. Из Skype для бизнеса Server управления используйте для набора списка активных серверов команды **Set-CsPersistentChatActiveServer.**
    
    > [!IMPORTANT]
    > Все активные серверы должны располагаться в одном центре обработки данных с новой базой данных-источником или в центре обработки данных, имеющем подключение к базе данных с низкой задержкой и высокой пропускной способностью. 
  
    На данном этапе успешно завершается сбой из основной базы данных "Постоянный сервер чата" в базу данных резервного копирования сохраняемой системы чат-сервера.
    
## <a name="fail-back-persistent-chat-server"></a>Сбой обратного сохраняемой сервера чата

В этой процедуре описаны действия, необходимые для восстановления после сбоя сервера сохраняемого чата и восстановления операций из основного центра обработки данных.
  
Во время сбоя сервера сохраняемого чата основной центр обработки данных испытывает полное отключение, а основные и зеркальные базы данных становятся недоступными. Основной центр обработки данных переключается на резервный сервер.
  
Ниже описывается процедура возобновления нормальной работы после восстановления основной базы данных и подключения серверов. Процедура предполагает, что основной центр обработки данных был восстановлен после полного простоя и что база данных mgc и база данных mgccomp были восстановлены и переустановлены с помощью Topology Builder.
  
Процедура также предполагает, что в период сбойного действия не были развернуты новые серверы зеркального и резервного копирования, и что единственным развернутым сервером является сервер резервного копирования и его зеркальный сервер, как было определено в Fail over Persistent Chat Server ранее.
  
Данные инструкции служат для восстановления исходной конфигурации, которая существовала до сбоя, приведшего к переключению с основного на резервный сервер.
  
1. Очистить все серверы из списка active Server сохраняемого чата с помощью команды **Set-CsPersistentChatActiveServer** из Skype для бизнеса Server управленческой оболочки. Это останавливает подключение всех серверов сохраняемого чата к базе данных mgc и базе данных mgccomp во время сбойных сбойов.
    
    > [!IMPORTANT]
    > Агент SQL Server на вторичном сервере сохраняемого сервера чата должен работать под привилегированной учетной записью. В частности, эта учетная запись должна иметь следующие разрешения: 
  
   - доступ на чтение к сетевой папке, в которую помещаются резервные копии;
    
   - доступ на запись к локальному каталогу, в который они копируются.
    
2. Отключите зеркальное отображение для резервной базы данных mgc.
    
   - С SQL Server Management Studio подключайтесь к экземпляру mgc резервного копирования.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Зеркальное отображение**.
    
   - Щелкните **Удалить зеркальное отображение**.
    
   - При появлении запроса на подтверждение нажмите кнопку **ОК**.
    
   - Выполните те же действия для базы данных mgccomp.
    
3. Создайте резервную копию базы данных mgc, чтобы ее можно было восстановить в новой основной базе данных.
    
   - С SQL Server Management Studio подключайтесь к экземпляру mgc резервного копирования.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи** и выберите пункт **Создать резервную копию**. Появится диалоговое окно **Резервное копирование базы данных**.
    
   - В списке **Тип резервной копии** выберите пункт **Полная**.
    
   - В списке **Компонент резервного копирования** выберите пункт **База данных**.
    
   - В поле **Имя** оставьте имя резервного набора данных по умолчанию или введите другое имя.
    
   -  *\<Optional\>*  В **описании** введите описание резервного набора.
    
   - Удалите расположение резервной копии по умолчанию из списка назначений.
    
   - Добавьте в список файл, указав путь к общей папке, которую вы выбрали для доставки журналов. Этот путь доступен как для основной, так и для резервной баз данных.
    
   - Нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и начать процесс резервного копирования.
    
4. Восстановите основную базу данных с помощью резервной копии, созданной в предыдущем шаге.
    
   - Используя SQL Server Management Studio, подключите к основному экземпляру mgc.
    
   - Щелкните правой кнопкой мыши базу данных mgc, наведите указатель на пункт **Задачи**, выберите пункт **Восстановить**, а затем **База данных**. Появится диалоговое окно **Восстановление базы данных**.
    
   - Выберите пункт **С устройства**.
    
   - Нажмите кнопку "Обзор". Откроется диалоговое окно **Указание резервной копии**. В списке **Резервные носители** выберите пункт **Файл**. Нажмите кнопку **Добавить**, выберите файл резервной копии, созданный в шаге 3, и нажмите кнопку **ОК**.
    
   - В таблице **Выберите резервные наборы данных для восстановления** выберите резервную копию.
    
   - В области **Выбор страницы** щелкните **Параметры**.
    
   - В разделе **Параметры восстановления** выберите пункт **Перезаписать существующую базу данных**.
    
   - На панели **Состояние восстановления** выберите пункт **Оставить базу данных готовой к использованию**.
    
   - Нажмите кнопку **ОК**, чтобы начать процесс восстановления.
    
5. Настройка SQL Server для основной базы данных. Выполните процедуры в Настройка высокой доступности и аварийного восстановления для persistent Chat Server в [Skype для бизнеса Server 2015](../../deploy/deploy-persistent-chat-server/configure-hadr-for-persistent-chat.md) г., чтобы установить доставку журналов для основной базы данных mgc.
    
6. Установите активные серверы сервера чата. Из Skype для бизнеса Server управления используйте для набора списка активных серверов команды **Set-CsPersistentChatActiveServer.**
    
    > [!IMPORTANT]
    > Все активные серверы должны располагаться в одном центре обработки данных с новой базой данных-источником или в центре обработки данных, имеющем подключение к базе данных с низкой задержкой и высокой пропускной способностью. 
  
Чтобы восстановить пул в нормальном состоянии, запустите следующую команду Windows PowerShell:
  
```PowerShell
Set-CsPersistentChatState -Identity "service: lyncpc.dci.discovery.com" -PoolState Normal
```

Дополнительные сведения см. в разделе Справка для [комлета Set-CsPersistentChatState.](/powershell/module/skype/set-cspersistentchatstate?view=skype-ps)
