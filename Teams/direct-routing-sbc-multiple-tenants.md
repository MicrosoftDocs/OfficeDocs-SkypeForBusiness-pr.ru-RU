---
title: Настройка пограничного контроллера сеанса — несколько клиентов
ms.reviewer: filippse
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.topic: article
ms.service: msteams
ms.localizationpriority: medium
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Узнайте, как настроить один пограничный контроллер сеансов (SBC) для обслуживания нескольких клиентов для Майкрософт партнеров и (или) операторов ТСОП.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: 570709730f7563b30b98626395f6b0a72fc1ac48
ms.sourcegitcommit: 0d97dc6616b3d633564409e39c08311af1522705
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 12/14/2022
ms.locfileid: "69392299"
---
# <a name="configure-a-session-border-controller-for-multiple-tenants"></a>Настройка множества клиентов в пограничном контроллере сеансов

Прямая маршрутизация поддерживает настройку одного пограничного контроллера сеансов (SBC) для обслуживания нескольких клиентов.

> [!NOTE]
> Этот сценарий предназначен для Майкрософт партнеров и (или) операторов ТСОП, которые далее в этом документе называются перевозчиками. Оператор продает клиентам услуги телефонии, предоставляемые Майкрософт Teams. 

Перевозчик:
- Развертывает SBC и управляет им в центре обработки данных (клиентам не нужно реализовывать SBC и они получают услуги телефонии от оператора в клиенте Teams).
- Соединяет SBC с несколькими клиентами.
- Предоставляет клиентам услуги телефонной сети общего пользования (ТСОП).
- Управляет качеством вызовов.
- Плата за службы ТСОП взимается отдельно.

Майкрософт не управляет перевозчиками. Майкрософт предлагает телефонную систему — УАТС и клиент Teams. Майкрософт также сертифицирует телефоны и SBC, которые можно использовать с телефонной системой. Перед выбором оператора убедитесь, что ваш выбор имеет сертифицированный SBC и может управлять качеством голосовой связи.

Ниже приведены шаги технической реализации для настройки сценария.

**Только оператор:**
1. Разверните SBC и настройте его для сценария размещения в соответствии [с инструкциями сертифицированных поставщиков SBC](#deploy-and-configure-the-sbc).
2. Зарегистрируйте базовое доменное имя в клиенте оператора и запросите сертификат с подстановочными знаками.
3. Зарегистрируйте поддомен для каждого клиента, который является частью базового домена.

**Оператор с глобальным администратором клиента:**
1. Добавьте имя поддомена в клиент клиента.
2. Активируйте имя поддомена.
3. Настройте магистраль от оператора до клиента клиента и подготовьте пользователей.

*Убедитесь, что вы понимаете основы DNS и управление доменным именем в Майкрософт 365. См [. статью Справка по Майкрософт 365 доменам](/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider), прежде чем продолжить.*

## <a name="deploy-and-configure-the-sbc"></a>Развертывание и настройка SBC

Подробные инструкции по развертыванию и настройке SBC для сценария размещения SBC см. в документации поставщика SBC.

- **AudioCodes:** Конфигурацию сценария размещения SBC см. в [примечаниях к конфигурации прямой маршрутизации](https://www.audiocodes.com/solutions-products/products/products-for-microsoft-365/direct-routing-for-Microsoft-Teams), как описано в разделе Подключение SBC AudioCodes к Майкрософт Примечания по настройке модели размещения прямой маршрутизации Teams. 
- **Oracle:** Конфигурацию сценария размещения SBC, как описано в разделе "Майкрософт", см. в [примечаниях к конфигурации прямой маршрутизации](https://www.oracle.com/technetwork/indexes/documentation/acme-packet-2228107.html). 
- **Связь с лентой:** Сведения о настройке [SBC Series SBC Core Майкрософт для ленты см. в руководстве по настройке Teams](https://support.sonus.net/display/ALLDOC/SBC+8.2+-+MS+Teams+Solution+Guide). См. также [рекомендации по настройке операторов для прямой маршрутизации SBC Edge для Майкрософт Teams](https://support.sonus.net/display/UXDOC81/Connect+SBC+Edge+to+Microsoft+Teams+Direct+Routing+to+Support+Direct+Routing+Carrier).
- **TE-Systems (anynode):** Зарегистрируйтесь на [сайте сообщества TE-Systems](https://community.te-systems.de/) , чтобы получить документацию и примеры по настройке SBC любого узла для нескольких клиентов.
- **Metaswitch:** Зарегистрируйтесь на [сайте Сообщества Metaswitch](https://manuals.metaswitch.com/MAN39555) для получения документации по включению Perimeta SBC для нескольких клиентов.

> [!NOTE]
> Убедитесь, что вы знаете, как настроить заголовок Contact. Заголовок Contact используется для поиска клиента клиента во входящем сообщении приглашения. 

## <a name="register-a-base-domain-and-subdomains"></a>Регистрация базового домена и поддоменов

Для сценария размещения необходимо создать:

- Одно базовое доменное имя, принадлежаемое оператору.
- Поддомен, который является частью базового доменного имени в каждом клиенте клиента.

В следующем примере:

- Adatum является оператором, который обслуживает нескольких клиентов, предоставляя услуги Интернета и телефонии.
- Woodgrove Bank, Contoso и Adventure Works — это три клиента, которые имеют Майкрософт 365 доменов, но получают услуги телефонии от Adatum.

Поддомены **должны соответствовать** полному доменному имени магистрали, которое будет настроено для клиента, и полному доменному имени в заголовке Contact при отправке приглашения в Майкрософт 365. 

Когда вызов поступает в интерфейс прямой маршрутизации Майкрософт 365, интерфейс использует заголовок Contact для поиска клиента, в котором должен находиться пользователь. Прямая маршрутизация не использует подстановку номера телефона в приглашении, так как некоторые клиенты могут иметь номера, отличные от DID, которые могут перекрываться в нескольких клиентах. Таким образом, полное доменное имя в заголовке Contact требуется для идентификации точного клиента для поиска пользователя по номеру телефона.

*Дополнительные сведения о создании доменных имен в Майкрософт 365 организациях см. в статье [Справка по Майкрософт 365 доменам](/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider).*

На следующей схеме перечислены требования к базовому домену, поддоменам и заголовку Contact.

:::image type="content" source="media/direct-routing-1-sbc-requirements.png" alt-text="Схема, показывающая требования к доменам и заголовок contact." lightbox="media/direct-routing-1-sbc-requirements.png":::

Для проверки подлинности подключений SBC требуется сертификат. В сценарии размещения SBC оператор должен запросить сертификат с .base_domain CN и (или) SAN *\*(например, \*customers.adatum.biz).* Этот сертификат можно использовать для проверки подлинности подключений к нескольким клиентам, обслуживаемого из одного SBC.

В следующей таблице приведен пример одной конфигурации.


|Новое доменное имя |Тип|Зарегистрированных  |Сертификат CN/SAN для SBC  |Домен клиента по умолчанию в примере  |Полное доменное имя, которое SBC должен содержать в заголовке Contact при отправке вызовов пользователям|
|---------|---------|---------|---------|---------|---------|
|customers.adatum.biz|    Базы     |     В клиенте оператора  |    \*.customers.adatum.biz  |   adatum.biz      |Na, это клиент службы, без пользователей |
|sbc1.customers.adatum.biz|    Поддомен  |    В клиенте клиента  |    \*.customers.adatum.biz  | woodgrovebank.us  |  sbc1.customers.adatum.biz|
|sbc2.customers.adatum.biz  |   Поддомен | В клиенте клиента   |   \*.customers.adatum.biz   |contoso.com   |sbc2.customers.adatum.biz |
|sbc3.customers.adatum.biz |   Поддомен | В клиенте клиента |   \*.customers.adatum.biz  |  adventureworks.com | sbc3.customers.adatum.biz |

Чтобы настроить базовые и поддомены, выполните описанные ниже действия. В этом примере настраивается базовое доменное имя (customers.adatum.biz) и поддомен для одного клиента (sbc1.customers.adatum.biz в клиенте Woodgrove Bank).

> [!NOTE]
> Используйте sbcX.customers.adatum.biz для включения голосовой связи в клиенте оператора; sbcX может быть любым уникальным и допустимым буквенно-цифровым именем узла.

## <a name="register-a-base-domain-name-in-the-carrier-tenant"></a>Регистрация базового доменного имени в клиенте оператора

**Эти действия выполняются в клиенте оператора.**

### <a name="ensure-that-you-have-appropriate-rights-in-the-carrier-tenant"></a>Убедитесь, что у вас есть соответствующие права в клиенте оператора

Новые домены можно добавлять только в том случае, если вы вошли в Центр администрирования Microsoft 365 в качестве глобального администратора. 

Чтобы проверить роль, войдите в Центр администрирования Microsoft 365 (https://portal.office.com), перейдите в раздел **Пользователи** > **Активные пользователи** и убедитесь, что у вас есть роль глобального администратора. 

Дополнительные сведения о ролях администратора и назначении роли в Майкрософт 365 см. в разделе [Сведения о ролях администратора](https://support.office.com/article/About-Office-365-admin-roles-da585eea-f576-4f55-a1e0-87090b6aaa9d).

### <a name="add-a-base-domain-to-the-tenant-and-verify-it"></a>Добавление базового домена в клиент и его проверка

1. В Центр администрирования Microsoft 365 перейдите к **разделу Настройка** > **доменов** > **Добавление домена**.

2. В поле **Введите домен, который вы владеете** , введите полное доменное имя базового домена. В следующем примере базовый домен *является customers.adatum.biz*.

3. Нажмите кнопку **Далее**.

4. В этом примере у клиента уже есть adatum.biz в качестве проверенного доменного имени. Мастер не будет запрашивать дополнительную проверку, так как customers.adatum.biz является поддоменом для уже зарегистрированного имени. Однако если вы добавите полное доменное имя, которое ранее не было проверено, вам потребуется пройти процесс проверки. Процесс проверки [описан ниже](#add-a-subdomain-to-the-customer-tenant-and-verify-it).

5. Нажмите **кнопку Далее**, а затем на странице **Обновление параметров DNS** выберите **Я добавлю записи DNS самостоятельно** и нажмите **кнопку Далее**.

6. На следующей странице очистите все значения (если вы не хотите использовать доменное имя для Exchange, SharePoint, Teams или Skype для бизнеса), нажмите кнопку **Далее**, а затем нажмите **кнопку Готово**. Убедитесь, что новый домен находится в состоянии завершения установки.

### <a name="activate-the-domain-name"></a>Активация доменного имени

После регистрации доменного имени необходимо активировать его, добавив по крайней мере одну лицензированную учетную запись пользователя Или ресурса Teams. Допустимые учетные записи будут лицензироваться с любым из следующих номеров SKU:

- Учетная запись пользователя с Office 365 E1/E3/E5 или Microsoft 365 E3/E5.
- Учетная запись пользователя с Office 365 A1/A3/A5 или Microsoft 365 A1/A3/A5.
- Учетная запись пользователя с Office 365 F3 или Microsoft 365 F1/F3.
- Учетная запись пользователя с Office 365 G1/G3/G5 или Microsoft 365 G3/G5.
- Учетная запись пользователя с Microsoft 365 бизнес базовый, "Стандартный" или "Премиум".
- Учетная запись пользователя с лицензией **на общие устройства Майкрософт Teams**.
- Учетная запись ресурса с **лицензией Телефонная система Microsoft Teams учетной записи ресурсов**.

Кроме того, имя участника-пользователя (имя участника-пользователя) учетной записи или Skype для бизнеса локальный SIP-адрес должны использовать то же полное доменное имя, что и только что созданный домен.

Дополнительные сведения о добавлении пользователей в Майкрософт 365 организаций см. в статье [Справка по Майкрософт 365 доменам](/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider).

Например, test@customers.adatum.biz

![Снимок экрана: страница активации базового домена.](media/direct-routing-4-sbc-domain-activation.png)

## <a name="register-a-subdomain-name-in-a-customer-tenant"></a>Регистрация имени поддомена в клиенте клиента

Необходимо создать уникальное имя поддомена для каждого клиента. В этом примере мы создадим sbc1.customers.adatum.biz поддомена в клиенте с доменным именем по умолчанию woodgrovebank.us.

**Все действия, приведенные ниже, выполняются в клиенте клиента.**

### <a name="ensure-that-you-have-appropriate-rights-in-the-customer-tenant"></a>Убедитесь, что у вас есть соответствующие права в клиенте клиента.

Новые домены можно добавлять только в том случае, если вы вошли в Центр администрирования Microsoft 365 в качестве глобального администратора. 

Чтобы проверить роль, войдите в Центр администрирования Microsoft 365 (https://portal.office.com), перейдите в раздел **Пользователи** > **Активные пользователи** и убедитесь, что у вас есть роль глобального администратора. 

Дополнительные сведения о ролях администратора и назначении роли в Майкрософт 365 см. в разделе [Сведения о ролях администратора](https://support.office.com/article/About-Office-365-admin-roles-da585eea-f576-4f55-a1e0-87090b6aaa9d).

### <a name="add-a-subdomain-to-the-customer-tenant-and-verify-it"></a>Добавление поддомена в клиент клиента и его проверка

1. В Центр администрирования Microsoft 365 перейдите к **разделу Настройка** > **доменов** > **Добавление домена**.

2. В поле **Введите домен, который вы владеете** , введите полное доменное имя поддомена для этого клиента. В приведенном ниже примере поддомен является sbc1.customers.adatum.biz.

3. Нажмите **Далее**.

4. Полное доменное имя никогда не было зарегистрировано в клиенте. На следующем шаге необходимо проверить домен. **Выберите Добавить запись TXT**. 

5. Нажмите **кнопку Далее** и запишите значение TXT, созданное для проверки доменного имени.

    ![Снимок экрана: текстовые записи на странице Проверка домена.](media/direct-routing-7-sbc-verify-domain-txt.png)

6. Создайте запись TXT со значением из предыдущего шага в поставщике услуг размещения DNS оператора.

    Дополнительные сведения см. в статье [Создание записей DNS у любого поставщика услуг размещения DNS](https://support.office.com/article/create-dns-records-at-any-dns-hosting-provider-for-office-365-7b7b075d-79f9-4e37-8a9e-fb60c1d95166).

7. Перейдите к Центр администрирования Microsoft 365 клиента и нажмите **кнопку Проверить**. 

8. На следующей странице выберите **Я добавлю записи DNS самостоятельно** и нажмите **кнопку Далее**.

9. На странице **Выберите веб-службы** снимите все параметры и нажмите кнопку **Далее**.

10. Нажмите **кнопку Готово** на странице **Обновление параметров DNS** .

11. Убедитесь, что состояние **установки завершено**.

    ![Снимок экрана: страница с состоянием завершения установки.](media/direct-routing-12-sbc-setup-complete.png)

> [!NOTE]
> Базовый URL-адрес и поддомен для отдельного клиента должны находиться в одном клиенте, чтобы можно было добавить _прямую магистраль маршрута_ .

### <a name="activate-the-subdomain-name"></a>Активация имени поддомена

После регистрации имени поддомена необходимо активировать его, добавив по крайней мере одного лицензированного пользователя Или учетной записи ресурса Teams. Допустимые учетные записи будут лицензироваться с любым из следующих номеров SKU:

-   Учетная запись пользователя с Office 365 E1/E3/E5/A3/A5 или Microsoft 365 E3/E5/A3/A5
-   Учетная запись пользователя с Office 365 F1/F3 или Microsoft 365 F1/F3
-   Учетная запись пользователя с планами Microsoft 365 бизнес базовый,Standard/Premium и G3/G5
-   Учетная запись пользователя с лицензией **Майкрософт Teams на общие устройства**
-   Учетная запись ресурса с лицензией **учетной записи Телефонная система Microsoft Teams ресурсов**

Кроме того, имя участника-пользователя (имя участника-пользователя) учетной записи или Skype для бизнеса локальный SIP-адрес должны использовать то же полное доменное имя, что и только что созданный поддомен.

Дополнительные сведения о добавлении пользователей в Майкрософт 365 организаций см. в статье [Справка по Майкрософт 365](/microsoft-365/admin/get-help-with-domains/create-dns-records-at-any-dns-hosting-provider).

Например: test@sbc1.customers.adatum.biz

![Снимок экрана: страница Активация поддомена.](media/direct-routing-13-sbc-activate-subdomain.png)

### <a name="create-a-trunk-and-provision-users"></a>Создание магистрали и подготовка пользователей

В первоначальном выпуске прямой маршрутизации Майкрософт требовалось добавить магистраль в каждый обслуживаемый клиент (клиент клиента) с помощью командлета New-CSOnlinePSTNGateway.

Однако этот метод не оказался оптимальным по двум причинам:
 
- **Управление накладными расходами**. Например, разгрузка или очистка SBC изменяет некоторые параметры, такие как включение или отключение обхода мультимедиа. Для изменения порта необходимо изменить параметры в нескольких клиентах (запустив Set-CSOnlinePSTNGateway), но на самом деле это тот же SBC. 

-  **Накладные расходы на обработку**. Сбор и мониторинг данных о работоспособности магистрали. Параметры SIP, собранные из нескольких логических магистралей, которые в действительности являются одинаковыми SBC и одной физической магистралью, замедляют обработку данных маршрутизации.
 
На основе этих отзывов Майкрософт использует новую логику подготовки магистралей для клиентов.

Были представлены две новые сущности:

- Магистраль несущего оператора, зарегистрированная в клиенте оператора с помощью команды New-CSOnlinePSTNGateway. Например: 
   
   ```PowerShell
   New-CSOnlinePSTNGateway -FQDN customers.adatum.biz -SIPSignalingport 5068 -ForwardPAI $true
    ```

- Производная магистраль, не требующая регистрации. Это просто нужное имя узла, добавленное из магистрали несущей связи. Все параметры конфигурации являются производными от несущей магистрали. Связь с магистралью носителя основана на полном доменном имени (см. подробные сведения ниже).

**Логика подготовки и пример**

- Операторам необходимо настроить и управлять только одной магистралью (магистралью в домене оператора) с помощью команды Set-CSOnlinePSTNGateway. В приведенном выше примере это adatum.biz.

- В клиенте клиента оператор должен добавить в маршруты голосовой связи производное полное доменное имя магистрали. Нет необходимости запускать New-CSOnlinePSTNGateway для магистрали.

- Производный магистраль, как следует из названия, наследует или наследует все параметры конфигурации от несущей магистрали. 

Примеры:
- Customers.adatum.biz — магистраль несущей платформы, которую необходимо создать в клиенте оператора.

- Sbc1.customers.adatum.biz — производная магистраль в клиенте клиента. Вы можете добавить имя производной магистрали в клиент клиента в голосовые маршруты, не создавая его.

- Оператору потребуется настроить запись DNS, разрешающую производное полное доменное имя магистрали для IP-адреса оператора SBC.

- Любые изменения, внесенные в магистраль перевозчика (в клиенте перевозчика), автоматически применяются к производным магистрали. Например, операторы могут изменить sip-порт на магистрали, и это изменение применяется ко всем производным магистрали. Новая логика настройки магистралей упрощает управление, так как вам не нужно переходить к каждому клиенту и изменять параметр на каждой магистрали.

- Параметры отправляются только в полное доменное имя магистрали оператора. Состояние работоспособности магистрали перевозчика применяется ко всем производным магистрали и используется для принятия решений о маршрутизации. Узнайте больше о [параметрах прямой маршрутизации](./direct-routing-monitor-and-troubleshoot.md).

- Носитель может осушить ствол носителя, и все производные стволы также будут осушены. 
 
> [!NOTE]
> Правила преобразования чисел, применяемые к несущей магистрали, не применяются к производным магистрали. Это известная проблема. В качестве альтернативного решения необходимо создать правила преобразования чисел для каждого клиента.

**Миграция с предыдущей модели на магистраль перевозчика**
 
Для миграции с текущей реализации модели, размещенной на операторе, на новую модель, операторам потребуется перенастроить магистрали для клиентов-клиентов. Удаление магистралей из клиентов клиента с помощью Remove-CSOnlinePSTNGateway (оставляя магистраль в клиенте перевозчика)-

Мы настоятельно рекомендуем как можно скорее переходить на новое решение, так как мы будем улучшать мониторинг и подготовку с помощью модели перевозчика и производной магистрали.
 
Дополнительные сведения о настройке отправки полного доменного имени поддоменов в заголовке Contact см. в [инструкциях поставщика SBC](#deploy-and-configure-the-sbc).

## <a name="considerations-for-setting-up-multi-tenant-failover"></a>Рекомендации по настройке мультитенантной отработки отказа 

Чтобы настроить отработку отказа для мультитенантной среды, необходимо выполнить следующие действия.

- Для каждого клиента добавьте полные доменные имена для двух разных SBC. Например:

   customer1.sbc1.contoso.com <br>
   customer1.sbc2.contoso.com <br>

- В разделе Сетевые голосовые маршруты укажите оба SBC. Если один SBC завершается сбоем, политика маршрутизации перенаправит вызовы ко второму SBC.


## <a name="see-also"></a>См. также

[Планирование прямой маршрутизации](direct-routing-plan.md)

[Настройка прямой маршрутизации](direct-routing-configure.md)
