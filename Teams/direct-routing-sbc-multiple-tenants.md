---
title: Настройка пограничного контроллера сеанса — несколько клиентов
ms.reviewer: filippse
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.topic: article
ms.service: msteams
ms.localizationpriority: medium
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Узнайте, как настроить один пограничный контроллер сеансов (SBC) для обслуживания нескольких клиентов для партнеров Майкрософт и (или) операторов ТСОП.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: 7a465945a55482c84b9d6373240bc89850b80e3a
ms.sourcegitcommit: 3f046142c40b3b776165e964f2b8718e2fe55df3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/24/2022
ms.locfileid: "65661680"
---
# <a name="configure-a-session-border-controller-for-multiple-tenants"></a>Настройка множества клиентов в пограничном контроллере сеансов

Прямая маршрутизация поддерживает настройку одного пограничного контроллера сеанса (SBC) для обслуживания нескольких клиентов.

> [!NOTE]
> Этот сценарий предназначен для партнеров Майкрософт и (или) операторов ТСОП, которые далее в этом документе называются операторами. Оператор продает услуги телефонии, доставленные Microsoft Teams клиентам. 

Оператор:
- Развертывает SBC и управляет им в своем центре обработки данных (клиентам не нужно реализовывать SBC и они получают телефонные службы от оператора в Teams клиенте).
- Подключает SBC к нескольким клиентам.
- Предоставляет клиентам службы телефонной сети общего пользования (ТСОП).
- Управляет качеством звонков.
- Плата за службы ТСОП взимается отдельно.

Корпорация Майкрософт не управляет операторами. Корпорация Майкрософт телефонная система — Exchange частной ветви (УАТС) — и Teams клиента. Корпорация Майкрософт также сертифицируйте телефоны и сертификаты SBC, которые можно использовать с телефонная система. Перед выбором оператора убедитесь, что ваш выбор имеет сертифицированный SBC и может управлять качеством голосовой связи.

Ниже приведены шаги по технической реализации для настройки сценария.

**Только для оператора:**
1. Разверните SBC и настройте его для сценария размещения в соответствии с инструкциями сертифицированных [поставщиков SBC](#deploy-and-configure-the-sbc).
2. Зарегистрируйте базовое доменное имя в клиенте оператора и запросите сертификат с подстановочными знаками.
3. Зарегистрируйте поддомен для каждого клиента, который является частью базового домена.

**Оператор с глобальным администратором клиента:**
1. Добавьте имя поддомена в клиент клиента.
2. Активируйте имя поддомена.
3. Настройте магистраль от оператора до клиента клиента и подготовите пользователей.

*Убедитесь, что вы понимаете основы DNS и управление доменным именем в Microsoft 365. Прежде чем продолжить, ознакомьтесь с [справкой по Microsoft 365 доменов](https://support.office.com/article/Get-help-with-Office-365-domains-28343f3a-dcee-41b6-9b97-5b0f4999b7ef).*

## <a name="deploy-and-configure-the-sbc"></a>Развертывание и настройка SBC

Подробные инструкции по развертыванию и настройке SBC для сценария размещения SBC см. в документации поставщика SBC.

- **AudioCodes:** Сведения [о настройке](https://www.audiocodes.com/solutions-products/products/products-for-microsoft-365/direct-routing-for-Microsoft-Teams) сценария размещения SBC см. в примечаниях к конфигурации прямой маршрутизации, как описано в разделе "Подключение SBC AudioCodes к Microsoft Teams конфигурации модели размещения прямой маршрутизации". 
- **Oracle:** Сведения [о настройке](https://www.oracle.com/technetwork/indexes/documentation/acme-packet-2228107.html) сценария размещения SBC см. в примечаниях к конфигурации прямой маршрутизации, как описано в разделе "Майкрософт". 
- **Связь с лентой:** Документацию по настройке [SBC Core Microsoft Teams SBC Core](https://support.sonus.net/display/IOT/PBXs+-+SBC+5k7kSWe) для ленты см. в документации по настройке SBC основных рядов ленты. См. также рекомендации по настройке операторов связи [для Microsoft Teams прямой маршрутизации SBC Edge](https://support.sonus.net/display/UXDOC81/Connect+SBC+Edge+to+Microsoft+Teams+Direct+Routing+to+Support+Direct+Routing+Carrier)
- **TE-Systems (anynode):** Зарегистрируйтесь на [сайте Community TE-Systems](https://community.te-systems.de/), чтобы получить документацию и примеры настройки anynode SBC для нескольких клиентов.
- **Metaswitch:** Зарегистрируйтесь [на сайте Community Metaswitch](https://manuals.metaswitch.com/MAN39555), чтобы получить документацию по включению Perimeta SBC для нескольких клиентов.

> [!NOTE]
> Убедитесь, что вы знаете, как настроить заголовок Contact. Заголовок Contact используется для поиска клиента клиента во входящем приглашении. 

## <a name="register-a-base-domain-and-subdomains"></a>Регистрация базового домена и поддоменов

Для сценария размещения необходимо создать:

- Одно базовое доменное имя, которое принадлежит оператору.
- Поддомен, который является частью базового доменного имени в каждом клиенте клиента.

В следующем примере:

- Adatum — это оператор, который обслуживает нескольких клиентов за счет предоставления услуг Интернета и телефонии.
- Woodgrove Bank, Contoso и Adventure Works — это три клиента, которые Microsoft 365 домены, но получают службы телефонии от Adatum.

Поддомены должны  соответствовать FQDN магистрали, которая будет настроена для клиента, и полное доменное имя в заголовке Contact при отправке приглашения Microsoft 365. 

Когда в интерфейс прямой маршрутизации Microsoft 365 поступает вызов, интерфейс использует заголовок Contact, чтобы найти клиент, в котором нужно найти пользователя. Прямая маршрутизация не использует поиск номеров телефонов в приглашении, так как у некоторых клиентов могут быть номера, отличные от DID, которые могут перекрываться в нескольких клиентах. Таким образом, полное доменное имя в заголовке контакта требуется для идентификации точного клиента для поиска пользователя по номеру телефона.

*Дополнительные сведения о создании доменных имен в организациях Microsoft 365 см. в справке по [Microsoft 365 доменам](https://support.office.com/article/Get-help-with-Office-365-domains-28343f3a-dcee-41b6-9b97-5b0f4999b7ef).*

На следующей схеме перечислены требования к базовому домену, поддоменам и заголовку contact.

:::image type="content" source="media/direct-routing-1-sbc-requirements.png" alt-text="Схема, показывающая требования к доменам и заголовку контакта." lightbox="media/direct-routing-1-sbc-requirements.png":::

Для проверки подлинности подключений SBC требуется сертификат. Для сценария размещения SBC оператору необходимо запросить сертификат с cn и /или SAN *.base_domain\* (например, \*.customers.adatum.biz)*. Этот сертификат можно использовать для проверки подлинности подключений к нескольким клиентам, обслуживаемых из одного SBC.

В следующей таблице приведен пример одной конфигурации.


|Новое доменное имя |Тип|Зарегистрированных  |Сертификат CN/SAN для SBC  |Домен клиента по умолчанию в примере  |Полное доменное имя, которое SBC должен присутствовать в заголовке Contact при отправке звонков пользователям|
|---------|---------|---------|---------|---------|---------|
|customers.adatum.biz|    Базы     |     В клиенте оператора  |    \*.customers.adatum.biz  |   adatum.biz      |Na, это клиент службы, без пользователей |
|sbc1.customers.adatum.biz|    Поддомен  |    В клиенте клиента  |    \*.customers.adatum.biz  | woodgrovebank.us  |  sbc1.customers.adatum.biz|
|sbc2.customers.adatum.biz  |   Поддомен | В клиенте клиента   |   \*.customers.adatum.biz   |contoso.com   |sbc2.customers.adatum.biz |
|sbc3.customers.adatum.biz |   Поддомен | В клиенте клиента |   \*.customers.adatum.biz  |  adventureworks.com | sbc3.customers.adatum.biz |

Чтобы настроить базовые и поддомены, выполните описанные ниже действия. В этом примере настраивается базовое доменное имя (customers.adatum.biz) и поддомен для одного клиента (sbc1.customers.adatum.biz клиента Woodgrove Bank).

> [!NOTE]
> Используйте sbcX.customers.adatum.biz для включения голосовой связи в клиенте оператора; sbcX может быть любым уникальным и допустимым буквенно-цифровым именем узла.

## <a name="register-a-base-domain-name-in-the-carrier-tenant"></a>Регистрация базового доменного имени в клиенте оператора

**Эти действия выполняются в клиенте оператора.**

### <a name="ensure-that-you-have-appropriate-rights-in-the-carrier-tenant"></a>Убедитесь, что у вас есть соответствующие права в арендаторе оператора.

Добавлять новые домены можно только в том случае, если вы вошли в Центр администрирования Microsoft 365 в качестве глобального администратора. 

Чтобы проверить роль, войдите в Центр администрирования Microsoft 365 (https://portal.office.com)перейдите  >  в раздел "Активные пользователи **", а** затем убедитесь, что у вас есть роль глобального администратора. 

Дополнительные сведения о ролях администраторов и назначении роли в Microsoft 365 см. в разделе "О [ролях администратора"](https://support.office.com/article/About-Office-365-admin-roles-da585eea-f576-4f55-a1e0-87090b6aaa9d).

### <a name="add-a-base-domain-to-the-tenant-and-verify-it"></a>Добавление базового домена в клиент и его проверка

1. В Центр администрирования Microsoft 365 перейдите к **разделу "Домены** > **установки** > **" "Добавить домен"**.

2. В поле **"Введите собственный** домен" введите полное доменное имя базового домена. В следующем примере базовым *доменом является* customers.adatum.biz.

3. Нажмите кнопку **Далее**.

4. В этом примере клиент уже adatum.biz как проверенное доменное имя. Мастер не будет запрашивать дополнительную проверку, customers.adatum.biz является поддоменом для уже зарегистрированного имени. Однако при добавлении полного доменного имени, которое ранее не было проверено, необходимо пройти проверку. Процесс проверки [описан ниже](#add-a-subdomain-to-the-customer-tenant-and-verify-it).

5. Нажмите **кнопку "** Далее", а затем на странице обновления **DNS Параметры** выберите "Я добавю записи **DNS самостоятельно**" и нажмите кнопку **"Далее"**.

6. На следующей странице очистите все значения (если вы не хотите использовать доменное имя для Exchange, SharePoint, Teams или Skype для бизнеса), нажмите кнопку "Далее" и нажмите кнопку "Готово **".** Убедитесь, что новый домен находится в состоянии "Настройка завершена".

### <a name="activate-the-domain-name"></a>Активация доменного имени

После регистрации доменного имени необходимо активировать его, добавив по крайней мере одного пользователя с лицензией телефонная система и назначив SIP-адрес с частью полного доменного имени SIP-адреса, соответствующей созданному базовому домену.

> [!NOTE]
> Клиент оператора должен сохранить по крайней мере одну телефонная система лицензию, назначенную клиенту, чтобы избежать удаления Skype для бизнеса конфигурации. 

*Дополнительные сведения о добавлении пользователей Microsoft 365 организаций см. в справке [по Microsoft 365 доменам](https://support.office.com/article/Get-help-with-Office-365-domains-28343f3a-dcee-41b6-9b97-5b0f4999b7ef).*

Например, test@customers.adatum.biz

![Снимок экрана: страница активации базового домена.](media/direct-routing-4-sbc-domain-activation.png)

## <a name="register-a-subdomain-name-in-a-customer-tenant"></a>Регистрация имени поддомена в клиенте клиента

Вам потребуется создать уникальное имя поддомена для каждого клиента. В этом примере мы создадим поддомен sbc1.customers.adatum.biz в клиенте с доменным именем по умолчанию woodgrovebank.us.

**Все приведенные ниже действия находятся в клиенте клиента.**

### <a name="ensure-that-you-have-appropriate-rights-in-the-customer-tenant"></a>Убедитесь, что у вас есть соответствующие права в клиенте клиента.

Добавлять новые домены можно только в том случае, если вы вошли в Центр администрирования Microsoft 365 в качестве глобального администратора. 

Чтобы проверить роль, войдите в Центр администрирования Microsoft 365 (https://portal.office.com)перейдите  >  в раздел "Активные пользователи **", а** затем убедитесь, что у вас есть роль глобального администратора. 

Дополнительные сведения о ролях администраторов и назначении роли в Microsoft 365 см. в разделе "О [ролях администратора"](https://support.office.com/article/About-Office-365-admin-roles-da585eea-f576-4f55-a1e0-87090b6aaa9d).

### <a name="add-a-subdomain-to-the-customer-tenant-and-verify-it"></a>Добавление поддомена в клиент клиента и его проверка

1. В Центр администрирования Microsoft 365 перейдите к **разделу "Домены** > **установки** > **" "Добавить домен"**.

2. В поле **"Введите** домен" введите полное доменное имя поддомена для этого клиента. В приведенном ниже примере поддомен sbc1.customers.adatum.biz.

3. Нажмите **Далее**.

4. Полное доменное имя никогда не было зарегистрировано в клиенте. На следующем шаге необходимо проверить домен. Выберите **"Добавить запись TXT"**. 

5. Нажмите **кнопку "** Далее" и запишите значение TXT, созданное для проверки доменного имени.

    ![Снимок экрана: текстовые записи на странице "Проверка домена".](media/direct-routing-7-sbc-verify-domain-txt.png)

6. Создайте запись TXT со значением из предыдущего шага в поставщике услуг размещения DNS оператора.

    Дополнительные сведения см. в [статье "Создание записей DNS на любом поставщике услуг размещения DNS"](https://support.office.com/article/create-dns-records-at-any-dns-hosting-provider-for-office-365-7b7b075d-79f9-4e37-8a9e-fb60c1d95166).

7. Перейдите на страницу клиента Центр администрирования Microsoft 365 нажмите кнопку "**Проверить"**. 

8. На следующей странице выберите **"Я добавю записи DNS самостоятельно"** и нажмите кнопку " **Далее"**.

9. На странице **"Веб-службы**" снимите все параметры и нажмите кнопку "**Далее"**.

10. Нажмите **кнопку "Готово** " **на странице "Обновление параметров DNS** ".

11. Убедитесь, что состояние **установки завершено**. 
    
    ![Снимок экрана: страница с состоянием завершения установки.](media/direct-routing-12-sbc-setup-complete.png)
    
> [!NOTE]
> Базовый URL-адрес и поддомен отдельного клиента должны быть в одном клиенте, чтобы можно было добавить _магистраль прямого маршрута_ .

### <a name="activate-the-subdomain-name"></a>Активация имени поддомена

После регистрации доменного имени необходимо активировать его, добавив по крайней мере одного пользователя и назначив SIP-адрес с частью полного доменного имени SIP-адреса, соответствующей созданному поддомену в клиенте клиента. 

*Дополнительные сведения о добавлении пользователей в Microsoft 365 организаций см. в [разделе "Справка по Microsoft 365](https://support.office.com/article/Get-help-with-Office-365-domains-28343f3a-dcee-41b6-9b97-5b0f4999b7ef)".*

Например, test@sbc1.customers.adatum.biz

![Снимок экрана: страница активации поддомена.](media/direct-routing-13-sbc-activate-subdomain.png)

### <a name="create-a-trunk-and-provision-users"></a>Создание магистрали и подготовка пользователей

В первоначальном выпуске прямой маршрутизации корпорация Майкрософт должна была добавить магистральную магистраль для каждого обслуживаемого клиента (клиента) с помощью New-CSOnlinePSTNGateway командлета.

Однако этот метод не был оптимальным по двум причинам:
 
- **Управление накладными затратами**. Разгрузка или очистка SBC, например, изменяет некоторые параметры, например включение или отключение обхода сервера-посредника. Изменение порта требует изменения параметров в нескольких клиентах (с помощью командной строки Set-CSOnlinePSTNGateway), но на самом деле это тот же SBC. 

-  **Накладная обработка**. Сбор и мониторинг данных о работоспособности магистрали — параметры SIP, собранные из нескольких логических магистралей, которые на самом деле являются одинаковыми SBC и одной физической магистралью, замедляют обработку данных маршрутизации.
 
На основе этого отзыва корпорация Майкрософт предоставляет новую логику для подготовки магистралей для клиентов клиента.

Появились две новые сущности:

- Магистраль оператора, зарегистрированная в клиенте оператора с помощью команды New-CSOnlinePSTNGateway. Например: 
   
   ```PowerShell
   New-CSOnlinePSTNGateway -FQDN customers.adatum.biz -SIPSignalingport 5068 -ForwardPAI $true
    ```

- Производная магистраль, которая не требует регистрации. Это просто нужное имя узла, добавленное из магистрали оператора. Он наследует все параметры конфигурации от магистрали оператора. Производную магистраль не нужно создавать в PowerShell, а связь с магистралью оператора основана на имени полного доменного имени (см. сведения ниже).

**Логика подготовки и пример**

- Операторы должны настроить и управлять только одной магистралью (магистраль оператора в домене оператора) с помощью команды Set-CSOnlinePSTNGateway. В приведенном выше примере он adatum.biz.

- В клиенте клиента оператору связи необходимо добавить полное доменное имя магистрали в голосовые маршруты. Нет необходимости запускать New-CSOnlinePSTNGateway магистрали.

- Производная магистраль, как предполагается в имени, наследует или наследует все параметры конфигурации от магистрали оператора. 

Примеры:
- Customers.adatum.biz — магистраль оператора, которую необходимо создать в арендаторе оператора.

- Sbc1.customers.adatum.biz — производная магистраль в клиенте клиента, которую не нужно создавать в PowerShell. Вы можете добавить имя производной магистрали в клиенте клиента в политику маршрутизации голосовой связи в сети без его создания (используйте полное доменное имя магистрали при настройке политики маршрутизации голосовой связи в TAC в разделе Teams-Voice-Direct Routing-Voice Routes field SBCs enrolled).

- Оператору необходимо настроить запись DNS, разрешая полное доменное имя магистрали для IP-адреса SBC оператора.

- Любые изменения, внесенные в магистрали оператора (в арендаторе оператора), автоматически применяются к производным магистралям. Например, операторы могут изменить порт SIP на магистрали оператора, и это изменение применяется ко всем производным магистралям. Новая логика настройки магистралей упрощает управление, так как вам не нужно переходить к каждому клиенту и изменять параметр на каждом магистрали.

- Параметры отправляются только в полное доменное имя магистрали оператора. Состояние работоспособности магистрали оператора применяется ко всем производным магистралям и используется для принятия решений о маршрутизации. Дополнительные сведения о [вариантах прямой маршрутизации](./direct-routing-monitor-and-troubleshoot.md).

- Оператор может очистить магистраль оператора, и все производные магистрали также будут удалены. 
 
> [!NOTE]
> Правила преобразования номеров, применяемые к магистрали оператора, не применяются к производным магистралям. Это известная проблема. В качестве альтернативного решения необходимо создать правила преобразования номеров для каждого клиента.

**Миграция с предыдущей модели на магистраль оператора**
 
Для миграции с текущей реализации размещенной у оператора модели на новую модель операторам потребуется перенастроить магистрали для клиентов клиентов. Удаление магистралей из клиентов клиента с помощью Remove-CSOnlinePSTNGateway (выход из магистрали в арендаторе оператора) —

Мы настоятельно рекомендуем как можно скорее перейти на новое решение, так как мы будем усовершенствовать мониторинг и подготовку с помощью оператора и модели магистральной линии связи.
 
Дополнительные сведения о настройке отправки полного доменного имени поддоменов в заголовке contact см. в инструкциях поставщика [SBC](#deploy-and-configure-the-sbc).

## <a name="considerations-for-setting-up-multi-tenant-failover"></a>Рекомендации по настройке многопользовательской отработки отказа 

Чтобы настроить отработку отказа для мультитенантной среды, необходимо выполнить следующие действия:

- Для каждого клиента добавьте полные доменные имена для двух разных контроллеров SBC. Например:

   customer1.sbc1.contoso.com <br>
   customer1.sbc2.contoso.com <br>

- В сетевых голосовых маршрутах укажите оба контроллера SBC. Если один SBC завершается сбоем, политика маршрутизации направляет вызовы на второй SBC.


## <a name="see-also"></a>См. также

[Планирование прямой маршрутизации](direct-routing-plan.md)

[Настройка прямой маршрутизации](direct-routing-configure.md)
