---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутизации
appliesto:
- Microsoft Teams
ms.openlocfilehash: 43673c2b6a1928ab2ca21579339324f01d5ada9e
ms.sourcegitcommit: 1a08ec9069332e19135312d35fc6a6c3247ce2d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2020
ms.locfileid: "41888578"
---
# <a name="overview"></a>Обзор

В этой статье рассказывается о том, как прямая маршрутизация поддерживает обход мультимедиа с помощью одноименного контроллера границ (SBC), включенного для функции ICE Lite, как описано в [RFC 5245](https://tools.ietf.org/html/rfc5245). Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку соединения между локальным SBC и прокси-службой SIP.

В этой статье приводятся общие сведения о сценариях ICE Lite и требованиях для взаимодействия. В этой статье описаны форматы сообщений и требования к переходам конечного автомата для обеспечения надежного потока звонков и мультимедиа.

## <a name="terminology"></a>Терминологии

- Первый Привет — первые слова, произносимые вызывающим абонентом и вызываемым. Важно, чтобы первые пакеты из конечных точек гарантированно доставлялись для большинства вариантов использования.

- Разветвление — предложение из вызывающего абонента может доставляться в несколько конечных точек вызывающего абонента, если вызываемый объект доступен на нескольких устройствах (например, пользователь Teams может войти в Teams для Windows и Teams для Android или iPhone).

- Ответ на предварительную подсылку (183) — конечные точки вызываемого абонента для более быстрой настройки звонков. отправьте ответ с кандидатами и ключами, необходимыми для создания мультимедийного потока. Это делается в том случае, если пользователь может ответить на вызов (200OK) из определенного экземпляра вызываемого метода. С помощью разветвления вызывающий абонент должен подготовиться к приему нескольких решений для подготовки.

- Повторно пригласить — предложение с конечными кандидатами, выбранными конечной точкой управления ICE. У него есть атрибут a = Remote-кандидатов для разрешения каких-либо условий состязания для обработки нескольких разветвлений.

- Конечная точка Teams — это может быть сервер (процессор мультимедиа, транспорт ретрансляции) или клиент Teams.

## <a name="message-format"></a>Формат сообщения

Инфраструктура Teams соответствует спецификации RFC 5245 для ICE – Lite. Это означает, что все сообщения STUN будут соответствовать стандартам [RFC 5389](https://tools.ietf.org/html/rfc5389).

SBCs в соответствии со стандартом RFC 5389 должны игнорировать любые атрибуты STUN, которые они не распознают, и продолжать обработку сообщений с помощью известных атрибутов. 

Если все неверно сформированные пакеты будут получены, пакеты должны быть удалены без воздействия на сеанс мультимедиа.

## <a name="ice-lite-requirements"></a>Требования для упрощенной Lite

Этот раздел служит для краткого захвата требований для ICE Lite.

### <a name="candidate-gathering"></a>Сбор кандидатов

SBC должен предоставлять только один кандидат, который доступен для общего доступа. В настоящее время поддерживаются только кандидаты IPV4.


#### <a name="connectivity-checks"></a>Проверки подключения

Реализация ICE Lite должна отвечать на любые полученные проверки подключения. Конечная точка ICE Lite не должна отправлять запросы на проверку подключения. (Если проверки подключения отправляются в нарушениех, вся реализация будет отвечать на запросы, что может привести к неожиданным результатам, производным от одноранговых элементов, которые могут привести к ошибкам вызова.)

#### <a name="nominations"></a>номинатионс

Конечная точка внутренней реализации ICE всегда будет управляющей конечной точкой и будет соответствовать стандарту "Regular" номинатионс для выбора конечных кандидатов, используемых для потока мультимедиа. Конечная точка ICE Lite может использовать номинатионс, чтобы завершить путь, который будет использоваться для мультимедиа и полных звонков.

Примечание. в случае разветвления с конечными точками одноранговой сети, отправляющей ответы 183, этот SBC должен быть готов к ответу на проверки из нескольких конечных точек, а также номинатионс из нескольких конечных точек, если номинатионс происходит перед 200OK. В зависимости от конвергенции конечного автомата ICE на конечном пути и времени ответа пользователя номинатионс может происходить до или после 200OK. Этот SBC должен поддерживать оба случая.

#### <a name="converging-for-forking"></a>Схождение для разветвления

Если предложение из SBC разделяется на несколько конечных точек Teams, конечные точки Teams могут отвечать на запросы предварительной обработки и запускать проверки подключения. SBC должен быть подготовлен для получения проверки подключения и ответа на проверки подключения из нескольких одноранговых конечных точек. Например, пользователь Teams может войти на Настольный компьютер и сотовый телефон. Оба устройства будут уведомлены о входящем звонке и будут пытаться проверить связь с помощью SBC.

В конечном итоге только одна из конечных точек ответит на звонок (200OK). Получив 200OK, SBC может настроить правый контекст для обработки пакетов мультимедиа.

## <a name="scenarios"></a>Scenarios

###  <a name="inbound-call-from-sbc"></a>Входящий звонок из SBC

Для этого сценария существует несколько возможных конечных точек одноранговых элементов, которые должен обрабатывать SBC.

- Конечные точки сервера обычно реагируют непосредственно с помощью 200OK. Это полные конечные точки, которые обычно участвуют в голосовой почте, очереди звонков и сценариях автосекретаря.

- Конечные точки клиента могут отправлять несколько предварительных ответов с разными тегами from/to (183), за которыми следует 200OK из конечной точки, которая отвечает за вызов. Это полные конечные точки, обычно представляющие клиентов конечных пользователей.

- Другие конечные точки SBC. Эти конечные точки ICE Lite обычно участвуют в сценарии одновременного звонка конечным точкам клиента и другим телефонным номерам.

Этот SBC должен отвечать на все допустимые запросы проверки подключения, полученные от полных конечных точек ICE. В соответствии с RFC полные конечные точки ICE станут управляющими конечными точками. Конечные точки Teams (клиент/сервер) выполняют "регулярные" номинатионс для завершения проверок подключения. Конечный 200Ok может быть из конечной точки, которая отправила раннее мультимедиа или из другой конечной точки. Когда вы получаете 200Ok, SBC должен настроить правый контекст для потока мультимедиа. 

###  <a name="early-media"></a>Ранний мультимедиа

Если вы выполняете более раннюю схему мультимедиа, этот SBC должен быть заблокирован до первой конечной точки, которая запускает потоковую передачу мультимедиа; поток мультимедиа может начинаться, прежде чем присвоены варианты. Для включения сценариев интерактивный автоответчик/голосовой почты SBC должен поддерживать пересылку DTMF на этом этапе. SBC должен использовать путь с наивысшим приоритетом, по которому получается проверка, если номинатионс не завершился.

### <a name="outbound-call-to-sbc"></a>Исходящий звонок на SBC

Конечные точки Teams — это вызывающий объект для этого сценария и будет управляющей конечной точкой. При получении ответа на предварительный запрос (183) или последнего ответа (200OK) конечная точка Teams начнет проверку подключения и затем перейти к регулярному номинатионсу для завершения проверки подключения.

Примечание. Если SBC отправляет предустановленный ответ (183), он должен быть готов к получению запросов проверки подключения и, возможно, завершить номинатионс, прежде чем 200OK отправляется с помощью SBC. Если проверки и (или) номинатионс выполняются перед получением 200OK, проверки и/или номинатионс не будут выполняться повторно после получения 200OK. SBC не должен изменять кандидатов на ICE, пароль и уфраг (фрагмент имени пользователя) между 183 и 200.

Чтобы обеспечить поддержку раннего мультимедиа, SBC может начать потоковую передачу мультимедиа на одноранговый кандидат, используя наивысший приоритет в соответствии с полученными проверками подключения, даже перед тем, как номинатионс завершается конечной точкой Teams. Этот SBC должен ожидать передачи мультимедиа от Teams на любой кандидат, пока номинатионс не завершится. После того как кандидат приступит, для отправки и получения пакетов мультимедиа необходимо сбросить SBC в правый контекст.

## <a name="srtp-support-requirements"></a>Требования поддержки SRTP

SBC должен поддерживать шифр SRTP Encryption AES_CM_128_HMAC_SHA1_80 для предложения и ответа в следующем формате:

```console
"inline:" <key||salt> ["|" lifetime]
```

Ниже приведен пример атрибута шифрования в предложении SDP из SBC:

```console
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:V/Lr6Lsvhad/crSB9kCQ28jrYDxR2Yfk5bXryH5V|2^31
```

Параметры МКИ и Length не являются обязательными.

Дополнительные сведения можно найти в [статье RFC 4568, раздел 6,1](https://tools.ietf.org/html/rfc4568#section-6.1).

## <a name="sdes-support-requirements"></a>Требования поддержки СДЕС

Устройство должно поддерживать СДЕС в формате, как описано ниже. Процессоры Microsoft Media всегда предпочитают СДЕС.

- Если не использовать мультимедиа, даже если клиент поддерживает ДТЛС, то процессоры мультимедиа будут преобразовываться в СДЕС.

- Если у клиента есть только ДТЛС (будущее рабочее состояние Google), прямая маршрутизация вставит в путь точку управления, преобразуя вызов из режима мультимедиа в режим обхода без мультимедиа. Между однокомпонентным процессором SBC и Media, СДЕС всегда используется.

В настоящее время нет клиента Teams, предлагающего только ДТЛС; Несмотря на то что компания Google объявила о том, что в какой – либо момент она прекратит поддерживать СДЕС.

## <a name="format-for-offer-from-sbc-in-bypass-mode"></a>Формат предложения из SBC в режиме обхода 

Предложение должно содержать СДЕС и может содержать ДТЛС необязательно в следующем формате:

```console
m=audio 54056 UDP/TLS/RTP/SAVP 0 8 76 77 18 9 101 13
a=rtcp:54056
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:krXco0QRglwErMqtbMs2zSw29tBdmdgXpEYZhQmp|2^31
a=fingerprint:sha-256 AE:24:07:15:5C:B7:45:1A:E4:45:60:C1:1E:68:0E:CC:8D:A6:78:3B:76:65:BB:B0:77:88:07:F8:98:18:62:34
a=setup:actpass
a=rtcp-mux
```

### <a name="format-for-answer-containing-sdes-to-sbc"></a>Формат ответа, содержащего СДЕС, в SBC

```console
m=audio 54056 RTP/SAVP 111 103 104 9 0 8 description 106 13 110 112 113 126
a=rtcp:54056
a=crypto:2 AES_CM_128_HMAC_SHA1_80 inline:fBc61ikv1kMy0sF85DblNqTzVAbFa7hJQ9GKb6Yj|2^31|1:1
a=crypto:3 AES_CM_128_HMAC_SHA1_80 inline:O1qT9tWbs/NwJVwhfrgF5tCrbNOxnVDqkIqTx4rz|2^31
a=rtcp-mux

```

## <a name="format-for-offer-from-teams-to-sbc"></a>Формат предложения из Teams в SBC 

### <a name="format-for-sdes-only-offer-to-sbc"></a>Формат для СДЕС только предложением для SBC

```console
m=audio 52884 RTP/SAVP 111 103 104 9 0 8 106 13 110 112 113 126
a=crypto:0 AES_CM_128_HMAC_SHA1_32 inline:Hr4D2cgUu9+Uza5Igz/JkVx59DAxDbaxJg862ibQ|2^31
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:JPEaIxHegfuv53ykBPZk8hV0GO8kTiiqRMfHimEE|2^31
a=rtcp:52884
a=rtcp-mux
```

