---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутии
appliesto:
- Microsoft Teams
ms.openlocfilehash: 43673c2b6a1928ab2ca21579339324f01d5ada9e
ms.sourcegitcommit: 1a08ec9069332e19135312d35fc6a6c3247ce2d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2020
ms.locfileid: "41888578"
---
# <a name="overview"></a>Обзор

В этой статье описывается, как direct Routing поддерживает обход мультимедиа с помощью граничного геймпада сеанса (SBC) для ICE Lite, как описано в [RFC 5245.](https://tools.ietf.org/html/rfc5245) Эта статья предназначена для администраторов голосовой связи, отвечающих за настройку подключения между локальной SBC и прокси-службой SIP.

В этой статье приводится обзор сценариев и требований для работы с ICE Lite. В этой статье описаны форматы сообщений и необходимые переходы государственного компьютера для обеспечения надежного потока звонка и передачи мультимедиа.

## <a name="terminology"></a>Терминология

- First Hello — первые слова, произнесенные звонив и вызываемой звоня. Важно сделать все возможное, чтобы обеспечить доставку первых пакетов с конечных точек в большинстве случаев.

- Forking — предложение от вызываемой команды может быть доставлено на несколько конечных точек, если вызываемая команда доступна на нескольких устройствах (например, пользователь Teams может быть подписан в Teams для Windows и Teams для Android или iPhone).

- Предварительный ответ (183) — конечные точки, необходимые для более быстрой настройки звонка, отправляют ответ с кандидатами и ключами, необходимыми для настройки потока мультимедиа. Это делается с учетом того, что пользователь может ответить на звонок (200OK) из этого экземпляра. Благодаря функции размыкажения звоняющий должен быть готов получить несколько предварительных ответов.

- Re-Invite – предложение с окончательными кандидатами, выбранными управляющей конечной точкой ICE. Атрибут a=remote-candidate будет иметь атрибут a=remote-candidate для устранения любых условий гонок от обработки нескольких вилок.

- Конечная точка Teams — это может быть сервер (процессор мультимедиа, ретранслятор транспорта) или клиент Teams.

## <a name="message-format"></a>Формат сообщения

Инфраструктура Teams следует за RFC 5245 для ICE-Lite. Это подразумевает, что все сообщения STUN соответствуют [требованиям RFC 5389.](https://tools.ietf.org/html/rfc5389)

В SBCs, требуемом для RFC 5389, необходимо игнорировать все атрибуты STUN, которые они не распознают, и продолжать обрабатывать сообщения с известными атрибутами. 

При получении неформатированной формы пакеты необходимо удалить, не влияя на установку сеанса мультимедиа.

## <a name="ice-lite-requirements"></a>Требования ICE Lite

В этом разделе кратко фиксироваться требования для ICE Lite.

### <a name="candidate-gathering"></a>Соищание

SBC должен предлагать только одну соисковую соисковую информацию. В настоящее время поддерживаются только кандидаты по IPV4.


#### <a name="connectivity-checks"></a>Проверки подключения

Внедрение ICE Lite должно реагировать на все полученные проверки подключения. Конечная точка ICE Lite не должна отправлять запросы на проверку подключения. (Если проверки подключения отправляются с нарушением, будет реагировать полная реализация, что может привести к обнаружению потенциальных кандидатов с непредвиденным одноранговой связью и сбоям в звонках.)

#### <a name="nominations"></a>Беты

Конечной точкой полной реализации ICE всегда является контрольная конечная точка, и она будет следовать за обычными сроками выбора конечных кандидатов, которые будут использоваться для потока мультимедиа. Конечная точка ICE Lite может использовать эти средства, чтобы завершить путь к использованию мультимедиа и завершить установку звонка.

Примечание. Если вы хотите использовать одноранговые конечные точки, отправляя 183 предварительных ответа, SBC должен быть готов к реагированию на проверки с нескольких конечных точек, а также с несколькими конечными точками, если до 200OK произойдет такое количество лицензий. В зависимости от сходимости компьютера ICE по конечному пути и времени ответа пользователя, срок действия лицензии может быть не раньше 2000 года. У SBC должна быть возможность обработки обоих случаев.

#### <a name="converging-for-forking"></a>Сходящиеся для разминания

Если предложение SBC предлагает несколько конечных точек Teams, конечные точки Teams могут отвечать с помощью предварительного ответа и начала проверки подключения. Необходимо подготовиться к приему проверок подключения и реагированию на проверки подключения с нескольких одноранговых конечных точек. Например, для пользователя Teams можно использовать как рабочий стол, так и мобильный телефон. Оба устройства будут уведомлены о входящий звонок и попытаются проверки подключения с SBC.

В конечном итоге на звонок ответит только одна из конечных точек (200OK). При получении пакета 200OK можно настроить контекст для обработки пакетов мультимедиа.

## <a name="scenarios"></a>Scenarios

###  <a name="inbound-call-from-sbc"></a>Входящий звонок из SBC

В этом сценарии существует несколько конечных точек, которые должны обрабатываться СКА:

- Конечные точки сервера обычно реагируют непосредственно в 200OK. Это полные конечные точки ICE, которые обычно участвуют в сценариях голосовой почты, очереди вызовов и автоответа.

- Клиентские конечные точки могут отправлять несколько предварительных ответов с разными тегами "От" и "На" (183), за которыми следует 200OK с конечной точки, которая отвечает на звонок. Это полные конечные точки ICE, которые обычно представляют клиенты конечных пользователей.

- Другие конечные точки SBC. Это конечные точки ICE Lite, которые обычно участвуют в сценарии одновременного звонка клиентских конечных точек и других номеров телефонов.

SBC должен отвечать на все допустимые запросы проверки подключения, полученные с полных конечных точек ICE. При RFC полные конечные точки ICE становятся конечными точками управления. Конечные точки Teams (клиент-сервер) выполняют обычные проверки подключения. Итоговая точка 200Ok может быть либо с конечной точки, которая отправила мультимедиа раньше, либо с другой конечной точки. При получении 200Ok SBC должен настроить правильный контекст для потока мультимедиа. 

###  <a name="early-media"></a>Ранние мультимедиа

Если имеется ранний поток мультимедиа, SBC должен быть прищелковым к первой конечной точке, которая начинает потоковую передачу мультимедиа; Поток мультимедиа может начаться до того, как будут назначены кандидаты. Чтобы включить сценарии IVR и голосовой почты, на этом этапе УАЦ должна поддерживать отправку DTMF. Следует использовать путь с наивысшим приоритетом, по которому она получает проверки, если не завершены политики.

### <a name="outbound-call-to-sbc"></a>Исходящие вызовы на SBC

Конечные точки Teams являются вызывающим (для этого сценария) и будут контрольной конечной точкой. При получении предварительного (183) или конечного ответа (200OK) конечная точка Teams начнет проверки подключения и переходит к обычным проверкам связи.

Примечание. Если SBC отправляет предварительный ответ (183), он должен быть готов получать запросы на проверку подключения и потенциально завершить проверку до отправки запроса 200OK. Если проверки и/или проверки выполнены до 2000 года, проверки и/или проверки не будут выполняться повторно после 200OK. Код SBC не должен изменять данные ICE candidates, password и ufrag (фрагмент имени пользователя) в период с 183 по 200.

Для поддержки ранних подключений SBC может начать потоковую передачу мультимедиа с соискантом, который является одноранговым соиском ICE, с наивысшим приоритетом на основе полученных проверок подключения, еще до того, как конечные точки Teams завершили передачу данных. В SBC следует ожидать, что мультимедиа из Teams будут у всех кандидатов до тех пор, пока не будут завершены процесс перенастройки. После того как соискитель является кандидатом, ему необходимо восстановить контекст для отправки и получения пакетов мультимедиа.

## <a name="srtp-support-requirements"></a>Требования к поддержке SRTP

Код SBC должен поддерживать шифрование AES_CM_128_HMAC_SHA1_80 SRTP, чтобы предлагать и отвечать на них в следующем формате:

```console
"inline:" <key||salt> ["|" lifetime]
```

Ниже приводится пример атрибута crypto в предложении SDP от SBC:

```console
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:V/Lr6Lsvhad/crSB9kCQ28jrYDxR2Yfk5bXryH5V|2^31
```

Параметры MKI и Length не требуются.

Дополнительные сведения см. в разделе [6.1 RFC 4568.](https://tools.ietf.org/html/rfc4568#section-6.1)

## <a name="sdes-support-requirements"></a>Требования к поддержке SDES

Устройство должно иметь возможность предлагать SDES в формате, как описано ниже. Процессоры Microsoft Media всегда предпочитают SDES.

- В случае обхода без мультимедиа, даже если клиент поддерживает только DTLS, процессоры мультимедиа преобразуются в SDES.

- При обходе мультимедиа, если клиент только DTLS (будущий штат Google Chrome), Direct Routing вставит в путь MP, преобразуя звонок из обхода мультимедиа в обход без мультимедиа. Между SBC и компонентом процессора мультимедиа Direct Routing всегда используется SDES.

В настоящее время клиент Teams не предлагает только DTLS. Однако Компания Google объявила, что со временем поддержка SDES перестанет поддерживаться.

## <a name="format-for-offer-from-sbc-in-bypass-mode"></a>Формат предложения из SBC в режиме обхода 

Предложение должно содержать SDES и может содержать необязательный DTLS в следующем формате:

```console
m=audio 54056 UDP/TLS/RTP/SAVP 0 8 76 77 18 9 101 13
a=rtcp:54056
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:krXco0QRglwErMqtbMs2zSw29tBdmdgXpEYZhQmp|2^31
a=fingerprint:sha-256 AE:24:07:15:5C:B7:45:1A:E4:45:60:C1:1E:68:0E:CC:8D:A6:78:3B:76:65:BB:B0:77:88:07:F8:98:18:62:34
a=setup:actpass
a=rtcp-mux
```

### <a name="format-for-answer-containing-sdes-to-sbc"></a>Формат ответа, содержащего SDES в SBC

```console
m=audio 54056 RTP/SAVP 111 103 104 9 0 8 description 106 13 110 112 113 126
a=rtcp:54056
a=crypto:2 AES_CM_128_HMAC_SHA1_80 inline:fBc61ikv1kMy0sF85DblNqTzVAbFa7hJQ9GKb6Yj|2^31|1:1
a=crypto:3 AES_CM_128_HMAC_SHA1_80 inline:O1qT9tWbs/NwJVwhfrgF5tCrbNOxnVDqkIqTx4rz|2^31
a=rtcp-mux

```

## <a name="format-for-offer-from-teams-to-sbc"></a>Формат предложения от Teams к SBC 

### <a name="format-for-sdes-only-offer-to-sbc"></a>Формат для SDES предлагается только для SBC

```console
m=audio 52884 RTP/SAVP 111 103 104 9 0 8 106 13 110 112 113 126
a=crypto:0 AES_CM_128_HMAC_SHA1_32 inline:Hr4D2cgUu9+Uza5Igz/JkVx59DAxDbaxJg862ibQ|2^31
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:JPEaIxHegfuv53ykBPZk8hV0GO8kTiiqRMfHimEE|2^31
a=rtcp:52884
a=rtcp-mux
```

