---
title: Общие сведения о прямой маршрутизации телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Прямая маршрутизация hHw поддерживает обход сервера-посредника с включенным пограничным контроллером сеанса для ICE Lite.
appliesto:
- Microsoft Teams
ms.openlocfilehash: e6f9715ee410116a66c572522a910cd16ef27154
ms.sourcegitcommit: f0e2a5928e9b959daf45202b9f256f65c2087195
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/20/2022
ms.locfileid: "68614422"
---
# <a name="overview"></a>Обзор

В этой статье описывается, как прямая маршрутизация поддерживает обход сервера-посредника с включенным пограничным контроллером сеансов (SBC) для ICE Lite, как описано в [RFC 5245](https://tools.ietf.org/html/rfc5245). Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку подключения между локальным SBC и службой прокси-сервера SIP.

В этой статье представлен обзор сценариев ICE Lite и требований к взаимодействию. В этой статье описываются форматы сообщений и необходимые переходы конечного автомата для обеспечения надежного вызова и потока мультимедиа.

## <a name="terminology"></a>Терминологии

- First Hello — первые слова, произнесенные вызывающим и вызываемым абонентом. Важно сделать все возможное, чтобы обеспечить надежную доставку первых пакетов из конечных точек в большинстве случаев использования.

- Разветвление — предложение от вызывающего абонента может быть доставлено в несколько вызываемых конечных точек, если вызываемый абонент доступен на нескольких устройствах (например, пользователь Teams может быть подписан в Teams для Windows и Teams для Android или iPhone).

- Provisional Answer (183) — вызываемые конечные точки для ускорения настройки вызовов отправляют ответ с кандидатами и ключами, необходимыми для установки потока мультимедиа. Это делается с учетом того, что пользователь может ответить на звонок (200OK) из конкретного вызываемого экземпляра. С помощью разветвление вызывающий объект должен быть готов к получению нескольких ответов на вопросы о подготовке.

- Re-Invite — предложение с окончательными кандидатами, выбранными управляющей конечной точкой ICE. Он будет иметь атрибут a=remote-candidate для разрешения любых состояний гонки от обработки нескольких вилки.

- Конечная точка Teams — это может быть сервер (обработчик мультимедиа, транспортный ретранслятор) или клиент Teams.

## <a name="message-format"></a>Формат сообщения

Инфраструктура Teams следует RFC 5245 для ICE-Lite. Это означает, что все сообщения STUN будут соответствовать [RFC 5389](https://tools.ietf.org/html/rfc5389).

Контроллеры SBC, необходимые для RFC 5389, должны игнорировать все атрибуты STUN, которые они не распознают, и продолжать обрабатывать сообщения с известными атрибутами. 

Если получены какие-либо неправильно сформированные пакеты, пакеты должны быть удалены без влияния на установку сеанса мультимедиа.

## <a name="ice-lite-requirements"></a>Требования ICE Lite

В этом разделе кратко описаны требования к ICE Lite.

### <a name="candidate-gathering"></a>Сбор кандидатов

SBC должен предлагать только один кандидат. В настоящее время поддерживаются только кандидаты IPV4.


#### <a name="connectivity-checks"></a>Проверки подключения

Реализация ICE Lite должна реагировать на все полученные проверки подключения. Конечная точка ICE Lite не должна отправлять запросы на проверку подключения. (Если проверки подключения отправляются с нарушением, будет реагировать полная реализация, что может привести к обнаружению непредвиденного однорангового кандидата и потенциально привести к сбоям вызовов.)

#### <a name="nominations"></a>Номинациях

Конечная точка полной реализации ICE всегда будет управляющей конечной точкой и будет следовать за заявками "Обычный" для выбора окончательных кандидатов, которые будут использоваться для потока мультимедиа. Конечная точка ICE Lite может использовать утверждения, чтобы завершить путь, используемый для носителя, и завершить установку вызова.

Примечание. В случае разветвление с помощью одноранговых конечных точек, отправляющего 183 ответов на запросы, SBC должен быть готов реагировать на проверки из нескольких конечных точек, а также заявки от нескольких конечных точек, если заявки выполняются до 200OK. В зависимости от конвергенции конечного пути и времени ответа пользователя на конечный путь конечного автомата ICE, утверждения могут выполняться до или после 200OK. SBC должен иметь возможность обрабатывать оба варианта.

#### <a name="converging-for-forking"></a>Схождение для разветвление

Если предложение из вилки SBC в несколько конечных точек Teams, конечные точки Teams могут ответить на запросы и начать проверку подключения. SBC должен быть готов к приему проверок подключения и реагированию на проверки подключения из нескольких одноранговых конечных точек. Например, пользователь Teams может быть включен как на рабочий стол, так и на мобильный телефон. Оба устройства будут уведомлены о входящем вызове и попытаются проверить подключение с помощью SBC.

В конечном итоге только одна из конечных точек ответит на вызов (200OK). Получив 200OK, SBC может настроить правильный контекст для обработки пакетов мультимедиа.

## <a name="scenarios"></a>Scenarios

###  <a name="inbound-call-from-sbc"></a>Входящий вызов из SBC

В этом сценарии существует несколько возможных одноранговых конечных точек, которые должен обрабатывать SBC:

- Конечные точки сервера обычно отвечают напрямую с помощью 200OK. Это полные конечные точки ICE, которые обычно используются в сценариях голосовой почты, очереди звонков и автосекретаря.

- Клиентские конечные точки могут отправлять несколько ответов на запросы с разными тегами From/To (183), за которыми следует 200OK из конечной точки, которая отвечает на вызов. Это полные конечные точки ICE, обычно представляющие клиенты конечных пользователей.

- Другие конечные точки SBC. Это конечные точки ICE Lite, обычно участвующие в сценарии одновременного звонка к конечным точкам клиента и другим номерам телефонов.

SBC должен отвечать на все допустимые запросы проверки подключения, полученные от полных конечных точек ICE. На RFC полные конечные точки ICE станут конечными точками управления. Конечные точки Teams (клиент/сервер) будут выполнять назначения "Обычный" для завершения проверки подключения. Последняя версия 200Ok может быть либо из конечной точки, отправив ранний носитель, либо из другой конечной точки. При получении 200Ok SBC должен настроить правильный контекст для потока мультимедиа. 

###  <a name="early-media"></a>Ранний носитель

Если имеется ранний поток мультимедиа, SBC должен защелать первую конечную точку, которая начинает потоковую передачу мультимедиа; поток мультимедиа может запускаться до того, как будут назначены кандидаты. SBC должен поддерживать отправку DTMF на этом этапе, чтобы включить сценарии IVR или голосовой почты. SBC должен использовать путь с наивысшим приоритетом, по которому он получил проверки, если заявки не завершены.

### <a name="outbound-call-to-sbc"></a>Исходящий вызов SBC

Конечные точки Teams являются вызывающим объектом для этого сценария и будут управляющей конечной точкой. При получении предварительного ответа (183) или окончательного ответа (200OK) конечная точка Teams начнет проверки подключения и переходит к утверждениям "Обычный", чтобы завершить проверки подключения.

Примечание. Если SBC отправляет ответ на подготовку (183), SBC должен быть готов к получению запросов на проверку подключения и потенциальному завершению заявки до отправки 200OK SBC. Если проверки и (или) заявки завершались до получения 200OK, проверки и (или) назначения не будут выполняться повторно после получения 200OK. SBC не должен изменять кандидаты ICE, пароль и ufrag (фрагмент имени пользователя) в диапазоне от 183 до 200.

Чтобы обеспечить поддержку ранних носителей, SBC может начать потоковую передачу мультимедиа на одноранговый кандидат ICE с наивысшим приоритетом на основе полученных проверок подключения даже до того, как конечная точка Teams завершит отправку заявки. SBC должен ожидать передачи мультимедиа из Teams на любом кандидате до тех пор, пока не будут завершены заявки. После назначения кандидата SBC должен сбросить нужный контекст для отправки и получения пакетов мультимедиа.

## <a name="srtp-support-requirements"></a>Требования к поддержке SRTP

SBC должен поддерживать шифр шифрования SRTP AES_CM_128_HMAC_SHA1_80 для предложения и ответа в следующем формате:

```console
"inline:" <key||salt> ["|" lifetime]
```

Ниже приведен пример атрибута шифрования в предложении SDP из SBC:

```console
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:V/Lr6Lsvhad/crSB9kCQ28jrYDxR2Yfk5bXryH5V|2^31
```

Параметры MKI и Length не требуются.

Дополнительные сведения см. в [разделе 6.1 RFC 4568](https://tools.ietf.org/html/rfc4568#section-6.1).

## <a name="sdes-support-requirements"></a>Требования к поддержке SDES

Устройство должно иметь возможность предлагать SDES в формате, как описано ниже. Обработчики мультимедиа Майкрософт всегда предпочитают SDES.

- При обходе без носителя, даже если клиент поддерживает только DTLS, обработчики мультимедиа преобразуются в SDES.

- При обходе сервера-посредника, если клиент является только DTLS (в будущем состоянии Google Chrome), прямая маршрутизация вставит MP в путь, преобразуя вызов из обхода сервера-посредника в обход без носителя. Между компонентом SBC и обработчиком мультимедиа прямой маршрутизации всегда используется SDES.

В настоящее время нет клиента Teams, который предлагает только DTLS. Однако Компания Google сообщила, что в определенный момент времени прекращает поддержку SDES.

## <a name="format-for-offer-from-sbc-in-bypass-mode"></a>Формат предложения из SBC в режиме обхода 

Предложение должно содержать SDES и может содержать необязательный DTLS в следующем формате:

```console
m=audio 54056 UDP/TLS/RTP/SAVP 0 8 76 77 18 9 101 13
a=rtcp:54056
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:krXco0QRglwErMqtbMs2zSw29tBdmdgXpEYZhQmp|2^31
a=fingerprint:sha-256 AE:24:07:15:5C:B7:45:1A:E4:45:60:C1:1E:68:0E:CC:8D:A6:78:3B:76:65:BB:B0:77:88:07:F8:98:18:62:34
a=setup:actpass
a=rtcp-mux
```

### <a name="format-for-answer-containing-sdes-to-sbc"></a>Формат ответа, содержащего SDES в SBC

```console
m=audio 54056 RTP/SAVP 111 103 104 9 0 8 description 106 13 110 112 113 126
a=rtcp:54056
a=crypto:2 AES_CM_128_HMAC_SHA1_80 inline:fBc61ikv1kMy0sF85DblNqTzVAbFa7hJQ9GKb6Yj|2^31|1:1
a=crypto:3 AES_CM_128_HMAC_SHA1_80 inline:O1qT9tWbs/NwJVwhfrgF5tCrbNOxnVDqkIqTx4rz|2^31
a=rtcp-mux

```

## <a name="format-for-offer-from-teams-to-sbc"></a>Формат предложения из Teams в SBC 

### <a name="format-for-sdes-only-offer-to-sbc"></a>Форматирование для предложения SDES только для SBC

```console
m=audio 52884 RTP/SAVP 111 103 104 9 0 8 106 13 110 112 113 126
a=crypto:0 AES_CM_128_HMAC_SHA1_32 inline:Hr4D2cgUu9+Uza5Igz/JkVx59DAxDbaxJg862ibQ|2^31
a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:JPEaIxHegfuv53ykBPZk8hV0GO8kTiiqRMfHimEE|2^31
a=rtcp:52884
a=rtcp-mux
```

