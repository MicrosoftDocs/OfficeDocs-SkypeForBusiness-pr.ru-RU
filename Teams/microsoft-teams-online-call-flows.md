---
title: Потоки звонков Microsoft Teams
ms.author: crowe
author: CarolynRowe
manager: serdars
ms.date: 06/08/2018
ms.topic: conceptual
ms.service: msteams
ms.reviewer: sonua
audience: admin
localization_priority: Normal
search.appverid: MET150
ms.collection:
- Teams_ITAdmin_Help
- M365-collaboration
- M365-voice
appliesto:
- Microsoft Teams
description: В этой статье описано, как teams использует потоки Office 365 в различных топологиях.
ms.openlocfilehash: d98f789017c0f5388a0adebd382d947e716d7fc9
ms.sourcegitcommit: e1c8a62577229daf42f1a7bcfba268a9001bb791
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/07/2019
ms.locfileid: "36239357"
---
# <a name="microsoft-teams-call-flows"></a>Потоки звонков Microsoft Teams

> [!Tip]
> В следующем сеансе показано, как в Teams используются сети и как планировать оптимальное сетевое подключение: [планирование сети Teams](https://aka.ms/teams-networking)

## <a name="overview"></a>Обзор
В этой статье описано, как teams использует потоки звонков Office 365 в различных топологиях. Кроме того, он описывает уникальные потоки команд, которые используются для одноранговой передачи данных мультимедиа. Документ описывает эти потоки, назначение и их происхождение и увольнение в сети. Для целей, описанных в этой статье, необходимо принять следующие сведения.

- Поток X используется локальным клиентом Office 365 для связи со службой Office 365 в облаке. Она получена из сети клиента и завершается в качестве конечной точки в Office 365.

- Поток Y используется локальным клиентом Office 365 для связи со службой в Интернете, для которой Office 365 имеет зависимость. Она получена из клиентской сети и завершается как конечная точка в Интернете.

Эта статья содержит следующие разделы:

- **Background (фон** ) — представлена информация общего характера, например сети, которые могут пройти потоки Office 365, тип трафика, руководство по подключению клиента к конечным точкам служб Office 365, взаимодействие с сторонними компонентами и принципы, которые используются в Teams для выбора потоков мультимедиа.

- **Потоки звонков в различных топологиях** — показывает использование потоков звонков в различных топологиях. Для каждой топологии в разделе перечисляются все поддерживаемые потоки и показано, как эти потоки используются с помощью нескольких вариантов использования. Для каждого варианта использования он описывает последовательность и выбор потоков с помощью схемы потока. 

- **Teams с оптимизацией для Экспресс-маршрута** — описывает, как эти потоки используются при развернутом Экспресс-маршруте для оптимизации и иллюстрируются с помощью простой топологии.

## <a name="background"></a>Общие сведения
### <a name="network-segments"></a>Сегменты сети
**Клиентская сеть**: это сегмент сети, который вы управляете и управляете. Сюда входят все клиентские соединения в офисах клиентов (проводные или беспроводные), а также в локальных центрах обработки данных и подключениях к поставщикам услуг Интернета, Экспресс-маршрутам и другим частным одноранговым соединениям. 

Обычно сеть клиента имеет несколько периметров сети с брандмауэрами и/или прокси-серверами, которые принудительно задают политики безопасности Организации и разрешают только определенный сетевой трафик, который вы настроили и настроены. Так как вы управляете этой сетью, вы можете прямо управлять работой сети, и настоятельно рекомендуется выполнять оценку сети для проверки производительности в сети и из сети в сеть Office 365. 

**Интернет**: это сегмент сети, который входит в общую сеть и будет использоваться пользователями, которые подключаются к Office 365 из-за пределов клиентской сети. Она также используется в некоторых трафиках из сети клиента в Office 365. 

**Посещенная/Гостевая частная сеть**: это сегмент сети за пределами вашей клиентской сети, но не в общедоступном Интернете, который пользователи и (или) гости могут посещать. Например, домашняя частная сеть или Корпоративная частная сеть, не развертывающая группы, в которой могут находиться пользователи и (или) клиенты, взаимодействующие с службами Teams.

>**Примечание**: подключение к Office 365 также применимо к этим сетям.

**Office 365**: это сегмент сети, поддерживающий службы Office 365. Она распространяется по всему миру с помощью краев в большинстве местоположений в отношении сети клиентов. Функции, упомянутые в этом документе, включают транспортные Relay, сервер конференц-связи и процессор мультимедиа. 

**Экспресс-маршрут (необязательно)**: это сегмент сети, который является частью всей сети и предоставит вам выделенное личное подключение к сети Office 365.

### <a name="types-of-traffic"></a>Типы трафика

**Мультимедиа в реальном времени**: данные, инкапсулированные в RTP (транспортный протокол в реальном времени), поддерживающие работу со звуком, видео и демонстрацией экрана. Как правило, трафик в мультимедиа очень чувствителен к задержкам, поэтому этот трафик может быть как можно более одновременным, так и использовать UDP и TCP как протокол транспортного уровня, который является лучшим транспортом для интерактивного воспроизведения в реальном времени с точки зрения качества. . (Примечание. в качестве последнего средства мультимедиа может использовать протокол TCP/IP и также является туннелем по протоколу HTTP, но это не рекомендуется делать из-за неправильного ограничения качества.) Поток RTP обеспечивает безопасность через SRTP, в которой шифруются только полезные данные.

**Передача сигналов**: связь между клиентом и сервером, а также другие клиенты, которые используются для управления действиями (например, при инициировании звонка), и доставка мгновенных сообщений. Большая часть трафика сигналов использует интерфейсы для RESTFUL на основе HTTPS, но в некоторых сценариях (например, подключение между Office 365 и контроллером границ сеанса) использует протокол SIP. Важно понимать, что этот трафик менее важен для задержки, но может привести к нарушениям обслуживания или тайм-аутам звонков, если задержка между конечными точками превышает несколько секунд. 

### <a name="connectivity-to-office-365"></a>Подключение к Office 365

Для работы Teams требуется [Подключение к Интернету](https://support.office.com/article/connectivity-to-the-internet-64b420ef-0218-48f6-8a34-74bb27633b10). URL-адреса и диапазоны IP-адресов для конечных точек указаны в списке URL-адресов и диапазонов адресов для [Office 365](https://docs.microsoft.com/office365/enterprise/urls-and-ip-address-ranges). (Примечание: Откройте для себя подключение к портам TCP 80 и 443, а для UDP-портов 3478 — 3481.) Кроме того, у Teams есть зависимость от Skype для бизнеса Online, который также должен быть подключен к Интернету.

Потоки мультимедиа в Teams реализованы по стандартным процедурам IETF (для установления интерактивной связи).

### <a name="interoperability-restrictions"></a>Ограничения на взаимодействие
**Ретрансляция мультимедиа третьими лицами**: поток команд мультимедиа (то есть одна из конечных точек мультимедиа — Teams) может проходить только в Teams или в машинных средствах трансляции мультимедиа Skype для бизнеса. Взаимодействие с ретранслятором мультимедийных файлов сторонних производителей не поддерживается. (Примечание. сторонний SBC-объект на границе с КТСОП должен прерывать поток RTP/РТКП, защищенным с помощью SRTP, и не передавать его на следующий прыжок.)

**Прокси-серверы SIP третьих лиц**: диалоговое окно сигнализации SIP со сторонними SBC и (или) шлюзом могут проходить по основным прокси-серверам SIP группы или Skype для бизнеса. Взаимодействие с прокси-сервером SIP третьих лиц не поддерживается.

**СТОРОННИЕ B2BUA (то есть, SBC)**: поток команд мультимедиа из/в сеть PSTN завершается третьим SBC. Тем не менее, взаимодействие с односторонними SBC в сети Teams (это значит, что независимый друг от друга односторонний из двух конечных точек группы и Skype для бизнеса) не поддерживается.

### <a name="technologies-that-are-not-recommended-with-microsoft-teams"></a>Технологии, не рекомендованные для Microsoft Teams

**Сеть VPN**: не рекомендуется использовать трафик мультимедиа (то есть, поток 2). VPN-клиент должен использовать разделенный VPN-трафик и перенаправлять такие данные, как и любой внешний пользователь, https://blogs.technet.microsoft.com/nexthop/2011/11/14/enabling-lync-media-to-bypass-a-vpn-tunnel/не являющийся VPN, как указано в.

>**Примечание**. Несмотря на то, что название — Lync, оно также применимо и для групп.

**Пакеты шаперс**: не рекомендуется использовать ни один из типов пакетов снипперс, проверка пакетов или многопакетные устройства, что может привести к существенному снижению качества. 

### <a name="principles"></a>Принцип
Вы ознакомитесь с четырьмя общими принципами, которые помогут вам понять потоки звонков для Microsoft teams:
 
1.  Конференции Microsoft Teams размещаются в Office 365 в той же области, в которой вы присоединились к первому участнику. (Примечание. Если в некоторых топологиях будут исключения из этого правила, они будут описаны в этом документе и проиллюстрированы соответствующим потоком вызова.)

2.  Конечная точка среды выполнения команд в Office 365 используется в соответствии с потребностями обработки мультимедиа, а не на основе типа звонка. (Например, вызов "точка-точка" может использовать конечную точку мультимедиа в облаке для обработки мультимедиа для транскрипции и (или) записи, в то время как Конференция с двумя участниками может не использовать конечную точку мультимедиа в облаке.) Однако большинство конференций используют конечную точку мультимедиа для смешивания и маршрутизации, выделена там, где размещена конференция. Трафик мультимедиа, отправленный клиентом в конечную точку мультимедиа, может перенаправляться напрямую или использовать транспортный ретранслятор в Office 365, если это требуется из-за ограничений сетевого брандмауэра клиента. 

3.  Трафик мультимедиа для одноранговых вызовов — это самый прямой маршрут, который доступен, предполагая, что этот звонок не записывает конечную точку мультимедиа в облаке (см. #2 выше). Предпочтительный маршрут — это прямой путь к удаленному узлу (клиенту), но если этот маршрут недоступен, то один или несколько ретрансляций транспорта будут передавать трафик. Рекомендуется, чтобы трафик мультимедиа не накладывается с поворотом на серверы, например пакеты шаперс, VPN-серверы и т. д., так как это повлияет на качество мультимедиа.

4.  Трафик, передаваемые по сигналу, всегда отправляется на ближайший сервер. 

Подробнее о том, как выбрать путь к носителю, можно найти https://www.youtube.com/watch?v=1tmHMIlAQdoв статье.

## <a name="call-flows-in-various-topologies"></a>Потоки звонков в различных топологиях
### <a name="teams-topology"></a>Топология групп
Эта топология используется клиентами, которые используют службы Teams из облака без локального развертывания, такие как Skype для бизнеса Server или прямая маршрутизация телефонной системы. Кроме того, интерфейс для Office 365 выполняется через Интернет без маршрута Azure Express. 

[![Потоки звонков в Microsoft Teams Online, рисунок 01](media/microsoft-teams-online-call-flows-figure01.png)](media/microsoft-teams-online-call-flows-figure01.png)

*Схема 1 — топология групп*

Обратите внимание, что:

- Направление стрелок на схеме выше отражает направление запуска связи, влияющей на подключение на периметрах предприятия. В случае использования UDP для мультимедиа первый пакет (-ов) может перетекать в обратном направлении, но эти пакеты могут блокироваться до тех пор, пока не будут передаваться пакеты в другом направлении.
- Teams разворачивается рядом с приложением Skype для бизнеса Online, поэтому клиенты выводятся как "Teams/SFB User".

Дополнительные сведения о следующих необязательных топологиях можно найти ниже в этой статье.

- Локальное развертывание Skype для бизнеса описано в гибридной **топологии Teams**.
- Прямая маршрутизация телефонной системы (для подключения PSTN) описана в разделе **Teams с прямой топологией маршрутизации**.
- Экспресс – маршрут описан в разделе **Teams с оптимизацией Express Route**.

**Описание потока**:
- **Flow 2** — представляет поток, инициированный пользователем в клиентской сети, в составе рабочей группы пользователя. Примерами таких потоков являются DNS-и одноранговые носители.
- **Flow 2 "** — представляет поток, инициированный пользователем удаленных мобильных команд, с VPN в клиентской сети. 
- **Поток 3** — представляет поток, инициированный удаленными пользователями рабочих групп в конечные точки Office 365 и Teams. 
- **Поток 4** — представляет поток, инициированный пользователем в сети клиента, в конечные точки Office 365 или Teams.
- **Поток 5** – обозначает одноранговый поток мультимедиа между пользователем Teams и другими участниками группы или пользователем Skype для бизнеса в клиентской сети.
- " **Поток 6** " — это одноранговый поток мультимедиа между пользователем удаленного доступа к Teams и другими удаленными мобильными группами или пользователями Skype для бизнеса через Интернет.

#### <a name="use-case-one-to-one"></a>Вариант использования: "один-к-одному"
Вызовы "один-к-одному" используют общую модель, в которой вызывающий абонент получает набор кандидатов, состоящий из IP-адресов или портов, в том числе из кандидатов, ретрансляции и гибких (общедоступный IP-адрес клиента, как показано в разделе "ретрансляция"). Вызывающий абонент отправляет эти кандидаты вызываемому абоненту. Вызываемый абонент также получает сходный набор кандидатов и отправляет их вызывающему абоненту. STUN с сообщениями проверка подключения используется для определения того, какие пути носителей вызывающего и вызываемого абонента работают, и выбран лучший рабочий путь. Носители (то есть пакеты RTP/РТКП, защищенные через SRTP) затем отправляются с использованием выбранной пары кандидатов. Транспортный ретранслятор развертывается в составе Office 365.

Если IP-адрес или потенциальные кандидаты имеют соединение, для мультимедиа будет выбран прямой путь между клиентами (или посредством NAT). Если клиенты находятся в сети клиента, необходимо выбрать прямой путь. Для этого требуется прямая связь по протоколу UDP в клиентской сети. Если клиенты Номадик и пользователи облака, в зависимости от NAT и брандмауэра, мультимедиа может использовать прямую связь.

Если один клиент является внутренним в клиентской сети, а один клиент является внешним (например, пользователь с мобильным облаком), маловероятно, что вы перейдете на прямую связь между локальным или воспроизведенными кандидатами. В этом случае можно использовать один из кандидатов транспортной ретрансляции из любого клиента (например, внутренний клиент, получивший кандидата Relay из ретрансляции транспорта в Office 365; внешний клиент должен иметь возможность отправлять пакеты STUN/RTP/РТКП в Transport Relay). Еще один вариант — внутренний клиент отправляется на кандидат-ретранслятор, полученный от клиента для мобильных устройств. Обратите внимание, что настоятельно рекомендуется использовать протокол TCP для подключения к носителю.

**Высокоуровневые действия**:
1. Пользователи Teams с разрешениями доменного имени URL-адреса (DNS) через flow2
2. Пользователь Teams выделит порт ретрансляции мультимедиа в Team Relay Transport с помощью потока 4
3. Пользователь Teams отправляет "пригласить" с кандидатами ICE через поток 4 в Office 365
4. Office 365 отправляет уведомление пользователю Teams B с помощью потока 4
5. Пользователь Teams B выделит порт ретрансляции мультимедиа в Team Relay Transport с помощью потока 4
6. Пользователи Teams B отправляют "Answer" с кандидатами ICE через поток 4, который пересылается обратно пользователю Teams с помощью потока 4
7. Пользователи Teams A и Teams B вызывают тесты подключения ICE, и выбирается лучший доступный путь к носителю (для различных вариантов использования см. схемы ниже).
8. Пользователи Teams отправляют телеметрию в Office 365 с помощью потока 4

**В клиентской сети:**

[![Потоки звонков в Microsoft Teams Online, рисунок 02](media/microsoft-teams-online-call-flows-figure02-thumbnail.png)](media/microsoft-teams-online-call-flows-figure02.png)

*Рис. 2 — в клиентской сети*
 
На шаге 7 выбирается одноранговый поток мультимедиа с потоком 5.
 
Мультимедиа является двунаправленной. Направление потока 5 указывает на то, что одна сторона инициирует связь с точки зрения соединения в соответствии со всеми потоками в этом документе. В этом случае не имеет значения, какое направление используется, так как обе конечные точки находятся в сети клиента.

**Клиентская сеть для внешних пользователей (носители ретранслируется транспортом Team Relay):**

[![Потоки звонков в Microsoft Teams Online, рисунок 03](media/microsoft-teams-online-call-flows-figure03-thumbnail.png)](media/microsoft-teams-online-call-flows-figure03.png)

*Рисунок 3-клиентская сеть для внешних пользователей (ретрансляция мультимедиа с помощью транспортной ретрансляции Teams)*
 
На шаге 7, поток 4, из сети клиентов в Office 365 и из 3 из удаленных мобильных групп в Office 365, будут выделены пользователи. Эти потоки ретранслируется с помощью транспортной ретрансляции Teams в Office 365.

Мультимедиа является двунаправленной, в которой указано, на какой стороне начинается связь с точки зрения подключения. В этом случае эти потоки используются для передачи сигналов и мультимедиа с помощью различных протоколов и адресов.

**Клиентская сеть для внешних пользователей (Direct Media):**

[![Потоки звонков Microsoft Teams Online, рис. 04](media/microsoft-teams-online-call-flows-figure04-thumbnail.png)](media/microsoft-teams-online-call-flows-figure04.png)

*Рисунок 4: клиентская сеть для внешних пользователей (Direct Media)*
 
На этапе 7 поток 2 из сети клиента в Интернет (одноранговый клиент) будет выбрана.
- Прямые носители с удаленным пользователем мобильного устройства (то есть не передаются через Office 365) являются необязательными. Другими словами, клиент может заблокировать этот путь для обеспечения пути к носителю с помощью транспортной ретрансляции в Office 365.

- Мультимедиа является двунаправленной. Направление потока 2 к удаленному пользователю мобильного устройства указывает на то, что одна сторона инициирует связь с точки зрения подключения. 

**Подключение VPN к внутреннему пользователю (ретрансляция мультимедиа с помощью транспорта Team Relay)**

[![Потоки вызовов Microsoft Teams Online, рис. 05](media/microsoft-teams-online-call-flows-figure05-thumbnail.png)](media/microsoft-teams-online-call-flows-figure05.png)

*Рис. 5 — пользователь VPN внутреннему пользователю (ретрансляция мультимедиа с помощью транспортной ретрансляции Teams)*
 
Передача сигналов между VPN и сетью клиентов осуществляется с помощью потока 2. Передача сигналов между сетью клиентов и Office 365 осуществляется с помощью потока 4. Однако мультимедиа обходит VPN-подключение и проходит через потоки 3 и 4 через командную трансляцию мультимедиа в Office 365.

**VPN-пользователь для внутреннего пользователя (прямые носители)**

[![Схема обзвона Microsoft Teams Online, 6](media/microsoft-teams-online-call-flows-figure06-thumbnail.png)](media/microsoft-teams-online-call-flows-figure06.png)

*Рисунок 6: пользователь VPN на внутренний пользователь (прямые носители)*

Передача сигналов между VPN и сетью клиентов осуществляется с помощью потока 2. Передача сигналов между сетью клиентов и Office 365 осуществляется с помощью потока 4. Однако мультимедиа обходит VPN и передается через поток 2 из клиентской сети в Интернет.

Мультимедиа является двунаправленной. Направление потока 2 к удаленному пользователю мобильного устройства указывает на то, что одна сторона инициирует связь с точки зрения подключения.

**VPN-пользователь для внешних пользователей (Direct Media)**

[![Поток звонков в Microsoft Teams, рис. 07](media/microsoft-teams-online-call-flows-figure07-thumbnail.png)](media/microsoft-teams-online-call-flows-figure07.png)

*Рисунок 7 — пользователь VPN для внешних пользователей (Direct Media)*

Передача сигнала между VPN-пользователем в клиентской сети осуществляется с помощью потока 2 и из потока 4 в Office 365. Однако мультимедиа обходит VPN и перенаправляется через поток 6.

Мультимедиа является двунаправленной. Направление потока 6 к удаленному пользователю мобильного устройства указывает на то, что одна сторона инициирует связь с точки зрения подключения.

#### <a name="use-case-teams-to-pstn-through-office-365-trunk"></a>Вариант использования: teams для PSTN через магистраль Office 365
В Office 365 имеется телефонная система, позволяющая принимать и получать звонки из общедоступной телефонной сети (PSTN). Если КОММУТИРУЕМая магистральная линия соединена через план звонков по телефонной системе, для этого варианта использования не существует особых требований к подключению. (Если вы хотите подключить собственную локальную магистральную сеть PSTN к Office 365, вы можете использовать прямую маршрутизацию для телефонной системы.)

[![Потоки звонков в Microsoft Teams Online, рисунок 08](media/microsoft-teams-online-call-flows-figure08-thumbnail.png)](media/microsoft-teams-online-call-flows-figure08.png)

*Рисунок 8: команды для PSTN через магистраль Office 365*

#### <a name="use-case-teams-meeting"></a>Вариант использования: собрание Teams

Сервер конференц-связи аудио/видео/экрана (VBSS) входит в состав Office 365. У него есть общедоступный IP-адрес, который должен быть доступен из сети клиента и должен быть доступен из облачного клиента Номадик. Каждый клиент или конечная точка должна иметь возможность подключения к серверу конференций.

Внутренние клиенты будут получать локальные, перегибкие и ретранслируемые кандидаты таким же образом, как описано для одноранговых вызовов. Клиенты будут отправлять эти кандидаты на сервер конференц-связи в приглашении. Сервер конференций не использует ретрансляцию, так как у него есть общедоступный IP-адрес, поэтому он отвечает на его локальный IP-адрес. Клиент и сервер конференций проверяют связь таким же образом, как и для одноранговых звонков. 

Обратите внимание, что:

- Клиенты Teams не могут присоединиться к собраниям Skype для бизнеса, и клиенты Skype для бизнеса не смогут присоединиться к собраниям группы.

- Пользователь PSTN, дополнительно "набрать номер" или "набрать номер", в зависимости от того, как организатор собрания и (или) подготовка к Конференции по телефону. 

- Гостевой пользователь или пользователь клиента может присоединиться к гостевой частной сети, защищенной с помощью встроенного по "FW/NAT".

[![Потоки звонков в Microsoft Teams Online, рисунок 09](media/microsoft-teams-online-call-flows-figure09-thumbnail.png)](media/microsoft-teams-online-call-flows-figure09.png)

*Рисунок 9: собрание группы*

#### <a name="use-case-federation-with-skype-for-business-on-premises"></a>Вариант использования: интеграция с Skype для бизнеса в локальной среде

**Трансляция мультимедиа с помощью транспорта Team Relay в Office 365**

[![Потоки звонков в Microsoft Teams Online, рисунок 10](media/microsoft-teams-online-call-flows-figure10-thumbnail.png)](media/microsoft-teams-online-call-flows-figure10.png)

*Рис. 10-ретрансляция средств транспортной ретрансляции в Office 365*

Обратите внимание, что:

- Федерация — это, по определению, связь между двумя клиентами. В этом случае клиент A использует Teams, Федерации с клиентом B, использующий Skype для бизнеса в локальной среде. Если клиент б также использует Office 365, клиент Skype для бизнеса мог бы использовать поток 3 для подключения к Office 365.

- Передача сигналов и мультимедиа из федеративного клиента Skype для бизнеса на локальный сервер Skype для бизнеса не выходит за рамки этого документа. Однако это показано ниже для ясности.

- Передача сигналов между группами и Skype для бизнеса осуществляется мостом в Office 365.

- Мультимедиа в этом случае передается с помощью ретрансляции серверных групп в Office 365 в клиентскую сеть и удаленное приложение Skype для бизнеса с помощью потока 4.

**Мультимедиа, транслируемое службой ретрансляции мультимедиа Skype для бизнеса в Федеративной клиенте**

[![Потоки звонков в Microsoft Teams Online, рисунок 11](media/microsoft-teams-online-call-flows-figure11-thumbnail.png)](media/microsoft-teams-online-call-flows-figure11.png)

*Рисунок 11 — мультимедиа, транслируемое службой ретрансляции Skype для бизнеса Media в Федеративной клиенте*

Обратите внимание, что:

- Передача сигналов и мультимедиа из федеративного клиента Skype для бизнеса на локальный сервер Skype для бизнеса не выходит за рамки этого документа. Однако это показано ниже для ясности.

- Передача сигналов между группами и Skype для бизнеса осуществляется мостом в Office 365.

- Мультимедиа в этом случае передается из локальной трансляции мультимедийных данных Skype для бизнеса в клиентскую сеть с помощью потока 2. (Обратите внимание на то, что трафик от пользователя Teams до удаленной ретрансляции мультимедиа в сети федеративных клиентов будет изначально заблокирован ретрансляции мультимедиа, пока не начнется поток в обратном направлении. Тем не менее, в обоих направлениях будет открываться подключение с помощью двунаправленного потока.)

**Прямой (одноранговая сеть)**

[![Потоки звонков в Microsoft Teams Online, рисунок 12](media/microsoft-teams-online-call-flows-figure12-thumbnail.png)](media/microsoft-teams-online-call-flows-figure12.png)

*Рисунок 12 — прямой (одноранговая сеть)*

### <a name="teams-hybrid-topology"></a>Гибридная топология Teams
Эта топология включает в себя команды в локальной среде Skype для бизнеса.

[![Потоки звонков в Microsoft Teams Online, рис. 13](media/microsoft-teams-online-call-flows-figure13-thumbnail.png)](media/microsoft-teams-online-call-flows-figure13.png)

*Рисунок 13-Гибридная топология Teams*
 
- Направление стрелок на схеме выше отражает направление запуска связи, влияющей на подключение на периметрах предприятия. В случае использования UDP для мультимедиа первый пакет (-ов) может перетекать в обратном направлении, но эти пакеты могут блокироваться до тех пор, пока не будут передаваться пакеты в другом направлении.

- Teams разворачивается рядом с приложением Skype для бизнеса Online, поэтому клиенты выводятся как "Teams/SFB User".

Дополнительные потоки (на вершине топологии Teams):
- **Поток 5A** — представляет одноранговый поток медиа между пользователем Teams в клиентской сети и локальным ретранслятором мультимедиа в Skype для бизнеса на стороне клиента в сети.

#### <a name="use-case-teams-to-skype-for-business-one-to-one"></a>Вариант использования: teams to Skype для бизнеса "один-к-одному"
**Гибридная конфигурация в клиентской сети**

[![Потоки звонков в Microsoft Teams Online, рисунок 14](media/microsoft-teams-online-call-flows-figure14-thumbnail.png)](media/microsoft-teams-online-call-flows-figure14.png)

*Рисунок 14 — Гибридная работа в клиентской сети*
 
Передача сигналов между группами и Skype для бизнеса осуществляется мостом в Office 365. Однако мультимедиа передается напрямую между одноранговым элементом в сети клиента с помощью потока 5.

**Гибридная сеть клиентов с внешним пользователем Skype для бизнеса — ретранслируется с помощью Office 365**

[![Потоки звонков в Microsoft Teams Online, рис. 15](media/microsoft-teams-online-call-flows-figure15-thumbnail.png)](media/microsoft-teams-online-call-flows-figure15.png)

*Рисунок 15 — Гибридная сеть клиентов с внешним пользователем Skype для бизнеса — ретранслируется с помощью Office 365*

Обратите внимание, что:

- Передача сигналов и мультимедиа от клиента Skype для бизнеса на локальный сервер Skype для бизнеса не распространяется на этот документ. Однако это показано ниже для ясности.

- Передача сигналов между группами и Skype для бизнеса осуществляется мостом в Office 365.

- Мультимедиа ретранслируется с помощью транспортной ретрансляции Teams в Office 365 в клиентскую сеть с помощью потока 4.

**Гибридная сеть клиентов с внешним пользователем Skype для бизнеса – ретранслируется локальным краем**

[![Потоки звонков в Microsoft Teams Online, рисунок 16](media/microsoft-teams-online-call-flows-figure16-thumbnail.png)](media/microsoft-teams-online-call-flows-figure16.png)

*Рисунок 16-гибридной сети клиентов с внешним пользователем Skype для бизнеса, который ретранслируется локальным краем*
 
Обратите внимание, что:

- Передача сигналов и мультимедиа от клиента Skype для бизнеса на локальный сервер Skype для бизнеса не распространяется на этот документ. Однако это показано ниже для ясности.

- Передача сигналов моста осуществляется шлюзом в Office 365.

- Мультимедиа передается через Skype для бизнеса Media Relay в рамках Skype для бизнеса в локальной сети с помощью потока управления мультимедиа 5A.

### <a name="teams-with-phone-system-direct-routing-topology"></a>Teams с прямой топологией маршрутизации телефонной системы
Эта топология включает в себя группы с прямой маршрутизацией на телефонную систему. 

Прямая маршрутизация позволяет использовать стороннего поставщика услуг по коммутируемой телефонной сети (PSTN), применяя к Office 365 поддерживаемый локальный клиентский контроллер для связи (одноранговых границ), а затем подключаться к магистрали телефонной связи. Это устройство. 

Для поддержки этого сценария пользователь должен развернуть сертифицированный SBC-объект для прямой маршрутизации от одного из сертифицированных партнеров корпорации Майкрософт. Для этого необходимо настроить SBC как рекомендованный изготовителем, а также возможность маршрутизации из Office 365 для прямого UDP-трафика. Мультимедиа может перетекать прямо из Teams и (или) клиента Skype для бизнеса в SBC (минуя шлюз Teams) или пройти по шлюзу Teams. Связь с SBC, когда магистраль настроен для обхода шлюза Teams, основывается на ICE, где SBC поддерживает ICE-Lite, в то время как конечная точка командных носителей Teams/Skype для бизнеса Media поддерживает ICE Full. 

[![Потоки звонков в Microsoft Teams Online, рисунок 17](media/microsoft-teams-online-call-flows-figure17-thumbnail.png)](media/microsoft-teams-online-call-flows-figure17.png)

* Рисунок 17 — команды с прямой топологией маршрутизации телефонной системы

Обратите внимание, что:

- Направление стрелок на схеме выше отражает направление запуска связи, влияющей на подключение на периметрах предприятия. В случае использования UDP для мультимедиа первый пакет (-ов) может перетекать в обратном направлении, но эти пакеты могут блокироваться до тех пор, пока не будут передаваться пакеты в другом направлении.

- Teams разворачивается рядом с приложением Skype для бизнеса Online, поэтому клиенты выводятся как "Teams/SFB User".

Дополнительные потоки (в верхней части топологии Teams Online):
- **Flow 4 "** — представляет поток из Office 365 в клиентскую сеть, который используется для установления соединения между сервером мультимедиа Teams в облаке с помощью SBC в локальной среде.
- **Поток 5b** — представляет поток мультимедиа между пользователем Teams в сети клиента с помощью прямого перенаправления одноименного SBC-соединения в режиме пропуска.
- **Поток 5C** — представляет поток мультимедиа между прямыми одноадресным SBC, прямым маршрутом однонаправленного одноадресного соединения в режиме пропуска для КТСОП разворот.

**Внутренний пользователь с прямой маршрутизацией (ретрансляция мультимедиа с помощью транспорта Team Relay в Office 365)**

[![Потоки звонков в Microsoft Teams Online, рисунок 18](media/microsoft-teams-online-call-flows-figure18-thumbnail.png)](media/microsoft-teams-online-call-flows-figure18.png)

*Рисунок 18 — внутренний пользователь с прямой маршрутизацией (ретрансляция мультимедиа с помощью транспорта Team Relay в Office 365)*

Обратите внимание, что:
 
- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365.

- Передача сигналов и мультимедиа из SBC в Office 365 и наоборот используют поток 4 и (или) поток 4.

- Передача сигналов и мультимедиа от клиента в клиентской сети до Office 365 используйте поток 4.


**Удаленный пользователь с прямой маршрутизацией (носители передаются через сервер мультимедиа (MP) в Office 365)**

[![Потоки звонков в Microsoft Teams Online, рис. 19](media/microsoft-teams-online-call-flows-figure19-thumbnail.png)](media/microsoft-teams-online-call-flows-figure19.png)

*Рисунок 19 — удаленный пользователь с прямой маршрутизацией (носители передаются через сервер мультимедиа (MP) в Office 365)*
 
Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365.

- Передача сигналов и мультимедиа из SBC в Office 365 и наоборот используют поток 4 и (или) поток 4.

- Передача сигналов и мультимедиа от клиента в Интернете в Office 365 используйте поток 3.

**Внутренний пользователь Direct Routing (обход мультимедиа)**

[![Потоки звонков в Microsoft Teams Online, рисунок 20](media/microsoft-teams-online-call-flows-figure20-thumbnail.png)](media/microsoft-teams-online-call-flows-figure20.png)

*Рисунок 20 — внутренний пользователь Direct Routing (обход мультимедиа)*
 
Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365.

- Передача сигнала из SBC в Office 365 и наоборот используйте поток 4 и (или) поток 4.

- Передача сигнала от клиента в клиентской сети до Office 365 используйте поток 4.

- Мультимедиа от клиента в клиентской сети до SBC в потоке использования клиентской сети 5B.

**Удаленный пользователь с прямой маршрутизацией (обход пропускной рекламы с помощью транспортной ретрансляции для Team Relay в Office 365)**

[![Потоки звонков в Microsoft Teams Online, рисунок 21](media/microsoft-teams-online-call-flows-figure21-thumbnail.png)](media/microsoft-teams-online-call-flows-figure21.png)

*Рисунок 21 — удаленный пользователь с прямой маршрутизацией (обходной адрес мультимедиа с помощью транспорта Team Relay в Office 365)*

Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365 и Интернет.

- Передача сигнала из SBC в Office 365 и наоборот использует поток 4 и (или) поток 4.

- Передача сигнала от клиента в Интернете до Office 365 использует поток 3.

- Носители из клиента в Интернете на SBC в клиентской сети используют потоки 3 и 4, ретранслируемые с помощью транспорта Team Relay в Office 365. 

**Прямая маршрутизация удаленных пользователей (прямой обход мультимедиа)**

[![Потоки вызовов Microsoft Teams Online, рис. 22](media/microsoft-teams-online-call-flows-figure22-thumbnail.png)](media/microsoft-teams-online-call-flows-figure22.png)

*Рисунок 22 — прямая маршрутизация удаленных пользователей (прямой обход мультимедиа)*
 
Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365 и Интернета.

- Передача сигнала из SBC в Office 365 и наоборот использует поток 4 и (или) поток 4.

- Передача сигнала от клиента в Интернете до Office 365 использует поток 3.

- Носители из клиента в Интернете на SBC в сети клиента использует поток 2.

**Прямая маршрутизация (обход мультимедиа) – вызов PSTN разворот (из-за переадресации звонков)**

[![Потоки звонков в Microsoft Teams Online, рисунок 23](media/microsoft-teams-online-call-flows-figure23-thumbnail.png)](media/microsoft-teams-online-call-flows-figure23.png)

*Рисунок 23: прямая маршрутизация (обход мультимедиа)-вызов КТСОП разворот (из-за звонка переадресация/передача)*
 
Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365.

- Передача сигнала из SBC в Office 365 и наоборот использует поток 4 и (или) поток 4.

- У клиента нет сигнала и цикла мультимедиа, после того как звонок хаирпиннед от КТСОП к КТСОП.

- Мультимедиа от экземпляра SBC A в клиентской сети к экземпляру SBC B в клиентской сети (где, A и B — это один и тот же экземпляр) использует потоки 5C.

**Прямая маршрутизация (носители через Office 365) – PSTN разворот звоните между двумя клиентами**

[![Потоки звонков в Microsoft Teams Online, рисунок 24](media/microsoft-teams-online-call-flows-figure24-thumbnail.png)](media/microsoft-teams-online-call-flows-figure24.png)

*Рисунок 24-прямая маршрутизация (носители через Office 365) – PSTN разворот звоните между двумя клиентами*
 
Обратите внимание, что:

- SBC должен иметь общедоступный IP-адрес, который можно опубликовать из Office 365.

- Передача сигнала из SBC в Office 365 и наоборот использует поток 4 и (или) поток 4.

- У клиента нет сигнала и цикла мультимедиа, после того как звонок хаирпиннед от КТСОП к КТСОП.

- Носители из экземпляра SBC "A" в экземпляре клиента в однобайтовом режиме "B" должны передаваться через сервер Office 365 Media и не использовать режим пропуска.

## <a name="teams-with-express-route-optimization"></a>Группы с оптимизацией Экспресс – маршрута

[![Потоки звонков в Microsoft Teams Online, рисунок 25](media/microsoft-teams-online-call-flows-figure25-thumbnail.png)](media/microsoft-teams-online-call-flows-figure25.png)

*Рисунок 25 — команды с оптимизацией Экспресс-маршрута*
 
В случае, когда экспресс-маршрут выравниваются и разворачивается, потоки команд могут пересылаться из потока 4 в поток 1 и из потока 4 "в поток 1". Однако приложение Teams имеет жесткую зависимость в других приложениях Office 365 через Интернет с помощью потоков 4 и 4. Поэтому такие потоки не должны быть заблокированы. 

Обратите внимание на то, что трафик в гибридной границе Skype для бизнеса передается в Интернет, а не на то, чтобы выражать связь с внешними пользователями и выполнять Федерацию с другими клиентами. 

Чтобы предотвратить ассиметричные потоки, перенаправление должно быть в обоих направлениях. Другими словами, адрес в клиентской сети можно маршрутизировать как через Интернет, так и через экспресс-маршрут, основываясь на оптимизации, но не в обоих случаях.

Например:

**Клиентская сеть для внешних пользователей (носители ретранслируется транспортом Team Relay):**

[![Потоки звонков в Microsoft Teams Online, рисунок 26](media/microsoft-teams-online-call-flows-figure26-thumbnail.png)](media/microsoft-teams-online-call-flows-figure26.png)

*Рис. 26 — клиентская сеть для внешних пользователей (ретрансляция файлов мультимедиа с помощью транспорта Team Relay)*
 
**Шаги высокого уровня:**
1. Пользователи Teams в сети клиента выполняют разрешение доменного имени URL-адреса (DNS) через flow2
2. Пользователи Teams в сети клиента распределяют порт ретрансляции мультимедиа в Team Relay с помощью потока 1
3. Пользователь Teams в сети клиента отправляет сообщение "пригласить" с кандидатами ICE через процесс 1 в Office 365
4. OFFICE 365 отправляет уведомление внешнему пользователю Teams через поток 3
5. Внешний пользователь Teams выделит порт ретрансляции мультимедиа в Team Relay с помощью потока 3
6. Внешние пользователи Teams отправляют "Answer" с кандидатами ICE через поток 3, который пересылается назад в Teams с помощью потока 1
7. Пользователи Teams A и Teams B вызывают тесты подключения ICE и выбирают потоки 1 и 3, которые ретранслируется с помощью транспорта Team Relay в Office 365
8. Пользователи Teams отправляют телеметрию в Office 365 через потоки 1 и 3

>**Примечание**. поток 4 должен быть включен для поддержки зависимостей приложения Teams в других микрослужбах, которые определяют поток 4.
