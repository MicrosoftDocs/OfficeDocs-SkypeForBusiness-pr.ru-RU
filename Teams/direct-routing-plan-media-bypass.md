---
title: Планирование обхода сервера-посредника с прямой маршрутизацией
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.reviewer: NMuravlyannikov
ms.topic: article
ms.service:
- msteams
ms.prod: skype-for-business-itpro
localization_priority: Normal
search.appverid: MET150
ms.collection: Teams_ITAdmin_Help
appliesto:
- Microsoft Teams
description: В этой статье рассказывается, как запланировать обход мультимедиа с прямой маршрутизацией телефонной системы.
ms.openlocfilehash: c9a4a1c035afda7941f82018cc074293f338832d
ms.sourcegitcommit: 3197f3ffca2b2315be9fd0c702ccc8c87383c893
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2019
ms.locfileid: "35062357"
---
# <a name="plan-for-media-bypass-with-direct-routing"></a>Планирование обхода сервера-посредника с прямой маршрутизацией

## <a name="about-media-bypass-with-direct-routing"></a>Обход мультимедиа с прямой маршрутизацией

Обход мультимедиа позволяет сократить путь к мультимедийному трафику и уменьшить число прыжков на пути для повышения производительности. При обходе мультимедиа мультимедиа хранится между контроллером границ сеанса (SBC) и клиентом, а не отправкой через телефонную систему Microsoft. Чтобы настроить обход мультимедиа, SBC и клиент должны находиться в одном месте или в сети.

Вы можете управлять обходом мультимедиа для каждого SBC с помощью команды **Set-ксонлинепстнгатевай** с параметром **-медиабипасс** , для которого установлено значение true или false. Если включить обход мультимедиа, это не значит, что весь трафик мультимедиа останется в корпоративной сети. В этой статье описаны потоки звонков в разных сценариях.    

На приведенных ниже схемах показано различие в потоке звонков с обходом мультимедиа и без него.

При отсутствии пропуска мультимедиа, когда клиент выполняет или получает вызов, как на рисунке, так и на устройстве с интерфейсом SBC, в системе Microsoft Phone и клиенте Teams, как показано на приведенной ниже схеме.

![Показывает сигнализацию и поток мультимедиа без обхода мультимедиа](media/direct-routing-media-bypass-1.png)


Но предположим, что пользователь в той же сборке или сети, что и SBC. Например, предположим, что пользователь, который входит в состав здания в Франкфурт, осуществляет звонок пользователю PSTN: 

- **Без**обобщения мультимедиа мультимедиа будет перетекать через Амстердам или Дублин (там, где развернут центры обработки данных Майкрософт) и обратно на SBC в Франкфурт. 

  Центр обработки данных в Европе выбран, так как SBC находится в Европе, а Microsoft использует центр обработки данных, ближайший к SBC. Хотя этот подход не влияет на качество связи в связи с оптимизацией потока трафика в сетях Microsoft в большинстве географических регионов, трафик имеет ненужное зацикливание.     

- **При обходе мультимедиа**мультимедиа сохраняется непосредственно между пользователем Teams и SBC, как показано на рисунке ниже.

![Показывает сигнализацию и поток мультимедиа с обходом мультимедиа](media/direct-routing-media-bypass-2.png)

Обход мультимедиа использует протоколы, называемые интерактивным подключением (ICE) в клиенте Teams, и Lite на SBC. Эти протоколы обеспечивают прямую маршрутизацию для использования наиболее подходящих путей к мультимедиа для оптимального качества. ICE и ICE Lite — это Вебртк стандарты. Подробные сведения об этих протоколах можно найти в RFC 5245.


## <a name="call-flow-and-firewall-planning"></a>Потоки звонков и планирование брандмауэра

Потоки звонков и планирование в брандмауэре зависят от того, есть ли у пользователя прямой доступ к общедоступному IP-адресу объекта SBC, а также от того, входит ли пользователь в сеть или за ее пределы.

### <a name="call-flow-if-the-user-has-direct-access-to-the-public-ip-address-of-the-sbc"></a>Поток звонков, если пользователь имеет прямой доступ к общедоступному IP-адресу объекта SBC

Если у пользователя есть прямой доступ к общедоступному IP-адресу объекта SBC, поток вызова выглядит следующим образом:

- Для обхода мультимедиа клиент Teams должен иметь доступ к общедоступному IP-адресу SBC, даже из внутренней сети. Если прямое мультимедиа не требуется, мультимедиа может перетекать через реле транспорта.

- Это рекомендуемое решение, если пользователь в той же сборке и (или) сети, что и SBC — удаление облачных компонентов Microsoft из пути к носителю.

- Передача сигналов всегда проходит через Microsoft Cloud.

На приведенной ниже схеме показан поток звонков, когда включена поддержка мультимедиа, клиент является внутренним, а клиент может получить доступ к публичному IP-адресу SBC (Direct Media): 

- Стрелки и числовые значения пути в соответствии со статьей [потоки вызовов Microsoft Teams](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows) .

- Сигнал SIP всегда принимает пути 4 и 4 (в зависимости от направления трафика). Мультимедиа останется на локальном компьютере, и его путь — 5b.

![Показывает поток звонков с включенным пропуском мультимедиа, клиент является внутренним](media/direct-routing-media-bypass-3.png)


### <a name="call-flow-if-the-user-does-not-have-access-to-the-public-ip-address-of-the-sbc"></a>Поток звонков, если пользователь не имеет доступа к общедоступному IP-адресу SBC

Ниже приведено описание потока вызова, если пользователь не имеет доступа к общедоступному IP-адресу SBC. 

Например, предположим, что пользователь является внешним, а администратор клиента решил не открывать общедоступный IP-адрес SBC для всех пользователей в Интернете, но только в Microsoft Cloud. Внутренние компоненты трафика могут перетекать через реле транспорта Teams. Это рекомендуемая конфигурация для пользователей за пределами корпоративной сети. Рассмотрим следующее:

- Используются реле транспорта Teams.

- Для обхода мультимедиа Корпорация Майкрософт использует версию реле транспорта, для которой требуется открыть порты 50 000 для 59 999 между ретранслятором транспорта групп и SBC (в будущем мы планируем переход на версию, для которой требуется только 3478 и 3479).

- Для целей оптимизации мультимедиа Корпорация Майкрософт рекомендует открывать общедоступный IP-адрес SBC только для ретрансляции транспорта Teams. Для клиентов за пределами корпоративной сети Корпорация Майкрософт рекомендует использовать реле транспорта вместо того, чтобы обращаться к публичному IP-адресу SBC напрямую.

На приведенной ниже схеме показан поток вызова, если включен обход мультимедиа, клиент является внешним, а клиент не может связаться с общедоступным IP-адресом контроллера границ сеанса (поток ретранслируется транспортом транспорта Team Relay).

- Стрелки и числовые значения пути в соответствии со статьей [потоки вызовов Microsoft Teams](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows) .

- Мультимедиа ретранслируется с помощью путей 3, 3, 4 и 4.

![Показывает поток вызова, если пользователь не имеет доступа к общедоступному IP-адресу объекта SBC](media/direct-routing-media-bypass-4.png)


### <a name="call-flow-if-a-user-is-outside-the-network-and-has-access-to-the-public-ip-of-the-sbc"></a>Поток звонков, если пользователь находится за пределами сети и имеет доступ к общедоступному IP-адресу SBC

> [!NOTE]
> Это не рекомендуемая конфигурация, так как она не использует возможности ретрансляции транспорта для Teams. Вместо этого следует рассмотреть предыдущий сценарий, в котором у пользователя нет доступа к общедоступному IP-адресу SBC. 

На приведенной ниже схеме показан поток звонков, если включен обход мультимедиа, клиент является внешним, а клиент может получить доступ к общевидимому IP-адресу SBC (Direct Media).

- Стрелки и числовые значения пути в соответствии со статьей [потоки вызовов Microsoft Teams](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows) .

- Сигнал SIP всегда принимает пути 3 и 3 (в зависимости от направления трафика). Потоки мультимедиа, использующие путь 2.

![Показывает поток вызова, если пользователь не имеет доступа к общедоступному IP-адресу объекта SBC](media/direct-routing-media-bypass-5.png)


## <a name="use-of-media-processors-and-transport-relays"></a>Использование мультимедийных процессоров и реле транспортировки

В облаке Microsoft есть два компонента, которые могут находиться в пути к мультимедийному трафику: процессоры мультимедиа и реле транспорта. 

- Процессор мультимедиа — это общедоступный компонент, который обрабатывает мультимедиа в необходных случаях и обрабатывает носители для голосовых приложений.

   Обработчики мультимедиа всегда находятся в пути для вызовов конечных пользователей, но никогда не в пути к пропускным звонкам. Процессоры мультимедиа всегда находятся в пути для всех голосовых приложений, таких как приостановка звонков, автоматический секретарь Организации и очереди звонков.

- Транспортный ретранслятор используется для подключения к ближайшей транспортной службе для отправки трафика в реальном времени.

   Ретрансляция транспорта может быть или не включена в путь для конечных вызовов, в зависимости от того, где находится пользователь и как настроена сеть.

На приведенной ниже схеме показаны два потока звонков — один с включенным пропуском мультимедиа, а второй — без отключения мультимедиа. Обратите внимание, что схема показывает только трафик, направленный от конечных пользователей.  
- Контроллер мультимедиа — это микрослужба в Azure, которая назначает мультимедийные процессоры и создает предлагаемые протоколы описания сеансов (SDP).

- Прокси-сервер SIP — компонент, который преобразует сигналы HTTP RESTFUL, используемые в Teams, в SIP.    

![Показывает потоки звонков с включенным и отключенным пропуском мультимедиа](media/direct-routing-media-bypass-6.png)


В приведенной ниже таблице показано различие между процессорами мультимедиа и реле транспорта.

|    | Процессоры мультимедиа | Реле транспорта|
| :--------------|:---------------|:------------|
В пути к носителю для пользователей, не пропускаемых за пределами Skype | Любой | Висеть | 
В пути к носителю для конечных пользователей | Висеть | Если клиент не может связаться с SBC на общедоступном IP-адресе | 
В пути к файлам мультимедиа для голосовых приложений | Любой | Висеть | 
Возможность перекодирования (B2BUA)\* | Да | Нет, ретрансляция звука между конечными точками | 
Количество экземпляров по всему миру и расположению | 8, всего: 2 в США и Западная; 2 в Амстердам и Дублин; 2 в Гонконг и Сингапур; 2 в Японии (добавляется в Q1CY2019)  | Сервер

Диапазон IP-адресов — 52.112.0.0/14 (IP-адреса из 52.112.0.1 в 52.115.255.254). 

\*Описание перекодирования: 

- Процессор мультимедиа — B2BUA, то есть он может изменить кодеки (например, SILK из клиента Teams на MP и G. 711 между MP и SBC).

- Реле транспорта не B2BUA, что означает, что кодек никогда не изменится между клиентом и SBC, даже если трафик проходит через реле.

### <a name="use-of-teams-transport-relays-in-escalation-scenarios-if-trunk-is-configured-for-media-bypass"></a>Использование ретрансляции транспорта групп в сценариях расширения, если магистраль настроен для обхода мультимедиа

Реле транспорта Teams всегда находятся в пути к носителю в следующих сценариях:

- Звонок эскалируется от 1:1 до группового звонка
- Звонок пользователю федеративных групп
- Звонок пересылается или передается пользователю Skype для бизнеса

Убедитесь в том, что SBC имеет доступ к ретрансляции транспорта, как описано ниже.    


## <a name="sip-signaling-fqdns-and-firewall-ports"></a>Сигнализация SIP: полные доменные имена и порты брандмауэра

Для сигнализации SIP требования к полному доменному имени и требованиям брандмауэра одинаковы для случаев, когда не используются другие варианты. 

Для прямой маршрутизации используются следующие три полных доменных имен:

- **SIP.pstnhub.Microsoft.com** — глобальное полное доменное имя — необходимо попытаться сначала. Когда SBC отправляет запрос для разрешения этого имени, DNS-серверы Microsoft Azure возвращают IP-адрес, указывающий на основной центр обработки данных Azure, назначенный для SBC. Назначение основывается на метриках производительности центров обработки данных и географических расположений, близких к SBC. Возвращенный IP-адрес соответствует основному доменному имени.

- **sip2.pstnhub.Microsoft.com** — дополнительное полное доменное имя — географически сопоставляется со вторым регионом приоритета.

- **SIP3.pstnhub.Microsoft.com** — ТРЕТИЧНОЕ полное доменное имя — географически сопоставляется с третьим регионом приоритета.

Эти три полных доменных имен необходимо разместить в указанных ниже целях.

- Обеспечьте оптимальную работу (менее загруженные и близкие к центру обработки данных, назначенному с помощью запроса первого полного доменного имени).

- Отработка отказа при установке соединения из SBC с помощью центра обработки данных, на котором возникла временная проблема. Дополнительные сведения можно найти в разделе механизм отработки отказа ниже.


Полные доменные имена **SIP.pstnhub.Microsoft.com**, **sip2.pstnhub.Microsoft.com**и **SIP3.pstnhub.Microsoft.com** будут разрешены на один из указанных ниже IP-адресов.
- 52.114.148.0
- 52.114.132.46
- 52.114.75.24
- 52.114.76.76
- 52.114.7.24
- 52.114.14.70

Чтобы разрешить входящий и исходящий трафик для отправки сигналов, вам нужно будет открыть порты для всех этих IP-адресов в брандмауэре. Если брандмауэр поддерживает DNS-имена, полное доменное имя **SIP-ALL.pstnhub.Microsoft.com** разрешается всем указанным выше IP-адресам. Необходимо использовать следующие порты:

| Дорож | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
SIP/TLS| Прокси-сервер SIP | БАЙТОВ | 1024-65535 | Определено для SBC |
| SIP/TLS | БАЙТОВ | Прокси-сервер SIP | Определено для SBC | 5061 |


## <a name="media-traffic-ip-and-port-ranges"></a>Трафик мультимедиа: IP-адреса и диапазоны портов

Трафик мультимедиа между SBC и клиентом Teams, если он доступен, или посредством ретрансляции транспорта группы, если клиент не может достичь SBC с помощью общедоступного IP-адреса.

### <a name="requirements-for-direct-media-traffic-between-the-teams-client-and-the-sbc"></a>Требования к прямому трафику мультимедиа (между клиентом Teams и SBC) 

Клиент должен иметь доступ к указанным портам (см. таблицу) на общедоступном IP-адресе SBC. 

Примечание. Если клиент находится во внутренней сети, он перетекает на общедоступный IP-адрес SBC. Вы можете настроить хаирпиннинг на устройстве NAT таким образом, чтобы трафик ни на что не покидает корпоративное сетевое оборудование.

| Дорож | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Клиент | БАЙТОВ | 50 000 – 50 019  | Определено для SBC |
| UDP/SRTP | БАЙТОВ | Клиент | Определено для SBC | 50 000 – 50 019  |


Примечание. Если у вас есть сетевое устройство, преобразующее исходные порты клиента, убедитесь, что переведенные порты открыты между сетевым оборудованием и SBC. 

### <a name="requirements-for-using-transport-relays"></a>Требования для использования ретрансляции транспорта

Транспортные ретрансляции находятся в том же диапазоне, что и процессоры мультимедиа (для необходных случаев): 52.112.0.0/14 (IP-адреса из 52.112.0.1 в 52.115.255.254).

Диапазон портов для реле транспорта Teams показан в таблице ниже.


| Дорож | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Транспортные ретрансляции | БАЙТОВ | 50 000-59 999    | Определено для SBC |
| UDP/SRTP | БАЙТОВ | Транспортные ретрансляции | Определено для SBC | 50 000 – 59 999, 3478, 3479     |


Примечание. Корпорация Microsoft рекомендует по крайней мере два порта для одновременных звонков на SBC. Так как корпорация Майкрософт использует две версии реле транспорта, необходимо выполнить указанные ниже действия.

- V4, которая может работать только с диапазоном портов 50 000 – 59 999

- V6, которые работают с портами 3478, 3479

В настоящее время обход мультимедиа поддерживает только версию v4 для реле транспорта. Мы будем поддерживать версию V6 в будущем. 

Для перехода вам нужно открыть порты 3478 и 3479. Если корпорация Майкрософт предоставляет поддержку для ретрансляции протокола V6 с пропуском мультимедиа, вам не нужно будет перенастраивать сетевое оборудование или SBCs. 

### <a name="requirements-for-using-media-processors"></a>Требования для использования процессоров мультимедиа

Процессоры мультимедиа всегда находятся в пути к файлам мультимедиа для голосовых приложений. Требования те же, что и для конфигурации без обхода.


IP-адрес для мультимедийного трафика — 52.112.0.0/14 (IP-адреса из 52.112.0.1 в 52.115.255.254).

Диапазон портов для процессоров мультимедиа приведен в таблице ниже.

| Дорож | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Процессор мультимедиа | БАЙТОВ | 49 152 – 53 247    | Определено для SBC |
| UDP/SRTP | БАЙТОВ | Процессор мультимедиа | Определено для SBC | 49 152 – 53 247     |

## <a name="considerations-if-you-have-skype-for-business-phones-in-your-network"></a>Что нужно знать, если у вас есть телефоны Skype для бизнеса в сети  

Если у вас есть конечные точки Skype для бизнеса в сети, в которой используется прямая маршрутизация (например, у пользователя Teams может быть телефон 3PIP, основанный на клиенте Skype для бизнеса) — обход мультимедиа на магистральной магистрали, которая служит для отключения этих пользователей, должна быть отключена.

Вы можете создать отдельную магистральную систему для этих пользователей и назначить ей политику сетевой голосовой маршрутизации.

Этапы настройки высокого уровня:

- Разделение пользователей по типу — в зависимости от того, есть ли у пользователя телефон 3PIP или нет.

- Создайте два канала для разных полных доменных имен: один включен для обхода мультимедиа. другой not. 

  Оба канала указывают на один и тот же SBC. Сигналы порта для TLS SIP должны быть разными. Порты для мультимедиа должны быть одинаковыми.

- Назначьте правильный магистрали в зависимости от типа пользователя в политике голосовой маршрутизации в сети.

В примере ниже показана эта логика.

| Набор пользователей | Количество пользователей | Полные доменные имена для магистрали, назначенные в ОВРП | Обход мультимедиа включен |
| :------------ |:----------------- |:--------------|:--------------|
Пользователи с клиентами Teams и 3PIPными телефонами | средняя | sbc1.contoso.com:5061 | false | 
Пользователи, у которых есть только конечные точки групп (в том числе новые телефоны, сертифицированные для Teams) | 980 | sbc2.contoso.com:5060 | true

Обе магистральные линии могут указывать на один и тот же SBC с одинаковым общим IP-адресом. Порты TLS-сигналов на SBC должны отличаться, как показано на следующей схеме. Примечание. необходимо убедиться, что ваш сертификат поддерживает обе магистральные линии. В сети SAN необходимо иметь два имени (**sbc1.contoso.com** и **sbc2.contoso.com**) или использовать подстановочный сертификат.


![Обе магистральные линии могут указывать на один и тот же SBC с одинаковым общим IP-адресом.](media/direct-routing-media-bypass-7.png)

Сведения о том, как настроить две магистральные линии на одном SBC, можно найти в документации, предоставленной вашим поставщиком SBC.

- AudioCodes
- Вариантов
- Системы TE (Аниноде)   

## <a name="client-endpoints-supported-with-media-bypass"></a>Конечные точки клиента, поддерживаемые при обходе мультимедиа

Обход мультимедиа поддерживается всеми конечными точками групп, кроме веб-клиентов Teams, пока не будет указано дальнейшее уведомление. 

Если вы предпочитаете использовать веб-приложение Teams в Microsoft EDGE, Google Chrome или Mozilla Firefox, для таких пользователей необходимо отключить функцию "мультимедиа". В будущем мы поможем вам позвонить, используя магистральную подсеть с поддержкой мультимедиа.   
 
## <a name="see-also"></a>См. также

[Настройка обхода сервера-посредника с прямой маршрутизацией](direct-routing-configure-media-bypass.md)



