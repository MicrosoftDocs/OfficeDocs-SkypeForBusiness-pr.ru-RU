---
title: Планирование обхода сервера-посредника с прямой маршрутизацией
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.reviewer: NMuravlyannikov
ms.topic: article
ms.service: msteams
localization_priority: Normal
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Узнайте, как спланировать обход мультимедиа с помощью прямой маршрутии телефонной системы, которая позволяет сократить путь к трафику мультимедиа и повысить производительность.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: e21007c31dca540e4f659aad627911b4aec2e456
ms.sourcegitcommit: d62e6cefceebe481eb207c59872f1aa67f0fc528
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/05/2021
ms.locfileid: "50460869"
---
# <a name="plan-for-media-bypass-with-direct-routing"></a>Планирование обхода сервера-посредника с прямой маршрутизацией

## <a name="about-media-bypass-with-direct-routing"></a>Обход мультимедиа с прямой маршрутией

Обход мультимедиа позволяет сократить путь трафика мультимедиа и сократить количество переходов для улучшения производительности. При обходе мультимедиа между контроллером границы сеанса (SBC) и клиентом хранятся мультимедиа, а не через телефонную систему Майкрософт. Чтобы настроить обход мультимедиа, SBC и клиент должны быть в одном расположении или в одной сети.

Вы можете настроить обход мультимедиа для каждого SBC с помощью команды **Set-CSOnlinePSTNGateway,** для параметра **-MediaBypass** задано true или false. Если включить обход мультимедиа, это не означает, что весь трафик мультимедиа будет оставаться в корпоративной сети. В этой статье описан поток зовов в разных сценариях.    

На рисунках ниже показано, чем отличается поток вызовов как с обходом мультимедиа, так и без него.

Без обхода мультимедиа, когда клиент совершает или принимает звонок, сигнальный и поток мультимедиа между SBC, телефонной системой Майкрософт и клиентом Teams, как показано на следующей схеме:

> [!div class="mx-imgBorder"]
> ![Сигнальный поток и поток мультимедиа без обхода мультимедиа](media/direct-routing-media-bypass-1.png)


Однако предположим, что пользователь находится в том же здании или в сети, что и УАЦ. Предположим, например, что пользователь, который находится в здании в Москве, звонит пользователю ННР: 

- **Без обхода** мультимедиа мультимедиа будут переходить через Дублин или Майкрософт (в которых развернуты центра обработки данных Майкрософт) и обратно в SBC в Это. 

  Центр обработки данных в Европе выбран, так как он находится в Европе, а корпорация Майкрософт использует ближайший к нему центр. Хотя этот подход не влияет на качество зовов из-за оптимизации потока трафика в сетях Майкрософт в большинстве географических регионах, он имеет ненужный цикл.     

- **При обходе** мультимедиа хранятся непосредственно между пользователем Teams и SBC, как показано на следующей схеме:

  > [!div class="mx-imgBorder"]
  > ![Сигнальный поток и поток мультимедиа с обходом мультимедиа](media/direct-routing-media-bypass-2.png)

Обход мультимедиа использует протоколы под названием Interactive Connectivity Вуальд (ICE) на клиенте Teams и ICE lite на SBC. Эти протоколы обеспечивают прямую маршрутику, чтобы использовать самый прямой путь к мультимедиа для обеспечения оптимального качества. ICE и ICE Lite — это стандарты WebRTC. Подробные сведения об этих протоколах см. в RFC 5245.


## <a name="call-flow-and-firewall-planning"></a>Планирование потока вызовов и брандмауэра

Планирование потока присоединения к звонкам и брандмауэра зависит от того, имеет ли пользователь прямой доступ к общедоступным IP-адресам SBC и находится ли пользователь внутри сети или за ее пределами.

### <a name="call-flow-if-the-user-has-direct-access-to-the-public-ip-address-of-the-sbc"></a>Поток присоединения к звонкам, если у пользователя есть прямой доступ к общедоступным IP-адресам SBC

Если у пользователя есть прямой доступ к общедоступным IP-адресу SBC, поток присоединения будет следующим:

- Для обхода мультимедиа клиент Teams должен иметь доступ к общедоступным IP-адресам SBC даже из внутренней сети. Если прямая мультимедиа не требуется, они могут передаются через ретрансляторы транспорта.

- Это рекомендуемое решение, если пользователь находится в том же здании или сети, что и SBC, и удалить компоненты Microsoft Cloud из пути мультимедиа.

- Сигнальный сигнал всегда проходит через облако Майкрософт.

На следующей схеме показан поток зовов, когда включен обход мультимедиа, клиент является внутренним, а клиент может связаться с общедоступным IP-адресом SBC (прямой мультимедиа): 

- Стрелки и числимые значения путей соответствуют потокам вызовов [Microsoft Teams.](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)

- Сигнальный трафик SIP всегда проходит по путям 4 и 4' (в зависимости от направления трафика). Media stays local and takes path 5b.

> [!div class="mx-imgBorder"]
> ![Отображает поток вызовов с включенным обходом мультимедиа, клиент внутренний](media/direct-routing-media-bypass-3.png)


### <a name="call-flow-if-the-user-does-not-have-access-to-the-public-ip-address-of-the-sbc"></a>Поток вызовов, если у пользователя нет доступа к общедоступным IP-адресу SBC

Ниже описан поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресу SBC. 

Предположим, пользователь является внешним, и администратор клиента решил не открывать общедоступный IP-адрес SBC для всех пользователей в Интернете, а только для Microsoft Cloud. Внутренние компоненты трафика могут перетекать через ретрансляторы транспорта Teams. Примите во внимание следующее:

- Используются ретрансляторы транспорта Teams.

- Для обхода мультимедиа Майкрософт использует версию ретрансляторов транспорта, которая требует открытия портов от 50 000 до 59 999 между ретрансляторами транспорта Teams и SBC (в будущем мы планируем перейти на версию, которая требует только 3478 и 3479 портов).


На следующей схеме показан поток зовов, когда включен обход мультимедиа, клиент является внешним и клиент не может связаться с общедоступным IP-адресом граничного контроллера сеанса (мультимедиа ретранслются ретранслятором транспорта Teams).

- Стрелки и числимые значения путей соответствуют потокам вызовов [Microsoft Teams.](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)

- Media is relayed through paths 3, 3', 4 and 4'

> [!div class="mx-imgBorder"]
> ![Отображает поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC](media/direct-routing-media-bypass-4.png)


### <a name="call-flow-if-a-user-is-outside-the-network-and-has-access-to-the-public-ip-of-the-sbc"></a>Поток вызовов, если пользователь находится за пределами сети и имеет доступ к общедоступным IP-адресам SBC

> [!NOTE]
> Такая конфигурация не рекомендуется, так как она не имеет преимуществ в ретрансляторах транспорта Teams. Вместо этого следует рассмотреть предыдущий сценарий, в котором у пользователя нет доступа к общедоступным IP-адресу SBC. 

На следующей схеме показан поток зовов, когда включен обход мультимедиа, клиент является внешним, а клиент может связаться с общедоступным IP-адресом SBC (прямой мультимедиа).

- Стрелки и числические значения путей соответствуют статье о потоках вызова [Microsoft Teams.](https://docs.microsoft.com/microsoftteams/microsoft-teams-online-call-flows)

- Сигнальный трафик SIP всегда проходит по путям 3 и 3' (в зависимости от направления трафика). Потоки мультимедиа, использующие путь 2.

> [!div class="mx-imgBorder"]
> ![Отображает поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC](media/direct-routing-media-bypass-5.png)


## <a name="use-of-media-processors-and-transport-relays"></a>Использование процессоров мультимедиа и ретрансляторов транспорта

В Microsoft Cloud есть два компонента, которые могут быть на пути трафика мультимедиа: процессоры мультимедиа и ретрансляторы транспорта. 

- Процессор мультимедиа — это общедоступный компонент, который обрабатывает мультимедиа в случаях без обхода и обрабатывает мультимедиа для голосовых приложений.

   Процессоры мультимедиа всегда находятся в пути для конечных пользователей, но никогда не находятся в пути для обходных звонков. Процессоры мультимедиа всегда находятся на пути для всех голосовых приложений, таких как "Парк вызовов", "Автосекретарь организации" и "Очереди вызовов".

- Ретранслятор транспорта используется для подключения к ближайшей службе транспорта для отправки трафика в режиме реального времени.

   В зависимости от того, где находится пользователь и как настроена сеть, ретрансляторы транспорта могут не оказаться в пути для обходных звонков: от пользователей или от их маршрутов до конечных пользователей.

На следующей схеме показаны два потока зовов: один с включенным обходом мультимедиа, а второй с отключенным обходом мультимедиа. Обратите внимание на то, что схема только иллюстрирует трафик, направляющийся с конечных пользователей или направляющийся в него.  
- Контроллер мультимедиа — это микрослужба в Azure, которая назначает процессоры мультимедиа и создает предложения протокола SDP.

- Прокси-сервер SIP — это компонент, который преобразует сигнал HTTP REST, используемый в Teams, в SIP.    

> [!div class="mx-imgBorder"]
> ![Потоки вызовов с включенным и отключенным обходом мультимедиа](media/direct-routing-media-bypass-6.png)


В таблице ниже общалась разница между процессорами мультимедиа и ретрансляторами транспорта.

|    | Процессоры мультимедиа | Ретрансляторы транспорта|
| :--------------|:---------------|:------------|
In media path for non-bypassed calls for end users | Всегда | Если клиенту не удается напрямую связаться с медиапереработчиком | 
В пути мультимедиа для обойденных звонков для конечных пользователей | Никогда | Если клиенту не удается связаться с SBC по общедоступным IP-адресу | 
В пути мультимедиа для голосовых приложений | Всегда | Никогда | 
Может делать транскодинг (B2BUA)\* | Да | Нет, только ретрансляции звука между конечными точками | 
Количество экземпляров по всему миру и его местонахождение | 10 итогов: 2 в восточной и западной части США; 2 в Ирландии и Дублине; 2 в Гонконге и Сингапуре; 2 в Японии; 2 в Восточной и Юго-Восточной Австралии | Несколько

Диапазоны IP-адресов:
- 52.112.0.0/14 (IP-адреса от 52.112.0.1 до 52.115.255.254)
- 52.120.0.0/14 (IP-адреса от 52.120.0.1 до 52.123.255.254)

\* Объяснение транскодинга: 

- Процессор мультимедиа — это B2BUA, то есть он может изменить кодеки (например, SILK из клиента Teams в MP и G.711 между MP и SBC).

- Ретрансляторы транспорта не являются B2BUA, то есть кодек никогда не меняется между клиентом и SBC, даже если трафик передается через ретрансляции.

### <a name="use-of-teams-media-processors-if-trunk-is-configured-for-media-bypass"></a>Использование процессоров мультимедиа Teams, если для настройки обхода мультимедиа настроена возможность обхода мультимедиа

Процессоры мультимедиа Teams всегда вставляются в медиапереклады в следующих сценариях:

- Звонок перенается из 1:1 в групповой звонок
- Звонок идет федераированному пользователю Teams
- Переадправление или переадправление звонка пользователю Skype для бизнеса

Убедитесь, что у вашего SBC есть доступ к процессорам мультимедиа и диапазонам ретрансляторов транспорта, как описано ниже.    


## <a name="sip-signaling-fqdns"></a>Сигнальный SIP: FQDNs

Для сигнального сигнала SIP требования к FQDN и брандмауэру одинаковы для случаев, не в которые они обходить. 

Прямая маршрутия предоставляется в следующих средах Microsoft 365 или Office 365:
- Microsoft 365 или Office 365
- Office 365 GCC
- Office 365 GCC High
- Office 365 DoD Подробнее об средах [Office 365](https://docs.microsoft.com/office365/servicedescriptions/office-365-platform-service-description/office-365-us-government/office-365-us-government) и государственных органов США, таких как GCC, GCC High и DoD.

### <a name="microsoft-365-office-365-and-office-365-gcc-environments"></a>Среды Microsoft 365, Office 365 и GCC Office 365

Ниже точки соединения для прямой маршрутии имеют следующие три FQDNs:

- **sip.pstnhub.microsoft.com** — глобальное FQDN — необходимо сначала опробовоть. Когда SBC отправляет запрос на устранение этого имени, DNS-серверы Microsoft Azure возвращают IP-адрес, указывающий на основной центр обработки данных Azure, который назначен SBC. Назначение основано на метриках производительности центра обработки данных и географической близости к SBC. Возвращаемый IP-адрес соответствует основному FQDN.

- **sip2.pstnhub.microsoft.com** — дополнительное FQDN — географически сопоставить со вторым приоритетом регион.

- **sip3.pstnhub.microsoft.com** — многоядерное FQDN — географически сопоставить с третьим приоритетом регион.

Эти три FQDNs необходимо разместить, чтобы:

- Обеспечение оптимальной работы (менее загружена и ближе всего к центру обработки данных SBC, назначенного с помощью запроса первого FQDN).

- Отбой в случае подключения с SBC к центру обработки данных, который имеет временную проблему. Дополнительные сведения см. ниже в механизме failover.


FQDNs sip.pstnhub.microsoft.com, **sip2.pstnhub.microsoft.com** **и** sip3.pstnhub.microsoft.com будут устранены на одном из следующих IP-адресов: 
- 52.114.148.0
- 52.114.132.46
- 52.114.16.74
- 52.114.20.29
- 52.114.75.24
- 52.114.76.76
- 52.114.7.24
- 52.114.14.70

Необходимо открыть порты для всех ЭТИХ IP-адресов в брандмауэре, чтобы разрешить входящие и исходяющие трафик до адресов и с них для сигнального трафика. Если брандмауэр поддерживает имена DNS,  имя FQDN sip-all.pstnhub.microsoft.com на все эти IP-адреса. 

### <a name="office-365-gcc-dod-environment"></a>Среда DoD "GCC" в Office 365

Точка соединения для прямой маршрутки имеет следующий FQDN:

**sip.pstnhub.dod.teams.microsoft.us** — глобальное FQDN. Так как среда DoD Office 365 существует только в центрах обработки данных в США, дополнительные и триадные FQDNs не существует.

FQDNs — sip.pstnhub.dod.teams.microsoft.us будут разрешены на один из следующих IP-адресов:

- 52.127.64.33
- 52.127.68.34

Необходимо открыть порты для всех ЭТИХ IP-адресов в брандмауэре, чтобы разрешить входящие и исходяющие трафик до адресов и с них для сигнального трафика.  Если брандмауэр поддерживает имена DNS, доменные sip.pstnhub.dod.teams.microsoft.us будут разрешать их все IP-адреса. 

### <a name="office-365-gcc-high-environment"></a>Среда Office 365 GCC High

Точка соединения для прямой маршрутки имеет следующий FQDN:

**sip.pstnhub.gov.teams.microsoft.us** — глобальное FQDN. Так как среда GCC High существует только в центрах обработки данных в США, дополнительные и дополнительные FQDNs не существуют.

FQDNs — sip.pstnhub.gov.teams.microsoft.us будут разрешены на один из следующих IP-адресов:

- 52.127.88.59
- 52.127.92.64

Необходимо открыть порты для всех ЭТИХ IP-адресов в брандмауэре, чтобы разрешить входящие и исходяющие трафик до адресов и с них для сигнального трафика.  Если брандмауэр поддерживает имена DNS, доменная sip.pstnhub.gov.teams.microsoft.us со всеми этими IP-адресами. 

## <a name="sip-signaling-ports"></a>Сигнальный SIP: порты

Требования к переносу одинаковы для всех сред Office 365, в которых предлагается прямая маршрутия:
- Microsoft 365 или Office 365
- Office 365 GCC
- Office 365 GCC High
- Office 365 DoD

Необходимо использовать следующие порты:

| Трафик | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
SIP/TLS| Прокси-сервер SIP | SBC | 1024 - 65535 | Определяется в SBC |
| SIP/TLS | SBC | Прокси-сервер SIP | Определяется в SBC | 5061 |


## <a name="media-traffic-ip-and-port-ranges"></a>Трафик мультимедиа: диапазоны IP-адресов и портов

Трафик мультимедиа передается между клиентом SBC и Teams, если доступно прямое подключение, или через ретрансляторы транспорта Teams, если клиент не может связаться с SBC, используя общедоступный IP-адрес.

### <a name="requirements-for-direct-media-traffic-between-the-teams-client-and-the-sbc"></a>Требования для прямого трафика мультимедиа (между клиентом Teams и SBC) 

У клиента должен быть доступ к указанным портам (см. таблицу) на общедоступный IP-адрес SBC. 

Примечание. Если клиент находится во внутренней сети, потоки мультимедиа перетекают в общедоступный IP-адрес SBC. Вы можете настроить закрепление ветвей на устройстве NAT, чтобы трафик никогда не покидает оборудование корпоративной сети.

| Трафик | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Клиент | SBC | 50 000 – 50 019  | Определяется в SBC |
| UDP/SRTP | SBC | Клиент | Определяется в SBC | 50 000 – 50 019  |


> [!NOTE]
> Если у вас есть сетевое устройство, которое преобразует исходные порты клиента, убедитесь, что открыты переведенные порты между сетевым оборудованием и SBC. 

### <a name="requirements-for-using-transport-relays"></a>Требования для использования ретрансляторов транспорта

Ретрансляторы транспорта находятся в том же диапазоне, что и процессоры мультимедиа (для случаев без обхода): 

### <a name="microsoft-365-office-365-and-office-365-gcc-environments"></a>Среды Microsoft 365, Office 365 и GCC Office 365

- 52.112.0.0 /14 (IP-адреса от 52.112.0.1 до 52.115.255.254)

## <a name="office-365-gcc-dod-environment"></a>Среда DoD "GCC" в Office 365

- 52.127.64.0/21

### <a name="office-365-gcc-high-environment"></a>Среда Office 365 GCC High

- 52.127.88.0/21


Диапазон портов ретрансляторов транспорта Teams (применимо для всех сред) показан в таблице ниже.


| Трафик | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Transport Relay | SBC | 50 000 -59 999    | Определяется в SBC |
| UDP/SRTP | SBC | Transport Relay | Определяется в SBC | 50 000 – 59 999, 3478, 3479     |


> [!NOTE]
> Корпорация Майкрософт рекомендует по крайней мере два порта для одного одновременного звонка на SBC. Так как у корпорации Майкрософт есть две версии ретрансляторов транспорта, требуются следующие:
> 
> - V4, который может работать только с портом от 50 000 до 59 999
> 
> - v6, который работает с портами 3478, 3479

В настоящее время обход мультимедиа поддерживает только 4-ю версию ретрансляторов транспорта. В будущем мы введем поддержку v6. 

Для перехода необходимо открыть порты 3478 и 3479. Если корпорация Майкрософт введет поддержку ретрансляторов транспорта v6 с помощью обхода мультимедиа, вам не придется перенастроять сетевое оборудование или SBCs. 

### <a name="requirements-for-using-media-processors"></a>Требования для использования процессоров мультимедиа

Процессоры мультимедиа всегда находятся в пути мультимедиа для голосовых приложений и веб-клиентов (например, клиентов Teams в Edge или Google Chrome). Требования одинаковы для настройки без обхода.


Диапазон IP-адресов для трафика мультимедиа: 

### <a name="office-365-and-office-365-gcc-environments"></a>Среды Office 365 и Office 365 GCC

- 52.112.0.0 /14 (IP-адреса от 52.112.0.1 до 52.115.255.254)

## <a name="office-365-gcc-dod-environment"></a>Среда DoD "GCC" в Office 365

- 52.127.64.0/21

### <a name="office-365-gcc-high-environment"></a>Среда Office 365 GCC High

- 52.127.88.0/21

Диапазон портов процессоров мультимедиа (применимо к всем средам) отображается в следующей таблице:

| Трафик | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Процессор мультимедиа | SBC | 3478, 3479 и 49 152–53 247    | Определяется в SBC |
| UDP/SRTP | SBC | Процессор мультимедиа | Определяется в SBC | 3478, 3479 и 49 152–53 247     |

## <a name="configure-separate-trunks-for-media-bypass-and-non-media-bypass"></a>Настройка отдельных магистральных каналов для обхода мультимедиа и обхода без мультимедиа  

Если вы хотите подтвердить функциональность перед переносом всех функций обхода мультимедиа в обход мультимедиа, вы можете создать отдельную магистраль и отдельную политику маршрутирования голосовой маршрутии Online, чтобы назначить ее определенным пользователям. 

Шаги высокой конфигурации:

- Определите пользователей, которые должны тестировать обход мультимедиа.

- Создание двух отдельных видов связи с разными FQDNs: одно из них включено для обхода мультимедиа; другой не. 

  Обе ленты указывают на один и тот же SBC. Порты для сигнального сигнала TLS SIP должны быть другими. Порты для мультимедиа должны быть одинаковыми.

- Создайте политику маршрутирования голосовой связи в Интернете и назначьте канал обхода мультимедиа соответствующим маршрутам, связанным с использованием этой политики ТСТС.

- Назначьте новую политику маршрутирования голосовой почты Online пользователям, для проверки обхода мультимедиа.

Пример ниже иллюстрирует эту логику.

| Набор пользователей | Количество пользователей | FQDN для магистрали, назначенное в OVRP | Включен обход мультимедиа |
| :------------ |:----------------- |:--------------|:--------------|
Пользователи с обойденной магистралью без мультимедиа | 980 | sbc1.contoso.com:5060 | true
Пользователи с обойденной магистралью мультимедиа | 20 | sbc2.contoso.com:5061 | false | 

Обе связи могут указывают на один и тот же SBC с одинаковым общедоступным IP-адресом. Сигнальные порты TLS на SBC должны быть другими, как показано на приведенной ниже схеме. Обратите внимание, что ваш сертификат должен поддерживать обе службы. В САН у вас должны быть два имена **(sbc1.contoso.com** и **sbc2.contoso.com)** или поддиавный сертификат.

> [!div class="mx-imgBorder"]
> ![Обе связи могут указать на один и тот же SBC с одинаковым общедоступным IP-адресом](media/direct-routing-media-bypass-7.png)

Сведения о том, как настроить две магистрали на одной телефонной телефонной телефонии, см. в документации вашего поставщика SBC:

 - [Документация по развертыванию AudioCodes](https://www.audiocodes.com/solutions-products/products/products-for-microsoft-365/direct-routing-for-microsoft-teams)
- [Документация по развертыванию Oracle](https://www.oracle.com/industries/communications/enterprise-session-border-controller/microsoft.html)
- [Документация по развертыванию информационного сообщения на ленте](https://ribboncommunications.com/solutions/enterprise-solutions/microsoft-solutions/direct-routing-microsoft-teams-calling)
- [Документация по развертыванию TE-Systems (anynode)](https://www.anynode.de/anynode-and-microsoft-teams/)

## <a name="client-endpoints-supported-with-media-bypass"></a>Конечные точки клиента, поддерживаемые обходом мультимедиа

Обход мультимедиа поддерживается для всех автономных классических клиентов Teams, клиентов Android и iOS, а также устройств Teams Phone. 

Для всех других конечных точек, которые не поддерживают обход мультимедиа, мы преобразуем звонок в обход, даже если он начался как обходной звонок. Это происходит автоматически и не требует действий от администратора. К ним относятся телефоны 3PIP Skype для бизнеса и веб-клиенты Teams, которые поддерживают прямые маршруты звонков (клиенты на основе WebRTC, работающие в Microsoft Edge, Google Chrome, Mozilla Firefox). 
 
## <a name="see-also"></a>См. также

[Настройка обхода сервера-посредника с прямой маршрутизацией](direct-routing-configure-media-bypass.md)


