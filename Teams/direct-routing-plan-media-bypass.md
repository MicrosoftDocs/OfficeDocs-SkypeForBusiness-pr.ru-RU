---
title: Планирование обхода сервера-посредника с прямой маршрутизацией
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.reviewer: NMuravlyannikov
ms.topic: article
ms.service: msteams
localization_priority: Normal
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Узнайте, как спланировать обход мультимедиа с помощью телефонная система прямой маршрутии, которая позволяет сократить путь к трафику мультимедиа и повысить производительность.
ms.custom: seo-marvel-apr2020
ms.openlocfilehash: 6806af0889f3667e85cc49856e605bbe0334d1be3ea3601a844a3b9f568e7619
ms.sourcegitcommit: 2a76435beaac1e5daa647e93f693ea8672ec0135
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/11/2021
ms.locfileid: "57848944"
---
# <a name="plan-for-media-bypass-with-direct-routing"></a>Планирование обхода сервера-посредника с прямой маршрутизацией

## <a name="about-media-bypass-with-direct-routing"></a>Обход мультимедиа с прямой маршрутией

Обход мультимедиа позволяет сократить путь к трафику мультимедиа и уменьшить количество переходов в пути для улучшения производительности. При обходе мультимедиа мультимедиа между контроллером границы сеанса (SBC) и клиентом хранятся мультимедиа, а не отправляются через Телефон (Майкрософт) системы. Чтобы настроить обход мультимедиа, SBC и клиент должны быть в одном расположении или сети.

Вы можете управлять обходом мультимедиа для каждого SBC с помощью команды **Set-CSOnlinePSTNGateway** с параметром **-MediaBypass,** для параметра true или false. Если включить обход мультимедиа, это не означает, что весь трафик мультимедиа будет оставаться в корпоративной сети. В этой статье описан поток зова в разных сценариях.

На схемах ниже показано, чем отличается поток вызовов как с обходом мультимедиа, так и без него.

Без обхода мультимедиа, когда клиент совершает или принимает звонок, сигнальный и поток мультимедиа между SBC, системой Телефон (Майкрософт) и клиентом Teams, как показано на схеме ниже:

> [!div class="mx-imgBorder"]
> ![Сигнальный поток и поток мультимедиа без обхода мультимедиа](media/direct-routing-media-bypass-1.png)


Но предположим, что пользователь находится в том же здании или сети, что и SBC. Например, предположим, что пользователь, который находится в здании в Области, звонит пользователю ННР: 

- **Без обхода мультимедиа** будут поступать через Залив или Dublin (где развернуты центра обработки данных Майкрософт) и обратно в SBC в Сша. 

  Центр обработки данных в Европе выбран, так как он находится в Европе, а корпорация Майкрософт использует центр обработки данных, ближайший к SBC. Хотя этот подход не влияет на качество звонка из-за оптимизации потока трафика в сетях Майкрософт в большинстве географических данных, трафик имеет ненужный цикл.     

- **При обходе** мультимедиа хранятся непосредственно между Teams и SBC, как показано на следующей схеме:

  > [!div class="mx-imgBorder"]
  > ![Сигнальный поток и поток мультимедиа с обходом мультимедиа](media/direct-routing-media-bypass-2.png)

Обход мультимедиа использует протоколы под названием "Интерактивные соединения (ICE) на клиенте Teams и ICE lite на SBC. Эти протоколы позволяют прямой маршрутике использовать самый прямой маршрут мультимедиа для оптимального качества. ICE и ICE Lite — это стандарты WebRTC. Подробные сведения об этих протоколах см. в описании протокола RFC 5245.


## <a name="call-flow-and-firewall-planning"></a>Планирование потока вызовов и брандмауэра

Планирование потока присоединения к звонкам и брандмауэра зависит от того, имеет ли пользователь прямой доступ к общедоступным IP-адресам SBC и находится ли пользователь внутри или за пределами сети.

### <a name="call-flow-if-the-user-has-direct-access-to-the-public-ip-address-of-the-sbc"></a>Поток зова, если у пользователя есть прямой доступ к общедоступным IP-адресу SBC

Если у пользователя есть прямой доступ к общедоступным IP-адресу SBC, поток зовов будет следующим:

- Для обхода мультимедиа Teams клиент должен иметь доступ к общедоступным IP-адресам SBC даже из внутренней сети. Если прямая мультимедиа не требуется, они могут перетекать через ретрансляторы транспорта.

- Это рекомендуемое решение, если пользователь находится в том же здании или сети, что и SBC, и удаляет компоненты Microsoft Cloud из пути мультимедиа.

- Сигнальный сигнал всегда проходит через облако Майкрософт.

На следующей схеме показан поток зова, когда включен обход мультимедиа, клиент является внутренним, а клиент может получить доступ к общедоступным IP-адресам SBC (прямой мультимедиа): 

- Стрелки и числимые значения путей соответствуют Microsoft Teams [звонка.](./microsoft-teams-online-call-flows.md)

- Сигнальный трафик SIP всегда проходит по путям 4 и 4' (в зависимости от направления трафика). Media stays local and takes path 5b.

> [!div class="mx-imgBorder"]
> ![Отображает поток зовов с включенным обходом мультимедиа, клиент является внутренним](media/direct-routing-media-bypass-3.png)


### <a name="call-flow-if-the-user-does-not-have-access-to-the-public-ip-address-of-the-sbc"></a>Поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC

Ниже описан поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC. 

Предположим, пользователь является внешним, а администратор клиента решил не открывать общедоступный IP-адрес SBC для всех пользователей в Интернете, а только в Microsoft Cloud. Внутренние компоненты трафика могут перетекать через Teams транспорта. Примите во внимание следующее:

- Teams Используются ретрансляторы транспорта.

- Для обхода мультимедиа корпорация Майкрософт использует версию ретрансляторов транспорта, которая требует открытия портов от 50 000 до 59 999 между ретрансляторами транспорта Teams и SBC (в будущем планируется перейти на версию, которая требует портов 3478–3481).


На следующей схеме показан поток зова, когда включен обход мультимедиа, клиент является внешним и не может получить доступ к общедоступным IP-адресам контроллера границы сеанса (мультимедиа передаются Teams ретранслятором транспорта).

- Стрелки и числимые значения путей соответствуют Microsoft Teams [звонка.](./microsoft-teams-online-call-flows.md)

- Мультимедиа передается по путям 3, 3', 4 и 4'

> [!div class="mx-imgBorder"]
> ![Отображает поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC](media/direct-routing-media-bypass-4.png)


### <a name="call-flow-if-a-user-is-outside-the-network-and-has-access-to-the-public-ip-of-the-sbc"></a>Поток вызовов, если пользователь находится за пределами сети и имеет доступ к общедоступным IP-адресам SBC

> [!NOTE]
> Такая конфигурация не рекомендуется, так как она не Teams ретрансляторов транспорта. Вместо этого следует рассмотреть предыдущий сценарий, в котором у пользователя нет доступа к общедоступным IP-адресам SBC. 

На следующей схеме показан поток зова, когда включен обход мультимедиа, клиент внешний, а клиент может получить доступ к общедоступным IP-адресам SBC (прямого мультимедиа).

- Стрелки и числимые значения путей соответствуют статье Microsoft Teams [потокам](./microsoft-teams-online-call-flows.md) зовов.

- Сигнальный трафик SIP всегда проходит по путям 3 и 3' (в зависимости от направления трафика). Потоки мультимедиа, использующие путь 2.

> [!div class="mx-imgBorder"]
> ![Отображает поток присоединения к звонкам, если у пользователя нет доступа к общедоступным IP-адресам SBC](media/direct-routing-media-bypass-5.png)


## <a name="use-of-media-processors-and-transport-relays"></a>Использование процессоров мультимедиа и ретрансляторов транспорта

В Microsoft Cloud есть два компонента, которые могут быть в пути к трафику мультимедиа: процессоры мультимедиа и ретрансляторы транспорта. 

- Процессор мультимедиа — это общедоступный компонент, который обрабатывает мультимедиа в случаях без обхода и обрабатывает мультимедиа для голосовых приложений.

   Процессоры мультимедиа всегда находятся в пути для конечных пользователей, не обходив вызовы, но никогда не находятся в пути для обойденных звонков. Процессоры мультимедиа всегда находятся в пути для всех голосовых приложений, таких как "Парк вызовов", "Автоотправление организации" и "Очереди зовов".

- Ретранслятор транспорта используется для подключения к ближайшей службе транспорта для отправки трафика в режиме реального времени.

   В зависимости от того, где находится пользователь и как настроена сеть, ретрансляторы транспорта могут быть в пути для обходных вызовов или предназначенных для конечных пользователей.

На следующей схеме показаны два потока зова: один с включенным обходом мультимедиа, второй — с отключенным обходом мультимедиа.

> [!NOTE]
> На схеме показывается только трафик, относяющийся к конечным пользователям или направляющийся на него.  

- Контроллер мультимедиа — это микрослужба в Azure, которая назначает процессоры мультимедиа и создает предложения протокола SDP.

- Прокси-сервер SIP — это компонент, который преобразует сигналы HTTP REST, используемые в Teams, в SIP.    

> [!div class="mx-imgBorder"]
> ![Отображает потоки зовов с включенным и отключенным обходом мультимедиа](media/direct-routing-media-bypass-6.png)


В таблице ниже приведена разница между процессорами мультимедиа и ретрансляторами транспорта.

|    | Процессоры мультимедиа | Ретрансляторы транспорта|
| :--------------|:---------------|:------------|
В канале мультимедиа для вызовов без обхода для конечных пользователей | Всегда | Если клиенту не удается напрямую связаться с процессором мультимедиа | 
В пути мультимедиа для обхода звонков для конечных пользователей | Нвер | Если клиенту не удается связаться с SBC по общедоступным IP-адресу | 
В пути мультимедиа для голосовых приложений | Всегда | Нвер | 
Может делать транскодинг (B2BUA)\* | Да | Нет, звук передается только между конечными точками. | 
Количество экземпляров и расположение в разных странах | 10 итогов: 2 на востоке и западе США; 2 в области "Париж" и "Dublin"; 2 в Гонконге и Сингапуре; 2 в Японии; 2 в Восточной и Юго-Восточной Австралии | Несколько

Диапазоны IP-адресов:
- 52.112.0.0/14 (IP-адреса от 52.112.0.1 до 52.115.255.254)
- 52.120.0.0/14 (IP-адреса от 52.120.0.1 до 52.123.255.254)

\* Объяснение транскодинга: 

- Процессор мультимедиа — это B2BUA, то есть он может изменять кодеки (например, КОДЕКИ ОТ клиента Teams до MP и G.711 между MP и SBC).

- Ретрансляторы транспорта не являются B2BUA, то есть кодек никогда не меняется между клиентом и SBC, даже если трафик передается через ретрансляторы.

### <a name="use-of-teams-media-processors-if-trunk-is-configured-for-media-bypass"></a>Использование процессоров Teams мультимедиа, если для обхода мультимедиа настроено использование магистрали

Teams Процессоры мультимедиа всегда вставляются в путь мультимедиа в следующих сценариях:

- Звонок перенается с 1:1 на групповой звонок
- Звонок идет федераированному Teams пользователю
- Звонок переадправлен или перенаправлен пользователю Skype для бизнеса.

Убедитесь, что ваш SBC имеет доступ к диапазонам процессоров мультимедиа и ретрансляторов транспорта, как описано ниже.    


## <a name="sip-signaling-fqdns"></a>Сигнальный SIP: FQDNs

Для сигнальных служб SIP требования к FQDN и брандмауэру одинаковы, как для случаев, не обходить которые не требуется. 

Прямая маршрутная маршрутия предоставляется в следующих Microsoft 365 или Office 365 средах:
- Microsoft 365 или Office 365
- Office 365 GCC
- Office 365 GCC высокая
- Office 365 DoD Подробнее о средах [Office 365](/office365/servicedescriptions/office-365-platform-service-description/office-365-us-government/office-365-us-government) и государственных государственных GCC, GCC Высокая и DoD.

### <a name="microsoft-365-office-365-and-office-365-gcc-environments"></a>Microsoft 365, Office 365 и Office 365 GCC средах

Точки соединения для прямой маршрутии являются следующими тремя FQDNs:

- **sip.pstnhub.microsoft.com** — глобальное FQDN — необходимо сначала опробовоть. Когда SBC отправляет запрос на устранение этого имени, DNS-серверы Microsoft Azure возвращают IP-адрес, указывающий на основной центр обработки данных Azure, который назначен SBC. Назначение основано на метриках производительности центра обработки данных и географической близости к SBC. Возвращенный IP-адрес соответствует основному FQDN.

- **sip2.pstnhub.microsoft.com** — дополнительное FQDN — географически сопоставить со вторым приоритетным регионом.

- **sip3.pstnhub.microsoft.com** — tertiary FQDN — географически сопоставить с третьим приоритетным регионом.

Эти три FQDDNs необходимо разместить, чтобы:

- Обеспечение оптимальной работы (меньше нагрузка и ближе всего к центру обработки данных SBC, назначенного с помощью запроса к первому FQDN).

- Отбой в случае, если подключение из SBC установлено к центру обработки данных, в который возникли временные проблемы. Дополнительные сведения см. в приведенной ниже механизме отбойной передачи.


FQDNs sip.pstnhub.microsoft.com , **sip2.pstnhub.microsoft.com** и **sip3.pstnhub.microsoft.com** будут разрешены на IP-адреса из следующих подсетей:
- 52.112.0.0/14
- 52.120.0.0/14

Чтобы разрешить входящий и исходяющий трафик с адресов для сигнального трафика, необходимо открыть в брандмауэре порты для всех этих диапазонов IP-адресов. Если брандмауэр поддерживает имена DNS,  имя FQDN sip-all.pstnhub.microsoft.com для всех этих IP-подсетей. 

### <a name="office-365-gcc-dod-environment"></a>Office 365 GCC DoD

Точка соединения для прямой маршрутии имеет следующий FQDN:

**sip.pstnhub.dod.teams.microsoft.us** — глобальное FQDN. Так как Office 365 DoD существует только в центрах обработки данных в США, дополнительные и дополнительные FQDNs не 33.

FQDN sip.pstnhub.dod.teams.microsoft.us будет разрешено на IP-адрес из следующей подсети:

- 52.127.64.0/21

Чтобы разрешить входящий и исходяющий трафик с адресов для сигнального трафика, необходимо открыть в брандмауэре порты для всех этих диапазонов IP-адресов.  Если брандмауэр поддерживает имена DNS, доменные sip.pstnhub.dod.teams.microsoft.us ко всем этим IP-подсетям. 

### <a name="office-365-gcc-high-environment"></a>Office 365 GCC высокая среда

Точка соединения для прямой маршрутии имеет следующий FQDN:

**sip.pstnhub.gov.teams.microsoft.us** — глобальное FQDN. Поскольку среда GCC Высокая существует только в центрах обработки данных в США, дополнительные и дополнительные FQDNs не имеются.

Адрес FQDN sip.pstnhub.gov.teams.microsoft.us будет разрешен на IP-адрес из следующей подсети:

- 52.127.88.0/21

Чтобы разрешить входящий и исходяющий трафик с адресов для сигнального трафика, необходимо открыть в брандмауэре порты для всех этих диапазонов IP-адресов.  Если брандмауэр поддерживает имена DNS, доменные sip.pstnhub.gov.teams.microsoft.us ко всем этим IP-подсетям. 

## <a name="sip-signaling-ports"></a>Сигнальный SIP: порты

Требования к переносу одинаковы для всех сред Office 365, где предлагается прямая маршрутная маршрутия:
- Microsoft 365 или Office 365
- Office 365 GCC
- Office 365 GCC высокая
- Office 365 Dod

Необходимо использовать следующие порты:

| Трафика | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
SIP/TLS| Прокси-сервер SIP | Sbc | 1024 - 65535 | Определено в SBC |
| SIP/TLS | Sbc | Прокси-сервер SIP | Определено в SBC | 5061 |


## <a name="media-traffic-ip-and-port-ranges"></a>Трафик мультимедиа: диапазоны IP-адресов и портов

Трафик мультимедиа передается между клиентом SBC и клиентом Teams, если доступно прямое подключение, или через Teams, если клиент не может связаться с SBC с использованием общего IP-адреса.

### <a name="requirements-for-direct-media-traffic-between-the-teams-client-and-the-sbc"></a>Требования для прямого трафика мультимедиа (между клиентом Teams и SBC) 

У клиента должен быть доступ к указанным портам (см. таблицу) на общедоступный IP-адрес SBC. 

> [!NOTE]
> Если клиент находится во внутренней сети, мультимедиа перетекают на общедоступный IP-адрес SBC. Вы можете настроить закрепление ветвей на устройстве NAT, чтобы трафик никогда не покидает сетевое оборудование предприятия.

| Трафика | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Клиент | Sbc | 3478-3481 и 49152 – 53247| Определено в SBC |
| UDP/SRTP | Sbc | Клиент | Определено в SBC | 3478-3481 и 49152 – 53247  |


> [!NOTE]
> Если у вас есть сетевое устройство, которое преобразует исходные порты клиента, убедитесь, что переведенные порты открыты между сетевым оборудованием и SBC. 

### <a name="requirements-for-using-transport-relays"></a>Требования для использования ретрансляторов транспорта

Ретрансляторы транспорта находятся в том же диапазоне, что и процессоры мультимедиа (для случаев без обхода): 

### <a name="microsoft-365-office-365-and-office-365-gcc-environments"></a>Microsoft 365, Office 365 и Office 365 GCC средах

- 52.112.0.0 /14 (IP-адреса от 52.112.0.1 до 52.115.255.254)

### <a name="office-365-gcc-dod-environment"></a>Office 365 GCC DoD

- 52.127.64.0/21

### <a name="office-365-gcc-high-environment"></a>Office 365 GCC высокая среда

- 52.127.88.0/21


Диапазон портов Teams ретрансляторов транспорта (применимо для всех сред) показан в следующей таблице:


| Трафика | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Ретранслятор транспорта | Sbc | 50 000 -59 999    | Определено в SBC |
| UDP/SRTP | Sbc | Ретранслятор транспорта | Определено в SBC | 50 000 – 59 999, 3478-3481     |


> [!NOTE]
> Корпорация Майкрософт рекомендует не менее двух портов для одновременного вызова на SBC. Так как у корпорации Майкрософт есть две версии ретрансляторов транспорта, требуется следующее:
> 
> - V4, которая может работать только с диапазоном портов от 50 000 до 59 999
> 
> - v6, которая работает с портами 3478–3481

В настоящее время обход мультимедиа поддерживает только версию ретрансляторов транспорта версии 4. В будущем мы введем поддержку v6. 

Для перехода необходимо открыть порты 3478–3481. Когда Корпорация Майкрософт введет поддержку ретрансляторов транспорта v6 с помощью обхода мультимедиа, вам не потребуется перенастройку сетевого оборудования или БСК. 

### <a name="requirements-for-using-media-processors"></a>Требования к использованию процессоров мультимедиа

Процессоры мультимедиа всегда находятся в пути мультимедиа для голосовых приложений и веб-клиентов (например, Teams клиентах в Edge или Google Chrome). Требования одинаковы для настройки без обхода.


Диапазон IP-адресов для трафика мультимедиа: 

### <a name="office-365-and-office-365-gcc-environments"></a>Office 365 и Office 365 GCC средах

- 52.112.0.0 /14 (IP-адреса от 52.112.0.1 до 52.115.255.254)

### <a name="office-365-gcc-dod-environment"></a>Office 365 GCC DoD

- 52.127.64.0/21

### <a name="office-365-gcc-high-environment"></a>Office 365 GCC высокая среда

- 52.127.88.0/21

Диапазон портов процессоров мультимедиа (применимо для всех сред) показан в таблице ниже.

| Трафика | От | До | Исходный порт | Конечный порт|
| :-------- | :-------- |:-----------|:--------|:---------|
UDP/SRTP | Процессор мультимедиа | Sbc | 3478-3481 и 49 152 – 53 247    | Определено в SBC |
| UDP/SRTP | Sbc | Процессор мультимедиа | Определено в SBC | 3478-3481 и 49 152 – 53 247     |

## <a name="configure-separate-trunks-for-media-bypass-and-non-media-bypass"></a>Настройка отдельных каналов для обхода мультимедиа и обхода без мультимедиа  

Если вы хотите подтвердить функциональность перед переносом всех функций обхода мультимедиа в обход мультимедиа, вы можете создать отдельную магистраль и отдельную политику голосового маршрутирования Online для маршрутирования к каналу обхода мультимедиа и назначения определенным пользователям. 

Шаги высокой настройки:

- Определите пользователей, которые должны проверить обход мультимедиа.

- Создайте две отдельные связи с разными FQDNs: одно из них включено для обхода мультимедиа; другой нет. 

  Обе стороны указывают на один и тот же SBC. Порты для сигнального сигнала TLS SIP должны быть другими. Порты мультимедиа должны быть одинаковыми.

- Создайте политику маршрутирования голосовой связи в Интернете и назначьте канал обхода мультимедиа соответствующим маршрутам, связанным с использованием этой политики через ТСТС.

- Назначьте новую политику маршрутирования голосовой почты в Интернете пользователям, для проверки обхода мультимедиа.

Пример ниже иллюстрирует эту логику.

| Набор пользователей | Количество пользователей | FQDN", присвоенное в OVRP | Включен обход мультимедиа |
| :------------ |:----------------- |:--------------|:--------------|
Пользователи с обводом без мультимедиа | 980 | sbc1.contoso.com:5061 | false |
Пользователи с обводом мультимедиа | 20 | sbc2.contoso.com:5060 | true | 

Обе связи могут указать на один и тот же SBC с одинаковым общедоступным IP-адресом. Сигнальные порты TLS на SBC должны быть другими, как показано на приведенной ниже схеме. Обратите внимание, что сертификат должен поддерживать обе стороны. В САН у вас должны быть два имени **(sbc1.contoso.com** **и sbc2.contoso.com**) или поддиск.

> [!div class="mx-imgBorder"]
> ![Обе связи могут указать на один и тот же SBC с одинаковым общедоступным IP-адресом](media/direct-routing-media-bypass-7.png)

Сведения о настройке двух телефонов на одном ИТ-сайте см. в документации поставщика SBC:

 - [Документация по развертыванию AudioCodes](https://www.audiocodes.com/solutions-products/products/products-for-microsoft-365/direct-routing-for-microsoft-teams)
- [Документация по развертыванию Oracle](https://www.oracle.com/industries/communications/enterprise-session-border-controller/microsoft.html)
- [Документация по развертыванию коммуникаций на ленте](https://ribboncommunications.com/solutions/enterprise-solutions/microsoft-solutions/direct-routing-microsoft-teams-calling)
- [Документация по развертыванию TE-Systems (anynode)](https://www.anynode.de/anynode-and-microsoft-teams/)

## <a name="client-endpoints-supported-with-media-bypass"></a>Конечные точки клиента, поддерживаемые с помощью обхода мультимедиа

Обход мультимедиа поддерживается для всех автономных Teams классических версий, клиентов Android и iOS, а также Teams Телефон устройств. 

Для всех остальных конечных точек, которые не поддерживают обход мультимедиа, мы преобразуем звонок в обход, даже если он начался как обходной вызов. Это происходит автоматически и не требует действий от администратора. К ним относятся телефоны Skype для бизнеса 3PIP и веб-клиенты Teams, поддерживаюющие прямые маршруты звонков (клиенты на основе WebRTC, работающие в Microsoft Edge, Google Chrome, Mozilla Firefox). 
 
## <a name="see-also"></a>См. также

[Настройка обхода сервера-посредника с прямой маршрутизацией](direct-routing-configure-media-bypass.md)
