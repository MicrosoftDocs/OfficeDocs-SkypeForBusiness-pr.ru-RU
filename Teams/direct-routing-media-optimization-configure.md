---
title: Настройка оптимизации локальных носителей для прямой маршрутизации
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: Настройка оптимизации локальных носителей для прямой маршрутизации
appliesto:
- Microsoft Teams
ms.openlocfilehash: 58cf5f560a22a58cb76ea28389d0dce1e3b3f4fb
ms.sourcegitcommit: 296862e02b548f0212c9c70504e65b467d459cc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2022
ms.locfileid: "65674881"
---
# <a name="configure-local-media-optimization-for-direct-routing"></a>Настройка оптимизации локальных носителей для прямой маршрутизации

Конфигурация для оптимизации локальных носителей основана на параметрах сети, общих для других облачных голосовых функций, таких как маршрутизация Location-Based и динамические экстренные вызовы. Дополнительные сведения о сетевых регионах, сетевых сайтах, сетевых подсетях и доверенных IP-адресах см. в разделе "Параметры сети для [облачных голосовых функций"](cloud-voice-network-settings.md).

Перед настройкой оптимизации локальных носителей см. статью "Оптимизация локальных носителей [для прямой маршрутизации"](direct-routing-media-optimization.md).

Чтобы настроить оптимизацию локального носителя, необходимо выполнить следующие действия. Вы можете использовать Teams Администратор Или PowerShell. Дополнительные сведения см. [в разделе "Управление топологией сети"](manage-your-network-topology.md).

1. Настройте пользователя и сайты SBC (как описано в этой статье).
2. Настройте SBC для оптимизации локальных носителей (в соответствии со спецификацией поставщика SBC).

На следующей схеме показана настройка сети, используемая в примерах этой статьи.

> [!div class="mx-imgBorder"]
> ![Схема, на которой показана настройка сети для примеров.](media/direct-routing-media-op-9.png "Примеры настройки сети")

## <a name="configure-the-user-and-the-sbc-sites"></a>Настройка пользователя и сайтов SBC

Чтобы настроить пользователя и сайты SBC, вам потребуется:

1. [Управление внешними доверенными IP-адресами](#manage-external-trusted-ip-addresses).

2. [Определите топологию сети](#define-the-network-topology) , настроив сетевые регионы, сетевые сайты и сетевые подсети.

3. [Определите топологию виртуальной](#define-the-virtual-network-topology) сети, назначив SBC сайтам с соответствующими режимами и значениями SBC прокси-сервера.

> [!NOTE]
> Оптимизация локального носителя зависит от того, что расположения клиентов обнаруживаются как внешние или внутренние относительно корпоративных сетей с доступом к внутреннему интерфейсу пограничного контроллера сеанса прямой маршрутизации (DR) (SBC).
> В сценариях VPN с раздельным туннелированием, когда конечная точка клиента определяется как внешняя для сети клиента, корпорация Майкрософт будет сигнализирует о внешнем расположении для SBC, даже если клиент может получить доступ к внутреннему интерфейсу SBC прямой маршрутизации клиента. Клиенты прямой маршрутизации, использующие оптимизацию локальных носителей, могут иметь длительное время настройки звонков, а в некоторых случаях — отсутствие звука при получении звонков из ТСОП.
> Чтобы избежать этого, администраторы VPN должны заблокировать доступ между удаленными пользователями VPN и внутренним интерфейсом SBC прямой маршрутизации.

## <a name="configure-sbcs-for-local-media-optimization-according-to-the-sbc-vendor-specification"></a>Настройка SBC для оптимизации локальных носителей в соответствии со спецификацией поставщика SBC

В этой статье описывается конфигурация компонентов Майкрософт. Сведения о конфигурации SBC см. в документации поставщика SBC. Сведения о том, какие поставщики SBC поддерживают оптимизацию локальных носителей, см. в разделе "Пограничные контроллеры сеансов", [сертифицированные для прямой маршрутизации](direct-routing-border-controllers.md).

## <a name="manage-external-trusted-ip-addresses"></a>Управление внешними доверенными IP-адресами

Внешние доверенные IP-адреса — это внешние IP-адреса Интернета корпоративной сети. Эти IP-адреса — это IP-адреса, используемые Microsoft Teams клиентами при подключении к Microsoft 365. Эти внешние IP-адреса необходимо добавить для каждого сайта, на котором есть пользователи, использующие оптимизацию локальных носителей.

Чтобы добавить общедоступные IP-адреса для каждого сайта, используйте New-CsTenantTrustedIPAddress командлета. Вы можете определить неограниченное количество доверенных IP-адресов для клиента. Если внешние IP-адреса, Microsoft 365 являются IPv4-адресами и IPv6-адресами, необходимо добавить оба типа IP-адресов. Для IPv4 используйте маску 32. Для IPv6 используйте маску 128. Вы можете добавить как отдельные внешние IP-адреса, так и внешние IP-подсети, указав разные объекты MaskBit в командлете.

```powershell
New-CsTenantTrustedIPAddress -IPAddress <External IP address> -MaskBits <Subnet bitmask> -Description <description>
```

Пример добавления доверенных IP-адресов.

```powershell
New-CsTenantTrustedIPAddress -IPAddress 172.16.240.110 -MaskBits 32 -Description "Vietnam site trusted IP"
New-CsTenantTrustedIPAddress -IPAddress 172.16.240.120 -MaskBits 32 -Description "Indonesia site trusted IP"
New-CsTenantTrustedIPAddress -IPAddress 172.16.240.130 -MaskBits 32 -Description "Singapore site trusted IP"
```

## <a name="define-the-network-topology"></a>Определение топологии сети

В этом разделе описывается, как определить сетевые регионы, сетевые сайты и сетевые подсети для топологии сети.

Все параметры чувствительны к регистру, поэтому необходимо убедиться, что используется тот же случай, который использовался во время установки.  (Например, значения GatewaySiteID "Вьетнам" и "вьетнам" будут рассматриваться как разные сайты.)

### <a name="define-network-regions"></a>Определение сетевых регионов

Чтобы определить сетевые регионы, используйте New-CsTenantNetworkRegion командлета. Параметр RegionID — это логическое имя, которое представляет географию региона и не имеет зависимостей или ограничений. Параметр CentralSite `<site ID>` является необязательным.

```powershell
New-CsTenantNetworkRegion -NetworkRegionID <region ID>
```

В следующем примере создается сетевой регион с именем APAC:

```powershell
New-CsTenantNetworkRegion -NetworkRegionID "APAC"
```

### <a name="define-network-sites"></a>Определение сетевых сайтов

Чтобы определить сетевые сайты, используйте New-CsTenantNetworkSite командлета. Каждый сетевой сайт должен быть связан с сетевым регионом.

```powershell
New-CsTenantNetworkSite -NetworkSiteID <site ID> -NetworkRegionID <region ID>
```

В следующем примере создаются три новых сетевых сайта: Вьетнам, Индонезия и Сингапур в регионе APAC:

```powershell
New-CsTenantNetworkSite -NetworkSiteID "Vietnam" -NetworkRegionID "APAC"
New-CsTenantNetworkSite -NetworkSiteID "Indonesia" -NetworkRegionID "APAC"
New-CsTenantNetworkSite -NetworkSiteID "Singapore" -NetworkRegionID "APAC"
```

### <a name="define-network-subnets"></a>Определение сетевых подсетей

Чтобы определить сетевые подсети и связать их с сетевыми сайтами, используйте New-CsTenantNetworkSubnet командлета. Каждая подсеть сети может быть связана только с одним сайтом.

```powershell
New-CsTenantNetworkSubnet -SubnetID <Subnet IP address> -MaskBits <Subnet bitmask> -NetworkSiteID <site ID>
```

В следующем примере определяются три сетевые подсети и они связаны с тремя сетевыми сайтами: Вьетнамом, Индонезией и Сингапуром:

```powershell
New-CsTenantNetworkSubnet -SubnetID 192.168.1.0 -MaskBits 24 -NetworkSiteID "Vietnam"
New-CsTenantNetworkSubnet -SubnetID 192.168.2.0 -MaskBits 24 -NetworkSiteID "Indonesia"
New-CsTenantNetworkSubnet -SubnetID 192.168.3.0 -MaskBits 24 -NetworkSiteID "Singapore"
```

## <a name="define-the-virtual-network-topology"></a>Определение топологии виртуальной сети

Сначала администратор клиента создает новую конфигурацию SBC для каждого соответствующего SBC с помощью New-CsOnlinePSTNGateway командлета.
Администратор клиента определяет топологию виртуальной сети, указав сетевые сайты для объектов шлюза ТСОП с помощью Set-CsOnlinePSTNGateway командлета:

```powershell
PS C:\> Set-CsOnlinePSTNGateway -Identity <Identity> -GatewaySiteID <site ID> -MediaBypass <true/false> -BypassMode <Always/OnlyForLocalUsers> -ProxySBC  <proxy SBC FQDN or $null>
```

Обратите внимание на следующее:

- Если у клиента есть один SBC, параметр -ProxySBC должен быть обязательным $null или полное доменное имя SBC (центральный SBC с централизованным сценарием магистралей).
- Параметр -MediaBypass должен иметь значение $true для поддержки оптимизации локального носителя.
- Если в SBC нет набора параметров -BypassMode, заголовки X-MS не будут отправляться.
- Все параметры чувствительны к регистру, поэтому необходимо убедиться, что используется тот же случай, который использовался во время установки.  (Например, значения GatewaySiteID "Вьетнам" и "вьетнам" будут рассматриваться как разные сайты.)

В следующем примере три контроллера SBC добавляются на сетевые сайты "Вьетнам", "Индонезия" и "Сингапур" в регионе APAC с режимом "Всегда обходить":

```powershell
Set-CSOnlinePSTNGateway -Identity "proxysbc.contoso.com" -GatewaySiteID "Singapore" -MediaBypass $true -BypassMode "Always" -ProxySBC $null

Set-CSOnlinePSTNGateway -Identity "VNsbc.contoso.com" -GatewaySiteID "Vietnam" -MediaBypass $true -BypassMode "Always" -ProxySBC "proxysbc.contoso.com"

Set-CSOnlinePSTNGateway -Identity "IDsbc.contoso.com" -GatewaySiteID "Indonesia" -MediaBypass $true -BypassMode "Always" -ProxySBC "proxysbc.contoso.com"
```

> [!NOTE]
> Чтобы обеспечить бесперебойную работу при одновременной настройке оптимизации локального носителя и маршрутизации Location-Based (LBR), для LBR необходимо включить нисходящие SBC, заданные для параметра GatewaySiteLbrEnabled значение $true для каждого подчиненного SBC. (Этот параметр не является обязательным для прокси-сервера SBC.)

Исходя из приведенных выше сведений, прямая маршрутизация будет включать три собственных заголовка SIP для приглашений SIP и повторных приглашений, как показано в следующей таблице.

Заголовки X-MS, представленные в прямой маршрутизации для приглашений и Re-Invites, если определен BypassMode:

|Имя заголовка|Значения|Комментарии|
|---|---|---|
|X-MS-UserLocation|внутренний или внешний|Указывает, является ли пользователь внутренним или внешним|
|Request-URI INVITE sip: +84439263000@VNsbc.contoso.com SIP /2.0|Полное доменное имя SBC|Полное доменное имя, предназначенное для вызова, даже если SBC не подключен напрямую к прямой маршрутизации|
|X-MS-MediaPath|Пример: proxysbc.contoso.com, VNsbc.contoso.com|Порядок контроллеров SBC, которые должны использоваться для пути мультимедиа между пользователем и целевым SBC. Последний SBC всегда является последним|
|X-MS-UserSite|usersiteID|Строка, определенная администратором клиента|

## <a name="call-flows"></a>Потоки вызовов

Ниже показаны потоки вызовов для двух режимов:

- [Всегда обходить](#always-bypass-mode)
- [Только для локальных пользователей](#only-for-local-users-mode)

### <a name="always-bypass-mode"></a>Режим постоянного обхода

Режим постоянного обхода является простейшим вариантом для настройки. Администратор клиента может настроить единый сайт для всех пользователей и контроллеров SBC, если все контроллеры безопасности доступны с любого сайта.

В примерах показан режим обхода Always для следующих сценариев:

- [Исходящие вызовы и пользователь находится в том же расположении, что и SBC](#outbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass)
- [Входящие вызовы и пользователь находится в том же расположении, что и SBC](#inbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass)
- [Исходящие вызовы и пользователь является внешним](#outbound-calls-and-the-user-is-external-with-always-bypass)
- [Входящие вызовы и пользователь является внешним](#inbound-calls-and-the-user-is-external-with-always-bypass)

В следующей таблице показаны полное доменное имя и IP-адреса, используемые в примерах:

|Полное доменное имя|Внешний IP-адрес SBC|Внутренний IP-адрес SBC|Внутренняя подсеть|Местоположение|Внешний NAT (доверенный IP-адрес)|
|---|---|---|---|---|---|
|VNsbc.contoso.com|Нет|192.168.1.5|192.168.1.0/24|Вьетнам|172.16.240.110|
|IDsbc.contoso.com|Нет|192.168.2.5|192.168.2.0/24|Индонезия|172.16.240.120|
|proxysbc.contoso.com|172.16.240.133|192.168.3.5|192.168.3.0/24|Сингапур|172.16.240.130|

#### <a name="outbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass"></a>Исходящие вызовы и пользователь находится в том же расположении, что и SBC с Always Bypass

|Режим|Пользователь|Местоположение|Направление вызова|
|---|---|---|---|
|AlwaysBypass|Internal|Тот же сайт, что и SBC|Исходящее|

В следующей таблице показаны конфигурация и действие конечного пользователя:

|Физическое расположение пользователя|Пользователь выполняет или получает вызов на номер или из номера|Номер телефона пользователя|Политика сетевой маршрутизации голосовой связи|Режим, настроенный для SBC|
|---|---|---|---|---|
|Вьетнам|+84 4 3926 3000|+84 4 5555 5555|Приоритет 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br> Приоритет 2. .* — proxysbc.contoso.com|VNsbc.contoso.com — всегда обходить <br> proxysbc.contoso.com — всегда обходить|

На следующей схеме показана схема SIP для исходящего вызова в режиме обхода Always и пользователя в том же расположении, что и SBC.

> [!div class="mx-imgBorder"]
> ![Схема исходящих вызовов.](media/direct-routing-media-op-10.png "Исходящие вызовы")

В следующей таблице показаны заголовки X-MS, отправляемые прямой маршрутиза службой.

|Параметр|Пояснение|
|---|---|
|Пригласить +8443926300@VNsbc.contoso.com|Целевое полное доменное имя SBC, определенное в политике маршрутизации голосовой связи в Сети, отправляется в URI запроса.|
|X-MS-UserLocation: internal|Поле, указывающее, что пользователь находится в корпоративной сети|
|X-MS-MediaPath: VNsbc.contoso.com|Указывает, какой SBC клиент должен проходить к целевому SBC. В этом случае, так как у нас есть Always Bypass, а клиент является внутренним именем целевого объекта, отправленным в качестве единственным именем в заголовке.|
|X-MS-UserSite: Вьетнам|Поле, указанное на сайте, где находится пользователь.|

#### <a name="inbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass"></a>Входящие вызовы и пользователь находится в том же расположении, что и SBC с Always Bypass

|Режим|Пользователь|Местоположение|Направление вызова|
|---|---|---|---|---|
|AlwaysBypass|Internal|Тот же сайт, что и SBC|Входящих|

При входящем вызове расположение пользователя неизвестно, и SBC должен угадать, где находится пользователь. Если предположение неправильное, потребуется повторное приглашение. В этом случае предполагается, что пользователь является внутренним, мультимедиа может выполняться напрямую, и никаких дополнительных действий (повторное приглашение) не требуется.
SBC, подключенный к службе прямой маршрутизации, сообщает исходное расположение SBC, предоставляя поля Record-Route контактов. На основе этих полей путь мультимедиа вычисляется путем прямой маршрутизации.

Примечание. Учитывая, что у пользователя может быть несколько конечных точек, поддержка 183 не поддерживается. В этом случае при прямой маршрутизации всегда будет использоваться 180 вызовов.

На следующей схеме показана схема SIP для входящего вызова в режиме AlwaysBypass, и пользователь находится в том же расположении, что и SBC.

> [!div class="mx-imgBorder"]
> ![Схема, на которой показана схема SIP.](media/direct-routing-media-op-11.png)

#### <a name="outbound-calls-and-the-user-is-external-with-always-bypass"></a>Исходящие вызовы и пользователь является внешним с always Bypass

|Режим|Пользователь|Сайт|Направление вызова
|---|---|---|---|
|AlwaysBypass|Внешняя|Н/Д|Исходящее|

На следующей схеме показана схема SIP для исходящего вызова в режиме AlwaysBypass, и пользователь является внешним:

> [!div class="mx-imgBorder"]
> ![На схеме показана схема SIP.](media/direct-routing-media-op-12.png)

В следующей таблице показаны заголовки X-MS, отправляемые службой прямой маршрутизации:

|Параметр|Пояснение|
|---|---|
|Пригласить +8443926300@VNsbc.contoso.com|Целевое полное доменное имя SBC, определенное в политике маршрутизации голосовой связи в сети, отправляется в URI запроса.|
|X-MS-UserLocation: external|В поле указано, что пользователь находится за пределами корпоративной сети.|
|X-MS-MediaPath: proxysbc.contoso.com, VNsbc.contoso.com|Указывает, какой SBC клиент должен проходить к целевому SBC. В этом случае, так как у нас есть Always Bypass, а клиент является внешним.|

#### <a name="inbound-calls-and-the-user-is-external-with-always-bypass"></a>Входящие вызовы и пользователь является внешним с always Bypass

|Режим|Пользователь|Сайт|Направление вызова|
|---|---|---|---|
|AlwaysBypass|Внешняя|Н/Д|Входящих|

Для входящего вызова SBC, подключенный к прямой маршрутизации, должен отправить повторное приглашение (по умолчанию всегда предлагаются кандидаты на локальные носители), если расположение пользователя является внешним.  X-MediaPath вычисляется на основе Record-Route и указанного пользователя SBC.

На следующей схеме показана схема SIP для входящего вызова в режиме AlwaysBypass, и пользователь является внешним.

> [!div class="mx-imgBorder"]
> ![Схема, на которой снова показана схема SIP.](media/direct-routing-media-op-13.png)

### <a name="only-for-local-users-mode"></a>Только для режима локальных пользователей

Кандидаты на локальные носители целевого SBC будут предлагаться только в том случае, если пользователь находится в том же расположении, что и SBC. Во всех остальных случаях мультимедиа будет проходить через внутренний или внешний IP-адрес прокси-сервера SBC.

Описаны следующие сценарии:

- [Исходящие вызовы и пользователь находится в том же расположении, что и SBC](#outbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-only-for-local-users)
- [Входящие вызовы и пользователь находится в том же расположении, что и SBC](#inbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-only-for-local-users)
- [Пользователь находится не в том же расположении, что и SBC, но находится в корпоративной сети.](#user-is-not-at-the-same-location-as-the-sbc-but-is-in-the-corporate-network-with-only-for-local-users)
- [Входящие вызовы и пользователь является внутренним, но не находится в том же расположении, что и SBC](#inbound-call-and-the-user-is-internal-but-is-not-at-the-same-location-as-the-sbc-with-only-for-local-users)

В следующей таблице показаны конфигурация и действие конечного пользователя:

|Физическое расположение пользователя|Пользователь выполняет или получает вызов на номер или из номера|Номер телефона пользователя|Политика сетевой маршрутизации голосовой связи|Режим, настроенный для SBC|
|---|---|---|---|---|
|Вьетнам|+84 4 3926  3000|+84 4 5555 5555|Приоритет 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br> Приоритет 2. .* — proxysbc.contoso.com|VNsbc.contoso.com — OnlyForLocalUsers Proxysbc.contoso.com — всегда обходить|

#### <a name="outbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-only-for-local-users"></a>Исходящие вызовы и пользователь находится в том же расположении, что и SBC только для локальных пользователей

|Режим|Пользователь|Сайт|Направление вызова|
|---|---|---|---|
|OnlyForLocalUsers|Internal|То же, что и SBC|Исходящее|

На следующей схеме показан исходящий вызов в режиме OnlyForLocalUsers, и пользователь находится в том же расположении, что и SBC. Это тот же поток, который отображается в [исходящих вызовах](#outbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass), когда пользователь находится в том же расположении, что и SBC.

> [!div class="mx-imgBorder"]
> ![На схеме снова показана схема SIP.](media/direct-routing-media-op-14.png)

#### <a name="inbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-only-for-local-users"></a>Входящие звонки и пользователь находится в том же расположении, что и SBC только для локальных пользователей

|Режим|Пользователь|Сайт|Направление вызова|
|---|---|---|---|
|OnlyForLocalUsers|Internal|То же, что и SBC|Входящих|

На следующей схеме показан входящий вызов в режиме OnlyForLocalUsers, и пользователь находится в том же расположении, что и SBC. Это тот же поток, что и во входящих вызовах, когда пользователь находится в том же расположении, что [и SBC](#inbound-calls-and-the-user-is-in-the-same-location-as-the-sbc-with-always-bypass).

> [!div class="mx-imgBorder"]
> ![Другая схема, показывающая схему SIP.](media/direct-routing-media-op-15.png)

#### <a name="user-is-not-at-the-same-location-as-the-sbc-but-is-in-the-corporate-network-with-only-for-local-users"></a>Пользователь находится не в том же расположении, что и SBC, но находится в корпоративной сети только для локальных пользователей.

|Режим|Пользователь|Сайт|Направление вызова|
|---|---|---|---|
|OnlyForLocalUsers|Internal|Отличается от SBC|Исходящее|

Прямая маршрутизация вычисляет X-MediaPath на основе сообщаемого расположения пользователя и режима, настроенного в SBC.

На следующей схеме показан исходящий вызов в режиме OnlyForLocalUsers и внутренний пользователь, который не находится в том же расположении, что и SBC.

> [!div class="mx-imgBorder"]
> ![На другой схеме показана схема SIP.](media/direct-routing-media-op-16.png)

#### <a name="inbound-call-and-the-user-is-internal-but-is-not-at-the-same-location-as-the-sbc-with-only-for-local-users"></a>Входящий звонок и пользователь является внутренним, но не находится в том же расположении, что и SBC только для локальных пользователей

|Режим|Пользователь|Сайт|Направление вызова|
|---|---|---|---|
|OnlyForLocalUsers|Internal|Отличается от SBC|Входящих|

На следующей схеме показан входящий вызов в режиме OnlyForLocalUsers и внутренний пользователь, который не находится в том же расположении, что и SBC.

> [!div class="mx-imgBorder"]
> ![Еще одна схема, показывающая схему SIP.](media/direct-routing-media-op-17.png)
