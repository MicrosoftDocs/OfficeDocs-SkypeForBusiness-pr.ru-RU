---
title: Оптимизация локальных носителей для прямой маршрутизации
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 04/07/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: filippse
search.appverid: MET150
f1.keywords:
- NOCSH
description: Оптимизация локальных носителей для прямой маршрутизации
appliesto:
- Microsoft Teams
ms.openlocfilehash: 29f18234cb836634ec30bfe9751b667fbab4fdd0
ms.sourcegitcommit: 296862e02b548f0212c9c70504e65b467d459cc3
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/25/2022
ms.locfileid: "65675931"
---
# <a name="plan-for-local-media-optimization-for-direct-routing"></a>Планирование оптимизации локальных носителей для прямой маршрутизации

Голосовые функции телефонной сети общего пользования (ТСОП) считаются критически важным для бизнеса приложением с высокими ожиданиями качества голосовой связи. Прямая маршрутизация позволяет управлять потоками трафика мультимедиа для размещения множества сетевых топологий и локальных настроек телефонии для различных предприятий по всему миру.

Оптимизация локальных носителей для прямой маршрутизации позволяет управлять качеством голоса с помощью:

- Управление потоком трафика мультимедиа между Teams клиентами и пограничными контроллерами сеансов клиента (SBC).
- Сохранение локального носителя в пределах подсетей корпоративной сети.
- Разрешение потоков мультимедиа между Teams клиентами и контроллерами SBC, даже если контроллеры SBC находятся за корпоративными брандмауэрами с частными IP-адресами и не видны корпорации Майкрософт напрямую.

Оптимизация локальных носителей поддерживает два сценария:

- Централизация всех локальных магистралей через централизованный SBC, подключенный к основной магистрали протокола Инициации сеансов (SIP), обеспечивая услуги телефонии для всех локальных филиалов компании.

- Создание топологии виртуальных сетей SBC, где контроллеры SBC в локальных филиалах подключены к централизованному прокси-серверу SBC, который является видимым и взаимодействует с Телефон (Майкрософт) System через свой внешний IP-адрес. В топологии виртуальной сети подчиненные контроллеры безопасности взаимодействуют через внутренние IP-адреса и не видны телефонная система.

В этой статье описываются функциональные возможности функций, сценарии и решения клиентов. Дополнительные сведения о конфигурации см. в разделе ["Настройка оптимизации локального носителя"](direct-routing-media-optimization-configure.md).

  > [!NOTE]
  > Если вы хотите сохранить локальный носитель в пределах интрасети, рекомендуется оптимизировать локальные носители. Если у вас уже есть обход сервера-посредника и вы используете только общедоступные IP-адреса своих контроллеров SBC, переход на оптимизацию локальных носителей не является обязательным. Вы можете продолжать использовать обход сервера-посредника. Дополнительные сведения см. в [разделе Plan Media Bypass](direct-routing-plan-media-bypass.md).

Сведения о том, какие поставщики SBC поддерживают оптимизацию локальных носителей, см. в разделе "Пограничные контроллеры сеансов", [сертифицированные для прямой маршрутизации](direct-routing-border-controllers.md).

## <a name="supported-customer-scenarios"></a>Поддерживаемые сценарии клиентов

В рамках этого обсуждения предположим, что Компания Contoso запускает несколько компаний по всему миру следующим образом. (Обратите внимание, что регионы Европы и APAC используются только в качестве примеров. Компания может иметь несколько разных регионов с аналогичными требованиями.)

- **В Европе** у компании Contoso есть офисы примерно в 30 странах. Каждый офис имеет собственную частную ветвь Exchange (УАТС).

  Компании Contoso была предложена возможность централизовать магистрали в одном расположении — Амстердаме — для всех 30 офисов в Европе. Компания Contoso развернула SBC в Амстердаме, предоставила достаточную пропускную способность для выполнения вызовов через централизованное расположение, подключила центральную магистраль SIP к централизованному расположению и начала обслуживать все европейские расположения из Амстердама.

- **В регионе APAC** contoso имеет несколько офисов в разных странах.

  Во многих странах компания по-прежнему использует магистрали СДМ в локальных филиалах. Централизация магистралей TDM не является вариантом в регионе APAC, поэтому переключение на SIP невозможно. Предположим, что в регионе APAC имеется более 50 филиалов Contoso с сотнями шлюзов (SBC). В этом сценарии невозможно связать все шлюзы с интерфейсом прямой маршрутизации из-за отсутствия общедоступных IP-адресов и (или) локальных выходов в Интернет. Кроме того, в некоторых странах применяются нормативные требования, которые не могут быть выполнены без подключения к локальной сети ТСОП.

В соответствии с бизнес-требованиями компания Contoso реализовала два решения с оптимизацией локальных носителей для прямой маршрутизации:

- **В Европе** все магистрали являются централизованными и потоками мультимедиа между центральным SBC и пользователями в зависимости от расположения пользователя.

  - Если пользователь подключен к локальной подсети корпоративной сети (т. е. является внутренним), то мультимедиа передается между внутренним IP-адресом центрального SBC и клиентом Teams пользователя.

  - Если пользователь находится за пределами корпоративной сети ( например, если пользователь использует общедоступное беспроводное подключение к Интернету), то пользователь считается внешним. В этом случае мультимедиа передается между внешним IP-адресом центрального SBC и Teams клиентом.

- В регионе **APAC** централизованный прокси-сервер SBC связан с прямой маршрутиза службой Microsoft, которая направляет мультимедиа между интерфейсом прямой маршрутизации и подчиненными контроллерами SBC в локальных филиалах.

  Подчиненные контроллеры SBC в локальных филиалах не видны прямой маршрутизации в APAC, но они связаны с помощью командлета Set-CSOnlinePSTNGateway для создания топологии виртуальной сети в Телефон (Майкрософт) System. Носитель всегда остается локальным по возможности. Внешние пользователи имеют поток мультимедиа между клиентом Teams и общедоступным IP-адресом прокси-сервера SBC.

## <a name="central-sbc-with-centralized-trunks"></a>Центральный SBC с централизованными магистралями

Чтобы создать решение, в котором службы ТСОП предоставляются всем локальным филиалам через единый центральный SBC с подключенной централизованной магистралью SIP, администратор клиента Contoso сопоирует один SBC (centralsbc.contoso.com) со службой; К SBC подключена централизованная магистраль SIP.

- Когда пользователь находится во внутренней сети компании, SBC предоставляет внутренний IP-адрес SBC для мультимедиа.

- Если пользователь находится за пределами корпоративной сети, SBC предоставляет внешний (общедоступный) IP-адрес SBC.

> [!NOTE]
> Все значения в примерах, таблицах или схемах представлены только в целях иллюстрации.

Таблица 1. Примеры сетевых параметров для контроллеров безопасности

| Местоположение | Полное доменное имя SBC | Внутренняя подсеть | Внешний NAT (доверенный IP-адрес) | Внешний IP-адрес SBC | Внутренний IP-адрес SBC |
|:------------|:-------|:-------|:-------|:-------|:-------|
| Амстердам | centralsbc.contoso.com | 192.168.5.0/24 | 172.16.76.73 | 172.16.76.71 | 192.168.5.5 |
| Германия | Не развернуто | 192.168.6.0/24 | 172.16.76.74 | Не развернуто |  Не развернуто |
| Франция | Не развернуто | 192.168.7.0/24 | 172.16.76.75 | Не развернуто |  Не развернуто |

### <a name="internal-user"></a>Внутренний пользователь

На следующей схеме показан поток трафика, когда пользователь подключен к корпоративной сети в домашнем филиале или на сайте пользователя.

В локальной среде пользователь назначается локальному филиалу в Германии. Пользователь выполняет телефонный вызов прямой маршрутизации через Teams.

- Клиент Teams пользователя взаимодействует с телефонная система непосредственно через REST API, но мультимедиа, созданный во время вызова, передается на внутренний IP-адрес центрального SBC.

- SBC перенаправляет поток в телефонная система подключенную сеть ТСОП.

- Центральный SBC виден для телефонная система только через внешний IP-адрес.

Схема 1. Поток трафика, когда пользователь находится на домашнем сайте с централизованным SBC и подключенной централизованной магистралью SIP

![Схема, показывающая оптимизацию локального носителя в потоке трафика.](media/direct-routing-media-op-1.png "Поток трафика, когда пользователь находится на домашнем сайте с централизованным SBC с подключенной централизованной магистралью SIP")


### <a name="external-user"></a>Внешний пользователь

На следующей схеме показан поток трафика, когда пользователь не находится в локальной среде и не подключен к корпоративной сети (то есть устройство пользователя подключено к Интернету через мобильное устройство или общедоступную сеть Wi-Fi). Пользователь выполняет телефонный вызов прямой маршрутизации через Teams:

- Клиент Teams пользователя взаимодействует с телефонная система через REST API, но в данном случае мультимедиа, созданный во время вызова, передается на внешний IP-адрес центрального SBC.

- SBC перенаправляет поток в телефонная система подключенную сеть ТСОП.

- Центральный SBC виден для телефонная система только через внешний IP-адрес.

В этом случае поведение аналогично тому, является ли пользователь локальным в филиале в Германии или в любом другом филиале. Пользователь считается внешним, так как он находится за пределами корпоративной сети.

Схема 2. Поток трафика, когда пользователь является внешним с централизованным SBC и с подключенной централизованной магистралью SIP

![На схеме показана оптимизация локального носителя для потока трафика.](media/direct-routing-media-op-2.png "Поток трафика, когда пользователь является внешним в случае централизованного SBC с подключенной централизованной магистралью SIP")

## <a name="proxy-sbc-with-connected-downstream-sbcs"></a>Прокси-сервер SBC с подключенными подчиненными контроллерами SBC

Чтобы создать решение, в котором службы ТСОП предоставляются во всех локальных филиалах в регионе APAC, где централизация магистралей TDM не является вариантом, администратор Contoso связывает один SBC (proxysbc.contoso.com), также называемый прокси-сервером SBC, со службой прямой маршрутизации.

После этого администратор Contoso добавляет некоторые нисходящие пакеты SBC, указывающие, что их можно получить через прокси-сервер SBC proxysbc.contoso.com. Подчиненные SBC не имеют общедоступных IP-адресов, однако их можно назначить голосовым маршрутам. В таблице ниже показаны примеры параметров сети и конфигурации.

Когда пользователь находится в локальном филиале, где находится подчиненный SBC, трафик мультимедиа проходит между пользователем и локальным подчиненным SBC напрямую. Если пользователь находится за пределами офиса (в общедоступном Интернете), мультимедиа передается от пользователя к общедоступному IP-адресу прокси-сервера SBC, который передает его на соответствующие подчиненные SBC.

Таблица 2. Пример сведений о сети SBC

| Местоположение | Полное доменное имя SBC | Внутренняя подсеть | Внешний NAT (доверенный IP-адрес) | Внешний IP-адрес SBC  | Внутренний IP-адрес SBC |
|:------------|:-------|:-------|:-------|:-------|:-------|
| Вьетнам | VNsbc.contoso.com | 192.168.1.0/24 | 172.16.240.110 | Нет |  192.168.1.5 |
| Индонезия  | IDsbc.contoso.com | 192.168.2.0/24 | 172.16.240.120 | Нет |  192.168.2.5 |
| Сингапур | proxysbc.contoso.com |   192.168.3.0/24 | 172.16.240.130 | 172.16.240.133 | 192.168.3.5 |



### <a name="internal-user"></a>Внутренний пользователь

На следующей схеме показан высокоуровневый поток трафика для сценария, когда пользователь находится внутри офиса в регионе APAC.
Пользователь, назначенный локальному филиалу в Вьетнаме, совершает телефонный вызов прямой маршрутизации через Teams.

- Клиент Teams пользователя взаимодействует с телефонная система через REST API, но мультимедиа, созданный во время потока вызовов на внутренний IP-адрес локального SBC.

- Локальный SBC перенаправляет поток на прокси-сервер SBC в Сингапуре и в подключенную локальную сеть ТСОП.

-  Прокси-сервер SBC отображается телефонная система только через внешний IP-адрес и направляет поток из подчиненного SBC (в данном случае локального SBC во Телефонная система).

- Подчиненный SBC в локальном филиале не виден непосредственно телефонная система но сопоставляется в топологии виртуальной сети, определенной администратором Contoso при настройке оптимизации локального носителя.

> [!NOTE]
> Поведение локальных и не локальных пользователей может отличаться в зависимости от настроенного режима оптимизации локального носителя.

Дополнительные сведения о возможных режимах и соответствующем поведении см. в разделе "Настройка оптимизации локального носителя".

Схема 3. Поток трафика, когда пользователь находится в "домашней" сети с прокси-сервером SBC и подключенными подчиненными SBC

! [Схема, на которой снова показана оптимизация локального носителя для потока трафика.] (media/direct-routing-media-op-3.png "Поток трафика в случае прокси-сервера SBC с подключенными подчиненными контроллерами безопасности, когда пользователь находится в "домашней" сети)

### <a name="external-user"></a>Внешний пользователь

На следующей схеме показан поток трафика, когда пользователь находится за пределами корпоративной сети. Пользователь не находится в локальной среде (не находится в пределах корпоративной сети). Пользователь выполняет телефонный вызов прямой маршрутизации Teams на номер телефона в Вьетнаме.

- Клиент Teams пользователя взаимодействует с телефонная система через REST API, но мультимедиа, созданный во время вызова, сначала передается на внешний IP-адрес прокси-сервера SBC в Сингапуре.

- В зависимости от конфигурации и политик голосовой [](direct-routing-media-optimization-configure.md) связи (дополнительные сведения см. в разделе "Настройка оптимизации локального носителя"), прокси-сервер SBC перенаправляет поток в подчиненный SBC во Вьетнаме.

- Подчиненный SBC в Вьетнаме перенаправляет поток в подключенную локальную сеть ТСОП.

- Прокси-сервер SBC виден для телефонная система только через внешний IP-адрес.

-  Подчиненный SBC в локальном филиале не виден телефонная система напрямую, но сопоставляется в топологии виртуальной сети, определенной администратором Contoso при настройке оптимизации локальных носителей. В этом примере пользователь считается внешним, так как он находится за пределами корпоративной сети.

Схема 4. Поток трафика, когда пользователь является внешним с прокси-сервером SBC и подключенными подчиненными контроллерами SBC

![На схеме снова показана оптимизация локального носителя для потока трафика.](media/direct-routing-media-op-4.png "Поток трафика в случае прокси-сервера SBC с подключенными подчиненными контроллерами SBC, когда пользователь является внешним")

## <a name="local-media-optimization-modes"></a>Локальные режимы оптимизации мультимедиа

Оптимизация локального носителя поддерживает два режима:

- **Режим 1. Всегда обходить**. В этом случае, если пользователь является внутренним, мультимедиа будет проходить через внутренний IP-адрес локального подчиненного SBC независимо от фактического расположения внутреннего пользователя; Например, в том же филиале, где находится подчиненный SBC, или в другом филиале.

- **Режим 2. Только для локальных пользователей**. В этом режиме носитель будет перенаться непосредственно на внутренний IP-адрес локального подчиненного SBC только при создании внутренним пользователем, расположенным в том же филиале, что и подчиненный SBC.

Чтобы различать режимы оптимизации локальных носителей, администратору клиента необходимо задать для параметра -BypassMode значение Always или OnlyForLocalUsers для каждого SBC с помощью командлета Set-CSonlinePSTNGateway. Дополнительные сведения см. в [разделе "Настройка оптимизации локального носителя"](direct-routing-media-optimization-configure.md).

> [!NOTE]
> Если пользователи являются внутренними, требуется подключение к мультимедиа между пользователем и SBC по внутреннему **IP-адресу**. В этом случае отката к ретрансляторам общедоступного транспорта для мультимедиа не существует, так как SBC будет предоставлять внутренний IP-адрес для подключения к мультимедиа.

### <a name="mode-1-always-bypass"></a>Режим 1. Всегда обходить

Если у вас есть хорошее подключение между филиалами, рекомендуемый режим — всегда обходить.

Например, предположим, что у компании есть централизованная магистраль SIP в Амстердаме, которая обслуживает 30 стран и обеспечивает хорошее подключение между всеми 30 сайтами и локальными пользователями. Также существует ветвь в Германии, в которой развернут локальный SBC.

SBC в Германии можно настроить в режиме "Всегда обходить". Пользователи, независимо от их расположения, будут подключаться к SBC напрямую через внутренний IP-адрес SBC (например, из Франции в Германии; см. схему ниже для справки).

Ниже описаны два сценария.

- Сценарий 1. Пользователь находится в том же расположении, что и SBC, определенный в политике маршрутизации голосовой связи по сети.

- Сценарий 2. Пользователь и шлюзы находятся на разных сайтах.

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-the-online-voice-routing-policy"></a>Сценарий 1. Пользователь находится в том же расположении, что и SBC, определенный в политике маршрутизации голосовой связи в Сети

SBC в Амстердаме настроен как прокси-сервер SBC для локального подчиненного SBC в Германии. Пользователь находится в Германии в той же подсети, что и корпоративная сеть локального SBC. Оба SBC (прокси-сервер и подчиненный) настроены для режима Always Bypass. Политики сетевой маршрутизации голосовой связи указывают, что в случае вызовов в Германии (с кодом области +49) они должны быть перенаправлены в локальный SBC в Германии. Все остальные вызовы , а также в случае сбоя SBC в Германии, вызовы в Германии, должны быть перенаправлены на прокси-сервер SBC в Амстердаме. В следующей таблице приведен пример конфигурации.

Таблица 3. Пример конфигурации для сценария 1

| Физическое расположение пользователя | Пользователь совершает звонок на номер | Политика сетевой маршрутизации голосовой связи | Режим, настроенный для SBC | Media Flow |
|:------------|:-------|:-------|:-------|:-------|
| Германия | +49 1 437 2800 | Приоритет 1: ^\+49(\d{8})$ -DEsbc.contoso.com<br>Приоритет 2. .* — proxysbc.contoso.com| DEsbc.contoso.com — всегда обходить <br>proxysbc.contoso.com — всегда обходить | Teams пользователя <–> DEsbc.contoso.com |

На схеме ниже показан высокоуровневый поток трафика для внутреннего пользователя в Германии, выполняющего телефонный вызов прямой маршрутизации Teams на номер в Германии.

- Клиент клиента Teams взаимодействует с телефонная система непосредственно через REST API.

- Носитель, созданный во время вызова, передается на внутренний IP-адрес локального SBC.

- Локальный SBC перенаправляет поток на прокси-сервер SBC в Амстердаме и в подключенную локальную сеть ТСОП.

- Прокси-сервер SBC отображается телефонная система только через внешний IP-адрес и направляет поток из подчиненного SBC (в данном случае локального SBC в Германии) в телефонная система.

- Подчиненный SBC в локальном филиале не виден непосредственно телефонная система но сопоставляется в топологии виртуальной сети, определенной администратором Contoso при настройке оптимизации локального носителя.


Схема 5.  Поток трафика в режиме "Всегда обходить", а пользователь находится на "домашнем" сайте

! [Схема, показывающая оптимизацию локального носителя для потока трафика.] (media/direct-routing-media-op-5.png "Поток трафика с режимом "Всегда обходить", а пользователь находится на домашнем сайте)


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>Сценарий 2. Пользователь и шлюзы находятся на разных сайтах

SBC в Амстердаме настроен как прокси-сервер SBC для локального подчиненного SBC в Германии. Оба SBC (прокси-сервер и подчиненный) настроены для режима Always Bypass. Внутренний пользователь во Франции, расположенный в локальном филиале, выполняет вызов прямой маршрутизации в Германии. Политики сетевой маршрутизации голосовой связи указывают, что вызовы в Германии (с кодом области +49) должны перенаправляться в локальный SBC в Германии. Все остальные вызовы ( а в случае сбоя SBC в Германии — все вызовы в Германии) должны быть перенаправлены на прокси-сервер SBC в Амстердаме. В следующей таблице приведен пример конфигурации.

Таблица 4. Пример конфигурации для сценария 2

| Физическое расположение пользователя | Пользователь совершает звонок на номер | Политика сетевой маршрутизации голосовой связи | Режим, настроенный для SBC | Media Flow |
|:------------|:-------|:-------|:-------|:-------|
| Франция | +49 1 437 2800 | Приоритет 1: ^\+49(\d{8})$ -DEsbc.contoso.com <br>Приоритет 2. .* — proxysbc.contoso.com |  DEsbc.contoso.com — всегда обходить proxysbc.contoso.com — всегда обходить | Teams пользователя <— > DEsbc.contoso.com  |

На следующей схеме показан высокоуровневый поток трафика, когда внутренний немецкий пользователь, расположенный во Франции, выполняет телефонный вызов прямой маршрутизации Teams номеру в Германии.

- Клиент клиента Teams взаимодействует с телефонная система непосредственно через REST API.

- Носитель, созданный во время вызова, передается непосредственно в SBC во внутреннем IP-адресе Германии.

- SBC в Германии перенаправляет поток на прокси-сервер SBC в Амстердаме и в подключенную локальную сеть ТСОП.

Схема 6.  Поток трафика в режиме "Всегда обходить", и пользователь находится не на "домашнем" сайте, а во внутренней сети

! [Схема, показывающая оптимизацию локального носителя для потока трафика.] (media/direct-routing-media-op-6.png "Поток трафика с режимом "Всегда обходить", и пользователь находится не на "домашнем" сайте, а во внутренней сети)

### <a name="mode-2-only-for-local-users"></a>Режим 2. Только для локальных пользователей

Если между локальными филиалами существуют недопустимые подключения, но между каждым локальным филиалом и региональным офисом есть хорошие подключения, рекомендуется использовать режим "Только для локальных пользователей".

Например, в регионе APAC предположим, что компания Contoso имеет несколько офисов в разных странах. Во многих странах переход на SIP невозможен, так как в компании по-прежнему есть магистрали TDM во многих локальных филиалах. Централизация магистралей TDM не является вариантом в регионе APAC. Кроме того, в регионе APAC имеется более 50 филиалов Contoso с сотнями шлюзов (SBC).

Чтобы создать решение, в котором службы ТСОП предоставляются во всех локальных филиалах в регионе APAC, где централизация магистралей TDM не является вариантом, администратор Contoso сопоирует один региональный SBC в Сингапуре в качестве прокси-сервера SBC со службой прямой маршрутизации. Прямое подключение между локальными филиалами не является хорошим, но существует хорошее соединение между каждым локальным филиалом и региональным SBC в Сингапуре. Для регионального SBC администратор выбирает режим "Всегда обходить", а для локальных подчиненных контроллеров SBC — режим "Только для локальных пользователей".

Ниже описаны два сценария.

- Сценарий 1. Пользователь находится в том же расположении, что и SBC, определенный в политике маршрутизации голосовой связи в Сети

- Сценарий 2. Пользователи и шлюзы находятся на разных сайтах

#### <a name="scenario-1-the-user-is-in-the-same-location-as-the-sbc-defined-in-online-voice-routing-policy"></a>Сценарий 1. Пользователь находится в том же расположении, что и SBC, определенный в политике маршрутизации голосовой связи в Сети.

Предположим, что SBC в Сингапуре настроен как прокси-сервер SBC для локальных подчиненных контроллеров SBC в Вьетнаме и Индонезии. Пользователь находится в Вьетнаме в том же расположении, что и локальный SBC. Политики сетевой маршрутизации голосовой связи указывают, что вызовы в Вьетнаме (с кодом области +84) должны перенаправляться в локальный SBC во Вьетнаме. Все остальные вызовы и, если SBC во Вьетнаме завершается сбоем, вызовы в Вьетнаме должны быть перенаправлены на прокси-сервер SBC в Сингапуре. В следующей таблице приведен пример конфигурации.

Таблица 5. Пример конфигурации для сценария 1 режима "Только для локальных пользователей"

| Физическое расположение пользователя | Пользователь совершает звонок на номер | Политика сетевой маршрутизации голосовой связи | Режим, настроенный для SBC | Media Flow |
|:------------|:-------|:-------|:-------|:-------|
| Вьетнам | +84 4 3926 3000 | Приоритет 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br>Приоритет 2. .* — proxysbc.contoso.com | VNsbc.contoso.com — только для локальных пользователей <br> proxysbc.contoso.com — всегда обходить | Teams < > VNsbc.contoso.com |

На следующей схеме пользователь, назначенный локальному филиалу в Вьетнаме, выполняет телефонный вызов прямой маршрутизации через Teams.

- Клиент клиента Teams взаимодействует с телефонная система непосредственно через REST API.

- Носитель, созданный во время потока вызова на внутренний IP-адрес локального SBC.

- Локальный SBC перенаправляет поток на прокси-сервер SBC в Сингапуре и в подключенную локальную сеть ТСОП.

- Прокси-сервер SBC отображается телефонная система только через внешний IP-адрес и направляет поток из подчиненного SBC (в данном случае локальный SBC во Телефонная система).

- Подчиненный SBC в локальном филиале не виден телефонная система напрямую, но сопоставлен в топологии виртуальной сети.

Схема 7. Поток трафика в режиме "Только для локальных пользователей", а пользователь находится на "домашнем" сайте

! [Другая схема, показывающая оптимизацию локального носителя для потока трафика.] (media/direct-routing-media-op-7.png "Traffic flow with "Only For Local Users" mode and user is in "home" site)


#### <a name="scenario-2-the-user-and-gateways-are-in-different-sites"></a>Сценарий 2. Пользователи и шлюзы находятся на разных сайтах

Предположим, что SBC в Сингапуре настроен как прокси-сервер SBC для локальных подчиненных контроллеров SBC в Вьетнаме и Индонезии. Внутренний пользователь в Индонезии, расположенный в локальном филиале, выполняет прямой вызов маршрутизации в Вьетнам. Политики сетевой маршрутизации голосовой связи указывают, что вызовы в Вьетнам (с кодом области +84) должны перенаправляться в локальный SBC во Вьетнаме. Все остальные вызовы , а в случае сбоя SBC в Вьетнаме вызовы к Вьетнаму, должны быть перенаправлены на прокси-сервер SBC в Сингапуре. Для прокси-сервера SBC в Сингапуре установлен режим "Всегда обходить", а для локального SBC в Вьетнаме — режим "Только для локальных пользователей". В следующей таблице приведен пример конфигурации.

Таблица 6. Пользовательская конфигурация

| Физическое расположение пользователя | Пользователь совершает звонок на номер | Политика сетевой маршрутизации голосовой связи | Режим, настроенный для SBC | Media Flow |
|:------------|:-------|:-------|:-------|:-------|
| Индонезия | +84 4 3926 3000 | Приоритет 1: ^\+84(\d{9})$ -VNsbc.contoso.com <br> Приоритет 2. .* — proxysbc.contoso.com |VNsbc.contoso.com — только для локальных пользователей <br> proxysbc.contoso.com — всегда обходить | Teams пользователя <–> proxysbc.contoso.com <–> VNsbc.contoso.com |


На следующей схеме внутренний пользователь, находясь в локальной среде в филиале "Индонезия", совершает телефонный звонок прямой маршрутизации через Teams на номер в Вьетнаме.

- Клиент клиента Teams взаимодействует с телефонная система непосредственно через REST API.

- Носитель, созданный во время потоков вызова, сначала используется внутренний IP-адрес SBC прокси-сервера.

- Прокси-сервер SBC в Сингапуре перенаправляет поток на внутренний IP-адрес подчиненного SBC в Вьетнаме и телефонная система.

- Подчиненный SBC в Вьетнаме направляет поток в подключенную локальную сеть ТСОП.

- Прокси-сервер SBC виден для телефонная система только через внешний IP-адрес.

- Подчиненные контроллеры SBC в локальных филиалах не видны телефонная система напрямую, но сопоставляются в топологии виртуальной сети.

Схема 8.  Поток трафика в режиме "Только для локальных пользователей", и пользователь находится не на "домашнем" сайте, а во внутренней сети

! [На другой схеме показана оптимизация локального носителя для потока трафика.] (media/direct-routing-media-op-8.png "Traffic flow with "Only For Local Users" mode, user is not in "home" site but in internal network)

## <a name="known-issues"></a>Известные проблемы

Ниже приведен список известных проблем, которые в настоящее время присутствуют в оптимизации локальных носителей. Корпорация Майкрософт работает над устранением этих проблем.

| Ошибка | Решение |
| :--- | :--- |
| Teams клиент не идентифицируется как внутренний,  Teams общедоступный IP-адрес клиента соответствует списку надежных IP-адресов клиента. | Для оптимизации локального носителя требуется, чтобы Teams клиентская подсеть совпадала с настроенной клиентом [сетевой подсетью.](/powershell/module/skype/new-cstenantnetworksubnet)|
| Эскалация вызовов приводит к удалению вызовов, Teams клиент определяется как внутренний.| Отключите оптимизацию локальных носителей в SBC прямой маршрутизации.|
| Эскалация вызовов от 1 до 1 между внутренними клиентами в многопользовательский вызов с внешним клиентом или ресурсом приводит к удаленным вызовам | Работа над исправлением выполняется. Кроме того, можно отключить оптимизацию локальных носителей в SBC прямой маршрутизации.|
| Teams переводит вызов на удержание. Музыка воспроизводится на конце ТСОП, и выполняется оптимизация локальных носителей. Пользователь Teams возобновляет вызов. Вызов ТСОП возобновляется, но оптимизация локального носителя не работает, и вызов продолжается через центральный (прокси-сервер) SBC. | Когда пользователь вызывает вызов, чтобы инициировать музыку при удержании (MoH), он передается с 1:1 на многопользовательский вызов контроллера вызовов для вызова контроллера мультимедиа и обработчика мультимедиа (который выступает в качестве avMCU mixer), через который MoH достигает пользователя, которого поместили на удержание. Отмена эскалации до вызова 1:1 после возобновления вызова никогда не происходит согласно проекту. Отключите оптимизацию локальных носителей в SBC прямой маршрутизации.|
|Пока звонок устанавливается в течение нескольких секунд, пользователь может услышать тишину.| Из-за сложности архитектуры оптимизации локальных носителей это может произойти в некоторых случаях.|
|Голосовые приложения (например, автосекретарь, очередь вызовов) не работают.| LMO не поддерживает голосовые приложения, так как они находятся в облаке и требуют внешнего подключения. Пока обходного решения нет.|
