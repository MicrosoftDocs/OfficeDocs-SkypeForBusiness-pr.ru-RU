---
title: SBA прямой маршрутизации
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 12/08/2020
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: crowe
search.appverid: MET150
f1.keywords:
- NOCSH
- ms.teamsadmincenter.directrouting.overview
description: Узнайте больше о прямой маршрутизации, таких как конфигурация, необходимые основные решения по развертыванию и рекомендации по маршрутизации голосовой связи.
ms.custom:
- seo-marvel-apr2020
- seo-marvel-jun2020
appliesto:
- Microsoft Teams
ms.openlocfilehash: 976c73aebe698152c4824e3eaedfcc19a13ae525
ms.sourcegitcommit: 1be178dc3b34575e1914e629f004f897c02e0097
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/28/2022
ms.locfileid: "68138492"
---
# <a name="survivable-branch-appliance-sba-for-direct-routing"></a>Устройство для обеспечения связи с филиалами (SBA) для прямой маршрутизации


Иногда сайт клиента, использующий прямую маршрутизацию для подключения к телефонной системе Майкрософт, может привести к сбою Интернета.

Предположим, что сайт клиента , называемый ветвью, временно не может подключиться к облаку Майкрософт через прямую маршрутизацию. Однако интрасеть внутри ветви по-прежнему полностью работоустрона, и пользователи могут подключаться к пограничному контроллеру сеансов (SBC), который обеспечивает подключение по ТСОП.

В этой статье описывается, как использовать устройство для обеспечения связи филиалов (SBA), чтобы телефонная система Майкрософт продолжает совершать и принимать звонки по ТСОП в случае сбоя.

## <a name="prerequisites"></a>Необходимые компоненты

SBA — это распространяемый код, предоставляемый корпорацией Майкрософт поставщикам SBC, которые затем внедряют код во встроенное ПО или распространяют его отдельно для запуска SBA на отдельной виртуальной машине или оборудовании. 

Чтобы получить последнюю версию встроенного ПО пограничного контроллера сеансов с внедренным устройством для обеспечения связи в филиалах, обратитесь к поставщику SBC. Кроме того, требуется следующее:

- Необходимо настроить SBC для обхода сервера-посредника, чтобы клиент Microsoft Teams на сайте филиала может иметь поток мультимедиа непосредственно с SBC. 

- TLS1.2 должен быть включен в ОС виртуальной машины SBA.
- Порты 3443, 4444 и 8443 используются Microsoft SBA Server для взаимодействия с клиентом Teams и должны быть разрешены в брандмауэре. 
- Порт 5061 (или настроенный в SBC) используется Microsoft SBA Server для взаимодействия с SBC и должен быть разрешен в брандмауэре. 
- UDP-порт 123 используется Microsoft SBA Server для связи с NTP-сервером и должен быть разрешен в брандмауэре.
- Порт 443 используется Microsoft SBA Server для связи с Microsoft 365 и должен быть разрешен в брандмауэре.
- Диапазоны IP-адресов Azure и теги служб для общедоступного облака должны быть определены в соответствии с рекомендациями, описанными в следующих разделах: https://www.microsoft.com/download/details.aspx?id=56519

## <a name="supported-teams-clients"></a>Поддерживаемые клиенты Teams

Функция SBA поддерживается на следующих клиентах Microsoft Teams: 

- Рабочий стол Microsoft Teams для Windows 

- Настольный компьютер Microsoft Teams для macOS
- Teams для мобильных устройств 
- Телефоны Teams

## <a name="how-it-works"></a>Принципы работы

Во время сбоя в Интернете клиент Teams должен автоматически переключиться на SBA, а текущие вызовы должны продолжаться без прерываний. Никаких действий от пользователя не требуется. Как только клиент Teams обнаружит, что Интернет работает и все исходящие вызовы будут завершены, клиент снова перейдите в обычный режим работы и подключитесь к другим службам Teams. SBA будет отправлять собранные записи данных о звонках в облако, и журнал вызовов будет обновлен, чтобы эти сведения были доступны для проверки администратором клиента. 

Если клиент Microsoft Teams находится в автономном режиме, доступны следующие функции, связанные с вызовами: 

- Выполнение вызовов ТСОП через локальный SBA или SBC с потоком мультимедиа через SBC.

- Получение вызовов ТСОП через локальный SBA или SBC с потоком мультимедиа через SBC. 

- Удержание и возобновление вызовов ТСОП.

## <a name="configuration"></a>Конфигурация

Для работы функции SBA клиент Teams должен знать, какие SBA доступны на каждом сайте филиала и какие SBA назначаются пользователям на этом сайте. Ниже приведены шаги по настройке.

1. Создайте SBAs.
2. Создайте политику устойчивости ветви Teams.
3. Назначьте политику пользователям.
4. Зарегистрируйте приложение для SBA в Azure Active Directory.

Вся настройка выполняется с помощью Skype для бизнеса Командлетов PowerShell Online. (Центр администрирования Teams пока не поддерживает функцию SBA прямой маршрутизации.) 

(Сведения о настройке SBC со ссылками на документацию поставщика SBC см. в разделе "Конфигурация пограничного контроллера сеансов" в конце этой статьи.)

### <a name="create-the-sbas"></a>Создание баз данных SBAs

Чтобы создать SBAs, вы будете использовать New-CsTeamsSurvivableBranchAppliance командлета. Этот командлет имеет следующие параметры:

| Параметр| Описание |
| :------------|:-------|
| Identity  | Удостоверение SBA  |
| Fqdn | Полное доменное имя SBA |
| Сайт | TenantNetworkSite, где находится SBA |
| Описание | Текст в свободном формате |
|||

Например:

``` powershell
C:\> New-CsTeamsSurvivableBranchAppliance  -Fqdn sba1.contoso.com -Description "SBA 1" 
Identity    : sba1.contoso.com 
Fqdn        : sba1.contoso.com 
Site        : 
Description : SBA 1 
```

### <a name="create-the-teams-branch-survivability-policy"></a>Создание политики устойчивости филиалов Teams 

Чтобы создать политику, используйте командлет New-CsTeamsSurvivableBranchAppliancePolicy. Этот командлет имеет следующие параметры. Обратите внимание, что политика может содержать один или несколько SBAs.

| Параметр| Описание |
| :------------|:-------|
| Identity | Удостоверение политики |
| BranchApplianceFqdns  | Полное доменное имя SBA на сайте |
||

Например:

``` powershell
C:\> new-CsTeamsSurvivableBranchAppliancePolicy -Identity CPH -BranchApplianceFqdns "sba1.contoso.com","sba2.contoso.com" 
Identity             : Tag:CPH 
BranchApplianceFqdns : {sba1.contoso.com, sba2.contoso.com} 
```

Вы можете добавить или удалить SBAs из политики с помощью Set-CsTeamsSurvivableBranchAppliancePolicy командлета. Например: 

``` powershell
Set-CsTeamsSurvivableBranchAppliancePolicy -Identity CPH -BranchApplianceFqdns @{remove="sba1.contoso.com"} 
Set-CsTeamsSurvivableBranchAppliancePolicy -Identity CPH -BranchApplianceFqdns @{add="sba1.contoso.com"} 
```

### <a name="assign-a-policy-to-a-user"></a>Назначение политики пользователю

Чтобы назначить политику отдельным пользователям, используйте Grant-CsTeamsSurvivableBranchAppliancePolicy командлета. Этот командлет имеет следующие параметры:

| Параметр| Описание |
| :------------|:-------|
| Identity | Удостоверение пользователя |
| PolicyName | Удостоверение политики |
||

Например:

``` powershell
C:\> Grant-CsTeamsSurvivableBranchAppliancePolicy -PolicyName CPH -Identity user@contoso.com 
```

Вы можете удалить политику у пользователя, предоставив $Null, как показано в следующем примере:

``` powershell
C:\> Grant-CsTeamsSurvivableBranchAppliancePolicy -PolicyName $Null -Identity user@contoso.com 
```

### <a name="register-an-application-for-the-sba-with-azure-active-directory"></a>Регистрация приложения для SBA в Azure Active Directory

Чтобы разрешить различным SBA, используемым в клиенте, считывать необходимые данные из Microsoft 365, необходимо зарегистрировать приложение для SBA в Azure Active Directory. 

Дополнительные сведения о регистрации приложения см. в следующих статьях:

- [Разработка бизнес-приложений для Azure Active Directory](/azure/active-directory/manage-apps/developer-guidance-for-integrating-applications)

- [Зарегистрируйте приложение в платформа удостоверений Майкрософт](/azure/active-directory/develop/quickstart-register-app).  

Вам нужно зарегистрировать только одно приложение для использования всеми SBAs в клиенте. 

Для регистрации SBA требуются следующие значения, созданные регистрацией: 

- Идентификатор приложения (клиента) 
- Секрет клиента 

Для приложения SBA учитывайте следующее: 

- Имя может быть любым, что вы решаете.  
- Поддерживаемые типы учетных записей = учетная запись только в этом каталоге организации. 
- URI веб-перенаправления = https://login.microsoftonline.com/common/oauth2/nativeclient.
- Неявные маркеры предоставления = маркеры доступа и маркеры идентификаторов. 
- API permissions = Skype and Teams Tenant Администратор Access -> Application permissions -> application_access_custom_sba_appliance.
- Секрет клиента: можно использовать любое описание и срок действия. 
- Не забудьте скопировать секрет клиента сразу после его создания. 
- Идентификатор приложения (клиента) отображается на вкладке "Обзор".

Затем выполните следующие действия.

1. Зарегистрируйте приложение.
2. Задайте неявные маркеры предоставления.
3. Задайте разрешения API.
4. Создайте секрет клиента.


## <a name="session-border-controller-configuration"></a>Конфигурация пограничного контроллера сеанса 

Пошаговые инструкции по настройке пограничного контроллера сеансов с внедренным устройством обеспечения связи см. в документации поставщика SBC: 

- [AudioCodes](https://www.audiocodes.com/library/technical-documents?query=sba)

- [Лента](https://support.sonus.net/pages/viewpage.action?pageId=248644034)

- [Oracle](https://www.oracle.com/technical-resources/documentation/acme-packet.html#Link-MicrosoftTeams) 

- [Te-Systems](https://www.anynode.de/microsoft-teams-sba/)

## <a name="reporting-issues"></a>Создание отчетов о проблемах

Ведите отчет о любых проблемах в службу поддержки поставщика SBC. При отправке сообщения о проблеме укажите, что у вас настроено устройство для обеспечения связи в филиалах.

## <a name="known-issues"></a>Известные проблемы

- Так как SBA использует маркеры проверки подлинности, которые действительны в течение 24 часов и обновляются ежедневно, в настоящее время SBA может поддерживать сбои до 24 часов с момента последней проверки подлинности. Это означает, что если сбой происходит через 20 часов после последнего продления маркера проверки подлинности, SBA будет работать только в течение оставшихся 4 часов.

- При добавлении новых устройств для обеспечения связи в филиалах может потребоваться некоторое время, прежде чем вы сможете использовать их в политиках устройств для обеспечения связи в филиалах.

- При назначении пользователю политики устройства для обеспечения связи ветвей может потребоваться некоторое время, прежде чем SBA отобразится в выходных данных Get-CsOnlineUser. 

- Обратный поиск номеров Azure AD контактов не выполняется. 

- SBA не поддерживает параметры переадресации вызовов. 

- Экстренный вызов на номер экстренных служб, настроенный для динамических экстренных вызовов (E911), не поддерживается.
