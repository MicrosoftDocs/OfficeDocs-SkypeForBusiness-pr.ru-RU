---
title: Подключение контроллера границ сеансов (SBC) к прямой маршрутизации
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.topic: article
ms.service: msteams
localization_priority: Normal
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Сведения о том, как настроить прямую маршрутизацию Microsoft Phone System.
ms.openlocfilehash: e86b0397e4c00b892d99a0814579f20ba14e8b59
ms.sourcegitcommit: 0289062510f0791906dab2791c5db8acb1cf849a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/20/2020
ms.locfileid: "42158009"
---
# <a name="connect-your-session-border-controller-sbc-to-direct-routing"></a>Подключение контроллера границ сеансов (SBC) к прямой маршрутизации 

В этой статье описано, как подключить контроллер границ сеанса (SBC) к прямой маршрутизации телефонной системы.  Это шаг 1, описанный ниже, для настройки прямой маршрутизации.

- **Шаг 1. Соединение SBC с телефонной системой и проверка соединения** (в этой статье)
- Шаг 2. [Разрешить пользователям прямую маршрутизацию](direct-routing-enable-users.md)
- Шаг 3. [Настройка маршрутизации звонков](direct-routing-voice-routing.md)
- Шаг 4. [Перевод чисел в альтернативный формат](direct-routing-translate-numbers.md) 

Сведения о всех шагах, необходимых для настройки прямой маршрутизации, приведены в статье [Настройка прямого маршрута](direct-routing-configure.md).

Чтобы соединить SBC для прямой маршрутизации, необходимо выполнить следующие действия: 

1. Подключитесь к центру администрирования **Skype для бизнеса Online** с помощью PowerShell.            
2. Свяжите SBC с клиентом.
3. Проверьте соединение. 

## <a name="connect-to-skype-for-business-online-by-using-powershell"></a>Подключение к Skype для бизнеса Online с помощью PowerShell 

Вы можете использовать сеанс PowerShell, подключенный к клиенту, для связывания SBC с интерфейсом Direct Routing. Чтобы открыть сеанс PowerShell, выполните действия, описанные в разделе [Настройка компьютера для Windows PowerShell](https://docs.microsoft.com/SkypeForBusiness/set-up-your-computer-for-windows-powershell/set-up-your-computer-for-windows-powershell). 
 
После установки удаленного сеанса PowerShell убедитесь, что вы видите команды для управления SBC. Чтобы проверить команды, введите (или скопируйте и вставьте) указанную ниже команду в сеансе PowerShell и нажмите клавишу ВВОД: 

```PowerShell
Get-Command *onlinePSTNGateway*
```

Команда возвращает четыре показанные здесь функции, позволяющие управлять SBC. 

<pre>
CommandType    Name                       Version    Source 
-----------    ----                       -------    ------ 
Function       Get-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt 
Function       New-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt 
Function       Remove-CsOnlinePSTNGateway 1.0        tmp_v5fiu1no.wxt 
Function       Set-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt
</pre>   


## <a name="connect-the-sbc-to-the-tenant"></a>Соединение SBC с клиентом 

Чтобы соединить SBC с клиентом, в сеансе PowerShell введите следующую команду и нажмите клавишу ВВОД: 

```PowerShell
New-CsOnlinePSTNGateway -Fqdn <SBC FQDN> -SipSignalingPort <SBC SIP Port> -MaxConcurrentSessions <Max Concurrent Sessions the SBC can handle> -Enabled $true 
```
  > [!NOTE]
  > 1. Корпорация Майкрософт рекомендует задать максимальное количество вызовов в SBC, используя сведения, которые можно найти в документации по SBC. Это ограничение инициирует уведомление, если объект SBC находится на уровне емкости.
  > 2. Вы можете присвоить значение SBC только в том случае, если доменная часть своего полного доменного имени соответствует одному из \*доменов, зарегистрированных в вашем клиенте, за исключением onmicrosoft.com. Использование \*доменных имен onmicrosoft.com не поддерживается для полного доменного имени SBC. Например, если у вас есть два доменных имен:<br/><br/>
  > **contoso**. com<br/>**contoso**. onmicrosoft.com<br/><br/>
  > Для имени SBC можно использовать имя sbc.contoso.com. При попытке связывания SBC с именем SBC. contoso. ABC система не позволит вам, так как домен не принадлежит этому клиенту.<br/>
  > Помимо домена, зарегистрированного в клиенте, важно, чтобы пользователь с этим доменом и назначенной лицензией E3 или водо. В противном случае появится следующее сообщение об ошибке:<br/>
  `Can not use the “sbc.contoso.com” domain as it was not configured for this tenant`.

```PowerShell
New-CsOnlinePSTNGateway -Identity sbc.contoso.com -Enabled $true -SipSignalingPort 5067 -MaxConcurrentSessions 100 
```
Дает
<pre>
Identity              : sbc.contoso.com 
Fqdn                  : sbc.contoso.com 
SipSignalingPort     : 5067 
FailoverTimeSeconds   : 10 
ForwardCallHistory    : False 
ForwardPai            : False 
SendSipOptions        : True 
MaxConcurrentSessions : 100 
Enabled               : True   
</pre>
В процессе подключения можно настроить дополнительные параметры. Однако в предыдущем примере показаны только минимально необходимые параметры. 
 
В таблице ниже приведены дополнительные параметры, которые можно использовать при настройке параметров ```New-CsOnlinePstnGateway```.

|Обязательно?|Имя|Описание|По умолчанию|Возможные значения|Тип и ограничения|
|:-----|:-----|:-----|:-----|:-----|:-----|
|Да|Полное доменное имя|Полное доменное имя SBC |Нет|NoneFQDN имя, ограничение 63 символов|Строка, список допустимых и недопустимых символов в [соглашениях об именовании в Active Directory для компьютеров, доменов, сайтов и подразделений](https://support.microsoft.com/help/909264)|
|Нет|MediaBypass |Параметр, обозначенный SBC, поддерживает обход мультимедиа, и администратор хочет использовать его.|Нет|Верно<br/>False|Boolean|
|Да|SipSignalingPort |Порт прослушивания, используемый для связи с прямыми службами маршрутизации с помощью протокола TLS (Transport Layer Security).|Нет|Любой порт|от 0 до 65535 |
|Нет|FailoverTimeSeconds |Если для этого параметра установлено значение 10 (значения по умолчанию), исходящие вызовы, которые не ответили шлюзом в течение 10 секунд, пересылаются на следующую доступную магистраль. Если дополнительных каналов связи нет, Звонок автоматически удаляется. В организации с медленными ответами сетей и шлюзов, это может приводить к необязательному пропуску вызовов. Значение по умолчанию — 10.|5-10|Число|Типом|
|Нет|ForwardCallHistory |Означает, будет ли переадресовываться по магистральному каналу сведения о журнале звонков. Если этот флажок установлен, прокси-сервер Office 365 КТСОП отправляет два заголовка: журнал — информация и на которую указывает обращение. Значением по умолчанию является **ложь** ($false). |False|Верно<br/>False|Boolean|
|Нет|ForwardPAI|Указывает, будет ли переадресовываться заголовок P-Asserted-Identity (PAI) одновременно с вызовом. Заголовок PAI предоставляет способ проверки удостоверения абонемента. Если включено, будет также отправлен заголовок "Конфиденциальность: ИД". Значением по умолчанию является **ложь** ($false).|False|Верно<br/>False|Boolean|
|Нет|SendSIPOptions |Определяет, будет ли SBC или не будет отправлять параметры SIP. Если отключено, SBC будет исключен из системы мониторинга и оповещения. Настоятельно рекомендуем включить параметры SIP. Значение по умолчанию — **true**. |Верно|Верно<br/>False|Boolean|
|Нет|MaxConcurrentSessions |Используется системой оповещения. Если задано какое либо значение, система оповещения создаст оповещение для администратора клиента, если количество одновременных сеансов составляет 90% или выше этого значения. Если параметр не задан, оповещения не создаются. Тем не менее, система мониторинга будет сообщать количество параллельных сеансов каждые 24 часа. |Значения|Значения<br/>от 1 до 100 000 ||
|Нет|MediaRelayRoutingLocationOverride |Позволяет выбрать путь для мультимедиа вручную. Прямая маршрутизация назначает центр обработки данных для пути к носителю, основываясь на общедоступном IP-адресе SBC. Мы всегда Выбери ближайший вариант в центре обработки данных SBC. Тем не менее, в некоторых случаях публичный IP-адрес, например, диапазон US, может быть назначен для SBC, находящегося в Европе. В этом случае мы будем использовать не оптимальный путь к носителю. Этот параметр позволяет вручную настроить предпочтительный регион для передачи данных мультимедиа. Корпорация Майкрософт рекомендует устанавливать этот параметр только в том случае, если журнал звонков явно указывает на то, что автоматическое назначение центра обработки данных для пути к носителю не присвоено ближайшему к центру обработки данных SBC. |Нет|Коды стран в формате ISO||
|Нет|Включено|Используется для включения этого SBC для исходящих вызовов. Может использоваться для временного удаления SBC во время его обновления или при обслуживании. |False|Верно<br/>False|Boolean|
 
## <a name="verify-the-sbc-connection"></a>Проверка соединения SBC 

Чтобы проверить подключение, выполните указанные ниже действия. 
- Убедитесь, что SBC есть в списке парных SBCs. 
- Проверьте параметры SIP. 
 
### <a name="check-if-the-sbc-is-on-the-list-of-paired-sbcs"></a>Проверка того, что SBC находится в списке парных SBCs 

После подключения SBC убедитесь, что SBC представлен в списке парных SBCs, выполнив следующую команду в удаленном сеансе PowerShell. 

```PowerShell
Get-CsOnlinePSTNGateway -Identity sbc.contoso.com  
```

Попарный шлюз должен отображаться в списке, как показано в приведенном ниже примере, а параметр **Enabled** должен отображать значение **true**. 


Возвращаемое значение.
<pre>
Identity              : sbc.contoso.com  
Fqdn                  : sbc.contoso.com 
SipSignalingPort     : 5067 
CodecPriority         : SILKWB,SILKNB,PCMU,PCMA 
ExcludedCodecs        :  
FailoverTimeSeconds   : 10 
ForwardCallHistory    : False 
ForwardPai            : False 
SendSipOptions        : True 
MaxConcurrentSessions : 100 
Enabled               : True 
</pre>

### <a name="validate-sip-options-flow"></a>Проверка потока параметров SIP 

Для проверки связывания с помощью исходящих параметров SIP используйте интерфейс управления SBC и убедитесь, что SBC получает ответы на 200 ОК в сообщениях с параметрами исходящих параметров.

Когда прямая маршрутизация видит параметры входящего трафика, она начнет отправлять сообщения параметров исходящих модулей SIP в FQDN, настроенном в поле "заголовок" в сообщении "параметры входящих". 

Для проверки связывания с помощью параметров входящего SIP используйте интерфейс управления SBC и посмотрите, что SBC отправляет ответы на сообщения параметров, поступившие от Direct Routing, и что код ответа, который он отправляет, — 200 ОК.


## <a name="see-also"></a>См. также

[Планирование прямой маршрутизации](direct-routing-plan.md)

[Настройка прямой маршрутизации](direct-routing-configure.md)
