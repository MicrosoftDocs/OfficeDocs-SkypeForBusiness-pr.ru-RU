---
title: Подключение контроллера границ сеансов (SBC) к прямой маршрутизации
ms.reviewer: ''
ms.author: crowe
author: CarolynRowe
manager: serdars
audience: ITPro
ms.topic: article
ms.service: msteams
localization_priority: Normal
search.appverid: MET150
ms.collection:
- M365-voice
appliesto:
- Microsoft Teams
f1.keywords:
- NOCSH
description: Сведения о том, как настроить и подключить SBC к прямой маршрутизации телефонной системы.
ms.openlocfilehash: 8ceb4d1811b479fbcdc0d4ca83f4dbc4672227bd
ms.sourcegitcommit: 1807ea5509f8efa6abba8462bce2f3646117e8bf
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/10/2020
ms.locfileid: "44691265"
---
# <a name="connect-your-session-border-controller-sbc-to-direct-routing"></a>Подключение контроллера границ сеансов (SBC) к прямой маршрутизации

В этой статье описано, как настроить контроллер границ сеанса (SBC) и подключить его к прямой маршрутизации телефонной системы.  Чтобы настроить прямую переадресацию, выполните указанные ниже действия.

- **Шаг 1. Соединение SBC с телефонной системой и проверка соединения** (в этой статье)
- Шаг 2. [Разрешить пользователям прямую маршрутизацию](direct-routing-enable-users.md)
- Шаг 3. [Настройка маршрутизации звонков](direct-routing-voice-routing.md)
- Шаг 4. [Перевод чисел в альтернативный формат](direct-routing-translate-numbers.md) 

Сведения о всех шагах, необходимых для настройки прямой маршрутизации, приведены в статье [Настройка прямого маршрута](direct-routing-configure.md).

Вы можете использовать [центр администрирования Microsoft Teams](#using-the-microsoft-teams-admin-center) или [PowerShell](#using-powershell) для настройки и соединения SBC для прямой маршрутизации.

## <a name="using-the-microsoft-teams-admin-center"></a>С помощью Центра администрирования Microsoft Teams

1. На панели навигации слева перейдите к **Voice**  >  **перенаправлению**голосовой почты, а затем откройте вкладку **SBCs** .
2. Нажмите **Добавить**.
3. Введите полное доменное имя для SBC. <br><br>Убедитесь, что часть доменного имени FQDN совпадает с именем домена, зарегистрированного в вашем клиенте, и имейте в виду, что имя `*.onmicrosoft.com` домена не поддерживается для доменного имени SBC. Например, если у вас есть два доменных имени `contoso.com` и `contoso.on.microsoft.com` используется в `sbc.contoso.com` качестве имени SBC.
4. Настройте для SBC следующие параметры в соответствии с потребностями Организации. Подробнее об этих параметрах можно узнать в разделе [Параметры SBC](#sbc-settings).

    ![Снимок экрана: Добавление страницы SBC в центре администрирования Microsoft Teams](media/direct-routing-add-sbc.png)

5. Закончив, нажмите кнопку **Сохранить**.

## <a name="using-powershell"></a>Использование PowerShell

Чтобы соединить SBC для прямой маршрутизации, необходимо выполнить следующие действия:

1. [Подключитесь к Skype для бизнеса Online с помощью PowerShell](#connect-to-skype-for-business-online-by-using-powershell).
2. [СВЯЖИТЕ SBC с клиентом](#connect-the-sbc-to-the-tenant).
3. [Проверьте соединение с помощью SBC](#verify-the-sbc-connection).

### <a name="connect-to-skype-for-business-online-by-using-powershell"></a>Подключение к Skype для бизнеса Online с помощью PowerShell

Вы можете использовать сеанс PowerShell, подключенный к клиенту, для связывания SBC с интерфейсом Direct Routing. Чтобы открыть сеанс PowerShell, выполните действия, описанные в разделе [Настройка компьютера для Windows PowerShell](https://docs.microsoft.com/SkypeForBusiness/set-up-your-computer-for-windows-powershell/set-up-your-computer-for-windows-powershell).
 
После установки удаленного сеанса PowerShell убедитесь, что вы видите команды для управления SBC. Чтобы проверить команды, введите (или скопируйте и вставьте) указанную ниже команду в сеансе PowerShell, а затем нажмите клавишу ВВОД: 

```PowerShell
Get-Command *onlinePSTNGateway*
```

Команда возвращает четыре показанные здесь функции, позволяющие управлять SBC.

<pre>
CommandType    Name                       Version    Source 
-----------    ----                       -------    ------ 
Function       Get-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt 
Function       New-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt 
Function       Remove-CsOnlinePSTNGateway 1.0        tmp_v5fiu1no.wxt 
Function       Set-CsOnlinePSTNGateway    1.0        tmp_v5fiu1no.wxt
</pre>

### <a name="connect-the-sbc-to-the-tenant"></a>Соединение SBC с клиентом

Используйте командлет [New-CsOnlinePSTNGateway](https://docs.microsoft.com/powershell/module/skype/new-csonlinepstngateway) , чтобы соединить SBC с клиентом. В сеансе PowerShell введите следующую команду и нажмите клавишу ВВОД:

```PowerShell
New-CsOnlinePSTNGateway -Fqdn <SBC FQDN> -SipSignalingPort <SBC SIP Port> -MaxConcurrentSessions <Max Concurrent Sessions the SBC can handle> -Enabled $true
```

  > [!NOTE]
  > 1. Рекомендуем установить максимальное число вызовов в SBC с помощью сведений, которые можно найти в документации по SBC. Это ограничение инициирует уведомление, если объект SBC находится на уровне емкости.
  > 2. Вы можете соединить SBC только в том случае, если доменная часть своего полного доменного имени соответствует одному из доменов, зарегистрированных в вашем клиенте, за исключением \* onmicrosoft.com. Использование \* доменных имен onmicrosoft.com не поддерживается для полного доменного имени SBC. Например, если у вас есть два доменных имени: **contoso**. com и **contoso**. onmicrosoft.com, вы можете использовать SBC. contoso. Con для имени SBC. При попытке подключить SBC с именем, таким как SBC. contoso. ABC, система не сможет предоставить вам доступ к домену, так как он не принадлежит этому клиенту.<br/>
  > В дополнение к домену, зарегистрированному в клиенте, важно, что у него есть пользователь с этим доменом и назначенная лицензия E3 или водо. В противном случае появится следующее сообщение об ошибке:<br/>
  `Can not use the "sbc.contoso.com" domain as it was not configured for this tenant`.

Ниже приводится пример.

```PowerShell
New-CsOnlinePSTNGateway -Identity sbc.contoso.com -Enabled $true -SipSignalingPort 5067 -MaxConcurrentSessions 100 
```

Возвращаемое значение.

<pre>
Identity              : sbc.contoso.com 
Fqdn                  : sbc.contoso.com 
SipSignalingPort     : 5067 
FailoverTimeSeconds   : 10 
ForwardCallHistory    : False 
ForwardPai            : False 
SendSipOptions        : True 
MaxConcurrentSessions : 100 
Enabled               : True   
</pre>

> [!NOTE]
> В этом примере показано только минимальное количество необходимых параметров. В процессе подключения можно настроить с помощью командлета [New-CsOnlinePSTNGateway](https://docs.microsoft.com/powershell/module/skype/new-csonlinepstngateway) дополнительные параметры. Дополнительные сведения можно найти в разделе [Параметры SBC](#sbc-settings).
 
### <a name="verify-the-sbc-connection"></a>Проверка соединения SBC

Чтобы проверить подключение, выполните указанные ниже действия.

- [Убедитесь, что SBC находится в списке парных SBCs](#check-whether-the-sbc-is-on-the-list-of-paired-sbcs).
- [Проверьте параметры SIP](#validate-sip-options).
 
#### <a name="check-whether-the-sbc-is-on-the-list-of-paired-sbcs"></a>Убедитесь, что SBC находится в списке парных SBCs

После подключения SBC используйте командлет [Get-CsOnlinePSTNGateway](https://docs.microsoft.com/powershell/module/skype/get-csonlinepstngateway) , чтобы убедиться, что SBC представлен в списке парных SBCs. В удаленном сеансе PowerShell введите следующую команду и нажмите клавишу ВВОД:

```PowerShell
Get-CsOnlinePSTNGateway -Identity sbc.contoso.com  
```

Попарный шлюз должен отображаться в списке, как показано в приведенном ниже примере, а параметр **Enabled** должен отображать значение **true**.

Возвращаемое значение.

<pre>
Identity              : sbc.contoso.com  
Fqdn                  : sbc.contoso.com
SipSignalingPort     : 5067
CodecPriority         : SILKWB,SILKNB,PCMU,PCMA
ExcludedCodecs        :  
FailoverTimeSeconds   : 10
ForwardCallHistory    : False
ForwardPai            : False
SendSipOptions        : True
MaxConcurrentSessions : 100
Enabled               : True
</pre>

#### <a name="validate-sip-options"></a>Проверка параметров SIP

Для проверки связывания с помощью исходящих параметров SIP используйте интерфейс управления SBC и убедитесь, что SBC получает ответы на 200 ОК в сообщениях с параметрами исходящих параметров.

Когда прямая маршрутизация видит параметры входящего трафика, она начнет отправлять сообщения параметров исходящих модулей SIP в FQDN, настроенном в поле "заголовок" в сообщении "параметры входящих". 

Для проверки связывания с помощью параметров входящего SIP используйте интерфейс управления SBC и посмотрите, что SBC отправляет ответы на сообщения параметров, поступившие от Direct Routing, и что код ответа, который он отправляет, — 200 ОК.

## <a name="sbc-settings"></a>Параметры SBC

В этой таблице перечислены параметры, которые можно настроить для SBC в центре администрирования Microsoft Teams, а также с помощью командлета [New-CsOnlinePSTNGateway](https://docs.microsoft.com/powershell/module/skype/new-csonlinepstngateway) .

|Обязательно?|Параметр центра администрирования Microsoft Teams|Параметр PowerShell|Описание|По умолчанию|Возможные значения|Тип и ограничения|
|:-----|:-----|:-----|:-----|:-----|:-----|:-----|
|Да|**Добавление полного доменного имени для SBC**|Полное доменное имя |Нет|Полное доменное имя, ограничение 63 символов|String, просмотр списка разрешенных и запрещенных символов в [соглашениях об именовании в службе каталогов Active Directory для компьютеров, доменов, сайтов и подразделений](https://support.microsoft.com/help/909264) .|
|Нет|**Включено**|Включено|Используется для включения SBC для исходящих вызовов. Вы можете использовать этот параметр, чтобы временно удалить SBC из службы при ее обновлении или при обслуживании. |False|Верно<br/>False|Boolean|
|Да|**Порт сигналов SIP**|SipSignalingPort |Это порт прослушивания, который используется для связи с прямой маршрутизацией с помощью протокола TLS (Transport Layer).|Нет|Любой порт|от 0 до 65535 |
|Нет|**Отправить параметры SIP**|SendSIPOptions |Определяет, будет ли SBC отправлять сообщения параметров SIP. Настоятельно рекомендуем включить этот параметр. Если этот параметр отключен, то SBC исключается из системы мониторинга и оповещения.|Верно|Верно<br/>False|Boolean|
|Нет|**Переадресация журнала звонков**|ForwardCallHistory |Указывает, пересылается ли информация журнала вызовов через магистраль. Когда вы включите этот параметр, на прокси-сервере Microsoft 365 или Office 365 посылается информация об истории и на которую ссылается заголовок. |False|Верно<br/>False|Boolean|
|Нет|**Заголовок "переадресация с подлинным-удостоверением" (PAI)**|ForwardPAI|Указывает, пересылается ли заголовок PAI вместе с звонком. Заголовок PAI предоставляет способ проверки удостоверения абонемента. Если этот параметр включен, также отправляется заголовок Privacy: ID.|False|Верно<br/>False|Boolean|
|Нет|**Емкость одновременных звонков**|MaxConcurrentSessions |Когда вы задаете значение, система оповещений уведомляет вас о том, что количество одновременных сеансов составляет 90% и больше, чем это значение. Если значение не задано, оповещения не создаются. Тем не менее, система мониторинга будет сообщать количество параллельных сеансов каждые 24 часа. |Значения|Значения<br/>от 1 до 100 000 ||
|Нет|**Коды ответов для отработки отказа**|FailoverResponseCodes<br>|Если прямая маршрутизация получает код ошибки SIP 4xx или 6xx в ответ на исходящий приглашение, вызов считается завершенным по умолчанию. "Исходящие" — вызов из клиента Teams в PSTN с потоком трафика: клиент Teams-> Direct Routing-> SBC-> телефонная сеть). При указании кода ответа для отработки отказа прямая маршрутизация пытается использовать другой SBC (если в политике голосовой маршрутизации пользователя есть другой SBC) при получении указанных кодов в том случае, если SBC не может позвонить из-за сети или других проблем. Дополнительные сведения о том, как [отработка отказа определенных SIP-кодов, полученных от контроллера границ сеансов (SBC)](direct-routing-trunk-failover-on-outbound-call.md).|408, 503, 504||Типом|
|Нет|**Время перехода на другой ресурс (в секундах)**|FailoverTimeSeconds |Когда вы задаете значение, исходящие вызовы, не отвеченные шлюзом в течение заданного вами времени, пересылаются на следующую доступную магистраль. Если дополнительные магистрали отсутствуют, Звонок автоматически удаляется. Значение по умолчанию — 10 секунд. В Организации с медленными сетями и ответами шлюза это может привести к невозможности удаления звонков.|5-10|Число|Типом|
|Нет|**Предпочтительная страна или регион для трафика мультимедиа**|MediaRelayRoutingLocationOverride |Вы можете вручную настроить предпочтительную страну или регион для мультимедийного трафика. Рекомендуется задавать этот параметр только в том случае, если в журналах звонков явно указано, что в качестве значения по умолчанию центра обработки данных для пути к носителю не используется путь, ближайший к центру обработки данных SBC. По умолчанию прямая маршрутизация назначает центр обработки данных на основе общедоступного IP-адреса SBC и всегда выбирает путь, ближайший к центру обработки данных SBC. Тем не менее, в некоторых случаях путь по умолчанию может быть не лучшим. Этот параметр позволяет вручную настроить предпочтительный регион для передачи данных мультимедиа. |Нет|Коды стран в формате ISO||
|Нет|**SBC поддерживает PIDFные и появляющиеся для экстренных вызовов**|PidfloSupported|Укажите, поддерживает ли SBC объект расположения формата данных сведений о присутствии (PIDF/почтовый) для вызова экстренной помощи.||||
|Нет|**Звонить на телефон при попытке найти пользователя**|GenerateRingingWhileLocatingUser|Укажите, следует ли воспроизводить звуковой сигнал вызывающему абоненту, чтобы указать, что команды находятся в процессе установки звонка. Этот параметр применяется только к прямой маршрутизации в режиме обхода файлов, не являющихся мультимедийными. Иногда входящие звонки от КТСОП к клиентам Teams могут занять больше времени, чем ожидалось. В этом случае абонент может не слышать ничего, так как клиент Teams не позвонит, и звонок может быть прерван некоторыми поставщиками телекоммуникационных услуг. Этот параметр позволяет избежать непредвиденных сбросов, которые могут возникать в этих сценариях.|Верно|Верно<br/>False|Boolean|
|Нет| - |MediaBypass|Этот параметр указывает, поддерживает ли SBC обход мультимедиа и следует ли использовать его для этого SBC. |Нет|Верно<br/>False|Boolean|

## <a name="see-also"></a>См. также

[Планирование прямой маршрутизации](direct-routing-plan.md)

[Настройка прямой маршрутизации](direct-routing-configure.md)

[Обзор PowerShell в Teams](teams-powershell-overview.md)
