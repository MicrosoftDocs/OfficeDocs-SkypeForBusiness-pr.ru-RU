---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутии
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899130"
---
# <a name="direct-routing---sip-protocol"></a><span data-ttu-id="51f8f-103">Прямая маршрутия — протокол SIP</span><span class="sxs-lookup"><span data-stu-id="51f8f-103">Direct Routing - SIP protocol</span></span>

<span data-ttu-id="51f8f-104">В этой статье описано, как прямая маршрутия реализует протокол SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-104">This article describes how Direct Routing implements the Session Initiation Protocol (SIP).</span></span> <span data-ttu-id="51f8f-105">Чтобы правильно маршрутировать трафик между контроллером границы сеанса (SBC) и прокси-сервером SIP, некоторые параметры SIP должны иметь определенные значения.</span><span class="sxs-lookup"><span data-stu-id="51f8f-105">To properly route traffic between a Session Border Controller (SBC) and the SIP proxy, some SIP parameters must have specific values.</span></span> <span data-ttu-id="51f8f-106">Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку подключения между локальной службой SBC и прокси-службой SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-106">This article is intended for voice administrators who are responsible for configuring the connection between the on-premises SBC and the SIP proxy service.</span></span>

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a><span data-ttu-id="51f8f-107">Обработка входящих запросов: поиск клиента и пользователя</span><span class="sxs-lookup"><span data-stu-id="51f8f-107">Processing the incoming request: finding the tenant and user</span></span>

<span data-ttu-id="51f8f-108">Перед обработкой входящих и исходящие вызовов сообщения OPTIONS обмениваются между прокси-сервером SIP и SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-108">Before an incoming or outbound call can be processed, OPTIONS messages are exchanged between SIP Proxy and the SBC.</span></span> <span data-ttu-id="51f8f-109">Эти сообщения параметры позволяют прокси-серверу SIP предоставлять разрешенные возможности для SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-109">These OPTIONS messages allow SIP Proxy to provide the allowed capabilities to SBC.</span></span> <span data-ttu-id="51f8f-110">Важно, чтобы согласование с OPTIONS было успешным (ответ 200OK), что позволило бы обеспечить дальнейшую связь между SBC и прокси-сервером SIP для установления звонков.</span><span class="sxs-lookup"><span data-stu-id="51f8f-110">It is important for OPTIONS negotiation to be successful (200OK response), allowing for further communication between SBC and SIP Proxy for establishing calls.</span></span> <span data-ttu-id="51f8f-111">В качестве примера ниже приведены заглавные данные SIP в сообщениях OPTIONS для прокси-сервера SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-111">The SIP headers in an OPTIONS messages to SIP Proxy are provided as an example below:</span></span>

| <span data-ttu-id="51f8f-112">Имя параметра</span><span class="sxs-lookup"><span data-stu-id="51f8f-112">Parameter name</span></span> | <span data-ttu-id="51f8f-113">Пример значения</span><span class="sxs-lookup"><span data-stu-id="51f8f-113">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="51f8f-114">URI запроса</span><span class="sxs-lookup"><span data-stu-id="51f8f-114">Request-URI</span></span> | <span data-ttu-id="51f8f-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="51f8f-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span></span> |
| <span data-ttu-id="51f8f-116">С помощью загона</span><span class="sxs-lookup"><span data-stu-id="51f8f-116">Via Header</span></span> | <span data-ttu-id="51f8f-117">Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="51f8f-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="51f8f-118">Max-Forwards загона</span><span class="sxs-lookup"><span data-stu-id="51f8f-118">Max-Forwards header</span></span> | <span data-ttu-id="51f8f-119">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="51f8f-119">Max-Forwards:68</span></span> |
| <span data-ttu-id="51f8f-120">Из области "Заглавная"</span><span class="sxs-lookup"><span data-stu-id="51f8f-120">From Header</span></span> | <span data-ttu-id="51f8f-121">Из области "От" в области "От": <sip:sbc1.adatum.biz:5058></span><span class="sxs-lookup"><span data-stu-id="51f8f-121">From Header From: <sip:sbc1.adatum.biz:5058></span></span> |
| <span data-ttu-id="51f8f-122">В заглавную</span><span class="sxs-lookup"><span data-stu-id="51f8f-122">To Header</span></span> | <span data-ttu-id="51f8f-123">Кому: <sip:sip.pstnhub.microsoft.com:5061></span><span class="sxs-lookup"><span data-stu-id="51f8f-123">To: <sip:sip.pstnhub.microsoft.com:5061></span></span> |
| <span data-ttu-id="51f8f-124">Заглавье CSeq</span><span class="sxs-lookup"><span data-stu-id="51f8f-124">CSeq header</span></span> | <span data-ttu-id="51f8f-125">CSeq: 1 ПРИГЛАШЕНИЕ</span><span class="sxs-lookup"><span data-stu-id="51f8f-125">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="51f8f-126">Заглавная связь контакта</span><span class="sxs-lookup"><span data-stu-id="51f8f-126">Contact Header</span></span> | <span data-ttu-id="51f8f-127">Контакт: <sip:sbc1.adatum.biz:50588;transport=tls></span><span class="sxs-lookup"><span data-stu-id="51f8f-127">Contact: <sip:sbc1.adatum.biz:50588;transport=tls></span></span> |

> [!NOTE]
> <span data-ttu-id="51f8f-128">Заглавные полосы SIP не содержат userinfo в используемом URI SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-128">The SIP headers do not contain userinfo in the SIP URI in use.</span></span> <span data-ttu-id="51f8f-129">В соответствии с [RFC 3261, разделом 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1)userinfo URI является необязательным и может отсутствовать, если конечного хоста нет представления о пользователях или когда хост является идентифицированным ресурсом.</span><span class="sxs-lookup"><span data-stu-id="51f8f-129">As per [RFC 3261, section 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), the userinfo part of a URI is optional and MAY be absent when the destination host does not have a notion of users or when the hosst itself is the resource being identified.</span></span> <span data-ttu-id="51f8f-130">Если знак @ присутствует в URI SIP, поле пользователя НЕ ДОЛЖНО быть пустым.</span><span class="sxs-lookup"><span data-stu-id="51f8f-130">If the @ sign is present in a SIP URI, the user field MUST NOT be empty.</span></span>

<span data-ttu-id="51f8f-131">Во время входящих зовов прокси-сервер SIP должен найти клиент, на который он перенапрался, и конкретного пользователя в этом клиенте.</span><span class="sxs-lookup"><span data-stu-id="51f8f-131">On an incoming call, the SIP proxy needs to find the tenant to which the call is destined and find the specific user within this tenant.</span></span> <span data-ttu-id="51f8f-132">Администратор клиента может настроить номера без did, например +1001, в нескольких клиентах.</span><span class="sxs-lookup"><span data-stu-id="51f8f-132">The tenant administrator might configure non-DID numbers, for example +1001, in multiple tenants.</span></span> <span data-ttu-id="51f8f-133">Поэтому важно найти конкретный клиент, в котором нужно выполнить поиск номеров, так как в разных организациях Microsoft 365 или Office 365 номера, неидаваемые, могут быть одинаковыми.</span><span class="sxs-lookup"><span data-stu-id="51f8f-133">Therefore, it is important to find the specific tenant on which to perform the number lookup because the non-DID numbers might be the same in multiple Microsoft 365 or Office 365 organizations.</span></span>  

<span data-ttu-id="51f8f-134">В этом разделе описано, как прокси-сервер SIP находит клиента и пользователя, а также выполняет проверку подлинности SBC при входящих подключениях.</span><span class="sxs-lookup"><span data-stu-id="51f8f-134">This section describes how the SIP proxy finds the tenant and the user, and performs authentication of the SBC on the incoming connection.</span></span>

<span data-ttu-id="51f8f-135">Ниже приводится пример приглашения SIP во входящий звонок:</span><span class="sxs-lookup"><span data-stu-id="51f8f-135">The following is an example of the SIP Invite message on an incoming call:</span></span>

| <span data-ttu-id="51f8f-136">Имя параметра</span><span class="sxs-lookup"><span data-stu-id="51f8f-136">Parameter name</span></span> | <span data-ttu-id="51f8f-137">Пример значения</span><span class="sxs-lookup"><span data-stu-id="51f8f-137">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="51f8f-138">URI запроса</span><span class="sxs-lookup"><span data-stu-id="51f8f-138">Request-URI</span></span> | <span data-ttu-id="51f8f-139">ПРИГЛАСИТЬ sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="51f8f-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span></span> |
| <span data-ttu-id="51f8f-140">С помощью загона</span><span class="sxs-lookup"><span data-stu-id="51f8f-140">Via Header</span></span> | <span data-ttu-id="51f8f-141">Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="51f8f-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="51f8f-142">Max-Forwards загона</span><span class="sxs-lookup"><span data-stu-id="51f8f-142">Max-Forwards header</span></span> | <span data-ttu-id="51f8f-143">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="51f8f-143">Max-Forwards:68</span></span> |
| <span data-ttu-id="51f8f-144">Из области "Заглавная"</span><span class="sxs-lookup"><span data-stu-id="51f8f-144">From Header</span></span> | <span data-ttu-id="51f8f-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span><span class="sxs-lookup"><span data-stu-id="51f8f-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span></span> |
| <span data-ttu-id="51f8f-146">В заглавную</span><span class="sxs-lookup"><span data-stu-id="51f8f-146">To Header</span></span> | <span data-ttu-id="51f8f-147">To : sip:+183338006777@sbc1.adatum.biz</span><span class="sxs-lookup"><span data-stu-id="51f8f-147">To: sip:+183338006777@sbc1.adatum.biz</span></span> | 
| <span data-ttu-id="51f8f-148">Заглавье CSeq</span><span class="sxs-lookup"><span data-stu-id="51f8f-148">CSeq header</span></span> | <span data-ttu-id="51f8f-149">CSeq: 1 ПРИГЛАШЕНИЕ</span><span class="sxs-lookup"><span data-stu-id="51f8f-149">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="51f8f-150">Заглавная связь контакта</span><span class="sxs-lookup"><span data-stu-id="51f8f-150">Contact Header</span></span> | <span data-ttu-id="51f8f-151">Контактное <SIP: 68712781@sbc1.adatum.biz:5058;transport=tls></span><span class="sxs-lookup"><span data-stu-id="51f8f-151">Contact: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span></span> | 

<span data-ttu-id="51f8f-152">При получении приглашения прокси-сервер SIP выполняет следующие действия:</span><span class="sxs-lookup"><span data-stu-id="51f8f-152">On receiving the invite, the SIP proxy performs the following steps:</span></span>

1. <span data-ttu-id="51f8f-153">Проверьте сертификат.</span><span class="sxs-lookup"><span data-stu-id="51f8f-153">Check the certificate.</span></span> <span data-ttu-id="51f8f-154">По первоначальному подключению служба direct Routing принимает имя FQDN, которое представлено в заглавной части контакта, и совпадает с именем "Общее имя" или "Тема альтернативы" для представленного сертификата.</span><span class="sxs-lookup"><span data-stu-id="51f8f-154">On the initial connection, the Direct Routing service takes the FQDN name presented in the Contact header and matches it to the Common Name or Subject Alternative name of the presented certificate.</span></span> <span data-ttu-id="51f8f-155">Имя SBC должно соответствовать одному из следующих вариантов:</span><span class="sxs-lookup"><span data-stu-id="51f8f-155">The SBC name must match one of the following options:</span></span>

   - <span data-ttu-id="51f8f-156">Вариант 1.</span><span class="sxs-lookup"><span data-stu-id="51f8f-156">Option 1.</span></span> <span data-ttu-id="51f8f-157">Полное полное имя FQDN, которое есть в заглавной части контакта, должно соответствовать общему имени или теме альтернативного имени представленного сертификата.</span><span class="sxs-lookup"><span data-stu-id="51f8f-157">The full FQDN name presented in the Contact header must match the Common Name/Subject Alternative name of the presented certificate.</span></span>  

   - <span data-ttu-id="51f8f-158">Вариант 2.</span><span class="sxs-lookup"><span data-stu-id="51f8f-158">Option 2.</span></span> <span data-ttu-id="51f8f-159">Часть домена имени FQDN, представленная в заглавном имени контакта (например, adatum.biz имени FQDN sbc1.adatum.biz), должна соответствовать поддеревным знакам в названии "Общее имя/тема" (например, \*.adatum.biz).</span><span class="sxs-lookup"><span data-stu-id="51f8f-159">The domain portion of the FQDN name presented in the Contact header (for example adatum.biz of the FQDN name sbc1.adatum.biz) must match the wildcard value in Common Name/Subject Alternative Name (for example \*.adatum.biz).</span></span>

2. <span data-ttu-id="51f8f-160">Попробуйте найти клиента, используя полное имя FQDN, которое вы найдете в заглавном тексте контакта.</span><span class="sxs-lookup"><span data-stu-id="51f8f-160">Try to find a tenant using the full FQDN name presented in the Contact header.</span></span>  

   <span data-ttu-id="51f8f-161">Убедитесь, что имя FQDN из заглавного sbc1.adatum.biz зарегистрировано как имя DNS в любой организации Microsoft 365 или Office 365.</span><span class="sxs-lookup"><span data-stu-id="51f8f-161">Check if the FQDN name from the Contact header (sbc1.adatum.biz) is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="51f8f-162">При обнаружении выполняется подсмотр пользователя в клиенте, в доменном имени которого зарегистрированО FQDN SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-162">If found, the lookup of the user is performed in the tenant that has the SBC FQDN registered as a Domain name.</span></span> <span data-ttu-id="51f8f-163">Если она не найдена, применяется шаг 3.</span><span class="sxs-lookup"><span data-stu-id="51f8f-163">If not found, Step 3 applies.</span></span>   

3. <span data-ttu-id="51f8f-164">Шаг 3 применяется только в случае сбойного шага 2.</span><span class="sxs-lookup"><span data-stu-id="51f8f-164">Step 3 only applies if Step 2 failed.</span></span> 

   <span data-ttu-id="51f8f-165">Удалите хост-часть из FQDN, представленную в заглавном имени контакта (FQDN: sbc12.adatum.biz, после удаления части хоста : adatum.biz) и проверьте, зарегистрировано ли это имя как имя DNS в любой организации Microsoft 365 или Office 365.</span><span class="sxs-lookup"><span data-stu-id="51f8f-165">Remove the host portion from the FQDN, presented in the Contact header (FQDN: sbc12.adatum.biz, after removing the host portion: adatum.biz), and check if this name is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="51f8f-166">При обнаружении в этом клиенте выполняется пользовательский просмотр.</span><span class="sxs-lookup"><span data-stu-id="51f8f-166">If found, the user lookup is performed in this tenant.</span></span> <span data-ttu-id="51f8f-167">Если он не найден, звонок не удастся найти.</span><span class="sxs-lookup"><span data-stu-id="51f8f-167">If not found, the call fails.</span></span>

4. <span data-ttu-id="51f8f-168">Используя номер телефона, представленный в URI-запроса, выполните обратный просмотр номера в клиенте, найденном в шаге 2 или 3.</span><span class="sxs-lookup"><span data-stu-id="51f8f-168">Using the phone number presented in the Request-URI, perform the reverse number lookup within the tenant found in Step 2 or 3.</span></span> <span data-ttu-id="51f8f-169">Сопопошать представленный номер телефона с пользовательским URI SIP в клиенте, найденном на предыдущем шаге.</span><span class="sxs-lookup"><span data-stu-id="51f8f-169">Match the presented phone number to a user SIP URI within the tenant found on the previous step.</span></span>

5. <span data-ttu-id="51f8f-170">Применим параметры туловища.</span><span class="sxs-lookup"><span data-stu-id="51f8f-170">Apply trunk settings.</span></span> <span data-ttu-id="51f8f-171">Найдите параметры, заданные администратором клиента для этого SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-171">Find the parameters set by the tenant admin for this SBC.</span></span>

   <span data-ttu-id="51f8f-172">Корпорация Майкрософт не поддерживает наличие прокси-сервера SIP сторонних пользователей или сервера агента пользователя между прокси-сервером Microsoft SIP и сопряженным сервером SBC, который может изменить URI запроса, созданный парным SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-172">Microsoft does not support having a third-party SIP proxy or User Agent Server between the Microsoft SIP proxy and the paired SBC, which might modify the Request URI created by the paired SBC.</span></span>

   <span data-ttu-id="51f8f-173">Далее в этой статье вы можете найти требования для двух подысков (этапов 2 и 3), необходимых для сценария, в котором один SBC взаимосвязан с множеством клиентов (сценарий оператора связи).</span><span class="sxs-lookup"><span data-stu-id="51f8f-173">The requirements for the two lookups (steps 2 and 3) needed for the scenario where one SBC is interconnected to many tenants (carrier scenario) are covered later in this article.</span></span>

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a><span data-ttu-id="51f8f-174">Подробные требования для загона контактов и запроса URI</span><span class="sxs-lookup"><span data-stu-id="51f8f-174">Detailed requirements for Contact header and Request-URI</span></span>

#### <a name="contact-header"></a><span data-ttu-id="51f8f-175">Заглавная связь с контактом</span><span class="sxs-lookup"><span data-stu-id="51f8f-175">Contact header</span></span>

<span data-ttu-id="51f8f-176">Для всех входящих сообщений SIP (OPTIONS, INVITE) на прокси-сервер SIP Корпорации Майкрософт заглавная запись контакта должна иметь в имени сервера URI сопряженное FQDN SBC следующим образом:</span><span class="sxs-lookup"><span data-stu-id="51f8f-176">For all incoming SIP messages (OPTIONS, INVITE) to the Microsoft SIP proxy, the Contact header must have the paired SBC FQDN in the URI hostname as follows:</span></span>

<span data-ttu-id="51f8f-177">Синтаксис: контакт: <sip:phone или sip address@FQDN SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="51f8f-177">Syntax: Contact:  <sip:phone or sip address@FQDN of the SBC;transport=tls></span></span> 

<span data-ttu-id="51f8f-178">В соответствии [с RFC 3261, раздел 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), поле заглавного поля контакта может присутствовать в сообщении OPTIONS.</span><span class="sxs-lookup"><span data-stu-id="51f8f-178">As per [RFC 3261, section 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), a Contact header field MAY be present in an OPTIONS message.</span></span> <span data-ttu-id="51f8f-179">В прямой маршрутике требуется заглавная линия контакта.</span><span class="sxs-lookup"><span data-stu-id="51f8f-179">In Direct Routing the contact header is required.</span></span> <span data-ttu-id="51f8f-180">Для сообщений INVITE в формате выше для сообщений OPTIONS userinfo можно удалить из SIP URI и только FQDN, отправленных в формате:</span><span class="sxs-lookup"><span data-stu-id="51f8f-180">For INVITE messages in format above, for OPTIONS messages the userinfo can be removed from SIP URI and only FQDN sent in format as follows:</span></span>

<span data-ttu-id="51f8f-181">Синтаксис: контакт: <sip:FQDN SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="51f8f-181">Syntax: Contact:  <sip:FQDN of the SBC;transport=tls></span></span>

<span data-ttu-id="51f8f-182">Это имя (FQDN) также должно быть в полях "Общее имя" или "Альтернативное имя субъекта" в сертификате.</span><span class="sxs-lookup"><span data-stu-id="51f8f-182">This name (FQDN) must also be in the Common Name or Subject Alternative name field(s) of the presented certificate.</span></span> <span data-ttu-id="51f8f-183">Корпорация Майкрософт поддерживает использование поддеревных значений имен в полях "Общее имя" или "Тема альтернативного имени" сертификата.</span><span class="sxs-lookup"><span data-stu-id="51f8f-183">Microsoft supports using wildcard values of the name(s) in the Common Name or Subject Alternative Name fields of the certificate.</span></span>   

<span data-ttu-id="51f8f-184">Поддержка поддицов описана в [разделе 3.1 RFC 2818.](https://tools.ietf.org/html/rfc2818#section-3.1)</span><span class="sxs-lookup"><span data-stu-id="51f8f-184">The support for wildcards is described in [RFC 2818, section 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span></span> <span data-ttu-id="51f8f-185">Специально:</span><span class="sxs-lookup"><span data-stu-id="51f8f-185">Specifically:</span></span>

<span data-ttu-id="51f8f-186">*"Имена могут содержать под вопросии символ, который считается совпадать с любым компонентом \* доменного имени или фрагментом компонента. Например, .a.com совпадает с foo.a.com, но не bar.foo.a.com. f .com соответствует foo.com, но \* \* не bar.com".*</span><span class="sxs-lookup"><span data-stu-id="51f8f-186">*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. E.g., \*.a.com matches foo.a.com but not bar.foo.a.com. f\*.com matches foo.com but not bar.com."*</span></span>

<span data-ttu-id="51f8f-187">Если SBC отправляет несколько значений в заглавном сообщении контактов, используется только часть FQDN первого значения в его заглавном сообщении.</span><span class="sxs-lookup"><span data-stu-id="51f8f-187">If more than one value in the Contact header presented in a SIP message is sent by the SBC, only the FQDN portion of the first value of the Contact header is used.</span></span>

<span data-ttu-id="51f8f-188">Как правило, при прямой маршрутике для заполнения URI SIP вместо IP-адреса используется FQDN.</span><span class="sxs-lookup"><span data-stu-id="51f8f-188">As rule of thumb for Direct Routing, it is important that FQDN is used to populate SIP URI instead of IP.</span></span> <span data-ttu-id="51f8f-189">Входящий приглашение или сообщение ПАРАМЕТРы на прокси-сервер SIP с названием контакта, в котором имя сервера представлено IP, а не FQDN, подключение будет отклонено с помощью параметра 403 Запрещено.</span><span class="sxs-lookup"><span data-stu-id="51f8f-189">An incoming INVITE or OPTIONS message to SIP Proxy with Contact header where hostname is represented by IP and not FQDN, the connection will be refused with 403 Forbidden.</span></span>

#### <a name="request-uri"></a><span data-ttu-id="51f8f-190">URI запроса</span><span class="sxs-lookup"><span data-stu-id="51f8f-190">Request-URI</span></span> 

<span data-ttu-id="51f8f-191">Для всех входящих звонков для совпадения номера телефона с пользователем используется URI-запрос.</span><span class="sxs-lookup"><span data-stu-id="51f8f-191">For all incoming calls, the Request-URI is used to match the phone number to a user.</span></span>   

<span data-ttu-id="51f8f-192">В настоящее время номер телефона должен содержать знак "плюс" (+), как показано в примере ниже.</span><span class="sxs-lookup"><span data-stu-id="51f8f-192">Currently The phone number must contain a plus sign (+) as shown in the following example.</span></span> 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a><span data-ttu-id="51f8f-193">Контактные Record-Route с учетом соображений безопасности</span><span class="sxs-lookup"><span data-stu-id="51f8f-193">Contact and Record-Route headers considerations</span></span>

<span data-ttu-id="51f8f-194">Прокси-сервер SIP должен вычислить FQDN следующего перехода для новых транзакций клиента в диалоговом оке (например, Bye или Re-Invite), а также при ответе на параметры SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-194">The SIP proxy needs to calculate the next hop FQDN for new in-dialog client transactions (for example Bye or Re-Invite), and when replying to SIP Options.</span></span> <span data-ttu-id="51f8f-195">Используются контакты или Record-Route.</span><span class="sxs-lookup"><span data-stu-id="51f8f-195">Either Contact or Record-Route are used.</span></span> 

<span data-ttu-id="51f8f-196">В соответствии [с RFC 3261, разделом 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)в любом запросе, который может привести к новому диалогову, требуется заглавная связь контакта.</span><span class="sxs-lookup"><span data-stu-id="51f8f-196">According to [RFC 3261, section 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), Contact header is required in any request that can result in a new dialog.</span></span> <span data-ttu-id="51f8f-197">Этот Record-Route требуется только в том случае, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окке.</span><span class="sxs-lookup"><span data-stu-id="51f8f-197">The Record-Route is only required if a proxy wants to stay on the path of future requests in a dialog.</span></span> <span data-ttu-id="51f8f-198">Если прокси-сервер SBC [](./direct-routing-media-optimization.md)используется с локальной оптимизацией мультимедиа для прямой маршрутизации, необходимо настроить маршрут записи, так как прокси-сервер должен оставаться в маршруте.</span><span class="sxs-lookup"><span data-stu-id="51f8f-198">If a proxy SBC is in use with [Local Media Optimization for Direct Routing](./direct-routing-media-optimization.md), a record route will need to be configured as the proxy SBC needs to stay in the route.</span></span> 

<span data-ttu-id="51f8f-199">Корпорация Майкрософт рекомендует использовать только заглавную запись контакта, если не используется прокси-сервер SBC:</span><span class="sxs-lookup"><span data-stu-id="51f8f-199">Microsoft recommends using only Contact header if a proxy SBC is not used:</span></span>

- <span data-ttu-id="51f8f-200">В соответствии с [RFC 3261, раздел 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route используется, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом оке, что не важно, если ни один прокси-сервер SBC не настроен, так как весь трафик проходит между прокси-сервером Microsoft SIP и сопряженным SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-200">Per [RFC 3261, section 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route is used if a proxy wants to stay on the path of future requests in a dialog, which is not essential if no proxy SBC is configured as all traffic goes between the Microsoft SIP proxy and the paired SBC.</span></span> 

- <span data-ttu-id="51f8f-201">Прокси-сервер SIP (Майкрософт) использует только заглавную запись контакта (а не Record-Route) для определения следующего перехода при отправке параметров исходящие связи.</span><span class="sxs-lookup"><span data-stu-id="51f8f-201">The Microsoft SIP proxy uses only Contact header (not Record-Route) to determine the next hop when sending outbound ping Options.</span></span> <span data-ttu-id="51f8f-202">Настройка только одного параметра (Контакт) вместо двух (Contact и Record-Route) упрощает администрирование, если прокси-сервер SBC не используется.</span><span class="sxs-lookup"><span data-stu-id="51f8f-202">Configuring only one parameter (Contact) instead of two (Contact and Record-Route) simplifies the administration if a proxy SBC is not in use.</span></span> 

<span data-ttu-id="51f8f-203">Для вычисления следующего перехода прокси-сервер SIP использует:</span><span class="sxs-lookup"><span data-stu-id="51f8f-203">To calculate the next hop, the SIP proxy uses:</span></span>

- <span data-ttu-id="51f8f-204">Приоритет 1.</span><span class="sxs-lookup"><span data-stu-id="51f8f-204">Priority 1.</span></span> <span data-ttu-id="51f8f-205">Record-Route верхнего уровня.</span><span class="sxs-lookup"><span data-stu-id="51f8f-205">Top-level Record-Route.</span></span> <span data-ttu-id="51f8f-206">Если имя FQDN Record-Route верхнего уровня, имя FQDN используется для соединения исходящие в диалоговом окну.</span><span class="sxs-lookup"><span data-stu-id="51f8f-206">If the top-level Record-Route contains the FQDN name, the FQDN name is used to make the outbound in-dialog connection.</span></span>

- <span data-ttu-id="51f8f-207">Приоритет 2.</span><span class="sxs-lookup"><span data-stu-id="51f8f-207">Priority 2.</span></span> <span data-ttu-id="51f8f-208">Заглавная связь с контактом.</span><span class="sxs-lookup"><span data-stu-id="51f8f-208">Contact header.</span></span> <span data-ttu-id="51f8f-209">Если Record-Route не существует, прокси-сервер SIP будет искать значение заглавного адреса контакта, чтобы сделать исходящие подключения.</span><span class="sxs-lookup"><span data-stu-id="51f8f-209">If Record-Route does not exist, the SIP proxy will look up the value of the Contact header to make the outbound connection.</span></span> <span data-ttu-id="51f8f-210">(Рекомендуемая конфигурация.)</span><span class="sxs-lookup"><span data-stu-id="51f8f-210">(This is the recommended configuration.)</span></span>

<span data-ttu-id="51f8f-211">Если используются как contact, так и Record-Route, администратор SBC должен сохранить одинаковые значения, что приводит к накладным расходовам администратора.</span><span class="sxs-lookup"><span data-stu-id="51f8f-211">If both Contact and Record-Route are used, the SBC administrator must keep their values identical, which causes administrative overhead.</span></span> 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a><span data-ttu-id="51f8f-212">Использование имени FQDN в контакте или Record-Route</span><span class="sxs-lookup"><span data-stu-id="51f8f-212">Use of FQDN name in Contact or Record-Route</span></span>

<span data-ttu-id="51f8f-213">Использование IP-адреса не поддерживается ни в Record-Route, ни в контакте.</span><span class="sxs-lookup"><span data-stu-id="51f8f-213">Use of an IP address is not supported in either Record-Route or Contact.</span></span> <span data-ttu-id="51f8f-214">Единственным поддерживаемым вариантом является FQDN, которое должно совпадать с общим именем или альтернативным именем субъекта сертификата SBC (поддерживаются поддеревные знаки в сертификате).</span><span class="sxs-lookup"><span data-stu-id="51f8f-214">The only supported option is an FQDN, which must match either the Common Name or Subject Alternative Name of the SBC certificate (wildcard values in the certificate are supported).</span></span>

- <span data-ttu-id="51f8f-215">Если IP-адрес присутствует в record-route или Contact, проверка сертификата не проходит, а звонок не проходит.</span><span class="sxs-lookup"><span data-stu-id="51f8f-215">If an IP address is presented in Record-route or Contact, the certificate check fails and the call fails.</span></span>

- <span data-ttu-id="51f8f-216">Если FQDN не совпадает со значением общего или альтернативного имени субъекта в представляемом сертификате, вызов не происходит.</span><span class="sxs-lookup"><span data-stu-id="51f8f-216">If the FQDN does not match the value of the Common or Subject Alternative Name in the presented certificate, the call fails.</span></span> 

## <a name="inbound-call-sip-dialog-description"></a><span data-ttu-id="51f8f-217">Входящий звонок: описание диалогового окно SIP</span><span class="sxs-lookup"><span data-stu-id="51f8f-217">Inbound call: SIP dialog description</span></span>

<span data-ttu-id="51f8f-218">В приведенной ниже таблице 2016 2016 2016 2016 2016 2016 2016 2016 2016 2016 2013 2016 2013</span><span class="sxs-lookup"><span data-stu-id="51f8f-218">The following table below summarizes the call flow differences and similarities between non-bypass and bypass modes:</span></span>

| <span data-ttu-id="51f8f-219">Имя параметра</span><span class="sxs-lookup"><span data-stu-id="51f8f-219">Parameter name</span></span> | <span data-ttu-id="51f8f-220">Режим без обхода</span><span class="sxs-lookup"><span data-stu-id="51f8f-220">Non-bypass mode</span></span> | <span data-ttu-id="51f8f-221">Режим обхода</span><span class="sxs-lookup"><span data-stu-id="51f8f-221">Bypass mode</span></span>
| :---------------------  |:---------------------- |:----------------|
| <span data-ttu-id="51f8f-222">Кандидаты на мультимедиа в 183 и 200 сообщениях, которые приходят из</span><span class="sxs-lookup"><span data-stu-id="51f8f-222">Media candidates in 183 and 200 messages coming from</span></span> | <span data-ttu-id="51f8f-223">Процессоры мультимедиа</span><span class="sxs-lookup"><span data-stu-id="51f8f-223">Media processors</span></span> | <span data-ttu-id="51f8f-224">Клиенты</span><span class="sxs-lookup"><span data-stu-id="51f8f-224">Clients</span></span> | 
| <span data-ttu-id="51f8f-225">Число 183 сообщений, которые может получать SBC</span><span class="sxs-lookup"><span data-stu-id="51f8f-225">Number of 183 messages SBC can receive</span></span> | <span data-ttu-id="51f8f-226">По одному в сеансе</span><span class="sxs-lookup"><span data-stu-id="51f8f-226">One per session</span></span> | <span data-ttu-id="51f8f-227">Несколько</span><span class="sxs-lookup"><span data-stu-id="51f8f-227">Multiple</span></span> | 
| <span data-ttu-id="51f8f-228">Звонок может быть с предварительным ответом (183)</span><span class="sxs-lookup"><span data-stu-id="51f8f-228">Call can be with provisional answer (183)</span></span> | <span data-ttu-id="51f8f-229">Да</span><span class="sxs-lookup"><span data-stu-id="51f8f-229">Yes</span></span> | <span data-ttu-id="51f8f-230">Да</span><span class="sxs-lookup"><span data-stu-id="51f8f-230">Yes</span></span> |
| <span data-ttu-id="51f8f-231">Звонок может быть без предварительного ответа (183)</span><span class="sxs-lookup"><span data-stu-id="51f8f-231">Call can be without provisional answer (183)</span></span> | <span data-ttu-id="51f8f-232">Да</span><span class="sxs-lookup"><span data-stu-id="51f8f-232">Yes</span></span> | <span data-ttu-id="51f8f-233">Да</span><span class="sxs-lookup"><span data-stu-id="51f8f-233">Yes</span></span> |

###  <a name="non-media-bypass-flow"></a><span data-ttu-id="51f8f-234">Поток обхода без мультимедиа</span><span class="sxs-lookup"><span data-stu-id="51f8f-234">Non-media bypass flow</span></span>

<span data-ttu-id="51f8f-235">У пользователя Teams может быть несколько конечных точек одновременно.</span><span class="sxs-lookup"><span data-stu-id="51f8f-235">A Teams user might have multiple endpoints at the same time.</span></span> <span data-ttu-id="51f8f-236">Например, это могут быть клиент Teams для Windows, клиент Teams для iPhone и Teams Phone (клиент Teams для Android).</span><span class="sxs-lookup"><span data-stu-id="51f8f-236">For example, Teams for Windows client, Teams for iPhone client, and Teams Phone (Teams Android client).</span></span> <span data-ttu-id="51f8f-237">Каждая конечная точка может сигнализировать об отстаке HTTP следующим образом:</span><span class="sxs-lookup"><span data-stu-id="51f8f-237">Each endpoint might signal an HTTP rest as follows:</span></span>

-   <span data-ttu-id="51f8f-238">Ход выполнения звонка — преобразуется прокси-сервером SIP в сообщение SIP 180.</span><span class="sxs-lookup"><span data-stu-id="51f8f-238">Call progress – converted by the SIP proxy to the SIP message 180.</span></span> <span data-ttu-id="51f8f-239">При получении сообщения 180 SBC должен создать локальный звонок.</span><span class="sxs-lookup"><span data-stu-id="51f8f-239">On receiving message 180, the SBC must generate local ringing.</span></span>

-   <span data-ttu-id="51f8f-240">Медиаотобращение — преобразуется прокси-сервером SIP в сообщение 183 с кандидатами на мультимедиа в протоколе SDP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-240">Media answer – converted by the SIP proxy to message 183 with media candidates in Session Description Protocol (SDP).</span></span> <span data-ttu-id="51f8f-241">При получении сообщения 183 SBC будет подключаться к медиаимям, полученным в сообщении SDP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-241">On receiving message 183, the SBC expects to connect to the media candidates received in the SDP message.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="51f8f-242">В некоторых случаях может не быть создан ответ мультимедиа, а конечный пункт может ответить сообщением "Звонок принят".</span><span class="sxs-lookup"><span data-stu-id="51f8f-242">In some cases the Media answer might not be generated, and the end point might answer with “Call Accepted” message.</span></span>

-   <span data-ttu-id="51f8f-243">Звонок принят — преобразуется прокси-сервером SIP в сообщение SIP 200 с SDP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-243">Call accepted – converted by the SIP proxy to SIP message 200 with SDP.</span></span> <span data-ttu-id="51f8f-244">Ожидается, что при получении сообщения 200 SBC будет отправлять и получать мультимедиа для предоставленных кандидатов SDP и от них.</span><span class="sxs-lookup"><span data-stu-id="51f8f-244">On receiving message 200, the SBC is expected to send and receive media to and from the provided SDP candidates.</span></span>

    > [!NOTE]
    > <span data-ttu-id="51f8f-245">Прямая маршрутная маршрутия не поддерживает приглашение с задержкой (приглашение без SDP).</span><span class="sxs-lookup"><span data-stu-id="51f8f-245">Direct Routing does not support Delayed Offer Invite (Invite without SDP).</span></span>

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a><span data-ttu-id="51f8f-246">Несколько конечных точек, которые звонят с временным ответом</span><span class="sxs-lookup"><span data-stu-id="51f8f-246">Multiple endpoints ringing with provisional answer</span></span>

1.  <span data-ttu-id="51f8f-247">При получении первого приглашения от SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках.</span><span class="sxs-lookup"><span data-stu-id="51f8f-247">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="51f8f-248">После уведомления каждая конечная точка начнет звонить на прокси-сервер SIP и отправлять сообщения о ходе выполнения зовов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-248">Upon notification, each endpoint will start ringing and sending "Call progress” messages to the SIP proxy.</span></span> <span data-ttu-id="51f8f-249">Так как у пользователя Teams может быть несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения зовов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-249">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="51f8f-250">Для каждого сообщения о ходе выполнения зовов, полученных от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="51f8f-250">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span> <span data-ttu-id="51f8f-251">Интервал для отправки таких сообщений определяется интервалом получения сообщений от контроллера звонка.</span><span class="sxs-lookup"><span data-stu-id="51f8f-251">The interval for sending such messages is defined by the interval of the receiving messages from the Call Controller.</span></span> <span data-ttu-id="51f8f-252">На приведенной ниже схеме прокси-сервером SIP создается 180 сообщений.</span><span class="sxs-lookup"><span data-stu-id="51f8f-252">In the following diagram, there are two 180 messages generated by the SIP proxy.</span></span> <span data-ttu-id="51f8f-253">Эти сообщения приходят с двух конечных точек пользователя Teams.</span><span class="sxs-lookup"><span data-stu-id="51f8f-253">These messages come from the two Teams endpoints of the user.</span></span> <span data-ttu-id="51f8f-254">У каждого клиента есть уникальный ИД тега.</span><span class="sxs-lookup"><span data-stu-id="51f8f-254">The clients each have a unique Tag ID.</span></span>  <span data-ttu-id="51f8f-255">Каждое сообщение из другой конечной точки будет отдельным сеансом (параметр "тег" в поле "To" будет разным).</span><span class="sxs-lookup"><span data-stu-id="51f8f-255">Every message coming from a different endpoint will be a separate session (the parameter “tag” in the “To” field will be different).</span></span> <span data-ttu-id="51f8f-256">Однако конечная точка может не создать сообщение 180 и отправить сообщение 183 сразу, как показано на приведенной ниже схеме.</span><span class="sxs-lookup"><span data-stu-id="51f8f-256">But an endpoint might not generate message 180 and send message 183 right away as shown in the following diagram.</span></span>

4.  <span data-ttu-id="51f8f-257">После того как конечная точка создает сообщение "Ответ на мультимедиа" с IP-адресами кандидатов на поддержку мультимедиа конечной точки, прокси-сервер SIP преобразует полученное сообщение в сообщение "Ход выполнения сеанса SIP 183", а SDP клиента заменяется SDP из процессора мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="51f8f-257">Once an endpoint generates a Media Answer message with the IP addresses of endpoint’s media candidates, the SIP proxy converts the message received to a "SIP 183 Session Progress" message with the SDP from the client replaced by the SDP from the Media Processor.</span></span> <span data-ttu-id="51f8f-258">На следующей схеме конечная точка из Висяча 2 ответила на звонок.</span><span class="sxs-lookup"><span data-stu-id="51f8f-258">In the following diagram, the endpoint from Fork 2 answered the call.</span></span> <span data-ttu-id="51f8f-259">Если ни одна из сторон связи не обойдена, сообщение SIP 183 создается только один раз (ring Bot или Client End Point).</span><span class="sxs-lookup"><span data-stu-id="51f8f-259">If the trunk is non-bypassed, the 183 SIP message is generated only once (either Ring Bot or Client End Point).</span></span> <span data-ttu-id="51f8f-260">183 может получиться на существующей висячий или начать новую.</span><span class="sxs-lookup"><span data-stu-id="51f8f-260">The 183 might come on an existing fork or start a new one.</span></span>

5.  <span data-ttu-id="51f8f-261">Будет отправлено приемочное сообщение с окончательными кандидатами конечной точки, которые приняли звонок.</span><span class="sxs-lookup"><span data-stu-id="51f8f-261">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="51f8f-262">Сообщение о приемке вызовов преобразуется в сообщение SIP 200.</span><span class="sxs-lookup"><span data-stu-id="51f8f-262">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="51f8f-263">![Схема с несколькими конечными точками, которые звонят с временным ответом](media/direct-routing-protocols-1.png)</span><span class="sxs-lookup"><span data-stu-id="51f8f-263">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-1.png)</span></span>

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a><span data-ttu-id="51f8f-264">Несколько конечных точек, которые звонят без предварительного ответа</span><span class="sxs-lookup"><span data-stu-id="51f8f-264">Multiple endpoints ringing without provisional answer</span></span>

1.  <span data-ttu-id="51f8f-265">При получении первого приглашения от SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках.</span><span class="sxs-lookup"><span data-stu-id="51f8f-265">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="51f8f-266">После уведомления каждая конечная точка начнет звонить и отправлять сообщение "Ход выполнения звонка" на прокси-сервер SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-266">Upon notification, each endpoint will start ringing and sending the message "Call progress” to the SIP proxy.</span></span> <span data-ttu-id="51f8f-267">Так как у пользователя Teams может быть несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения зовов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-267">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="51f8f-268">Для каждого сообщения о ходе выполнения зовов, полученных от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="51f8f-268">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span>  <span data-ttu-id="51f8f-269">Интервал для отправки сообщений определяется интервалом получения сообщений с контроллера звонка.</span><span class="sxs-lookup"><span data-stu-id="51f8f-269">The interval for sending the messages is defined by the interval of receiving the messages from the Call Controller.</span></span> <span data-ttu-id="51f8f-270">На рисунке ниже 180 сообщений, созданных прокси-сервером SIP. Это означает, что пользователь вошел в три клиента Teams и каждый клиент отправил ход выполнения звонка.</span><span class="sxs-lookup"><span data-stu-id="51f8f-270">On the picture below there are two 180 messages generated by the SIP proxy, meaning that user logged into three Teams clients and each client send the call progress.</span></span> <span data-ttu-id="51f8f-271">Каждое сообщение будет отдельным сеансом (параметр "тег" в поле "To" отличается)</span><span class="sxs-lookup"><span data-stu-id="51f8f-271">Every message will be a separate session (parameter “tag” in “To” field is different)</span></span>

4.  <span data-ttu-id="51f8f-272">Будет отправлено приемочное сообщение с окончательными кандидатами конечной точки, которые приняли звонок.</span><span class="sxs-lookup"><span data-stu-id="51f8f-272">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="51f8f-273">Сообщение о приемке вызовов преобразуется в сообщение SIP 200.</span><span class="sxs-lookup"><span data-stu-id="51f8f-273">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="51f8f-274">![Схема, показывающая несколько конечных точек, которые звонят без предварительного ответа](media/direct-routing-protocols-2.png)</span><span class="sxs-lookup"><span data-stu-id="51f8f-274">![Diagram showing multiple endpoints ringing without provisional answer](media/direct-routing-protocols-2.png)</span></span>

### <a name="media-bypass-flow"></a><span data-ttu-id="51f8f-275">Поток обхода мультимедиа</span><span class="sxs-lookup"><span data-stu-id="51f8f-275">Media bypass flow</span></span>

<span data-ttu-id="51f8f-276">Те же сообщения (100 trying, 180, 183) используются в сценарии обхода мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="51f8f-276">The same messages (100 Trying, 180, 183) are used in the media bypass scenario.</span></span> 

<span data-ttu-id="51f8f-277">В приведенной ниже схеме показан пример обхода потока зова.</span><span class="sxs-lookup"><span data-stu-id="51f8f-277">The schema below shows an example of the bypass call flow.</span></span> 

> [!NOTE]
> <span data-ttu-id="51f8f-278">Кандидаты на выбор мультимедиа могут быть из разных конечных точек.</span><span class="sxs-lookup"><span data-stu-id="51f8f-278">The media candidates can come from different endpoints.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="51f8f-279">![Схема с несколькими конечными точками, которые звонят с временным ответом](media/direct-routing-protocols-3.png)</span><span class="sxs-lookup"><span data-stu-id="51f8f-279">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-3.png)</span></span>

## <a name="replaces-option"></a><span data-ttu-id="51f8f-280">Параметр "Заменяет"</span><span class="sxs-lookup"><span data-stu-id="51f8f-280">Replaces option</span></span>

<span data-ttu-id="51f8f-281">SBC должен поддерживать приглашение на замену.</span><span class="sxs-lookup"><span data-stu-id="51f8f-281">The SBC must support Invite with Replaces.</span></span>

## <a name="size-of-sdp-considerations"></a><span data-ttu-id="51f8f-282">Размер учета SDP</span><span class="sxs-lookup"><span data-stu-id="51f8f-282">Size of SDP considerations</span></span>

<span data-ttu-id="51f8f-283">Интерфейс прямой маршрутизации может отправлять сообщение SIP, превышающий 1500 тол.</span><span class="sxs-lookup"><span data-stu-id="51f8f-283">The Direct Routing interface might send a SIP message exceeding 1,500 bytes.</span></span>  <span data-ttu-id="51f8f-284">Это главным образом связано с размером SDP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-284">The size of SDP primarily causes this.</span></span> <span data-ttu-id="51f8f-285">Однако если за SBC находится магистраль UDP, оно может отклонить сообщение, если оно будет перенапращено с прокси-сервера SIP Корпорации Майкрософт на неизмененную.</span><span class="sxs-lookup"><span data-stu-id="51f8f-285">However, if there is a UDP trunk behind the SBC, it might reject the message if it is forwarded from the Microsoft SIP proxy to the trunk unmodified.</span></span> <span data-ttu-id="51f8f-286">Корпорация Майкрософт рекомендует обрезать некоторые значения в SDP на SBC при отправке сообщения на ленту UDP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-286">Microsoft recommends stripping some values in SDP on the SBC when sending the message to the UDP trunks.</span></span> <span data-ttu-id="51f8f-287">Например, можно удалить соитли ICE или неиспользованые кодеки.</span><span class="sxs-lookup"><span data-stu-id="51f8f-287">For example, the ICE candidates or unused codecs can be removed.</span></span>

## <a name="call-transfer"></a><span data-ttu-id="51f8f-288">Перена передаче вызовов</span><span class="sxs-lookup"><span data-stu-id="51f8f-288">Call transfer</span></span>

<span data-ttu-id="51f8f-289">Прямая маршрутия поддерживает два способа перенаправки вызовов:</span><span class="sxs-lookup"><span data-stu-id="51f8f-289">Direct Routing supports two methods for call transfer:</span></span>

- <span data-ttu-id="51f8f-290">Вариант 1.</span><span class="sxs-lookup"><span data-stu-id="51f8f-290">Option 1.</span></span> <span data-ttu-id="51f8f-291">Процессы прокси-сервера SIP. Они относятся к локальному клиенту и выступают в качестве посредника, как описано в разделе 7.1 RFC 3892.</span><span class="sxs-lookup"><span data-stu-id="51f8f-291">SIP proxy processes Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span></span>

  <span data-ttu-id="51f8f-292">При этом прокси-сервер SIP прекращает передачу и добавляет новое приглашение.</span><span class="sxs-lookup"><span data-stu-id="51f8f-292">With this option, the SIP proxy terminates the transfer and adds a new Invite.</span></span> 


- <span data-ttu-id="51f8f-293">Вариант 2.</span><span class="sxs-lookup"><span data-stu-id="51f8f-293">Option 2.</span></span> <span data-ttu-id="51f8f-294">Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве переносителя, как описано в разделе 6 RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="51f8f-294">SIP proxy sends the Refer to the SBC and acts as a Transferor as describing in Section 6 of RFC 5589.</span></span>

  <span data-ttu-id="51f8f-295">При этом прокси-сервер SIP отправляет ссылку на SBC и ожидает, что SBC полностью обработать передачу.</span><span class="sxs-lookup"><span data-stu-id="51f8f-295">With this option, the SIP proxy sends a Refer to the SBC and expects the SBC to handle the Transfer fully.</span></span>

<span data-ttu-id="51f8f-296">Прокси-сервер SIP выбирает метод на основе возможностей, о возможностях, о которые сообщает SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-296">The SIP proxy selects the method based on the capabilities reported by the SBC.</span></span> <span data-ttu-id="51f8f-297">Если SBC указывает на то, что он поддерживает метод "Refer", прокси-сервер SIP будет использовать вариант 2 для перенаправок.</span><span class="sxs-lookup"><span data-stu-id="51f8f-297">If the SBC indicates that it supports the method “Refer”, the SIP proxy will use Option 2 for call transfers.</span></span>

<span data-ttu-id="51f8f-298">Ниже по образцу SBC отправляется сообщение о том, что метод Refer поддерживается:</span><span class="sxs-lookup"><span data-stu-id="51f8f-298">The following is an example of an SBC sending the message that the Refer method is supported:</span></span>

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

<span data-ttu-id="51f8f-299">Если SBC не указывает на то, что использовать ссылку как поддерживаемый метод, то при прямой маршрутике будет применяться вариант 1 (прокси-сервер SIP выступает в качестве подмножества).</span><span class="sxs-lookup"><span data-stu-id="51f8f-299">If the SBC doesn’t indicate that Refer as a supported method, Direct Routing will use Option 1 (SIP proxy acts as a Referee) .</span></span> <span data-ttu-id="51f8f-300">Кроме того, SBC должен сигнализировать о том, что он поддерживает метод Notify:</span><span class="sxs-lookup"><span data-stu-id="51f8f-300">The SBC  must also signal that it supports the Notify method:</span></span>

<span data-ttu-id="51f8f-301">Пример SBC, указывающий на то, что метод Refer не поддерживается:</span><span class="sxs-lookup"><span data-stu-id="51f8f-301">Example of SBC indicating that Refer method is not supported:</span></span>

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a><span data-ttu-id="51f8f-302">Процессы прокси-сервера SIP Относятся к локальному клиенту и выступают в качестве посредника</span><span class="sxs-lookup"><span data-stu-id="51f8f-302">SIP proxy processes Refer from the client locally and acts as a Referee</span></span>

<span data-ttu-id="51f8f-303">Если SBC указал, что метод Refer не поддерживается, прокси-сервер SIP выступает в качестве доверяемого.</span><span class="sxs-lookup"><span data-stu-id="51f8f-303">If the SBC indicated that the Refer method is not supported, the SIP proxy acts as a Referee.</span></span> 

<span data-ttu-id="51f8f-304">Запрос на ссылку, который приходит от клиента, будет прекращен на прокси-сервере SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-304">The Refer request that comes from the client will be terminated on the SIP proxy.</span></span> <span data-ttu-id="51f8f-305">(На приведенной ниже схеме запрос на передачу от клиента показан как "Передача вызовов Для Вас".</span><span class="sxs-lookup"><span data-stu-id="51f8f-305">(The Refer request from the client is shown as “Call transfer to Dave” in the following diagram.</span></span>  <span data-ttu-id="51f8f-306">Дополнительные сведения см. в разделе 7.1 [RFC 3892.](https://www.ietf.org/rfc/rfc3892.txt)</span><span class="sxs-lookup"><span data-stu-id="51f8f-306">For more information, see section 7.1 of [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="51f8f-307">![Схема с несколькими конечными точками, которые звонят с временным ответом](media/direct-routing-protocols-4.png)</span><span class="sxs-lookup"><span data-stu-id="51f8f-307">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-4.png)</span></span>

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a><span data-ttu-id="51f8f-308">Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве посредника</span><span class="sxs-lookup"><span data-stu-id="51f8f-308">SIP proxy send the Refer to the SBC and acts as a Transferor</span></span>

<span data-ttu-id="51f8f-309">Этот способ является предпочтительным и является обязательным для устройств, которые ищут сертификацию обхода мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="51f8f-309">This is the preferred method for call transfers, and it is mandatory for devices seeking media bypass certification.</span></span> <span data-ttu-id="51f8f-310">Передача вызовов без использования SBC для обработки ссылок не поддерживается в режиме обхода мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="51f8f-310">Call Transfer without the SBC being able to handle Refer is not supported in media bypass mode.</span></span> 

<span data-ttu-id="51f8f-311">Стандартное можно объяснить в разделе 6 RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="51f8f-311">The standard is explained in Section 6 of RFC 5589.</span></span> <span data-ttu-id="51f8f-312">Связанными будут:</span><span class="sxs-lookup"><span data-stu-id="51f8f-312">The related RFCs are:</span></span>

- [<span data-ttu-id="51f8f-313">Управление звонками по протоколу SIP (Session Initiation Protocol, SIP) — передача</span><span class="sxs-lookup"><span data-stu-id="51f8f-313">Session Initiation Protocol (SIP) Call Control - Transfer</span></span>](https://tools.ietf.org/html/rfc5589)

- [<span data-ttu-id="51f8f-314">Заглавный заглавный протокол SIP заменяет</span><span class="sxs-lookup"><span data-stu-id="51f8f-314">Session Initiation Protocol (SIP) "Replaces" Header</span></span>](https://tools.ietf.org/html/rfc3891)

- [<span data-ttu-id="51f8f-315">Механизм SIP</span><span class="sxs-lookup"><span data-stu-id="51f8f-315">Session Initiation Protocol (SIP) "Referred-By" mechanism</span></span>](https://tools.ietf.org/html/rfc3892)

<span data-ttu-id="51f8f-316">Предполагается, что прокси-сервер SIP выступает в качестве переносителя и отправляет сообщение "Ссылка" в SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-316">This option assumes that the SIP proxy acts as a Transferor and sends a Refer message to the SBC.</span></span> <span data-ttu-id="51f8f-317">SBC выступает в качестве переносимой и обрабатывает ссылку для создания нового предложения для передачи.</span><span class="sxs-lookup"><span data-stu-id="51f8f-317">The SBC acts as a Transferee and handles the Refer to generate a new offer for transfer.</span></span> <span data-ttu-id="51f8f-318">Возможны два случая:</span><span class="sxs-lookup"><span data-stu-id="51f8f-318">There are two possible cases:</span></span>

- <span data-ttu-id="51f8f-319">Звонок будет перенаправлен внешнему участнику ОКП.</span><span class="sxs-lookup"><span data-stu-id="51f8f-319">The call is transferred to an external PSTN participant.</span></span> 
- <span data-ttu-id="51f8f-320">Звонок передается от одного пользователя Teams другому пользователю Teams в том же клиенте через SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-320">The call is transferred from one Teams user to another Teams user in the same tenant via the SBC.</span></span> 

<span data-ttu-id="51f8f-321">Если звонок передается от одного пользователя Teams другому через SBC, предполагается, что SBC выдает новое приглашение (начать новое диалоговое окно) для целевого пользователя Teams, используя сведения, полученные в сообщении Refer.</span><span class="sxs-lookup"><span data-stu-id="51f8f-321">If the call is transferred from one Teams user to another via the SBC, the SBC is expected to issue a new invite (start a new dialog) for the transfer target (the Teams user) using the information received in the Refer message.</span></span> 

<span data-ttu-id="51f8f-322">Чтобы заполнить поля To/Transferor для транзакции запроса внутри нее, прокси-сервер SIP должен передавать эти сведения в заглавных полях REFER-TO/REFERRED-BY.</span><span class="sxs-lookup"><span data-stu-id="51f8f-322">To populate the To/Transferor fields for the transaction of the request internally, the SIP proxy needs to convey this information  inside the REFER-TO/REFERRED-BY headers.</span></span> 

<span data-ttu-id="51f8f-323">Прокси-сервер SIP будет формировать REFER-TO как URI SIP, состоящий из FQDN прокси-сервера SIP в имени хоста и одного из следующих uri:</span><span class="sxs-lookup"><span data-stu-id="51f8f-323">The SIP proxy will form the REFER-TO as a SIP URI comprised of a SIP proxy FQDN in the hostname and either one of the following:</span></span>

- <span data-ttu-id="51f8f-324">Номер телефона E.164 в части URI имени пользователя, если целевым объектом передачи является номер телефона или</span><span class="sxs-lookup"><span data-stu-id="51f8f-324">An E.164 phone number in the username part of the URI in case the transfer target is a phone number, or</span></span>

- <span data-ttu-id="51f8f-325">параметры x-m и x-t, кодющие полный целевой показатель MRI и код клиента соответственно</span><span class="sxs-lookup"><span data-stu-id="51f8f-325">x-m and x-t parameters encoding the full transfer target MRI and tenant ID respectively</span></span> 

<span data-ttu-id="51f8f-326">Заглавная таблица REFERRED-BY — это URI SIP с кодом MRI-передачи, а также кодом клиента-переносителя и другими параметрами контекста передачи, как показано в таблице ниже.</span><span class="sxs-lookup"><span data-stu-id="51f8f-326">The REFERRED-BY header is a SIP URI with transferor MRI encoded in it as well as transferor tenant ID and other transfer context parameters as shown in the following table:</span></span>

| <span data-ttu-id="51f8f-327">Параметр</span><span class="sxs-lookup"><span data-stu-id="51f8f-327">Parameter</span></span> | <span data-ttu-id="51f8f-328">Значение</span><span class="sxs-lookup"><span data-stu-id="51f8f-328">Value</span></span> | <span data-ttu-id="51f8f-329">Описание</span><span class="sxs-lookup"><span data-stu-id="51f8f-329">Description</span></span> |  
|:---------------------  |:---------------------- |:---------------------- |
| <span data-ttu-id="51f8f-330">x-m</span><span class="sxs-lookup"><span data-stu-id="51f8f-330">x-m</span></span> | <span data-ttu-id="51f8f-331">Мрт</span><span class="sxs-lookup"><span data-stu-id="51f8f-331">MRI</span></span> | <span data-ttu-id="51f8f-332">Full MRI of transferor/transfer target as populated by CC</span><span class="sxs-lookup"><span data-stu-id="51f8f-332">Full MRI of transferor/transfer target as populated by CC</span></span> |
| <span data-ttu-id="51f8f-333">x-t</span><span class="sxs-lookup"><span data-stu-id="51f8f-333">x-t</span></span> | <span data-ttu-id="51f8f-334">Идентификатор клиента</span><span class="sxs-lookup"><span data-stu-id="51f8f-334">Tenant ID</span></span> | <span data-ttu-id="51f8f-335">X-t Tenant ID Optional Tenant ID as populated by CC</span><span class="sxs-lookup"><span data-stu-id="51f8f-335">x-t Tenant ID Optional Tenant ID as populated by CC</span></span> |
| <span data-ttu-id="51f8f-336">x-ti</span><span class="sxs-lookup"><span data-stu-id="51f8f-336">x-ti</span></span> | <span data-ttu-id="51f8f-337">Transferor Correlation Id</span><span class="sxs-lookup"><span data-stu-id="51f8f-337">Transferor Correlation Id</span></span> | <span data-ttu-id="51f8f-338">Correlation ID of the call to the transferor</span><span class="sxs-lookup"><span data-stu-id="51f8f-338">Correlation ID of the call to the transferor</span></span> |
| <span data-ttu-id="51f8f-339">x-tt</span><span class="sxs-lookup"><span data-stu-id="51f8f-339">x-tt</span></span> | <span data-ttu-id="51f8f-340">URI передачи целевого звонка</span><span class="sxs-lookup"><span data-stu-id="51f8f-340">Transfer target call URI</span></span> | <span data-ttu-id="51f8f-341">Кодированный URI замены звонка</span><span class="sxs-lookup"><span data-stu-id="51f8f-341">Encoded call replacement URI</span></span> |

<span data-ttu-id="51f8f-342">В этом случае размер заглавной ссылки может быть не более 400 символов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-342">The size of the Refer Header can be up to 400 symbols in this case.</span></span> <span data-ttu-id="51f8f-343">SBC должен поддерживать обработку ссылок с сообщениями размером до 400 символов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-343">The SBC must support handling Refer messages with size up to 400 symbols.</span></span>

> [!div class="mx-imgBorder"]
> <span data-ttu-id="51f8f-344">![Схема с несколькими конечными точками, которые звонят с временным ответом](media/direct-routing-protocols-5.png)</span><span class="sxs-lookup"><span data-stu-id="51f8f-344">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-5.png)</span></span>

## <a name="session-timer"></a><span data-ttu-id="51f8f-345">Сеансовой timer</span><span class="sxs-lookup"><span data-stu-id="51f8f-345">Session timer</span></span>

<span data-ttu-id="51f8f-346">Прокси-сервер SIP поддерживает (всегда предлагает) время сеанса при звонках без обхода, но не предлагает его при обходе звонков.</span><span class="sxs-lookup"><span data-stu-id="51f8f-346">The SIP proxy supports (always offers) the Session Timer on non-bypass calls but does not offer it on bypass calls.</span></span> <span data-ttu-id="51f8f-347">Использование SBC timer сеанса не является обязательным.</span><span class="sxs-lookup"><span data-stu-id="51f8f-347">Use of the Session Timer by the SBC is not mandatory.</span></span>

##  <a name="use-of-request-uri-parameter-userphone"></a><span data-ttu-id="51f8f-348">Использование параметра Request-URI user=phone</span><span class="sxs-lookup"><span data-stu-id="51f8f-348">Use of Request-URI parameter user=phone</span></span>

<span data-ttu-id="51f8f-349">Прокси-сервер SIP анализирует запрос-URI, и если параметр user=phone присутствует, служба обрабатывает URI-запроса как номер телефона, совпадая с номером пользователя.</span><span class="sxs-lookup"><span data-stu-id="51f8f-349">The SIP proxy analyses the Request-URI and if the parameter user=phone is present, the service will handle the Request-URI as a phone number, matching the number to a user.</span></span> <span data-ttu-id="51f8f-350">Если параметра нет, прокси-сервер SIP применяет к типу пользователя Request-URI (номер телефона или адрес SIP).</span><span class="sxs-lookup"><span data-stu-id="51f8f-350">If parameter is not present the SIP proxy applies heuristics to determine  the Request-URI user type (phone number or a SIP address).</span></span>

<span data-ttu-id="51f8f-351">Корпорация Майкрософт рекомендует всегда применять параметр user=phone, чтобы упростить настройку звонков.</span><span class="sxs-lookup"><span data-stu-id="51f8f-351">Microsoft recommends always applying the user=phone parameter to simplify the call setup process.</span></span>

## <a name="history-info-header"></a><span data-ttu-id="51f8f-352">History-Info загона</span><span class="sxs-lookup"><span data-stu-id="51f8f-352">History-Info header</span></span>

<span data-ttu-id="51f8f-353">Заглавный History-Info используется для перенаустанавливации запросов SIP и стандартного механизма записи сведений об истории запросов, чтобы обеспечить поддержку широкого круга служб для сетей и конечных пользователей."</span><span class="sxs-lookup"><span data-stu-id="51f8f-353">The History-Info header is used for retargeting SIP requests and “provide(s) a standard mechanism for capturing the request history information to enable a wide variety of services for networks and end-users.”</span></span> <span data-ttu-id="51f8f-354">Дополнительные сведения см. в разделе [RFC 4244 — раздел 1.1.](http://www.ietf.org/rfc/rfc4244.txt)</span><span class="sxs-lookup"><span data-stu-id="51f8f-354">For more information, see [RFC 4244 – Section 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span></span> <span data-ttu-id="51f8f-355">Для телефонной системы Майкрософт этот замещающий номер используется в сценариях "Simulring" и "Переад номера звонков".</span><span class="sxs-lookup"><span data-stu-id="51f8f-355">For Microsoft Phone System, this header is used in Simulring and Call Forwarding scenarios.</span></span>  

<span data-ttu-id="51f8f-356">При отправке History-Info включен следующим образом:</span><span class="sxs-lookup"><span data-stu-id="51f8f-356">If sending, the History-Info is enabled as follows:</span></span>

- <span data-ttu-id="51f8f-357">Прокси-сервер SIP вставит параметр, содержащий связанный номер телефона, в отдельные записи History-Info, которые включают History-Info, отправленные на контроллер ЗВОНКОВ.</span><span class="sxs-lookup"><span data-stu-id="51f8f-357">The SIP proxy will insert a parameter containing the associated phone number in individual History-Info entries that comprise the History-Info header sent to the PSTN Controller.</span></span>  <span data-ttu-id="51f8f-358">Если использовать только записи с параметром номера телефона, контроллер ЗВОНКОВ перестроит новый History-Info и передаст его поставщику услуг связи SIP через прокси-сервер SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-358">Using only entries that have the phone number parameter, the PSTN Controller will rebuild a new History-Info header, and pass it on to the SIP trunk provider via SIP proxy.</span></span>

- <span data-ttu-id="51f8f-359">History-Info будут добавлены загон для одновременных звонках и случаев переадад вызовов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-359">History-Info header will be added for simultaneous ring and call forwarding cases.</span></span>

- <span data-ttu-id="51f8f-360">History-Info не будет добавлен для случаев перена передачи вызовов.</span><span class="sxs-lookup"><span data-stu-id="51f8f-360">History-Info header will not be added for call transfer cases.</span></span>

- <span data-ttu-id="51f8f-361">В восстановленном History-Info записи в истории будет параметр номера телефона, предоставленный в сочетании с FQDN прямой маршрутной маршрутии (sip.pstnhub.microsoft.com), который является хост-частью URI; Параметр "пользователь=телефон" будет добавлен в URI SIP.</span><span class="sxs-lookup"><span data-stu-id="51f8f-361">An individual history entry in the reconstructed History-Info header will have the phone number parameter provided combined with the Direct Routing FQDN (sip.pstnhub.microsoft.com) set as the host part of the URI; a parameter of ‘user=phone’ will be added as part of the SIP URI.</span></span>  <span data-ttu-id="51f8f-362">Любые другие параметры, связанные с исходным History-Info, за исключением контекстных параметров телефона, будут передаваться в повторно построенном History-Info.</span><span class="sxs-lookup"><span data-stu-id="51f8f-362">Any other parameters associated with the original History-Info header, except for phone context parameters, will be passed through in the re-constructed History-Info header.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="51f8f-363">Частные записи (в соответствии с механизмами, определенными в разделе 3.3 RFC 4244) будут перенаправлены так же, как и частные записи, так как поставщик услуг связи SIP является доверенным пиром.</span><span class="sxs-lookup"><span data-stu-id="51f8f-363">Entries that are private (as determined by the mechanisms defined in Section 3.3 of RFC 4244) will be forwarded as is because  the SIP trunk provider is a trusted peer.</span></span>

- <span data-ttu-id="51f8f-364">Входящие History-Info игнорируются.</span><span class="sxs-lookup"><span data-stu-id="51f8f-364">Inbound History-Info is ignored.</span></span>

<span data-ttu-id="51f8f-365">Ниже следующую информацию о формате заглавного заглавного управления "История", отправленного прокси-сервером SIP:</span><span class="sxs-lookup"><span data-stu-id="51f8f-365">Following is the format of the History-info header sent by the SIP proxy:</span></span>

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

<span data-ttu-id="51f8f-366">Если звонок перенаправлялся несколько раз, сведения обо всех перенаправлениях включаются с соответствующей причиной в хронологическом порядке.</span><span class="sxs-lookup"><span data-stu-id="51f8f-366">If the call was redirected several times, information about every redirect is included with the appropriate reason in chronological order.</span></span>


<span data-ttu-id="51f8f-367">Пример заглавного за</span><span class="sxs-lookup"><span data-stu-id="51f8f-367">Header Example:</span></span>

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

<span data-ttu-id="51f8f-368">Этот History-Info защищен с помощью обязательного механизма TLS.</span><span class="sxs-lookup"><span data-stu-id="51f8f-368">The History-Info is protected by a mandatory TLS mechanism.</span></span> 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a><span data-ttu-id="51f8f-369">Подключение SBC к прямой маршрутике и механизму отбойного управления</span><span class="sxs-lookup"><span data-stu-id="51f8f-369">SBC connection to Direct Routing and failover mechanism</span></span>

<span data-ttu-id="51f8f-370">См. раздел Механизм отрезка для сигнального сигнала SIP в [статье Планирование прямой маршрутизации.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)</span><span class="sxs-lookup"><span data-stu-id="51f8f-370">See the section Failover mechanism for SIP signaling in [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span></span>

## <a name="retry-after"></a><span data-ttu-id="51f8f-371">Retry-After</span><span class="sxs-lookup"><span data-stu-id="51f8f-371">Retry-After</span></span>

<span data-ttu-id="51f8f-372">Если центр обработки данных Direct Routing занят, служба может отправить Retry-After с интервалом в одну секунду в SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-372">If a Direct Routing datacenter is busy, the service can send a Retry-After message with a one-second interval to the SBC.</span></span> <span data-ttu-id="51f8f-373">Когда SBC получает сообщение 503 с Retry-After в ответ на приглашение, он должен прервать это подключение и попробовать следующий доступный центр обработки данных Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="51f8f-373">When the SBC receives a 503 message with a Retry-After header in response to an INVITE, the SBC must terminate that connection and try the next available Microsoft datacenter.</span></span>

## <a name="handling-retries-603-response"></a><span data-ttu-id="51f8f-374">Обработка ирисовки (603 ответа)</span><span class="sxs-lookup"><span data-stu-id="51f8f-374">Handling retries (603 response)</span></span>
<span data-ttu-id="51f8f-375">Если пользователь наблюдает несколько пропущенных звонков для одного звонка после его отступа, это означает, что механизм повторной работы поставщика услуг связи SBC или STN неправильно сконфигурировали.</span><span class="sxs-lookup"><span data-stu-id="51f8f-375">If an end user observes several missed calls for one call after declining the incoming call, it means that the SBC or PSTN trunk provider's retry mechanism is misconfigured.</span></span> <span data-ttu-id="51f8f-376">Чтобы остановить попытку ответов на запрос 603, необходимо перенастроить SBC.</span><span class="sxs-lookup"><span data-stu-id="51f8f-376">The SBC must be reconfigured to stop the retry efforts on the 603 response.</span></span>

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a><span data-ttu-id="51f8f-377">Перезапуск ICE: обход мультимедиа перенаправится на конечную точку, которая не поддерживает обход мультимедиа</span><span class="sxs-lookup"><span data-stu-id="51f8f-377">ICE Restart: Media bypass call transferred to an endpoint that does not support media bypass</span></span>

<span data-ttu-id="51f8f-378">SBC должен поддерживать перезапуски ICE, как описано в [разделе 9.1.1.1.1 RFC 5245.](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)</span><span class="sxs-lookup"><span data-stu-id="51f8f-378">The SBC must support ICE restarts as described in [RFC 5245, section 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span></span>

<span data-ttu-id="51f8f-379">Перезапуск в прямой маршрутике выполняется в соответствии со следующими абзацами RFC:</span><span class="sxs-lookup"><span data-stu-id="51f8f-379">The restart in Direct Routing is implemented according to the following paragraphs of the RFC:</span></span>

<span data-ttu-id="51f8f-380">*Чтобы перезапустить ICE, агент должен изменить льдом и льдом-ufrag для потока мультимедиа в предложении.  Обратите внимание, что атрибуты уровня сеанса можно использовать в одном предложении, но использовать тот же атрибут ice-pwd или ice-ufrag, что и атрибуты уровня мультимедиа в последующих предложениях.  Это не изменение пароля, а изменение его представления и не приведет к перезапуску ICE.*</span><span class="sxs-lookup"><span data-stu-id="51f8f-380">*To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.*</span></span>

<span data-ttu-id="51f8f-381">*Агент задает остальные поля в SDP для этого потока мультимедиа так же, как в первоначальном предложении этого потока мультимедиа (см. раздел 4.3).  Следовательно, в набор кандидатов может быть включено несколько, никто или все предыдущие кандидаты для этого потока, а также новый набор кандидатов, собранный в соответствии с разделом 4.1.1.*</span><span class="sxs-lookup"><span data-stu-id="51f8f-381">*An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see Section 4.3).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates gathered as described in Section 4.1.1.*</span></span>

<span data-ttu-id="51f8f-382">Если звонок был изначально установлен с помощью обхода мультимедиа и перенаправлен в клиент Skype для бизнеса, для прямой маршрутии требуется вставить процессор мультимедиа, так как прямая маршрутия не может использоваться с клиентом Skype для бизнеса с обходом мультимедиа.</span><span class="sxs-lookup"><span data-stu-id="51f8f-382">If the call was initially established with media bypass, and the call is transferred to a Skype for Business client, Direct Routing needs to insert a Media Processor--this is because Direct Routing cannot be used with a Skype for Business client with media bypass.</span></span> <span data-ttu-id="51f8f-383">Прямая маршрутизации запускает процесс перезапуска ICE, изменяя льдом и льдом-ufrag и предлагая новых кандидатов мультимедиа в повторной обработке.</span><span class="sxs-lookup"><span data-stu-id="51f8f-383">Direct Routing starts the ICE restart process by  changing the ice-pwd and ice-ufrag and offering new media candidates in a reinvite.</span></span>
