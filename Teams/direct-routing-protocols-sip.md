---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутизации
appliesto:
- Microsoft Teams
ms.openlocfilehash: 6b93ea469a1a27e796b5cc2016fd63c9cfd3acdd
ms.sourcegitcommit: 1a08ec9069332e19135312d35fc6a6c3247ce2d2
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/11/2020
ms.locfileid: "41888568"
---
# <a name="direct-routing---sip-protocol"></a>Direct Routing-протокол SIP

В этой статье описано, как прямая маршрутизация реализует протокол SIP. Чтобы правильно маршрутизировать трафик между контроллером границ сеанса (SBC) и прокси SIP, некоторые параметры SIP должны иметь определенные значения. Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку соединения между локальным SBC и прокси-службой SIP.

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>Обработка входящего запроса: Поиск клиента и пользователя

Во входящем звонке прокси-сервер SIP должен найти клиента, которому адресован звонок, и найти определенного пользователя в этом клиенте. Администратор клиента может настроить невыполненные номера, например + 1001, в нескольких клиентах. Таким образом, важно найти определенного клиента, для которого нужно выполнить просмотр номера, так как невыполненные номера могут быть одинаковыми в нескольких клиентах Office 365.  

В этом разделе показано, как прокси-сервер SIP находит клиент и пользователя, а также выполняет проверку подлинности SBC для входящего подключения.

Ниже приведен пример сообщения INVITE протокола SIP на входящем звонке.

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| URI запроса | ПРИГЛАСИТЬ sip:+18338006777@sip.pstnhub.microsoft.com SIP/2,0 |
| С помощью заголовка | Via: SIP/2.0/TLS sbc1. адатум. раздел: 5058; Alias; Branch = z9hG4bKac2121518978 | 
| Верхний колонтитул Max-Forwards | Макс. Пересылка: 68 |
| От верхнего колонтитула | Из заголовка из: <SIP: 7168712781@sbc1. адатум. раздел; Transport = UDP; Tag = 1c747237679 |
| В верхний колонтитул | Кому: sip:+183338006777@sbc1.adatum.biz | 
| Заголовок Ксек | Ксек: 1 пригласить | 
| Заголовок контакта | Контакт: <SIP: 68712781@sbc1. адатум. раздел; Transport = TLS> | 

Получив приглашение, прокси-сервер SIP выполняет следующие действия:

1. Проверьте сертификат. При первоначальном подключении служба прямой маршрутизации получает полное доменное имя, представленное в заголовке контакта, и сопоставляет его с общим именем или альтернативным именем предоставленного сертификата. Имя SBC должно совпадать с одним из следующих вариантов:

   - Вариант 1. Полное ДОМЕНное имя, представленное в заголовке контакта, должно совпадать со стандартным именем или названием субъекта предоставленного сертификата.  

   - Вариант 2. Доменное имя FQDN, представленное в заголовке контакта (например, adatum.biz полного доменного имени sbc1.adatum.biz), должно соответствовать подстановочному значению в общем имени или альтернативном имени для темы (например, *. adatum.biz).

2. Попробуйте найти клиента, используя полное ДОМЕНное имя, представленное в заголовке контакта.  

   Убедитесь в том, что полное доменное имя из заголовка контакта (sbc1.adatum.biz) зарегистрировано как DNS-имя в любом клиенте Office 365. Если найден, Поиск пользователя выполняется в клиенте с полным доменным именем SBC, зарегистрированным в качестве доменного имени. Если не найдено, применяется шаг 3.   

3. Действие 3 применимо только в том случае, если шаг 2 не удался. 

   Удалите часть узла из полного доменного имени, представленной в заголовке контакта (FQDN: sbc12.adatum.biz, после удаления части Host: adatum.biz), и убедитесь, что это имя зарегистрировано как DNS-имя в любом клиенте Office 365. Если найден, Поиск пользователя выполняется в этом клиенте. Если он не найден, вызов завершается сбоем.

4. Используя номер телефона, представленный в URI запроса, выполните обратный просмотр номера в клиенте, найденном на этапе 2 или 3. Сопоставить предоставленный телефонный номер URI-адресу SIP пользователя в клиенте, найденном на предыдущем этапе.

5. Примените параметры магистрали. Найдите параметры, заданные администратором клиента для этого SBC.

   Корпорация Майкрософт не поддерживает для прокси-сервера SIP или сервер агента пользователя, не поддерживающие прокси-серверы, а также один и тот же объект, который может изменить URI запроса, созданный с помощью парного SBC.

   Требования для двух подстановок (шаги 2 и 3), необходимые для сценария, где один SBC связан с многочисленными клиентами (сценарий с несущей), рассматриваются ниже в этой статье.

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>Подробные требования для заголовка и запроса URI для контакта

#### <a name="contact-header"></a>Заголовок контакта

Для всех входящих звонков на прокси-сервер Microsoft SIP в заголовке контакта должно быть указано полное доменное имя одноименного SBC в имени узла URI.

Синтаксис: Contact: <SIP: Phone или SIP address@FQDN SBC; Transport = TLS> 

Это имя должно быть также представлено в поле "замещающий имя" или "в списке субъектов" для предоставленного сертификата. Корпорация Майкрософт поддерживает использование подстановочных знаков в полях "Общее имя" или "дополнительное имя субъекта" сертификата.   

Поддержка подстановочных знаков описана в [документе RFC 2818, который можно получить в разделе 3,1](https://tools.ietf.org/html/rfc2818#section-3.1). Предназначены

*Имя может содержать подстановочный знак \* , который рассматривается как один компонент доменного имени или фрагмент компонента. Например, \*. a.com соответствует foo.a.com, но не Bar.foo.a.com. f\*. com соответствует foo.com, но не Bar.com ".*

Если несколько значений в заголовке контакта, представленном в сообщении SIP, отправляется с помощью SBC, используется только часть полного имени из первого значения заголовка Contact.

#### <a name="request-uri"></a>URI запроса 

Для всех входящих вызовов URI запроса — используется для сопоставления номера телефона с пользователем.   

В настоящее время номер телефона должен содержать знак "плюс" (+), как показано в следующем примере. 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a>Контакты и записи: рекомендации для заголовков маршрутов

Прокси-серверу SIP требуется вычислить полное доменное имя следующего прыжка для новых клиентских транзакций в диалоговом окне (например, пока или повторное приглашение), а также при ответе на параметры SIP. Используется либо контакт, либо маршрут записи. 

Согласно стандарту RFC 3261, в любом запросе, который может привести к новому диалоговому окну, требуется заголовок Contact. Маршрут записи требуется только в том случае, если прокси-сервер хочет сохранить путь для будущих запросов в диалоговом окне. 

Корпорация Майкрософт рекомендует использовать только заголовок Contact по следующим причинам:

- В соответствии с RFC 3261 используется маршрут записи, если прокси-сервер хочет сохранить путь к запросам будущих запросов в диалоговом окне, что не важно, так как весь трафик проходит между прокси-сервером SIP и парным SBC. Промежуточный прокси-сервер не нужен для прокси-сервера SBC и Microsoft SIP.

- Прокси-сервер Microsoft SIP использует только заголовок контакта (но не маршрут записи) для определения следующего прыжка при отправке исходящих параметров ping. Для упрощения администрирования следует настроить только один параметр (контакт) вместо двух (контактных данных и маршрутов записи).

Для вычисления следующего прыжка прокси-сервер SIP использует:

- Приоритет 1. Маршрут записи верхнего уровня. Если маршрут записи верхнего уровня содержит полное доменное имя или IP-адрес, используется полное доменное имя или IP-адрес, чтобы сделать исходящее подключение в диалоговом окне.

- Приоритет 2. Заголовок контакта. Если маршрут записи не существует, прокси-сервер SIP выполнит поиск значения заголовка Contact, чтобы сделать исходящее подключение. (Это рекомендуемая конфигурация.)

Если используются как контакт, так и маршрут записи, администратор SBC должен сохранить значения одинаково, что приводит к дополнительным затратам на администрирование. 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>Использование полного доменного имени в контакте или записи в маршруте

Использование IP-адреса не поддерживается ни в одной записи, ни на маршруте, ни в контакте. Единственным поддерживаемым вариантом является полное доменное имя, которое должно совпадать либо с общим именем, либо с другим именем темы сертификата SBC (значения подстановочных знаков в сертификате поддерживаются).

- Если IP-адрес указан в разделе запись (маршрут или контакт), проверка сертификата завершается сбоем, и вызов завершается сбоем.

- Если полное доменное имя не совпадает со значением общего или альтернативного имени субъекта в представленном сертификате, вызов завершается сбоем. 

## <a name="inbound-call-sip-dialog-description"></a>Входящий звонок: Описание диалогового окна SIP

В таблице ниже приведено краткое описание различий в потоке звонков и других параметров, не являющихся режимами обхода:

| Имя параметра | Режим без обхода | Режим пропуска
| :---------------------  |:---------------------- |:----------------|
| Потенциальные мультимедийные сообщения в 183 и 200, поступающие из | Процессоры мультимедиа | Клиенты | 
| Количество сообщений 183, которые может принимать SBC | По одному на сеанс | Сервер | 
| Ответ на звонок можно получить с помощью предварительной подконтрольной подготовки (183) | Да | Да |
| Звонок может быть недоступен для предварительного ответа (183) | Да | Да |

###  <a name="non-media-bypass-flow"></a>Поток обхода файлов без мультимедиа

У пользователя Teams может быть несколько конечных точек одновременно. Например, Teams для клиента Windows, Teams для iPhone и Team Phone (клиентская группа Android). Каждая конечная точка может сообщить о себе HTTP-части следующим образом:

-   Ход вызова, преобразованный прокси SIP в сообщение SIP 180. При получении сообщения 180, SBC должен создать локальный звонок.

-   Ответ на мультимедиа, преобразованный прокси SIP на сообщение 183 с кандидатами мультимедиа в протоколе описания сеансов (SDP). При получении сообщения 183 в коде SBC ожидается соединение с кандидатами мультимедиа, полученными в сообщении SDP. Обратите внимание, что в некоторых случаях ответ на мультимедиа может не генерироваться, и конечная точка может ответить на сообщение "звонок принят".

-   Звонки принимаются через прокси-сервер SIP в сообщение SIP 200 с помощью SDP. При получении сообщения 200 ожидается, что SBC будет отправлять и получать носители от предоставленных кандидатов SDP.

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>Несколько конечных точек с ответом на предварительный Звонок

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 пытается" и оповещает все конечные точки конечных пользователей о входящем звонке. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщения "ход выполнения звонка" на прокси-сервер SIP. Так как пользователь Teams может иметь несколько конечных точек, прокси-сервер SIP может получать сообщения о ходе выполнения звонка.

3.  Для каждого сообщения о ходе выполнения звонка, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 пытается". Интервал отправки таких сообщений определяется интервалом приема сообщений от контроллера звонков. На приведенной ниже схеме есть сообщения 2 180, созданные прокси-сервером SIP. Эти сообщения поступают из двух конечных точек пользователя Teams. У каждого клиента есть уникальный идентификатор тега.  Каждое сообщение, поступающие из другой конечной точки, будет отдельным сеансом (параметр "тег" в поле "Кому" будет отличаться). Но конечная точка может не создать сообщение 180 и отправить сообщение 183 прямо дальше, как показано на следующей схеме.

4.  После того как конечная точка создаст сообщение ответа на мультимедиа с IP-адресом кандидатов конечной точки, прокси-сервер SIP преобразует сообщение, полученное в сообщении о ходе сеанса SIP 183, с помощью SDP, заменяя SDP из обработчика мультимедиа. На приведенной ниже схеме конечная точка из вилки 2 ответила на звонок. Если магистраль не пропускается, сообщение SIP 183 генерируется только один раз (Bot или конечная точка клиента). 183 может находиться на существующей вилке или начать новую.

5.  Сообщение о принятии вызова отправляется с конечными кандидатами конечной точки, принимающей звонок. Сообщение о принятии звонка будет преобразовано в сообщение SIP 200. 

![Схема, на которой показано несколько конечных точек с ответом на предварительный Звонок](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>Несколько конечных точек звонить без предварительного ответа

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 пытается" и оповещает все конечные точки конечных пользователей о входящем звонке. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщение "ход звонка" на прокси-сервер SIP. Так как пользователь Teams может иметь несколько конечных точек, прокси-сервер SIP может получать сообщения о ходе выполнения звонка.

3.  Для каждого сообщения о ходе выполнения звонка, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 пытается".  Интервал отправки сообщений определяется интервалом получения сообщений от контроллера звонков. На рисунке ниже есть сообщения 2 180, созданные прокси SIP, то есть пользователь вошел в три клиента Teams и каждый клиент отправляет ход вызова. Каждое сообщение будет отдельным сеансом (тег "" to ") в поле" Кому "(другое)

4.  Сообщение о принятии вызова отправляется с конечными кандидатами конечной точки, принимающей звонок. Сообщение о принятии звонка будет преобразовано в сообщение SIP 200. 

![Схема, на которой показано несколько конечных точек звонок без предварительного ответа](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>Поток обхода мультимедиа

Такие же сообщения (100 пытается, 180, 183) используются в сценарии обхода мультимедиа. 

В приведенной ниже схеме показан пример пропуска потока вызова. Обратите внимание, что кандидаты мультимедиа могут поступать из разных конечных точек. 

![Схема, на которой показано несколько конечных точек с ответом на предварительный Звонок](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>Параметр "замена"

SBC должен поддерживать приглашение с замещением.

## <a name="size-of-sdp-considerations"></a>Сведения о размере SDP

Интерфейс Direct Routing может отправлять сообщение SIP, превышающее 1 500 байт.  Размер SDP в основном вызывает это. Тем не менее, если в SBC есть магистральная линия UDP, она может отклонить сообщение, если оно переадресовано с прокси-сервера SIP Microsoft на магистраль в неизменном виде. Корпорация Майкрософт рекомендует при отправке сообщения в магистральные UDP-магистрали отменять некоторые значения в SDP на SBC. Например, можно удалить кандидатов на ICE или неиспользуемые кодеки.

## <a name="call-transfer"></a>Передача вызова

Прямая маршрутизация поддерживает два способа передачи звонков.

- Вариант 1. Прокси-серверы SIP ссылаются с клиента на локальный и действуют как рефери, как описано в разделе 7,1 из RFC 3892.

  С помощью этого параметра прокси-сервер SIP завершает передачу и добавляет новое приглашение. 


- Вариант 2. Прокси-сервер SIP отправляет ссылку на SBC и действует в качестве средства пересылки, как описано в разделе 6 документа RFC 5589.

  С помощью этого параметра прокси-сервер SIP отправляет ссылку на SBC и ожидает, что объект SBC полностью обрабатывает передачу.

Прокси-сервер SIP выбирает метод на основе возможностей, предоставленных SBC. Если SBC указывает на то, что он поддерживает метод "ссылка", прокси-сервер SIP будет использовать вариант 2 для передачи звонков.

Ниже приведен пример SBC, отправляющего сообщение о том, что метод ссылки поддерживается.

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

Если SBC не показывает, что он поддерживает поддерживаемый метод, прямая маршрутизация будет использовать вариант 1 (прокси-сервер SIP выступает в качестве рефери). SBC также должен сообщить, что он поддерживает метод notify:

Пример SBC, указывающий на то, что метод ссылки не поддерживается:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>Прокси-серверы SIP ссылаются с клиента на локальный и функционируют как Рефери

Если в SBC указано, что метод ссылки не поддерживается, прокси-сервер SIP действует как рефери. 

Запрос ссылки, поступающий из клиента, будет прекращен на прокси-сервере SIP. (Запрос на получение ссылки от клиента показан в виде "позвонить на Дэйв" на следующей схеме.  Дополнительные сведения можно найти в разделе 7,1 из [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt). 

![Схема, на которой показано несколько конечных точек с ответом на предварительный Звонок](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>Прокси-сервер SIP отправляет ссылку на SBC и действует как переправитель.

Этот способ является предпочтительным для передачи звонков и является обязательным для устройств, исключающих сертификацию мультимедиа. Передача вызова без SBC, которая может обрабатывать ссылку, не поддерживается в режиме обхода мультимедиа. 

Эти стандарты описаны в разделе 6 документа RFC 5589. Ниже приведены соответствующие документы RFC.

- [Управление вызовами протокола запуска сеансов (SIP)-передача данных](https://tools.ietf.org/html/rfc5589)

- [Заголовок "заменяет протоколом запуска сеансов (SIP)"](https://tools.ietf.org/html/rfc3891)

- [Механизм, на который ссылается протокол SIP](https://tools.ietf.org/html/rfc3892)

Этот параметр предполагает, что прокси-сервер SIP выступает в качестве перенаправляющего и отправляет сообщение о ссылке на SBC. SBC действует как получатель и обрабатывает ссылку для создания нового предложения для передачи. Возможны два варианта:

- Звонок будет передан внешнему абоненту PSTN. 
- Вызов передается от одного пользователя Teams другому пользователю Teams в том же клиенте через SBC. 

Если звонок передается из одного пользователя группы на другой через SBC, предполагается, что SBC выдаст новое приглашение (начать новое диалоговое окно) для целевого объекта передачи (пользователя Teams) с использованием сведений, полученных в сообщении об ошибке. 

Для внутреннего заполнения полей "Кому" и "Пересылка" для транзакции запроса прокси-сервер SIP должен передать эти данные внутри заголовков "ссылка на/ссылка". 

Прокси-сервер SIP будет ссылаться на ссылку в качестве URI SIP, состоящего из полного доменного имени прокси-сервера SIP, и одного из указанных ниже вариантов.

- Номер телефона E. 164 в части имени пользователя URI в случае, если цель передачи — номер телефона, или

- параметры x-m и x-t заключают полную пересылку МРИ и идентификатор клиента соответственно. 

УПОМЯНУТый заголовок — это URI SIP с МРИ, который закодирован в нем, а также ИДЕНТИФИКАТОРом клиента пересылки и другими параметрами контекста передачи, как показано в следующей таблице:

| Параметр | Значение | Описание |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | мри | Полный МРИ объекта пересылки/передачи, заполненный CC |
| x-t | Идентификатор клиента | Идентификатор клиента x-t — необязательный идентификатор клиента, заполненный CC |
| x-Ti | Идентификатор корреляции для пересылки | Идентификатор корреляции вызова для пересылки |
| x-TT | Универсальный код ресурса (URI) для целевого вызова передачи | URI замены закодированного вызова |

В этом случае размер заголовка ссылки может доставлять до 400 символов. SBC должен поддерживать обработку сообщений с размером до 400 символов.

![Схема, на которой показано несколько конечных точек с ответом на предварительный Звонок](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>Таймер сеанса

Прокси-сервер SIP поддерживает (всегда предлагает) таймер сеанса для вызовов, не исключаясь, но не предлагает его в обходных вызовов. Использование таймера сеанса с помощью SBC не является обязательным.

##  <a name="use-of-request-uri-parameter-userphone"></a>Использование параметра Request-URI User = Phone

Прокси-сервер SIP проанализирует URI запроса и, если параметр User = Phone, служба будет обрабатывать запрос URI как номер телефона, который соответствует номеру пользователя. Если параметр не указан, прокси-сервер SIP применяет эвристику для определения типа пользователя Request-URI (номер телефона или адрес SIP).

Микрософ рекомендует всегда применять параметр User = Phone для упрощения процесса настройки звонка.

## <a name="history-info-header"></a>История — заголовок info

Заголовок History-info используется для перенаправления запросов SIP и "предоставить (s) Стандартный механизм для захвата данных журнала запросов, чтобы включить широкий спектр служб для сетей и конечных пользователей". Дополнительные сведения можно найти в [статье RFC 4244 – раздел 1,1](http://www.ietf.org/rfc/rfc4244.txt). Для телефонной системы Microsoft этот заголовок используется в сценариях Симулринг и переадресации звонков.  

При отправке данные о журнале будут включены следующим образом:

- Прокси-сервер SIP вставит параметр, содержащий связанный номер телефона, в отдельные записи журнала — сведения, которые составляют заголовок History – info, отправленный контроллеру КТСОП.  Используя только записи с параметром "телефонный номер", контроллер PSTN перестраивает новый заголовок History-info и передает его в поставщик магистральной службы SIP через прокси-сервер SIP.

- В заголовке история — данные будут добавлены для одновременных звонков и переадресации звонков.

- Закрывающий заголовок "История — данные" не будет добавлен для вариантов передачи звонков.

- Отдельная запись журнала в заголовке реконструированный заголовок info содержит параметр номера телефона в сочетании с полным доменным именем маршрутизации (sip.pstnhub.microsoft.com), установленным в качестве хост-части универсального кода ресурса (URI). параметр "User = Phone" будет добавлен как часть URI SIP.  Любые другие параметры, связанные с исходным заголовком History — info (за исключением параметров контекста телефона), будут переданы в повторно созданном заголовке журнала — info.  Обратите внимание на то, что закрытые записи (в соответствии с механизмами, определенными в разделе 3,3 из RFC 4244) будут переадресованы как есть, так как поставщик магистральной магистрали SIP является надежным одноранговым элементом.

- Журнал входящих сообщений — данные игнорируются.

Ниже приведен формат заголовка History-info, отправляемого прокси SIP:

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

Если звонок был перенаправлен несколько раз, сведения о каждом перенаправлении будут включены по соответствующей причине в хронологическом порядке.


Пример заголовков:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

История — данные защищены обязательным механизмом TLS. 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>Соединение между собой SBC и механизмом перемещения по прямой маршрутизации

Ознакомьтесь с разделом отказоустойчивый механизм сигнализации SIP в разделе [планирование прямой маршрутизации](direct-routing-plan.md#failover-mechanism-for-sip-signaling).

## <a name="retry-after"></a>Повтор — после

Если центр обработки данных, на который осуществляется прямая маршрутизация, занят, служба может отправить односекундное сообщение с помощью одинарного интервала в SBC. Когда SBC получает сообщение 503 с заголовком Retry-After в ответе на приглашение, этот объект должен завершить это подключение и попробовать следующий доступный центр обработки данных Майкрософт. 

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>Перезагрузка ICE: вызов обхода мультимедиа, передаваемый в конечную точку, не поддерживающую обход мультимедиа

SBC должен поддерживать перезапуски ICE, как описано в [RFC 5245, раздел 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).

Перезагрузка в прямом маршруте реализована в соответствии со следующими абзацами RFC:

*Чтобы перезапустить ICE, агент должен изменить оба типа ICE-PWD и Ice-уфраг для потока мультимедиа в предложении.  Обратите внимание, что в одном предложении можно использовать атрибут уровня сеанса, но для того, чтобы предоставить один и тот же объект Ice-PWD или Ice-уфраг как атрибут уровня мультимедиа в последующих предложениях.  Это не является изменением пароля, изменением его представления и не приводит к перезапуску ICE.*

*Агент задает остальные поля в SDP для этого потока мультимедиа так же, как и в первоначальном предложении этого потока мультимедиа (см. раздел 4,3).  Следовательно, набор кандидатов может включать в себя не более одного или всех предыдущих кандидатов для этого потока и может включать совершенно новый набор кандидатов, собранных в соответствии с описанием, описанным в разделе 4.1.1.*

Если звонок первоначально был установлен с пропуском мультимедиа и этот звонок передается клиенту Skype для бизнеса, прямая маршрутизация должна вставить процессор мультимедиа – это связано с тем, что прямая маршрутизация не может использоваться для клиента Skype для бизнеса с пропуском мультимедиа. Прямая маршрутизация запускает процедуру перезапуска ICE, изменяя Ice и уфраг и предлагая новые кандидаты мультимедиа в повторном приглашении. 


