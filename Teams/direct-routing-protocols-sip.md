---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутии
appliesto:
- Microsoft Teams
ms.openlocfilehash: 4fe636029c3a058dc1a8d33cc191d7654888ec5e
ms.sourcegitcommit: 414d077b16a0ae4ea6a49e3b3d0082858174cacb
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2021
ms.locfileid: "50278729"
---
# <a name="direct-routing---sip-protocol"></a>Прямая маршрутия — протокол SIP

В этой статье описано, как direct Routing реализует протокол SIP. Чтобы правильно маршрутировать трафик между контроллером границы сеанса (SBC) и прокси-сервером SIP, некоторые параметры SIP должны иметь определенные значения. Эта статья предназначена для администраторов голосовой связи, отвечающих за настройку подключения между локальной SBC и прокси-службой SIP.

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>Обработка входящих запросов: поиск клиента и пользователя

Перед обработкой входящих и исходящие вызовов сообщения OPTIONS обмениваются между прокси-сервером SIP и SBC. Эти сообщения позволяют прокси-серверу SIP предоставлять разрешенные возможности для SBC. Очень важно, чтобы согласование с options было успешным (ответ 200OK), что обеспечивает дальнейшую связь между SBC и прокси-сервером SIP для установления звонков. В качестве примера ниже приведены заглавные данные SIP в сообщениях OPTIONS для прокси-сервера SIP.

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| Request-URI | OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0 |
| Через заглавную | Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards загона | Max-Forwards:68 |
| С заглавного | В header From: <sip:sbc1.adatum.biz:5058> |
| В заглавную | Кому: <sip:sip.pstnhub.microsoft.com:5061> |
| Загонщик CSeq | CSeq: 1 ПРИГЛАШЕНИЕ | 
| Заглавная информация о контакте | Контакт: <sip:sbc1.adatum.biz:50588;transport=tls> |

> [!NOTE]
> Заглавные данные SIP не содержат userinfo в используемом URI SIP. В соответствии с [RFC 3261, раздел 19.1.1,](https://tools.ietf.org/html/rfc3261#section-19.1.1)часть URI userinfo необязательна и может отсутствовать, если у конечного хоста нет представления о пользователях или когда определен ресурс. Если знак @ присутствует в URI SIP, поле пользователя НЕ должно быть пустым.

Во время входящих звонка прокси-сервер SIP должен найти клиента, в который он перенапрался, и конкретного пользователя в этом клиенте. Администратор клиента может настроить номера без кодов DID, например +1001, в нескольких клиентах. Поэтому важно найти конкретный клиент, для которого нужно выполнить поиск номеров, так как в разных организациях Microsoft 365 или Office 365 номера, не на основе DID, могут быть одинаковыми.  

В этом разделе описывается, как прокси-сервер SIP находит клиента и пользователя, а также выполняет проверку подлинности SBC при входящих подключениях.

Ниже приводится пример приглашения SIP во входящий звонок:

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| Request-URI | INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0 |
| Через заглавную | Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards загона | Max-Forwards:68 |
| С заглавного | From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679 |
| В заглавную | Чтобы: sip:+183338006777@sbc1.adatum.biz | 
| Загонщик CSeq | CSeq: 1 ПРИГЛАШЕНИЕ | 
| Заглавная информация о контакте | Контакт: <SIP: 68712781@sbc1.adatum.biz:5058;transport=tls> | 

При получении приглашения прокси-сервер SIP выполняет следующие действия:

1. Проверьте сертификат. При начальном под соединении служба Direct Routing принимает имя FQDN, которое представлено в названии контакта, и соответствует ему общему имени или альтернативному имени субъекта представляемого сертификата. Имя SBC должно соответствовать одному из следующих вариантов:

   - Вариант 1. Полное имя FQDN, представленное в заглавной части контакта, должно соответствовать общему имени и альтернативному имени субъекта представленного сертификата.  

   - Вариант 2. Часть доменного имени, представленная в названии контакта (например, adatum.biz имени FQDN sbc1.adatum.biz), должна совпадать с поддеревом в именах "Общее имя" и "Альтернативное имя субъекта" (например, *.adatum.biz).

2. Попробуйте найти клиент, используя полное имя полного полного доменного имени, которое представлено в заглавной области контакта.  

   Убедитесь, что имя FQDN из заглавного имени контакта (sbc1.adatum.biz) зарегистрировано как имя DNS в любой организации Microsoft 365 или Office 365. Если пользователь найден, его можно найти в клиенте, для которого FQDN SBC зарегистрирована как доменное имя. Если не удалось найти, применяется шаг 3.   

3. Шаг 3 применяется только в случае сбойного шага 2. 

   Удалите хост-часть из FQDN, представленную в заглавной части контакта (FQDN: sbc12.adatum.biz, после удаления части хоста: adatum.biz) и проверьте, зарегистрировано ли это имя как DNS-имя в любой организации Microsoft 365 или Office 365. При обнаружении выполняется искомый пользователь в этом клиенте. Если он не найден, вызов не удастся найти.

4. Используя номер телефона, представленный в URI запроса, выполните обратный просмотр номера в клиенте, найденном в шагах 2 или 3. Совмесите представленный номер телефона с пользовательским URI SIP в клиенте, найденном на предыдущем шаге.

5. "Применить параметры магистрали". Найдите параметры, заданные администратором клиента для этого SBC.

   Корпорация Майкрософт не поддерживает наличие прокси-сервера SIP или сервера агента пользователя между прокси-сервером Microsoft SIP и сопряженным SBC, что может изменить URI запроса, созданный парным SBC.

   Далее в этой статье огося ого, как требования для двух подытогов (шагов 2 и 3), которые необходимы для сценария, когда один SBC взаимосвязан с множеством клиентов (сценарий оператора).

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>Подробные требования для заглавных и запрашиваемого URI контактов

#### <a name="contact-header"></a>Заглавная информация о контакте

Для всех входящих сообщений SIP (OPTIONS, INVITE) на прокси-сервер Microsoft SIP в имени сервера URI должен быть парный FQDN SBC:

Синтаксис: контакт: <sip:phone или sip address@FQDN SBC;transport=tls> 

В соответствии [с RFC 3261, разделом 11.1](https://tools.ietf.org/html/rfc3261#section-11.1)в сообщении OPTIONS может присутствовать поле "Заглавный контакт". При прямой маршрутике требуется заглавная линия контакта. Для сообщений INVITE в формате выше, для сообщений OPTIONS, которые userinfo можно удалить из SIP URI и только FQDN отправлен в формате:

Синтаксис: контакт: <sip:FQDN SBC;transport=tls>

Это имя (FQDN) должно также быть в полях "Общее имя" или "Альтернативное имя субъекта" для сертификата. Корпорация Майкрософт поддерживает использование поддеревных значений имен в полях "Общее имя" или "Альтернативное имя субъекта" сертификата.   

Поддержка поддеревок описана в разделе [3.1 RFC 2818.](https://tools.ietf.org/html/rfc2818#section-3.1) В частности:

*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. Например, .a.com соответствует foo.a.com, но не bar.foo.a.com. f .com соответствует foo.com но не \* \* bar.com".*

Если SBC отправляет несколько значений в заглавном сообщении контакта, относясь к SBC, используется только часть FQDN первого значения.

Как правило, для прямой маршрутки важно использовать FQDN для заполнения SIP URI вместо IP-адреса. Входящие сообщения INVITE или OPTIONS на прокси-сервер SIP с заглавным названием контакта, в котором имя сервера представлено IP, а не FQDN, соединение будет отклонено с помощью параметра 403 Запрещено.

#### <a name="request-uri"></a>Request-URI 

Для всех входящих звонков используется URI запроса для связи номера телефона с пользователем.   

В настоящее время номер телефона должен содержать знак "плюс" (+), как показано в следующем примере. 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a>Контактные и Record-Route контактов

Прокси-сервер SIP должен вычислять FQDN следующего перехода для новых транзакций в клиентском диалоговом окну (например, bye или Re-Invite), а также при ответе на параметры SIP. Используются Record-Route контактов. 

Согласно [RFC 3261, разделу 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)заглавная связь контакта является обязательной для любого запроса, что может привести к новому диалогову. Этот Record-Route требуется только в том случае, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окке. Если прокси-сервер SBC [](https://docs.microsoft.com/MicrosoftTeams/direct-routing-media-optimization)используется с локальной оптимизацией мультимедиа для прямой маршрутизации, потребуется настроить маршрут записи, так как прокси-сервер должен оставаться в маршруте. 

Корпорация Майкрософт рекомендует использовать только заглавную запись контакта, если не используется прокси-сервер SBC:

- Для [RFC 3261, раздел 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route используется, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окте, что не важно, если не настроен прокси-сервер SBC, так как весь трафик проходит между прокси-сервером Microsoft SIP и сопряженным сервером SBC. 

- Прокси-сервер SIP Майкрософт использует только заглавную запись контакта (не Record-Route) для определения следующего перехода при отправке параметров исходящие связи. Если не используется прокси-сервер SBC, настройка только одного параметра ("Контакт") вместо двух ("Контакт" и "Маршрут записи") упрощает администрирование. 

Для вычисления следующего перехода прокси-сервер SIP использует:

- Приоритет 1. Запись верхнего уровня. Если имя Record-Route содержит имя FQDN, имя FQDN используется для подключения исходящие в диалоговом окну.

- Приоритет 2. Заглавная связь с контактом. Если Record-Route не существует, прокси-сервер SIP подытет значение для заглавного адреса контакта, чтобы получить исходящие подключения. (Рекомендуемая конфигурация.)

Если используются как контакт, так и Record-Route, администратор SBC должен поддерживать их одинаковые значения, что приводит к накладным расходов администраторам. 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>Использование имени FQDN в контакте или Record-Route

Использование IP-адреса не поддерживается ни в Record-Route, ни в контакте. Единственным поддерживаемым вариантом является FQDN, которое должно совпадать с общим именем или альтернативным именем субъекта сертификата SBC (поддерживаются поддиавные знаки в сертификате).

- Если IP-адрес присутствует в маршруте записи или контакте, проверка сертификата не проходит, а звонок не проходит.

- Если FQDN не соответствует значению общего или альтернативного имени субъекта в представляемом сертификате, вызов не происходит. 

## <a name="inbound-call-sip-dialog-description"></a>Входящий звонок: описание диалоговое окно SIP

В следующей таблице приведены различия и сходства между режимами обхода и обхода пунктов.

| Имя параметра | Режим без обхода | Режим обхода
| :---------------------  |:---------------------- |:----------------|
| Кандидаты мультимедиа в 183 и 200 сообщениях, исходя из | Процессоры мультимедиа | Клиенты | 
| Число 183 сообщений, которые может получать SBC | По одному в сеансе | Несколько | 
| Звонок может быть с предварительным ответом (183) | Да | Да |
| Звонок может быть без предварительного ответа (183) | Да | Да |

###  <a name="non-media-bypass-flow"></a>Поток обхода без мультимедиа

У пользователя Teams может быть несколько конечных точек одновременно. Например, teams для Windows, Teams для iPhone и Teams Phone (клиент Teams для Android). Каждая конечная точка может сигнализировать об rest HTTP следующим образом:

-   Ход выполнения звонка — преобразуется прокси-сервером SIP в сообщение SIP 180. При получении сообщения 180 SBC должен создать локальный звонок.

-   Медиаотюд — преобразуется прокси-сервером SIP в сообщение 183 с кандидатами на мультимедиа в протоколе SDP (SDP). При получении сообщения 183 SBC будет подключаться к медиаимям, полученным в сообщении SDP. 

    > [!NOTE]
    > В некоторых случаях медиа ответ может не быть создан, а конечный пункт может ответить сообщением "Звонок принят".

-   Звонок принят — преобразуется прокси-сервером SIP в сообщение SIP 200 с SDP. При получении сообщения 200 ожидается, что SBC будет отправлять и получать мультимедиа для предоставленных кандидатов SDP и от них.

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>Звонки на несколько конечных точек с предварительным ответом

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщения о ходе выполнения звонка на прокси-сервер SIP. Так как у пользователя Teams может быть несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения звонка.

3.  Для каждого сообщения о ходе выполнения вызовов, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения вызовов в сообщение SIP "SIP SIP/2.0 180 Trying". Интервал отправки таких сообщений определяется интервалом получения сообщений от контроллера звонка. На приведенной ниже схеме 180 сообщений, созданных прокси-сервером SIP. Эти сообщения приходят из двух конечных точек Teams пользователя. У каждого клиента есть уникальный ИД тега.  Каждое сообщение из разных конечных точек будет отдельным сеансом (параметр "тег" в поле "To" будет разным). Однако конечная точка может не создать сообщение 180 и отправить сообщение 183 сразу, как показано на приведенной ниже схеме.

4.  После того как конечная точка создает сообщение "Ответ на мультимедиа" с IP-адресами кандидатов на выборку из конечных точек мультимедиа, прокси-сервер SIP преобразует полученное сообщение в сообщение "Ход выполнения сеанса SIP 183", а SDP-сообщение от клиента заменено SDP из процессора мультимедиа. На следующей схеме на звонок ответила конечная точка из fork 2. Если не обойтись, сообщение SIP 183 SIP создается только один раз (будь то клиент-бот или клиентская точки). 183 может приступить к существующей вике или начать новую.

5.  Будет отправлено приемочное сообщение с окончательными кандидатами конечной точки, которые приняли звонок. Сообщение о приемке звонка преобразуется в SIP-сообщение 200. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая звонки нескольких конечных точек с предварительным ответом](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>Звонки на несколько конечных точек без предварительного ответа

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщение "Ход выполнения звонка" на прокси-сервер SIP. Так как у пользователя Teams может быть несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения звонка.

3.  Для каждого сообщения о ходе выполнения вызовов, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения вызовов в сообщение SIP "SIP SIP/2.0 180 Trying".  Интервал отправки сообщений определяется интервалом получения сообщений с контроллера звонка. На рисунке ниже 180 сообщений, созданных прокси-сервером SIP. Это означает, что пользователь вошел в три клиента Teams и каждый клиент отправляет ход выполнения звонка. Каждое сообщение будет отдельным сеансом (параметр "тег" в поле "To" отличается)

4.  Будет отправлено приемочное сообщение с окончательными кандидатами конечной точки, которые приняли звонок. Сообщение о приемке звонка преобразуется в SIP-сообщение 200. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая, что несколько конечных точек звонят без предварительного ответа](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>Поток обхода мультимедиа

В сценарии обхода мультимедиа используются те же сообщения (100 попыток, 180, 183). 

В приведенной ниже схеме показан пример обхода потока вызовов. 

> [!NOTE]
> Кандидаты на выбор мультимедиа могут быть из разных конечных точек. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая звонки нескольких конечных точек с предварительным ответом](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>Параметр "Заменить"

SBC должен поддерживать приглашение на замену.

## <a name="size-of-sdp-considerations"></a>Размер вопросов, учесть SDP

Интерфейс прямой маршрутизации может отправлять SIP-сообщение, превышающий 1500 тол.  Главным причиной этого является размер SDP. Однако если на сервере SBC имеется магистраль UDP, оно может отклонить сообщение, если оно будет перенапрано с прокси-сервера Microsoft SIP на неконтифицированную. Корпорация Майкрософт рекомендует обрезать некоторые значения SDP в SBC при отправке сообщения на ленту UDP. Например, можно удалить кандидатов на ice или неиспользованые кодеки.

## <a name="call-transfer"></a>Передача звонка

Прямая маршрутия поддерживает два способа перенаправки вызовов:

- Вариант 1. Процессы прокси-сервера SIP относятся к локальному клиенту и выступают в качестве рефери, как описано в разделе 7.1 RFC 3892.

  При этом прокси-сервер SIP прекращает передачу и добавляет новое приглашение. 


- Вариант 2. Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве переносителя, как описано в разделе 6 статьи 5589 RFC.

  При этом прокси-сервер SIP отправляет ссылку на SBC и ожидает, что SBC будет полностью обрабатывать передачу.

Этот способ выбирается прокси-сервером SIP в зависимости от возможностей, которые были зачитано SBC. Если SBC указывает, что поддерживает метод "Refer", прокси-сервер SIP будет использовать вариант 2 для перенаправок.

Ниже приводится пример SBC, в который отправляется сообщение о том, что метод "Ссылка" поддерживается:

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

Если SBC не указывает на то, что используется ссылка на поддерживаемый метод, при прямой маршрутке будет использоваться вариант 1 (прокси-сервер SIP выступает в качестве рефери). SBC также должен сигнализировать о том, что он поддерживает метод Уведомления:

Пример SBC, указывающий на то, что метод ссылки не поддерживается:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>Процессы прокси-сервера SIP относятся к локальному клиенту и выступают в качестве рефери

Если SBC указал, что способ ссылки не поддерживается, прокси-сервер SIP выступает в качестве рефери. 

Запрос на ссылку от клиента будет прерван на прокси-сервере SIP. (На приведенной ниже схеме запрос на передачу звонка от клиента показан как "Передача вызовов Даве".  Дополнительные сведения см. в разделе 7.1 [RFC 3892.](https://www.ietf.org/rfc/rfc3892.txt) 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая звонки нескольких конечных точек с предварительным ответом](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве переносителя

Этот способ предпочтителен для передачи звонка, и он является обязательным для устройств, которые не являются сертификатами мультимедиа. Передача вызовов без использования SBC для обработки ссылок не поддерживается в режиме обхода мультимедиа. 

Стандарт объясняется в разделе 6 RFC 5589. Имеются такие же документы:

- [Управление звонками SIP — передача](https://tools.ietf.org/html/rfc5589)

- [Заглавная точка протокола SIP "Заменяет"](https://tools.ietf.org/html/rfc3891)

- [Механизм SIP](https://tools.ietf.org/html/rfc3892)

Предполагается, что прокси-сервер SIP выступает в качестве переноса и отправляет на SBC сообщение со ссылкой. SBC выступает в качестве передачи и обрабатывает ссылку, чтобы создать новое предложение для передачи. Возможны два случая:

- Звонок передается внешнему участнику ОКП. 
- Звонок передается от одного пользователя Teams другому пользователю Teams в том же клиенте через SBC. 

Если звонок передается одному пользователю Teams другому через SBC, ожидается, что SBC выдадут новое приглашение (запустить новое диалоговое окно) для целевого средства передачи (пользователя Teams), используя информацию, полученную в сообщении Refer. 

Чтобы заполнить поля "Кому"/"Передача" для транзакции запроса внутри организации, прокси-сервер SIP должен передавать эти сведения в заглавные поля REFER-TO/REFERRED-BY. 

Прокси-сервер SIP формирует ссылку НА как URI SIP, состоящий из FQDN прокси-сервера SIP в имени хоста и одного из следующих uri:

- Номер телефона E.164 в части URI имени пользователя, если целевым объектом передачи является номер телефона или

- Параметры x-m и x-t, кодющие целевой показатель MRI и ИД клиента для полного переноса 

За header REFERRED-BY — это URI SIP, в котором задан код MRI-передачи, а также код клиента переноса и другие параметры контекста передачи, как показано в следующей таблице:

| Параметр | Значение | Описание |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | MRI | Полное заполнение CC при MRI целевого показателя передачи или передачи |
| x-t | Идентификатор клиента | X-t Tenant ID Optional Tenant ID as populated by CC |
| x–ti | Transferor Correlation Id | Correlation ID of the call to the transferor |
| x-tt | URI передачи целевого звонка | Кодированный URI замены звонка |

В этом случае размер заглавного знака может быть не более 400 символов. SBC должен поддерживать обработку сообщений Refer с размером до 400 символов.

> [!div class="mx-imgBorder"]
> ![Схема, показывающая звонки нескольких конечных точек с предварительным ответом](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>Время сеанса

Прокси-сервер SIP поддерживает (всегда предлагает) время сеанса для звонков без обхода, но не предлагает его для обхода звонков. Использование SBC "Время сеанса" не является обязательным.

##  <a name="use-of-request-uri-parameter-userphone"></a>Использование параметра Request-URI user=phone

Прокси-сервер SIP анализирует URI запроса, и если в этом случае задан параметр user=phone, служба будет обрабатывать запрос-URI как номер телефона, совпадая с номером пользователя. Если параметр не задан, прокси-сервер SIP применяет аврристику для определения типа пользователя Request-URI (номера телефонов или SIP-адреса).

Microsof всегда применяет параметр user=phone, чтобы упростить настройку звонков.

## <a name="history-info-header"></a>History-Info загона

Заглавный History-Info используется для перенаупоминия запросов SIP, а также "предоставляет(а) стандартный механизм сбора сведений о истории запросов для обеспечения поддержки широкого спектра служб для сетей и конечных пользователей". Дополнительные сведения см. в разделе [1.1 RFC 4244.](http://www.ietf.org/rfc/rfc4244.txt) Для телефонной системы Майкрософт этот замещающий номер используется в сценариях "Simulring" и "Переад запись звонков".  

При отправке History-Info включен следующим образом:

- Прокси-сервер SIP вставит параметр, содержащий связанный номер телефона, в отдельные записи History-Info элементы, History-Info в заглавную запись, отданную на контроллере STN.  Если использовать только записи с параметром номера телефона, контроллер STN перестроит новый History-Info и передаст его поставщику услуг связи SIP через прокси-сервер SIP.

- History-Info для одновременного звонка и переадных вызовов.

- History-Info не будет добавлен для случаев перена передачи звонка.

- В отдельной записи истории на History-Info будет параметр номера телефона, предоставленный в сочетании с FQDN (sip.pstnhub.microsoft.com) прямой маршрутии, который является хост-частью URI. Параметр user=phone будет добавлен как часть SIP URI.  Любые другие параметры, связанные с исходным History-Info, за исключением контекстных параметров телефона, будут передаваться в повторно построенном History-Info.  

  > [!NOTE]
  > Частные записи (с помощью механизмов, определенных в разделе 3.3 rFC 4244) будут перенаправлены так, как поставщик связи SIP является доверенным.

- Входящие History-Info игнорируются.

Ниже замер формата заглавного заглавия history-info, отосланного прокси-сервером SIP:

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

Если звонок перенаправлен несколько раз, сведения обо всех перенаправлениях включаются в хронологическом порядке по соответствующей причине.


Пример с заглавным заглавием:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

The History-Info is protected by a mandatory TLS mechanism. 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>SBC connection to Direct Routing and failover mechanism

См. механизм отсвечения сигнального сигнала SIP в [плане прямой маршрутизации.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)

## <a name="retry-after"></a>Retry-After

Если центр обработки данных Direct Routing занят, служба может отправить Retry-After сообщению с интервалом в одну секунду в SBC. Когда SBC получает сообщение 503 с Retry-After в ответ на приглашение, SBC должен прервать это подключение и попробовать следующий доступный центр обработки данных Майкрософт. 

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>Перезапуск ICE: звонок "Обход мультимедиа" передается на конечную точку, которая не поддерживает обход мультимедиа

SBC должен поддерживать перезапуски ICE, как описано в разделе [9.1.1.1 RFC 5245.](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)

Перезапуск в прямой маршрутке осуществляется в соответствии со следующими пунктами RFC:

*Чтобы перезапустить ICE, агент должен изменить ice-pwd и ice-ufrag для потока мультимедиа в предложении.  Обратите внимание, что атрибуты уровня сеанса в одном предложении допустимы, но в последующих предложениях можно использовать те же атрибуты, что и ice-pwd или ice-ufrag.  Это не изменение пароля, а изменение его представления и не приведет к перезапуску ICE.*

*Агент задает остальные поля в SDP для этого потока мультимедиа так же, как и в первоначальном предложении этого потока мультимедиа (см. раздел 4.3).  Соответственно, в состав набора кандидатов может быть включено несколько кандидатов, ни один из них, ни один из предыдущих кандидатов для этого потока, а также новый набор кандидатов, собранных в соответствии с разделом 4.1.1.*

Если звонок был изначально установлен с обходом мультимедиа и перенаправлен в клиент Skype для бизнеса, для прямой маршрутки требуется вставить процессор мультимедиа, так как прямая маршрутия не может использоваться в клиенте Skype для бизнеса с обходом мультимедиа. Прямая маршрутизации запускает перезапуск ICE, изменяя ice-pwd и ice-ufrag и предлагая новых кандидатов мультимедиа в повторном запросе. 


