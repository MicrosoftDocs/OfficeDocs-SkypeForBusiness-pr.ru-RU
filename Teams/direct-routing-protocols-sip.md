---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутизации
appliesto:
- Microsoft Teams
ms.openlocfilehash: 6cf7bf4040a75e59518312edd32c9c4e77f11728
ms.sourcegitcommit: 95a56dab4e30f7ad6615ebd4a4a0f61996fdc20f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 01/17/2023
ms.locfileid: "69812716"
---
# <a name="direct-routing---sip-protocol"></a>Прямая маршрутизация — протокол SIP

В этой статье описывается, как прямая маршрутизация реализует протокол инициации сеанса (SIP). Для правильной маршрутизации трафика между пограничным контроллером сеансов (SBC) и прокси-сервером SIP некоторые параметры SIP должны иметь определенные значения. Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку подключения между локальным SBC и службой прокси-сервера SIP.

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>Обработка входящего запроса: поиск клиента и пользователя

Перед обработкой входящего или исходящего вызова сообщения OPTIONS обмениваются между прокси-сервером SIP и SBC. Эти сообщения OPTIONS позволяют прокси-серверу SIP предоставлять разрешенные возможности для SBC. Важно, чтобы согласование OPTIONS было успешным (ответ 200OK), что позволяет продолжить обмен данными между SBC и SIP Proxy для установления вызовов. Заголовки SIP в сообщениях OPTIONS для прокси-сервера SIP приведены в качестве примера ниже:

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| URI запроса | OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0 |
| Через заголовок | С помощью: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| заголовок Max-Forwards | Максимальное число переадресов:68 |
| Из заголовка | Из заголовка: <sip:sbc1.adatum.biz:5058> |
| До заголовка | Кому: <sip:sip.pstnhub.microsoft.com:5061> |
| Заголовок CSeq | CSeq: 1 INVITE | 
| Заголовок контакта | Контакт: <sip:sbc1.adatum.biz:50588;transport=tls> |

> [!NOTE]
> Заголовки SIP не содержат userinfo в используемом URI SIP. В соответствии с [RFC 3261, раздел 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), часть userinfo URI является необязательной и может отсутствовать, если конечный узел не имеет понятия о пользователях или когда сам узел является идентифицируемым ресурсом. Если знак @присутствует в URI SIP, поле пользователя не должно быть пустым.
> Обратите внимание, что URI SIPS не следует использовать с прямой маршрутизацией, так как он не поддерживается.
> Проверьте конфигурацию пограничного контроллера сеансов и убедитесь, что в sip-запросах не используются заголовки Replaces. Прямая маршрутизация отклоняет SIP-запросы, для которых определены заголовки Replaces.

При входящем вызове прокси-сервер SIP должен найти клиент, которому предназначен вызов, и найти конкретного пользователя в этом клиенте. Администратор клиента может настроить номера, не относящиеся к DID, например +1001, в нескольких клиентах. Поэтому важно найти конкретный клиент, в котором будет выполняться поиск номеров, так как номера, отличные от DID, могут быть одинаковыми в нескольких организациях Microsoft 365 или Office 365.  

В этом разделе описывается, как прокси-сервер SIP находит клиента и пользователя и выполняет проверку подлинности SBC при входящем подключении.

Ниже приведен пример сообщения SIP Invite при входящем вызове:

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| URI запроса | INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0 |
| Через заголовок | С помощью: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| заголовок Max-Forwards | Максимальное число переадресов:68 |
| Из заголовка | Из заголовка Из: <sip:+17168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679 |
| До заголовка | Для: sip:+183338006777@sbc1.adatum.biz | 
| Заголовок CSeq | CSeq: 1 INVITE | 
| Заголовок контакта | Контакт: <sip:+17168712781@sbc1.adatum.biz:5058;transport=tls> | 

При получении приглашения прокси-сервер SIP выполняет следующие действия:

1. Проверьте сертификат. При первоначальном подключении служба прямой маршрутизации принимает полное доменное имя, представленное в заголовке Contact, и сопоставляет его с общим именем или альтернативным именем субъекта представленного сертификата. Имя SBC должно соответствовать одному из следующих параметров:

   - Вариант 1. Полное полное доменное имя, представленное в заголовке Contact, должно соответствовать общему имени или альтернативному имени субъекта представленного сертификата.  

   - Вариант 2. Доменная часть имени полного доменного имени, представленная в заголовке Contact (например, adatum.biz имени полного доменного имени sbc1.adatum.biz), должна соответствовать значению подстановочного знака в разделе Общее имя или альтернативное имя субъекта (например, *.adatum.biz).

2. Попробуйте найти клиента, используя полное полное доменное имя, представленное в заголовке Contact.  

   Проверьте, зарегистрировано ли полное доменное имя из заголовка Contact (sbc1.adatum.biz) в качестве DNS-имени в любой организации Microsoft 365 или Office 365. В случае обнаружения поиск пользователя выполняется в клиенте, у которого полное доменное имя SBC зарегистрировано в качестве доменного имени. Если не найдено, применяется шаг 3.   

3. Шаг 3 применяется только в том случае, если шаг 2 завершился ошибкой. 

   Удалите часть узла из полного доменного имени, представленного в заголовке Contact (FQDN: sbc12.adatum.biz, после удаления части узла: adatum.biz), и проверьте, зарегистрировано ли это имя в качестве DNS-имени в любой организации Microsoft 365 или Office 365. При обнаружении поиск пользователя выполняется в этом клиенте. Если не найдено, вызов завершается ошибкой.

4. Используя номер телефона, указанный в запросе URI, выполните обратный поиск номера в клиенте, который находится на шаге 2 или 3. Совпадите указанный номер телефона с пользовательским URI SIP в клиенте, найденном на предыдущем шаге.

5. Применение параметров магистрали. Найдите параметры, заданные администратором клиента для этого SBC.

   Корпорация Майкрософт не поддерживает наличие стороннего прокси-сервера SIP или сервера агента пользователя между прокси-сервером Microsoft SIP и сопряженным SBC, что может изменить URI запроса, созданный сопряженным SBC.

   Требования к двум подстановкам (шаги 2 и 3), необходимые для сценария, в котором один SBC связан со многими клиентами (сценарий оператора), рассматриваются далее в этой статье.

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>Подробные требования к заголовку contact и URI запроса

#### <a name="contact-header"></a>Заголовок контакта

Для всех входящих сообщений SIP (OPTIONS, INVITE) к прокси-серверу Microsoft SIP заголовок Contact должен иметь парное полное доменное имя SBC в имени узла URI следующим образом:

Синтаксис: Contact: <sip:phone или sip address@FQDN SBC;transport=tls> 

В соответствии с [RFC 3261, раздел 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), поле заголовка контакта может присутствовать в сообщении OPTIONS. В поле Прямая маршрутизация требуется заголовок контакта. Для сообщений INVITE в приведенном выше формате для сообщений OPTIONS можно удалить userinfo из URI SIP и отправить только полное доменное имя в следующем формате:

Синтаксис: Contact: <sip:FQDN SBC;transport=tls>

Это имя (FQDN) также должно находиться в полях "Общее имя" или "Альтернативное имя субъекта" указанного сертификата. Корпорация Майкрософт поддерживает использование подстановочных знаков имен в полях "Общее имя" или "Альтернативное имя субъекта" сертификата.   

Поддержка подстановочных знаков описана в [разделе RFC 2818, раздел 3.1](https://tools.ietf.org/html/rfc2818#section-3.1). Специально:

*"Имена могут содержать подстановочный знак \* , который считается соответствующим любому отдельному компоненту или фрагменту компонента доменного имени. Например, .a.com соответствует foo.a.com, \*но не bar.foo.a.com. f.com\* соответствует foo.com, но не bar.com".*

Если SBC отправляет несколько значений в заголовке Contact, представленном в сообщении SIP, используется только часть полного доменного имени первого значения заголовка Contact.

Как правило, для прямой маршрутизации важно, чтобы полное доменное имя использовалось для заполнения URI SIP вместо IP-адреса. Входящее сообщение INVITE или OPTIONS к прокси-серверу SIP с заголовком Contact, где имя узла представлено IP-адресом, а не полным доменным именем. Подключение будет отклонено с 403 Запрещено.

#### <a name="request-uri"></a>URI запроса 

Для всех входящих вызовов для сопоставления номера телефона пользователю используется URI-request.   

В настоящее время номер телефона должен содержать знак "плюс" (+), как показано в следующем примере. 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```
#### <a name="from-header"></a>Из заголовка

Для всех входящих звонков используется параметр From Header для сопоставления номера телефона звонящего и списка заблокированных телефонных номеров звонящего.

Номер телефона должен содержать значение +, как показано в следующем примере.

```console
From: <sip:+17168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679
```

## <a name="contact-and-record-route-headers-considerations"></a>Рекомендации по заголовкам контактов и Record-Route

Прокси-сервер SIP должен вычислить полное доменное имя следующего прыжка для новых клиентских транзакций в диалоговом окне (например, Bye или Re-Invite) и при ответе на параметры SIP. Используется контакт или Record-Route. 

В соответствии с [RFC 3261, раздел 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), заголовок Contact требуется в любом запросе, который может привести к созданию нового диалогового окна. Record-Route требуется только в том случае, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окне. Если прокси-сервер SBC используется с [оптимизацией локального носителя для прямой маршрутизации](./direct-routing-media-optimization.md), необходимо настроить маршрут записи, так как прокси-сервер SBC должен оставаться в маршруте. 

Корпорация Майкрософт рекомендует использовать только заголовок Contact, если прокси-сервер SBC не используется:

- В [соответствии с RFC 3261, раздел 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route используется, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окне, что не важно, если прокси-сервер SBC не настроен, так как весь трафик проходит между прокси-сервером Microsoft SIP и сопряженным SBC. 

- Прокси-сервер Microsoft SIP использует только заголовок Contact (не Record-Route) для определения следующего прыжка при отправке параметров исходящей связи. Настройка только одного параметра (Contact) вместо двух (Contact и Record-Route) упрощает администрирование, если прокси-сервер SBC не используется. 

Чтобы вычислить следующий прыжок, прокси-сервер SIP использует:

- Приоритет 1. Маршрут записи верхнего уровня. Если Record-Route верхнего уровня содержит полное доменное имя, то для подключения к исходящему диалогу используется полное доменное имя.

- Приоритет 2. Заголовок контакта. Если Record-Route не существует, прокси-сервер SIP будет искать значение заголовка Contact, чтобы установить исходящее подключение. (Это рекомендуемая конфигурация.)

Если используются как Contact, так и Record-Route, администратор SBC должен сохранить их значения одинаковыми, что приводит к дополнительным административным издержкам. 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>Использование имени полного доменного имени в контакте или Record-Route

Использование IP-адреса не поддерживается ни в Record-Route, ни в контакте. Единственным поддерживаемым вариантом является полное доменное имя, которое должно соответствовать общему имени или альтернативному имени субъекта сертификата SBC (поддерживаются подстановочные знаки в сертификате).

- Если IP-адрес указан в поле "Запись маршрута" или "Контакт", проверка сертификата завершается ошибкой и вызов завершается ошибкой.

- Если полное доменное имя не соответствует значению Common или Subject Alternative Name в представленном сертификате, вызов завершается ошибкой. 

## <a name="inbound-call-sip-dialog-description"></a>Входящий вызов: описание диалогового окна SIP

В следующей таблице ниже перечислены различия в потоках вызовов и сходства между режимами без обхода и обхода.

| Имя параметра | Режим без обхода | Режим обхода
| :---------------------  |:---------------------- |:----------------|
| Кандидаты в сми в 183 и 200 сообщениях, поступающих от | Обработчики мультимедиа | Клиенты | 
| Число 183 сообщений, которые может получать SBC | По одному на сеанс | Несколько | 
| Вызов может быть с предварительным ответом (183) | Да | Да |
| Звонок может быть без предварительного ответа (183) | Да | Да |

###  <a name="non-media-bypass-flow"></a>Поток обхода без посредника

Пользователь Teams может иметь несколько конечных точек одновременно. Например, клиент Teams для Windows, клиент Teams для iPhone и Teams Phone (клиент Teams Android). Каждая конечная точка может сигнализировать об rest HTTP следующим образом:

-   Ход выполнения вызова — преобразуется прокси-сервером SIP в sip-сообщение 180. При получении сообщения 180 SBC должен создать локальный звонок.

-   Ответ мультимедиа — преобразуется прокси-сервером SIP в сообщение 183 с кандидатами мультимедиа в протоколе описания сеанса (SDP). При получении сообщения 183 SBC ожидает подключения к кандидатам мультимедиа, полученным в сообщении SDP. 

    > [!NOTE]
    > В некоторых случаях ответ мультимедиа может не быть создан, а конечная точка может ответить сообщением "Звонок принят".

-   Вызов принят — преобразуется прокси-сервером SIP в SIP-сообщение 200 с SDP. При получении сообщения 200 SBC, как ожидается, будет отправлять и получать мультимедиа в и от предоставленных кандидатов SDP.

    > [!NOTE]
    > Прямая маршрутизация не поддерживает приглашение с задержкой (приглашение без SDP).

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>Несколько конечных точек с предварительным ответом

1.  При получении первого приглашения от SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и уведомляет все конечные точки конечного пользователя о входящем вызове. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщения "Ход вызова" прокси-серверу SIP. Так как у пользователя Teams может быть несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе вызова.

3.  Для каждого сообщения о ходе выполнения вызова, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения вызова в sip-сообщение "SIP/2.0 180 Ringing". Интервал для отправки таких сообщений определяется интервалом получения сообщений от контроллера вызовов. На следующей схеме представлены два 180 сообщений, созданных прокси-сервером SIP. Эти сообщения поступают от двух конечных точек Teams пользователя. Каждый клиент имеет уникальный идентификатор тега.  Каждое сообщение, поступающее из другой конечной точки, будет отдельным сеансом (параметр tag в поле "Кому" будет отличаться). Но конечная точка может не создать сообщение 180 и сразу отправить сообщение 183, как показано на следующей схеме.

4.  После того как конечная точка создает сообщение Media Answer с IP-адресами кандидатов на носитель конечной точки, прокси-сервер SIP преобразует полученное сообщение в сообщение "Ход сеанса SIP 183" с SDP от клиента, замененным SDP из обработчика мультимедиа. На следующей схеме конечная точка из Fork 2 ответила на вызов. Если магистраль не обходить стороной, сообщение SIP 183 создается только один раз (кольцевой бот или конечная точка клиента). 183 может прийти на существующую вилку или начать новую.

5.  Отправляется сообщение о принятии звонка с окончательными кандидатами конечной точки, которая приняла вызов. Сообщение о приеме звонка преобразуется в sip-сообщение 200. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек с предварительным ответом.](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>Несколько конечных точек без предварительного ответа

1.  При получении первого приглашения от SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и уведомляет все конечные точки конечного пользователя о входящем вызове. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщение "Ход вызова" прокси-серверу SIP. Так как пользователь Teams может иметь несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения вызова.

3.  Для каждого сообщения о ходе выполнения звонка, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения вызова в сообщение SIP "SIP/2.0 180 Trying".  Интервал отправки сообщений определяется интервалом получения сообщений от контроллера вызовов. На рисунке ниже есть два 180 сообщений, созданных прокси-сервером SIP, что означает, что пользователь вошел в три клиента Teams и каждый клиент отправляет ход вызова. Каждое сообщение будет отдельным сеансом (параметр "tag" в поле "Кому" отличается)

4.  Отправляется сообщение о принятии звонка с окончательными кандидатами конечной точки, которая приняла вызов. Сообщение о приеме звонка преобразуется в sip-сообщение 200. 

> [!div class="mx-imgBorder"]
> ![Схема, на которой показано, как несколько конечных точек звонят без предварительного ответа.](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>Поток обхода мультимедиа

Те же сообщения (100 trying, 180, 183) используются в сценарии обхода мультимедиа. 

В приведенной ниже схеме показан пример потока обходных вызовов. 

> [!NOTE]
> Кандидаты мультимедиа могут поступать из разных конечных точек. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек с предварительным ответом.](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>Параметр "Заменяет"

SBC должен поддерживать приглашение с заменами.

## <a name="size-of-sdp-considerations"></a>Рекомендации по размеру SDP

Интерфейс прямой маршрутизации может отправлять SIP-сообщение, превышающее 1500 байт.  Это в первую очередь связано с размером SDP. Однако если за SBC находится магистраль UDP, оно может отклонить сообщение, если оно перенаправлено с прокси-сервера Microsoft SIP на магистраль без изменений. Корпорация Майкрософт рекомендует удалить некоторые значения в SDP в SBC при отправке сообщения в магистрали UDP. Например, кандидаты ICE или неиспользуемые кодеки можно удалить.

## <a name="call-transfer"></a>передача вызовов;

Прямая маршрутизация поддерживает два метода передачи вызовов:

- Вариант 1. Прокси-сервер SIP обрабатывает ссылку от клиента локально и выступает в качестве рефери, как описано в разделе 7.1 RFC 3892.

  При использовании этого параметра прокси-сервер SIP завершает передачу и добавляет новое приглашение. 


- Вариант 2. Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве передателя, как описано в разделе 6 RFC 5589.

  При использовании этого параметра прокси-сервер SIP отправляет ссылку на SBC и ожидает, что SBC полностью обработает передачу.

Прокси-сервер SIP выбирает метод на основе возможностей, сообщаемых SBC. Если SBC указывает, что поддерживает метод Refer, прокси-сервер SIP будет использовать вариант 2 для передачи вызовов.

Ниже приведен пример SBC, отправляющий сообщение о поддержке метода Refer:

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

Если SBC не указывает на то, что ссылка является поддерживаемым методом, прямая маршрутизация будет использовать вариант 1 (прокси-сервер SIP выступает в качестве рефери). SBC также должен сигнализировать о том, что он поддерживает метод Notify:

Пример SBC, указывающий, что метод Refer не поддерживается:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>Прокси-сервер SIP обрабатывает Запрос от клиента локально и выступает в качестве рефери

Если В SBC указано, что метод Refer не поддерживается, прокси-сервер SIP выступает в качестве рефери. 

Запрос на ссылку, поступающий от клиента, будет завершен на прокси-сервере SIP. (На следующей схеме запрос на ссылку от клиента отображается как "Переадресация вызовов в Дэйв".  Дополнительные сведения см. в разделе 7.1 [документа RFC 3892](https://www.ietf.org/rfc/rfc3892.txt). 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек с предварительным ответом.](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве передателя

Это предпочтительный метод для передачи вызовов, который является обязательным для устройств, ищущих сертификацию обхода мультимедиа. Передача вызовов без возможности обработки ссылок SBC не поддерживается в режиме обхода мультимедиа. 

Стандарт описан в разделе 6 RFC 5589. Связанные RFC:

- [Управление вызовами по протоколу SIP — передача](https://tools.ietf.org/html/rfc5589)

- [Заголовок "Replaces" (Заголовок протокола SIP инициации сеанса (SIP)](https://tools.ietf.org/html/rfc3891)

- [Механизм "Referred-By" по протоколу инициации сеанса (SIP)](https://tools.ietf.org/html/rfc3892)

Этот параметр предполагает, что прокси-сервер SIP выступает в качестве передателя и отправляет сообщение Refer в SBC. SBC выступает в качестве получателя и обрабатывает ссылку, чтобы создать новое предложение для передачи. Возможны два варианта:

- Вызов передается внешнему участнику ТСОП. 
- Вызов передается от одного пользователя Teams другому пользователю Teams в том же клиенте через SBC. 

Если вызов передается от одного пользователя Teams другому через SBC, ожидается, что SBC выдаст новое приглашение (запуск нового диалогового окна) для целевого объекта передачи (пользователя Teams), используя сведения, полученные в сообщении Ссылка. 

Чтобы заполнить поля To/Transferor для транзакции запроса внутренне, прокси-сервер SIP должен передать эти сведения в заголовки REFER-TO/REFERED-BY. 

Прокси-сервер SIP будет формировать REFER-TO как URI SIP, состоящий из полного доменного имени прокси-сервера SIP в имени узла и одного из следующих вариантов:

- Номер телефона E.164 в части URI имени пользователя, если целевой объект передачи является номером телефона, или

- Параметры x-m и x-t, кодирующие МРТ полного целевого объекта передачи и идентификатор клиента соответственно 

Заголовок REFERRED-BY — это URI SIP с закодированными в нем МРТ передателя, а также идентификатором клиента передателя и другими параметрами контекста передачи, как показано в следующей таблице:

| Параметр | Значение | Описание |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | МРТ | Полная МРТ передателя/целевого объекта передачи, заполненная CC |
| x-t | Идентификатор клиента | X-t Идентификатор клиента Необязательный идентификатор клиента, заполненный CC |
| x-ti | Идентификатор корреляции передателя | Идентификатор корреляции вызова передателя |
| x-tt | URI целевого вызова для передачи | Кодированный URI замены вызова |

В этом случае размер заголовка ссылки может составлять до 400 символов. SBC должен поддерживать обработку ссылочных сообщений размером до 400 символов.

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек с предварительным ответом.](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>Таймер сеанса

Прокси-сервер SIP поддерживает (всегда предлагает) таймер сеанса для вызовов без обхода, но не предлагает его при обходных вызовах. Использование таймера сеанса SBC не является обязательным.

##  <a name="use-of-request-uri-parameter-userphone"></a>Использование параметра Request-URI user=phone

Прокси-сервер SIP анализирует URI запроса, и если параметр user=phone присутствует, служба будет обрабатывать URI запроса как номер телефона, соответствующий номеру пользователя. Если параметр отсутствует, прокси-сервер SIP применяет эвристические методы для определения типа пользователя Request-URI (номер телефона или SIP-адрес).

Корпорация Майкрософт рекомендует всегда применять параметр user=phone для упрощения процесса настройки звонка.

## <a name="history-info-header"></a>заголовок History-Info

Заголовок History-Info используется для перенацеливание запросов SIP и "предоставляет стандартный механизм сбора сведений журнала запросов, чтобы обеспечить широкий спектр служб для сетей и конечных пользователей". Дополнительные сведения см. в [статье RFC 4244 — Раздел 1.1](http://www.ietf.org/rfc/rfc4244.txt). Для телефонной системы Майкрософт этот заголовок используется в сценариях симуляции и переадресации звонков.  

При отправке History-Info включается следующим образом:

- Прокси-сервер SIP вставляет параметр, содержащий связанный номер телефона, в отдельные History-Info записи, содержащие заголовок History-Info, отправляемый контроллеру ТСОП.  Используя только записи с параметром номера телефона, контроллер ТСОП перестроит новый заголовок History-Info и передает его поставщику магистрали SIP через прокси-сервер SIP.

- History-Info заголовок будет добавлен для случаев одновременного вызова и переадресации звонков.

- History-Info заголовок не будет добавлен для случаев передачи звонков.

- Отдельная запись журнала в восстановленном заголовке History-Info будет содержать параметр номера телефона, указанный в сочетании с FQDN прямой маршрутизации (sip.pstnhub.microsoft.com) в качестве хост-части URI; параметр user=phone будет добавлен как часть URI SIP.  Все другие параметры, связанные с исходным заголовком History-Info, за исключением параметров контекста телефона, будут передаваться в повторно созданном History-Info заголовке.  

  > [!NOTE]
  > Записи, которые являются частными (как определено механизмами, определенными в разделе 3.3 RFC 4244), будут пересылаться как есть, так как поставщик магистрали SIP является доверенным одноранговым.

- Входящий History-Info сохраняется при включении параметра ForwardCallHistory. Сохраненные History-Info можно использовать для предотвращения циклов.

Ниже приведен формат заголовка History-info, отправляемого прокси-сервером SIP:

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

Если вызов перенаправлялся несколько раз, сведения о каждом перенаправлении включаются с соответствующей причиной в хронологическом порядке.


Пример заголовка:

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

History-Info защищен обязательным механизмом TLS. 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>Подключение SBC к прямой маршрутизации и механизм отработки отказа

См. раздел Механизм отработки отказа для сигналов SIP в [разделе Планирование прямой маршрутизации](direct-routing-plan.md#failover-mechanism-for-sip-signaling).

## <a name="retry-after"></a>Retry-After

Если центр обработки данных с прямой маршрутизацией занят, служба может отправить Retry-After сообщение с интервалом в одну секунду в SBC. Когда SBC получает сообщение 503 с заголовком Retry-After в ответ на INVITE, SBC должен прекратить это подключение и попробовать следующий доступный центр обработки данных Майкрософт.

## <a name="handling-retries-603-response"></a>Обработка повторных попыток (ответ 603)
Если пользователь наблюдает несколько пропущенных вызовов для одного вызова после отклонения входящего вызова, это означает, что механизм повторных попыток поставщика магистрали SBC или ТСОП настроен неправильно. Необходимо перенастроить SBC, чтобы остановить повторные попытки в ответе 603.

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>Перезапуск ICE: вызов обхода мультимедиа передается в конечную точку, которая не поддерживает обход мультимедиа

SBC должен поддерживать перезапуски ICE, как описано в [разделе RFC 5245, раздел 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).

Перезапуск в прямой маршрутизации реализуется в соответствии со следующими абзацами RFC:

*Чтобы перезапустить ICE, агент должен изменить как ice-pwd, так и ice-ufrag для медиа потока в предложении.  Обратите внимание, что в одном предложении допускается использовать атрибут уровня сеанса, но в последующем предложении в качестве атрибута уровня мультимедиа можно использовать тот же атрибут ice-pwd или ice-ufrag.  Это не изменение пароля, а просто изменение его представления и не приводит к перезапуску ICE.*

*Агент задает остальные поля в SDP для этого потока мультимедиа так же, как и в первоначальном предложении этого потока мультимедиа (см. раздел 4.3).  Следовательно, набор кандидатов может включать в себя некоторых, ни одного или всех предыдущих кандидатов для этого потока и МОЖЕТ включать в себя совершенно новый набор кандидатов, собранных, как описано в разделе 4.1.1.*

Если вызов был изначально установлен с обходом сервера-посредника и он передается клиенту Skype для бизнеса, то прямая маршрутизация должна вставить обработчик мультимедиа. Это связано с тем, что прямая маршрутизация не может использоваться с клиентом Skype для бизнеса с обходом мультимедиа. Прямая маршрутизация запускает процесс перезапуска ICE, изменяя ice-pwd и ice-ufrag и предлагая новые медиа кандидаты в повторном создании.
