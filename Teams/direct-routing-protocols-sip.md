---
title: Прямая маршрутизация телефонной системы
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Протоколы прямой маршрутии
appliesto:
- Microsoft Teams
ms.openlocfilehash: 436eded0069af9263aec02f62a697572be7a4ead
ms.sourcegitcommit: b4bc3b4c1d167a075a25180818f61758eb56cd6b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/16/2021
ms.locfileid: "61041271"
---
# <a name="direct-routing---sip-protocol"></a>Прямая маршрутия — протокол SIP

В этой статье описано, как прямая маршрутия реализует протокол SIP. Чтобы правильно маршрутировать трафик между контроллером границы сеанса (SBC) и прокси-сервером SIP, некоторые параметры SIP должны иметь определенные значения. Эта статья предназначена для администраторов голосовой связи, которые отвечают за настройку подключения между локальной службой SBC и прокси-службой SIP.

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a>Обработка входящих запросов: поиск клиента и пользователя

Перед обработкой входящих и исходящие вызовов сообщения OPTIONS обмениваются между прокси-сервером SIP и SBC. Эти сообщения параметров позволяют прокси-серверу SIP предоставлять разрешенные возможности для SBC. Важно, чтобы согласование с OPTIONS было успешным (ответ 200OK), что позволяет далее устанавливать звонки между SBC и прокси-сервером SIP. В качестве примера ниже приведены заглавные данные SIP в сообщениях OPTIONS для прокси-сервера SIP.

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| URI запроса | OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0 |
| С помощью загона | Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards загона | Max-Forwards:68 |
| Из области "Заглавная" | Из области "От" <sip:sbc1.adatum.biz:5058> |
| В заглавную | Кому: <sip:sip.pstnhub.microsoft.com:5061> |
| Заглавье CSeq | CSeq: 1 ПРИГЛАШЕНИЕ | 
| Заглавная связь с контактом | Контакт: <sip:sbc1.adatum.biz:50588;transport=tls> |

> [!NOTE]
> Заглавные данные SIP не содержат userinfo в используемом URI SIP. В соответствии с [RFC 3261, разделом 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1)userinfo URI является необязательным и может отсутствовать, если конечного хоста нет представления о пользователях или когда хост является идентифицированным ресурсом. Если знак @ присутствует в URI SIP, поле пользователя НЕ ДОЛЖНО быть пустым.
> Обратите внимание, что URI SIPS не следует использовать с direct Routing, так как он не поддерживается.
> Проверьте конфигурацию контроллера границы сеанса и убедитесь, что в запросах SIP не используется заглавная "Замена". Прямая маршрутия отклоняет запросы SIP с задаваемой заменой.

Во время входящих зовов прокси-сервер SIP должен найти клиент, на который он перенапрался, и конкретного пользователя в этом клиенте. Администратор клиента может настроить номера без DID, например +1001, в нескольких клиентах. Поэтому важно найти конкретный клиент, для которого нужно выполнить поиск номеров, так как неИдационные числа могут быть одинаковыми в Microsoft 365 или Office 365 организациях.  

В этом разделе описано, как прокси-сервер SIP находит клиента и пользователя, а также выполняет проверку подлинности SBC при входящих подключениях.

Ниже приводится пример приглашения SIP во входящий звонок:

| Имя параметра | Пример значения | 
| :---------------------  |:---------------------- |
| URI запроса | ПРИГЛАСИТЬ sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0 |
| С помощью загона | Через: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978 | 
| Max-Forwards загона | Max-Forwards:68 |
| Из области "Заглавная" | From Header From: <sip:+17168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679 |
| В заглавную | To: sip:+183338006777@sbc1.adatum.biz | 
| Заглавье CSeq | CSeq: 1 ПРИГЛАШЕНИЕ | 
| Заглавная связь с контактом | Контактное <SIP: 68712781@sbc1.adatum.biz:5058;transport=tls> | 

При получении приглашения прокси-сервер SIP выполняет следующие действия:

1. Проверьте сертификат. По первоначальному подключению служба прямой маршрутизовывания принимает имя FQDN, которое представлено в заглавной части контакта, и совпадает с именем "Общее имя" или "Тема альтернативы" для представленного сертификата. Имя SBC должно соответствовать одному из следующих вариантов:

   - Вариант 1. Полное полное имя FQDN, которое есть в заглавном тексте контакта, должно совпадать с именем "Общее имя/тема" для сертификата.  

   - Вариант 2. Часть домена имени FQDN, представленная в заглавной части контакта (например, adatum.biz имени FQDN sbc1.adatum.biz), должна соответствовать поддеревной знаку в названии "Общее имя" или "Альтернативное имя субъекта" (например, *.adatum.biz).

2. Попробуйте найти клиента, используя полное имя FQDN, которое представлено в заглавном тексте контакта.  

   Проверьте, зарегистрировано ли имя FQDN из заглавного sbc1.adatum.biz контакта в любой организации Microsoft 365 или Office 365 DNS. При обнаружении выполняется подсмотр пользователя в клиенте, в доменном имени которого зарегистрированО FQDN SBC. Если она не найдена, применяется шаг 3.   

3. Шаг 3 применяется только в случае сбойного шага 2. 

   Удалите часть хоста из FQDN, представленную в заглавном имени контакта (FQDN: sbc12.adatum.biz, после удаления части хоста: adatum.biz) и проверьте, зарегистрировано ли это имя как имя DNS в любой организации Microsoft 365 или Office 365. При обнаружении в этом клиенте выполняется пользовательский просмотр. Если он не найден, звонок не удастся найти.

4. Используя номер телефона, представленный в URI-запроса, выполните обратный просмотр номера в клиенте, найденном в шаге 2 или 3. Сопопошать представленный номер телефона с пользовательским URI SIP в клиенте, найденном на предыдущем шаге.

5. Применим параметры туловища. Найдите параметры, заданные администратором клиента для этого SBC.

   Корпорация Майкрософт не поддерживает наличие прокси-сервера SIP сторонних пользователей или сервера агента пользователя между прокси-сервером SIP Майкрософт и сопряженным сервером SBC, который может изменить URI запроса, созданный парным SBC.

   Требования для двух подысков (этапов 2 и 3), необходимых для сценария, в котором один SBC взаимосвязан с множеством клиентов (сценарий оператора связи), см. далее в этой статье.

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a>Подробные требования для загона контактов и запроса URI

#### <a name="contact-header"></a>Заглавная связь с контактом

Для всех входящих сообщений SIP (OPTIONS, INVITE) на прокси-сервер SIP Майкрософт закаглавная запись контакта должна иметь сопряженное FQDN SBC в имени хоста URI следующим образом:

Синтаксис: контакт: <sip:phone или sip address@FQDN SBC;transport=tls> 

В соответствии [с RFC 3261, раздел 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), поле заглавного поля контакта может присутствовать в сообщении OPTIONS. В прямой маршрутике требуется заглавная линия контакта. Для сообщений INVITE в формате выше для сообщений OPTIONS, которые userinfo можно удалить из SIP URI и только FQDN, отправленных в формате:

Синтаксис: контакт: <sip:FQDN SBC;transport=tls>

Это имя (FQDN) также должно быть в полях "Общее имя" или "Альтернативные имена субъекта" в сертификате. Корпорация Майкрософт поддерживает использование поддеревных значений имен в полях "Общее имя" или "Альтернативное имя субъекта" сертификата.   

Поддержка поддеревных знаков описана в [разделе 3.1 RFC 2818.](https://tools.ietf.org/html/rfc2818#section-3.1) Специально:

*"Имена могут содержать под вопросии, который считается совпадать с любым компонентом \* доменного имени или фрагментом компонента. Например, .a.com совпадает с foo.a.com, но не bar.foo.a.com. f .com соответствует foo.com, но \* не \* bar.com".*

Если SBC отправляет несколько значений в заглавном сообщении контакта, используемой SBC, используется только часть FQDN первого значения в заглавном сообщении контакта.

Как правило, при прямой маршрутике для заполнения URI SIP вместо IP-адреса используется FQDN. Сообщение о входящих ПРИГЛАШЕНИЯх и параметрах на прокси-сервер SIP с названием контакта, в котором имя сервера представлено IP, а не FQDN, подключение будет отклонено с помощью параметра 403 Запрещено.

#### <a name="request-uri"></a>URI запроса 

Для всех входящих звонков для совпадения номера телефона с пользователем используется запрос-URI.   

В настоящее время номер телефона должен содержать знак "плюс" (+), как показано в примере ниже. 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```
#### <a name="from-header"></a>Из области "Заглавная"

Для всех входящих звонков закаглавка "От" используется для совпадения номера телефона звоня с заблокированным списком номеров телефонов вызываемого.

Номер телефона должен содержать +, как показано в примере ниже.

```console
From: <sip:+17168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679
```

## <a name="contact-and-record-route-headers-considerations"></a>Контактные и Record-Route с Record-Route.

Прокси-сервер SIP должен вычислить FQDN следующего перехода для новых клиентских транзакций в диалоговом оке (например, Bye или Re-Invite), а также при ответе на параметры SIP. Используются контакты или Record-Route контактов. 

Согласно [RFC 3261, разделу 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8)в любом запросе, который может привести к новому диалоговом оклу, требуется заглавная связь контакта. Этот Record-Route требуется только в том случае, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окке. Если прокси-сервер SBC [](./direct-routing-media-optimization.md)используется с локальной оптимизацией мультимедиа для прямой маршрутизации, необходимо настроить маршрут записи, так как прокси-сервер должен оставаться в маршруте. 

Корпорация Майкрософт рекомендует использовать только заглавную запись контакта, если не используется прокси-сервер SBC:

- В [соответствии с RFC 3261, раздел 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route используется, если прокси-сервер хочет оставаться на пути будущих запросов в диалоговом окке, что не важно, если ни один прокси-сервер SBC не настроен, так как весь трафик проходит между прокси-сервером Microsoft SIP и сопряженным SBC. 

- Прокси-сервер SIP (Майкрософт) использует только заглавную запись контакта (а не Record-Route) для определения следующего перехода при отправке параметров исходящие связи. Настройка только одного параметра (Контакт) вместо двух (Contact и Record-Route) упрощает администрирование, если прокси-сервер SBC не используется. 

Для вычисления следующего перехода прокси-сервер SIP использует:

- Приоритет 1. Запись верхнего уровня. Если имя FQDN Record-Route верхнего уровня, имя FQDN используется для соединения исходящие в диалоговом окну.

- Приоритет 2. Заглавная связь с контактом. Если Record-Route не существует, прокси-сервер SIP будет искать значение в заглавной части контакта, чтобы сделать исходящие подключения. (Рекомендуемая конфигурация.)

Если используются как contact, так и Record-Route, администратор SBC должен сохранить одинаковые значения, что приводит к накладным расходовам администратора. 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a>Использование имени FQDN в контакте или Record-Route

Использование IP-адреса не поддерживается ни в Record-Route, ни в контакте. Единственным поддерживаемым вариантом является FQDN, которое должно совпадать с общим именем или альтернативным именем субъекта сертификата SBC (поддерживаются поддеревные знаки в сертификате).

- Если IP-адрес присутствует в record-route или Contact, проверка сертификата не проходит, а звонок не проходит.

- Если FQDN не соответствует значению общего или альтернативного имени субъекта в представляемом сертификате, вызов не происходит. 

## <a name="inbound-call-sip-dialog-description"></a>Входящий звонок: описание диалогового окно SIP

В следующей таблице ниже общались различия и сходства потока зовов между режимами обхода и обхода:

| Имя параметра | Режим без обхода | Режим обхода
| :---------------------  |:---------------------- |:----------------|
| Кандидаты на мультимедиа в 183 и 200 сообщениях, которые приходят из | Процессоры мультимедиа | Клиенты | 
| Число 183 сообщений, которые может получать SBC | По одному в сеансе | Несколько | 
| Звонок может быть с предварительным ответом (183) | Да | Да |
| Звонок может быть без предварительного ответа (183) | Да | Да |

###  <a name="non-media-bypass-flow"></a>Поток обхода без мультимедиа

У Teams может быть несколько конечных точек одновременно. Например, Teams для Windows, Teams для iPhone и Teams Телефон (Teams клиента Android). Каждая конечная точка может сигнализировать об отстаке HTTP следующим образом:

-   Ход выполнения звонка — преобразуется прокси-сервером SIP в сообщение SIP 180. При получении сообщения 180 SBC должен создать локальный звонок.

-   Медиаотобращение— преобразуется прокси-сервером SIP в сообщение 183 с кандидатами на мультимедиа в протоколе SDP. При получении сообщения 183 SBC рассчитывает подключиться к медиаимумам, полученным в сообщении SDP. 

    > [!NOTE]
    > В некоторых случаях ответ на вопрос "Мультимедиа" может не быть создан, а конечный пункт может ответить сообщением "Звонок принят".

-   Звонок принят — преобразуется прокси-сервером SIP в сообщение SIP 200 с SDP. При получении сообщения 200 ожидается отправка и получение мультимедиа для предоставленных кандидатов SDP и от них.

    > [!NOTE]
    > Прямая маршрутная маршрутия не поддерживает приглашение с задержкой предложения (приглашение без SDP).

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a>Несколько конечных точек, которые звонят с временным ответом

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках. 

2.  После уведомления каждая конечная точка начнет звонить на прокси-сервер SIP и отправлять сообщения о ходе выполнения зовов. Так как Teams может иметь несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения зовов.

3.  Для каждого сообщения о ходе выполнения звонка, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 Trying". Интервал для отправки таких сообщений определяется интервалом получения сообщений от контроллера звонка. На приведенной ниже схеме прокси-сервером SIP создается 180 сообщений. Эти сообщения приходят из двух Teams конечных точек пользователя. У каждого клиента есть уникальный ИД тега.  Каждое сообщение из другой конечной точки будет отдельным сеансом (параметр "тег" в поле "To" будет разным). Однако конечная точка может не создать сообщение 180 и отправить сообщение 183 сразу, как показано на приведенной ниже схеме.

4.  После того как конечная точка создает сообщение "Ответ на мультимедиа" с IP-адресами кандидатов на поддержку мультимедиа конечной точки, прокси-сервер SIP преобразует полученное сообщение в сообщение "Ход выполнения сеанса SIP 183", а SDP клиента будет заменена SDP-сервером из процессора мультимедиа. На приведенной ниже схеме конечная точка из Висяча 2 ответила на звонок. Если ни одна из сторон связи не обойдена, сообщение SIP 183 создается только один раз (ring bot или client end point). На 183-й может быть уже существующий висячий или новый.

5.  Вместе с конечными кандидатами конечной точки, которые приняли звонок, будет отправлено сообщение о приеме звонка. Сообщение о приемке вызовов преобразуется в сообщение SIP 200. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек, которые звонят с временным ответом.](media/direct-routing-protocols-1.png)

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a>Несколько конечных точек, которые звонят без предварительного ответа

1.  При получении первого приглашения из SBC прокси-сервер SIP отправляет сообщение "SIP SIP/2.0 100 Trying" и сообщает конечным точкам пользователей о входящих звонках. 

2.  После уведомления каждая конечная точка начнет звонить и отправлять сообщение "Ход выполнения звонка" на прокси-сервер SIP. Так как Teams может иметь несколько конечных точек, прокси-сервер SIP может получать несколько сообщений о ходе выполнения зовов.

3.  Для каждого сообщения о ходе выполнения звонка, полученного от клиентов, прокси-сервер SIP преобразует сообщение о ходе выполнения звонка в сообщение SIP "SIP SIP/2.0 180 Trying".  Интервал для отправки сообщений определяется интервалом получения сообщений с контроллера звонка. На рисунке ниже 180 сообщений, созданных прокси-сервером SIP, то есть пользователь вошел в три клиента Teams и каждый клиент отправил ход выполнения звонка. Каждое сообщение будет отдельным сеансом (параметр "тег" в поле "To" отличается)

4.  Вместе с конечными кандидатами конечной точки, которые приняли звонок, будет отправлено сообщение о приеме звонка. Сообщение о приемке вызовов преобразуется в сообщение SIP 200. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек, которые звонят без предварительного ответа.](media/direct-routing-protocols-2.png)

### <a name="media-bypass-flow"></a>Поток обхода мультимедиа

Те же сообщения (100 trying, 180, 183) используются в сценарии обхода мультимедиа. 

В приведенной ниже схеме показан пример обхода потока зова. 

> [!NOTE]
> Кандидаты на выбор мультимедиа могут быть из разных конечных точек. 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек, которые звонят с временным ответом.](media/direct-routing-protocols-3.png)

## <a name="replaces-option"></a>Параметр "Заменяет"

SBC должен поддерживать приглашение на замену.

## <a name="size-of-sdp-considerations"></a>Размер аспектов SDP

Интерфейс прямой маршрутизации может отправить сообщение SIP, превышающий 1500 тол.  Это главным образом связано с размером SDP. Однако если за SBC находится магистраль UDP, оно может отклонить сообщение, если оно будет перенапрано с прокси-сервера SIP Майкрософт на неизмененную. Корпорация Майкрософт рекомендует обрезать некоторые значения в SDP на SBC при отправке сообщения на ленту UDP. Например, можно удалить соитли ICE или неиспользованые кодеки.

## <a name="call-transfer"></a>передача вызовов;

Прямая маршрутия поддерживает два способа перенаправки вызовов:

- Вариант 1. Процессы прокси-сервера SIP. Они относятся к локальному клиенту и выступают в качестве посредника, как описано в разделе 7.1 RFC 3892.

  При этом прокси-сервер SIP прекращает передачу и добавляет новое приглашение. 


- Вариант 2. Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве переносителя, как описано в разделе 6 RFC 5589.

  При этом прокси-сервер SIP отправляет ссылку на SBC и ожидает, что SBC полностью обработать передачу.

Прокси-сервер SIP выбирает метод на основе возможностей, о возможностях, о которые сообщает SBC. Если SBC указывает на то, что он поддерживает метод "Refer", прокси-сервер SIP будет использовать вариант 2 для перенаправок.

Ниже по образцу SBC отправляется сообщение о том, что метод Refer поддерживается:

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

Если SBC не указывает на то, что "Ссылка как поддерживаемый способ", прямая маршрутия будет использовать вариант 1 (прокси-сервер SIP выступает в качестве подмножества). Кроме того, SBC должен сигнализировать о том, что он поддерживает метод Notify:

Пример SBC, указывающий на то, что метод Refer не поддерживается:

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a>Процессы прокси-сервера SIP. Ссылаются на локального клиента и выступают в качестве посредника

Если SBC указал, что метод Refer не поддерживается, прокси-сервер SIP выступает в качестве посредника. 

Запрос на ссылку, который приходит от клиента, будет прекращен на прокси-сервере SIP. (На приведенной ниже схеме запрос на передачу от клиента показан как "Передача вызовов Е.  Дополнительные сведения см. в разделе 7.1 [RFC 3892.](https://www.ietf.org/rfc/rfc3892.txt) 

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек, которые звонят с временным ответом.](media/direct-routing-protocols-4.png)

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a>Прокси-сервер SIP отправляет ссылку на SBC и выступает в качестве посредника

Этот способ является предпочтительным и является обязательным для устройств, которые ищут сертификацию обхода мультимедиа. Передача вызовов без использования SBC для обработки ссылок не поддерживается в режиме обхода мультимедиа. 

Стандартная процедура объясняется в разделе 6 RFC 5589. Связанными будут:

- [Управление звонками по протоколу SIP (Session Initiation Protocol, SIP) — передача](https://tools.ietf.org/html/rfc5589)

- [Замещает заглавный протокол SIP](https://tools.ietf.org/html/rfc3891)

- [Механизм SIP](https://tools.ietf.org/html/rfc3892)

Предполагается, что прокси-сервер SIP выступает в качестве переносителя и отправляет в SBC сообщение "Ссылка". SBC выступает в качестве переносимой и обрабатывает ссылку для создания нового предложения для передачи. Возможны два случая:

- Звонок будет перенаправлен внешнему участнику ОКП. 
- Звонок передается от одного Teams другому Teams в том же клиенте через SBC. 

Если звонок переносится от одного Teams пользователя к другому через SBC, предполагается, что SBC выдает новое приглашение (начать новое диалоговое окно) для целевого Teams, используя сведения, полученные в сообщении. 

Чтобы заполнить поля To/Transferor для транзакции запроса внутри нее, прокси-сервер SIP должен передавать эти сведения в заглавных полях REFER-TO/REFERRED-BY. 

Прокси-сервер SIP будет формировать REFER-TO как URI SIP, состоящий из FQDN прокси-сервера SIP в имени хоста и одного из следующих uri:

- Номер телефона E.164 в части URI имени пользователя, если целевым объектом передачи является номер телефона или

- Параметры x-m и x-t, кодющие полную передачу параметров MRI и ИД клиента соответственно 

Заглавный код REFERRED-BY — это URI SIP с кодом MRI-кода переносителя, а также кодом клиента переноса и другими параметрами контекста передачи, как показано в таблице ниже.

| Параметр | Значение | Описание |  
|:---------------------  |:---------------------- |:---------------------- |
| x-m | МРТ | Full MRI of transferor/transfer target as populated by CC |
| x-t | Идентификатор клиента | X-t Tenant ID Optional Tenant ID as populated by CC |
| x-ti | Transferor Correlation Id | Correlation ID of the call to the transferor |
| x-tt | URI передачи целевого звонка | Кодированный URI замены звонка |

В этом случае размер заглавной ссылки может быть не более 400 символов. SBC должен поддерживать обработку ссылок с сообщениями размером до 400 символов.

> [!div class="mx-imgBorder"]
> ![Схема, показывающая несколько конечных точек, которые звонят с временным ответом.](media/direct-routing-protocols-5.png)

## <a name="session-timer"></a>Сеансовой timer

Прокси-сервер SIP поддерживает (всегда предлагает) время сеанса при звонках без обхода, но не предлагает его при обходе звонков. Использование SBC timer сеанса не является обязательным.

##  <a name="use-of-request-uri-parameter-userphone"></a>Использование параметра Request-URI user=phone

Прокси-сервер SIP анализирует запрос-URI, и если параметр user=phone присутствует, служба будет обрабатывать request-URI как номер телефона, совпадая с номером пользователя. Если параметра нет, прокси-сервер SIP применяет авристику для определения типа пользователя Request-URI (номер телефона или SIP-адрес).

Корпорация Майкрософт рекомендует всегда применять параметр user=phone, чтобы упростить настройку звонков.

## <a name="history-info-header"></a>History-Info загона

Заглавная History-Info используется для перенанабножать запросы SIP и "предоставлять" стандартный механизм сбора сведений об истории запросов, чтобы обеспечить поддержку широкого круга служб для сетей и конечных пользователей". Дополнительные сведения см. в разделе [RFC 4244 — раздел 1.1.](http://www.ietf.org/rfc/rfc4244.txt) В Телефон (Майкрософт) система этот замещающий  

При отправке History-Info включено следующим образом:

- Прокси-сервер SIP вставит параметр, содержащий связанный номер телефона, в отдельные записи History-Info, которые включают History-Info, отправленные на контроллер ЗВОНКОВ.  Если использовать только записи с параметром номера телефона, контроллер ЗВОНКОВ перестроит новый History-Info и передаст его поставщику услуг связи SIP через прокси-сервер SIP.

- History-Info будут добавлены загон для одновременных звонка и случаев переад вызовов.

- History-Info не будет добавлен для случаев перена передачи вызовов.

- В восстановленном History-Info записи истории будет параметр номера телефона, предоставленный в сочетании с FQDN прямой маршрутии (sip.pstnhub.microsoft.com), заданным в качестве хост-части URI; Параметр "user=phone" будет добавлен в URI SIP.  Любые другие параметры, связанные с исходным History-Info, за исключением контекстных параметров телефона, будут передаваться в повторно построенном History-Info.  

  > [!NOTE]
  > Частные записи (в соответствии с механизмами, определенными в разделе 3.3 RFC 4244) будут перенаправлены так же, как и частные записи, так как поставщик услуг связи SIP является доверенным пиром.

- Входящие History-Info игнорируются.

Ниже приводится формат заглавного заглавного адреса "История-сведения", отправленного прокси-сервером SIP:

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

Если звонок перенаправлялся несколько раз, сведения о каждом перенаправлении включаются с соответствующей причиной в хронологическом порядке.


Пример заглавного за

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

Этот History-Info защищен с помощью обязательного механизма TLS. 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a>Подключение SBC к прямой маршрутике и механизму отбойного управления

См. раздел Механизм отрезка для сигнального сигнала SIP в [статье Планирование прямой маршрутизации.](direct-routing-plan.md#failover-mechanism-for-sip-signaling)

## <a name="retry-after"></a>Retry-After

Если центр обработки данных Direct Routing занят, служба может отправить Retry-After с интервалом в одну секунду в SBC. Когда SBC получает сообщение 503 с Retry-After в ответ на приглашение, он должен прекратить подключение и попробовать следующий доступный центр обработки данных Майкрософт.

## <a name="handling-retries-603-response"></a>Обработка ирисовки (603 ответа)
Если конечный пользователь наблюдает несколько пропущенных звонков для одного звонка после отступа, это означает, что механизм повторной работы поставщика услуг связи SBC или STN неправильно сконфигурировали. Чтобы остановить попытку ответа 603, необходимо перенастроить SBC.

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a>Перезапуск ICE: звонок "Обход мультимедиа" переносится на конечную точку, которая не поддерживает обход мультимедиа

SBC должен поддерживать перезапуски ICE, как описано в [разделе 9.1.1.1.1 RFC 5245.](https://tools.ietf.org/html/rfc5245#section-9.1.1.1)

Перезапуск в прямой маршрутике выполняется в соответствии со следующими абзацами RFC:

*Чтобы перезапустить ICE, агент должен изменить в предложении как льдовый, так и льдовый уфраг для потока мультимедиа.  Обратите внимание, что атрибуты уровня сеанса можно использовать в одном предложении, но использовать тот же атрибут ice-pwd или ice-ufrag, что и атрибуты уровня мультимедиа в последующих предложениях.  Это не изменение пароля, а изменение его представления и не приведет к перезапуску ICE.*

*Агент задает остальные поля в SDP для этого потока мультимедиа так же, как в первоначальном предложении этого потока мультимедиа (см. раздел 4.3).  Следовательно, в набор кандидатов могут быть некоторые, никто или все предыдущие кандидаты для этого потока, а также новый набор кандидатов, собранный в соответствии с разделом 4.1.1.*

Если звонок был изначально установлен с помощью обхода мультимедиа и перенаправлен в клиент Skype для бизнеса, необходимо вставить процессор мультимедиа, так как прямая маршрутия не может использоваться с клиентом Skype для бизнеса с обходом мультимедиа. Прямая маршрутизации запускает процесс перезапуска ICE, изменяя льдом и льдом-ufrag и предлагая новых кандидатов мультимедиа в повторной обработке.
