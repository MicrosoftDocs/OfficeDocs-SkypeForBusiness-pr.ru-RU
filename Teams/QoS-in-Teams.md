---
title: Качество обслуживания в Microsoft Teams
ms.author: mikeplum
author: MikePlumleyMSFT
manager: Serdars
ms.topic: article
ms.service: msteams
ms.reviewer: vkorlep, siunies
audience: admin
description: Узнайте, как подготовить сеть организации к качеству обслуживания (QoS) в Microsoft Teams.
ms.localizationpriority: medium
search.appverid: MET150
f1.keywords:
- CSH
ms.custom:
- ms.teamsadmincenter.meetingsettings.qos
- ms.teamsadmincenter.meetingsettings.network.qosmarkers
- seo-marvel-apr2020
ms.collection:
- M365-collaboration
appliesto:
- Microsoft Teams
ms.openlocfilehash: 5b9c049942808da9b2df97d031ff850949bca211
ms.sourcegitcommit: 8d7a926758971bee491d24f23b1ad14f5e5c6f7f
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2022
ms.locfileid: "66713317"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>Реализация качества обслуживания (QoS) в Microsoft Teams

Качество обслуживания (QoS) в Microsoft Teams позволяет сетевому трафику в режиме реального времени, чувствительным к задержкам сети (например, голосовым или видеопотокам), "вырезать в строке" перед менее конфиденциальным трафиком (например, скачивание нового приложения, где скачивание дополнительной секунды не является большим объемом). QoS использует объекты Windows групповая политика и списки контроль доступа на основе портов для идентификации и пометки всех пакетов в потоках в режиме реального времени. Это помогает вашей сети предоставлять голосовой, видео- и экранный общий доступ к потокам выделенной части пропускной способности сети.

Если вы поддерживаете большую группу пользователей, у которых возникают какие-либо проблемы, описанные в этой статье, возможно, потребуется реализовать QoS. Малому бизнесу с небольшим количеством пользователей может не потребоваться качество обслуживания, но даже там это может быть полезно.

Без какой-либо формы QoS в голосовой и видеосвязи могут возникнуть следующие проблемы с качеством:

- Дрожание — пакеты мультимедиа, поступающие с разной скоростью, что может привести к отсутствию слов или слогов в вызовах
- Потеря пакетов — пакеты удалены, что также может привести к снижению качества голоса и сложному распознаванию речи
- Отложенное время кругового пути (RTT) — передача пакетов мультимедиа в места назначения занимает много времени, что приводит к заметным задержкам между двумя сторонами в беседе и заставляет людей общаться друг с другом.

Наименее сложный способ решения этих проблем — увеличить размер подключений к данным как внутри, так и из Интернета. Так как это часто является дорогостоящим, QoS предоставляет способ более эффективного управления ресурсами, которые у вас есть, вместо добавления пропускной способности. Чтобы устранить проблемы с качеством, рекомендуется сначала использовать QoS, а затем добавить пропускную способность только при необходимости.

Чтобы качество обслуживания было эффективным, необходимо применить согласованные параметры качества обслуживания во всей организации. Любая часть пути, которая не поддерживает ваши приоритеты качества обслуживания, может снизить качество звонков, видео и демонстрации экрана. Это включает применение параметров ко всем пользовательским компьютерам или устройствам, сетевым коммутаторам, маршрутизаторам в Интернете и службе Teams.

_Рис. 1. Связь между сетями организации и службами Microsoft 365 или Office 365_

![Иллюстрация связи между сетями и службами.](media/Qos-in-Teams-Image1.png "Связь между сетями организации и службами Microsoft 365 или Office 365: локальная сеть и устройства подключаются к сети подключения, которая, в свою очередь, подключается к службам Голосовой связи и аудиоконференций Microsoft 365 или Office 365 Cloud.")

## <a name="qos-implementation-checklist"></a>Контрольный список реализации QoS

На высоком уровне выполните следующие действия для реализации QoS:

1. [Убедитесь, что сеть готова](#make-sure-your-network-is-ready).

1. [Выберите метод реализации QoS](#select-a-qos-implementation-method).

1. [Выберите начальные диапазоны портов для каждого типа носителя](#choose-initial-port-ranges-for-each-media-type).

1. Реализуйте параметры качества обслуживания:
   1. На клиентах, использующих объект групповая политика (GPO) для задания диапазонов портов и [маркировки клиентских устройств](QoS-in-Teams-clients.md).
   2. На маршрутизаторах (см. документацию производителя) или других сетевых устройствах. Это может быть контроль доступа списков управления доступом на основе портов или простое определение очередей QoS и меток DSCP или все эти.

      > [!IMPORTANT]
      > Мы рекомендуем реализовать эти политики качества обслуживания, используя исходные порты клиента и исходный и конечный IP-адрес "any". Это позволит перехватывать как входящий, так и исходящий трафик мультимедиа во внутренней сети.  

   3. [Задайте способ обработки медиа-трафика для собраний Teams](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings).

5. [Проверьте реализацию QoS,](#validate-your-qos-implementation) проанализировав трафик Teams в сети.

При подготовке к реализации QoS учитывайте следующие рекомендации:

- Лучше всего использовать самый короткий путь к Microsoft 365.
- Закрытие портов приведет только к снижению качества.
- Любые препятствия между ними, например прокси-серверы, не рекомендуется.
- Ограничьте число прыжков:
  - От клиента к границе сети — от 3 до 5 прыжков
  - Подключение поставщиков услуг Интернета к границе сети Майкрософт — 3 прыжка
  - От границы сети Майкрософт до конечного места назначения — не имеет значения

Сведения о настройке портов брандмауэра см. [в Office 365 URL-адресов и диапазонов IP-адресов](office-365-urls-ip-address-ranges.md).

## <a name="make-sure-your-network-is-ready"></a>Убедитесь, что сеть готова

Если вы рассматриваете реализацию QoS, необходимо определить требования к пропускной способности и другие [требования к сети](prepare-network.md).
  
Перегрузка трафика в сети значительно повлияет на качество мультимедиа. Отсутствие пропускной способности приводит к снижению производительности и ухудшению взаимодействия с пользователем. По мере роста внедрения и использования Teams используйте отчеты [,](use-call-analytics-to-troubleshoot-poor-call-quality.md) аналитику звонков для каждого пользователя и панель мониторинга качества звонков [(CQD)](turning-on-and-using-call-quality-dashboard.md) для выявления проблем, а затем внесите изменения с помощью QoS и выборочного добавления пропускной способности.

### <a name="vpn-considerations"></a>Рекомендации по VPN

Качество обслуживания работает должным образом только при реализации во всех ссылках между вызывающими объектами. Если вы используете QoS во внутренней сети и пользователь входит из удаленного расположения, приоритет можно задать только внутри внутренней управляемой сети. Хотя удаленные расположения могут получать управляемое подключение путем реализации виртуальной частной сети (VPN), VPN по своей сути увеличивает нагрузку на пакеты и создает задержки в трафике в режиме реального времени. Рекомендуется избегать запуска трафика связи в режиме реального времени через VPN.

В глобальной организации с управляемыми каналами, охватывающими континенты, мы настоятельно рекомендуем использовать QoS, так как пропускная способность для этих каналов ограничена по сравнению с локальной сетью.

## <a name="introduction-to-qos-queues"></a>Общие сведения о очередях QoS

Чтобы обеспечить качество обслуживания, сетевые устройства должны иметь возможность классифицировать трафик и иметь возможность отличать голосовые или видеосвязи от другого сетевого трафика.

Когда сетевой трафик входит в маршрутизатор, он помещается в очередь. Если политика качества обслуживания не настроена, существует только одна очередь, и все данные обрабатываются как данные "первым", то есть с одинаковым приоритетом. Это означает, что голосовой трафик (который очень чувствительн к задержкам) может зависнуть за трафиком, если задержка в несколько дополнительных миллисекунд не будет проблемой.

При реализации QoS вы определяете несколько очередей с помощью одной из нескольких функций управления перегрузкой, например приоритетных очередей Cisco и взвешенного взвешенного очереди на основе классов [(CBWFQ)](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641) и функций предотвращения перегрузки, таких как взвешенного случайного [раннего обнаружения (WRED)](https://en.wikipedia.org/wiki/Weighted_random_early_detection).

_Рис. 2. Примеры очередей QoS_

![Иллюстрация очередей качества обслуживания и деления пропускной способности.](media/Qos-in-Teams-Image2.png "Общая доступная пропускная способность распределяется между несколькими очередями ( аудио, видео и другим трафиком), которым назначены разные приоритеты.")

Простая аналогия — QoS создает виртуальные "полосы карполя" в сети данных, поэтому некоторые типы данных никогда или редко сталкиваются с задержкой. Создав эти полосы, вы сможете настроить их относительный размер и гораздо эффективнее управлять пропускной способностью подключения, сохраняя при этом возможности бизнес-уровня для пользователей вашей организации.

## <a name="select-a-qos-implementation-method"></a>Выбор метода реализации QoS

Вы можете реализовать QoS с помощью тегов на основе портов, используя контроль доступа списков (ACL) на маршрутизаторах вашей сети. Теги на основе портов — это самый надежный метод, так как он работает в смешанных средах Windows, Mac и Linux и является самым простым в реализации. Мобильные клиенты не предоставляют механизм для маркировки трафика с помощью значений DSCP, поэтому им потребуется этот метод.  

Используя теги на основе портов, маршрутизатор сети проверяет входящий пакет и, если пакет поступает с использованием определенного порта или диапазона портов, он определяет его как определенный тип носителя и помещает его в очередь для этого типа, добавляя предопределенные метки [DSCP](https://tools.ietf.org/html/rfc2474) в заголовок IP-пакета, чтобы другие устройства могли распознавать его тип трафика и присваивать ему приоритет в своей очереди.

Хотя маркировка на основе портов работает на разных платформах, она помечает трафик только на границе глобальной сети (а не на клиентском компьютере) и создает накладные расходы на управление. Инструкции по реализации этого метода см. в документации, предоставленной производителем маршрутизатора.

### <a name="insert-dscp-markers"></a>Вставка маркеров DSCP

Можно также реализовать QoS с помощью объекта групповая политика (GPO), чтобы клиентские устройства могли вставлять маркер DSCP в заголовки IP-пакетов, определяя его как определенный тип трафика (например, голосовой). Маршрутизаторы и другие сетевые устройства можно настроить для распознавания этого и размещения трафика в отдельной очереди с более высоким приоритетом.

Хотя этот сценарий является полностью допустимым, он будет работать только для присоединенных к домену клиентов Windows. Любое устройство, не присоединенное к домену клиентом Windows, не будет включено для добавления тегов DSCP. Другие клиенты, например под управлением macOS, имеют жестко заданные теги и всегда будут помечайте трафик.

На стороне плюса управление маркировкой DSCP с помощью объекта групповой политики гарантирует, что все присоединенные к домену компьютеры получат одинаковые параметры и что только администратор может управлять ими. Клиенты, которые могут использовать объект групповой политики, будут помечены на исходном устройстве, а затем настроенные сетевые устройства смогут распознавать поток в режиме реального времени с помощью кода DSCP и присваивать ему соответствующий приоритет.

### <a name="best-practice"></a>Рекомендации

По возможности рекомендуется использовать сочетание разметки DSCP в конечной точке и списков ACL на основе портов на маршрутизаторах. Использование объекта групповой политики для перехвата большинства клиентов, а также использование тегов DSCP на основе портов гарантирует, что мобильные устройства, Mac и другие клиенты будут по-прежнему получать обработку QoS (по крайней мере частично).

Маркировку DSCP можно совместить с почтовыми метками, которые указывают почтовым работникам, насколько срочной является доставка и как лучше всего сортировать ее для быстрой доставки. После настройки сети для передачи приоритета потокам мультимедиа в режиме реального времени потеря пакетов и поздних пакетов должна значительно снизиться.

После того как все устройства в сети будут использовать одинаковые классификации, маркировки и приоритеты, можно уменьшить или устранить задержки, отброшенные пакеты и дрожание, изменив размер диапазонов портов, назначенных очередям, используемым для каждого типа трафика. С точки зрения Teams самым важным этапом настройки является классификация и маркировка пакетов. Однако для успешного выполнения сквозного QoS необходимо также тщательно согласовать конфигурацию приложения с базовой конфигурацией сети. После полной реализации QoS текущее управление — это вопрос настройки диапазонов портов, назначенных каждому типу трафика, в зависимости от потребностей вашей организации и фактического использования.

## <a name="choose-initial-port-ranges-for-each-media-type"></a>Выбор начальных диапазонов портов для каждого типа носителя

Значение DSCP указывает соответствующим образом настроенной сети, какой приоритет следует указать пакету или потоку, назначается ли метка DSCP клиентами или самой сетью на основе параметров ACL. Каждая рабочая нагрузка мультимедиа получает собственное уникальное значение DSCP (другие службы могут разрешить рабочим нагрузкам совместно использовать маркировку DSCP, а Teams — нет) и определенный и отдельный диапазон портов, используемый для каждого типа носителя. В других средах может быть установлена существующая стратегия качества обслуживания, которая поможет определить приоритет сетевых рабочих нагрузок.

Относительный размер диапазонов портов для различных рабочих нагрузок потоковой передачи в реальном времени задает долю общей доступной пропускной способности, выделенной для этой рабочей нагрузки. Чтобы вернуться к предыдущей почтовой аналогии: письмо с меткой "Air Mail" может быть отправлено в ближайший аэропорт в течение часа, а небольшой пакет с отметкой "Массовая почта" может подождать целый день перед поездкой на серию грузовиков.

_Рекомендуемые начальные диапазоны портов_

|Тип медиатрафика| Диапазон портов источника клиента  |Протокол|Значение DSCP|Класс DSCP|
|:--- |:--- |:--- |:--- |:--- |
|Звук| 50,000–50,019|TCP/UDP|46|Беспрепятственная переадресация (EF)|
|Видео| 50,020–50,039|TCP/UDP|34|Гарантированная переадресация (AF41)|
|Приложение / Разделение экрана| 50,040–50,059|TCP/UDP|18|Гарантированная пересылка (AF21)|
||||||

При использовании этих параметров учитывайте следующее:

- Если вы планируете реализовать ExpressRoute в будущем и еще не реализовали QoS, рекомендуем следовать указаниям, чтобы значения DSCP совпадали от отправителя к получателю.

- Все клиенты, включая мобильные клиенты и устройства Teams, будут использовать эти диапазоны портов и будут затронуты любой реализуемой политикой DSCP, использующей эти диапазоны исходных портов. Единственными клиентами, которые продолжат использовать динамические порты, являются клиенты на основе браузера (клиенты, которые позволяют участникам присоединяться к собраниям с помощью браузеров).

- Хотя клиент Mac использует одинаковые диапазоны портов, он также использует жестко заданные значения для аудио (EF) и общего доступа к видео и приложениям и экранам (AF41). Эти значения нельзя настроить.

- Если позже вам потребуется изменить диапазоны портов, чтобы улучшить взаимодействие с пользователем, диапазоны портов не могут перекрываться и должны быть смежными друг с другом.

## <a name="migrate-qos-to-teams"></a>Перенос QoS в Teams

Если вы ранее развернули Skype для бизнеса Online, включая теги QoS и диапазоны портов, и теперь развертываете их. Teams, Teams будут учитывать существующую конфигурацию и будут использовать те же диапазоны портов и теги, что и Skype для бизнеса клиента. В большинстве случаев дополнительная настройка не требуется.

> [!NOTE]
> Если вы используете теги QoS для имени приложения групповая политика, необходимо добавить Teams.exe в качестве имени приложения.

### <a name="implement-qos-in-teams-on-windows-using-powershell"></a>Реализация QoS в Teams в Windows с помощью PowerShell

**Настройка качества обслуживания для звука**

```powershell
new-NetQosPolicy -Name "Teams Audio" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50000 -IPSrcPortEndMatchCondition 50019 -DSCPAction 46 -NetworkProfile All
```

**Настройка качества обслуживания для видео**

```powershell
new-NetQosPolicy -Name "Teams Video" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50020 -IPSrcPortEndMatchCondition 50039 -DSCPAction 34 -NetworkProfile All
```

**Настройка качества обслуживания для общего доступа**

```powershell
new-NetQosPolicy -Name "Teams Sharing" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50040 -IPSrcPortEndMatchCondition 50059 -DSCPAction 18 -NetworkProfile All
```

## <a name="managing-source-ports-in-the-teams-admin-center"></a>Управление исходными портами в Центре администрирования Teams

В Teams исходные порты QoS, используемые различными рабочими нагрузками, должны активно управляться и корректироваться при необходимости. Ссылаясь на таблицу в разделе "Выбор начальных диапазонов портов" для каждого типа носителя [,](#choose-initial-port-ranges-for-each-media-type) диапазоны портов можно изменить, но разметку DSCP нельзя настроить. После реализации этих параметров может оказаться, что для данного типа носителя требуется больше или меньше портов. [Аналитику](use-call-analytics-to-troubleshoot-poor-call-quality.md) звонков для отдельных пользователей и панель мониторинга [качества звонков (CQD)](turning-on-and-using-call-quality-dashboard.md) следует использовать для принятия решения об изменении диапазонов портов после реализации Teams и периодически при изменении потребностей.

> [!NOTE]
> Если вы уже настроите QoS на основе диапазонов исходных портов и маркировки DSCP для Skype для бизнеса Online, эта же конфигурация будет применяться к Teams, и никакие дополнительные изменения клиента или сети в сопоставлении не требуются, хотя вам может потребоваться задать диапазоны, используемые [в Teams](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings), в соответствии с тем, что было настроено для Skype для бизнеса Online.

Если вы ранее развернули Skype для бизнеса Server локально, может потребоваться повторно изучить политики качества обслуживания. Настройте политики в соответствии с проверенными параметрами диапазона портов, чтобы обеспечить качественный пользовательский интерфейс для Teams.

## <a name="validate-your-qos-implementation"></a>Проверка реализации QoS

Чтобы качество обслуживания было эффективным, значение DSCP, заданное объектом групповой политики, должно присутствовать на обоих концах вызова. Анализируя трафик, созданный клиентом Teams, можно убедиться, что значение DSCP не изменилось или не удалено при перемещении трафика рабочей нагрузки Teams по сети.

Желательно записывать трафик в точке сетевого исходящего трафика. Для этого можно использовать зеркальное отображение портов на коммутаторе или маршрутизаторе.

## <a name="implement-qos-for-other-devices"></a>Реализация QoS для других устройств

Дополнительные сведения о реализации QoS для Intune, Surface, iOS, Android и Mac см. в этих разделах.

- [QoS для Surface Hub 2S](/surface-hub/surface-hub-2s-manage-intune)

- [QoS для Surface Hub](/surface-hub/surface-hub-qos)

- [QoS для iOS, Android и Mac](./meeting-settings-in-teams.md?WT.mc_id=TeamsAdminCenterCSH#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)

## <a name="related-topics"></a>Статьи по теме

- [Видео: планирование сети](https://aka.ms/teams-networking)

- [Подготовка сети организации к использованию Microsoft Teams](prepare-network.md)

- [Реализация QoS в клиенте Teams](QoS-in-Teams-clients.md)
