---
title: Качество обслуживания в Microsoft Teams
author: SerdarSoysal
ms.author: serdars
manager: Serdars
ms.topic: article
ms.service: msteams
ms.reviewer: vkorlep, siunies
audience: admin
description: Узнайте, как подготовить сеть организации к качеству обслуживания (QoS) в Microsoft Teams.
ms.localizationpriority: medium
search.appverid: MET150
f1.keywords:
- CSH
ms.custom:
- ms.teamsadmincenter.meetingsettings.qos
- ms.teamsadmincenter.meetingsettings.network.qosmarkers
- seo-marvel-apr2020
ms.collection:
- M365-collaboration
appliesto:
- Microsoft Teams
ms.openlocfilehash: 3547f23d43f07d8de28ba8ca53626be119de30de
ms.sourcegitcommit: 556fffc96729150efcc04cd5d6069c402012421e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/26/2021
ms.locfileid: "58595291"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>Реализация качества обслуживания (QoS) в Microsoft Teams

Качество обслуживания (QoS) в Microsoft Teams позволяет в режиме реального времени использовать сетевой трафик, который чувствителен к задержкам в сети (например, голосовой или видеопоток), чтобы "вырезать строку" перед менее конфиденциальным трафиком (например, скачиванием нового приложения, где дополнительная секунда для скачивания не так велика). QoS использует Windows групповую политику и списки управления доступом на основе портов для определения и пометки всех пакетов в потоках реального времени. Это позволяет вашей сети передавать потоки голосовой и видеосвязи, а также передачу данных с экрана выделенной части пропускной способности сети.

Если вы поддерживаете большую группу пользователей, у которых возникают какие-либо проблемы, описанные в этой статье, вероятно, необходимо внедрить QoS. Небольшие компании с небольшим количеством пользователей могут не нуждаться в QoS, но даже в них оно должно быть полезным.

Без QoS в голосовой и видеосвязи могут возникнуть следующие проблемы с качеством:

- Дрожание — пакеты мультимедиа, поступающие по разным тарифам, что может привести к отсутствуют словам или слогам в звонках.
- Потеря пакетов — пакеты сброшены, что также может привести к снижению качества голосовой связи и снижению понимания речи
- Отложенное время кругового пути (RTT) — пакеты мультимедиа, которые долго добираются до пункта назначения, что приводит к заметным задержкам между двумя сторонами в беседе и вызывает общение между ними.

Наименее сложный способ решения этих проблем — увеличить размер подключений к данным как внутри организации, так и из-за подключения к Интернету. Так как это часто является неоправительным по стоимости, QoS обеспечивает более эффективное управление ресурсами, а не добавляет полосу пропускания. Для решения проблем с качеством рекомендуется сначала использовать QoS, а затем добавить пропускную способность только при необходимости.

Чтобы QoS было эффективным, необходимо применить согласованные параметры QoS во всей организации. Любая часть пути, которая не поддерживает приоритеты QoS, может привести к ухудшению качества звонков, видео и общего доступа к экрану. Это включает применение параметров на всех пользовательских компьютерах или устройствах, сетевых переключателях, маршрутизаторах к Интернету и службе Teams подключения.

_Рисунок 1. Связь между сетями организации и Microsoft 365 или Office 365 службами_

![Изображение отношения между сетями и службами](media/Qos-in-Teams-Image1.png "Связь между сетями организации и службами Microsoft 365 или Office 365: локальной сетью и устройствами подключаются через интерсоединение, которое, в свою очередь, связывается со службами Microsoft 365 или Office 365 cloud Voice and Audio Conferencing.")

## <a name="qos-implementation-checklist"></a>Контрольный список внедрения QoS

В качестве высокого уровня для внедрения QoS сделайте следующее:

1. [Убедитесь, что сеть готова.](#make-sure-your-network-is-ready)

1. [Выберите метод внедрения QoS.](#select-a-qos-implementation-method)

1. [Выберите диапазоны исходных портов для каждого типа мультимедиа.](#choose-initial-port-ranges-for-each-media-type)

1. Реализация параметров QoS:
   1. На клиентах, использующих объект групповой политики (GPO), чтобы настроить диапазоны портов и [метки клиентских устройств.](QoS-in-Teams-clients.md)
   2. На маршрутизаторах (см. документацию производителя) или других сетевых устройствах. Это может быть списки управления доступом на основе портов или просто определение очередей QoS и маркировки DSCP или всех этих элементов.

      > [!IMPORTANT]
      > Мы рекомендуем реализовать эти политики QoS, используя клиентские исходные порты и IP-адрес источника и назначения "any". Это позволит ловить трафик как входящих, так и исходяющих мультимедиа во внутренней сети.  

   3. [Настройка обработки медиапотока для Teams собраний.](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)

5. [Проверьте реализацию QoS,](#validate-your-qos-implementation) проанализировав Teams трафика в сети.

При подготовке к внедрению QoS следует помнить о следующих рекомендациях:

- Самый короткий путь к Microsoft 365 лучше всего.
- Закрытие портов приведет только к снижению качества.
- Не рекомендуется использовать любые помехи между ними, например прокси-связи.
- Ограничить количество прыжков:
  - От клиента к границе сети — от 3 до 5 прыжков
  - IsP to Microsoft network edge – 3 hops
  - Граница сети Майкрософт до конечного пункта назначения — нерелевантно

Сведения о настройке портов брандмауэра можно найти в Office 365 [URL-адреса и диапазоны IP-адресов.](office-365-urls-ip-address-ranges.md)

## <a name="make-sure-your-network-is-ready"></a>Убедитесь, что сеть готова

Если вы рассматриваете реализацию QoS, необходимо определить требования к пропускной способности и другие [требования к сети.](prepare-network.md)
  
Перегрузка трафика в сети существенно повлияет на качество мультимедиа. Отсутствие пропускной способности ведет к снижению производительности и снижению качества работы пользователей. По мере Teams внедрения и использования используйте [отчеты,](use-call-analytics-to-troubleshoot-poor-call-quality.md)аналитику вызовов для каждого пользователя и панель мониторинга качества звонка [(CQD)](turning-on-and-using-call-quality-dashboard.md) для выявления проблем, а затем внесения изменений с помощью QoS и выборочного добавления пропускной способности.

### <a name="vpn-considerations"></a>Аспекты VPN

QoS работает так, как ожидалось, только при внедрении всех связей между вызывателями. Если вы используете QoS во внутренней сети и пользователь въехал из удаленного расположения, вы можете установить приоритет только внутри внутренней управляемой сети. Хотя удаленные расположения могут получать управляемое подключение путем реализации виртуальной частной сети (VPN), VPN по сути добавляет накладные пакеты и увеличивает задержки при трафике в режиме реального времени. Мы не рекомендуем запускать трафик связи в режиме реального времени через VPN.

В глобальной организации с управляемыми связями, которые охватывают континенты, мы настоятельно рекомендуем использовать QoS, так как пропускная способность для этих связей ограничена в сравнении с локальной сетью.

## <a name="introduction-to-qos-queues"></a>Введение в очереди QoS

Для обеспечения QoS сетевые устройства должны иметь возможность классифицировать трафик и иметь возможность отличать голосовую или видеосвязь от другого сетевого трафика.

При вводе маршрутизатора сетевой трафик помещается в очередь. Если политика QoS не настроена, существует только одна очередь, и все данные обрабатываются как первые, с одинаковым приоритетом. Это означает, что голосовой трафик (который очень чувствителен к задержкам) может зависнуть за трафиком, где задержка в несколько миллисекунд не будет проблемой.

При внедрении QoS вы определяете несколько очередей с помощью одной из нескольких функций управления перегрузкой, таких как очередь приоритетов Cisco и ВЗВЕШЕННЫЕ очереди на основе класса [и](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641) функции предотвращения перегрузки, такие как взвешенные случайные ранние определения [(WRED).](https://en.wikipedia.org/wiki/Weighted_random_early_detection)

_Рисунок 2. Примеры очередей QoS_

![Изображение очередей QoS и деления пропускной способности](media/Qos-in-Teams-Image2.png "Общая доступная пропускная способность разделена на несколько очередей (аудио, видео и другой трафик), для которых назначены разные приоритеты.")

Простая аналогия с тем, что QoS создает виртуальные «дорожки для автомобиля» в сети данных, чтобы некоторые типы данных никогда или редко сталкивались с задержкой. Создав эти дорожки, вы можете настроить их относительный размер и гораздо эффективнее управлять пропускной способностью подключения, но при этом предоставлять пользователям организации бизнес-класса.

## <a name="select-a-qos-implementation-method"></a>Выбор метода внедрения QoS

Вы можете внедрить QoS с помощью тегов на основе портов с помощью списков управления Access на маршрутизаторах сети. Теги на основе портов — это наиболее надежный способ, так как он работает в смешанной среде Windows, Mac и Linux, и его проще всего внедрить. Мобильные клиенты не предоставляют механизм для пометки трафика с помощью значений DSCP, поэтому для них требуется этот метод.  

Используя теги на основе портов, маршрутизатор сети проверяет входящий пакет, и если пакет прибыл с использованием определенного порта или диапазона портов, он определяет его как определенный тип мультимедиа и помещает его в очередь для этого типа, добавляя заранее задаваемую метку [DSCP](https://tools.ietf.org/html/rfc2474) к заглавной записи IP-пакета, чтобы другие устройства могли распознавать его тип трафика и придать ему приоритет в очереди.

Хотя маркировка на основе портов работает на разных платформах, она помечет трафик только на границе WAN (не в сторону клиентского компьютера) и создает накладные расходы на управление. Инструкции по внедрению этого метода можно найти в документации, предоставленной изготовителем маршрутизатора.

### <a name="insert-dscp-markers"></a>Вставка маркеров DSCP

Кроме того, можно реализовать QoS с помощью объекта групповой политики (GPO) для прямых клиентских устройств, которые вставляют маркер DSCP в заглавные пакеты IP-пакетов, определяя его как определенный тип трафика (например, голосовой). Маршрутизаторы и другие сетевые устройства могут быть настроены таким образом, чтобы распознать это и поместить трафик в отдельную очередь с более высоким приоритетом.

Хотя этот сценарий действителен, он будет работать только для клиентов, которые Windows домена. Все устройства, которые не присоединились к Windows домена, не будут включены для маркировки DSCP. Другие клиенты, например, работающие под управлением macOS, имеют жестко закодные теги и всегда будут помечать трафик.

С другой стороны, контроль маркировки DSCP с помощью GPO гарантирует, что все компьютеры, которые присоединились к домену, получат одинаковые параметры и что управлять ими может только администратор. Клиенты, которые могут использовать GPO, помечаются на устройстве, а затем настроенные сетевые устройства распознают поток в режиме реального времени по коду DSCP и придают ему соответствующий приоритет.

### <a name="best-practice"></a>Лучшие методики

По возможности рекомендуется использовать разметку DSCP на конечной точке и портовые ALS на маршрутизаторах. Использование GPO для поимки большинства клиентов, а также использование тегов DSCP на основе портов гарантирует, что мобильные, Mac и другие клиенты будут по-прежнему получать обработку QoS (по крайней мере частично).

Пометки DSCP можно пометить как почтовые метки, которые показывают, насколько срочным является доставка и как лучше отсортировать их для быстрой доставки. После настройки сети для передачи потоков мультимедиа в режиме реального времени потеря пакетов и пакетов с поздними номерами может значительно ухместиться.

После того как все устройства в сети используют одинаковые классификации, пометки и приоритеты, можно уменьшить или устранить задержки, сброс пакетов и дрожание, изменив размер диапазонов портов, которые назначены очередям для каждого типа трафика. С Teams точки зрения самым важным этапом настройки является классификация и пометка пакетов. Однако для успешной работы qoS необходимо тщательно выровнять конфигурацию приложения с конфигурацией сети. После полного внедрения QoS постоянное управление — это вопрос изменения диапазонов портов, которые назначены каждому типу трафика, в зависимости от потребностей организации и фактического использования.

## <a name="choose-initial-port-ranges-for-each-media-type"></a>Выбор исходных диапазонов портов для каждого типа мультимедиа

Значение DSCP указывает, какая сеть имеет приоритет для передачи пакета или потока независимо от того, назначена ли метка DSCP клиентами или самой сетью на основе параметров ACL. Каждая рабочая нагрузка мультимедиа имеет уникальное значение DSCP (другие службы могут разрешить рабочим нагрузкам совместно использовать маркировку DSCP, Teams не имеет) и определенный и отдельный диапазон портов, используемый для каждого типа мультимедиа. В других средах может существовать стратегия QoS, которая поможет определить приоритет сетевых рабочих нагрузок.

Относительный размер диапазонов портов для различных рабочих нагрузок потоковой передачи в режиме реального времени задает долю общей доступной пропускной способности, выделенной для этой рабочей нагрузки. Чтобы вернуться к предыдущей почтовой аналогии, буква с меткой "Air Mail" может быть доставлена в ближайший аэропорт в течение часа, а небольшой пакет с пометкой "Массовая почта" может подождать день, прежде чем навести на страну на рядах автомобилей.

_Рекомендуемые диапазоны исходных портов_

|Тип медиатрафика| Диапазон портов источника клиента  |Протокол|Значение DSCP|Класс DSCP|
|:--- |:--- |:--- |:--- |:--- |
|Звук| 50,000–50,019|TCP/UDP|46|Беспрепятственная переадресация (EF)|
|Видео| 50,020–50,039|TCP/UDP|34|Гарантированная переадресация (AF41)|
|Приложение / Разделение экрана| 50,040–50,059|TCP/UDP|18|Гарантированная пересылка (AF21)|
||||||

При использовании этих параметров следует помнить о следующих параметрах:

- Если вы планируете реализовать ExpressRoute в будущем, но еще не реализовали QoS, рекомендуем следовать указаниям, чтобы значения DSCP были одинаковыми от отправитель к приемнику.

- Эти диапазоны портов будут использовать все клиенты, включая мобильные и Teams, и на них будет повлиять политика DSCP, использующая диапазоны портов источника. Динамические порты будут по-прежнему использовать только клиенты в браузере (клиенты, которые могут присоединяться к собраниям с помощью браузеров).

- Клиент Mac использует одинаковые диапазоны портов, но для аудио- и видеофайла (AF41) используются жестко задатки. Эти значения невозможно настроить.

- Если позже вам потребуется изменить диапазоны портов для улучшения пользовательского интерфейса, они не могут перекрываться и должны быть смежными друг с другом.

## <a name="migrate-qos-to-teams"></a>Перенос QoS в Teams

Если вы ранее развернули Skype для бизнеса Online, включая маркировку QoS и диапазоны портов, и сейчас развертывание. Teams, Teams будет соблюдать существующую конфигурацию и будет использовать те же диапазоны портов и теги, что и Skype для бизнеса клиента. В большинстве случаев дополнительная настройка не требуется.

> [!NOTE]
> Если вы используете теги QoS "Имя приложения" с помощью групповой политики, Teams.exe имя приложения.

### <a name="implement-qos-in-teams-on-windows-using-powershell"></a>Реализация QoS в Teams на Windows с помощью PowerShell

**Настройка QoS для звука**

```powershell
new-NetQosPolicy -Name "Teams Audio" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50000 -IPSrcPortEndMatchCondition 50019 -DSCPAction 46 -NetworkProfile All
```

**Настройка QoS для видео**

```powershell
new-NetQosPolicy -Name "Teams Video" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50020 -IPSrcPortEndMatchCondition 50039 -DSCPAction 34 -NetworkProfile All
```

**Настройка QoS для общего доступа**

```powershell
new-NetQosPolicy -Name "Teams Sharing" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50040 -IPSrcPortEndMatchCondition 50059 -DSCPAction 18 -NetworkProfile All
```

## <a name="managing-source-ports-in-the-teams-admin-center"></a>Управление исходными портами в Teams администрирования

В Teams необходимо активно управлять исходными портами QoS, используемыми для разных рабочих нагрузок, и при необходимости настраивать их. Ссылаясь на таблицу Выберите диапазоны исходных портов для каждого типа [мультимедиа,](#choose-initial-port-ranges-for-each-media-type)диапазоны портов можно настраивать, но метки DSCP не настраиваются. После внедрения этих параметров может оказаться, что для данного типа мультимедиа требуется больше или меньше портов. [При](use-call-analytics-to-troubleshoot-poor-call-quality.md) принятии решения об изменении диапазонов портов следует использовать аналитические данные о звонках для каждого пользователя и панель мониторинга качества звонка [(CQD)](turning-on-and-using-call-quality-dashboard.md) после внедрения Teams и периодически по мере изменения потребностей.

> [!NOTE]
> Если вы уже настроили QoS на основе диапазонов исходных портов и маркировки DSCP для Skype для бизнеса Online, то такая же конфигурация будет применяться к Teams и больше не потребуется вносить изменения в сопоставление, хотя вам может потребоваться настроить диапазоны, используемые в [Teams,](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings) в зависимости от того, что было настроено для Skype для бизнеса Online.

Если вы ранее развернули Skype для бизнеса Server локально, вам может потребоваться повторно изучить политики QoS. Настройть политики в соответствие с проверенными настройками диапазона портов, чтобы обеспечить качественный пользовательский интерфейс Teams.

## <a name="validate-your-qos-implementation"></a>Проверка внедрения QoS

Чтобы качество QoS было эффективным, значение DSCP, за установленного GPO, должно присутствовать на обоих концах звонка. Анализируя трафик, созданный клиентом Teams, вы можете убедиться, что значение DSCP не изменилось и не обрезалось, Teams трафик рабочей нагрузки перемещается по сети.

Желательно, чтобы трафик фиксируется в точке сетевого точки. Для этого можно использовать зеркальное отражение портов на коммутаторе или маршрутизаторе.

## <a name="implement-qos-for-other-devices"></a>Реализация QoS для других устройств

Сведения о внедрении QoS для Intune, Surface, iOS, Android и Mac см. в этих темах.

- [QoS для Surface Hub 2S](/surface-hub/surface-hub-2s-manage-intune)

- [QoS для Surface Hub](/surface-hub/surface-hub-qos)

- [QoS для iOS, Android и Mac](./meeting-settings-in-teams.md?WT.mc_id=TeamsAdminCenterCSH#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)

## <a name="related-topics"></a>Статьи по теме

- [Видео: планирование сети](https://aka.ms/teams-networking)

- [Подготовка сети организации к использованию Microsoft Teams](prepare-network.md)

- [Реализация QoS в клиенте Teams клиента](QoS-in-Teams-clients.md)