---
title: "Качество обслуживания (QoS) в Microsoft Teams"
author: rmw2890
ms.author: MyAdvisor
manager: Serdars
ms.date: 02/16/2018
ms.topic: article
ms.service: msteams
description: "Подготовка сети организации к работе с качеством обслуживания (QoS) в Microsoft Teams."
MS.collection: Strat_MT_TeamsAdmin
ms.openlocfilehash: 61bebd64c7d1478c16e114631b696dee2bf59625
ms.sourcegitcommit: 85105cb4e42ae8eb6e7e76eaf6d4dd5b9568cf41
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2018
---
<a name="quality-of-service-qos-in-microsoft-teams"></a><span data-ttu-id="815a0-103">Качество обслуживания (QoS) в Microsoft Teams</span><span class="sxs-lookup"><span data-stu-id="815a0-103">Quality of Service (QoS) in Microsoft Teams</span></span>
==========================================
<span data-ttu-id="815a0-104">Это руководство поможет подготовить сеть вашей организации к работе с качеством обслуживания (QoS) в Microsoft Teams.</span><span class="sxs-lookup"><span data-stu-id="815a0-104">This guide will help you prepare your organization's network for Quality of Service (QoS) in Teams.</span></span>


<span data-ttu-id="815a0-105">Качество обслуживания (QoS) — это механизм, который позволяет приоритизировать определенные типы сетевого трафика.</span><span class="sxs-lookup"><span data-stu-id="815a0-105">Quality of Service (QoS) is a mechanism that lets you prioritize certain types of network traffic.</span></span> <span data-ttu-id="815a0-106">Назначение приоритетов для трафика служб связи в режиме реального времени, таких как Teams, является необходимым условием для предоставления пользователям услуг бизнес-класса.</span><span class="sxs-lookup"><span data-stu-id="815a0-106">Prioritizing the traffic for real-time communications services such as Teams is important in order to deliver a business-grade user experience.</span></span> <span data-ttu-id="815a0-107">Чтобы QoS было действительно эффективным, подключения с поддержкой QoS должны быть настроены на всем пути от начального узла к конечному (компьютер, затем сетевые коммутаторы, маршрутизаторы и облако), так как если хотя бы один элемент на этом пути не поддерживает QoS, это снизит качество всего соединения.</span><span class="sxs-lookup"><span data-stu-id="815a0-107">For QoS to be truly effective, a QoS-capable connection must be configured end-to-end (PC, network switches, and routers to the cloud), because any part in the path that fails to support QoS could degrade the quality of the entire call.</span></span>


![Схема отношений между сетями организации и службами Office 365.](media/Qos-in-Teams-Image1.png)

 

<span data-ttu-id="815a0-109">В большинстве случаев промежуточная сеть будет неуправляемой сетью, интернет-подключением.</span><span class="sxs-lookup"><span data-stu-id="815a0-109">In most cases, the interconnect network will be an unmanaged network, an internet connection.</span></span> <span data-ttu-id="815a0-110">Одним из возможных вариантов обеспечения сквозного QoS является использование [ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/).</span><span class="sxs-lookup"><span data-stu-id="815a0-110">One option available to address end-to-end QoS is [ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/).</span></span> <span data-ttu-id="815a0-111">Тем не менее мы все же рекомендуем реализовать QoS на контролируемых вами участках сети, а именно в вашей локальной сети.</span><span class="sxs-lookup"><span data-stu-id="815a0-111">It is our recommendation to still implement QoS on the portions of the network you have control over, namely your on-premises network.</span></span> <span data-ttu-id="815a0-112">Это улучшит выполнение рабочих нагрузок связи в реальном времени и поможет уменьшить количество узких мест в развернутой у вас среде.</span><span class="sxs-lookup"><span data-stu-id="815a0-112">This will increase the quality of real time communication workloads throughout your deployment and will alleviate choke points in your existing deployment.</span></span> 

## <a name="objectives"></a><span data-ttu-id="815a0-113">Цели</span><span class="sxs-lookup"><span data-stu-id="815a0-113">Objectives</span></span> 

<span data-ttu-id="815a0-114">Это руководство посвящено тому, как приоритизировать трафик Teams для связи в режиме реального времени, а именно для голосового и видеотрафика.</span><span class="sxs-lookup"><span data-stu-id="815a0-114">This guide will focus on how to prioritize Teams real-time communications traffic, namely voice and video.</span></span> <span data-ttu-id="815a0-115">Вы можете назначать приоритет и для других видов трафика в зависимости от ваших потребностей.</span><span class="sxs-lookup"><span data-stu-id="815a0-115">Other types of traffic can also be prioritized based on your needs.</span></span>

<span data-ttu-id="815a0-116">Приоритизировать трафик можно по-разному, но чаще всего применяются метки DSCP (Differentiated Services Code Point — точка кода дифференцированных услуг).</span><span class="sxs-lookup"><span data-stu-id="815a0-116">There are multiple ways to prioritize traffic, but the most common is by using differentiated services code point (DSCP) markings.</span></span> <span data-ttu-id="815a0-117">Они могут назначаться на основе диапазона портов, а также при помощи объектов групповой политики.</span><span class="sxs-lookup"><span data-stu-id="815a0-117">They can be applied based on port ranges but also via Group Policy objects.</span></span> <span data-ttu-id="815a0-118">Этот документ описывает оба способа.</span><span class="sxs-lookup"><span data-stu-id="815a0-118">We will cover both in this document.</span></span>

<span data-ttu-id="815a0-119">Управление метками DSCP через объекты групповой политики (GPO) гарантирует, что присоединенные к домену компьютеры получают корректные настройки и что этими настройками может управлять только администратор.</span><span class="sxs-lookup"><span data-stu-id="815a0-119">Controlling the DSCP marking via Group Policy objects (GPO) ensures that domain-joined computers receive the correct settings and that these settings can only be managed by an administrator.</span></span> 

<span data-ttu-id="815a0-120">Важно понимать, что механизм QoS работает, только когда он применяется для всех подключений, соединяющих вызывающего абонента с вызываемым.</span><span class="sxs-lookup"><span data-stu-id="815a0-120">It’s important to understand that QoS only works when implemented on all links connecting caller to callee.</span></span> <span data-ttu-id="815a0-121">Если мы используем QoS во внутренней сети, а пользователь подключается из удаленного расположения, то мы можем назначать приоритет только в нашей внутренней, управляемой сети.</span><span class="sxs-lookup"><span data-stu-id="815a0-121">If we use QoS on the internal network and a user signs in from a remote location, we can only prioritize within our internal, managed, network.</span></span> <span data-ttu-id="815a0-122">Хотя удаленные расположения могут получать управляемое подключение при помощи VPN, не рекомендуется направлять трафик систем связи в реальном времени через VPN.</span><span class="sxs-lookup"><span data-stu-id="815a0-122">While remote locations could receive a managed connection by implementing a VPN, it is not recommended to run real-time communications traffic over the VPN.</span></span>

> [!NOTE]
> <span data-ttu-id="815a0-123">Рекомендуем использовать раздельное туннелирование для удаленных пользователей, подключенных через VPN. В этом случае качество работы для них будет максимальным.</span><span class="sxs-lookup"><span data-stu-id="815a0-123">Our recommendation is to implement split tunneling for VPN connected remote users to maximize the user experience.</span></span> <span data-ttu-id="815a0-124">Дополнительные сведения см. в документе [Deploy-Guidance-VPN Split Tunnel](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 ) (Руководство по развертыванию VPN с раздельным туннелированием).</span><span class="sxs-lookup"><span data-stu-id="815a0-124">See the document [Deploy-Guidance-VPN Split Tunnel](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 ) for more information.</span></span>

<span data-ttu-id="815a0-125">В международных организациях, в которых управляемые подключения охватывают целые континенты, настоятельно рекомендуется использовать QoS, так как полоса пропускания этих подключений ограничена по сравнению с локальной сетью (LAN).</span><span class="sxs-lookup"><span data-stu-id="815a0-125">In a global organization with managed links spanning continents, QoS is highly recommended since the bandwidth is limited in comparisons to the local network (LAN).</span></span>

## <a name="quality-of-service"></a><span data-ttu-id="815a0-126">Качество обслуживания</span><span class="sxs-lookup"><span data-stu-id="815a0-126">Managing Quality of Service</span></span>

<span data-ttu-id="815a0-127">Для предоставления гарантированного уровня обслуживания приложению в сети эта сеть должна иметь способ классифицировать различные типы трафика.</span><span class="sxs-lookup"><span data-stu-id="815a0-127">In order to provide a guaranteed level of service for an application on the network, the underlying network devices must have a way to classify different types of traffic.</span></span> <span data-ttu-id="815a0-128">Если, например, необходимо обслуживать голосовой трафик особым образом, то маршрутизатор должен уметь отличать голосовой трафик от обычного трафика работы в Интернете.</span><span class="sxs-lookup"><span data-stu-id="815a0-128">A router, for example, must be able to distinguish between voice traffic and normal web browsing traffic, if there is an expectation that voice receives better treatment.</span></span> 

<span data-ttu-id="815a0-129">Дифференцированные службы (DiffServ) представляют собой платформу, в которой сетевые устройства обращаются с трафиком ранжировано в зависимости от поля "тип служб" (ToS) в заголовке пакета IPv4/IPv6.</span><span class="sxs-lookup"><span data-stu-id="815a0-129">Differentiated Services (DiffServ) provides a framework in which traffic is treated by network devices with priorities based on the type of services (ToS) field in the header of an IPv4/IPv6 packet.</span></span> <span data-ttu-id="815a0-130">Шесть наиболее важных битов в поле DiffServ называются DSCP (Differentiated Services Code Point — точка кода дифференцированных услуг).</span><span class="sxs-lookup"><span data-stu-id="815a0-130">The six most significant bits of the DiffServ field is known as the Differentiated Services Code Point, or DSCP.</span></span> <span data-ttu-id="815a0-131">Эта платформа позволяет классифицировать трафик как особый (голосовой) и присвоить ему метку (101110, или 46 в десятичном виде), чтобы сетевые устройства могли при обработке этих меток назначить трафику соответствующий приоритет (в нашем примере — беспрепятственная переадресация).</span><span class="sxs-lookup"><span data-stu-id="815a0-131">Using this framework, traffic can be classified as a particular type of traffic (voice), and then marked (101110, or 46 in decimal), such that when network devices process these markings, the traffic can be prioritized accordingly (Expedited Forwarding, in this example).</span></span>

<span data-ttu-id="815a0-132">При входе сетевого трафика на маршрутизатор трафик помещается в очередь. Если QoS не применяется, очередь, по сути, одна и данные обрабатываются в порядке поступления. В этом случае голосовой трафик (который очень чувствителен к задержкам) может "застрять" за трафиком служб потоковой трансляции в Интернете.</span><span class="sxs-lookup"><span data-stu-id="815a0-132">When network traffic enters a router, the traffic is placed into a queue – if there is no QoS in place, essentially there is only one queue, and data is treated as first-in, first-out. That means voice traffic (which is very sensitive to delays) could get stuck behind traffic from online streaming services.</span></span> <span data-ttu-id="815a0-133">При использовании QoS появляется возможность задать несколько очередей с различными механизмами для управления перегрузками (например, очереди с приоритетом (PQ) и взвешенная справедливая очередь на основе классов (CBWFQ) компании Cisco) и для предотвращения перегрузок (например, взвешенное произвольное раннее обнаружение (WRED)).</span><span class="sxs-lookup"><span data-stu-id="815a0-133">When implementing QoS, multiple queues can be defined, with different congestion management features (such as Cisco’s Priority Queuing (PQ) and Class Based Weighted Fair Queue (CBWFQ)) and congestion avoidance features (such as Weighted Random Early Detection (WRED)).</span></span>

![Схема очередей QoS в Teams.](media/Qos-in-Teams-Image2.png)

<span data-ttu-id="815a0-135">Рис. 1. Визуальное представлений очередей QoS</span><span class="sxs-lookup"><span data-stu-id="815a0-135">Figure 1: QoS queues visualized</span></span>

<span data-ttu-id="815a0-136">Построенная таким образом система позволяет обеспечить предсказуемое качество обслуживания, так как вся управляемая сеть теперь понимает, как нужно классифицировать, маркировать и приоритизировать трафик.</span><span class="sxs-lookup"><span data-stu-id="815a0-136">Once these pieces are in place, a predictable quality of service can be delivered, as the underlying managed network now understands how to classify, mark and prioritize traffic.</span></span> <span data-ttu-id="815a0-137">С точки зрения Teams самым важным элементом конфигурации является классификация и маркирование пакетов. Но чтобы эффективно реализовать сквозное QoS, также необходимо тщательно спланировать конфигурацию приложения в соответствии с конфигурацией сети.</span><span class="sxs-lookup"><span data-stu-id="815a0-137">From the Teams perspective, the most important configuration item is the classification and marking of packets – but careful planning is involved to align the application’s configuration with the underlying network configuration for end-to-end QoS to be successful.</span></span>

## <a name="qos-scenarios"></a><span data-ttu-id="815a0-138">Сценарии QoS</span><span class="sxs-lookup"><span data-stu-id="815a0-138">QoS scenarios</span></span>

<span data-ttu-id="815a0-139">В руководстве по реализации QoS для Teams мы опираемся на четыре начальных сценария.</span><span class="sxs-lookup"><span data-stu-id="815a0-139">When implementing QoS for Teams, we’ve based our guidance on four starting scenarios:</span></span>

1.  <span data-ttu-id="815a0-140">Вы развертываете или уже развернули Teams и планируете реализовать QoS с использованием маркировки трафика на основе номеров портов.</span><span class="sxs-lookup"><span data-stu-id="815a0-140">You’ve deployed or are deploying Teams and are planning on implementing QoS via Port Based Tagging.</span></span> <span data-ttu-id="815a0-141">Маркировка трафика по номерам портов является самым надежным методом в силу своей универсальности, независимости от платформы и простоты реализации.</span><span class="sxs-lookup"><span data-stu-id="815a0-141">Port Based Tagging is the most reliable method since it works universally throughout all platforms and is the easiest to implement.</span></span> 

2.  <span data-ttu-id="815a0-142">Вы развертываете или уже развернули Teams и планируете реализовать QoS с использованием маркировки трафика на основе объектов групповой политики.</span><span class="sxs-lookup"><span data-stu-id="815a0-142">You’ve deployed or are deploying Teams and are planning to implement QoS via Group Policy Object tagging.</span></span> <span data-ttu-id="815a0-143">Этот сценарий иногда применяется в сочетании со сценарием 1.</span><span class="sxs-lookup"><span data-stu-id="815a0-143">This is sometimes used in combination with scenario 1.</span></span> <span data-ttu-id="815a0-144">Хотя этот сценарий является полностью рабочим и описан ниже, важно понимать, что он применим только для клиентов Windows, присоединенных к домену.</span><span class="sxs-lookup"><span data-stu-id="815a0-144">While this scenario is entirely valid and described below, it is important to understand this will only work for Domain Joined Windows Clients.</span></span> <span data-ttu-id="815a0-145">Маркировка QoS/DSCP не затронет устройства с клиентами, не присоединенными к домену Windows.</span><span class="sxs-lookup"><span data-stu-id="815a0-145">Any device that is not a Windows Domain Joined Client will not be enabled for QoS\DSCP Tagging.</span></span> 

3.  <span data-ttu-id="815a0-146">У вас уже развернут Skype для бизнеса Online с настроенной маркировкой QoS, и сейчас вы развертываете Teams.</span><span class="sxs-lookup"><span data-stu-id="815a0-146">You have Skype for Business Online deployed including QoS Tagging and are now deploying Teams.</span></span> <span data-ttu-id="815a0-147">В этом случае Teams сохранит текущие настройки и будет использовать те же диапазоны портов и маркировку, что и клиент Skype для бизнеса.</span><span class="sxs-lookup"><span data-stu-id="815a0-147">If this is you, Teams will respect the existing configuration and will use the same port ranges and tagging as the Skype for Business client.</span></span> <span data-ttu-id="815a0-148">Никаких дополнительных настроек не требуется.</span><span class="sxs-lookup"><span data-stu-id="815a0-148">No additional configuration should be needed.</span></span> 
    > [!NOTE]
    > <span data-ttu-id="815a0-149">Если вы реализуете маркировку QoS на основе имени приложения через групповую политику, то необходимо добавить имя приложения "Teams.exe".</span><span class="sxs-lookup"><span data-stu-id="815a0-149">If you're using Application Name QoS tagging via Group Policy you should add “Teams.exe” as Application Name.</span></span>
4.  <span data-ttu-id="815a0-150">Вы развертываете или уже развернули Teams и планируете реализовать QoS с маркировкой на базе номеров портов заданного диапазона.</span><span class="sxs-lookup"><span data-stu-id="815a0-150">You’ve deployed or are deploying Teams and want to implement QoS via port-based tagging with a custom port range.</span></span>

## <a name="recommended-differentiated-services-code-point-dscp-markings"></a><span data-ttu-id="815a0-151">Рекомендуемые метки DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-151">Recommended differentiated services code point (DSCP) markings</span></span>

<span data-ttu-id="815a0-152">На первом этапе необходимо классифицировать потоки трафика (такие как аудио и видео), используя уникальные непересекающиеся диапазоны портов со значением DSCP.</span><span class="sxs-lookup"><span data-stu-id="815a0-152">The first step is to classify the traffic flows (such as audio and video) by leveraging the unique, non-overlapping port ranges with a DSCP-value.</span></span> <span data-ttu-id="815a0-153">Это значение DSCP будет задавать приоритет для проходящего по сети трафика (на основе конфигурации сети).</span><span class="sxs-lookup"><span data-stu-id="815a0-153">The DSCP value assigned here will determine the priority of the traffic going through the network (based on the network configuration).</span></span> <span data-ttu-id="815a0-154">Каждая рабочая нагрузка получает свое значение DSCP, хотя некоторые клиенты могут задать одно и то же значение для голоса и видео, предоставив им одинаковый приоритет в сети.</span><span class="sxs-lookup"><span data-stu-id="815a0-154">Each workload gets its own DSCP value, although some customers might set the same value on voice and video, giving them the same priority in the network.</span></span> 

<span data-ttu-id="815a0-155">Конкретное значение DSCP зависит от приоритета рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="815a0-155">What DSCP value to use depends on how a workload is prioritized.</span></span> <span data-ttu-id="815a0-156">Например, в соответствии с бизнес-требованиями общий доступ к приложениям может нуждаться в таком же уровне приоритета, что и видео (и, следовательно, отмечаться таким же значением DSCP, что и видео).</span><span class="sxs-lookup"><span data-stu-id="815a0-156">For example, business requirements could dictate that application sharing is to be treated with the same level of priority as video (and as such, marked with the same DSCP-value as video).</span></span> <span data-ttu-id="815a0-157">Другие среды уже могут иметь свою стратегию QoS.</span><span class="sxs-lookup"><span data-stu-id="815a0-157">Other environments might have an existing QoS strategy in place already.</span></span> 

<span data-ttu-id="815a0-158">В Таблице 1 ниже приведены необходимые метки DSCP при использовании Teams с ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="815a0-158">Table 1 below shows the required DSCP markings when utilizing Teams with ExpressRoute.</span></span> <span data-ttu-id="815a0-159">Клиенты, которые не уверены, какие настройки использовать в своей среде, могут начать с параметров в этой таблице.</span><span class="sxs-lookup"><span data-stu-id="815a0-159">This could serve as a good starting point for customers unsure what to use in their own environment.</span></span> <span data-ttu-id="815a0-160">Дополнительные сведения см. в статье [Требования к качеству обслуживания для ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-qos).</span><span class="sxs-lookup"><span data-stu-id="815a0-160">To learn more, read [ExpressRoute QoS requirements](https://docs.microsoft.com/azure/expressroute/expressroute-qos).</span></span>


| <span data-ttu-id="815a0-161">Порт источника на клиенте</span><span class="sxs-lookup"><span data-stu-id="815a0-161">Client source port</span></span>|<span data-ttu-id="815a0-162">Протокол</span><span class="sxs-lookup"><span data-stu-id="815a0-162">Protocol</span></span>|<span data-ttu-id="815a0-163">Категория медиаданных</span><span class="sxs-lookup"><span data-stu-id="815a0-163">Media category</span></span>|<span data-ttu-id="815a0-164">Стандартное значение DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-164">Common DSCP value</span></span>|<span data-ttu-id="815a0-165">Класс DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-165">DSCP class</span></span>|
|---------|---------|---------|---------|---------|
| <span data-ttu-id="815a0-166">50 000–50 019</span><span class="sxs-lookup"><span data-stu-id="815a0-166">50,000 – 50,019</span></span>|<span data-ttu-id="815a0-167">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-167">TCP/UDP</span></span>|<span data-ttu-id="815a0-168">Аудио</span><span class="sxs-lookup"><span data-stu-id="815a0-168">Audio</span></span>|<span data-ttu-id="815a0-169">46</span><span class="sxs-lookup"><span data-stu-id="815a0-169">46</span></span>|<span data-ttu-id="815a0-170">Беспрепятственная переадресация (EF)</span><span class="sxs-lookup"><span data-stu-id="815a0-170">Expedited Forwarding (EF)</span></span>|
| <span data-ttu-id="815a0-171">50 020–50 039</span><span class="sxs-lookup"><span data-stu-id="815a0-171">50,020 – 50,039</span></span>|<span data-ttu-id="815a0-172">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-172">TCP/UDP</span></span>|<span data-ttu-id="815a0-173">Видео</span><span class="sxs-lookup"><span data-stu-id="815a0-173">Video</span></span>|<span data-ttu-id="815a0-174">34</span><span class="sxs-lookup"><span data-stu-id="815a0-174">3-4</span></span>|<span data-ttu-id="815a0-175">Гарантированная переадресация (AF41)</span><span class="sxs-lookup"><span data-stu-id="815a0-175">Assured Forwarding (AF41)</span></span>|
| <span data-ttu-id="815a0-176">50 040–50 059</span><span class="sxs-lookup"><span data-stu-id="815a0-176">50,040 – 50,059</span></span>|<span data-ttu-id="815a0-177">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-177">TCP/UDP</span></span>|<span data-ttu-id="815a0-178">Общий доступ к приложениям и рабочему столу и передача файлов</span><span class="sxs-lookup"><span data-stu-id="815a0-178">Application/Desktop Sharing and File Transfer</span></span>|<span data-ttu-id="815a0-179">18</span><span class="sxs-lookup"><span data-stu-id="815a0-179">18</span></span>|<span data-ttu-id="815a0-180">Выбор класса (CS3)</span><span class="sxs-lookup"><span data-stu-id="815a0-180">Class Selector (CS3)</span></span>|

<span data-ttu-id="815a0-181">Таблица 1. Метки DSCP.</span><span class="sxs-lookup"><span data-stu-id="815a0-181">Table 1: DSCP markings</span></span>

<span data-ttu-id="815a0-182">Некоторые замечания по использованию данных из Таблицы 1.</span><span class="sxs-lookup"><span data-stu-id="815a0-182">Here are some caveats to understand when you use the information in Table 1:</span></span>

- <span data-ttu-id="815a0-183">Для общего доступа к файлам и к приложениям используется один и тот же диапазон портов источника, поэтому им назначаются одни и те же метки DSCP при маркировке на основе портов.</span><span class="sxs-lookup"><span data-stu-id="815a0-183">File sharing and application sharing use the same source port range – and as such, would use the same DSCP markings when using Port Based Tagging.</span></span> <span data-ttu-id="815a0-184">Следовательно, необходимо определить, какой приоритет больше всего подходит для *обеих* модальностей (интерактивный или по умолчанию).</span><span class="sxs-lookup"><span data-stu-id="815a0-184">Because of this, it should be determined which priority is most applicable to *both* modalities (Interactive or Default).</span></span>
    
- <span data-ttu-id="815a0-185">Если в будущем планируется использовать ExpressRoute, а QoS еще не реализовано, то рекомендуем следовать приведенным выше указаниям и сделать значения DSCP одинаковыми от отправителя до получателя.</span><span class="sxs-lookup"><span data-stu-id="815a0-185">If there’s a plan to implement ExpressRoute in the future and QoS has not yet been implemented, the recommendation is to follow the guidance given above so that DSCP values are the same from sender to receiver.</span></span> 
    
## <a name="source-ports-used-by-teams"></a><span data-ttu-id="815a0-186">Порты источника в Teams</span><span class="sxs-lookup"><span data-stu-id="815a0-186">Source ports used by Teams</span></span>

<span data-ttu-id="815a0-187">В Teams необходимо настраивать QoS на основе портов источника, используемых различными рабочими нагрузками.</span><span class="sxs-lookup"><span data-stu-id="815a0-187">In Teams, QoS should be configured based on the source ports used by the different workloads.</span></span> <span data-ttu-id="815a0-188">Диапазоны портов и на сервере, и на клиенте сейчас настроить не удастся.</span><span class="sxs-lookup"><span data-stu-id="815a0-188">Both server-side and client-side port ranges are non-configurable at this point.</span></span> 

<span data-ttu-id="815a0-189">Для развертывания QoS используйте диапазоны портов источника на клиенте, приведенные в Таблице 2, с соответствующими метками DSCP.</span><span class="sxs-lookup"><span data-stu-id="815a0-189">To deploy QoS, use the client source port ranges listed in Table 2, with their associated QoS DSCP markings.</span></span>

| <span data-ttu-id="815a0-190">Порт источника на клиенте</span><span class="sxs-lookup"><span data-stu-id="815a0-190">Client source port</span></span>|<span data-ttu-id="815a0-191">Протокол</span><span class="sxs-lookup"><span data-stu-id="815a0-191">Protocol</span></span>|<span data-ttu-id="815a0-192">Категория медиаданных</span><span class="sxs-lookup"><span data-stu-id="815a0-192">Media category</span></span>|<span data-ttu-id="815a0-193">Стандартное значение DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-193">Common DSCP value</span></span>|<span data-ttu-id="815a0-194">Класс DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-194">DSCP class</span></span>|
|---------|---------|---------|---------|---------|
| <span data-ttu-id="815a0-195">50 000–50 019</span><span class="sxs-lookup"><span data-stu-id="815a0-195">50,000 – 50,019</span></span>|<span data-ttu-id="815a0-196">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-196">TCP/UDP</span></span>|<span data-ttu-id="815a0-197">Аудио</span><span class="sxs-lookup"><span data-stu-id="815a0-197">Audio</span></span>|<span data-ttu-id="815a0-198">46</span><span class="sxs-lookup"><span data-stu-id="815a0-198">46</span></span>|<span data-ttu-id="815a0-199">Беспрепятственная переадресация (EF)</span><span class="sxs-lookup"><span data-stu-id="815a0-199">Expedited Forwarding (EF)</span></span>|
| <span data-ttu-id="815a0-200">50 020–50 039</span><span class="sxs-lookup"><span data-stu-id="815a0-200">50,020 – 50,039</span></span>|<span data-ttu-id="815a0-201">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-201">TCP/UDP</span></span>|<span data-ttu-id="815a0-202">Видео</span><span class="sxs-lookup"><span data-stu-id="815a0-202">Video</span></span>|<span data-ttu-id="815a0-203">34</span><span class="sxs-lookup"><span data-stu-id="815a0-203">3-4</span></span>|<span data-ttu-id="815a0-204">Гарантированная переадресация (AF41)</span><span class="sxs-lookup"><span data-stu-id="815a0-204">Assured Forwarding (AF41)</span></span>|
| <span data-ttu-id="815a0-205">50 040–50 059</span><span class="sxs-lookup"><span data-stu-id="815a0-205">50,040 – 50,059</span></span>|<span data-ttu-id="815a0-206">TCP/UDP</span><span class="sxs-lookup"><span data-stu-id="815a0-206">TCP/UDP</span></span>|<span data-ttu-id="815a0-207">Общий доступ к приложениям и рабочему столу и передача файлов</span><span class="sxs-lookup"><span data-stu-id="815a0-207">Application/Desktop Sharing and File Transfer</span></span>|<span data-ttu-id="815a0-208">18</span><span class="sxs-lookup"><span data-stu-id="815a0-208">18</span></span>|<span data-ttu-id="815a0-209">Выбор класса (CS3)</span><span class="sxs-lookup"><span data-stu-id="815a0-209">Class Selector (CS3)</span></span>|

<span data-ttu-id="815a0-210">Таблица 2. Диапазоны портов источника на клиенте</span><span class="sxs-lookup"><span data-stu-id="815a0-210">Table 2: Client source port ranges</span></span>

> [!NOTE]
> <span data-ttu-id="815a0-211">Если вы уже настроили QoS для Skype для бизнеса Online на основе диапазонов портов источника, то эта же конфигурация будет действовать и для Teams без каких-либо дополнительных изменений.</span><span class="sxs-lookup"><span data-stu-id="815a0-211">If you've already configured QoS based on source port ranges for Skype for Business Online, the same configuration will apply to Teams and no further changes are required.</span></span> <span data-ttu-id="815a0-212">Если у вас развернута система Skype для бизнеса Server (локальный), то нужно будет изменить политики QoS.</span><span class="sxs-lookup"><span data-stu-id="815a0-212">If you’ve deployed Skype for Business Server (on premises), you will need to redesign your QoS Policies.</span></span>

## <a name="setting-differentiated-services-code-point-dscp-markings"></a><span data-ttu-id="815a0-213">Установка меток DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-213">Setting differentiated services code point (DSCP) markings</span></span>

<span data-ttu-id="815a0-214">Существуют различные подходы к установке меток DSCP для классификации трафика.</span><span class="sxs-lookup"><span data-stu-id="815a0-214">There are multiple approaches to setting the proper DSCP markings for traffic classification.</span></span>

- <span data-ttu-id="815a0-215">Установка меток DSCP на конечной точке. Предпочтительный вариант в большинстве случаев, так как конечная точка сама устанавливает подходящие метки.</span><span class="sxs-lookup"><span data-stu-id="815a0-215">DSCP marking at the endpoint: This is the preferred option in general, as the endpoint itself is providing the proper markings.</span></span> <span data-ttu-id="815a0-216">В настоящее время это можно сделать с помощью объектов групповой политики, но они доступны только для клиентов Windows, присоединенных к домену.</span><span class="sxs-lookup"><span data-stu-id="815a0-216">Currently this could be done by using a GPO, but this is only possible on domain-joined Windows clients.</span></span> <span data-ttu-id="815a0-217">Клиенты Mac OSX или, например, мобильные клиенты не имеют механизма маркирования трафика значениями DSCP.</span><span class="sxs-lookup"><span data-stu-id="815a0-217">Mac OSX or mobile clients, for example, do not provide a mechanism to mark traffic with DSCP values.</span></span>

- <span data-ttu-id="815a0-218">Маркировка на основе портов со списками управления доступом (ACL) на маршрутизаторах. Этот вариант часто используется в гетерогенных средах Windows и Mac.</span><span class="sxs-lookup"><span data-stu-id="815a0-218">Port-based using ACLs on routers: This is a very common option encountered in heterogeneous environments of Windows and Mac.</span></span> <span data-ttu-id="815a0-219">В этом сценарии специалисты по сетям маркируют трафик на маршрутизаторах на входе или выходе (обычно в глобальной сети (WAN)), основываясь на диапазонах портов источника, заданных для каждой модальности.</span><span class="sxs-lookup"><span data-stu-id="815a0-219">In this scenario, the network team marks the traffic at the ingress/egress routers (typically on the Wide Area Network (WAN)) based on the source port ranges defined for each modality.</span></span> <span data-ttu-id="815a0-220">Так как эта схема охватывает различные платформы, она устанавливает метки только по периметру WAN, а не на всем пути до клиентского компьютера, а также увеличивает издержки на управление.</span><span class="sxs-lookup"><span data-stu-id="815a0-220">While this works across platforms, it only marks at the WAN edge – not all the way to the client machine – and incurs management overhead.</span></span>
    
- <span data-ttu-id="815a0-221">Сочетание маркировки DSCP на клиенте и ACL на основе портов на маршрутизаторах.</span><span class="sxs-lookup"><span data-stu-id="815a0-221">A combination of DSCP markings on the client and port-based ACLs on routers.</span></span>
    
<span data-ttu-id="815a0-222">Рекомендуем, если возможно, использовать сочетание двух подходов: применяйте объекты групповой политики для большинства клиентов и используйте маркировку DSCP на основе портов для (частичной) реализации QoS на мобильных, Mac- и других клиентах.</span><span class="sxs-lookup"><span data-stu-id="815a0-222">If possible, we recommend a combination of both, to use a GPO to catch the majority of clients, and to also use port based DSCP tagging to ensure mobile clients, Mac and other clients will still get a (partial) QoS treatment.</span></span>

<span data-ttu-id="815a0-223">Значения DSCP для заранее определенного диапазона портов источника в клиенте Teams можно установить при помощи политик для QoS в рамках групповой политики.</span><span class="sxs-lookup"><span data-stu-id="815a0-223">Setting the DSCP value for the pre-defined source port range in the Teams client can be done using policy-based QoS within Group Policy.</span></span> <span data-ttu-id="815a0-224">В следующей таблице показаны диапазоны портов для создания политики для каждой рабочей нагрузки.</span><span class="sxs-lookup"><span data-stu-id="815a0-224">The following table uses the port ranges specified in the table to create a policy for each workload.</span></span>

| <span data-ttu-id="815a0-225">Тип трафика клиента</span><span class="sxs-lookup"><span data-stu-id="815a0-225">Client traffic type</span></span>|<span data-ttu-id="815a0-226">Начало диапазона портов</span><span class="sxs-lookup"><span data-stu-id="815a0-226">Port range start</span></span>|<span data-ttu-id="815a0-227">Конец диапазона портов</span><span class="sxs-lookup"><span data-stu-id="815a0-227">Port range end</span></span>|<span data-ttu-id="815a0-228">DSCP Value</span><span class="sxs-lookup"><span data-stu-id="815a0-228">DSCP value</span></span>|
|---------|---------|---------|--------|
| <span data-ttu-id="815a0-229">Аудио</span><span class="sxs-lookup"><span data-stu-id="815a0-229">Audio</span></span>|<span data-ttu-id="815a0-230">50000</span><span class="sxs-lookup"><span data-stu-id="815a0-230">50000</span></span>|<span data-ttu-id="815a0-231">50019</span><span class="sxs-lookup"><span data-stu-id="815a0-231">50019</span></span>|<span data-ttu-id="815a0-232">46</span><span class="sxs-lookup"><span data-stu-id="815a0-232">46</span></span>|
| <span data-ttu-id="815a0-233">Видео</span><span class="sxs-lookup"><span data-stu-id="815a0-233">Video</span></span>|<span data-ttu-id="815a0-234">50020</span><span class="sxs-lookup"><span data-stu-id="815a0-234">50020</span></span>|<span data-ttu-id="815a0-235">50039</span><span class="sxs-lookup"><span data-stu-id="815a0-235">50039</span></span>|<span data-ttu-id="815a0-236">34</span><span class="sxs-lookup"><span data-stu-id="815a0-236">3-4</span></span>|
| <span data-ttu-id="815a0-237">Общий доступ к приложениям</span><span class="sxs-lookup"><span data-stu-id="815a0-237">Application sharing</span></span>|<span data-ttu-id="815a0-238">50040</span><span class="sxs-lookup"><span data-stu-id="815a0-238">50040</span></span>|<span data-ttu-id="815a0-239">50059</span><span class="sxs-lookup"><span data-stu-id="815a0-239">50059</span></span>|<span data-ttu-id="815a0-240">18</span><span class="sxs-lookup"><span data-stu-id="815a0-240">18</span></span>|
| <span data-ttu-id="815a0-241">Передача файлов</span><span class="sxs-lookup"><span data-stu-id="815a0-241">File transfer</span></span>|<span data-ttu-id="815a0-242">50040</span><span class="sxs-lookup"><span data-stu-id="815a0-242">50040</span></span>|<span data-ttu-id="815a0-243">50059</span><span class="sxs-lookup"><span data-stu-id="815a0-243">50059</span></span>|<span data-ttu-id="815a0-244">18</span><span class="sxs-lookup"><span data-stu-id="815a0-244">18</span></span>|

<span data-ttu-id="815a0-245">Таблица 3. Диапазоны портов по типам трафика</span><span class="sxs-lookup"><span data-stu-id="815a0-245">Table 3: Port ranges by traffic type</span></span>

<span data-ttu-id="815a0-246">Примечание. Вы не можете изменять диапазоны портов, установленные Teams.</span><span class="sxs-lookup"><span data-stu-id="815a0-246">Note: The port ranges set by Teams cannot be changed or altered.</span></span> <span data-ttu-id="815a0-247">Последние сведения см. на странице https://support.microsoft.com/kb/2409256</span><span class="sxs-lookup"><span data-stu-id="815a0-247">Please review this page for the latest information: https://support.microsoft.com/ kb/2409256</span></span>

<span data-ttu-id="815a0-248">После определения диапазонов портов следующий этап — настроить политики для QoS в объекте групповой политики (GPO).</span><span class="sxs-lookup"><span data-stu-id="815a0-248">Once the port ranges have been determined, the next step is to configure the policy-based QoS settings within a Group Policy Object (GPO).</span></span> <span data-ttu-id="815a0-249">Сведения об этой операции см. в [TechNet](https://technet.microsoft.com/library/jj205371(v=ocs.15).aspx).</span><span class="sxs-lookup"><span data-stu-id="815a0-249">Details for these steps can be found on [TechNet](https://technet.microsoft.com/library/jj205371(v=ocs.15).aspx).</span></span> 

<span data-ttu-id="815a0-250">Созданные политики не вступят в силу, пока не обновлена групповая политика на клиентских компьютерах.</span><span class="sxs-lookup"><span data-stu-id="815a0-250">The new policies you have created won’t take effect until Group Policy has been refreshed on your client computers.</span></span> <span data-ttu-id="815a0-251">Хотя групповая политика периодически обновляется сама, вы можете обновить ее принудительно, запустив на каждом нужном компьютере следующую команду.</span><span class="sxs-lookup"><span data-stu-id="815a0-251">Although Group Policy periodically refreshes on its own, you can force an immediate refresh by running the following command on each computer where Group Policy needs to be refreshed:</span></span>

        gpudate.exe /force

<span data-ttu-id="815a0-252">Команду можно выполнить в любом командном окне, запущенном от имени администратора.</span><span class="sxs-lookup"><span data-stu-id="815a0-252">This command can be run from any command window that is running under administrator credentials.</span></span> <span data-ttu-id="815a0-253">Чтобы открыть такое окно с правами администратора, в меню **Пуск** правой кнопкой мыши щелкните **Командная строка** и выберите пункт **Запуск от имени администратора**.</span><span class="sxs-lookup"><span data-stu-id="815a0-253">To open a command window, click **Start**, right-click **Command Prompt**, and then click **Run as administrator**.</span></span>

## <a name="verifying-the-dscp-markings-in-gpo"></a><span data-ttu-id="815a0-254">Проверка меток DSCP в объекте групповой политики</span><span class="sxs-lookup"><span data-stu-id="815a0-254">Verifying the DSCP markings in GPO</span></span>

<span data-ttu-id="815a0-255">Чтобы проверить заданные значения из объекта групповой политики (GPO), сделайте следующее.</span><span class="sxs-lookup"><span data-stu-id="815a0-255">To verify that the values from the GPO has been set, please perform the following steps:</span></span>

1.  <span data-ttu-id="815a0-256">При помощи команды gpresult проверьте, что настройки из GPO были получены локальным компьютером.</span><span class="sxs-lookup"><span data-stu-id="815a0-256">Use gpresult to verify that the settings from the GPO has been received by the local PC.</span></span> <span data-ttu-id="815a0-257">Команда "gpresult /R >gp.txt" сформирует отчет и поместит его в текстовый файл gp.txt.</span><span class="sxs-lookup"><span data-stu-id="815a0-257">gpresult /R >gp.txt will generate a report and send it to a text file, gp.txt.</span></span>

    ![Снимок экрана с командным окном администратора и запуском команды gpresult.](media/Qos-in-Teams-Image3.png)

    <span data-ttu-id="815a0-259">Рис. 2. Проверка примененных объектов групповой политики</span><span class="sxs-lookup"><span data-stu-id="815a0-259">Figure 2: Verify Applied Group Policy Objects</span></span>
    > [!NOTE]
    > <span data-ttu-id="815a0-260">Вы также можете выполнить команду "gpresult /H gp.html" которая выдаст те же данные в более удобном формате HTML.</span><span class="sxs-lookup"><span data-stu-id="815a0-260">Alternatively, you can run gpresult /H gp.html to produce the same data in more user-friendly HTML report.</span></span> 
2.  <span data-ttu-id="815a0-261">В сформированном файле найдите заголовок "Примененные объекты групповой политики" и проверьте, есть ли в списке примененных политик имена созданных ранее объектов.</span><span class="sxs-lookup"><span data-stu-id="815a0-261">In the generated file look for the heading: Applied Group Policy Objects and verify that the names of the GPO’s created earlier is in the list of applied policies.</span></span> 

3.  <span data-ttu-id="815a0-262">Откройте редактор реестра и перейдите к разделу:</span><span class="sxs-lookup"><span data-stu-id="815a0-262">Open the registry editor and navigate to:</span></span>

    <span data-ttu-id="815a0-263">HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\\</span><span class="sxs-lookup"><span data-stu-id="815a0-263">HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\\</span></span>

    <span data-ttu-id="815a0-264">Проверьте значения реестра, перечисленные в Таблице 3 ниже.</span><span class="sxs-lookup"><span data-stu-id="815a0-264">Verify the registry values listed in Table 3 below.</span></span>
    
    | <span data-ttu-id="815a0-265">Имя</span><span class="sxs-lookup"><span data-stu-id="815a0-265">Name</span></span> | <span data-ttu-id="815a0-266">Тип</span><span class="sxs-lookup"><span data-stu-id="815a0-266">Type</span></span> | <span data-ttu-id="815a0-267">Значение</span><span class="sxs-lookup"><span data-stu-id="815a0-267">Data</span></span>|
    |---------|---------|---------
    | <span data-ttu-id="815a0-268">Application Name</span><span class="sxs-lookup"><span data-stu-id="815a0-268">Application Name</span></span>|<span data-ttu-id="815a0-269">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-269">REG_SZ</span></span>|<span data-ttu-id="815a0-270">Teams.exe</span><span class="sxs-lookup"><span data-stu-id="815a0-270">Teams.exe</span></span>|
    | <span data-ttu-id="815a0-271">DSCP Value</span><span class="sxs-lookup"><span data-stu-id="815a0-271">DSCP Value</span></span>|<span data-ttu-id="815a0-272">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-272">REG_SZ</span></span>|<span data-ttu-id="815a0-273">46</span><span class="sxs-lookup"><span data-stu-id="815a0-273">46</span></span>|
    | <span data-ttu-id="815a0-274">Local IP</span><span class="sxs-lookup"><span data-stu-id="815a0-274">Second Reflexive Local IP</span></span>|<span data-ttu-id="815a0-275">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-275">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-276">Local IP Prefix Length</span><span class="sxs-lookup"><span data-stu-id="815a0-276">Local IP Prefix Length</span></span>|<span data-ttu-id="815a0-277">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-277">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-278">Local Port</span><span class="sxs-lookup"><span data-stu-id="815a0-278">Local Port</span></span>|<span data-ttu-id="815a0-279">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-279">REG_SZ</span></span>|<span data-ttu-id="815a0-280">50000-50019</span><span class="sxs-lookup"><span data-stu-id="815a0-280">50000-50019</span></span>|
    | <span data-ttu-id="815a0-281">Протокол</span><span class="sxs-lookup"><span data-stu-id="815a0-281">Protocol</span></span>|<span data-ttu-id="815a0-282">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-282">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-283">Remote IP</span><span class="sxs-lookup"><span data-stu-id="815a0-283">Remote IP</span></span>|<span data-ttu-id="815a0-284">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-284">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-285">Remote Ip Prefix</span><span class="sxs-lookup"><span data-stu-id="815a0-285">Remote Ip Prefix</span></span>|<span data-ttu-id="815a0-286">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-286">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-287">Remote Port</span><span class="sxs-lookup"><span data-stu-id="815a0-287">Remote Port</span></span>|<span data-ttu-id="815a0-288">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-288">REG_SZ</span></span>|*|
    | <span data-ttu-id="815a0-289">Throttle Rate</span><span class="sxs-lookup"><span data-stu-id="815a0-289">Throttle Rate</span></span>|<span data-ttu-id="815a0-290">REG_SZ</span><span class="sxs-lookup"><span data-stu-id="815a0-290">REG_SZ</span></span>|<span data-ttu-id="815a0-291">-1</span><span class="sxs-lookup"><span data-stu-id="815a0-291">$1</span></span>|
    
    <span data-ttu-id="815a0-292">Таблица 3. Значения реестра Windows для QoS</span><span class="sxs-lookup"><span data-stu-id="815a0-292">Table 3: Windows registry values for QoS</span></span>

4.  <span data-ttu-id="815a0-293">Проверьте, что значение параметра "Application Name" (Имя приложения) соответствует используемому вами клиенту и что параметры "DSCP value" (Значение DSCP) и "Local Port" (Локальный порт) соответствуют настройкам объекта групповой политики.</span><span class="sxs-lookup"><span data-stu-id="815a0-293">Verify that the Application Name is correct for the client you are using, and verify that both DSCP value and Local Port reflect the settings in the GPO.</span></span>

## <a name="validating-qos-analyzing-teams-traffic-on-the-network"></a><span data-ttu-id="815a0-294">Проверка QoS: анализ трафика Teams в сети</span><span class="sxs-lookup"><span data-stu-id="815a0-294">Validating QoS: Analyzing Teams traffic on the network</span></span>

<span data-ttu-id="815a0-295">Для эффективной работы QoS значение DSCP, заданное в GPO, должно присутствовать на всем пути от вызывающего абонента до вызываемого.</span><span class="sxs-lookup"><span data-stu-id="815a0-295">The DSCP value set by the GPO needs to be present from caller to callee in order for QoS to be affective.</span></span> <span data-ttu-id="815a0-296">Просматривая трафик, создаваемый клиентом Teams, мы можем проверить, что DSCP не изменяется и не удаляется при прохождении по сети.</span><span class="sxs-lookup"><span data-stu-id="815a0-296">By looking at the traffic generated by the Teams client we can verify that the DSCP is not changed or stripped out when traversing the network.</span></span> 

<span data-ttu-id="815a0-297">Предпочтительным вариантом будет перехват трафика в точке входа в сеть.</span><span class="sxs-lookup"><span data-stu-id="815a0-297">Preferably we would capture traffic at the network egress point.</span></span> <span data-ttu-id="815a0-298">Для перехвата трафика можно использовать зеркалирование портов на коммутаторе или маршрутизаторе.</span><span class="sxs-lookup"><span data-stu-id="815a0-298">Port mirroring can be used on a switch or router to aid in capturing traffic on the network.</span></span> 

### <a name="looking-at-network-traffic-using-network-monitor"></a><span data-ttu-id="815a0-299">Просмотр сетевого трафика при помощи Network Monitor</span><span class="sxs-lookup"><span data-stu-id="815a0-299">Looking at network traffic using Network Monitor</span></span>

<span data-ttu-id="815a0-300">Network Monitor (сетевой монитор) — это инструмент, доступный для скачивания с сайта Майкрософт и предназначенный для анализа сетевого трафика.</span><span class="sxs-lookup"><span data-stu-id="815a0-300">Network Monitor is a tool you can download from Microsoft to analyze network traffic.</span></span> <span data-ttu-id="815a0-301">Загрузить [Network Monitor 3.4](https://www.microsoft.com/download/4865).</span><span class="sxs-lookup"><span data-stu-id="815a0-301">Download [Network Monitor 3.4](https://www.microsoft.com/download/4865).</span></span>

<span data-ttu-id="815a0-302">Подключите компьютер с запущенным сетевым монитором к порту, настроенному на зеркалирование, и запустите сбор пакетов.</span><span class="sxs-lookup"><span data-stu-id="815a0-302">Connect to PC running network monitor to the port that has been configured for port mirroring and start capturing packets.</span></span> <span data-ttu-id="815a0-303">Сделайте звонок при помощи клиента Skype для бизнеса.</span><span class="sxs-lookup"><span data-stu-id="815a0-303">Make a call using the Skype for Business client.</span></span> <span data-ttu-id="815a0-304">Убедитесь, что связь установлена, и завершите вызов.</span><span class="sxs-lookup"><span data-stu-id="815a0-304">Make sure media is established before hanging up the call.</span></span> <span data-ttu-id="815a0-305">Остановите сбор пакетов и установите фильтр отображения, задав в качестве критериев поиска IP-адрес компьютера, с которого был сделан звонок, и значение DSCP 46 (шестн. 0xb8):</span><span class="sxs-lookup"><span data-stu-id="815a0-305">Stop the capture create a Display Filter that matches the source IP of the PC that made the call and refine the filter by defining DSCP value 46 (hex 0xb8) as search criteria:</span></span>

<span data-ttu-id="815a0-306">Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8</span><span class="sxs-lookup"><span data-stu-id="815a0-306">Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8</span></span> 

![Снимок экрана с диалоговым окном программы Network Monitor, где показаны применяемые фильтры отображения.](media/Qos-in-Teams-Image4.png)


<span data-ttu-id="815a0-308">Нажмите кнопку **Apply** (Применить), чтобы активировать фильтр.</span><span class="sxs-lookup"><span data-stu-id="815a0-308">Click **Apply** to activate the filter.</span></span> <span data-ttu-id="815a0-309">В окне **Frame Summary** (Сводка по кадру) выберите первый UDP-пакет и просмотрите сведения о кадре.</span><span class="sxs-lookup"><span data-stu-id="815a0-309">In the **Frame Summary** window, select the first UDP packet and look at the Frame Details:</span></span>

![Снимок экрана с диалоговым окном Frame Details (Сведения о кадре) в программе Network Monitor с выделенными параметрами DSCP.](media/Qos-in-Teams-Image5.png)

<span data-ttu-id="815a0-311">Разверните раздел IPv4 и проверьте значение в конце строки DSCP.</span><span class="sxs-lookup"><span data-stu-id="815a0-311">Expand IPv4 and look at the value at the end of the DSCP line.</span></span> <span data-ttu-id="815a0-312">В этом примере мы видим, что значение DSCP равно 46. Это корректная настройка, так как используемый порт источника — 50019, что означает, что рабочей нагрузкой является голосовая связь.</span><span class="sxs-lookup"><span data-stu-id="815a0-312">In this example we see that the DSCP value is set to 46 which is correct since the source port used is 50019 which tells us that the workload is voice.</span></span> 

<span data-ttu-id="815a0-313">Повторите проверку для каждой рабочей нагрузки, которая маркируется при помощи GPO.</span><span class="sxs-lookup"><span data-stu-id="815a0-313">Repeat the verification for each workload that has been marked by the GPO.</span></span> 

> [!NOTE]
> <span data-ttu-id="815a0-314">Проверьте, что метки устанавливаются также и для трафика одноранговых соединений.</span><span class="sxs-lookup"><span data-stu-id="815a0-314">Verify that markings are honored for peer-to-peer traffic as well.</span></span> <span data-ttu-id="815a0-315">Это можно сделать, установив Network Monitor на двух клиентах и совершая звонки между ними.</span><span class="sxs-lookup"><span data-stu-id="815a0-315">This can be done by installing Network Monitor on two clients and placing calls between the two clients.</span></span> <span data-ttu-id="815a0-316">Проверьте описанным выше способом трафик мультимедиа, проходящий от одного клиента к другому.</span><span class="sxs-lookup"><span data-stu-id="815a0-316">Look at the media traffic flowing between clients in the same manner as described above.</span></span>

### <a name="sample-filters-to-use-for-network-monitor-or-wireshark"></a><span data-ttu-id="815a0-317">Примеры фильтров для программ Network Monitor или Wireshark</span><span class="sxs-lookup"><span data-stu-id="815a0-317">Sample filters to use for Network Monitor or Wireshark</span></span>

|<span data-ttu-id="815a0-318">Режим</span><span class="sxs-lookup"><span data-stu-id="815a0-318">Usage</span></span>  |<span data-ttu-id="815a0-319">Пример фильтра</span><span class="sxs-lookup"><span data-stu-id="815a0-319">Sample filter</span></span>  |
|---------|---------|
|<span data-ttu-id="815a0-320">Голосовая связь (примечание. Мультиплексирование должно быть отключено)</span><span class="sxs-lookup"><span data-stu-id="815a0-320">Voice (note: muxing must be turned off)</span></span>     |   <span data-ttu-id="815a0-321">udp.port==3479 AND Ipv4.DifferentiatedServicesField.DSCP==46</span><span class="sxs-lookup"><span data-stu-id="815a0-321">udp.port==3479 AND Ipv4.DifferentiatedServicesField.DSCP==46</span></span>      |
|<span data-ttu-id="815a0-322">Видео</span><span class="sxs-lookup"><span data-stu-id="815a0-322">Video</span></span>     | <span data-ttu-id="815a0-323">udp.port==3480 AND Ipv4.DifferentiatedServicesField.DSCP==34</span><span class="sxs-lookup"><span data-stu-id="815a0-323">udp.port==3480 AND Ipv4.DifferentiatedServicesField.DSCP==34</span></span>        |
|<span data-ttu-id="815a0-324">Демонстрация экрана</span><span class="sxs-lookup"><span data-stu-id="815a0-324">Screen sharing</span></span>     |  <span data-ttu-id="815a0-325">udp.port==3481 AND Ipv4.DifferentiatedServicesField.DSCP==18</span><span class="sxs-lookup"><span data-stu-id="815a0-325">udp.port==3481 AND Ipv4.DifferentiatedServicesField.DSCP==18</span></span>       |

### <a name="filter-media-traffic-from-microsoft-relays-requires-azure-expressroutehttpsazuremicrosoftcomservicesexpressroute"></a><span data-ttu-id="815a0-326">Фильтр: трафик мультимедиа с ретрансляторов Майкрософт (требуется [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/))</span><span class="sxs-lookup"><span data-stu-id="815a0-326">Filter: Media traffic from Microsoft relays (requires [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/))</span></span>

<span data-ttu-id="815a0-327">ip.src in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.srcport in {3479 3480 3481} or (udp.srcport ge 50000 and udp.srcport lt 60000))</span><span class="sxs-lookup"><span data-stu-id="815a0-327">ip.src in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.srcport in {3479 3480 3481} or (udp.srcport ge 50000 and udp.srcport lt 60000))</span></span>

### <a name="filter-media-traffic-to-microsoft-relays"></a><span data-ttu-id="815a0-328">Фильтр: трафик мультимедиа к ретрансляторам Майкрософт</span><span class="sxs-lookup"><span data-stu-id="815a0-328">Filter: Media traffic to Microsoft relays</span></span>

<span data-ttu-id="815a0-329">ip.dst in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.dstport in {3479 3480 3481} or (udp.dstport ge 50000 and udp.dstport lt 60000))</span><span class="sxs-lookup"><span data-stu-id="815a0-329">ip.dst in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.dstport in {3479 3480 3481} or (udp.dstport ge 50000 and udp.dstport lt 60000))</span></span>


<span data-ttu-id="815a0-330">Отобразится входящий и исходящий трафик ретрансляторов Майкрософт.</span><span class="sxs-lookup"><span data-stu-id="815a0-330">You should see traffic to and from the Microsoft relays.</span></span> <span data-ttu-id="815a0-331">Вы можете проверить метки DSCP на уровне IP в Wireshark, как показано в следующем разделе.</span><span class="sxs-lookup"><span data-stu-id="815a0-331">You can check DSCP markings on the IP layer in Wireshark, as shown in the next section.</span></span>

### <a name="expected-dscp-markings"></a><span data-ttu-id="815a0-332">Ожидаемые метки DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-332">Expected DSCP markings</span></span>

<span data-ttu-id="815a0-333">Аудиопотоки: 46</span><span class="sxs-lookup"><span data-stu-id="815a0-333">Audio streams: 46</span></span>

<span data-ttu-id="815a0-334">Видеопотоки: 34</span><span class="sxs-lookup"><span data-stu-id="815a0-334">Video streams: 34</span></span>

<span data-ttu-id="815a0-335">Потоки данных: 18</span><span class="sxs-lookup"><span data-stu-id="815a0-335">Data streams: 18</span></span>

### <a name="filter-dscp-condition-to-network"></a><span data-ttu-id="815a0-336">Фильтр: отбор по значениям DSCP</span><span class="sxs-lookup"><span data-stu-id="815a0-336">Filter: DSCP condition to network</span></span>

<span data-ttu-id="815a0-337">ip.dsfield.dscp in {46 34 18}</span><span class="sxs-lookup"><span data-stu-id="815a0-337">ip.dsfield.dscp in {46 34 18}</span></span>



### <a name="looking-at-network-traffic-using-wireshark"></a><span data-ttu-id="815a0-338">Просмотр сетевого трафика при помощи Wireshark</span><span class="sxs-lookup"><span data-stu-id="815a0-338">Looking at network traffic using Wireshark</span></span>

<span data-ttu-id="815a0-339">Wireshark (https://www.wireshark.org/) — это мощный инструмент, позволяющий фильтровать и записывать сетевые данные для анализа.</span><span class="sxs-lookup"><span data-stu-id="815a0-339">Wireshark, https://www.wireshark.org/, is a powerful tool that allows us to filter and record network data for further analysis.</span></span> <span data-ttu-id="815a0-340">Подключите компьютер с запущенным Wireshark к порту, настроенному на зеркалирование, и запустите сбор пакетов.</span><span class="sxs-lookup"><span data-stu-id="815a0-340">Connect a PC running Wireshark to the port that has been configured for port mirroring and start capturing packets.</span></span> <span data-ttu-id="815a0-341">Сделайте звонок при помощи клиента Teams.</span><span class="sxs-lookup"><span data-stu-id="815a0-341">Make a call using the Teams client.</span></span> <span data-ttu-id="815a0-342">Убедитесь, что связь установлена, и завершите вызов.</span><span class="sxs-lookup"><span data-stu-id="815a0-342">Make sure media is established before hanging up the call.</span></span>

<span data-ttu-id="815a0-343">Остановите трассировку пакетов и примените фильтр, задав в качестве IP-адреса источника адрес компьютера, где установлен клиент Teams (например, *ip.src_host == 192.168.137.201*), и назначив отображение пакетов, использующих порт источника из диапазона для голосовой связи (50 000–50 019).</span><span class="sxs-lookup"><span data-stu-id="815a0-343">Stop the packet trace and create a filter that only displays the source IP of the PC where the Teams client is installed, for example, *ip.src_host == 192.168.137.201* and looks for packages that use a source port from the range specified for voice, 50,000 – 50,019:</span></span>

![Снимок экрана Wireshark с настройками фильтра.](media/Qos-in-Teams-Image6.png)
 

<span data-ttu-id="815a0-345">Выделите пакет и разверните раздел Internet Protocol Version 4 (IPV4) на панели сведений о пакете.</span><span class="sxs-lookup"><span data-stu-id="815a0-345">Mark the package and expand the Internet Protocol Version 4 (IPV4) header in the packet detail pane:</span></span>

![Снимок экрана Wireshark с выделенными параметрами DSCP](media/Qos-in-Teams-Image7.png)
 

<span data-ttu-id="815a0-347">Проверьте, что значение параметра *Differentiated Services Codepoint* совпадает со значением для соответствующей рабочей нагрузки. В нашем случае это 46 (двоичн. 101110) для голосовой связи.</span><span class="sxs-lookup"><span data-stu-id="815a0-347">Verify that the value for *Differentiated Services Codepoint* match the value for the specific workload, in this case 46 (binary 101110) for voice.</span></span>

<span data-ttu-id="815a0-348">Повторите проверку для каждой рабочей нагрузки, которая маркируется при помощи GPO.</span><span class="sxs-lookup"><span data-stu-id="815a0-348">Repeat the verification for each workload that has been marked by the GPO.</span></span>

> [!NOTE]
> <span data-ttu-id="815a0-349">Проверьте использование меток для трафика одноранговых соединений.</span><span class="sxs-lookup"><span data-stu-id="815a0-349">Verify that markings are honored for peer-to-peer traffic.</span></span> <span data-ttu-id="815a0-350">Это можно сделать, установив WireShark или Network Monitor на двух клиентах и совершая звонки между ними.</span><span class="sxs-lookup"><span data-stu-id="815a0-350">This can be done by installing WireShark or Network Monitor on two clients and placing calls between the two clients.</span></span> <span data-ttu-id="815a0-351">Проверьте описанным выше способом трафик мультимедиа, проходящий от одного клиента к другому.</span><span class="sxs-lookup"><span data-stu-id="815a0-351">Look at the media traffic flowing between clients in the same manner as described above.</span></span>

## <a name="summary"></a><span data-ttu-id="815a0-352">Заключение</span><span class="sxs-lookup"><span data-stu-id="815a0-352">Summary</span></span>

<span data-ttu-id="815a0-353">Качество обслуживания (QoS) является важной частью картины при предоставлении услуг бизнес-класса с помощью Teams.</span><span class="sxs-lookup"><span data-stu-id="815a0-353">Quality of Service is an important piece of the puzzle when providing business-class experiences with Teams.</span></span> <span data-ttu-id="815a0-354">Но важно понимать, что QoS эффективно только в корректно управляемых сетях.</span><span class="sxs-lookup"><span data-stu-id="815a0-354">However, it is important to always remember that QoS is only effective on properly managed networks.</span></span> <span data-ttu-id="815a0-355">Поэтому команда специалистов по развертыванию должна работать в тесном сотрудничестве со специалистами по сетям и обеспечить корректную передачу информации на уровне сети, в идеале — контролируемую на всем протяжении канала передачи.</span><span class="sxs-lookup"><span data-stu-id="815a0-355">As such, the deployment team must work very closely with the networking teams to ensure the proper information is passed at the network layer, ideally managed from end-to-end.</span></span>

