---
title: "Качество обслуживания (QoS) в Microsoft Teams"
author: rmw2890
ms.author: MyAdvisor
manager: Serdars
ms.date: 02/16/2018
ms.topic: article
ms.service: msteams
description: "Подготовка сети организации к работе с качеством обслуживания (QoS) в Microsoft Teams."
MS.collection: Strat_MT_TeamsAdmin
ms.openlocfilehash: 61bebd64c7d1478c16e114631b696dee2bf59625
ms.sourcegitcommit: 85105cb4e42ae8eb6e7e76eaf6d4dd5b9568cf41
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/19/2018
---
<a name="quality-of-service-qos-in-microsoft-teams"></a>Качество обслуживания (QoS) в Microsoft Teams
==========================================
Это руководство поможет подготовить сеть вашей организации к работе с качеством обслуживания (QoS) в Microsoft Teams.


Качество обслуживания (QoS) — это механизм, который позволяет приоритизировать определенные типы сетевого трафика. Назначение приоритетов для трафика служб связи в режиме реального времени, таких как Teams, является необходимым условием для предоставления пользователям услуг бизнес-класса. Чтобы QoS было действительно эффективным, подключения с поддержкой QoS должны быть настроены на всем пути от начального узла к конечному (компьютер, затем сетевые коммутаторы, маршрутизаторы и облако), так как если хотя бы один элемент на этом пути не поддерживает QoS, это снизит качество всего соединения.


![Схема отношений между сетями организации и службами Office 365.](media/Qos-in-Teams-Image1.png)

 

В большинстве случаев промежуточная сеть будет неуправляемой сетью, интернет-подключением. Одним из возможных вариантов обеспечения сквозного QoS является использование [ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/). Тем не менее мы все же рекомендуем реализовать QoS на контролируемых вами участках сети, а именно в вашей локальной сети. Это улучшит выполнение рабочих нагрузок связи в реальном времени и поможет уменьшить количество узких мест в развернутой у вас среде. 

## <a name="objectives"></a>Цели 

Это руководство посвящено тому, как приоритизировать трафик Teams для связи в режиме реального времени, а именно для голосового и видеотрафика. Вы можете назначать приоритет и для других видов трафика в зависимости от ваших потребностей.

Приоритизировать трафик можно по-разному, но чаще всего применяются метки DSCP (Differentiated Services Code Point — точка кода дифференцированных услуг). Они могут назначаться на основе диапазона портов, а также при помощи объектов групповой политики. Этот документ описывает оба способа.

Управление метками DSCP через объекты групповой политики (GPO) гарантирует, что присоединенные к домену компьютеры получают корректные настройки и что этими настройками может управлять только администратор. 

Важно понимать, что механизм QoS работает, только когда он применяется для всех подключений, соединяющих вызывающего абонента с вызываемым. Если мы используем QoS во внутренней сети, а пользователь подключается из удаленного расположения, то мы можем назначать приоритет только в нашей внутренней, управляемой сети. Хотя удаленные расположения могут получать управляемое подключение при помощи VPN, не рекомендуется направлять трафик систем связи в реальном времени через VPN.

> [!NOTE]
> Рекомендуем использовать раздельное туннелирование для удаленных пользователей, подключенных через VPN. В этом случае качество работы для них будет максимальным. Дополнительные сведения см. в документе [Deploy-Guidance-VPN Split Tunnel](https://myadvisor.fasttrack.microsoft.com/CloudVoice/Downloads?SelectedIDs=5_1_0_9 ) (Руководство по развертыванию VPN с раздельным туннелированием).

В международных организациях, в которых управляемые подключения охватывают целые континенты, настоятельно рекомендуется использовать QoS, так как полоса пропускания этих подключений ограничена по сравнению с локальной сетью (LAN).

## <a name="quality-of-service"></a>Качество обслуживания

Для предоставления гарантированного уровня обслуживания приложению в сети эта сеть должна иметь способ классифицировать различные типы трафика. Если, например, необходимо обслуживать голосовой трафик особым образом, то маршрутизатор должен уметь отличать голосовой трафик от обычного трафика работы в Интернете. 

Дифференцированные службы (DiffServ) представляют собой платформу, в которой сетевые устройства обращаются с трафиком ранжировано в зависимости от поля "тип служб" (ToS) в заголовке пакета IPv4/IPv6. Шесть наиболее важных битов в поле DiffServ называются DSCP (Differentiated Services Code Point — точка кода дифференцированных услуг). Эта платформа позволяет классифицировать трафик как особый (голосовой) и присвоить ему метку (101110, или 46 в десятичном виде), чтобы сетевые устройства могли при обработке этих меток назначить трафику соответствующий приоритет (в нашем примере — беспрепятственная переадресация).

При входе сетевого трафика на маршрутизатор трафик помещается в очередь. Если QoS не применяется, очередь, по сути, одна и данные обрабатываются в порядке поступления. В этом случае голосовой трафик (который очень чувствителен к задержкам) может "застрять" за трафиком служб потоковой трансляции в Интернете. При использовании QoS появляется возможность задать несколько очередей с различными механизмами для управления перегрузками (например, очереди с приоритетом (PQ) и взвешенная справедливая очередь на основе классов (CBWFQ) компании Cisco) и для предотвращения перегрузок (например, взвешенное произвольное раннее обнаружение (WRED)).

![Схема очередей QoS в Teams.](media/Qos-in-Teams-Image2.png)

Рис. 1. Визуальное представлений очередей QoS

Построенная таким образом система позволяет обеспечить предсказуемое качество обслуживания, так как вся управляемая сеть теперь понимает, как нужно классифицировать, маркировать и приоритизировать трафик. С точки зрения Teams самым важным элементом конфигурации является классификация и маркирование пакетов. Но чтобы эффективно реализовать сквозное QoS, также необходимо тщательно спланировать конфигурацию приложения в соответствии с конфигурацией сети.

## <a name="qos-scenarios"></a>Сценарии QoS

В руководстве по реализации QoS для Teams мы опираемся на четыре начальных сценария.

1.  Вы развертываете или уже развернули Teams и планируете реализовать QoS с использованием маркировки трафика на основе номеров портов. Маркировка трафика по номерам портов является самым надежным методом в силу своей универсальности, независимости от платформы и простоты реализации. 

2.  Вы развертываете или уже развернули Teams и планируете реализовать QoS с использованием маркировки трафика на основе объектов групповой политики. Этот сценарий иногда применяется в сочетании со сценарием 1. Хотя этот сценарий является полностью рабочим и описан ниже, важно понимать, что он применим только для клиентов Windows, присоединенных к домену. Маркировка QoS/DSCP не затронет устройства с клиентами, не присоединенными к домену Windows. 

3.  У вас уже развернут Skype для бизнеса Online с настроенной маркировкой QoS, и сейчас вы развертываете Teams. В этом случае Teams сохранит текущие настройки и будет использовать те же диапазоны портов и маркировку, что и клиент Skype для бизнеса. Никаких дополнительных настроек не требуется. 
    > [!NOTE]
    > Если вы реализуете маркировку QoS на основе имени приложения через групповую политику, то необходимо добавить имя приложения "Teams.exe".
4.  Вы развертываете или уже развернули Teams и планируете реализовать QoS с маркировкой на базе номеров портов заданного диапазона.

## <a name="recommended-differentiated-services-code-point-dscp-markings"></a>Рекомендуемые метки DSCP

На первом этапе необходимо классифицировать потоки трафика (такие как аудио и видео), используя уникальные непересекающиеся диапазоны портов со значением DSCP. Это значение DSCP будет задавать приоритет для проходящего по сети трафика (на основе конфигурации сети). Каждая рабочая нагрузка получает свое значение DSCP, хотя некоторые клиенты могут задать одно и то же значение для голоса и видео, предоставив им одинаковый приоритет в сети. 

Конкретное значение DSCP зависит от приоритета рабочей нагрузки. Например, в соответствии с бизнес-требованиями общий доступ к приложениям может нуждаться в таком же уровне приоритета, что и видео (и, следовательно, отмечаться таким же значением DSCP, что и видео). Другие среды уже могут иметь свою стратегию QoS. 

В Таблице 1 ниже приведены необходимые метки DSCP при использовании Teams с ExpressRoute. Клиенты, которые не уверены, какие настройки использовать в своей среде, могут начать с параметров в этой таблице. Дополнительные сведения см. в статье [Требования к качеству обслуживания для ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-qos).


| Порт источника на клиенте|Протокол|Категория медиаданных|Стандартное значение DSCP|Класс DSCP|
|---------|---------|---------|---------|---------|
| 50 000–50 019|TCP/UDP|Аудио|46|Беспрепятственная переадресация (EF)|
| 50 020–50 039|TCP/UDP|Видео|34|Гарантированная переадресация (AF41)|
| 50 040–50 059|TCP/UDP|Общий доступ к приложениям и рабочему столу и передача файлов|18|Выбор класса (CS3)|

Таблица 1. Метки DSCP.

Некоторые замечания по использованию данных из Таблицы 1.

- Для общего доступа к файлам и к приложениям используется один и тот же диапазон портов источника, поэтому им назначаются одни и те же метки DSCP при маркировке на основе портов. Следовательно, необходимо определить, какой приоритет больше всего подходит для *обеих* модальностей (интерактивный или по умолчанию).
    
- Если в будущем планируется использовать ExpressRoute, а QoS еще не реализовано, то рекомендуем следовать приведенным выше указаниям и сделать значения DSCP одинаковыми от отправителя до получателя. 
    
## <a name="source-ports-used-by-teams"></a>Порты источника в Teams

В Teams необходимо настраивать QoS на основе портов источника, используемых различными рабочими нагрузками. Диапазоны портов и на сервере, и на клиенте сейчас настроить не удастся. 

Для развертывания QoS используйте диапазоны портов источника на клиенте, приведенные в Таблице 2, с соответствующими метками DSCP.

| Порт источника на клиенте|Протокол|Категория медиаданных|Стандартное значение DSCP|Класс DSCP|
|---------|---------|---------|---------|---------|
| 50 000–50 019|TCP/UDP|Аудио|46|Беспрепятственная переадресация (EF)|
| 50 020–50 039|TCP/UDP|Видео|34|Гарантированная переадресация (AF41)|
| 50 040–50 059|TCP/UDP|Общий доступ к приложениям и рабочему столу и передача файлов|18|Выбор класса (CS3)|

Таблица 2. Диапазоны портов источника на клиенте

> [!NOTE]
> Если вы уже настроили QoS для Skype для бизнеса Online на основе диапазонов портов источника, то эта же конфигурация будет действовать и для Teams без каких-либо дополнительных изменений. Если у вас развернута система Skype для бизнеса Server (локальный), то нужно будет изменить политики QoS.

## <a name="setting-differentiated-services-code-point-dscp-markings"></a>Установка меток DSCP

Существуют различные подходы к установке меток DSCP для классификации трафика.

- Установка меток DSCP на конечной точке. Предпочтительный вариант в большинстве случаев, так как конечная точка сама устанавливает подходящие метки. В настоящее время это можно сделать с помощью объектов групповой политики, но они доступны только для клиентов Windows, присоединенных к домену. Клиенты Mac OSX или, например, мобильные клиенты не имеют механизма маркирования трафика значениями DSCP.

- Маркировка на основе портов со списками управления доступом (ACL) на маршрутизаторах. Этот вариант часто используется в гетерогенных средах Windows и Mac. В этом сценарии специалисты по сетям маркируют трафик на маршрутизаторах на входе или выходе (обычно в глобальной сети (WAN)), основываясь на диапазонах портов источника, заданных для каждой модальности. Так как эта схема охватывает различные платформы, она устанавливает метки только по периметру WAN, а не на всем пути до клиентского компьютера, а также увеличивает издержки на управление.
    
- Сочетание маркировки DSCP на клиенте и ACL на основе портов на маршрутизаторах.
    
Рекомендуем, если возможно, использовать сочетание двух подходов: применяйте объекты групповой политики для большинства клиентов и используйте маркировку DSCP на основе портов для (частичной) реализации QoS на мобильных, Mac- и других клиентах.

Значения DSCP для заранее определенного диапазона портов источника в клиенте Teams можно установить при помощи политик для QoS в рамках групповой политики. В следующей таблице показаны диапазоны портов для создания политики для каждой рабочей нагрузки.

| Тип трафика клиента|Начало диапазона портов|Конец диапазона портов|DSCP Value|
|---------|---------|---------|--------|
| Аудио|50000|50019|46|
| Видео|50020|50039|34|
| Общий доступ к приложениям|50040|50059|18|
| Передача файлов|50040|50059|18|

Таблица 3. Диапазоны портов по типам трафика

Примечание. Вы не можете изменять диапазоны портов, установленные Teams. Последние сведения см. на странице https://support.microsoft.com/kb/2409256

После определения диапазонов портов следующий этап — настроить политики для QoS в объекте групповой политики (GPO). Сведения об этой операции см. в [TechNet](https://technet.microsoft.com/library/jj205371(v=ocs.15).aspx). 

Созданные политики не вступят в силу, пока не обновлена групповая политика на клиентских компьютерах. Хотя групповая политика периодически обновляется сама, вы можете обновить ее принудительно, запустив на каждом нужном компьютере следующую команду.

        gpudate.exe /force

Команду можно выполнить в любом командном окне, запущенном от имени администратора. Чтобы открыть такое окно с правами администратора, в меню **Пуск** правой кнопкой мыши щелкните **Командная строка** и выберите пункт **Запуск от имени администратора**.

## <a name="verifying-the-dscp-markings-in-gpo"></a>Проверка меток DSCP в объекте групповой политики

Чтобы проверить заданные значения из объекта групповой политики (GPO), сделайте следующее.

1.  При помощи команды gpresult проверьте, что настройки из GPO были получены локальным компьютером. Команда "gpresult /R >gp.txt" сформирует отчет и поместит его в текстовый файл gp.txt.

    ![Снимок экрана с командным окном администратора и запуском команды gpresult.](media/Qos-in-Teams-Image3.png)

    Рис. 2. Проверка примененных объектов групповой политики
    > [!NOTE]
    > Вы также можете выполнить команду "gpresult /H gp.html" которая выдаст те же данные в более удобном формате HTML. 
2.  В сформированном файле найдите заголовок "Примененные объекты групповой политики" и проверьте, есть ли в списке примененных политик имена созданных ранее объектов. 

3.  Откройте редактор реестра и перейдите к разделу:

    HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\QoS\

    Проверьте значения реестра, перечисленные в Таблице 3 ниже.
    
    | Имя | Тип | Значение|
    |---------|---------|---------
    | Application Name|REG_SZ|Teams.exe|
    | DSCP Value|REG_SZ|46|
    | Local IP|REG_SZ|*|
    | Local IP Prefix Length|REG_SZ|*|
    | Local Port|REG_SZ|50000-50019|
    | Протокол|REG_SZ|*|
    | Remote IP|REG_SZ|*|
    | Remote Ip Prefix|REG_SZ|*|
    | Remote Port|REG_SZ|*|
    | Throttle Rate|REG_SZ|-1|
    
    Таблица 3. Значения реестра Windows для QoS

4.  Проверьте, что значение параметра "Application Name" (Имя приложения) соответствует используемому вами клиенту и что параметры "DSCP value" (Значение DSCP) и "Local Port" (Локальный порт) соответствуют настройкам объекта групповой политики.

## <a name="validating-qos-analyzing-teams-traffic-on-the-network"></a>Проверка QoS: анализ трафика Teams в сети

Для эффективной работы QoS значение DSCP, заданное в GPO, должно присутствовать на всем пути от вызывающего абонента до вызываемого. Просматривая трафик, создаваемый клиентом Teams, мы можем проверить, что DSCP не изменяется и не удаляется при прохождении по сети. 

Предпочтительным вариантом будет перехват трафика в точке входа в сеть. Для перехвата трафика можно использовать зеркалирование портов на коммутаторе или маршрутизаторе. 

### <a name="looking-at-network-traffic-using-network-monitor"></a>Просмотр сетевого трафика при помощи Network Monitor

Network Monitor (сетевой монитор) — это инструмент, доступный для скачивания с сайта Майкрософт и предназначенный для анализа сетевого трафика. Загрузить [Network Monitor 3.4](https://www.microsoft.com/download/4865).

Подключите компьютер с запущенным сетевым монитором к порту, настроенному на зеркалирование, и запустите сбор пакетов. Сделайте звонок при помощи клиента Skype для бизнеса. Убедитесь, что связь установлена, и завершите вызов. Остановите сбор пакетов и установите фильтр отображения, задав в качестве критериев поиска IP-адрес компьютера, с которого был сделан звонок, и значение DSCP 46 (шестн. 0xb8):

Source == "192.168.137.201" AND IPv4.DifferentiatedServicesField == 0xb8 

![Снимок экрана с диалоговым окном программы Network Monitor, где показаны применяемые фильтры отображения.](media/Qos-in-Teams-Image4.png)


Нажмите кнопку **Apply** (Применить), чтобы активировать фильтр. В окне **Frame Summary** (Сводка по кадру) выберите первый UDP-пакет и просмотрите сведения о кадре.

![Снимок экрана с диалоговым окном Frame Details (Сведения о кадре) в программе Network Monitor с выделенными параметрами DSCP.](media/Qos-in-Teams-Image5.png)

Разверните раздел IPv4 и проверьте значение в конце строки DSCP. В этом примере мы видим, что значение DSCP равно 46. Это корректная настройка, так как используемый порт источника — 50019, что означает, что рабочей нагрузкой является голосовая связь. 

Повторите проверку для каждой рабочей нагрузки, которая маркируется при помощи GPO. 

> [!NOTE]
> Проверьте, что метки устанавливаются также и для трафика одноранговых соединений. Это можно сделать, установив Network Monitor на двух клиентах и совершая звонки между ними. Проверьте описанным выше способом трафик мультимедиа, проходящий от одного клиента к другому.

### <a name="sample-filters-to-use-for-network-monitor-or-wireshark"></a>Примеры фильтров для программ Network Monitor или Wireshark

|Режим  |Пример фильтра  |
|---------|---------|
|Голосовая связь (примечание. Мультиплексирование должно быть отключено)     |   udp.port==3479 AND Ipv4.DifferentiatedServicesField.DSCP==46      |
|Видео     | udp.port==3480 AND Ipv4.DifferentiatedServicesField.DSCP==34        |
|Демонстрация экрана     |  udp.port==3481 AND Ipv4.DifferentiatedServicesField.DSCP==18       |

### <a name="filter-media-traffic-from-microsoft-relays-requires-azure-expressroutehttpsazuremicrosoftcomservicesexpressroute"></a>Фильтр: трафик мультимедиа с ретрансляторов Майкрософт (требуется [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/))

ip.src in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.srcport in {3479 3480 3481} or (udp.srcport ge 50000 and udp.srcport lt 60000))

### <a name="filter-media-traffic-to-microsoft-relays"></a>Фильтр: трафик мультимедиа к ретрансляторам Майкрософт

ip.dst in {52.114.188.0/22 52.114.220.0/22 52.114.124.0/22 52.114.60.0/22} and (udp.dstport in {3479 3480 3481} or (udp.dstport ge 50000 and udp.dstport lt 60000))


Отобразится входящий и исходящий трафик ретрансляторов Майкрософт. Вы можете проверить метки DSCP на уровне IP в Wireshark, как показано в следующем разделе.

### <a name="expected-dscp-markings"></a>Ожидаемые метки DSCP

Аудиопотоки: 46

Видеопотоки: 34

Потоки данных: 18

### <a name="filter-dscp-condition-to-network"></a>Фильтр: отбор по значениям DSCP

ip.dsfield.dscp in {46 34 18}



### <a name="looking-at-network-traffic-using-wireshark"></a>Просмотр сетевого трафика при помощи Wireshark

Wireshark (https://www.wireshark.org/) — это мощный инструмент, позволяющий фильтровать и записывать сетевые данные для анализа. Подключите компьютер с запущенным Wireshark к порту, настроенному на зеркалирование, и запустите сбор пакетов. Сделайте звонок при помощи клиента Teams. Убедитесь, что связь установлена, и завершите вызов.

Остановите трассировку пакетов и примените фильтр, задав в качестве IP-адреса источника адрес компьютера, где установлен клиент Teams (например, *ip.src_host == 192.168.137.201*), и назначив отображение пакетов, использующих порт источника из диапазона для голосовой связи (50 000–50 019).

![Снимок экрана Wireshark с настройками фильтра.](media/Qos-in-Teams-Image6.png)
 

Выделите пакет и разверните раздел Internet Protocol Version 4 (IPV4) на панели сведений о пакете.

![Снимок экрана Wireshark с выделенными параметрами DSCP](media/Qos-in-Teams-Image7.png)
 

Проверьте, что значение параметра *Differentiated Services Codepoint* совпадает со значением для соответствующей рабочей нагрузки. В нашем случае это 46 (двоичн. 101110) для голосовой связи.

Повторите проверку для каждой рабочей нагрузки, которая маркируется при помощи GPO.

> [!NOTE]
> Проверьте использование меток для трафика одноранговых соединений. Это можно сделать, установив WireShark или Network Monitor на двух клиентах и совершая звонки между ними. Проверьте описанным выше способом трафик мультимедиа, проходящий от одного клиента к другому.

## <a name="summary"></a>Заключение

Качество обслуживания (QoS) является важной частью картины при предоставлении услуг бизнес-класса с помощью Teams. Но важно понимать, что QoS эффективно только в корректно управляемых сетях. Поэтому команда специалистов по развертыванию должна работать в тесном сотрудничестве со специалистами по сетям и обеспечить корректную передачу информации на уровне сети, в идеале — контролируемую на всем протяжении канала передачи.

