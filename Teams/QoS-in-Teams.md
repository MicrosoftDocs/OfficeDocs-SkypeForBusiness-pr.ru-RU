---
title: Качество обслуживания в Microsoft Teams
author: SerdarSoysal
ms.author: serdars
manager: Serdars
ms.topic: article
ms.service: msteams
ms.reviewer: vkorlep, siunies
audience: admin
description: Узнайте, как подготовить сеть организации к качеству обслуживания (QoS) в Microsoft Teams.
localization_priority: Normal
search.appverid: MET150
f1.keywords:
- CSH
ms.custom:
- ms.teamsadmincenter.meetingsettings.qos
- ms.teamsadmincenter.meetingsettings.network.qosmarkers
- seo-marvel-apr2020
ms.collection:
- M365-collaboration
appliesto:
- Microsoft Teams
ms.openlocfilehash: 87f3577d34df6d2b0665a45b60b441d29cd0265b
ms.sourcegitcommit: 01087be29daa3abce7d3b03a55ba5ef8db4ca161
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/23/2021
ms.locfileid: "51092617"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>Реализация качества обслуживания (QoS) в Microsoft Teams

Качество обслуживания (QoS) в Microsoft Teams позволяет использовать сетевой трафик в режиме реального времени, который чувствителен к задержкам в сети (например, голосовых и видеопотоков), чтобы "обрезать" трафик, который менее чувствителен к конфиденциальной информации (например, загрузка нового приложения, где дополнительная секунда для скачивания не так велика). QoS использует объекты групповой политики Windows и списки управления доступом на основе портов для определения и пометки всех пакетов в потоках реального времени. Это позволяет вашей сети передавать потоки голосовой связи, видео и экранной передачи через выделенную часть пропускной способности сети.

Если вы поддерживаете большую группу пользователей, у которых возникают какие-либо проблемы, описанные в этой статье, возможно, потребуется внедрить QoS. Небольшие компании с небольшим количеством пользователей могут не нуждаться в QoS, но даже в этом они могут оказаться полезными.

Без QoS в голосовой и видеосвязи могут возникнуть следующие проблемы с качеством:

- Дрожание — пакеты мультимедиа, поступающие по разным тарифам, что может привести к отсутствуютм слов или слогов в звонках
- Потеря пакетов — пакеты сброшены, что также может привести к снижению качества голосовой связи и сложному для понимания речи.
- Время кругового пути (RTT) — пакеты мультимедиа долго добираются до своих пунктов назначения, что приводит к заметным задержкам между двумя участниками беседы и заставляет собеседников общаться друг с другом

Наименее сложный способ решения этих проблем — увеличить размер подключений к данным как для внутренних подключений, так и для подключения к Интернету. Поскольку это часто является затратным запретительным, QoS обеспечивает более эффективное управление ресурсами, а не добавляет полосу пропускания. Для устранения проблем с качеством рекомендуется сначала использовать QoS, а затем добавить полосу пропускания только при необходимости.

Чтобы QoS было эффективным, необходимо применить согласованные параметры QoS во всей организации. Любая часть пути, которая не поддерживает приоритеты QoS, может привести к ухудшению качества звонков, видео и общего доступа к экрану. Это включает применение параметров на всех компьютерах и устройствах пользователей, сетевых переключателях, маршрутизаторах к Интернету и службе Teams.

_Рисунок 1. Связь между сетями организации и службами Microsoft 365 или Office 365_

![Изображение отношения между сетями и службами](media/Qos-in-Teams-Image1.png "Связь между сетями организации и службами Microsoft 365 или Office 365: локальной сетью и устройствами подключаются к межсоединяемой сети, которая, в свою очередь, подключается к службам Microsoft 365 или Office 365 Cloud Voice и Аудиоконференцию.")

## <a name="qos-implementation-checklist"></a>Контрольный список внедрения QoS

Чтобы внедрить QoS, в качестве высокого уровня сделайте следующее:

1. [Убедитесь, что сеть готова.](#make-sure-your-network-is-ready)

1. [Выберите метод внедрения QoS.](#select-a-qos-implementation-method)

1. [Выберите диапазоны исходных портов для каждого типа мультимедиа.](#choose-initial-port-ranges-for-each-media-type)

1. Реализация параметров QoS:
   1. На клиентах, использующих объект групповой политики (GPO), чтобы настроить диапазоны портов и [метки клиентских устройств.](QoS-in-Teams-clients.md)
   2. На маршрутизаторах (см. документацию производителя) или других сетевых устройствах. К ним относятся списки управления доступом на основе порта или просто определение очередей QoS и маркировки DSCP или всех этих.

      > [!IMPORTANT]
      > Мы рекомендуем реализовать эти политики QoS, используя клиентские исходные порты и IP-адрес источника и назначения any. Это позволит ловить как входящий, так и исходяющий трафик мультимедиа во внутренней сети.  

   3. [Настройка обработки трафика мультимедиа для собраний Teams.](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)

5. [Проверьте реализацию QoS,](#validate-your-qos-implementation) проанализировав трафик Teams в сети.

При подготовке к внедрению QoS необходимо следующую рекомендации:

- Самый короткий путь к Microsoft 365 — лучший.
- Закрытие портов приведет только к снижению качества.
- Любые проблемы между ними, например прокси-прокси, не рекомендуется.
- Ограничение числа прыжков:
  - От клиента к границе сети — от 3 до 5 переходов
  - IsP to Microsoft network edge - 3 hops
  - Граница сети Майкрософт до конечного пункта назначения — нерелевантно

Сведения о настройке портов брандмауэра можно найти на URL-адресах [и диапазонах IP-адресов Office 365.](office-365-urls-ip-address-ranges.md)

## <a name="make-sure-your-network-is-ready"></a>Убедитесь, что сеть готова

Если вы рассматриваете реализацию QoS, необходимо определить требования к пропускной способности и другие требования [к сети.](prepare-network.md)
  
Перегрузка сети трафиком существенно влияет на качество мультимедиа. Отсутствие пропускной способности приводит к снижению производительности и низкому производительности пользователей. По мере роста принятия и [](use-call-analytics-to-troubleshoot-poor-call-quality.md)использования Teams используйте отчеты, аналитические данные о звонках для каждого пользователя и панель мониторинга качества звонка [(CQD),](turning-on-and-using-call-quality-dashboard.md) чтобы выявить проблемы, а затем внести корректировки с использованием QoS и выборочного добавления пропускной способности.

### <a name="vpn-considerations"></a>Вопросы использования VPN

QoS работает так, как ожидалось, только если он внедрен во все связи между вызывателями. Если вы используете QoS во внутренней сети и пользователь в службу в службе из удаленного расположения, приоритет можно установить только внутри внутренней управляемой сети. Хотя удаленные расположения могут получать управляемое подключение путем реализации виртуальной частной сети (VPN), VPN по существу увеличивает накладные пакеты и увеличивает трафик в режиме реального времени. Не рекомендуется запускать трафик связи в режиме реального времени через VPN.

В глобальной организации с управляемыми связями, охватывающими континенты, мы настоятельно рекомендуем использовать QoS, так как пропускная способность для этих связей ограничена в сравнении с локальной сетью.

## <a name="introduction-to-qos-queues"></a>Введение в очереди QoS

Для обеспечения QoS сетевые устройства должны иметь возможность классифицировать трафик и иметь возможность отличать голосовую или видеосвязь от другого сетевого трафика.

При входе сетевого трафика на маршрутизатор он помещается в очередь. Если политика QoS не настроена, существует только одна очередь и все данные обрабатываются как первые и те же с одинаковым приоритетом. Это означает, что голосовой трафик (который очень чувствителен к задержкам) может зависнуть за трафиком, если задержка в несколько миллисекунд не будет проблемой.

При внедрении QoS вы определяете несколько очередей с помощью одного из нескольких функций управления перегрузкой, таких как очередь приоритетов Cisco и взвешенные очереди на основе класса [(CBWFQ)](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641) и функции предотвращения перегрузки, такие как взвешенные случайные ранние обнаружения [(WRED).](https://en.wikipedia.org/wiki/Weighted_random_early_detection)

_Рисунок 2. Примеры очередей QoS_

![Изображение очередей QoS и деления пропускной способности](media/Qos-in-Teams-Image2.png "Общая доступная пропускная способность распределяется между несколькими очередями (аудио, видео и другим трафиком), для которых назначены разные приоритеты.")

Простая аналогия — это то, что QoS создает виртуальные «дорожки автомобиля» в сети данных, поэтому некоторые типы данных никогда или редко встречаются с задержкой. После создания таких дорожек вы можете настроить их относительный размер и гораздо эффективнее управлять своей пропускной способностью подключения, не из-за того что предоставляет пользователям организации возможности бизнес-класса.

## <a name="select-a-qos-implementation-method"></a>Выбор метода внедрения QoS

QoS можно реализовать с помощью тегов на основе портов, используя списки управления Доступом (ALS) на маршрутизаторах сети. Теги на основе портов — наиболее надежный способ, так как он работает в смешанной среде Windows, Mac и Linux и проще всего внедрить. Мобильные клиенты не предоставляют механизм для пометки трафика с помощью значений DSCP, поэтому для них требуется этот способ.  

Используя теги на основе портов, маршрутизатор сети проверяет входящий пакет. Если пакет поступил с использованием определенного порта или диапазона портов, он определяет его как определенный тип мультимедиа и помещает его в очередь этого типа, добавляя в заметив DSCP-пакет предопределенный знак [DSCP,](https://tools.ietf.org/html/rfc2474) чтобы другие устройства могли распознавать его тип трафика и присваивать ему приоритет в очереди.

Хотя раскладка тегов на основе портов работает на разных платформах, она только отмечает трафик на границе WAN (не в пути к клиентском компьютеру) и создает накладные расходы на управление. Инструкции по внедрению этого метода можно найти в документации, предоставленной изготовителем маршрутизатора.

### <a name="insert-dscp-markers"></a>Вставка маркеров DSCP

Вы также можете внедрить QoS, используя объект групповой политики (GPO), чтобы направить клиентские устройства на вставку маркера DSCP в headers IP-пакетов, определяющий его как определенный тип трафика (например, голосовая связь). Маршрутизаторы и другие сетевые устройства можно настроить таким образом, чтобы они распознали этот трафик и помещали трафик в отдельную очередь с более высоким приоритетом.

Хотя этот сценарий вполне допустим, он будет работать только для клиентов Windows, которые присоединились к домену. Для устройств, которые не присоединились к домену клиента Windows, теги DSCP не включены. Другие клиенты, например, работающие под управлением macOS, имеют жестко задатую кодю теги и всегда будут помечать трафик.

С одной стороны, контроль маркировки DSCP с помощью GPO гарантирует, что все компьютеры, которые присоединились к домену, получат одинаковые параметры и что только администратор может управлять ими. Клиенты, которые могут использовать GPO, помечаются на устройстве, и настроенные сетевые устройства распознают поток в режиме реального времени по коду DSCP и придают ему соответствующий приоритет.

### <a name="best-practice"></a>Методика

По возможности рекомендуется использовать разметку DSCP на конечной точке и на базе портов на маршрутизаторах. Использование GPO для обращения к большинству клиентов и использование тегов DSCP на основе портов гарантирует, что мобильные, Mac и другие клиенты будут по-прежнему получать обработку QoS (по крайней мере частично).

Маркировки DSCP можно пометить как почтовые марки, которые показывают, насколько срочным является доставка и как лучше отсортировать их для быстрой доставки. После настройки сети для передачи потоков мультимедиа в режиме реального времени потеря пакетов и пакетов с опозданием может значительно ухухалить их.

После того как все устройства в сети используют одинаковые классификации, метки и приоритеты, можно уменьшить или устранить задержки, затеряющиеся пакеты и дрожание, изменив размер диапазонов портов, которые назначены очередям, используемым для каждого типа трафика. С точки зрения Teams самым важным этапом настройки является классификация и пометка пакетов. Однако для успешного qoS необходимо также тщательно выровнять конфигурацию приложения с конфигурацией сети. После полного внедрения QoS постоянное управление заключается в корректировке диапазонов портов, которые назначены каждому типу трафика, в зависимости от потребностей организации и фактического использования.

## <a name="choose-initial-port-ranges-for-each-media-type"></a>Выбор диапазонов исходных портов для каждого типа мультимедиа

Значение DSCP указывает, какая сеть имеет приоритет для передачи пакета или потока, независимо от того, назначена ли метка DSCP клиентами или самой сетью на основе параметров ACL. Каждая рабочая нагрузка мультимедиа получает собственное уникальное значение DSCP (другие службы могут разрешить рабочим нагрузкам совместно использовать маркировку DSCP, в Teams — нет) и определенный и отдельный диапазон портов, используемый для каждого типа мультимедиа. В других средах может существовать существующая стратегия QoS, которая поможет определить приоритет сетевых рабочих нагрузок.

Относительный размер диапазонов портов для различных потоковых рабочих нагрузок в режиме реального времени определяет долю общей доступной пропускной способности, выделенной для этой рабочей нагрузки. Чтобы вернуться к нашей предыдущей почтовой аналогии, буква с отметкой "Почта" может быть доставлена в ближайший аэропорт в течение часа, а небольшой пакет с пометкой "Массовая почта" может подождать день, прежде чем наехал на погрузку в поголовье грузовиков.

_Рекомендуемые диапазоны исходных портов_

|Тип медиатрафика| Диапазон портов источника клиента  |Протокол|Значение DSCP|Класс DSCP|
|:--- |:--- |:--- |:--- |:--- |
|Звук| 50,000–50,019|TCP/UDP|46|Беспрепятственная переадресация (EF)|
|Видео| 50,020–50,039|TCP/UDP|34|Гарантированная переадресация (AF41)|
|Приложение / Разделение экрана| 50,040–50,059|TCP/UDP|18|Гарантированная пересылка (AF21)|
||||||

При использовании этих параметров следует помнить о следующих параметрах:

- Если вы планируете реализовать ExpressRoute в будущем, но еще не внедряли QoS, рекомендуем следовать указаниям, чтобы значения DSCP были одинаковыми от отправитель к приемнику.

- Все клиенты, включая мобильные клиенты и устройства Teams, будут использовать эти диапазоны портов, на которые будет повлиять политика DSCP, реализуемая с использованием диапазонов исходных портов. Динамические порты по-прежнему используют только клиенты, использующие браузер (клиенты, которые участники могут присоединяться к собраниям с помощью своих браузеров).

- Клиент Mac использует те же диапазоны портов, но для аудио- и видеосвязи (EF) и видео (AF41) также используются жестко задатые значения. Эти значения нельзя настроить.

- Если позже вам потребуется изменить диапазоны портов для улучшения пользовательского интерфейса, они не могут перекрываться и должны быть смежными.

## <a name="migrate-qos-to-teams"></a>Перенос QoS в Teams

Если ранее вы развернули Skype для бизнеса Online, включая диапазоны тегов и портов QoS, и сейчас развертывание. Teams и Teams будут соблюдать существующую конфигурацию и будут использовать те же диапазоны портов и теги, что и клиент Skype для бизнеса. В большинстве случаев дополнительная настройка не требуется.

> [!NOTE]
> Если вы используете теги QoS "Имя приложения" с помощью групповой политики, Teams.exe в качестве имени приложения.

### <a name="implement-qos-in-teams-on-windows-using-powershell"></a>Реализация QoS в Teams для Windows с помощью PowerShell

**Настройка QoS для звука**

```powershell
new-NetQosPolicy -Name "Teams Audio" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50000 -IPSrcPortEndMatchCondition 50019 -DSCPAction 46 -NetworkProfile All
```

**Настройка QoS для видео**

```powershell
new-NetQosPolicy -Name "Teams Video" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50020 -IPSrcPortEndMatchCondition 50039 -DSCPAction 34 -NetworkProfile All
```

**Настройка QoS для общего доступа**

```powershell
new-NetQosPolicy -Name "Teams Sharing" -AppPathNameMatchCondition "Teams.exe" -IPProtocolMatchCondition Both -IPSrcPortStartMatchCondition 50040 -IPSrcPortEndMatchCondition 50059 -DSCPAction 18 -NetworkProfile All
```

## <a name="managing-source-ports-in-the-teams-admin-center"></a>Управление исходными портами в Центре администрирования Teams

В Teams исходными портами QoS, используемыми для разных рабочих нагрузок, следует активно управлять и при необходимости настраивать их. Ссылаясь на таблицу в области "Выбор диапазонов исходных портов" для каждого типа [мультимедиа,](#choose-initial-port-ranges-for-each-media-type)диапазоны портов можно настраивать, но маркировки DSCP нельзя настроить. После внедрения этих параметров для данного типа мультимедиа может потребоваться больше или меньше портов. [Аналитические данные](use-call-analytics-to-troubleshoot-poor-call-quality.md) о звонках для каждого пользователя и панель мониторинга качества звонка [(CQD)](turning-on-and-using-call-quality-dashboard.md) следует использовать для принятия решения о том, следует ли настраивать диапазоны портов после внедрения Teams и периодически изменять их в мере изменения потребностей.

> [!NOTE]
> Если вы уже настроили QoS на основе диапазонов исходных портов и маркировки DSCP для Skype для бизнеса Online, такая же конфигурация будет применяться к Teams и больше не будет требоваться изменение сопоставления в клиенте или сети, хотя вам может потребоваться настроить диапазоны, используемые в [Teams,](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings) в том числе для того, чтобы они совпадали с настроенными для Skype для бизнеса Online.

Если ранее вы развернули Skype для бизнеса Server в локальной сети, вам может потребоваться повторно изучить политики QoS. Настройть политики в соответствие с настройками диапазона портов, которые вы проверили, чтобы обеспечить качественный пользовательский интерфейс для Teams.

## <a name="validate-your-qos-implementation"></a>Проверка внедрения QoS

Для эффективного качества QoS значение DSCP, за настроенного GPO, должно присутствовать на обоих концах звонка. Анализируя трафик, созданный клиентом Teams, вы можете убедиться, что значение DSCP не изменилось и не обрезалось при перемещениях трафика рабочей нагрузки Teams по сети.

Желательно фиксировать трафик в сетевой точке точки регрессии. Для этого можно использовать зеркальное отражение портов на коммутаторе или маршрутизаторе.

## <a name="implement-qos-for-other-devices"></a>Реализация QoS для других устройств

Прочитайте эти разделы, чтобы узнать о внедрении QoS для Intune, Surface, iOS, Android и Mac

- [QoS для Surface Hub 2S](/surface-hub/surface-hub-2s-manage-intune)

- [QoS для Surface Hub](/surface-hub/surface-hub-qos)

- [QoS для iOS, Android и Mac](./meeting-settings-in-teams.md?WT.mc_id=TeamsAdminCenterCSH#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)

## <a name="related-topics"></a>Статьи по теме

- [Видео: планирование сети](https://aka.ms/teams-networking)

- [Подготовка сети организации к использованию Microsoft Teams](prepare-network.md)

- [Реализация QoS в клиенте Teams](QoS-in-Teams-clients.md)