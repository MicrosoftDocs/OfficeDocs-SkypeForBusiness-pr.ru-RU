---
title: Качество обслуживания в Microsoft Teams
author: lanachin
ms.author: v-lanac
manager: Serdars
ms.date: 12/17/2018
ms.topic: article
ms.service: msteams
ms.reviewer: rowille
description: Подготовка сети организации к работе с качеством обслуживания (QoS) в Microsoft Teams.
localization_priority: Normal
search.appverid: MET150
f1keywords: ms.teamsadmincenter.meetingsettings.qos
MS.collection:
- Teams_ITAdmin_PracticalGuidance
- M365-collaboration
appliesto:
- Microsoft Teams
ms.openlocfilehash: dc2344494ed853a992f205b6bdcfd4d702136f99
ms.sourcegitcommit: da87a3c4c781223ab7de2fb539bb0796dc27ea9e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/23/2019
ms.locfileid: "35820987"
---
# <a name="implement-quality-of-service-qos-in-microsoft-teams"></a>Реализация качества обслуживания (QoS) в Microsoft Teams

В этой статье вы сможете подготовить сеть Организации к качеству обслуживания (QoS) в Microsoft Teams. Если вы разработали крупную группу пользователей и столкнулись с одной из проблем, упомянутых ниже, вам, возможно, потребуется реализовать QoS. Для малых предприятий с небольшим количеством пользователей может не потребоваться качество обслуживания, но даже там оно должно быть полезным.

Качество обслуживания — это способ разрешить сетевую передачу данных в реальном времени (например, голосовые и видеопотоки), которые зависят от задержки сети, для поэтапного трафика, который меньше конфиденциально (например, для загрузки нового приложения, где дополнительная секунда для скачивания не является большим количеством). QoS определяет и помечает все пакеты в потоках в реальном времени (с помощью объектов групповой политики Windows и функции маршрутизации, называемые списками управления доступом на основе порта, больше об этом ниже), что позволяет сети предоставлять потокам голосовой, видеосвязи и экрана общий доступ к файлам выделенный участок пропускной способности сети.

Вы можете столкнуться со следующими проблемами качества в голосовой и видеосвязи, не имея некоторых форм качества обслуживания.

- Колебаний – пакеты мультимедиа, поступающие на разные тарифы, что может привести к пропущенным словам или слогам в звонках.
- Потери пакетов – пакеты отбрасываются, что также может привести к снижению качества голоса и сложному понятию речи.
- Отложенное время приема-передачи (RTT) – пакеты мультимедиа занимают много времени, что приводит к значительным задержкам между двумя сторонами в разговоре, что приводит к тому, что люди говорят друг другу.

Самый сложный способ решить эти проблемы — это уменьшить размер подключений к данным, как внутренним, так и к Интернету. Так как это часто недорогие, QoS обеспечивает более эффективное управление ресурсами вместо добавления новых ресурсов. Для устранения проблем с качеством качества обслуживания в рамках реализации следует использовать QoS, а затем добавим подключение только в том случае, если это действительно необходимо.

Чтобы качество обслуживания было эффективным, в вашей организации будут применены соответствующие параметры качества обслуживания, поскольку любая часть пути, которая не поддерживает приоритеты QoS, может снизить качество звонков, видео и экранных ресурсов. Сюда входят параметры применения параметров ко всем пользовательским ПК или устройствам, сетевым коммутаторам, маршрутизаторам и Интернет-службам Teams.

_Рисунок 1. Связь между сетями Организации и службами Office 365_

![Схема связи между сетями и службами] (media/Qos-in-Teams-Image1.png "Связь между сетями Организации и службами Office 365: локальная сеть и устройства подключаются к сети Интернет-соединения, которая, в свою очередь, подключается к службе голосовой и видеоконференции Office 365.")

В большинстве случаев сеть, соединяющая предприятие с облаком, является неуправляемой сетью, в которой вы не сможете надежно настраивать параметры качества обслуживания. Один из вариантов, доступных для одноранговых QoS, — это [Azure ExpressRoute](https://azure.microsoft.com/documentation/articles/expressroute-introduction/), но мы рекомендуем реализовать качество обслуживания в локальной сети как для входящего, так и для исходящего трафика. Это повысит качество рабочей нагрузки для взаимодействия в реальном времени во время развертывания и чокепоинтс.

## <a name="verify-your-network-is-ready"></a>Проверка готовности сети

Если вы просматриваете реализацию QoS, вы уже должны определить требования к пропускной способности и другие [сетевые требования](prepare-network.md). 
  
  Перегрузка трафика в сети значительно повлияет на качество мультимедиа. Недостаток пропускной способности приводит к снижению производительности и плохому взаимодействию с пользователем. По мере роста и использования команд в команде следует использовать функцию создания отчетов, [аналитики звонков и панель мониторинга качества звонков](difference-between-call-analytics-and-call-quality-dashboard.md) для выявления проблем, а затем вносить изменения с помощью QoS и выборочных дополнений к пропускной способности.

### <a name="vpn-considerations"></a>Общие сведения о VPN

Качество обслуживания QoS работает должным образом только при реализации всех связей между абонентами. Если вы используете службу QoS во внутренней сети и пользователь входит в удаленное место, вы можете установить приоритет только в пределах внутренней управляемой сети. Несмотря на то, что удаленные расположения могут принимать управляемое подключение, реализуя виртуальную частную сеть (VPN), VPN по сути добавляет служебные пакеты и создает задержку в трафике в режиме реального времени. Мы рекомендуем не использовать трафик для обмена данными в режиме реального времени через VPN.

В глобальной Организации с управляемыми связями, охватывающими континенты, настоятельно рекомендуется использовать QoS, так как пропускная способность для этих ссылок ограничена сравнением с локальной сетью.

## <a name="introduction-to-qos-queues"></a>Общие сведения об очередях QoS

Для обеспечения качества обслуживания сетевые устройства должны иметь способ классификации трафика и должны быть в состоянии отличать голосовую или видеосвязь от другого сетевого трафика.

Когда сетевой трафик входит в маршрутизатор, трафик помещается в очередь. Если политика качества обслуживания не настроена, то имеется только одна очередь, и все данные обрабатываются как first-in — первый из них с одинаковым приоритетом. Это означает, что голосовая связь (которая очень важна для задержек) может зависнуть за трафик, в течение которого задержка, связанная с несколькими дополнительными миллисекундами, не будет проблемой.

При реализации QoS вы определяете несколько очередей с помощью одной из нескольких функций управления перегрузкой (например, очереди приоритетов Cisco и взвешенного измерения, основанного [](https://www.cisco.com/en/US/docs/ios/12_0t/12_0t5/feature/guide/cbwfq.html#wp17641)на классах), а также функций предотвращения перегрузки (например, взвешенного случайного числа первых). Обнаружение [вред](https://en.wikipedia.org/wiki/Weighted_random_early_detection)).

_На рисунке 2. Примеры очередей QoS_

![Изображение очередей QoS и разделение пропускной способности] (media/Qos-in-Teams-Image2.png "Общая доступная пропускная способность делится между несколькими очередями, звуком, видео и другим трафиком, которым назначены разные приоритеты.")

Простым аналогом является то, что QoS создает виртуальную "карпулные желобы" в сети данных, поэтому некоторые типы данных никогда или редко сталкиваются с задержкой. Создав эти дорожки, вы можете изменить их относительный размер и значительно повысить эффективность управления пропускной способностью соединения, сохранив при этом возможности бизнес-задач для пользователей организации.

## <a name="select-a-qos-implementation-method"></a>Выбор метода реализации QoS

Вы можете реализовать качество обслуживания с помощью тегов на основе порта, используя списки управления доступом (ACL) на маршрутизаторах вашей сети. Маркировка на основе порта является наиболее надежным способом, так как она работает в смешанных средах Windows и Mac и является простейшей реализацией. Мобильные клиенты не предоставляют механизм для пометки трафика с помощью значений DSCP, поэтому им потребуется этот метод.  

С помощью этого метода маршрутизатор сети проверяет входящий пакет и, если он был доставлен через определенный порт или диапазон портов, определяет его как конкретный тип мультимедиа и помещает его в очередь для этого типа, добавляя предварительно определенную метку [DSCP](https://tools.ietf.org/html/rfc2474) к IP-адресу. Заголовок пакета, чтобы другие устройства могли распознать тип трафика и присвоить ему приоритет в очереди.

Несмотря на то, что она работает на разных платформах, она помечает трафик только в глобальной сети (не все возможности на клиентском компьютере) и создает дополнительные затраты на управление. Инструкции по реализации этого метода вы можете найти в документации, предоставленной изготовителем маршрутизатора.

* * *

Кроме того, вы можете реализовать QoS с помощью объекта групповой политики (GPO), чтобы клиентские устройства могли вставить маркер DSCP в заголовки IP-пакетов, определяющие его как конкретный тип трафика (например, голосовую почту). Маршрутизаторы и другие сетевые устройства можно настроить таким образом, чтобы они могли распознавать это и размещать трафик в отдельной очереди более приоритетных сообщений.

Несмотря на то, что этот сценарий полностью действителен, он будет работать только для клиентов Windows, присоединенных к домену. Для любого устройства, которое не входит в состав домена, не нужно включать подстановку DSCP в клиенте Windows. Клиенты, такие как Mac OS, имеют жестко закодированные Теги и всегда заключают трафик в тег.

На стороне плюс управление пометкой DSCP через GPO обеспечивает получение одинаковых параметров для всех компьютеров, присоединенных к домену, и управление ими разрешено только администратором. Клиенты, которые могут использовать объект групповой политики, будут помечены на исходном устройстве, а затем настроенные сетевые устройства смогут распознавать поток реального времени с помощью кода DSCP и присвоить ему подходящий приоритет.

* * *

Мы рекомендуем использовать сочетание DSCP для конечной точки и ACL на основе порта на маршрутизаторах, если это возможно. С помощью объекта групповой политики для перехвата большинства клиентов, а также с помощью разметки DSCP на основе порта, вы будете гарантировать, что мобильные, Mac-и другие клиенты будут получать обработку QoS (хотя бы частично).

Маркировка DSCP может быть ликенеда для почтового штампа, указывающего на почтовые работники, как срочно доставляться и как лучше отсортировать ее для ускорения доставки. После настройки сети для предоставления приоритетов для потоков мультимедиа в реальном времени потерянные и просроченные пакеты должны значительно уменьшиться.

После того как все устройства в сети будут использовать одну и ту же классификацию, маркировку и приоритеты, можно уменьшить или устранить задержки, отброшенные пакеты и колебание, изменив размер диапазонов портов, назначенных очередям, используемым для каждого типа трафика. С точки зрения рабочих групп, наиболее важной частью конфигурации является классификация и пометка пакетов, но для успешного завершения QoS необходимо также тщательно согласовать конфигурацию приложения с базовой конфигурацией сети. После того как качество обслуживания полностью реализовано, текущее управление является вопросом настройки диапазонов портов, назначаемых каждому типу трафика, в зависимости от потребностей Организации и фактического использования.

## <a name="choose-initial-port-ranges-for-each-media-type"></a>Выберите начальные диапазоны портов для каждого типа мультимедиа.

Значение DSCP указывает в соответствующей конфигурации сеть, приоритет которой следует предоставить пакету или потоку, определяет назначение метки DSCP клиентами или самой сетью на основе параметров ACL. Каждая рабочая нагрузка получает собственное уникальное значение DSCP (другие службы могут разрешать рабочим нагрузкам предоставлять доступ к разметке DSCP, Teams — нет) и определенному и отдельному диапазону портов, используемому для каждого типа мультимедиа. Другие среды могут иметь существующую стратегию QoS, что поможет вам определить приоритет рабочих нагрузок в сети.

Относительный размер диапазонов портов для разных рабочих нагрузок в реальном времени задает долю общей доступной пропускной способности, выделенной для этой рабочей нагрузки. Чтобы вернуться к предыдущей почтовой корреспонденции: письмо с меткой "Air Mail" может поступить в течение часа до ближайшего аэропорта, а небольшой пакет, помеченный меткой "массовая почта", может подождать, пока он не попадет на серию грузовиков.

В следующей таблице показаны необходимые метки DSCP для Teams с ExpressRoute и соответствующие порты для очередей рабочей нагрузки. Эти диапазоны могут служить хорошей отправной точкой для пользователей, которые не уверены в том, что использовать в своей среде. Дополнительные сведения см. в статье [Требования к качеству обслуживания для ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-qos).

_Рекомендуемые начальные диапазоны портов_

|Тип трафика мультимедиа| Диапазон портов источника клиента |Протокол|DSCP Value|Класс DSCP|
|:--- |:--- |:--- |:--- |:--- |
|Голосовая связь| 50000 — 50019|TCP/UDP|46|Беспрепятственная переадресация (EF)|
|Видеосвязь| 50020 – 50039|TCP/UDP|34|Гарантированная переадресация (AF41)|
|Демонстрация приложений и экрана| 50040 – 50059|TCP/UDP|18|Гарантированная переадресация (AF21)|
||||||

При использовании этих параметров имейте в виду следующее:

- Если вы планируете реализовать ExpressRoute в будущем, но еще не реализовали QoS, мы рекомендуем следовать рекомендациям, чтобы значения DSCP были теми же, что и у отправителя и получателя.
- Все клиенты, в том числе мобильные клиенты и устройства с рабочими группами, будут использовать эти диапазоны портов и будут зависеть от того, какая политика DSCP реализуется с использованием этих диапазонов исходного порта. Клиенты, которые будут продолжать использовать динамические порты, — это клиенты на базе браузера (то есть клиенты, которые позволяют участникам присоединяться к собраниям с помощью браузеров).
- Несмотря на то, что клиент Mac использует один и тот же диапазон портов, он также использует жестко закодированные значения для аудиоподсистемы (EF) и Video (AF41). Эти значения нельзя настраивать.
- Если позже вам потребуется настроить диапазоны портов для улучшения взаимодействия с пользователем, диапазоны портов не могут перекрываться и должны находиться рядом друг с другом.

## <a name="migrate-qos-to-teams"></a>Миграция QoS в Teams

Если вы ранее развернули Skype для бизнеса Online, в том числе разметку QoS и диапазоны портов, а теперь разворачиваете группы, Teams будет учитывать текущую конфигурацию и использовать те же диапазоны портов и разметку, что и в клиенте Skype для бизнеса. В большинстве случаев дополнительные настройки не требуются.

> [!NOTE]
> Если вы используете Теги QoS с именем приложения с помощью групповой политики, необходимо добавить Teams. exe в качестве имени приложения.

## <a name="qos-implementation-steps"></a>Этапы реализации QoS

Для реализации QoS на очень высоком уровне необходимо выполнить следующие действия:

1. [Проверка готовности сети](#verify-your-network-is-ready)
2. [Выбор метода реализации QoS](#select-a-qos-implementation-method)
3. [Выберите начальные диапазоны портов для каждого типа мультимедиа.](#choose-initial-port-ranges-for-each-media-type)
4. Реализация параметров качества обслуживания:
   1. На клиентах, использующих объект групповой политики, для [настройки диапазонов портов и пометки клиентских устройств](QoS-in-Teams-clients.md)
   2. На маршрутизаторах (ознакомьтесь с документацией производителя) или другими сетевыми устройствами. Это может быть список ACL на основе порта или просто определение очередей QoS и пометки DSCP.

      > [!IMPORTANT]
      > Мы рекомендуем реализовать эти политики качества обслуживания с помощью исходных портов клиента и IP-адреса источника и назначения "Any". Это будет перехватывать входящий и исходящий трафик мультимедиа во внутренней сети.  

   3. В [центре администрирования Teams](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings)
5. [Проверка реализации QoS](#validate-the-qos-implementation) путем анализа трафика Teams в сети.

По мере подготовки к реализации QoS следует учитывать следующие моменты.

- Наиболее короткий путь к Office 365 является наилучшим вариантом.
- Закрытие портов может привести к ухудшению качества.
- Любые препятствия, такие как прокси-серверы, не рекомендуются.
- Ограничьте число прыжков:
  - От клиента к сети – от 3 до 5 прыжков.
  - Поставщик услуг Интернета в Microsoft Network EDGE – 3 прыжка
  - Сеть Microsoft Network Edge с конечным расположением – нет значения

Сведения о настройке портов брандмауэра можно найти в [адресах URL Office 365 и диапазонах IP-](office-365-urls-ip-address-ranges.md)адресов.

## <a name="managing-source-ports-in-the-teams-admin-center"></a>Управление портами источников в центре администрирования Teams

В Teams исходные порты QoS, используемые в различных рабочих нагрузках, должны быть активно управляемыми и скорректированы по мере необходимости. При обращении к таблице в разделе [Выбор начальных диапазонов портов для каждого типа мультимедийного](#choose-initial-port-ranges-for-each-media-type)диапазона диапазоны портов изменяются, но маркировка DSCP не настраивается. После того как вы реализовали эти параметры, вы можете обнаружить, что требуется больше или меньше портов для определенного типа мультимедиа. С помощью средства [аналитики звонков и панели мониторинга качества звонков](difference-between-call-analytics-and-call-quality-dashboard.md) следует принимать решение о необходимости настройки диапазонов портов после реализации Teams и периодически при их изменении.

> [!NOTE]
> Если вы уже настроили QoS на основе диапазонов исходного порта и меток DSCP для Skype для бизнеса Online, то эта же конфигурация будет применяться к группам, и дальнейшие изменения, внесенные в клиентские или сетевые параметры сопоставления, будут необязательными, однако может потребоваться [задать диапазоны. используется в центре администрирования Teams](meeting-settings-in-teams.md#set-how-you-want-to-handle-real-time-media-traffic-for-teams-meetings) в соответствии с настройками Skype для бизнеса Online.

Если вы ранее развернули локальную версию Skype для бизнеса Server, вам может потребоваться повторно изучить политики QoS и настроить их так, чтобы они соответствовали параметрам диапазонов, которые вы проверили для обеспечения качества обслуживания пользователей Teams.

## <a name="validate-the-qos-implementation"></a>Проверка реализации QoS

Для обеспечения эффективности QoS значение DSCP, заданное объектом групповой политики, должно быть представлено на обоих концах вызова. Проанализировав трафик, сформированный клиентом Teams, вы можете проверить, что значение DSCP не изменилось или не выводится, когда трафик рабочей нагрузки Teams проходит по сети.

Лучше всего захватывать трафик в точке выхода сети. С помощью зеркального отображения порта на коммутаторе или маршрутизаторе вы можете помочь.

### <a name="use-network-monitor-to-verify-dscp-values"></a>Использование сетевого монитора для проверки значений DSCP

Сетевой монитор — это инструмент, который можно [загрузить из Microsoft](https://www.microsoft.com/download/4865) для анализа сетевого трафика.

1. На компьютере с запущенным сетевым монитором подключитесь к порту, для которого настроено зеркальное отображение портов, и начните собирать пакеты.

2. Совершить звонок с помощью клиента Teams. Перед тем как присоединиться к звонку, убедитесь, что вы установили мультимедиа.

3. Остановить запись.

4. В поле **Фильтр отображения** используйте IP-адрес источника компьютера, который сделал звонок, а затем уточните фильтр, ОПРЕДЕЛИВ значение DSCP 46 (Hex 0x2e) в качестве условий поиска, как показано в следующем примере:

    Source = = "192.168.137.201" и IPv4. Дифферентиатедсервицесфиелд = = 0x2E

    ![Фильтры снимков экрана в диалоговом окне "фильтр отображения".] (media/Qos-in-Teams-Image4.png "Диалоговое окно «Фильтр отображения» в сетевом мониторе, в котором показаны применяемые фильтры.")

5. Нажмите кнопку **Применить** , чтобы активировать фильтр.

6. В окне **Сводка** по кадрам выберите первый пакет UDP.

7. В окне **сведения о кадре** разверните элемент списка IPv4 и обратите внимание на значение в конце строки, которое начинается с **DSCP**.

    ![Снимок экрана: параметры DSCP в диалоговом окне "сведения о кадре".] (media/Qos-in-Teams-Image5.png "Диалоговое окно \"сведения о кадре\" в сетевом мониторе, в котором выделяются параметры DSCP.")

В этом примере значение DSCP установлено в 46. Это правильно, так как исходный порт используется в 50019, указывающий на то, что это Голосовая нагрузка.

Повторите проверку для каждой рабочей нагрузки, которая маркируется при помощи GPO.

## <a name="more-information"></a>Дополнительные сведения

[Видео: планирование сети](https://aka.ms/teams-networking)

[Подготовка сети организации к использованию Microsoft Teams](prepare-network.md)

[Требования к качеству ExpressRoute](https://docs.microsoft.com/azure/expressroute/expressroute-qos)
